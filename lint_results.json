[{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\debug_records.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\debug_zombie_check.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\App.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":111,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":111,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4821,4824],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4821,4824],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { Suspense } from 'react';\r\nimport { Routes, Route, Navigate } from 'react-router-dom';\r\nimport { useAuth } from './context/AuthContext';\r\nimport { useExport } from './hooks/useExport';\r\nimport { useAppStore } from './store/useAppStore';\r\nimport { lazyWithRetry } from './utils/lazyWithRetry';\r\n\r\n// Layout & Security\r\nimport DashboardLayout from './layouts/DashboardLayout';\r\nimport ProtectedRoute from './features/auth/ProtectedRoute';\r\nimport RequireRole from './layouts/RequireRole';\r\nimport RequireActiveStatus from './layouts/RequireActiveStatus';\r\nimport DashboardSkeleton from './ui/layout/DashboardSkeleton';\r\nimport Login from './features/auth/Login';\r\nimport NotFound from './layouts/pages/NotFound';\r\nimport WeeklyScheduler from './features/operations/WeeklyScheduler';\r\n\r\n// Page Components\r\nimport DashboardSwitcher from './layouts/components/DashboardSwitcher';\r\nimport UserProfile from './features/user/UserProfile';\r\nimport UserManagementPanel from './features/admin/users/UserManagementPanel';\r\nimport DevSandbox from './pages/DevSandbox';\r\n\r\n// Other Panels (Mapped from legacy ViewSwitcher)\r\nimport SupportHub from './features/franchise/SupportHub';\r\nimport ResourcesPanel from './features/franchise/ResourcesPanel';\r\nimport AnnouncementSystem from './features/admin/AnnouncementSystem';\r\nimport AuditPanel from './features/admin/AuditPanel';\r\nimport TariffEditor from './features/admin/finance/TariffEditor';\r\nimport AdminSupportPanel from './features/admin/AdminSupportPanel';\r\nimport AdminResourcesPanel from './features/admin/AdminResourcesPanel';\r\n\r\n// Lazy Load Heavy Components (Durability with lazyWithRetry)\r\n// const FranchiseDashboard = lazyWithRetry(() => import('./features/franchise/FranchiseDashboard'));\r\nconst OperationsPage = lazyWithRetry(() => import('./features/operations/OperationsPage'));\r\nconst Academy = lazyWithRetry(() => import('./features/academy/Academy'));\r\nconst AdminFranchiseView = lazyWithRetry(() => import('./features/admin/AdminFranchiseView'));\r\nconst KanbanBoard = lazyWithRetry(() => import('./features/admin/kanban/KanbanBoard'));\r\nconst RidersView = lazyWithRetry(() => import('./features/fleet/RidersView'));\r\n\r\nimport { useFranchiseFinance } from './hooks/useFranchiseFinance';\r\nimport { useVersionCheck } from './hooks/useVersionCheck';\r\nimport { RiderLayout } from './layouts/RiderLayout';\r\n\r\n\r\n\r\nconst RiderScheduleView = lazyWithRetry(() => import('./features/rider/schedule/RiderScheduleView'));\r\nconst RiderProfileView = lazyWithRetry(() => import('./features/rider/profile/RiderProfileView').then(module => ({ default: module.RiderProfileView })));\r\nconst RiderHomeView = lazyWithRetry(() => import('./features/rider/home/RiderHomeView').then(module => ({ default: module.RiderHomeView })));\r\n\r\nfunction App() {\r\n    const { user, loading: authLoading, roleConfig, logout, isAdmin, impersonatedFranchiseId } = useAuth();\r\n\r\n    // Global UI State from Store\r\n    const {\r\n        selectedMonth,\r\n        setSelectedMonth\r\n    } = useAppStore();\r\n\r\n    // üîÑ AUTO-UPDATE CHECKER\r\n    useVersionCheck();\r\n\r\n    // Admin Selection State\r\n    const [targetFranchiseId, setTargetFranchiseId] = React.useState<string | null>(null);\r\n    const [targetFranchiseName, setTargetFranchiseName] = React.useState<string | null>(null);\r\n\r\n    const { exportCSV } = useExport();\r\n\r\n    // Helper flags\r\n    const isFranchise = roleConfig?.role === 'franchise' || !!impersonatedFranchiseId;\r\n\r\n    // üõ†Ô∏è DEBUG & CACHE CLEANUP\r\n    console.log(\"üöÄ Running App Version: v4.1.0 - STABLE\");\r\n\r\n    // --- DATA FETCHING ---\r\n    const dataHookFranchiseId = (isAdmin && targetFranchiseId)\r\n        ? targetFranchiseId\r\n        : (roleConfig?.franchiseId || user?.uid || null);\r\n\r\n    const {\r\n        rawData: currentData,\r\n        accounting,\r\n        updateFinance: handleUpdate,\r\n        isSaving: saving,\r\n        analysis\r\n    } = useFranchiseFinance({\r\n        franchiseId: user ? (dataHookFranchiseId || undefined) : undefined,\r\n        month: selectedMonth\r\n    });\r\n\r\n    const report = accounting?.report;\r\n\r\n    // Handle Admin Select\r\n    const handleAdminSelectFranchise = (uid: string, name: string) => {\r\n        setTargetFranchiseId(uid);\r\n        setTargetFranchiseName(name);\r\n    };\r\n\r\n    // --- LAYOUT PROPS ---\r\n    const layoutProps = {\r\n        user, isAdmin, isFranchise,\r\n        // Legacy props for compatibility if Header uses them\r\n        viewMode: 'dashboard', setViewMode: () => { },\r\n        franchiseView: 'cockpit', setFranchiseView: () => { },\r\n\r\n        targetFranchiseName,\r\n        // selectedMonth, -> Handled by Store\r\n        // onMonthChange: setSelectedMonth, -> Handled by Store\r\n        // viewPeriod, setViewPeriod, -> Handled by Store\r\n        onLogout: logout,\r\n        onExport: () => exportCSV(report as any, selectedMonth, isAdmin && targetFranchiseName ? targetFranchiseName : 'REPAART'),\r\n        sidebarData: currentData, onCalculate: handleUpdate, readOnly: false,\r\n        saving,\r\n        // isChatOpen, setIsChatOpen, -> Handled by Store (DashboardLayout uses store)\r\n        chatData: { report }\r\n    };\r\n\r\n    // Context to be exposed via Outlet\r\n    const outletContext = {\r\n        user,\r\n        franchiseId: dataHookFranchiseId,\r\n        currentData, report, analysis,\r\n        selectedMonth, setSelectedMonth,\r\n        handleAdminSelectFranchise,\r\n        targetFranchiseId,\r\n        setIsSidebarOpen: (_isOpen: boolean) => {\r\n            // Placeholder, handled by Store now\r\n        }\r\n    };\r\n\r\n    if (authLoading) {\r\n        return <div className=\"min-h-screen bg-slate-950 flex items-center justify-center\"><DashboardSkeleton /></div>;\r\n    }\r\n\r\n    return (\r\n        <Suspense fallback={<div className=\"min-h-screen bg-slate-950 flex items-center justify-center\"><DashboardSkeleton /></div>}>\r\n\r\n            <Routes>\r\n                {/* PUBLIC */}\r\n                <Route path=\"/login\" element={\r\n                    !user ? <Login /> : (\r\n                        ['rider'].includes(user.role || '')\r\n                            ? <Navigate to=\"/rider/dashboard\" replace />\r\n                            : <Navigate to=\"/dashboard\" replace />\r\n                    )\r\n                } />\r\n\r\n                {/* PROTECTED LAYOUT */}\r\n                <Route path=\"/\" element={\r\n                    <ProtectedRoute>\r\n                        {['rider'].includes(user?.role || '') ? (\r\n                            <Navigate to=\"/rider/dashboard\" replace />\r\n                        ) : (\r\n                            <DashboardLayout {...layoutProps} outletContext={outletContext} />\r\n                        )}\r\n                    </ProtectedRoute>\r\n                }>\r\n                    <Route index element={\r\n                        ['rider'].includes(user?.role || '')\r\n                            ? <Navigate to=\"/rider/dashboard\" replace />\r\n                            : (user?.role === 'admin' || user?.role === 'franchise'\r\n                                ? <Navigate to=\"/dashboard\" replace />\r\n                                : <Navigate to=\"/profile\" replace />)\r\n                    } />\r\n\r\n                    {/* CORE (Admin/Franchise Only) */}\r\n                    <Route path=\"dashboard\" element={\r\n                        <RequireRole allowedRoles={['admin', 'franchise']}>\r\n                            <RequireActiveStatus>\r\n                                <DashboardSwitcher />\r\n                            </RequireActiveStatus>\r\n                        </RequireRole>\r\n                    } />\r\n                    <Route path=\"operations\" element={\r\n                        <RequireRole allowedRoles={['admin', 'franchise']}>\r\n                            <RequireActiveStatus>\r\n                                <OperationsPage />\r\n                            </RequireActiveStatus>\r\n                        </RequireRole>\r\n                    } />\r\n                    <Route path=\"academy\" element={\r\n                        <RequireRole allowedRoles={['admin', 'franchise']}>\r\n                            {/* Academy is ALLOWED for Pending users */}\r\n                            <Academy />\r\n                        </RequireRole>\r\n                    } />\r\n                    <Route path=\"fleet\" element={\r\n                        <RequireRole allowedRoles={['admin', 'franchise']}>\r\n                            <RequireActiveStatus>\r\n                                <RidersView />\r\n                            </RequireActiveStatus>\r\n                        </RequireRole>\r\n                    } />\r\n                    <Route path=\"profile\" element={<UserProfile />} />\r\n                    <Route path=\"demo/smart-input\" element={<DevSandbox />} />\r\n\r\n                    {/* FRANCHISE SPECIFIC */}\r\n                    <Route path=\"support\" element={\r\n                        <RequireRole allowedRoles={['admin', 'franchise']}>\r\n                            {/* Support is ALLOWED for Pending users */}\r\n                            <SupportHub />\r\n                        </RequireRole>\r\n                    } />\r\n                    <Route path=\"resources\" element={\r\n                        <RequireRole allowedRoles={['admin', 'franchise']}>\r\n                            {/* Resources is ALLOWED for Pending users */}\r\n                            <ResourcesPanel />\r\n                        </RequireRole>\r\n                    } />\r\n\r\n                    {/* ADMIN SPECIFIC */}\r\n                    <Route path=\"admin/users\" element={\r\n                        <ProtectedRoute requireAdmin={true}>\r\n                            <UserManagementPanel />\r\n                        </ProtectedRoute>\r\n                    } />\r\n\r\n                    <Route path=\"admin/support\" element={\r\n                        <ProtectedRoute requireAdmin={true}>\r\n                            <AdminSupportPanel />\r\n                        </ProtectedRoute>\r\n                    } />\r\n\r\n                    <Route path=\"admin/resources\" element={\r\n                        <ProtectedRoute requireAdmin={true}>\r\n                            <AdminResourcesPanel />\r\n                        </ProtectedRoute>\r\n                    } />\r\n\r\n                    <Route path=\"admin/audit\" element={\r\n                        <ProtectedRoute requireAdmin={true}>\r\n                            <AuditPanel />\r\n                        </ProtectedRoute>\r\n                    } />\r\n\r\n                    <Route path=\"admin/tariffs\" element={\r\n                        <ProtectedRoute requireAdmin={true}>\r\n                            <TariffEditor onClose={() => { }} />\r\n                        </ProtectedRoute>\r\n                    } />\r\n\r\n                    <Route path=\"admin/communications\" element={\r\n                        <ProtectedRoute requireAdmin={true}>\r\n                            <div className=\"p-5 md:p-8 space-y-6\"><AnnouncementSystem /></div>\r\n                        </ProtectedRoute>\r\n                    } />\r\n\r\n                    <Route path=\"admin/shifts\" element={\r\n                        <ProtectedRoute requireAdmin={true}>\r\n                            <div className=\"p-5 md:p-8 space-y-6 h-[calc(100vh-64px)] overflow-hidden\"><WeeklyScheduler franchiseId={targetFranchiseId || ''} readOnly={false} /></div>\r\n                        </ProtectedRoute>\r\n                    } />\r\n\r\n                    <Route path=\"admin/kanban\" element={\r\n                        <ProtectedRoute requireAdmin={true}>\r\n                            <div className=\"p-5 md:p-8 space-y-6 h-[calc(100vh-64px)] overflow-hidden\">\r\n                                <React.Suspense fallback={<DashboardSkeleton />}>\r\n                                    <KanbanBoard />\r\n                                </React.Suspense>\r\n                            </div>\r\n                        </ProtectedRoute>\r\n                    } />\r\n\r\n                    {/* ADMIN FINANCE DETAIL */}\r\n                    <Route path=\"admin/franchise/:franchiseId\" element={\r\n                        <ProtectedRoute requireAdmin={true}>\r\n                            <AdminFranchiseView />\r\n                        </ProtectedRoute>\r\n                    } />\r\n\r\n                    {/* 404 for DashboardLayout */}\r\n                    <Route path=\"*\" element={<NotFound />} />\r\n                </Route>\r\n\r\n                {/* RIDER SPECIFIC APP (Independent from Admin Layout) */}\r\n                <Route path=\"/rider\" element={\r\n                    <ProtectedRoute>\r\n                        <RequireRole allowedRoles={['rider', 'admin']}>\r\n                            <RiderLayout />\r\n                        </RequireRole>\r\n                    </ProtectedRoute>\r\n                }>\r\n                    <Route index element={<Navigate to=\"dashboard\" replace />} />\r\n                    <Route path=\"dashboard\" element={<RiderHomeView />} />\r\n                    <Route path=\"schedule\" element={<RiderScheduleView />} />\r\n                    <Route path=\"profile\" element={<RiderProfileView />} />\r\n                </Route>\r\n            </Routes>\r\n            {/* <Seeder /> (Removed by User Request) */}\r\n        </Suspense>\r\n    );\r\n}\r\n\r\nexport default App;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\components\\ImpersonationBanner.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\components\\common\\PremiumBanner.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\components\\dev\\Seeder.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":41,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":41,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1770,1773],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1770,1773],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\r\nimport { useAuth } from '../../context/AuthContext';\r\nimport { fleetService } from '../../services/fleetService';\r\nimport { Database, Loader2, CheckCircle } from 'lucide-react';\r\n\r\nconst MOCK_RIDERS = [\r\n    { fullName: 'Marc M√°rquez', email: 'marc@repaart.es', phone: '600111001', contractHours: 40 },\r\n    { fullName: 'Jorge Mart√≠n', email: 'jorge@repaart.es', phone: '600333003', contractHours: 40 },\r\n    { fullName: '√Ålvaro Mart√≠n', email: 'alvaro@repaart.es', phone: '600444004', contractHours: 40 }\r\n];\r\n\r\nconst MOCK_MOTOS = [\r\n    { plate: '1111-AAA', model: 'Silence S02', brand: 'Silence', currentKm: 1500, nextRevisionKm: 5000 },\r\n    { plate: '2222-BBB', model: 'Niu NQi', brand: 'Niu', currentKm: 4950, nextRevisionKm: 5000 }\r\n];\r\n\r\nexport const Seeder: React.FC = () => {\r\n    const { user } = useAuth();\r\n    const [loading, setLoading] = useState(false);\r\n    const [done, setDone] = useState(false);\r\n\r\n    const seedData = async () => {\r\n        // PRIORIDAD: Usamos el UID como franchiseId (Modelo Mohamed)\r\n        const fId = user?.uid;\r\n        if (!fId || user?.role !== 'franchise') {\r\n            return alert(\"Error: Debes estar logueado como FRANQUICIA para ejecutar esto.\");\r\n        }\r\n\r\n        setLoading(true);\r\n        try {\r\n            // 1. Inyectar Riders\r\n            for (const r of MOCK_RIDERS) {\r\n                try {\r\n                    await fleetService.createRider({\r\n                        ...r,\r\n                        franchiseId: fId, // Vinculaci√≥n por UID\r\n                        password: 'Password123!',\r\n                        status: 'active'\r\n                    });\r\n                    console.log(`Rider created: ${r.fullName}`);\r\n                } catch (error: any) {\r\n                    if (error.code === 'auth/email-already-in-use' || error.message?.includes('already-in-use')) {\r\n                        console.log(`Rider ${r.email} already exists. Skipping.`);\r\n                    } else {\r\n                        console.error(`Failed to create rider ${r.fullName}:`, error);\r\n                    }\r\n                }\r\n            }\r\n\r\n            // 2. Inyectar Motos\r\n            for (const m of MOCK_MOTOS) {\r\n                try {\r\n                    await fleetService.createVehicle(fId, m);\r\n                    console.log(`Moto created: ${m.plate}`);\r\n                } catch (error) {\r\n                    console.error(`Failed to create moto ${m.plate}:`, error);\r\n                    // Continue seeding even if moto fails\r\n                }\r\n            }\r\n\r\n            setDone(true);\r\n            setTimeout(() => setDone(false), 3000);\r\n        } catch (error) {\r\n            console.error(\"Error en Seeding (General):\", error);\r\n            alert(\"Fallo al inyectar datos. Revisa la consola.\");\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    if (user?.role !== 'franchise' && user?.role !== 'admin') return null;\r\n\r\n    return (\r\n        <button\r\n            onClick={seedData}\r\n            disabled={loading}\r\n            className=\"fixed bottom-6 right-6 bg-emerald-600 hover:bg-emerald-500 text-white p-4 rounded-full shadow-2xl z-[9999] flex items-center gap-2 transition-transform active:scale-90\"\r\n        >\r\n            {loading ? <Loader2 className=\"animate-spin\" size={24} /> : done ? <CheckCircle size={24} /> : <Database size={24} />}\r\n            <span className=\"font-bold uppercase tracking-wider\">Poblar Datos {user?.displayName ? `(${user.displayName})` : ''}</span>\r\n        </button>\r\n    );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\constants\\finance.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\constants\\labels.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\constants\\pageHelpData.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\context\\AuthContext.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":29,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":29,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1014,1017],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1014,1017],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":56,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":56,"endColumn":21,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { createContext, useContext, useState, useEffect, ReactNode } from \"react\";\r\nimport { auth, db } from \"../lib/firebase\";\r\nimport { onAuthStateChanged, signInWithEmailAndPassword, signOut, User } from \"firebase/auth\";\r\nimport { doc, getDoc, setDoc } from \"firebase/firestore\";\r\nimport { logAction, AUDIT_ACTIONS } from \"../lib/audit\";\r\n\r\n// =====================================================\r\n// TYPES & INTERFACES\r\n// =====================================================\r\n\r\nexport interface RoleConfig {\r\n    role?: string;\r\n    franchiseId?: string;\r\n    status?: 'active' | 'pending' | 'banned';\r\n    pack?: 'basic' | 'premium' | 'admin';\r\n    [key: string]: unknown;\r\n}\r\n\r\nexport interface AuthUser extends User {\r\n    role?: string;\r\n    franchiseId?: string;\r\n    status?: 'active' | 'pending' | 'banned';\r\n}\r\n\r\nexport interface AuthContextType {\r\n    user: AuthUser | null;\r\n    roleConfig: RoleConfig | null;\r\n    isAdmin: boolean;\r\n    login: (email: string, password: string) => Promise<any>;\r\n    logout: () => Promise<void>;\r\n    assignRole: (\r\n        targetUid: string,\r\n        role: string,\r\n        franchiseId?: string | null,\r\n        targetEmail?: string | null\r\n    ) => Promise<void>;\r\n    resetPassword: (email: string) => Promise<void>;\r\n    loading: boolean;\r\n    // Impersonation feature\r\n    impersonatedFranchiseId: string | null;\r\n    startImpersonation: (franchiseId: string) => void;\r\n    stopImpersonation: () => void;\r\n}\r\n\r\ninterface AuthProviderProps {\r\n    children: ReactNode;\r\n}\r\n\r\n// =====================================================\r\n// CONTEXT\r\n// =====================================================\r\n\r\nconst AuthContext = createContext<AuthContextType | undefined>(undefined);\r\n\r\n// eslint-disable-next-line react-refresh/only-export-components\r\nexport const useAuth = (): AuthContextType => {\r\n    const context = useContext(AuthContext);\r\n    if (!context) {\r\n        throw new Error(\"useAuth must be used within an AuthProvider\");\r\n    }\r\n    return context;\r\n};\r\n\r\nexport const AuthProvider: React.FC<AuthProviderProps> = ({ children }) => {\r\n    const [user, setUser] = useState<AuthUser | null>(null);\r\n    const [roleConfig, setRoleConfig] = useState<RoleConfig | null>(null);\r\n    const [loading, setLoading] = useState(true);\r\n    // ‚úÖ NUEVO: Estado calculado para facilitar la vida a los componentes\r\n    const [isAdmin, setIsAdmin] = useState(false);\r\n    // üé≠ IMPERSONATION: Para que el admin vea la app como una franquicia\r\n    const [impersonatedFranchiseId, setImpersonatedFranchiseId] = useState<string | null>(null);\r\n\r\n    useEffect(() => {\r\n        const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {\r\n            if (typeof getDoc !== 'function') console.error(\"CRITICAL: getDoc is not a function\");\r\n            try {\r\n                if (currentUser) {\r\n                    // 1. Obtener la configuraci√≥n real de la DB (NEW ARCHITECTURE: 'users')\r\n                    const configRef = doc(db, \"users\", currentUser.uid);\r\n                    const configSnap = await getDoc(configRef);\r\n\r\n                    let finalConfig: RoleConfig | null = null;\r\n\r\n                    if (configSnap.exists()) {\r\n                        finalConfig = configSnap.data() as RoleConfig;\r\n                    }\r\n\r\n                    // üö® SECURITY: BAN VERIFICATION\r\n                    if (finalConfig && finalConfig.status === 'banned') {\r\n                        await signOut(auth);\r\n                        setUser(null);\r\n                        return;\r\n                    }\r\n\r\n                    setRoleConfig(finalConfig);\r\n\r\n                    // üî• LA MAGIA: Inyectamos el rol DENTRO del objeto usuario\r\n                    const enhancedUser = currentUser as AuthUser;\r\n                    if (finalConfig) {\r\n                        if (finalConfig.role) enhancedUser.role = finalConfig.role;\r\n                        if (finalConfig.franchiseId) enhancedUser.franchiseId = finalConfig.franchiseId;\r\n                        if (finalConfig.status) enhancedUser.status = finalConfig.status;\r\n                    }\r\n\r\n                    // üöë SELF-HEALING: Ensure role is NEVER undefined\r\n                    if (!enhancedUser.role) {\r\n                        if (currentUser.email?.includes('rider')) {\r\n                            enhancedUser.role = 'rider';\r\n                        } else {\r\n                            enhancedUser.role = 'user'; // Default safe role\r\n                        }\r\n                    }\r\n\r\n                    console.log(`[Security] Auth Initialized: ${currentUser.email} as ${enhancedUser.role}`);\r\n\r\n                    // Calculamos si es admin de una vez por todas\r\n                    setIsAdmin(finalConfig?.role === 'admin');\r\n\r\n                    // Guardamos el usuario \"dopado\" con su rol\r\n                    setUser(enhancedUser);\r\n\r\n                } else {\r\n                    setUser(null);\r\n                    setRoleConfig(null);\r\n                    setIsAdmin(false);\r\n                }\r\n            } catch (err) {\r\n                console.error(\"Auth Initialization Error:\", err);\r\n                setRoleConfig(null);\r\n                setIsAdmin(false);\r\n            } finally {\r\n                setLoading(false);\r\n            }\r\n        });\r\n        return unsubscribe;\r\n    }, []);\r\n\r\n    const login = async (email: string, password: string) => {\r\n        const result = await signInWithEmailAndPassword(auth, email, password);\r\n        logAction(result.user, AUDIT_ACTIONS.LOGIN_SUCCESS, { method: 'email_password' });\r\n        return result;\r\n    };\r\n\r\n    const logout = async (): Promise<void> => {\r\n        if (user) {\r\n            logAction(user, AUDIT_ACTIONS.LOGOUT);\r\n        }\r\n        return signOut(auth);\r\n    };\r\n\r\n    const assignRole = async (\r\n        targetUid: string,\r\n        role: string,\r\n        franchiseId: string | null = null,\r\n        targetEmail: string | null = null\r\n    ): Promise<void> => {\r\n        // NEW ARCHITECTURE: Single Source of Truth -> 'users'\r\n        const payload: Record<string, unknown> = { role, franchiseId };\r\n        if (targetEmail) payload.email = targetEmail;\r\n\r\n        // Escribimos directamente en 'users' (identity + access)\r\n        await setDoc(doc(db, \"users\", targetUid), payload, { merge: true });\r\n\r\n        if (user && targetUid === user.uid) {\r\n            const newConfig: RoleConfig = { ...roleConfig, role, franchiseId: franchiseId || undefined };\r\n            setRoleConfig(newConfig);\r\n            // Actualizamos tambi√©n el helper\r\n            setIsAdmin(role === 'admin');\r\n            // Y el usuario en memoria\r\n            user.role = role;\r\n            user.franchiseId = franchiseId || undefined;\r\n            setUser({ ...user });\r\n        }\r\n    };\r\n\r\n    const startImpersonation = (franchiseId: string) => {\r\n        if (!isAdmin) return;\r\n        setImpersonatedFranchiseId(franchiseId);\r\n        if (user) {\r\n            setUser({ ...user, franchiseId, role: 'franchise' });\r\n        }\r\n    };\r\n\r\n    const stopImpersonation = () => {\r\n        setImpersonatedFranchiseId(null);\r\n        if (user && roleConfig) {\r\n            setUser({ ...user, franchiseId: roleConfig.franchiseId, role: roleConfig.role });\r\n        }\r\n    };\r\n\r\n    // üì¶ EXPORTAMOS EL PAQUETE COMPLETO\r\n    const value: AuthContextType = {\r\n        user,           // El usuario (ahora con .role inyectado)\r\n        roleConfig,     // La config pura\r\n        isAdmin,        // ‚úÖ El booleano m√°gico para abrir puertas\r\n        login,\r\n        logout,\r\n        assignRole,\r\n        resetPassword: async (email: string): Promise<void> => {\r\n            const { sendPasswordResetEmail } = await import(\"firebase/auth\");\r\n            return sendPasswordResetEmail(auth, email);\r\n        },\r\n        loading,\r\n        impersonatedFranchiseId,\r\n        startImpersonation,\r\n        stopImpersonation\r\n    };\r\n\r\n    return (\r\n        <AuthContext.Provider value={value}>\r\n            {!loading && children}\r\n        </AuthContext.Provider>\r\n    );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\context\\SupportContext.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Move your React context(s) to a separate file.","line":10,"column":14,"nodeType":"Identifier","messageId":"reactContext","endLine":10,"endColumn":28},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":10,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":10,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[538,541],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[538,541],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { createContext, ReactNode } from 'react';\r\nimport { useAuth } from './AuthContext';\r\nimport { useSupportManager } from '../hooks/useSupportManager';\r\n\r\n// Define the shape of the context. \r\n// Since useSupportManager is what we are exposing, we can try to infer it \r\n// or use 'any' if useSupportManager is complex/not migrated yet. \r\n// Ideally we should import the return type from useSupportManager.\r\n// For now, adhering to 'any' to unblock, but commenting for improvement.\r\nexport const SupportContext = createContext<any>(null);\r\nSupportContext.displayName = 'SupportContext';\r\n\r\ninterface SupportProviderProps {\r\n    children: ReactNode;\r\n}\r\n\r\nexport const SupportProvider: React.FC<SupportProviderProps> = ({ children }) => {\r\n    const { user } = useAuth();\r\n    // Assuming useSupportManager handles user possibly being null\r\n    const supportData = useSupportManager(user);\r\n\r\n    return (\r\n        <SupportContext.Provider value={supportData}>\r\n            {children}\r\n        </SupportContext.Provider>\r\n    );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\context\\ThemeContext.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":6,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":6,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, ReactNode, useContext } from 'react';\r\nimport { ThemeContext } from './contexts';\r\n\r\ntype Theme = 'light' | 'dark';\r\n\r\nexport const useTheme = () => useContext(ThemeContext);\r\n\r\ninterface ThemeContextType {\r\n    theme: Theme;\r\n    toggleTheme: () => void;\r\n}\r\n\r\ninterface ThemeProviderProps {\r\n    children: ReactNode;\r\n}\r\n\r\nexport const ThemeProvider: React.FC<ThemeProviderProps> = ({ children }) => {\r\n    const [theme, setTheme] = useState<Theme>(\r\n        () => (localStorage.getItem('theme') as Theme) || 'light'\r\n    );\r\n\r\n    useEffect(() => {\r\n        const root = window.document.documentElement;\r\n        if (theme === 'dark') {\r\n            root.classList.add('dark');\r\n        } else {\r\n            root.classList.remove('dark');\r\n        }\r\n        localStorage.setItem('theme', theme);\r\n    }, [theme]);\r\n\r\n    const toggleTheme = () => {\r\n        setTheme(prev => prev === 'light' ? 'dark' : 'light');\r\n    };\r\n\r\n    const value: ThemeContextType = { theme, toggleTheme };\r\n\r\n    return (\r\n        <ThemeContext.Provider value={value}>\r\n            {children}\r\n        </ThemeContext.Provider>\r\n    );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\context\\ToastContext.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\context\\contexts.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\declarations.d.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\academy\\Academy.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":21,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":21,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[876,879],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[876,879],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\r\nimport { useAuth } from '../../context/AuthContext';\r\nimport AcademyDashboard from './AcademyDashboard';\r\nimport AdminAcademyPanel from './AdminAcademyPanel';\r\nimport ModuleViewer from './ModuleViewer';\r\nimport { AcademyModule } from '../../hooks/useAcademy';\r\n\r\n/**\r\n * Academy Main Component - Punto de entrada principal\r\n * Maneja la vista admin vs franquiciado y la navegaci√≥n entre m√≥dulos\r\n */\r\nconst Academy: React.FC = () => {\r\n    const { isAdmin } = useAuth();\r\n    const [selectedModule, setSelectedModule] = useState<AcademyModule | null>(null);\r\n    const [activeView, setActiveView] = useState<'student' | 'admin'>(isAdmin ? 'admin' : 'student');\r\n\r\n    // Si hay un m√≥dulo seleccionado, mostrar el visor\r\n    if (selectedModule) {\r\n        return (\r\n            <ModuleViewer\r\n                module={selectedModule as any}\r\n                onBack={() => setSelectedModule(null)}\r\n            />\r\n        );\r\n    }\r\n\r\n    // Vista de administrador\r\n    if (isAdmin && activeView === 'admin') {\r\n        return (\r\n            <div className=\"min-h-screen bg-slate-50 dark:bg-slate-950 transition-colors duration-500\">\r\n                {/* Toggle View Bar - Floating Glass */}\r\n                <div className=\"sticky top-4 z-50 px-4 md:px-8 max-w-7xl mx-auto mb-[-2rem]\">\r\n                    <div className=\"bg-white/80 dark:bg-slate-900/60 backdrop-blur-xl border border-slate-200/50 dark:border-slate-800/50 rounded-2xl shadow-lg shadow-indigo-500/5 p-3 flex justify-between items-center\">\r\n                        <h2 className=\"text-sm font-bold text-slate-600 dark:text-slate-300 flex items-center gap-2 pl-2\">\r\n                            <span className=\"bg-indigo-100 dark:bg-indigo-500/10 p-1.5 rounded-lg text-indigo-600 dark:text-indigo-400\">üõ°Ô∏è</span>\r\n                            Vista de Administraci√≥n\r\n                        </h2>\r\n                        <button\r\n                            onClick={() => setActiveView('student')}\r\n                            className=\"px-4 py-2 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 rounded-xl hover:bg-indigo-50 dark:hover:bg-indigo-900/20 hover:text-indigo-600 dark:hover:text-indigo-400 font-bold transition-all text-xs tracking-wide border border-transparent hover:border-indigo-200 dark:hover:border-indigo-500/30\"\r\n                        >\r\n                            Ver como Estudiante\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n                <div className=\"pt-8\">\r\n                    <AdminAcademyPanel />\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    // Vista de estudiante (para admin tambi√©n puede verla)\r\n    return (\r\n        <div className=\"min-h-screen bg-slate-50 dark:bg-slate-950 transition-colors duration-500\">\r\n            {isAdmin && (\r\n                <div className=\"sticky top-4 z-50 px-4 md:px-8 max-w-7xl mx-auto mb-[-2rem]\">\r\n                    <div className=\"bg-white/80 dark:bg-slate-900/60 backdrop-blur-xl border border-slate-200/50 dark:border-slate-800/50 rounded-2xl shadow-lg shadow-indigo-500/5 p-3 flex justify-between items-center\">\r\n                        <h2 className=\"text-sm font-bold text-slate-600 dark:text-slate-300 flex items-center gap-2 pl-2\">\r\n                            <span className=\"bg-emerald-100 dark:bg-emerald-500/10 p-1.5 rounded-lg text-emerald-600 dark:text-emerald-400\">üéì</span>\r\n                            Vista de Estudiante\r\n                        </h2>\r\n                        <button\r\n                            onClick={() => setActiveView('admin')}\r\n                            className=\"px-4 py-2 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 rounded-xl hover:bg-slate-200 dark:hover:bg-slate-700 font-bold transition-all text-xs tracking-wide\"\r\n                        >\r\n                            Panel de Administraci√≥n\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n            )}\r\n            <div className={isAdmin ? \"pt-8\" : \"\"}>\r\n                <AcademyDashboard onModuleClick={(module) => setSelectedModule(module as AcademyModule)} />\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default Academy;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\academy\\AcademyAnalytics.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\academy\\AcademyDashboard.tsx","messages":[{"ruleId":"react-hooks/preserve-manual-memoization","severity":2,"message":"Compilation Skipped: Existing memoization could not be preserved\n\nReact Compiler has skipped optimizing this component because the existing manual memoization could not be preserved. The inferred dependencies did not match the manually specified dependencies, which could cause the value to change more or less frequently than expected. The inferred dependency was `getModuleStatus`, but the source dependencies were [modules, progress, searchQuery, statusFilter]. Inferred different dependency than source.\n\nC:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\academy\\AcademyDashboard.tsx:72:37\n  70 |\n  71 |     // Filtered and searched modules\n> 72 |     const filteredModules = useMemo(() => {\n     |                                     ^^^^^^^\n> 73 |         return modules.filter(module => {\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 74 |             const status = getModuleStatus(module);\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 75 |             const matchesSearch = module.title.toLowerCase().includes(searchQuery.toLowerCase()) ||\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 76 |                 module.description.toLowerCase().includes(searchQuery.toLowerCase());\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 77 |             const matchesFilter = statusFilter === 'all' || status === statusFilter;\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 78 |             return matchesSearch && matchesFilter;\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 79 |         });\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 80 |     }, [modules, progress, searchQuery, statusFilter]);\n     | ^^^^^^ Could not preserve existing manual memoization\n  81 |\n  82 |     // Statistics\n  83 |     const completedCount = modules.filter(m => getModuleStatus(m) === 'completed').length;","line":72,"column":37,"nodeType":null,"endLine":80,"endColumn":6},{"ruleId":"react-hooks/preserve-manual-memoization","severity":2,"message":"Compilation Skipped: Existing memoization could not be preserved\n\nReact Compiler has skipped optimizing this component because the existing manual memoization could not be preserved. The inferred dependencies did not match the manually specified dependencies, which could cause the value to change more or less frequently than expected. The inferred dependency was `getModuleStatus`, but the source dependencies were [modules, progress, searchQuery, statusFilter]. Inferred different dependency than source.\n\nC:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\academy\\AcademyDashboard.tsx:72:37\n  70 |\n  71 |     // Filtered and searched modules\n> 72 |     const filteredModules = useMemo(() => {\n     |                                     ^^^^^^^\n> 73 |         return modules.filter(module => {\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 74 |             const status = getModuleStatus(module);\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 75 |             const matchesSearch = module.title.toLowerCase().includes(searchQuery.toLowerCase()) ||\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 76 |                 module.description.toLowerCase().includes(searchQuery.toLowerCase());\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 77 |             const matchesFilter = statusFilter === 'all' || status === statusFilter;\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 78 |             return matchesSearch && matchesFilter;\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 79 |         });\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 80 |     }, [modules, progress, searchQuery, statusFilter]);\n     | ^^^^^^ Could not preserve existing manual memoization\n  81 |\n  82 |     // Statistics\n  83 |     const completedCount = modules.filter(m => getModuleStatus(m) === 'completed').length;","line":72,"column":37,"nodeType":null,"endLine":80,"endColumn":6},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useMemo has a missing dependency: 'getModuleStatus'. Either include it or remove the dependency array.","line":80,"column":8,"nodeType":"ArrayExpression","endLine":80,"endColumn":54,"suggestions":[{"desc":"Update the dependencies array to be: [getModuleStatus, modules, searchQuery, statusFilter]","fix":{"range":[2963,3009],"text":"[getModuleStatus, modules, searchQuery, statusFilter]"}}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { type FC, type ReactNode, useState, useMemo } from 'react';\r\nimport { BookOpen, Lock, CheckCircle, Clock, PlayCircle, Award, Search } from 'lucide-react';\r\nimport { useAcademyModules, useAcademyProgress } from '../../hooks/useAcademy';\r\nimport { useAuth } from '../../context/AuthContext';\r\n\r\ntype ModuleStatus = 'available' | 'locked' | 'in_progress' | 'completed';\r\n\r\ninterface Module {\r\n    id: string;\r\n    order: number;\r\n    title: string;\r\n    description: string;\r\n    duration?: string;\r\n    lessonCount?: number;\r\n}\r\n\r\ninterface AcademyDashboardProps {\r\n    onModuleClick: (module: Module) => void;\r\n}\r\n\r\n/**\r\n * Academy Dashboard - Vista principal de la academia\r\n * Para franquiciados: Muestra m√≥dulos y progreso\r\n */\r\nconst AcademyDashboard: FC<AcademyDashboardProps> = ({ onModuleClick }) => {\r\n    const { user } = useAuth();\r\n    const { modules, loading } = useAcademyModules();\r\n    const { progress, totalProgress } = useAcademyProgress(user?.uid ?? null);\r\n\r\n    // Filter and search state\r\n    const [searchQuery, setSearchQuery] = useState('');\r\n    const [statusFilter, setStatusFilter] = useState<ModuleStatus | 'all'>('all');\r\n\r\n    const getModuleStatus = (module: Module): ModuleStatus => {\r\n        const moduleProgress = progress[module.id];\r\n\r\n        if (!moduleProgress) {\r\n            // Verificar si est√° desbloqueado\r\n            if (module.order === 1) return 'available';\r\n\r\n            // Verificar si el m√≥dulo anterior est√° completado\r\n            const prevModule = modules.find(m => m.order === module.order - 1);\r\n            const prevProgress = progress[prevModule?.id || ''];\r\n\r\n            if (prevProgress && prevProgress.score && prevProgress.score >= 80) {\r\n                return 'available';\r\n            }\r\n\r\n            return 'locked';\r\n        }\r\n\r\n        if (moduleProgress.completed) return 'completed';\r\n        return 'in_progress';\r\n    };\r\n\r\n    const getStatusIcon = (status: ModuleStatus): ReactNode => {\r\n        switch (status) {\r\n            case 'completed':\r\n                return <CheckCircle className=\"w-6 h-6 text-emerald-500\" />;\r\n            case 'in_progress':\r\n                return <PlayCircle className=\"w-6 h-6 text-blue-500\" />;\r\n            case 'locked':\r\n                return <Lock className=\"w-6 h-6 text-slate-400\" />;\r\n            default:\r\n                return <BookOpen className=\"w-6 h-6 text-blue-500\" />;\r\n        }\r\n    };\r\n\r\n\r\n\r\n    // Filtered and searched modules\r\n    const filteredModules = useMemo(() => {\r\n        return modules.filter(module => {\r\n            const status = getModuleStatus(module);\r\n            const matchesSearch = module.title.toLowerCase().includes(searchQuery.toLowerCase()) ||\r\n                module.description.toLowerCase().includes(searchQuery.toLowerCase());\r\n            const matchesFilter = statusFilter === 'all' || status === statusFilter;\r\n            return matchesSearch && matchesFilter;\r\n        });\r\n    }, [modules, progress, searchQuery, statusFilter]);\r\n\r\n    // Statistics\r\n    const completedCount = modules.filter(m => getModuleStatus(m) === 'completed').length;\r\n    const inProgressCount = modules.filter(m => getModuleStatus(m) === 'in_progress').length;\r\n\r\n\r\n    if (loading) {\r\n        return (\r\n            <div className=\"flex items-center justify-center h-96\">\r\n                <div className=\"text-center\">\r\n                    <BookOpen className=\"w-12 h-12 mx-auto mb-4 text-blue-500 animate-pulse\" />\r\n                    <p className=\"text-slate-500 font-medium\">Cargando academia...</p>\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"min-h-screen bg-slate-50 dark:bg-slate-900 p-4 md:p-8 max-w-7xl mx-auto space-y-6 md:space-y-8 animate-fade-in\">\r\n            {/* Header */}\r\n            <div className=\"bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-3xl p-6 md:p-8 shadow-xl shadow-slate-200/50 dark:shadow-slate-900/50\">\r\n                <div className=\"flex flex-col gap-6\">\r\n                    {/* Title and Stats */}\r\n                    <div className=\"flex flex-col md:flex-row md:items-start justify-between gap-4\">\r\n                        <div>\r\n                            <h1 className=\"text-3xl md:text-4xl font-black mb-2 text-slate-900 dark:text-white\">üéì Academia Repaart</h1>\r\n                            <p className=\"text-slate-500 dark:text-slate-400 text-base md:text-lg\">\r\n                                Tu camino hacia la excelencia operativa\r\n                            </p>\r\n                        </div>\r\n                        <div className=\"flex gap-4\">\r\n                            <div className=\"text-center bg-indigo-50 dark:bg-indigo-950/30 p-4 rounded-xl border border-indigo-100 dark:border-indigo-900\">\r\n                                <p className=\"text-xs text-indigo-600 dark:text-indigo-400 mb-1 font-bold uppercase tracking-wider\">Progreso</p>\r\n                                <p className=\"text-3xl font-black text-indigo-900 dark:text-indigo-100\">{Math.round(totalProgress)}%</p>\r\n                            </div>\r\n                            <div className=\"text-center bg-emerald-50 dark:bg-emerald-950/30 p-4 rounded-xl border border-emerald-100 dark:border-emerald-900\">\r\n                                <p className=\"text-xs text-emerald-600 dark:text-emerald-400 mb-1 font-bold uppercase tracking-wider\">Completados</p>\r\n                                <p className=\"text-3xl font-black text-emerald-900 dark:text-emerald-100\">{completedCount}/{modules.length}</p>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Progress Bar */}\r\n                    <div className=\"bg-slate-100 dark:bg-slate-700 rounded-full h-4 overflow-hidden border border-slate-200 dark:border-slate-600\">\r\n                        <div\r\n                            className=\"bg-gradient-to-r from-indigo-500 to-purple-500 h-full transition-all duration-1000 ease-out shadow-[0_0_10px_rgba(99,102,241,0.4)]\"\r\n                            style={{ width: `${totalProgress}%` }}\r\n                        />\r\n                    </div>\r\n\r\n                    {/* Search and Filters */}\r\n                    <div className=\"flex flex-col sm:flex-row gap-3\">\r\n                        {/* Search Bar */}\r\n                        <div className=\"relative flex-1\">\r\n                            <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400\" />\r\n                            <input\r\n                                type=\"text\"\r\n                                placeholder=\"Buscar m√≥dulos...\"\r\n                                value={searchQuery}\r\n                                onChange={(e) => setSearchQuery(e.target.value)}\r\n                                className=\"w-full pl-10 pr-4 py-2.5 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl text-sm font-medium text-slate-900 dark:text-white placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent\"\r\n                            />\r\n                        </div>\r\n\r\n                        {/* Filter Buttons */}\r\n                        <div className=\"flex gap-2 bg-slate-100 dark:bg-slate-700 p-1 rounded-xl border border-slate-200 dark:border-slate-600\">\r\n                            <button\r\n                                onClick={() => setStatusFilter('all')}\r\n                                className={`px-4 py-2 rounded-lg text-xs font-bold transition ${statusFilter === 'all'\r\n                                    ? 'bg-white dark:bg-slate-600 text-indigo-600 dark:text-indigo-400 shadow-sm'\r\n                                    : 'text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200'\r\n                                    }`}\r\n                            >\r\n                                Todos ({modules.length})\r\n                            </button>\r\n                            <button\r\n                                onClick={() => setStatusFilter('in_progress')}\r\n                                className={`px-4 py-2 rounded-lg text-xs font-bold transition ${statusFilter === 'in_progress'\r\n                                    ? 'bg-white dark:bg-slate-600 text-blue-600 dark:text-blue-400 shadow-sm'\r\n                                    : 'text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200'\r\n                                    }`}\r\n                            >\r\n                                En Curso ({inProgressCount})\r\n                            </button>\r\n                            <button\r\n                                onClick={() => setStatusFilter('completed')}\r\n                                className={`px-4 py-2 rounded-lg text-xs font-bold transition ${statusFilter === 'completed'\r\n                                    ? 'bg-white dark:bg-slate-600 text-emerald-600 dark:text-emerald-400 shadow-sm'\r\n                                    : 'text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200'\r\n                                    }`}\r\n                            >\r\n                                Completados ({completedCount})\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Modules Grid */}\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6\">\r\n                {filteredModules.map((module) => {\r\n                    const status = getModuleStatus(module);\r\n                    const moduleProgress = progress[module.id];\r\n                    const isLocked = status === 'locked';\r\n                    // Dynamic border color based on status\r\n                    const borderColor = status === 'completed' ? 'border-emerald-200' : status === 'in_progress' ? 'border-indigo-200' : 'border-slate-200';\r\n                    const bgColor = status === 'completed' ? 'bg-emerald-50/30' : status === 'in_progress' ? 'bg-white' : 'bg-slate-50/50';\r\n\r\n                    return (\r\n                        <div\r\n                            key={module.id}\r\n                            onClick={() => !isLocked && onModuleClick(module)}\r\n                            className={`\r\n                                relative rounded-2xl border ${borderColor} ${bgColor} p-6 transition-all duration-300\r\n                                ${!isLocked ? 'cursor-pointer hover:shadow-xl hover:shadow-indigo-500/10 hover:-translate-y-1 hover:border-indigo-300' : 'cursor-not-allowed opacity-80'}\r\n                            `}\r\n                        >\r\n                            {/* Status Badge */}\r\n                            <div className=\"absolute top-4 right-4\">\r\n                                {getStatusIcon(status)}\r\n                            </div>\r\n\r\n                            {/* Module Info */}\r\n                            <div className=\"mb-4\">\r\n                                <div className=\"flex items-center gap-2 mb-2\">\r\n                                    <span className=\"text-xs font-bold text-slate-500 uppercase tracking-wider bg-slate-100 px-2 py-1 rounded-md\">\r\n                                        M√≥dulo {module.order}\r\n                                    </span>\r\n                                    {module.duration && (\r\n                                        <span className=\"flex items-center text-xs text-slate-500 font-medium\">\r\n                                            <Clock className=\"w-3 h-3 mr-1\" />\r\n                                            {module.duration}\r\n                                        </span>\r\n                                    )}\r\n                                </div>\r\n                                <h3 className={`text-xl font-black mb-2 line-clamp-2 ${isLocked ? 'text-slate-400' : 'text-slate-900'}`}>\r\n                                    {module.title}\r\n                                </h3>\r\n                                <p className=\"text-sm text-slate-600 line-clamp-3 leading-relaxed\">\r\n                                    {module.description}\r\n                                </p>\r\n                            </div>\r\n\r\n                            {/* Progress */}\r\n                            {moduleProgress && (\r\n                                <div className=\"space-y-2 mt-6\">\r\n                                    <div className=\"flex justify-between items-center text-xs font-bold\">\r\n                                        <span className=\"text-slate-500\">\r\n                                            {moduleProgress.completedLessons || 0}/{module.lessonCount || 0} lecciones\r\n                                        </span>\r\n                                        <span className=\"text-indigo-600\">\r\n                                            {Math.round(moduleProgress.progress || 0)}%\r\n                                        </span>\r\n                                    </div>\r\n                                    <div className=\"bg-slate-100 rounded-full h-2 overflow-hidden border border-slate-200\">\r\n                                        <div\r\n                                            className=\"bg-indigo-500 h-full transition-all duration-500\"\r\n                                            style={{ width: `${moduleProgress.progress || 0}%` }}\r\n                                        />\r\n                                    </div>\r\n                                </div>\r\n                            )}\r\n\r\n                            {/* Certificate Badge */}\r\n                            {status === 'completed' && moduleProgress?.score && moduleProgress.score >= 80 && (\r\n                                <div className=\"mt-4 flex items-center gap-2 text-emerald-700 bg-emerald-50 px-3 py-2 rounded-lg text-xs font-bold border border-emerald-100\">\r\n                                    <Award className=\"w-4 h-4\" />\r\n                                    Certificado: {moduleProgress.score}%\r\n                                </div>\r\n                            )}\r\n\r\n                            {/* Locked Message */}\r\n                            {isLocked && (\r\n                                <div className=\"mt-4 text-xs text-slate-400 italic flex items-center gap-1 bg-slate-100 px-3 py-2 rounded-lg\">\r\n                                    <Lock className=\"w-3 h-3\" />\r\n                                    M√≥dulo bloqueado\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    );\r\n                })}\r\n            </div>\r\n\r\n            {/* Empty State */}\r\n            {modules.length === 0 && (\r\n                <div className=\"text-center py-20 bg-white rounded-3xl border border-slate-200 border-dashed\">\r\n                    <BookOpen className=\"w-16 h-16 mx-auto mb-4 text-slate-300\" />\r\n                    <h3 className=\"text-xl font-bold text-slate-700 mb-2\">\r\n                        No hay m√≥dulos disponibles\r\n                    </h3>\r\n                    <p className=\"text-slate-500\">\r\n                        Los m√≥dulos aparecer√°n aqu√≠ cuando el administrador los publique\r\n                    </p>\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default AcademyDashboard;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\academy\\AdminAcademyPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\academy\\BrutalLearningView.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\academy\\CalculatorWidget.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":282,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":282,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14024,14027],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14024,14027],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useMemo, type FC, type ChangeEvent } from 'react';\r\nimport { TrendingUp, RefreshCw, Coins, type LucideIcon, ArrowRight } from 'lucide-react';\r\nimport { formatMoney } from '../../lib/finance';\r\n\r\ntype CalculatorType = 'profitability' | 'roi' | 'taxes';\r\n\r\ninterface ProfitabilityValues {\r\n    orders?: number;\r\n    ticket?: number;\r\n    riders?: number;\r\n    costPerOrder?: number;\r\n}\r\n\r\ninterface ROIValues {\r\n    investment?: number;\r\n    monthlyProfit?: number;\r\n}\r\n\r\ninterface TaxesValues {\r\n    revenue?: number;\r\n    expenses?: number;\r\n}\r\n\r\ntype CalculatorValues = ProfitabilityValues | ROIValues | TaxesValues;\r\n\r\ninterface ProfitabilityResult {\r\n    revenue: number;\r\n    costs: number;\r\n    profit: number;\r\n    margin: number;\r\n}\r\n\r\ninterface ROIResult {\r\n    months: number;\r\n    annualRoi: number;\r\n}\r\n\r\ninterface TaxesResult {\r\n    ivaPagar: number;\r\n    irpf: number;\r\n    totalTaxes: number;\r\n}\r\n\r\ntype CalculatorResult = ProfitabilityResult | ROIResult | TaxesResult | null;\r\n\r\ninterface CalculatorWidgetProps {\r\n    type?: CalculatorType;\r\n}\r\n\r\ninterface CalculatorConfig {\r\n    title: string;\r\n    icon: LucideIcon;\r\n    color: string;\r\n    bgColor: string;\r\n    render: () => React.ReactElement;\r\n}\r\n\r\n/**\r\n * CalculatorWidget - Componente interactivo para lecciones\r\n * Tipos soportados: 'profitability', 'roi', 'taxes'\r\n */\r\nconst CalculatorWidget: FC<CalculatorWidgetProps> = ({ type = 'profitability' }) => {\r\n    // --- STATE MANAGEMENT ---\r\n    const [values, setValues] = useState<CalculatorValues>(() => {\r\n        if (type === 'profitability') return { orders: 800, ticket: 7.5, riders: 4, costPerOrder: 6.2 };\r\n        if (type === 'roi') return { investment: 4000, monthlyProfit: 1200 };\r\n        if (type === 'taxes') return { revenue: 6000, expenses: 4500 };\r\n        return {};\r\n    });\r\n\r\n    useEffect(() => {\r\n        const timer = setTimeout(() => {\r\n            if (type === 'profitability') setValues({ orders: 800, ticket: 7.5, riders: 4, costPerOrder: 6.2 });\r\n            else if (type === 'roi') setValues({ investment: 4000, monthlyProfit: 1200 });\r\n            else if (type === 'taxes') setValues({ revenue: 6000, expenses: 4500 });\r\n        }, 0);\r\n        return () => clearTimeout(timer);\r\n    }, [type]);\r\n\r\n    const result = useMemo((): CalculatorResult => {\r\n        if (Object.keys(values).length === 0) return null;\r\n\r\n        if (type === 'profitability') {\r\n            const v = values as ProfitabilityValues;\r\n            const revenue = (v.orders || 0) * (v.ticket || 0);\r\n            const costs = (v.orders || 0) * (v.costPerOrder || 0);\r\n            const profit = revenue - costs;\r\n            const margin = revenue > 0 ? (profit / revenue) * 100 : 0;\r\n            return { revenue, costs, profit, margin } as ProfitabilityResult;\r\n        }\r\n        else if (type === 'roi') {\r\n            const v = values as ROIValues;\r\n            const months = (v.monthlyProfit || 0) > 0 ? (v.investment || 0) / (v.monthlyProfit || 0) : 0;\r\n            const annualRoi = (v.investment || 0) > 0 ? (((v.monthlyProfit || 0) * 12) / (v.investment || 0)) * 100 : 0;\r\n            return { months: Math.ceil(months), annualRoi } as ROIResult;\r\n        }\r\n        else if (type === 'taxes') {\r\n            const v = values as TaxesValues;\r\n            const ivaRepercutido = (v.revenue || 0) * 0.21;\r\n            const ivaSoportado = (v.expenses || 0) * 0.21;\r\n            const ivaPagar = ivaRepercutido - ivaSoportado;\r\n            const profitPreTax = (v.revenue || 0) - (v.expenses || 0);\r\n            const irpf = profitPreTax > 0 ? profitPreTax * 0.20 : 0;\r\n            return { ivaPagar, irpf, totalTaxes: ivaPagar + irpf } as TaxesResult;\r\n        }\r\n        return null;\r\n    }, [values, type]);\r\n\r\n    const handleChange = (key: string, val: string): void => {\r\n        setValues(prev => ({ ...prev, [key]: parseFloat(val) || 0 }));\r\n    };\r\n\r\n    const renderProfitability = (): React.ReactElement => {\r\n        const v = values as ProfitabilityValues;\r\n        const r = result as ProfitabilityResult | null;\r\n\r\n        return (\r\n            <div className=\"space-y-6\">\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                    <div>\r\n                        <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\" htmlFor=\"orders\">\r\n                            Pedidos Mensuales\r\n                        </label>\r\n                        <input\r\n                            id=\"orders\"\r\n                            type=\"number\"\r\n                            value={v.orders || ''}\r\n                            onChange={(e: ChangeEvent<HTMLInputElement>) => handleChange('orders', e.target.value)}\r\n                            className=\"w-full p-3 border border-slate-200 rounded-xl font-mono text-slate-700 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-slate-50 focus:bg-white transition-colors\"\r\n                            placeholder=\"Ej: 800\"\r\n                            aria-label=\"N√∫mero de pedidos mensuales\"\r\n                        />\r\n                    </div>\r\n                    <div>\r\n                        <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\" htmlFor=\"ticket\">\r\n                            Ticket Medio (‚Ç¨)\r\n                        </label>\r\n                        <input\r\n                            id=\"ticket\"\r\n                            type=\"number\"\r\n                            value={v.ticket || ''}\r\n                            onChange={(e: ChangeEvent<HTMLInputElement>) => handleChange('ticket', e.target.value)}\r\n                            className=\"w-full p-3 border border-slate-200 rounded-xl font-mono text-slate-700 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-slate-50 focus:bg-white transition-colors\"\r\n                            placeholder=\"Ej: 15.50\"\r\n                            aria-label=\"Valor del ticket medio en euros\"\r\n                        />\r\n                    </div>\r\n                </div>\r\n\r\n                {r && (\r\n                    <div className=\"bg-indigo-50 rounded-2xl p-6 border border-indigo-100 flex items-center justify-between\">\r\n                        <div>\r\n                            <p className=\"text-xs text-indigo-600 font-bold uppercase tracking-wider mb-1\">Ingresos</p>\r\n                            <p className=\"text-xl font-black text-indigo-900\">{formatMoney(r.revenue)}‚Ç¨</p>\r\n                        </div>\r\n                        <ArrowRight className=\"text-indigo-300 w-5 h-5\" />\r\n                        <div className=\"text-right\">\r\n                            <p className=\"text-xs text-slate-500 font-bold uppercase tracking-wider mb-1\">Beneficio Est.</p>\r\n                            <p className={`text-2xl font-black ${r.profit >= 0 ? 'text-emerald-600' : 'text-rose-600'}`}>\r\n                                {formatMoney(r.profit)}‚Ç¨\r\n                            </p>\r\n                        </div>\r\n                    </div>\r\n                )}\r\n            </div>\r\n        );\r\n    };\r\n\r\n    const renderROI = (): React.ReactElement => {\r\n        const v = values as ROIValues;\r\n        const r = result as ROIResult | null;\r\n        return (\r\n            <div className=\"space-y-6\">\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                    <div>\r\n                        <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\" htmlFor=\"investment\">\r\n                            Inversi√≥n Inicial (‚Ç¨)\r\n                        </label>\r\n                        <input\r\n                            id=\"investment\"\r\n                            type=\"number\"\r\n                            value={v.investment || ''}\r\n                            onChange={(e: ChangeEvent<HTMLInputElement>) => handleChange('investment', e.target.value)}\r\n                            className=\"w-full p-3 border border-slate-200 rounded-xl font-mono text-slate-700 focus:ring-2 focus:ring-purple-500 bg-slate-50 focus:bg-white transition-colors\"\r\n                            placeholder=\"Ej: 5000\"\r\n                            aria-label=\"Inversi√≥n inicial\"\r\n                        />\r\n                    </div>\r\n                    <div>\r\n                        <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\" htmlFor=\"monthlyProfit\">\r\n                            Beneficio Mensual (‚Ç¨)\r\n                        </label>\r\n                        <input\r\n                            id=\"monthlyProfit\"\r\n                            type=\"number\"\r\n                            value={v.monthlyProfit || ''}\r\n                            onChange={(e: ChangeEvent<HTMLInputElement>) => handleChange('monthlyProfit', e.target.value)}\r\n                            className=\"w-full p-3 border border-slate-200 rounded-xl font-mono text-slate-700 focus:ring-2 focus:ring-purple-500 bg-slate-50 focus:bg-white transition-colors\"\r\n                            placeholder=\"Ej: 2000\"\r\n                            aria-label=\"Beneficio mensual estimado\"\r\n                        />\r\n                    </div>\r\n                </div>\r\n\r\n                {r && (\r\n                    <div className=\"bg-purple-50 rounded-2xl p-6 border border-purple-100 grid grid-cols-2 gap-8 relative overflow-hidden\">\r\n                        <div className=\"relative z-10\">\r\n                            <p className=\"text-xs text-purple-600 uppercase font-bold tracking-wider mb-1\">Retorno</p>\r\n                            <p className=\"text-3xl font-black text-purple-900\">{r.months} <span className=\"text-base font-bold text-purple-500\">Meses</span></p>\r\n                        </div>\r\n                        <div className=\"text-right relative z-10\">\r\n                            <p className=\"text-xs text-purple-600 uppercase font-bold tracking-wider mb-1\">ROI Anual</p>\r\n                            <p className=\"text-3xl font-black text-purple-900\">{r.annualRoi.toFixed(0)}%</p>\r\n                        </div>\r\n                        <div className=\"absolute inset-0 bg-gradient-to-r from-purple-100/30 to-purple-50 pointer-events-none\" />\r\n                    </div>\r\n                )}\r\n            </div>\r\n        );\r\n    };\r\n\r\n    const renderTaxes = (): React.ReactElement => {\r\n        const v = values as TaxesValues;\r\n        const r = result as TaxesResult | null;\r\n        return (\r\n            <div className=\"space-y-6\">\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                    <div>\r\n                        <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\" htmlFor=\"revenue\">\r\n                            Ingresos Base (‚Ç¨)\r\n                        </label>\r\n                        <input\r\n                            id=\"revenue\"\r\n                            type=\"number\"\r\n                            value={v.revenue || ''}\r\n                            onChange={(e: ChangeEvent<HTMLInputElement>) => handleChange('revenue', e.target.value)}\r\n                            className=\"w-full p-3 border border-slate-200 rounded-xl font-mono text-slate-700 focus:ring-2 focus:ring-orange-500 bg-slate-50 focus:bg-white transition-colors\"\r\n                            placeholder=\"Ej: 10000\"\r\n                            aria-label=\"Ingresos base\"\r\n                        />\r\n                    </div>\r\n                    <div>\r\n                        <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\" htmlFor=\"expenses\">\r\n                            Gastos Base (‚Ç¨)\r\n                        </label>\r\n                        <input\r\n                            id=\"expenses\"\r\n                            type=\"number\"\r\n                            value={v.expenses || ''}\r\n                            onChange={(e: ChangeEvent<HTMLInputElement>) => handleChange('expenses', e.target.value)}\r\n                            className=\"w-full p-3 border border-slate-200 rounded-xl font-mono text-slate-700 focus:ring-2 focus:ring-orange-500 bg-slate-50 focus:bg-white transition-colors\"\r\n                            placeholder=\"Ej: 5000\"\r\n                            aria-label=\"Gastos base\"\r\n                        />\r\n                    </div>\r\n                </div>\r\n\r\n                {r && (\r\n                    <div className=\"bg-orange-50 rounded-2xl p-6 border border-orange-100\">\r\n                        <div className=\"space-y-4\">\r\n                            <div className=\"flex justify-between items-center border-b border-orange-200/50 pb-3\">\r\n                                <span className=\"text-orange-800 font-medium text-sm\">IVA a Pagar (Modelo 303):</span>\r\n                                <span className=\"font-bold text-orange-900 text-lg\">{formatMoney(r.ivaPagar)}‚Ç¨</span>\r\n                            </div>\r\n                            <div className=\"flex justify-between items-center\">\r\n                                <span className=\"text-orange-900 font-bold text-base uppercase tracking-wider\">Total Trimestre:</span>\r\n                                <span className=\"text-orange-900 font-black text-2xl\">{formatMoney(r.totalTaxes * 3)}‚Ç¨</span>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                )}\r\n            </div>\r\n        );\r\n    };\r\n\r\n    const configs: Record<CalculatorType, CalculatorConfig> = {\r\n        profitability: { title: 'Simulador de Rentabilidad', icon: TrendingUp, color: 'text-indigo-600', bgColor: 'bg-indigo-50', render: renderProfitability },\r\n        roi: { title: 'Calculadora ROI', icon: RefreshCw, color: 'text-purple-600', bgColor: 'bg-purple-50', render: renderROI },\r\n        taxes: { title: 'Estimador Fiscal', icon: Coins, color: 'text-orange-600', bgColor: 'bg-orange-50', render: renderTaxes },\r\n    };\r\n\r\n    const config = (configs as any)[type] || configs.profitability;\r\n    const Icon = config.icon;\r\n\r\n    return (\r\n        <div className=\"my-8 max-w-lg mx-auto bg-white rounded-3xl shadow-xl shadow-slate-200/50 border border-slate-200 overflow-hidden transform transition-all hover:scale-[1.01]\">\r\n            <div className={`p-5 ${config.bgColor} border-b border-slate-100 flex items-center gap-4`}>\r\n                <div className={`p-2.5 rounded-xl bg-white shadow-sm ${config.color}`}>\r\n                    <Icon className=\"w-5 h-5\" />\r\n                </div>\r\n                <h3 className=\"font-bold text-slate-800 text-lg\">{config.title}</h3>\r\n            </div>\r\n            <div className=\"p-8\">\r\n                {config.render()}\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default CalculatorWidget;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\academy\\CreateExampleModuleButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\academy\\LessonEditor.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":15,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":15,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[515,518],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[515,518],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\r\nimport { ArrowLeft, Plus, Edit2, Trash2, Save, X, Eye, Code, GripVertical } from 'lucide-react';\r\nimport ReactMarkdown from 'react-markdown';\r\nimport { useModuleLessons, useCreateLesson, useUpdateLesson, useDeleteLesson, Lesson, AcademyModule } from '../../hooks/useAcademy';\r\n\r\ninterface LessonEditorProps {\r\n    module: AcademyModule;\r\n    onBack: () => void;\r\n}\r\n\r\ninterface LessonFormData {\r\n    title: string;\r\n    content: string;\r\n    order: number;\r\n    resources: any[];\r\n}\r\n\r\n/**\r\n * Lesson Editor - CRUD completo de lecciones para un m√≥dulo\r\n * Design: Executive Glass\r\n */\r\nconst LessonEditor: React.FC<LessonEditorProps> = ({ module, onBack }) => {\r\n    const { lessons, loading } = useModuleLessons(module.id);\r\n    const createLesson = useCreateLesson();\r\n    const updateLesson = useUpdateLesson();\r\n    const deleteLesson = useDeleteLesson();\r\n\r\n    const [editingLesson, setEditingLesson] = useState<Lesson | null>(null);\r\n    const [isCreating, setIsCreating] = useState(false);\r\n    const [showPreview, setShowPreview] = useState(false);\r\n    const [formData, setFormData] = useState<LessonFormData>({\r\n        title: '',\r\n        content: '',\r\n        order: lessons.length + 1,\r\n        resources: []\r\n    });\r\n\r\n    const handleCreate = async () => {\r\n        if (!formData.title.trim() || !formData.content.trim()) {\r\n            alert('El t√≠tulo y el contenido son obligatorios');\r\n            return;\r\n        }\r\n\r\n        try {\r\n            await createLesson({\r\n                moduleId: module.id,\r\n                ...formData,\r\n                order: lessons.length + 1\r\n            });\r\n\r\n            setFormData({ title: '', content: '', order: lessons.length + 2, resources: [] });\r\n            setIsCreating(false);\r\n        } catch (error) {\r\n            console.error('Error creating lesson:', error);\r\n            alert('Error al crear la lecci√≥n');\r\n        }\r\n    };\r\n\r\n    const handleUpdate = async (lessonId: string) => {\r\n        if (!editingLesson) return;\r\n        try {\r\n            await updateLesson(lessonId, editingLesson);\r\n            setEditingLesson(null);\r\n        } catch (error) {\r\n            console.error('Error updating lesson:', error);\r\n            alert('Error al actualizar la lecci√≥n');\r\n        }\r\n    };\r\n\r\n    const handleDelete = async (lessonId: string, lessonTitle: string) => {\r\n        if (!confirm(`¬øSeguro que quieres eliminar \"${lessonTitle}\" ? `)) {\r\n            return;\r\n        }\r\n\r\n        try {\r\n            await deleteLesson(lessonId);\r\n        } catch (error) {\r\n            console.error('Error deleting lesson:', error);\r\n            alert('Error al eliminar la lecci√≥n');\r\n        }\r\n    };\r\n\r\n    if (loading) {\r\n        return (\r\n            <div className=\"flex items-center justify-center h-96\">\r\n                <div className=\"text-center\">\r\n                    <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500 mx-auto mb-4\" />\r\n                    <p className=\"text-slate-500 font-medium\">Cargando lecciones...</p>\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"min-h-screen bg-white dark:bg-slate-950 relative overflow-hidden p-8 max-w-7xl mx-auto space-y-8\">\r\n            {/* Atmospheric Backgrounds */}\r\n            <div className=\"absolute top-[-5%] right-[-5%] w-[35%] h-[35%] bg-indigo-500/5 rounded-full blur-[100px] animate-pulse\" />\r\n\r\n            <div className=\"relative z-10 space-y-8 animate-in fade-in duration-1000\">\r\n                {/* Header */}\r\n                <div className=\"flex flex-col md:flex-row md:items-center justify-between gap-6\">\r\n                    <div>\r\n                        <button\r\n                            onClick={onBack}\r\n                            className=\"flex items-center gap-2 text-indigo-600 dark:text-indigo-400 hover:text-indigo-700 font-medium mb-4 transition-all group\"\r\n                        >\r\n                            <ArrowLeft className=\"w-4 h-4 group-hover:-translate-x-1 transition-transform\" />\r\n                            <span className=\"text-[13px]\">Volver a la arquitectura</span>\r\n                        </button>\r\n                        <h1 className=\"text-3xl font-medium text-slate-900 dark:text-white tracking-tight flex items-center gap-3\">\r\n                            Gesti√≥n de Lecciones\r\n                        </h1>\r\n                        <div className=\"mt-2 flex items-center gap-2 text-sm text-slate-500 dark:text-slate-400\">\r\n                            M√≥dulo: <span className=\"font-medium text-indigo-600 dark:text-indigo-400 bg-indigo-500/5 px-3 py-1 rounded-full border border-indigo-500/10\">{module.title}</span>\r\n                        </div>\r\n                    </div>\r\n                    {!isCreating && !editingLesson && (\r\n                        <button\r\n                            onClick={() => setIsCreating(true)}\r\n                            className=\"flex items-center gap-2 px-6 py-3 bg-indigo-600 text-white rounded-[1.2rem] hover:bg-indigo-700 font-medium shadow-xl shadow-indigo-600/20 transition-all active:scale-[0.98] text-sm\"\r\n                        >\r\n                            <Plus className=\"w-4 h-4\" />\r\n                            Nueva Lecci√≥n\r\n                        </button>\r\n                    )}\r\n                </div>\r\n\r\n                {/* Create/Edit Lesson Form - Deep Glass */}\r\n                {(isCreating || editingLesson) && (\r\n                    <div className=\"bg-white/70 dark:bg-slate-900/40 backdrop-blur-2xl rounded-[2.5rem] border border-slate-200/40 dark:border-slate-800/40 p-8 shadow-2xl shadow-indigo-500/[0.05] animate-in fade-in slide-in-from-top-8 duration-700 overflow-hidden relative\">\r\n                        <div className=\"absolute top-0 right-0 w-64 h-64 bg-indigo-500/[0.03] rounded-full blur-3xl -mr-32 -mt-32\" />\r\n\r\n                        <div className=\"relative z-10 flex items-center justify-between mb-8 pb-6 border-b border-slate-200/40 dark:border-slate-800/40\">\r\n                            <div className=\"flex items-center gap-6\">\r\n                                <h3 className=\"text-xl font-medium text-slate-900 dark:text-white flex items-center gap-3\">\r\n                                    <div className=\"p-2 bg-indigo-500/10 rounded-xl\">\r\n                                        {editingLesson ? <Edit2 className=\"w-5 h-5 text-indigo-600 dark:text-indigo-400\" /> : <Plus className=\"w-5 h-5 text-indigo-600 dark:text-indigo-400\" />}\r\n                                    </div>\r\n                                    {editingLesson ? 'Editar Lecci√≥n' : 'Crear Nueva Lecci√≥n'}\r\n                                </h3>\r\n                                <div className=\"h-6 w-px bg-slate-200 dark:bg-slate-800\" />\r\n                                <div className=\"flex bg-slate-100/50 dark:bg-slate-800/50 p-1 rounded-xl border border-slate-200/40 dark:border-slate-700/40\">\r\n                                    <button\r\n                                        onClick={() => setShowPreview(false)}\r\n                                        className={`flex items-center gap-2 px-4 py-2 rounded-lg text-[11px] font-medium uppercase tracking-wider transition-all ${!showPreview\r\n                                            ? 'bg-white dark:bg-slate-700 text-indigo-600 dark:text-indigo-400 shadow-sm'\r\n                                            : 'text-slate-500 hover:text-slate-700 dark:hover:text-slate-300'\r\n                                            }`}\r\n                                    >\r\n                                        <Code className=\"w-3.5 h-3.5\" />\r\n                                        Dise√±o\r\n                                    </button>\r\n                                    <button\r\n                                        onClick={() => setShowPreview(true)}\r\n                                        className={`flex items-center gap-2 px-4 py-2 rounded-lg text-[11px] font-medium uppercase tracking-wider transition-all ${showPreview\r\n                                            ? 'bg-white dark:bg-slate-700 text-indigo-600 dark:text-indigo-400 shadow-sm'\r\n                                            : 'text-slate-500 hover:text-slate-700 dark:hover:text-slate-300'\r\n                                            }`}\r\n                                    >\r\n                                        <Eye className=\"w-3.5 h-3.5\" />\r\n                                        Vista Previa\r\n                                    </button>\r\n                                </div>\r\n                            </div>\r\n                            <button\r\n                                onClick={() => {\r\n                                    setIsCreating(false);\r\n                                    setEditingLesson(null);\r\n                                    setShowPreview(false);\r\n                                }}\r\n                                className=\"p-2.5 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full transition-all text-slate-400 hover:text-slate-600 dark:hover:text-slate-200\"\r\n                                title=\"Cerrar editor\"\r\n                            >\r\n                                <X className=\"w-5 h-5\" />\r\n                            </button>\r\n                        </div>\r\n\r\n                        {!showPreview ? (\r\n                            <div className=\"space-y-6\">\r\n                                <div>\r\n                                    <label className=\"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2\">\r\n                                        T√≠tulo de la Lecci√≥n *\r\n                                    </label>\r\n                                    <input\r\n                                        type=\"text\"\r\n                                        value={editingLesson ? editingLesson.title : formData.title}\r\n                                        onChange={(e) => editingLesson\r\n                                            ? setEditingLesson({ ...editingLesson, title: e.target.value })\r\n                                            : setFormData({ ...formData, title: e.target.value })\r\n                                        }\r\n                                        placeholder=\"Ej: Introducci√≥n al Modelo de Negocio\"\r\n                                        className=\"w-full px-4 py-3 border border-slate-200 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 font-medium bg-slate-50 dark:bg-slate-900/50 text-slate-900 dark:text-white focus:bg-white dark:focus:bg-slate-900 transition-colors\"\r\n                                    />\r\n                                </div>\r\n\r\n                                <div>\r\n                                    <label className=\"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2\">\r\n                                        Contenido (Markdown) *\r\n                                    </label>\r\n\r\n                                    {/* Toolbar */}\r\n                                    <div className=\"flex flex-wrap gap-2 mb-2 p-2 bg-slate-50 dark:bg-slate-900/30 border border-slate-200 dark:border-slate-800 rounded-lg\">\r\n                                        <button\r\n                                            onClick={() => {\r\n                                                const content = editingLesson ? editingLesson.content : formData.content;\r\n                                                const update = (val: string) => editingLesson ? setEditingLesson({ ...editingLesson, content: val }) : setFormData({ ...formData, content: val });\r\n                                                update(content + '\\n\\n**Negrita**');\r\n                                            }}\r\n                                            className=\"px-2 py-1 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded hover:bg-slate-50 dark:hover:bg-slate-700 text-xs font-bold text-slate-700 dark:text-slate-300 shadow-sm\"\r\n                                            title=\"Negrita\"\r\n                                        >\r\n                                            B\r\n                                        </button>\r\n                                        <button\r\n                                            onClick={() => {\r\n                                                const content = editingLesson ? editingLesson.content : formData.content;\r\n                                                const update = (val: string) => editingLesson ? setEditingLesson({ ...editingLesson, content: val }) : setFormData({ ...formData, content: val });\r\n                                                update(content + '\\n\\n*Cursiva*');\r\n                                            }}\r\n                                            className=\"px-2 py-1 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded hover:bg-slate-50 dark:hover:bg-slate-700 text-xs italic font-bold text-slate-700 dark:text-slate-300 shadow-sm\"\r\n                                            title=\"Cursiva\"\r\n                                        >\r\n                                            I\r\n                                        </button>\r\n                                        <div className=\"w-px bg-slate-300 dark:bg-slate-700 mx-2\" />\r\n                                        <span className=\"text-xs font-bold text-slate-500 dark:text-slate-400 self-center uppercase tracking-wider\">Widgets:</span>\r\n\r\n                                        <button\r\n                                            onClick={() => {\r\n                                                const content = editingLesson ? editingLesson.content : formData.content;\r\n                                                const update = (val: string) => editingLesson ? setEditingLesson({ ...editingLesson, content: val }) : setFormData({ ...formData, content: val });\r\n                                                update(content + '\\n\\n{{WIDGET:CALCULATOR_PROFITABILITY}}\\n\\n');\r\n                                            }}\r\n                                            className=\"px-2 py-1 bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-200 dark:border-indigo-800 text-indigo-600 dark:text-indigo-400 rounded hover:bg-indigo-100 dark:hover:bg-indigo-900/40 text-xs font-bold shadow-sm\"\r\n                                        >\r\n                                            + Rentab.\r\n                                        </button>\r\n                                        <button\r\n                                            onClick={() => {\r\n                                                const content = editingLesson ? editingLesson.content : formData.content;\r\n                                                const update = (val: string) => editingLesson ? setEditingLesson({ ...editingLesson, content: val }) : setFormData({ ...formData, content: val });\r\n                                                update(content + '\\n\\n{{WIDGET:CALCULATOR_ROI}}\\n\\n');\r\n                                            }}\r\n                                            className=\"px-2 py-1 bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-800 text-purple-600 dark:text-purple-400 rounded hover:bg-purple-100 dark:hover:bg-purple-900/40 text-xs font-bold shadow-sm\"\r\n                                        >\r\n                                            + ROI\r\n                                        </button>\r\n                                        <button\r\n                                            onClick={() => {\r\n                                                const content = editingLesson ? editingLesson.content : formData.content;\r\n                                                const update = (val: string) => editingLesson ? setEditingLesson({ ...editingLesson, content: val }) : setFormData({ ...formData, content: val });\r\n                                                update(content + '\\n\\n{{WIDGET:CALCULATOR_TAXES}}\\n\\n');\r\n                                            }}\r\n                                            className=\"px-2 py-1 bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-800 text-orange-600 dark:text-orange-400 rounded hover:bg-orange-100 dark:hover:bg-orange-900/40 text-xs font-bold shadow-sm\"\r\n                                        >\r\n                                            + Impuestos\r\n                                        </button>\r\n                                        <div className=\"w-px bg-slate-300 dark:bg-slate-700 mx-2\" />\r\n                                        <button\r\n                                            onClick={() => {\r\n                                                const url = prompt(\"URL del video (Embed):\");\r\n                                                if (!url) return;\r\n                                                const content = editingLesson ? editingLesson.content : formData.content;\r\n                                                const update = (val: string) => editingLesson ? setEditingLesson({ ...editingLesson, content: val }) : setFormData({ ...formData, content: val });\r\n                                                update(content + `\\n\\n{{VIDEO:${url}}}\\n\\n`);\r\n                                            }}\r\n                                            className=\"px-2 py-1 bg-rose-50 dark:bg-rose-900/20 border border-rose-200 dark:border-rose-800 text-rose-600 dark:text-rose-400 rounded hover:bg-rose-100 dark:hover:bg-rose-900/40 text-xs font-bold shadow-sm\"\r\n                                        >\r\n                                            + Video\r\n                                        </button>\r\n                                    </div>\r\n\r\n                                    <textarea\r\n                                        value={editingLesson ? editingLesson.content : formData.content}\r\n                                        onChange={(e) => editingLesson\r\n                                            ? setEditingLesson({ ...editingLesson, content: e.target.value })\r\n                                            : setFormData({ ...formData, content: e.target.value })\r\n                                        }\r\n                                        placeholder=\"# T√≠tulo Principal&#10;&#10;## Subt√≠tulo&#10;&#10;Escribe tu contenido aqu√≠ usando Markdown...\"\r\n                                        rows={15}\r\n                                        className=\"w-full px-4 py-3 border border-slate-200 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 font-mono text-sm resize-none bg-slate-50 dark:bg-slate-900/50 text-slate-900 dark:text-white focus:bg-white dark:focus:bg-slate-900 transition-colors\"\r\n                                    />\r\n                                    <p className=\"text-xs text-slate-500 dark:text-slate-400 mt-2 flex items-center gap-1\">\r\n                                        <span className=\"bg-slate-100 dark:bg-slate-800 px-1.5 py-0.5 rounded text-slate-600 dark:text-slate-300 font-semibold\">MD</span>\r\n                                        Soporta Markdown: **negrita**, *cursiva*, listas, tablas, c√≥digo, etc.\r\n                                    </p>\r\n                                </div>\r\n\r\n                                <div className=\"flex gap-3 pt-2 border-t border-slate-100 dark:border-slate-800\">\r\n                                    <button\r\n                                        onClick={() => editingLesson ? handleUpdate(editingLesson.id) : handleCreate()}\r\n                                        className=\"flex-1 flex items-center justify-center gap-2 px-6 py-3 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 font-medium shadow-lg shadow-emerald-600/20 transition active:scale-[0.98]\"\r\n                                    >\r\n                                        <Save className=\"w-5 h-5\" />\r\n                                        {editingLesson ? 'Guardar Cambios' : 'Crear Lecci√≥n'}\r\n                                    </button>\r\n                                    <button\r\n                                        onClick={() => {\r\n                                            setIsCreating(false);\r\n                                            setEditingLesson(null);\r\n                                        }}\r\n                                        className=\"px-6 py-3 bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 rounded-xl hover:bg-slate-200 dark:hover:bg-slate-700 font-medium transition\"\r\n                                    >\r\n                                        Cancelar\r\n                                    </button>\r\n                                </div>\r\n                            </div>\r\n                        ) : (\r\n                            <div className=\"bg-slate-50 dark:bg-slate-900/30 rounded-xl p-6 border border-slate-200 dark:border-slate-800 max-h-[600px] overflow-y-auto\">\r\n                                <h4 className=\"text-xs font-bold text-slate-500 dark:text-slate-400 mb-4 uppercase tracking-wider flex items-center gap-2\">\r\n                                    <Eye className=\"w-4 h-4\" />\r\n                                    Vista Previa del Contenido\r\n                                </h4>\r\n                                <div className=\"prose prose-slate dark:prose-invert prose-lg max-w-none bg-white dark:bg-slate-900 p-8 rounded-xl shadow-sm border border-slate-100 dark:border-slate-800\">\r\n                                    <ReactMarkdown>\r\n                                        {editingLesson ? editingLesson.content : formData.content}\r\n                                    </ReactMarkdown>\r\n                                </div>\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                )}\r\n\r\n                {/* Lessons List */}\r\n                <div className=\"space-y-4\">\r\n                    <h3 className=\"text-lg font-semibold text-slate-800 dark:text-white flex items-center gap-2\">\r\n                        <span className=\"bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-400 px-2 py-0.5 rounded text-sm\">\r\n                            {lessons.length}\r\n                        </span>\r\n                        Lecciones del M√≥dulo\r\n                    </h3>\r\n\r\n                    {lessons.map((lesson, index) => (\r\n                        <div\r\n                            key={lesson.id}\r\n                            className=\"bg-white dark:bg-slate-900/30 backdrop-blur-sm rounded-2xl border border-slate-200 dark:border-slate-800 p-6 hover:shadow-xl hover:shadow-slate-200/50 dark:hover:shadow-indigo-500/5 transition-all hover:border-indigo-200 dark:hover:border-indigo-500/30 group\"\r\n                        >\r\n                            <div className=\"flex items-start justify-between\">\r\n                                <div className=\"flex-1\">\r\n                                    <div className=\"flex items-center gap-3 mb-2\">\r\n                                        <GripVertical className=\"w-5 h-5 text-slate-400 cursor-grab active:cursor-grabbing\" />\r\n                                        <span className=\"text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider bg-slate-100 dark:bg-slate-800 px-2 py-0.5 rounded\">\r\n                                            Lecci√≥n {lesson.order || index + 1}\r\n                                        </span>\r\n                                    </div>\r\n                                    <h3 className=\"text-xl font-semibold text-slate-900 dark:text-white mb-2 group-hover:text-indigo-900 dark:group-hover:text-indigo-100 transition-colors\">\r\n                                        {lesson.title}\r\n                                    </h3>\r\n                                    <p className=\"text-sm text-slate-600 dark:text-slate-400 line-clamp-2\">\r\n                                        {lesson.content ? lesson.content.substring(0, 150) + '...' : 'Sin contenido'}\r\n                                    </p>\r\n                                    <div className=\"mt-3 text-xs text-slate-400 font-medium\">\r\n                                        {lesson.content ? lesson.content.length : 0} caracteres\r\n                                    </div>\r\n                                </div>\r\n\r\n                                <div className=\"flex gap-2\">\r\n                                    <button\r\n                                        onClick={() => setEditingLesson(lesson)}\r\n                                        className=\"p-2 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 text-indigo-600 dark:text-indigo-400 rounded-lg transition border border-transparent hover:border-indigo-100 dark:hover:border-indigo-500/30\"\r\n                                        title=\"Editar lecci√≥n\"\r\n                                        aria-label={`Editar lecci√≥n ${lesson.title}`}\r\n                                    >\r\n                                        <Edit2 className=\"w-5 h-5\" />\r\n                                    </button>\r\n                                    <button\r\n                                        onClick={() => handleDelete(lesson.id, lesson.title)}\r\n                                        className=\"p-2 hover:bg-rose-50 dark:hover:bg-rose-900/20 text-rose-600 dark:text-rose-400 rounded-lg transition border border-transparent hover:border-rose-100 dark:hover:border-rose-500/30\"\r\n                                        title=\"Eliminar lecci√≥n\"\r\n                                        aria-label={`Eliminar lecci√≥n ${lesson.title}`}\r\n                                    >\r\n                                        <Trash2 className=\"w-5 h-5\" />\r\n                                    </button>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    ))}\r\n                </div>\r\n\r\n                {/* Empty State */}\r\n                {lessons.length === 0 && !isCreating && (\r\n                    <div className=\"text-center py-20 bg-white dark:bg-slate-900/30 rounded-3xl border border-slate-200 dark:border-slate-800 border-dashed\">\r\n                        <div className=\"text-6xl mb-4 opacity-50\">üìù</div>\r\n                        <h3 className=\"text-xl font-medium text-slate-800 dark:text-white mb-2\">\r\n                            No hay lecciones en este m√≥dulo\r\n                        </h3>\r\n                        <p className=\"text-slate-500 dark:text-slate-400 mb-6\">\r\n                            Crea tu primera lecci√≥n para empezar a construir el contenido\r\n                        </p>\r\n                        <button\r\n                            onClick={() => setIsCreating(true)}\r\n                            className=\"inline-flex items-center gap-2 px-6 py-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 font-medium shadow-lg shadow-indigo-600/20 transition active:scale-[0.98]\"\r\n                        >\r\n                            <Plus className=\"w-5 h-5\" />\r\n                            Crear Primera Lecci√≥n\r\n                        </button>\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default LessonEditor;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\academy\\ModuleViewer.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":41,"column":76,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":41,"endColumn":79,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1855,1858],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1855,1858],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":76,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":76,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3977,3980],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3977,3980],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, type FC } from 'react';\r\nimport { ArrowLeft, BookOpen, Clock, CheckCircle, ArrowRight } from 'lucide-react';\r\nimport ReactMarkdown from 'react-markdown';\r\nimport { useModuleLessons, useMarkLessonComplete, useModuleQuiz, AcademyModule, Lesson } from '../../hooks/useAcademy';\r\nimport { useAuth } from '../../context/AuthContext';\r\nimport QuizEngine from './QuizEngine';\r\nimport CalculatorWidget from './CalculatorWidget';\r\n\r\ninterface ModuleViewerProps {\r\n    module: AcademyModule;\r\n    onBack: () => void;\r\n}\r\n\r\n/**\r\n * Module Viewer - Vista de consumo de m√≥dulos para franquiciados\r\n * Muestra lecciones en formato markdown con navegaci√≥n\r\n */\r\nconst ModuleViewer: FC<ModuleViewerProps> = ({ module, onBack }) => {\r\n    const { user } = useAuth();\r\n    const { lessons, loading } = useModuleLessons(module.id);\r\n    const { quiz } = useModuleQuiz(module.id);\r\n    const markComplete = useMarkLessonComplete();\r\n\r\n    const [currentLessonIndex, setCurrentLessonIndex] = useState(0);\r\n    const [completedLessons, setCompletedLessons] = useState<Set<string>>(new Set());\r\n    const [showQuiz, setShowQuiz] = useState(false);\r\n\r\n    // [NEW] Helper to render content with widgets\r\n    const renderContentWithWidgets = (content: string) => {\r\n        if (!content) return null;\r\n\r\n        // Split by widget tags using regex capture group\r\n        const parts = content.split(/({{WIDGET:[^}]+}}|{{VIDEO:[^}]+}})/g);\r\n\r\n        return parts.map((part, index) => {\r\n            if (part.startsWith('{{WIDGET:')) {\r\n                const widgetType = part.replace('{{WIDGET:', '').replace('}}', '').toLowerCase();\r\n\r\n                if (widgetType.startsWith('calculator_')) {\r\n                    const calcType = widgetType.replace('calculator_', '');\r\n                    return <CalculatorWidget key={index} type={calcType as any} />;\r\n                }\r\n                return null;\r\n            }\r\n\r\n            if (part.startsWith('{{VIDEO:')) {\r\n                const videoUrl = part.replace('{{VIDEO:', '').replace('}}', '');\r\n                return (\r\n                    <div key={index} className=\"my-8 rounded-2xl overflow-hidden shadow-lg border-4 border-slate-900 aspect-video bg-black\">\r\n                        <iframe\r\n                            src={videoUrl}\r\n                            title=\"Video Lesson\"\r\n                            className=\"w-full h-full\"\r\n                            frameBorder=\"0\"\r\n                            allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\"\r\n                            allowFullScreen\r\n                        />\r\n                    </div>\r\n                );\r\n            }\r\n\r\n            // Normal markdown content\r\n            return <div key={index} className=\"prose prose-slate max-w-none mb-6\">\r\n                <ReactMarkdown\r\n                    components={{\r\n                        h1: ({ ...props }) => <h1 className=\"text-3xl font-black text-slate-800 mb-4\" {...props} />,\r\n                        h2: ({ ...props }) => <h2 className=\"text-2xl font-black text-slate-800 mb-3 mt-8\" {...props} />,\r\n                        h3: ({ ...props }) => <h3 className=\"text-xl font-bold text-slate-800 mb-2 mt-6\" {...props} />,\r\n                        p: ({ ...props }) => <p className=\"text-slate-700 leading-relaxed mb-4\" {...props} />,\r\n                        ul: ({ ...props }) => <ul className=\"list-disc pl-6 mb-4 space-y-2\" {...props} />,\r\n                        ol: ({ ...props }) => <ol className=\"list-decimal pl-6 mb-4 space-y-2\" {...props} />,\r\n                        li: ({ ...props }) => <li className=\"text-slate-700\" {...props} />,\r\n                        blockquote: ({ ...props }) => (\r\n                            <blockquote className=\"border-l-4 border-blue-500 bg-blue-50 pl-4 py-2 my-4 italic text-slate-700\" {...props} />\r\n                        ),\r\n                        code: ({ inline, ...props }: any) =>\r\n                            inline\r\n                                ? <code className=\"bg-slate-100 text-slate-800 px-1.5 py-0.5 rounded font-mono text-sm\" {...props} />\r\n                                : <code className=\"block bg-slate-900 text-slate-100 p-4 rounded-lg font-mono text-sm overflow-x-auto\" {...props} />,\r\n                        strong: ({ ...props }) => <strong className=\"font-bold text-slate-900\" {...props} />,\r\n                        a: ({ ...props }) => <a className=\"text-blue-600 hover:text-blue-700 underline font-medium\" {...props} />\r\n                    }}\r\n                >\r\n                    {part}\r\n                </ReactMarkdown>\r\n            </div>;\r\n        });\r\n    };\r\n\r\n    const currentLesson = lessons[currentLessonIndex] as Lesson;\r\n    const isFirstLesson = currentLessonIndex === 0;\r\n    const isLastLesson = currentLessonIndex === lessons.length - 1;\r\n    const allLessonsCompleted = completedLessons.size === lessons.length && lessons.length > 0;\r\n\r\n    // Mostrar quiz cuando se completan todas las lecciones\r\n    useEffect(() => {\r\n        if (allLessonsCompleted && quiz && !showQuiz) {\r\n            // Avoid synchronous state update\r\n            const timer = setTimeout(() => setShowQuiz(true), 0);\r\n            return () => clearTimeout(timer);\r\n        }\r\n    }, [allLessonsCompleted, quiz, showQuiz]);\r\n\r\n    const handleMarkComplete = async () => {\r\n        if (!currentLesson || !user) return;\r\n\r\n        try {\r\n            await markComplete(user.uid, module.id, currentLesson.id);\r\n            setCompletedLessons(prev => new Set([...prev, currentLesson.id]));\r\n\r\n            // Auto-avanzar a la siguiente lecci√≥n\r\n            if (!isLastLesson) {\r\n                setCurrentLessonIndex(prev => prev + 1);\r\n            }\r\n        } catch (error) {\r\n            console.error('Error marking lesson complete:', error);\r\n        }\r\n    };\r\n\r\n    const handlePrevious = () => {\r\n        if (!isFirstLesson) {\r\n            setCurrentLessonIndex(prev => prev - 1);\r\n        }\r\n    };\r\n\r\n    const handleNext = () => {\r\n        if (!isLastLesson) {\r\n            setCurrentLessonIndex(prev => prev + 1);\r\n        }\r\n    };\r\n\r\n    if (loading) {\r\n        return (\r\n            <div className=\"flex items-center justify-center h-96\">\r\n                <div className=\"text-center\">\r\n                    <BookOpen className=\"w-12 h-12 mx-auto mb-4 text-blue-500 animate-pulse\" />\r\n                    <p className=\"text-slate-500 font-medium\">Cargando lecciones...</p>\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    if (lessons.length === 0) {\r\n        return (\r\n            <div className=\"p-8 max-w-4xl mx-auto\">\r\n                <button\r\n                    onClick={onBack}\r\n                    className=\"flex items-center gap-2 text-blue-600 hover:text-blue-700 font-bold mb-6 transition\"\r\n                >\r\n                    <ArrowLeft className=\"w-5 h-5\" />\r\n                    Volver a m√≥dulos\r\n                </button>\r\n\r\n                <div className=\"bg-amber-50 border border-amber-200 rounded-2xl p-8 text-center\">\r\n                    <BookOpen className=\"w-16 h-16 mx-auto mb-4 text-amber-500\" />\r\n                    <h3 className=\"text-xl font-bold text-amber-900 mb-2\">\r\n                        Este m√≥dulo est√° en construcci√≥n\r\n                    </h3>\r\n                    <p className=\"text-amber-700\">\r\n                        Las lecciones se agregar√°n pronto\r\n                    </p>\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    // Si todas las lecciones est√°n completadas y hay quiz, mostrar el quiz\r\n    if (showQuiz && quiz) {\r\n        return (\r\n            <QuizEngine\r\n                quiz={quiz}\r\n                module={module}\r\n                onComplete={() => {\r\n                    // Volver al dashboard cuando completa el quiz\r\n                    onBack();\r\n                }}\r\n            />\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"min-h-screen bg-white\">\r\n            {/* Header */}\r\n            <div className=\"bg-white border-b border-slate-200 sticky top-0 z-10 shadow-sm backdrop-blur-md bg-white/90\">\r\n                <div className=\"max-w-4xl mx-auto px-4 md:px-8 py-4\">\r\n                    <button\r\n                        onClick={onBack}\r\n                        className=\"flex items-center gap-2 text-slate-500 hover:text-slate-800 font-bold mb-3 transition text-sm\"\r\n                    >\r\n                        <ArrowLeft className=\"w-4 h-4\" />\r\n                        Volver a m√≥dulos\r\n                    </button>\r\n\r\n                    <div className=\"flex flex-col md:flex-row md:items-center justify-between gap-4\">\r\n                        <div>\r\n                            <div className=\"flex items-center gap-2 mb-1\">\r\n                                <span className=\"text-xs font-bold text-slate-500 uppercase tracking-wider bg-slate-100 px-2 py-0.5 rounded\">\r\n                                    M√≥dulo {module.order}\r\n                                </span>\r\n                                {module.duration && (\r\n                                    <span className=\"flex items-center text-xs text-slate-500 font-medium\">\r\n                                        <Clock className=\"w-3 h-3 mr-1\" />\r\n                                        {module.duration}\r\n                                    </span>\r\n                                )}\r\n                            </div>\r\n                            <h1 className=\"text-xl md:text-2xl font-black text-slate-900 tracking-tight\">\r\n                                {module.title}\r\n                            </h1>\r\n                        </div>\r\n\r\n                        <div className=\"flex items-center justify-between md:block md:text-right\">\r\n                            <p className=\"text-xs text-slate-500 mb-1 font-semibold uppercase tracking-wider\">Progreso</p>\r\n                            <p className=\"text-2xl font-black text-indigo-600\">\r\n                                {Math.round((completedLessons.size / lessons.length) * 100)}%\r\n                            </p>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Progress Bar */}\r\n                    <div className=\"mt-4 bg-slate-100 rounded-full h-2 overflow-hidden border border-slate-200\">\r\n                        <div\r\n                            className=\"bg-indigo-600 h-full transition-all duration-500 shadow-[0_0_10px_rgba(79,70,229,0.3)]\"\r\n                            style={{ width: `${(completedLessons.size / lessons.length) * 100}%` }}\r\n                        />\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Content */}\r\n            <div className=\"max-w-4xl mx-auto px-4 md:px-8 py-8 animate-fade-in\">\r\n                {/* Lesson Header */}\r\n                <div className=\"mb-8\">\r\n                    <div className=\"flex items-center gap-2 mb-2\">\r\n                        <span className=\"text-sm font-bold text-slate-500\">\r\n                            Lecci√≥n {currentLessonIndex + 1} de {lessons.length}\r\n                        </span>\r\n                        {completedLessons.has(currentLesson?.id) && (\r\n                            <span className=\"flex items-center gap-1 text-xs font-bold text-emerald-700 bg-emerald-50 px-2 py-0.5 rounded-full border border-emerald-100\">\r\n                                <CheckCircle className=\"w-3 h-3\" />\r\n                                Completada\r\n                            </span>\r\n                        )}\r\n                    </div>\r\n                    <h2 className=\"text-3xl font-black text-slate-900 leading-tight\">\r\n                        {currentLesson?.title}\r\n                    </h2>\r\n                </div>\r\n\r\n                {/* Lesson Content */}\r\n                <div className=\"bg-white rounded-2xl border border-slate-200 shadow-xl shadow-slate-200/50 p-8 mb-8\">\r\n                    {/* [UPDATED] Render with Widgets */}\r\n                    {renderContentWithWidgets(currentLesson?.content || '')}\r\n\r\n                    {/* Resources */}\r\n                    {currentLesson?.resources && currentLesson.resources.length > 0 && (\r\n                        <div className=\"mt-8 pt-8 border-t border-slate-100\">\r\n                            <h4 className=\"text-lg font-bold text-slate-900 mb-4 flex items-center gap-2\">\r\n                                <span className=\"bg-indigo-100 text-indigo-600 p-1 rounded\">üìé</span> Recursos adicionales\r\n                            </h4>\r\n                            <div className=\"space-y-2\">\r\n                                {currentLesson.resources.map((resource: { url: string; title: string }, index: number) => (\r\n                                    <a\r\n                                        key={index}\r\n                                        href={resource.url}\r\n                                        target=\"_blank\"\r\n                                        rel=\"noopener noreferrer\"\r\n                                        className=\"block p-4 bg-slate-50 hover:bg-indigo-50/50 rounded-xl transition font-medium text-slate-700 hover:text-indigo-700 border border-slate-100 hover:border-indigo-100 group\"\r\n                                    >\r\n                                        <span className=\"group-hover:translate-x-1 transition-transform inline-block\">üìÑ {resource.title}</span>\r\n                                    </a>\r\n                                ))}\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n\r\n                {/* Navigation */}\r\n                <div className=\"flex items-center justify-between gap-4\">\r\n                    <button\r\n                        onClick={handlePrevious}\r\n                        disabled={isFirstLesson}\r\n                        aria-label=\"Lecci√≥n anterior\"\r\n                        className=\"flex items-center gap-2 px-6 py-3 bg-white border border-slate-200 text-slate-600 rounded-xl hover:bg-slate-50 hover:text-slate-900 font-bold transition disabled:opacity-50 disabled:cursor-not-allowed shadow-sm hover:shadow\"\r\n                    >\r\n                        <ArrowLeft className=\"w-5 h-5\" />\r\n                        Anterior\r\n                    </button>\r\n\r\n                    {!completedLessons.has(currentLesson?.id) && (\r\n                        <button\r\n                            onClick={handleMarkComplete}\r\n                            className=\"flex items-center gap-2 px-6 py-3 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 font-bold shadow-lg shadow-emerald-600/20 transition active:scale-[0.98]\"\r\n                        >\r\n                            <CheckCircle className=\"w-5 h-5\" />\r\n                            Marcar como completada\r\n                        </button>\r\n                    )}\r\n\r\n                    <button\r\n                        onClick={handleNext}\r\n                        disabled={isLastLesson}\r\n                        aria-label=\"Siguiente lecci√≥n\"\r\n                        className=\"flex items-center gap-2 px-6 py-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 font-bold shadow-lg shadow-indigo-600/20 transition disabled:opacity-50 disabled:cursor-not-allowed active:scale-[0.98]\"\r\n                    >\r\n                        Siguiente\r\n                        <ArrowRight className=\"w-5 h-5\" />\r\n                    </button>\r\n                </div>\r\n\r\n                {/* Completion Status */}\r\n                {isLastLesson && completedLessons.size === lessons.length && (\r\n                    <div className=\"mt-8 bg-emerald-50 border border-emerald-100 rounded-2xl p-6 text-center animate-fade-in-up\">\r\n                        <CheckCircle className=\"w-12 h-12 mx-auto mb-3 text-emerald-600\" />\r\n                        <h3 className=\"text-xl font-black text-emerald-900 mb-2\">\r\n                            üéâ ¬°M√≥dulo completado!\r\n                        </h3>\r\n                        <p className=\"text-emerald-700\">\r\n                            Has terminado todas las lecciones de este m√≥dulo\r\n                        </p>\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default ModuleViewer;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\academy\\QuizEditor.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\academy\\QuizEditor.tsx:41:13\n  39 |     useEffect(() => {\n  40 |         if (quiz?.questions) {\n> 41 |             setQuestions(quiz.questions);\n     |             ^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  42 |         }\n  43 |     }, [quiz]);\n  44 |","line":41,"column":13,"nodeType":null,"endLine":41,"endColumn":25}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, type FC } from 'react';\r\nimport { Plus, Trash2, Save, CheckCircle, ArrowLeft, HelpCircle } from 'lucide-react';\r\nimport { useModuleQuiz, useSaveQuiz, useDeleteQuiz, AcademyModule, Question } from '../../hooks/useAcademy';\r\n\r\ninterface QuizEditorProps {\r\n    module: AcademyModule;\r\n    onBack: () => void;\r\n}\r\n\r\n// Temporary interface for editing state\r\ninterface QuestionState {\r\n    type: 'single-choice' | 'true-false' | 'multi-select';\r\n    question: string;\r\n    options: string[];\r\n    correctAnswer: number;\r\n    correctAnswers: number[];\r\n}\r\n\r\n/**\r\n * Editor de Quizzes para Admin\r\n * Permite crear evaluaciones con preguntas de opci√≥n m√∫ltiple\r\n * Design: Executive Glass\r\n */\r\nconst QuizEditor: FC<QuizEditorProps> = ({ module, onBack }) => {\r\n    const { quiz, loading } = useModuleQuiz(module.id);\r\n    const saveQuiz = useSaveQuiz();\r\n    const deleteQuiz = useDeleteQuiz();\r\n\r\n    const [questions, setQuestions] = useState<Question[]>([]);\r\n    const [currentQuestion, setCurrentQuestion] = useState<QuestionState>({\r\n        type: 'single-choice',\r\n        question: '',\r\n        options: ['', '', '', ''],\r\n        correctAnswer: 0,\r\n        correctAnswers: []\r\n    });\r\n\r\n    // Sync quiz data when it loads from Firestore\r\n    useEffect(() => {\r\n        if (quiz?.questions) {\r\n            setQuestions(quiz.questions);\r\n        }\r\n    }, [quiz]);\r\n\r\n    const handleAddQuestion = () => {\r\n        if (!currentQuestion.question.trim()) {\r\n            // Using browser alert for simplicity, could be upgraded to Toast\r\n            alert('Por favor completa la pregunta');\r\n            return;\r\n        }\r\n\r\n        if (currentQuestion.type === 'single-choice' || currentQuestion.type === 'multi-select') {\r\n            if (currentQuestion.options.some(o => !o.trim())) {\r\n                alert('Por favor completa todas las opciones');\r\n                return;\r\n            }\r\n        }\r\n\r\n        if (currentQuestion.type === 'multi-select' && currentQuestion.correctAnswers.length === 0) {\r\n            alert('Por favor selecciona al menos una respuesta correcta');\r\n            return;\r\n        }\r\n\r\n        const newQuestion: Question = {\r\n            type: currentQuestion.type === 'single-choice' ? 'single-choice' : currentQuestion.type,\r\n            question: currentQuestion.question,\r\n            options: currentQuestion.options,\r\n            correctAnswer: (currentQuestion.type === 'multi-select' || currentQuestion.type === 'true-false') ? undefined : currentQuestion.correctAnswer,\r\n            correctAnswers: (currentQuestion.type === 'multi-select') ? currentQuestion.correctAnswers : undefined\r\n        };\r\n\r\n        setQuestions([...questions, newQuestion]);\r\n\r\n        const resetState: QuestionState = {\r\n            type: currentQuestion.type,\r\n            question: '',\r\n            options: currentQuestion.type === 'true-false' ? ['Verdadero', 'Falso'] : ['', '', '', ''],\r\n            correctAnswer: 0,\r\n            correctAnswers: []\r\n        };\r\n\r\n        setCurrentQuestion(resetState);\r\n    };\r\n\r\n    const handleRemoveQuestion = (index: number) => {\r\n        setQuestions(questions.filter((_, i) => i !== index));\r\n    };\r\n\r\n    const handleSave = async () => {\r\n        if (questions.length === 0) {\r\n            alert('Agrega al menos una pregunta');\r\n            return;\r\n        }\r\n\r\n        try {\r\n            await saveQuiz(module.id, {\r\n                questions,\r\n                passingScore: 80,\r\n                title: `Evaluaci√≥n: ${module.title}`\r\n            });\r\n            alert('‚úÖ Quiz guardado con √©xito');\r\n        } catch (error) {\r\n            console.error('Error saving quiz:', error);\r\n            alert('Error al guardar el quiz');\r\n        }\r\n    };\r\n\r\n    const handleDelete = async () => {\r\n        if (!quiz || !confirm('¬øSeguro que quieres eliminar este quiz?')) {\r\n            return;\r\n        }\r\n\r\n        try {\r\n            await deleteQuiz(quiz.id);\r\n            setQuestions([]);\r\n            alert('‚úÖ Quiz eliminado');\r\n        } catch (error) {\r\n            console.error('Error deleting quiz:', error);\r\n            alert('Error al eliminar el quiz');\r\n        }\r\n    };\r\n\r\n    if (loading) {\r\n        return (\r\n            <div className=\"flex items-center justify-center h-screen bg-white dark:bg-slate-950\">\r\n                <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500\" />\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"min-h-screen bg-white dark:bg-slate-950 relative overflow-hidden p-8 max-w-7xl mx-auto space-y-8\">\r\n            {/* Atmospheric Backgrounds */}\r\n            <div className=\"absolute top-[-10%] left-[-5%] w-[40%] h-[40%] bg-purple-500/10 rounded-full blur-[120px] animate-pulse\" />\r\n            <div className=\"absolute bottom-[-5%] right-[-5%] w-[35%] h-[35%] bg-indigo-500/10 rounded-full blur-[100px] animate-pulse [animation-delay:3s]\" />\r\n\r\n            <div className=\"relative z-10 space-y-8 animate-in fade-in duration-1000\">\r\n                {/* Header */}\r\n                <div className=\"flex flex-col md:flex-row md:items-center justify-between gap-6\">\r\n                    <div>\r\n                        <button\r\n                            onClick={onBack}\r\n                            className=\"flex items-center gap-2 text-indigo-600 dark:text-indigo-400 hover:text-indigo-700 font-medium mb-4 transition-all group\"\r\n                        >\r\n                            <ArrowLeft className=\"w-4 h-4 group-hover:-translate-x-1 transition-transform\" />\r\n                            <span className=\"text-[13px]\">Volver al curr√≠culum</span>\r\n                        </button>\r\n                        <h1 className=\"text-3xl font-medium text-slate-900 dark:text-white tracking-tight flex items-center gap-3\">\r\n                            Orquestaci√≥n de Evaluaci√≥n\r\n                        </h1>\r\n                        <div className=\"mt-2 flex items-center gap-2 text-sm text-slate-500 dark:text-slate-400\">\r\n                            M√≥dulo: <span className=\"font-medium text-purple-600 dark:text-purple-400 bg-purple-500/5 px-3 py-1 rounded-full border border-purple-500/10\">{module.title}</span>\r\n                        </div>\r\n                    </div>\r\n                    <div className=\"flex gap-3\">\r\n                        {quiz && (\r\n                            <button\r\n                                onClick={handleDelete}\r\n                                className=\"px-5 py-2.5 bg-rose-50 dark:bg-rose-900/10 text-rose-700 dark:text-rose-400 rounded-xl hover:bg-rose-100 dark:hover:bg-rose-900/20 font-medium transition border border-rose-100 dark:border-rose-900/30 text-sm\"\r\n                            >\r\n                                Eliminar Quiz\r\n                            </button>\r\n                        )}\r\n                        <button\r\n                            onClick={handleSave}\r\n                            className=\"flex items-center gap-2 px-6 py-3 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 font-medium shadow-lg shadow-emerald-600/20 transition active:scale-[0.98] text-sm\"\r\n                        >\r\n                            <Save className=\"w-5 h-5\" />\r\n                            Guardar Quiz\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n\r\n                <div className=\"grid grid-cols-1 lg:grid-cols-12 gap-8\">\r\n                    {/* Editor Panel - Glass */}\r\n                    <div className=\"lg:col-span-4 space-y-6\">\r\n                        <div className=\"bg-white/70 dark:bg-slate-900/40 backdrop-blur-2xl rounded-[2rem] border border-slate-200/40 dark:border-slate-800/40 p-8 shadow-2xl shadow-indigo-500/[0.05] sticky top-8\">\r\n                            <div className=\"flex items-center gap-3 mb-8\">\r\n                                <div className=\"p-2.5 bg-indigo-500/10 rounded-xl\">\r\n                                    <Plus className=\"w-5 h-5 text-indigo-600 dark:text-indigo-400\" />\r\n                                </div>\r\n                                <div className=\"space-y-0.5\">\r\n                                    <h3 className=\"text-lg font-medium text-slate-900 dark:text-white\">Nueva Pregunta</h3>\r\n                                    <p className=\"text-[11px] text-slate-500 dark:text-slate-400 font-normal uppercase tracking-widest opacity-80\">Dise√±o Reactivo</p>\r\n                                </div>\r\n                            </div>\r\n\r\n                            <div className=\"space-y-5\">\r\n                                <div>\r\n                                    <label className=\"block text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2\">\r\n                                        Tipo de Pregunta\r\n                                    </label>\r\n                                    <div className=\"relative\">\r\n                                        <select\r\n                                            value={currentQuestion.type}\r\n                                            onChange={(e) => {\r\n                                                const newType = e.target.value as QuestionState['type'];\r\n                                                setCurrentQuestion({\r\n                                                    ...currentQuestion,\r\n                                                    type: newType,\r\n                                                    options: newType === 'true-false' ? ['Verdadero', 'Falso'] : ['', '', '', ''],\r\n                                                    correctAnswers: []\r\n                                                });\r\n                                            }}\r\n                                            className=\"w-full px-4 py-3 border border-slate-200 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-indigo-500 font-medium bg-slate-50 dark:bg-slate-900/50 text-slate-900 dark:text-white focus:bg-white dark:focus:bg-slate-900 transition-colors appearance-none\"\r\n                                            aria-label=\"Seleccionar tipo de pregunta\"\r\n                                        >\r\n                                            <option value=\"single-choice\">Opci√≥n M√∫ltiple (1 correcta)</option>\r\n                                            <option value=\"true-false\">Verdadero/Falso</option>\r\n                                            <option value=\"multi-select\">Selecci√≥n M√∫ltiple (varias correctas)</option>\r\n                                        </select>\r\n                                    </div>\r\n                                </div>\r\n\r\n                                <div>\r\n                                    <label className=\"block text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2\">\r\n                                        Pregunta *\r\n                                    </label>\r\n                                    <textarea\r\n                                        value={currentQuestion.question}\r\n                                        onChange={(e) => setCurrentQuestion({ ...currentQuestion, question: e.target.value })}\r\n                                        className=\"w-full px-4 py-3 border border-slate-200 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 font-medium bg-slate-50 dark:bg-slate-900/50 text-slate-900 dark:text-white focus:bg-white dark:focus:bg-slate-900 transition-colors resize-none\"\r\n                                        placeholder=\"Escribe la pregunta aqu√≠...\"\r\n                                        rows={3}\r\n                                        aria-label=\"Texto de la pregunta\"\r\n                                    />\r\n                                </div>\r\n\r\n                                <div>\r\n                                    <label className=\"block text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2\">\r\n                                        {currentQuestion.type === 'true-false' ? 'Respuesta Correcta' : 'Opciones de Respuesta'}\r\n                                    </label>\r\n                                    {currentQuestion.type === 'true-false' ? (\r\n                                        <div className=\"space-y-2\">\r\n                                            {currentQuestion.options.map((option, index) => (\r\n                                                <div\r\n                                                    key={index}\r\n                                                    className={`flex items-center gap-3 p-3 border rounded-xl cursor-pointer transition-all ${currentQuestion.correctAnswer === index\r\n                                                        ? 'bg-emerald-50 dark:bg-emerald-900/20 border-emerald-200 dark:border-emerald-800 ring-1 ring-emerald-200 dark:ring-emerald-800'\r\n                                                        : 'hover:bg-slate-50 dark:hover:bg-slate-800/50 border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900/30'\r\n                                                        }`}\r\n                                                    onClick={() => setCurrentQuestion({ ...currentQuestion, correctAnswer: index })}\r\n                                                >\r\n                                                    <div className={`w-5 h-5 rounded-full border flex items-center justify-center ${currentQuestion.correctAnswer === index ? 'border-emerald-500 bg-emerald-500' : 'border-slate-300 dark:border-slate-600'}`}>\r\n                                                        {currentQuestion.correctAnswer === index && <CheckCircle className=\"w-3 h-3 text-white\" />}\r\n                                                    </div>\r\n                                                    <span className={`font-medium ${currentQuestion.correctAnswer === index ? 'text-emerald-900 dark:text-emerald-400' : 'text-slate-700 dark:text-slate-300'}`}>\r\n                                                        {option}\r\n                                                    </span>\r\n                                                </div>\r\n                                            ))}\r\n                                        </div>\r\n                                    ) : (\r\n                                        <div className=\"space-y-3\">\r\n                                            {currentQuestion.options.map((option, index) => (\r\n                                                <div key={index} className=\"flex items-center gap-2\">\r\n                                                    <div className=\"flex-shrink-0 pt-2\">\r\n                                                        <input\r\n                                                            type={currentQuestion.type === 'multi-select' ? 'checkbox' : 'radio'}\r\n                                                            checked={currentQuestion.type === 'multi-select' ? currentQuestion.correctAnswers.includes(index) : currentQuestion.correctAnswer === index}\r\n                                                            onChange={(e) => {\r\n                                                                if (currentQuestion.type === 'multi-select') {\r\n                                                                    let newCorrect = [...currentQuestion.correctAnswers];\r\n                                                                    if (e.target.checked) newCorrect.push(index);\r\n                                                                    else newCorrect = newCorrect.filter(i => i !== index);\r\n                                                                    setCurrentQuestion({ ...currentQuestion, correctAnswers: newCorrect });\r\n                                                                } else {\r\n                                                                    setCurrentQuestion({ ...currentQuestion, correctAnswer: index });\r\n                                                                }\r\n                                                            }}\r\n                                                            className=\"w-5 h-5 text-indigo-600 focus:ring-indigo-500 border-slate-300 dark:border-slate-600 rounded bg-white dark:bg-slate-800\"\r\n                                                            aria-label={`Marcar opci√≥n ${index + 1} como correcta`}\r\n                                                        />\r\n                                                    </div>\r\n                                                    <input\r\n                                                        type=\"text\"\r\n                                                        value={option}\r\n                                                        onChange={(e) => {\r\n                                                            const newOptions = [...currentQuestion.options];\r\n                                                            newOptions[index] = e.target.value;\r\n                                                            setCurrentQuestion({ ...currentQuestion, options: newOptions });\r\n                                                        }}\r\n                                                        placeholder={`Opci√≥n ${index + 1}`}\r\n                                                        className=\"flex-1 px-4 py-2 border border-slate-200 dark:border-slate-700 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-slate-50 dark:bg-slate-900/50 text-slate-900 dark:text-white focus:bg-white dark:focus:bg-slate-900 transition-colors text-sm\"\r\n                                                        aria-label={`Texto de la opci√≥n ${index + 1}`}\r\n                                                    />\r\n                                                </div>\r\n                                            ))}\r\n                                        </div>\r\n                                    )}\r\n                                </div>\r\n                                <button\r\n                                    onClick={handleAddQuestion}\r\n                                    className=\"w-full flex items-center justify-center gap-2 px-4 py-3.5 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 font-medium shadow-lg shadow-indigo-600/20 transition active:scale-[0.98]\"\r\n                                >\r\n                                    <Plus className=\"w-5 h-5\" />\r\n                                    Agregar Pregunta\r\n                                </button>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Questions List */}\r\n                    <div className=\"lg:col-span-8 space-y-6\">\r\n                        <div className=\"flex items-center justify-between\">\r\n                            <h3 className=\"text-lg font-semibold text-slate-800 dark:text-white flex items-center gap-2\">\r\n                                <span className=\"bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-400 px-2 py-0.5 rounded text-sm\">\r\n                                    {questions.length}\r\n                                </span>\r\n                                Preguntas del Quiz\r\n                            </h3>\r\n                            {questions.length === 0 && (\r\n                                <span className=\"text-sm text-slate-500 dark:text-slate-400 italic\">No hay preguntas agregadas</span>\r\n                            )}\r\n                        </div>\r\n\r\n                        {questions.length === 0 ? (\r\n                            <div className=\"bg-slate-50 dark:bg-slate-900/30 rounded-2xl border border-slate-200 dark:border-slate-800 border-dashed p-12 text-center\">\r\n                                <HelpCircle className=\"w-12 h-12 text-slate-300 dark:text-slate-700 mx-auto mb-3\" />\r\n                                <p className=\"text-slate-500 dark:text-slate-400 font-medium\">\r\n                                    Usa el panel de la izquierda para agregar preguntas al quiz.\r\n                                </p>\r\n                            </div>\r\n                        ) : (\r\n                            <div className=\"space-y-4\">\r\n                                {questions.map((q, index) => (\r\n                                    <div key={index} className=\"bg-white dark:bg-slate-900/30 backdrop-blur-sm rounded-2xl border border-slate-200 dark:border-slate-800 p-6 hover:shadow-xl hover:shadow-slate-200/50 dark:hover:shadow-indigo-500/5 transition-all group\">\r\n                                        <div className=\"flex items-start justify-between gap-4\">\r\n                                            <div className=\"flex-1\">\r\n                                                <div className=\"flex items-center gap-2 mb-2\">\r\n                                                    <span className=\"bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-300 text-xs font-medium px-2 py-0.5 rounded uppercase tracking-wider\">\r\n                                                        Pregunta {index + 1}\r\n                                                    </span>\r\n                                                    <span className=\"text-xs text-slate-400 dark:text-slate-500 font-medium uppercase\">\r\n                                                        {q.type === 'single-choice' && 'Opci√≥n M√∫ltiple'}\r\n                                                        {q.type === 'true-false' && 'Verdadero/Falso'}\r\n                                                        {q.type === 'multi-select' && 'Selecci√≥n M√∫ltiple'}\r\n                                                    </span>\r\n                                                </div>\r\n                                                <h4 className=\"text-lg font-semibold text-slate-900 dark:text-white mb-4\">{q.question}</h4>\r\n                                                <div className=\"space-y-2 pl-4 border-l-2 border-slate-100 dark:border-slate-800\">\r\n                                                    {q.options.map((option, optIndex) => {\r\n                                                        const isCorrect = q.type === 'multi-select'\r\n                                                            ? q.correctAnswers?.includes(optIndex)\r\n                                                            : q.correctAnswer === optIndex;\r\n\r\n                                                        return (\r\n                                                            <div\r\n                                                                key={optIndex}\r\n                                                                className={`p-2 rounded-lg text-sm flex items-center gap-2 ${isCorrect\r\n                                                                    ? 'bg-emerald-50 dark:bg-emerald-900/20 text-emerald-700 dark:text-emerald-400 font-medium border border-emerald-100 dark:border-emerald-900/30'\r\n                                                                    : 'text-slate-600 dark:text-slate-400'\r\n                                                                    }`}\r\n                                                            >\r\n                                                                <span className={`w-5 h-5 flex items-center justify-center rounded border text-xs ${isCorrect ? 'border-emerald-300 dark:border-emerald-600 bg-emerald-200/50 dark:bg-emerald-800/20' : 'border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800'}`}>\r\n                                                                    {String.fromCharCode(65 + optIndex)}\r\n                                                                </span>\r\n                                                                {option}\r\n                                                                {isCorrect && <CheckCircle className=\"w-4 h-4 text-emerald-500 ml-auto\" />}\r\n                                                            </div>\r\n                                                        );\r\n                                                    })}\r\n                                                </div>\r\n                                            </div>\r\n                                            <button\r\n                                                onClick={() => handleRemoveQuestion(index)}\r\n                                                className=\"p-2 text-rose-500 hover:bg-rose-50 dark:hover:bg-rose-900/20 rounded-lg transition opacity-0 group-hover:opacity-100\"\r\n                                                title=\"Eliminar pregunta\"\r\n                                                aria-label={`Eliminar pregunta ${index + 1}`}\r\n                                            >\r\n                                                <Trash2 className=\"w-5 h-5\" />\r\n                                            </button>\r\n                                        </div>\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default QuizEditor;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\academy\\QuizEngine.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":22,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[846,849],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[846,849],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\r\nimport { CheckCircle, Award, ArrowRight, ArrowLeft, HelpCircle } from 'lucide-react';\r\nimport { useSaveQuizResult, Quiz, AcademyModule } from '../../hooks/useAcademy';\r\nimport { useAuth } from '../../context/AuthContext';\r\nimport QuizResults from './QuizResults';\r\n\r\ninterface QuizEngineProps {\r\n    quiz: Quiz;\r\n    module: AcademyModule;\r\n    onComplete?: (score: number) => void;\r\n}\r\n\r\n/**\r\n * Quiz Engine - Motor de evaluaci√≥n para estudiantes\r\n * Muestra preguntas, valida respuestas y guarda resultados\r\n */\r\nconst QuizEngine: React.FC<QuizEngineProps> = ({ quiz, module, onComplete }) => {\r\n    const { user } = useAuth();\r\n    const saveQuizResult = useSaveQuizResult();\r\n\r\n    const [currentQuestion, setCurrentQuestion] = useState(0);\r\n    const [answers, setAnswers] = useState<Record<number, any>>({}); // For single-choice: number, for multi-select: array\r\n    const [showResults, setShowResults] = useState(false);\r\n    const [score, setScore] = useState(0);\r\n\r\n    // Handle para respuesta √∫nica (multiple-choice y true-false)\r\n    const handleSingleAnswer = (questionIndex: number, answerIndex: number) => {\r\n        setAnswers({\r\n            ...answers,\r\n            [questionIndex]: answerIndex\r\n        });\r\n    };\r\n\r\n    // Handle para respuesta m√∫ltiple (multi-select)\r\n    const handleMultiAnswer = (questionIndex: number, answerIndex: number) => {\r\n        const currentAnswers: number[] = answers[questionIndex] || [];\r\n        let newAnswers;\r\n\r\n        if (currentAnswers.includes(answerIndex)) {\r\n            newAnswers = currentAnswers.filter(a => a !== answerIndex);\r\n        } else {\r\n            newAnswers = [...currentAnswers, answerIndex];\r\n        }\r\n\r\n        setAnswers({\r\n            ...answers,\r\n            [questionIndex]: newAnswers\r\n        });\r\n    };\r\n\r\n    const handleSubmit = async () => {\r\n        // Calcular puntuaci√≥n\r\n        let correct = 0;\r\n        quiz.questions.forEach((q, index) => {\r\n            const userAnswer = answers[index];\r\n\r\n            if (q.type === 'multi-select') {\r\n                // Para multi-select, comparar arrays\r\n                const correctAnswers = q.correctAnswers || [];\r\n                const userAnswers = (userAnswer as number[]) || [];\r\n\r\n                // Correcta si tiene todas las correctas y ninguna incorrecta\r\n                const hasAllCorrect = correctAnswers.every((a: number) => userAnswers.includes(a));\r\n                const hasNoIncorrect = userAnswers.every((a: number) => (correctAnswers as number[]).includes(a));\r\n\r\n                if (hasAllCorrect && hasNoIncorrect && userAnswers.length > 0) {\r\n                    correct++;\r\n                }\r\n            } else {\r\n                // Para single-choice y true-false\r\n                if (userAnswer === q.correctAnswer) {\r\n                    correct++;\r\n                }\r\n            }\r\n        });\r\n\r\n        const finalScore = Math.round((correct / quiz.questions.length) * 100);\r\n        setScore(finalScore);\r\n        setShowResults(true);\r\n\r\n        // Guardar resultado\r\n        try {\r\n            if (user?.uid) {\r\n                await saveQuizResult(user.uid, module.id, finalScore, answers);\r\n            }\r\n\r\n            if (finalScore >= 80) {\r\n                setTimeout(() => {\r\n                    if (onComplete) onComplete(finalScore);\r\n                }, 3000);\r\n            }\r\n        } catch (error) {\r\n            console.error('Error saving quiz result:', error);\r\n        }\r\n    };\r\n\r\n    const handleRetry = () => {\r\n        setCurrentQuestion(0);\r\n        setAnswers({});\r\n        setShowResults(false);\r\n        setScore(0);\r\n    };\r\n\r\n    const allAnswered = quiz.questions.every((q, index) => {\r\n        const answer = answers[index];\r\n        if (q.type === 'multi-select') {\r\n            // Para multi-select, verificar que hay al menos una respuesta\r\n            return Array.isArray(answer) && answer.length > 0;\r\n        }\r\n        // Para single-choice y true-false\r\n        return answer !== undefined;\r\n    });\r\n\r\n    if (showResults) {\r\n        return (\r\n            <QuizResults\r\n                quiz={quiz}\r\n                answers={answers}\r\n                score={score}\r\n                onRetry={handleRetry}\r\n                onComplete={() => onComplete && onComplete(score)}\r\n            />\r\n        );\r\n    }\r\n\r\n    const question = quiz.questions[currentQuestion];\r\n\r\n    return (\r\n        <div className=\"max-w-3xl mx-auto p-4 md:p-8 animate-fade-in\">\r\n            {/* Progress Bar */}\r\n            <div className=\"mb-8\">\r\n                <div className=\"flex items-center justify-between mb-2\">\r\n                    <span className=\"text-sm font-bold text-slate-600 uppercase tracking-wider\">\r\n                        Pregunta {currentQuestion + 1} de {quiz.questions.length}\r\n                    </span>\r\n                    <span className=\"text-sm text-slate-500 font-medium bg-slate-100 px-2 py-0.5 rounded\">\r\n                        {Object.keys(answers).length}/{quiz.questions.length} respondidas\r\n                    </span>\r\n                </div>\r\n                <div className=\"h-2 bg-slate-100 rounded-full overflow-hidden border border-slate-200\">\r\n                    <div\r\n                        className=\"h-full bg-indigo-600 transition-all duration-500 ease-out\"\r\n                        style={{ width: `${((currentQuestion + 1) / quiz.questions.length) * 100}%` } as React.CSSProperties}\r\n                    />\r\n                </div>\r\n            </div>\r\n\r\n            {/* Question */}\r\n            <div className=\"bg-white rounded-3xl border border-slate-200 p-6 md:p-10 shadow-xl shadow-slate-200/50 mb-8 min-h-[400px] flex flex-col\">\r\n                {/* Question Type Badge */}\r\n                <div className=\"flex items-center gap-3 mb-6\">\r\n                    <span className={`px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider ${question.type === 'true-false' ? 'bg-purple-50 text-purple-700 border border-purple-100' :\r\n                        question.type === 'multi-select' ? 'bg-amber-50 text-amber-700 border border-amber-100' :\r\n                            'bg-indigo-50 text-indigo-700 border border-indigo-100'\r\n                        }`}>\r\n                        {question.type === 'true-false' ? 'Verdadero/Falso' :\r\n                            question.type === 'multi-select' ? 'Selecci√≥n M√∫ltiple' :\r\n                                'Opci√≥n M√∫ltiple'}\r\n                    </span>\r\n                    {question.type === 'multi-select' && (\r\n                        <span className=\"text-xs text-slate-400 flex items-center gap-1 font-medium\">\r\n                            <HelpCircle className=\"w-3 h-3\" />\r\n                            Selecciona todas las correctas\r\n                        </span>\r\n                    )}\r\n                </div>\r\n\r\n                <h2 className=\"text-2xl md:text-3xl font-black text-slate-900 mb-8 leading-tight\">\r\n                    {question.question}\r\n                </h2>\r\n\r\n                <div className=\"space-y-4 flex-1\">\r\n                    {question.type === 'multi-select' ? (\r\n                        // Multi-Select - Checkboxes\r\n                        question.options.map((option, index) => {\r\n                            const userAnswers = (answers[currentQuestion] as number[]) || [];\r\n                            const isSelected = userAnswers.includes(index);\r\n\r\n                            return (\r\n                                <button\r\n                                    key={index}\r\n                                    onClick={() => handleMultiAnswer(currentQuestion, index)}\r\n                                    className={`w-full text-left px-6 py-5 rounded-2xl border-2 font-medium transition-all group flex items-center justify-between ${isSelected\r\n                                        ? 'border-indigo-600 bg-indigo-50/50 shadow-sm'\r\n                                        : 'border-slate-200 hover:border-indigo-200 hover:bg-slate-50'\r\n                                        }`}\r\n                                    aria-pressed={isSelected ? 'true' : 'false'}\r\n                                >\r\n                                    <div className=\"flex items-center gap-4\">\r\n                                        <div className={`w-6 h-6 rounded flex items-center justify-center transition-colors ${isSelected\r\n                                            ? 'bg-indigo-600 text-white shadow-sm'\r\n                                            : 'bg-slate-100 text-transparent border border-slate-200 group-hover:border-indigo-300'\r\n                                            }`}>\r\n                                            <CheckCircle className=\"w-4 h-4\" />\r\n                                        </div>\r\n                                        <div>\r\n                                            <span className={`font-bold mr-3 ${isSelected ? 'text-indigo-700' : 'text-slate-400 group-hover:text-indigo-400'}`}>\r\n                                                {String.fromCharCode(65 + index)}.\r\n                                            </span>\r\n                                            <span className={`text-lg ${isSelected ? 'text-indigo-900 font-semibold' : 'text-slate-600'}`}>\r\n                                                {option}\r\n                                            </span>\r\n                                        </div>\r\n                                    </div>\r\n                                </button>\r\n                            );\r\n                        })\r\n                    ) : (\r\n                        // Single-Choice - Radio buttons\r\n                        question.options.map((option, index) => {\r\n                            const isSelected = answers[currentQuestion] === index;\r\n\r\n                            return (\r\n                                <button\r\n                                    key={index}\r\n                                    onClick={() => handleSingleAnswer(currentQuestion, index)}\r\n                                    className={`w-full text-left px-6 py-5 rounded-2xl border-2 font-medium transition-all group flex items-center justify-between ${isSelected\r\n                                        ? 'border-indigo-600 bg-indigo-50/50 shadow-sm'\r\n                                        : 'border-slate-200 hover:border-indigo-200 hover:bg-slate-50'\r\n                                        }`}\r\n                                    aria-pressed={isSelected ? 'true' : 'false'}\r\n                                >\r\n                                    <div className=\"flex items-center gap-4\">\r\n                                        <div className={`w-6 h-6 rounded-full flex items-center justify-center transition-all ${isSelected\r\n                                            ? 'border-[6px] border-indigo-600 bg-white'\r\n                                            : 'border-2 border-slate-300 group-hover:border-indigo-300'\r\n                                            }`}\r\n                                        />\r\n                                        <div>\r\n                                            <span className={`font-bold mr-3 ${isSelected ? 'text-indigo-700' : 'text-slate-400 group-hover:text-indigo-400'}`}>\r\n                                                {String.fromCharCode(65 + index)}.\r\n                                            </span>\r\n                                            <span className={`text-lg ${isSelected ? 'text-indigo-900 font-semibold' : 'text-slate-600'}`}>\r\n                                                {option}\r\n                                            </span>\r\n                                        </div>\r\n                                    </div>\r\n                                    {isSelected && <CheckCircle className=\"w-5 h-5 text-indigo-600\" />}\r\n                                </button>\r\n                            );\r\n                        })\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            {/* Navigation */}\r\n            <div className=\"flex items-center justify-between mt-8\">\r\n                <button\r\n                    onClick={() => setCurrentQuestion(Math.max(0, currentQuestion - 1))}\r\n                    disabled={currentQuestion === 0}\r\n                    className=\"flex items-center gap-2 px-6 py-3 text-slate-500 hover:text-slate-800 font-bold transition disabled:opacity-30 disabled:cursor-not-allowed disabled:hover:text-slate-500\"\r\n                >\r\n                    <ArrowLeft className=\"w-5 h-5\" />\r\n                    Anterior\r\n                </button>\r\n\r\n                {currentQuestion === quiz.questions.length - 1 ? (\r\n                    <button\r\n                        onClick={handleSubmit}\r\n                        disabled={!allAnswered}\r\n                        className=\"flex items-center gap-2 px-8 py-4 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 font-bold shadow-lg shadow-emerald-600/20 transition transform active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none\"\r\n                    >\r\n                        <Award className=\"w-5 h-5\" />\r\n                        Finalizar Quiz\r\n                    </button>\r\n                ) : (\r\n                    <button\r\n                        onClick={() => setCurrentQuestion(Math.min(quiz.questions.length - 1, currentQuestion + 1))}\r\n                        disabled={answers[currentQuestion] === undefined}\r\n                        className=\"flex items-center gap-2 px-8 py-4 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 font-bold shadow-lg shadow-indigo-600/20 transition transform active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none\"\r\n                    >\r\n                        Siguiente\r\n                        <ArrowRight className=\"w-5 h-5\" />\r\n                    </button>\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default QuizEngine;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\academy\\QuizResults.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":7,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":7,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[284,287],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[284,287],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState, useMemo } from 'react';\r\nimport { Trophy, CheckCircle, XCircle, ArrowRight, RotateCcw, TrendingUp } from 'lucide-react';\r\nimport { Quiz } from '../../hooks/useAcademy';\r\n\r\ninterface QuizResultsProps {\r\n    quiz: Quiz;\r\n    answers: Record<number, any>;\r\n    score: number;\r\n    onRetry?: () => void;\r\n    onComplete?: () => void;\r\n}\r\n\r\ninterface ConfettiPiece {\r\n    id: number;\r\n    left: number;\r\n    delay: number;\r\n    color: string;\r\n}\r\n\r\ninterface BreakdownItem {\r\n    question: string;\r\n    isCorrect: boolean;\r\n    userAnswer: string;\r\n    correctAnswer: string;\r\n}\r\n\r\n/**\r\n * QuizResults - Pantalla de resultados mejorada con animaciones\r\n * Muestra puntuaci√≥n, feedback y desglose de respuestas\r\n */\r\nconst QuizResults: React.FC<QuizResultsProps> = ({ quiz, answers, score, onRetry, onComplete }) => {\r\n    const [showConfetti, setShowConfetti] = useState(false);\r\n    const passed = score >= (quiz.passingScore || 80);\r\n\r\n    const [confettiPieces, setConfettiPieces] = useState<ConfettiPiece[]>([]);\r\n\r\n    useEffect(() => {\r\n        if (passed) {\r\n            // Generate deterministic confetti for this run\r\n            const pieces = [...Array(50)].map((_, i) => ({\r\n                id: i,\r\n                left: Math.random() * 100,\r\n                delay: Math.random() * 3,\r\n                color: ['#f59e0b', '#3b82f6', '#10b981', '#ef4444', '#8b5cf6'][Math.floor(Math.random() * 5)]\r\n            }));\r\n            const timer = setTimeout(() => {\r\n                setConfettiPieces(pieces);\r\n                setShowConfetti(true);\r\n            }, 0);\r\n\r\n            const hideTimer = setTimeout(() => setShowConfetti(false), 3000);\r\n            return () => { clearTimeout(timer); clearTimeout(hideTimer); };\r\n        }\r\n    }, [passed]);\r\n\r\n    // Calculate breakdown and stats\r\n    const breakdown = useMemo<BreakdownItem[]>(() => {\r\n        return quiz.questions.map((q, index) => {\r\n            const userAnswer = answers[index];\r\n            let isCorrect = false;\r\n            let userAnswerText = '';\r\n            let correctAnswerText = '';\r\n\r\n            if (q.type === 'multi-select') {\r\n                const correctAnswers = (q.correctAnswers || []) as number[];\r\n                const userAnswers = (userAnswer || []) as number[];\r\n\r\n                const hasAllCorrect = correctAnswers.every(a => userAnswers.includes(a));\r\n                const hasNoIncorrect = userAnswers.every(a => correctAnswers.includes(a));\r\n                isCorrect = hasAllCorrect && hasNoIncorrect && userAnswers.length > 0;\r\n\r\n                userAnswerText = userAnswers.map(i => q.options[i]).join(', ');\r\n                correctAnswerText = correctAnswers.map(i => q.options[i]).join(', ');\r\n            } else {\r\n                isCorrect = userAnswer === q.correctAnswer;\r\n                userAnswerText = (userAnswer !== undefined && q.options[userAnswer as number]) ? q.options[userAnswer as number] : '---';\r\n                correctAnswerText = q.options[q.correctAnswer as number];\r\n            }\r\n\r\n            return {\r\n                question: q.question,\r\n                isCorrect,\r\n                userAnswer: userAnswerText,\r\n                correctAnswer: correctAnswerText\r\n            };\r\n        });\r\n    }, [quiz, answers]);\r\n\r\n    const correctCount = breakdown.filter(i => i.isCorrect).length;\r\n    const incorrectCount = breakdown.length - correctCount;\r\n\r\n    return (\r\n        <>\r\n            {/* Confetti Animation */}\r\n            {showConfetti && (\r\n                <div className=\"fixed inset-0 pointer-events-none z-50\">\r\n                    <div className=\"confetti-container\">\r\n                        {confettiPieces.map((piece) => (\r\n                            <div\r\n                                key={piece.id}\r\n                                className=\"confetti\"\r\n                                style={{\r\n                                    left: `${piece.left}%`,\r\n                                    animationDelay: `${piece.delay}s`,\r\n                                    backgroundColor: piece.color\r\n                                }}\r\n                            />\r\n                        ))}\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            <div className=\"max-w-4xl mx-auto space-y-8 animate-fade-in\">\r\n                {/* Header Card */}\r\n                <div className={`bg-white rounded-3xl shadow-2xl p-12 text-center transform transition-all duration-500 ${passed ? 'border-4 border-emerald-400' : 'border-4 border-rose-400'\r\n                    } hover:scale-105`}>\r\n                    {/* Icon */}\r\n                    <div className=\"mb-6 flex justify-center\">\r\n                        {passed ? (\r\n                            <div className=\"w-32 h-32 bg-emerald-100 rounded-full flex items-center justify-center animate-bounce-slow\">\r\n                                <Trophy className=\"w-20 h-20 text-emerald-600\" />\r\n                            </div>\r\n                        ) : (\r\n                            <div className=\"w-32 h-32 bg-rose-100 rounded-full flex items-center justify-center animate-pulse\">\r\n                                <RotateCcw className=\"w-20 h-20 text-rose-600\" />\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n\r\n                    {/* Title */}\r\n                    <h1 className={`text-5xl font-black mb-4 ${passed ? 'text-emerald-600' : 'text-rose-600'\r\n                        }`}>\r\n                        {passed ? '¬°Felicidades!' : 'No Aprobado'}\r\n                    </h1>\r\n\r\n                    {/* Score */}\r\n                    <div className=\"mb-6\">\r\n                        <div className=\"text-8xl font-black bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent\">\r\n                            {score}%\r\n                        </div>\r\n                        <p className=\"text-xl text-slate-600 mt-2\">\r\n                            {correctCount} de {quiz.questions.length} correctas\r\n                        </p>\r\n                    </div>\r\n\r\n                    {/* Message */}\r\n                    <p className=\"text-lg text-slate-600 max-w-2xl mx-auto mb-8\">\r\n                        {passed\r\n                            ? '¬°Has completado el m√≥dulo con √©xito! Tu conocimiento ha sido validado.'\r\n                            : `Necesitas al menos ${quiz.passingScore || 80}% para aprobar. ¬°No te rindas, int√©ntalo de nuevo!`\r\n                        }\r\n                    </p>\r\n\r\n                    {/* Stats Summary */}\r\n                    <div className=\"grid grid-cols-2 gap-6 max-w-md mx-auto\">\r\n                        <div className=\"bg-emerald-50 rounded-2xl p-6 border-2 border-emerald-200\">\r\n                            <CheckCircle className=\"w-8 h-8 text-emerald-600 mx-auto mb-2\" />\r\n                            <div className=\"text-3xl font-bold text-emerald-600\">{correctCount}</div>\r\n                            <div className=\"text-sm text-emerald-700\">Correctas</div>\r\n                        </div>\r\n                        <div className=\"bg-rose-50 rounded-2xl p-6 border-2 border-rose-200\">\r\n                            <XCircle className=\"w-8 h-8 text-rose-600 mx-auto mb-2\" />\r\n                            <div className=\"text-3xl font-bold text-rose-600\">{incorrectCount}</div>\r\n                            <div className=\"text-sm text-rose-700\">Incorrectas</div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Breakdown Card */}\r\n                <div className=\"bg-white rounded-3xl shadow-xl p-8\">\r\n                    <h2 className=\"text-2xl font-bold text-slate-800 mb-6 flex items-center gap-3\">\r\n                        <TrendingUp className=\"w-7 h-7 text-blue-600\" />\r\n                        Desglose Detallado\r\n                    </h2>\r\n\r\n                    <div className=\"space-y-4\">\r\n                        {breakdown.map((item, index) => (\r\n                            <div\r\n                                key={index}\r\n                                className={`p-6 rounded-2xl border-2 transition-all hover:shadow-md ${item.isCorrect\r\n                                    ? 'bg-emerald-50 border-emerald-300'\r\n                                    : 'bg-rose-50 border-rose-300'\r\n                                    }`}\r\n                            >\r\n                                <div className=\"flex items-start gap-4\">\r\n                                    {item.isCorrect ? (\r\n                                        <CheckCircle className=\"w-6 h-6 text-emerald-600 flex-shrink-0 mt-1\" />\r\n                                    ) : (\r\n                                        <XCircle className=\"w-6 h-6 text-rose-600 flex-shrink-0 mt-1\" />\r\n                                    )}\r\n                                    <div className=\"flex-1\">\r\n                                        <h3 className=\"font-bold text-slate-800 mb-3\">\r\n                                            Pregunta {index + 1}: {item.question}\r\n                                        </h3>\r\n                                        <div className=\"space-y-2\">\r\n                                            <div className={`flex items-center gap-2 ${item.isCorrect ? 'text-emerald-700' : 'text-rose-700'\r\n                                                }`}>\r\n                                                <span className=\"font-semibold\">Tu respuesta:</span>\r\n                                                <span>{item.userAnswer}</span>\r\n                                            </div>\r\n                                            {!item.isCorrect && (\r\n                                                <div className=\"flex items-center gap-2 text-emerald-700\">\r\n                                                    <span className=\"font-semibold\">Respuesta correcta:</span>\r\n                                                    <span className=\"font-bold\">{item.correctAnswer}</span>\r\n                                                </div>\r\n                                            )}\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Actions */}\r\n                <div className=\"flex gap-4 justify-center\">\r\n                    {!passed && onRetry && (\r\n                        <button\r\n                            onClick={onRetry}\r\n                            className=\"flex items-center gap-3 px-8 py-4 bg-blue-600 text-white rounded-2xl hover:bg-blue-700 font-bold text-lg shadow-lg hover:shadow-xl transition-all transform hover:scale-105\"\r\n                        >\r\n                            <RotateCcw className=\"w-6 h-6\" />\r\n                            Reintentar Quiz\r\n                        </button>\r\n                    )}\r\n                    <button\r\n                        onClick={onComplete}\r\n                        className={`flex items-center gap-3 px-8 py-4 rounded-2xl font-bold text-lg shadow-lg hover:shadow-xl transition-all transform hover:scale-105 ${passed\r\n                            ? 'bg-emerald-600 text-white hover:bg-emerald-700'\r\n                            : 'bg-slate-200 text-slate-700 hover:bg-slate-300'\r\n                            }`}\r\n                    >\r\n                        {passed ? 'Continuar' : 'Volver'}\r\n                        <ArrowRight className=\"w-6 h-6\" />\r\n                    </button>\r\n                </div>\r\n\r\n                {/* Progress Saved Message */}\r\n                {passed && (\r\n                    <div className=\"text-center\">\r\n                        <p className=\"text-emerald-600 font-bold text-lg animate-pulse\">\r\n                            ‚úÖ Progreso guardado - Siguiente m√≥dulo desbloqueado\r\n                        </p>\r\n                    </div>\r\n                )}\r\n            </div>\r\n\r\n            {/* CSS for Confetti */}\r\n            <style>{`\r\n                @keyframes confetti-fall {\r\n                    to {\r\n                        transform: translateY(100vh) rotate(360deg);\r\n                    }\r\n                }\r\n\r\n                @keyframes fade-in {\r\n                    from {\r\n                        opacity: 0;\r\n                        transform: translateY(20px);\r\n                    }\r\n                    to {\r\n                        opacity: 1;\r\n                        transform: translateY(0);\r\n                    }\r\n                }\r\n\r\n                @keyframes bounce-slow {\r\n                    0%, 100% {\r\n                        transform: translateY(0);\r\n                    }\r\n                    50% {\r\n                        transform: translateY(-20px);\r\n                    }\r\n                }\r\n\r\n                .confetti {\r\n                    position: absolute;\r\n                    width: 10px;\r\n                    height: 10px;\r\n                    top: -10px;\r\n                    animation: confetti-fall 3s linear infinite;\r\n                }\r\n\r\n                .animate-fade-in {\r\n                    animation: fade-in 0.6s ease-out;\r\n                }\r\n\r\n                .animate-bounce-slow {\r\n                    animation: bounce-slow 2s ease-in-out infinite;\r\n                }\r\n            `}</style>\r\n        </>\r\n    );\r\n\r\n};\r\n\r\nexport default QuizResults;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\AdminFranchiseView.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":78,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":78,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2976,2979],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2976,2979],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, Suspense, lazy } from 'react';\r\nimport { ArrowLeft, Bike, CalendarDays, Wallet, Users, LucideIcon, LogIn } from 'lucide-react';\r\nimport { useAuth } from '../../context/AuthContext';\r\nimport { useParams, useNavigate } from 'react-router-dom';\r\nimport { franchiseService } from '../../services/franchiseService';\r\nimport { isOk } from '../../types/result';\r\nimport MonthlyHistoryTable from '../franchise/finance/MonthlyHistoryTable';\r\nimport UserManagementPanel from './users/UserManagementPanel';\r\n\r\n// Lazy load heavy components\r\nconst WeeklyScheduler = lazy(() => import('../operations/WeeklyScheduler'));\r\nconst FleetManager = lazy(() => import('../operations/FleetManager'));\r\nconst FranchiseDashboard = lazy(() => import('../franchise/FranchiseDashboard'));\r\n\r\n\r\n// =====================================================\r\n// TYPES & INTERFACES\r\n// =====================================================\r\n\r\nexport interface AdminFranchiseViewProps {\r\n    franchiseId?: string;\r\n    onBack?: () => void;\r\n}\r\n\r\ninterface FranchiseData {\r\n    id?: string;\r\n    name?: string;\r\n    status?: 'active' | 'inactive' | 'unknown';\r\n    [key: string]: unknown;\r\n}\r\n\r\ntype TabId = 'dashboard' | 'operations' | 'team' | 'fleet' | 'academy' | 'finance' | 'settings' | 'kanban';\r\n\r\ninterface TabConfig {\r\n    id: TabId;\r\n    label: string;\r\n    icon: LucideIcon;\r\n}\r\n\r\n// =====================================================\r\n// COMPONENT\r\n// =====================================================\r\n\r\nconst AdminFranchiseView: React.FC<AdminFranchiseViewProps> = ({ franchiseId: propId, onBack: propOnBack }) => {\r\n    const { franchiseId: paramId } = useParams<{ franchiseId: string }>();\r\n    const navigate = useNavigate();\r\n\r\n    const { startImpersonation } = useAuth();\r\n    const franchiseId = propId || paramId;\r\n    const onBack = propOnBack || (() => navigate('/dashboard?view=franchises'));\r\n\r\n    // Default to finance\r\n    const [activeTab, setActiveTab] = useState<TabId>('finance');\r\n    const [franchiseData, setFranchiseData] = useState<FranchiseData | null>(null);\r\n    const [loading, setLoading] = useState(true);\r\n\r\n    // Simplified Tabs\r\n    const TABS: TabConfig[] = [\r\n        { id: 'finance', label: 'Finanzas', icon: Wallet },\r\n        { id: 'operations', label: 'Horarios', icon: CalendarDays },\r\n        { id: 'team', label: 'Riders', icon: Users },\r\n        { id: 'fleet', label: 'Flota', icon: Bike },\r\n    ];\r\n\r\n    // FETCH REAL FRANCHISE DATA\r\n    useEffect(() => {\r\n        if (!franchiseId) return;\r\n\r\n        const fetchFranchiseDetails = async () => {\r\n            try {\r\n                setLoading(true);\r\n                const result = await franchiseService.getFranchiseMeta(franchiseId);\r\n\r\n                if (isOk(result)) {\r\n                    setFranchiseData({\r\n                        id: result.data.id,\r\n                        name: result.data.name,\r\n                        status: (result.data as any).status || 'active'\r\n                    } as FranchiseData);\r\n                } else {\r\n                    console.warn(\"Franquicia no encontrada en BD, usando ID visual\");\r\n                    setFranchiseData({ name: `Franquicia: ${franchiseId}`, status: 'unknown' });\r\n                }\r\n            } catch (error) {\r\n                console.error(\"Error cargando franquicia:\", error);\r\n            } finally {\r\n                setLoading(false);\r\n            }\r\n        };\r\n\r\n        fetchFranchiseDetails();\r\n    }, [franchiseId]);\r\n\r\n    if (!franchiseId) return null;\r\n\r\n    return (\r\n        <div className=\"min-h-screen bg-slate-50 relative animate-in fade-in zoom-in-95 duration-300\">\r\n            {/* Header (God Mode Indicator) */}\r\n            <div className=\"bg-slate-900 border-b border-indigo-500/30 text-white sticky top-0 z-50 shadow-xl\">\r\n                <div className=\"max-w-7xl mx-auto px-4 py-3 flex items-center justify-between\">\r\n                    <div className=\"flex items-center gap-4\">\r\n                        <button\r\n                            onClick={onBack}\r\n                            className=\"p-2 hover:bg-white/10 rounded-full transition-colors\"\r\n                            title=\"Volver al Listado\"\r\n                        >\r\n                            <ArrowLeft size={20} className=\"text-slate-400\" />\r\n                        </button>\r\n                        <button\r\n                            onClick={() => {\r\n                                if (franchiseId) {\r\n                                    startImpersonation(franchiseId);\r\n                                    navigate('/dashboard');\r\n                                }\r\n                            }}\r\n                            className=\"flex items-center gap-2 px-3 py-1.5 bg-indigo-500/20 hover:bg-indigo-500/30 text-indigo-400 rounded-lg text-xs font-bold transition-all border border-indigo-500/30\"\r\n                            title=\"Entrar como esta franquicia (Inmersi√≥n Completa)\"\r\n                        >\r\n                            <LogIn size={14} />\r\n                            <span>Entrar</span>\r\n                        </button>\r\n                        <div>\r\n                            <div className=\"flex items-center gap-2\">\r\n                                <h2 className=\"text-xs uppercase tracking-widest text-indigo-400 font-bold\">Modo Supervisor</h2>\r\n                                {franchiseData?.status === 'active' && (\r\n                                    <span className=\"px-2 py-0.5 rounded text-[10px] bg-emerald-500/20 text-emerald-400 border border-emerald-500/30\">\r\n                                        ACTIVO\r\n                                    </span>\r\n                                )}\r\n                            </div>\r\n                            <h1 className=\"text-xl font-bold flex items-center gap-2\">\r\n                                {loading ? (\r\n                                    <span className=\"animate-pulse bg-white/20 h-6 w-48 rounded\" />\r\n                                ) : (\r\n                                    <span>{franchiseData?.name || franchiseId}</span>\r\n                                )}\r\n                            </h1>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"flex gap-1 overflow-x-auto pb-1 md:pb-0\">\r\n                        {TABS.map(tab => {\r\n                            const Icon = tab.icon;\r\n                            const isActive = activeTab === tab.id;\r\n                            return (\r\n                                <button\r\n                                    key={tab.id}\r\n                                    onClick={() => setActiveTab(tab.id)}\r\n                                    className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all whitespace-nowrap ${isActive\r\n                                        ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-500/20'\r\n                                        : 'text-slate-400 hover:text-white hover:bg-white/5'\r\n                                        }`}\r\n                                >\r\n                                    <Icon size={16} />\r\n                                    <span className=\"hidden md:inline\">{tab.label}</span>\r\n                                </button>\r\n                            );\r\n                        })}\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Content Area */}\r\n            <div className=\"max-w-7xl mx-auto px-4 py-4 md:py-8\">\r\n\r\n                {/* 1. FINANZAS: KPIs + History */}\r\n                {activeTab === 'finance' && (\r\n                    <div className=\"space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500\">\r\n                        {/* KPI SECTION */}\r\n                        <Suspense fallback={<div className=\"h-64 bg-white/50 rounded-xl animate-pulse\" />}>\r\n                            <FranchiseDashboard franchiseId={franchiseId} readOnly={true} />\r\n                        </Suspense>\r\n\r\n                        {/* HISTORY SECTION */}\r\n                        <div className=\"space-y-4\">\r\n                            <div className=\"flex items-center gap-3\">\r\n                                <div className=\"p-2 bg-indigo-100 rounded-lg\">\r\n                                    <Wallet className=\"w-5 h-5 text-indigo-600\" />\r\n                                </div>\r\n                                <div>\r\n                                    <h2 className=\"text-xl font-bold text-slate-900\">Hist√≥rico de Cierres</h2>\r\n                                    <p className=\"text-sm text-slate-500\">Registro mensual de estados financieros.</p>\r\n                                </div>\r\n                            </div>\r\n                            <MonthlyHistoryTable franchiseId={franchiseData?.id || franchiseId} />\r\n                        </div>\r\n                    </div>\r\n                )}\r\n\r\n                {activeTab === 'operations' && (\r\n                    <div className=\"h-[calc(100vh-180px)] min-h-[600px] animate-in fade-in slide-in-from-bottom-4 duration-500\">\r\n                        <Suspense fallback={<div className=\"h-full w-full flex items-center justify-center bg-white/50 rounded-2xl animate-pulse\"><div className=\"text-slate-400 font-medium\">Cargando planificador...</div></div>}>\r\n                            <div className=\"h-full w-full bg-white rounded-2xl shadow-xl ring-1 ring-black/5 overflow-hidden flex flex-col\">\r\n                                <WeeklyScheduler franchiseId={franchiseData?.id || franchiseId} readOnly={true} />\r\n                            </div>\r\n                        </Suspense>\r\n                    </div>\r\n                )}\r\n\r\n                {/* 3. TEAM: Riders */}\r\n                {activeTab === 'team' && (\r\n                    <div className=\"animate-in fade-in slide-in-from-bottom-4 duration-500\">\r\n                        <div className=\"mb-6\">\r\n                            <h2 className=\"text-2xl font-bold text-slate-900 flex items-center gap-2\">\r\n                                <Users className=\"w-6 h-6 text-indigo-600\" />\r\n                                Equipo de Riders\r\n                            </h2>\r\n                            <p className=\"text-slate-500\">Gesti√≥n de personal asociado a la franquicia.</p>\r\n                        </div>\r\n                        <UserManagementPanel franchiseId={franchiseData?.id || franchiseId} readOnly={true} />\r\n                    </div>\r\n                )}\r\n\r\n                {/* 4. FLEET: Motos */}\r\n                {activeTab === 'fleet' && (\r\n                    <Suspense fallback={<div className=\"p-8 text-center text-slate-400\">Cargando flota...</div>}>\r\n                        <div className=\"mb-6\">\r\n                            <h2 className=\"text-2xl font-bold text-slate-900 flex items-center gap-2\">\r\n                                <Bike className=\"w-6 h-6 text-indigo-600\" />\r\n                                Flota\r\n                            </h2>\r\n                            <p className=\"text-slate-500\">Estado de veh√≠culos y asignaciones.</p>\r\n                        </div>\r\n                        <FleetManager franchiseId={franchiseData?.id || franchiseId} readOnly={true} />\r\n                    </Suspense>\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default AdminFranchiseView;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\AdminResourcesPanel.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":45,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":45,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1367,1370],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1367,1370],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useMemo } from 'react';\r\nimport { db, storage } from '../../lib/firebase';\r\nimport { collection, deleteDoc, doc, query, orderBy, onSnapshot, updateDoc, Timestamp } from 'firebase/firestore';\r\nimport { ref, deleteObject } from 'firebase/storage';\r\nimport {\r\n    FileText,\r\n    Image as ImageIcon,\r\n    File,\r\n    Grid,\r\n    List as ListIcon,\r\n    Search,\r\n    Trash2,\r\n    Eye,\r\n    Download,\r\n    Plus,\r\n    Pin,\r\n    FolderOpen,\r\n    Shield,\r\n    Briefcase,\r\n    BookOpen,\r\n    Layout,\r\n    Folder\r\n} from 'lucide-react';\r\nimport DocPreviewModal from '../../ui/overlays/DocPreviewModal';\r\nimport ConfirmationModal from '../../ui/feedback/ConfirmationModal';\r\nimport ResourceUploadModal from './resources/ResourceUploadModal';\r\nimport AdminGuidesPanel from './knowledge/AdminGuidesPanel';\r\nimport UserManual from '../common/UserManual/UserManual';\r\nimport RequestsInbox from './resources/RequestsInbox';\r\nimport ServiceManager from './services/ServiceManager';\r\nimport { resourceRequestService } from '../../services/resourceRequestService';\r\n\r\ninterface Resource {\r\n    id: string;\r\n    title?: string;\r\n    name?: string;\r\n    category?: string;\r\n    type?: string;\r\n    size?: number;\r\n    url?: string;\r\n    storagePath?: string;\r\n    createdAt?: Timestamp;\r\n    isPinned?: boolean;\r\n    isMock?: boolean;\r\n    [key: string]: any;\r\n}\r\n\r\ninterface ConfirmDialogState {\r\n    isOpen: boolean;\r\n    title: string;\r\n    message: string;\r\n    confirmText?: string;\r\n    isDestructive?: boolean;\r\n    onConfirm: (() => void) | null;\r\n}\r\n\r\n// üóÇÔ∏è Unified Folder Structure (Same as Franchise)\r\nconst FOLDERS = [\r\n    { id: 'contracts', label: 'Marco Legal & Contratos', icon: Shield, color: 'text-indigo-500' },\r\n    { id: 'manuals', label: 'Manuales Operativos', icon: BookOpen, color: 'text-emerald-500' },\r\n    { id: 'commercial', label: 'Dossiers Comerciales', icon: Briefcase, color: 'text-amber-500' },\r\n    { id: 'marketing', label: 'Activos de Marca', icon: Layout, color: 'text-rose-500' },\r\n    { id: 'general', label: 'Documentaci√≥n General', icon: Folder, color: 'text-slate-500' },\r\n];\r\n\r\n// üìÑ Mock Data removed for production\r\nconst MOCK_RESOURCES: Resource[] = [];\r\n\r\nconst AdminResourcesPanel = () => {\r\n    // Tab State (Global Navigation)\r\n    const [activeTab, setActiveTab] = useState<'vault' | 'guides' | 'manual' | 'requests' | 'services'>('vault');\r\n    const [activeCategory, setActiveCategory] = useState<string>('contracts');\r\n\r\n    // Data State\r\n    const [dbResources, setDbResources] = useState<Resource[]>([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const [searchTerm, setSearchTerm] = useState('');\r\n    const [viewMode, setViewMode] = useState<'list' | 'grid'>('grid');\r\n    const [pendingRequestsCount, setPendingRequestsCount] = useState(0);\r\n\r\n    // Modals State\r\n    const [isUploadModalOpen, setIsUploadModalOpen] = useState(false);\r\n    const [previewFile, setPreviewFile] = useState<Resource | null>(null);\r\n    const [confirmDialog, setConfirmDialog] = useState<ConfirmDialogState>({\r\n        isOpen: false,\r\n        title: '',\r\n        message: '',\r\n        onConfirm: null,\r\n    });\r\n\r\n    // Fetch resources\r\n    useEffect(() => {\r\n        const q = query(collection(db, 'resources'), orderBy('createdAt', 'desc'));\r\n        const unsubscribe = onSnapshot(q, (snapshot) => {\r\n            const fetched: Resource[] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() } as Resource));\r\n            setDbResources(fetched);\r\n            setLoading(false);\r\n        }, (error) => {\r\n            console.error(\"Error fetching resources: \", error);\r\n            setLoading(false);\r\n        });\r\n\r\n        return () => unsubscribe();\r\n    }, []);\r\n\r\n    // Fetch Pending Requests Count\r\n    useEffect(() => {\r\n        const fetchPending = async () => {\r\n            const reqs = await resourceRequestService.getPendingRequests();\r\n            setPendingRequestsCount(reqs.length);\r\n        };\r\n        fetchPending();\r\n    }, []);\r\n\r\n    // Merge Mock & Real\r\n    const allResources = useMemo(() => {\r\n        return [...MOCK_RESOURCES, ...dbResources];\r\n    }, [dbResources]);\r\n\r\n    // Filter Logic\r\n    const filteredResources = useMemo(() => {\r\n        let filtered = allResources;\r\n\r\n        // 1. Category Filter\r\n        if (activeCategory) {\r\n            filtered = filtered.filter(r => (r.category || 'general') === activeCategory);\r\n        }\r\n\r\n        // 2. Search Filter\r\n        if (searchTerm) {\r\n            const lower = searchTerm.toLowerCase();\r\n            filtered = filtered.filter(resource =>\r\n                (resource.title || resource.name || '').toLowerCase().includes(lower)\r\n            );\r\n        }\r\n\r\n        // 3. Sort (Pinned first)\r\n        return filtered.sort((a, b) => {\r\n            if (a.isPinned && !b.isPinned) return -1;\r\n            if (!a.isPinned && b.isPinned) return 1;\r\n            return 0; // Keep original order (createdAt)\r\n        });\r\n    }, [allResources, activeCategory, searchTerm]);\r\n\r\n\r\n    // Actions\r\n    const handleDelete = (file: Resource) => {\r\n        if (file.isMock) {\r\n            alert(\"No puedes eliminar archivos de ejemplo (Mock)\");\r\n            return;\r\n        }\r\n\r\n        setConfirmDialog({\r\n            isOpen: true,\r\n            title: 'Eliminar Recurso',\r\n            message: `¬øEst√°s seguro de que quieres eliminar \"${file.title || file.name}\"? Esta acci√≥n es irreversible.`,\r\n            confirmText: 'Eliminar',\r\n            isDestructive: true,\r\n            onConfirm: async () => {\r\n                try {\r\n                    if (file.storagePath) {\r\n                        const fileRef = ref(storage, file.storagePath);\r\n                        await deleteObject(fileRef);\r\n                    }\r\n                    await deleteDoc(doc(db, 'resources', file.id));\r\n                    setConfirmDialog(prev => ({ ...prev, isOpen: false }));\r\n                } catch (error) {\r\n                    console.error(\"Error deleting resource: \", error);\r\n                    alert(\"Error al eliminar el recurso.\");\r\n                }\r\n            },\r\n        });\r\n    };\r\n\r\n    const togglePin = async (file: Resource, event: React.MouseEvent) => {\r\n        event.stopPropagation();\r\n        if (file.isMock) return; // Mocks are fixed\r\n        try {\r\n            const fileRef = doc(db, 'resources', file.id);\r\n            await updateDoc(fileRef, { isPinned: !file.isPinned });\r\n        } catch (error) {\r\n            console.error(\"Error toggling pin: \", error);\r\n        }\r\n    };\r\n\r\n    const formatBytes = (bytes?: number) => {\r\n        if (!bytes) return '0 B';\r\n        const k = 1024;\r\n        const sizes = ['B', 'KB', 'MB', 'GB'];\r\n        const i = Math.floor(Math.log(bytes) / Math.log(k));\r\n        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];\r\n    };\r\n\r\n    const getFileIcon = (type?: string) => {\r\n        if (type?.includes('pdf')) return <FileText className=\"w-10 h-10 text-rose-500\" />;\r\n        if (type?.includes('image')) return <ImageIcon className=\"w-10 h-10 text-indigo-500\" />;\r\n        if (type?.includes('zip')) return <Folder className=\"w-10 h-10 text-amber-500\" />;\r\n        if (type?.includes('sheet') || type?.includes('excel')) return <FileText className=\"w-10 h-10 text-emerald-500\" />;\r\n        if (type?.includes('presentation')) return <FileText className=\"w-10 h-10 text-orange-500\" />;\r\n        return <File className=\"w-10 h-10 text-slate-400\" />;\r\n    };\r\n\r\n\r\n    return (\r\n        <div className=\"flex flex-col h-full bg-slate-50 dark:bg-slate-950 min-h-screen text-slate-900 dark:text-slate-200 font-sans transition-colors duration-300\">\r\n\r\n            {/* HEADER with Global Navigation */}\r\n            <div className=\"flex flex-col md:flex-row md:items-center justify-between p-6 bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 z-20\">\r\n                <div className=\"mb-4 md:mb-0\">\r\n                    <h2 className=\"text-2xl font-black text-slate-900 dark:text-white tracking-tight flex items-center gap-3\">\r\n                        Centro de Conocimiento\r\n                        <span className=\"px-2 py-0.5 rounded-full bg-indigo-500/10 text-indigo-600 dark:text-indigo-300 text-[10px] font-bold border border-indigo-500/20 uppercase tracking-widest\">Admin</span>\r\n                    </h2>\r\n                    <p className=\"text-sm text-slate-500 dark:text-slate-400 mt-1 font-medium\">Gesti√≥n integral de documentaci√≥n y gu√≠as.</p>\r\n                </div>\r\n\r\n                <div className=\"flex bg-slate-100 dark:bg-slate-800 p-1 rounded-xl\">\r\n                    <button\r\n                        onClick={() => setActiveTab('vault')}\r\n                        className={`px-5 py-2 rounded-lg text-sm font-bold transition-all ${activeTab === 'vault' ? 'bg-white dark:bg-slate-700 text-indigo-600 dark:text-white shadow-sm' : 'text-slate-500 hover:text-slate-700 dark:hover:text-slate-300'}`}\r\n                    >\r\n                        B√≥veda Digital\r\n                    </button>\r\n                    <button\r\n                        onClick={() => setActiveTab('guides')}\r\n                        className={`px-5 py-2 rounded-lg text-sm font-bold transition-all ${activeTab === 'guides' ? 'bg-white dark:bg-slate-700 text-indigo-600 dark:text-white shadow-sm' : 'text-slate-500 hover:text-slate-700 dark:hover:text-slate-300'}`}\r\n                    >\r\n                        Gu√≠as Interactivas\r\n                    </button>\r\n                    <button\r\n                        onClick={() => setActiveTab('manual')}\r\n                        className={`px-5 py-2 rounded-lg text-sm font-bold transition-all ${activeTab === 'manual' ? 'bg-white dark:bg-slate-700 text-indigo-600 dark:text-white shadow-sm' : 'text-slate-500 hover:text-slate-700 dark:hover:text-slate-300'}`}\r\n                    >\r\n                        Manual de Uso\r\n                    </button>\r\n                    <button\r\n                        onClick={() => setActiveTab('requests')}\r\n                        className={`px-5 py-2 rounded-lg text-sm font-bold transition-all relative flex items-center gap-2 ${activeTab === 'requests' ? 'bg-white dark:bg-slate-700 text-indigo-600 dark:text-white shadow-sm' : 'text-slate-500 hover:text-slate-700 dark:hover:text-slate-300'}`}\r\n                    >\r\n                        Solicitudes\r\n                        {pendingRequestsCount > 0 && (\r\n                            <span className=\"flex items-center justify-center bg-rose-500 text-white text-[10px] h-5 min-w-[20px] px-1 rounded-full border-2 border-slate-100 dark:border-slate-800\">\r\n                                {pendingRequestsCount}\r\n                            </span>\r\n                        )}\r\n                    </button>\r\n                    <button\r\n                        onClick={() => setActiveTab('services')}\r\n                        className={`px-5 py-2 rounded-lg text-sm font-bold transition-all ${activeTab === 'services' ? 'bg-white dark:bg-slate-700 text-indigo-600 dark:text-white shadow-sm' : 'text-slate-500 hover:text-slate-700 dark:hover:text-slate-300'}`}\r\n                    >\r\n                        Servicios Premium\r\n                    </button>\r\n                </div>\r\n            </div>\r\n\r\n            {/* CONTENT AREA */}\r\n            <div className=\"flex-1 flex overflow-hidden\">\r\n                {activeTab === 'vault' ? (\r\n                    <>\r\n                        {/* üìÇ SIDEBAR (Folders) */}\r\n                        <aside className=\"w-72 bg-white dark:bg-slate-900/50 border-r border-slate-200 dark:border-slate-800 flex flex-col pt-6 pb-4\">\r\n                            <div className=\"px-6 mb-2\">\r\n                                <h3 className=\"text-xs font-black text-slate-400 uppercase tracking-widest mb-4\">Estructura de Archivos</h3>\r\n                            </div>\r\n                            <nav className=\"flex-1 px-4 space-y-1 overflow-y-auto custom-scrollbar\">\r\n                                {FOLDERS.map(folder => {\r\n                                    const isActive = activeCategory === folder.id;\r\n                                    return (\r\n                                        <button\r\n                                            key={folder.id}\r\n                                            onClick={() => setActiveCategory(folder.id)}\r\n                                            className={`w-full flex items-center justify-between px-4 py-3 rounded-xl text-sm font-medium transition-all duration-200 group ${isActive\r\n                                                ? 'bg-indigo-50 dark:bg-indigo-900/20 text-indigo-700 dark:text-indigo-300 ring-1 ring-indigo-200 dark:ring-indigo-800'\r\n                                                : 'text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800'\r\n                                                }`}\r\n                                        >\r\n                                            <div className=\"flex items-center gap-3\">\r\n                                                <folder.icon className={`w-4 h-4 ${isActive ? 'text-indigo-600' : 'text-slate-400 group-hover:text-slate-600'}`} />\r\n                                                {folder.label}\r\n                                            </div>\r\n                                            {isActive && <div className=\"w-1.5 h-1.5 rounded-full bg-indigo-500\" />}\r\n                                        </button>\r\n                                    );\r\n                                })}\r\n                            </nav>\r\n\r\n                            <div className=\"p-4 mt-auto border-t border-slate-100 dark:border-slate-800 space-y-4\">\r\n                                {/* Storage Widget */}\r\n                                <div className=\"bg-slate-50 dark:bg-slate-800/50 rounded-xl p-4 border border-slate-100 dark:border-slate-700\">\r\n                                    <div className=\"flex justify-between items-center mb-2\">\r\n                                        <span className=\"text-[10px] font-bold text-slate-500 uppercase tracking-wider\">Almacenamiento</span>\r\n                                        <span className=\"text-[10px] font-bold text-indigo-500\">2.4 GB / 10 GB</span>\r\n                                    </div>\r\n                                    <div className=\"h-1.5 w-full bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden\">\r\n                                        <div className=\"h-full bg-indigo-500 w-[24%] rounded-full\" />\r\n                                    </div>\r\n                                </div>\r\n\r\n                                <button\r\n                                    onClick={() => setIsUploadModalOpen(true)}\r\n                                    className=\"w-full py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl shadow-lg shadow-indigo-500/20 transition-all font-bold text-sm flex items-center justify-center gap-2 group\"\r\n                                >\r\n                                    <Plus className=\"w-4 h-4 group-hover:rotate-90 transition-transform\" />\r\n                                    Subir Nuevo Recurso\r\n                                </button>\r\n                            </div>\r\n                        </aside>\r\n\r\n                        {/* üìÑ MAIN GRID */}\r\n                        <main className=\"flex-1 flex flex-col min-w-0 bg-slate-50/50 dark:bg-slate-950/50 relative\">\r\n                            {/* Sub-Header / Search */}\r\n                            <div className=\"h-16 px-8 border-b border-slate-200 dark:border-slate-800 flex items-center justify-between shrink-0 bg-white/50 dark:bg-slate-950/50 backdrop-blur-md sticky top-0 z-10\">\r\n                                <div className=\"flex items-center gap-4\">\r\n                                    <h3 className=\"text-lg font-bold text-slate-900 dark:text-white\">\r\n                                        {FOLDERS.find(f => f.id === activeCategory)?.label}\r\n                                    </h3>\r\n                                    <span className=\"bg-slate-200 dark:bg-slate-800 text-slate-600 dark:text-slate-400 text-xs font-bold px-2 py-0.5 rounded-md\">\r\n                                        {filteredResources.length}\r\n                                    </span>\r\n                                </div>\r\n\r\n                                <div className=\"flex items-center gap-3\">\r\n                                    <div className=\"relative group w-64 transition-all focus-within:w-80\">\r\n                                        <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 group-focus-within:text-indigo-500 transition-colors\" />\r\n                                        <input\r\n                                            type=\"text\"\r\n                                            value={searchTerm}\r\n                                            onChange={(e) => setSearchTerm(e.target.value)}\r\n                                            placeholder=\"Filtrar archivos...\"\r\n                                            className=\"w-full pl-10 pr-4 py-2 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl text-sm outline-none focus:ring-2 focus:ring-indigo-500/20 transition-all shadow-sm\"\r\n                                        />\r\n                                    </div>\r\n                                    <div className=\"flex bg-white dark:bg-slate-900 rounded-lg p-1 border border-slate-200 dark:border-slate-700 shadow-sm\">\r\n                                        <button onClick={() => setViewMode('grid')} title=\"Vista Cuadr√≠cula\" className={`p-1.5 rounded-md transition-all ${viewMode === 'grid' ? 'bg-indigo-50 text-indigo-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}>\r\n                                            <Grid className=\"w-4 h-4\" />\r\n                                        </button>\r\n                                        <button onClick={() => setViewMode('list')} title=\"Vista Lista\" className={`p-1.5 rounded-md transition-all ${viewMode === 'list' ? 'bg-indigo-50 text-indigo-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}>\r\n                                            <ListIcon className=\"w-4 h-4\" />\r\n                                        </button>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n\r\n                            {/* Scrollable Content */}\r\n                            <div className=\"flex-1 overflow-y-auto p-8 custom-scrollbar\">\r\n                                {loading ? (\r\n                                    <div className=\"grid grid-cols-4 gap-6 animate-pulse\">\r\n                                        {[1, 2, 3, 4, 5, 6].map(i => <div key={i} className=\"h-48 bg-slate-200 dark:bg-slate-800 rounded-2xl\" />)}\r\n                                    </div>\r\n                                ) : filteredResources.length === 0 ? (\r\n                                    <div className=\"h-full flex flex-col items-center justify-center text-center opacity-80 animate-in fade-in zoom-in-95 duration-500\">\r\n                                        <div className=\"w-24 h-24 bg-slate-50 dark:bg-slate-800 rounded-full flex items-center justify-center mb-4 group relative\">\r\n                                            <div className=\"absolute inset-0 border-2 border-dashed border-slate-200 dark:border-slate-700 rounded-full animate-spin-slow pointer-events-none\" />\r\n                                            <FolderOpen className=\"w-10 h-10 text-slate-300 dark:text-slate-600 group-hover:scale-110 transition-transform\" />\r\n                                        </div>\r\n                                        <h4 className=\"text-lg font-black text-slate-700 dark:text-slate-200\">Carpeta Vac√≠a</h4>\r\n                                        <p className=\"text-sm text-slate-400 dark:text-slate-500 max-w-[200px] mt-2 mb-6 leading-relaxed\">\r\n                                            No hay documentos en esta secci√≥n.\r\n                                        </p>\r\n                                        <button\r\n                                            onClick={() => setIsUploadModalOpen(true)}\r\n                                            className=\"px-6 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-full text-indigo-600 dark:text-indigo-400 text-xs font-bold uppercase tracking-wider hover:bg-indigo-50 dark:hover:bg-slate-700 transition-colors\"\r\n                                        >\r\n                                            Subir primer archivo\r\n                                        </button>\r\n                                    </div>\r\n                                ) : (\r\n                                    <>\r\n                                        {viewMode === 'grid' ? (\r\n                                            <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6\">\r\n                                                {filteredResources.map((file) => (\r\n                                                    <div\r\n                                                        key={file.id}\r\n                                                        onClick={() => setPreviewFile(file)}\r\n                                                        className=\"group bg-white dark:bg-slate-900 border border-slate-100 dark:border-slate-800 rounded-[2rem] p-5 hover:border-indigo-400 dark:hover:border-indigo-500 hover:shadow-2xl hover:shadow-indigo-500/10 transition-all duration-300 hover:-translate-y-1 cursor-pointer flex flex-col items-center text-center relative overflow-hidden\"\r\n                                                    >\r\n                                                        {file.isMock && (\r\n                                                            <div className=\"absolute top-3 left-3 z-10\">\r\n                                                                <span className=\"bg-slate-100 dark:bg-slate-800 text-[9px] font-bold text-slate-400 px-1.5 py-0.5 rounded border border-slate-200 dark:border-slate-700\">EJEMPLO</span>\r\n                                                            </div>\r\n                                                        )}\r\n\r\n                                                        {/* Gradient Flash on Hover */}\r\n                                                        <div className=\"absolute inset-0 bg-gradient-to-tr from-transparent via-transparent to-indigo-500/5 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none\" />\r\n\r\n                                                        {/* Admin Controls */}\r\n                                                        <div className=\"absolute top-2 right-2 flex gap-1 z-10 opacity-0 group-hover:opacity-100 transition-opacity\">\r\n                                                            <button\r\n                                                                onClick={(e) => togglePin(file, e)}\r\n                                                                title={file.isPinned ? \"Desfijar\" : \"Fijar\"}\r\n                                                                className={`p-1.5 rounded-lg backdrop-blur-sm ${file.isPinned ? 'text-amber-400 bg-amber-400/10' : 'text-slate-400 hover:text-amber-400 hover:bg-slate-100 dark:hover:bg-slate-800'}`}\r\n                                                            >\r\n                                                                <Pin size={14} className={file.isPinned ? 'fill-current' : ''} />\r\n                                                            </button>\r\n                                                            {!file.isMock && (\r\n                                                                <button\r\n                                                                    onClick={(e) => { e.stopPropagation(); handleDelete(file); }}\r\n                                                                    title=\"Eliminar recurso\"\r\n                                                                    className=\"p-1.5 rounded-lg text-slate-400 hover:text-rose-500 hover:bg-rose-50 dark:hover:bg-rose-900/20 backdrop-blur-sm\"\r\n                                                                >\r\n                                                                    <Trash2 size={14} />\r\n                                                                </button>\r\n                                                            )}\r\n                                                        </div>\r\n\r\n                                                        <div className=\"w-20 h-20 mb-4 flex items-center justify-center transform group-hover:scale-110 transition-transform duration-300 mt-2\">\r\n                                                            <div className=\"absolute inset-0 bg-indigo-50/50 dark:bg-indigo-900/20 rounded-full blur-xl opacity-0 group-hover:opacity-100 transition-opacity\" />\r\n                                                            {getFileIcon(file.type)}\r\n                                                        </div>\r\n\r\n                                                        <h4 className=\"text-sm font-bold text-slate-700 dark:text-slate-200 leading-tight mb-2 line-clamp-2 px-2 group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors\">\r\n                                                            {file.title || file.name}\r\n                                                        </h4>\r\n\r\n                                                        <span className=\"text-[10px] font-mono text-slate-400 mb-4\">{formatBytes(file.size)}</span>\r\n\r\n                                                        <div className=\"mt-auto pt-4 w-full border-t border-slate-50 dark:border-slate-800 flex items-center justify-between opacity-0 group-hover:opacity-100 transition-opacity translate-y-2 group-hover:translate-y-0 duration-300\">\r\n                                                            <span className=\"text-[10px] font-bold text-indigo-500 uppercase tracking-wider\">Visualizar</span>\r\n                                                            <Eye className=\"w-4 h-4 text-indigo-500\" />\r\n                                                        </div>\r\n                                                    </div>\r\n                                                ))}\r\n                                            </div>\r\n                                        ) : (\r\n                                            <div className=\"bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl overflow-hidden shadow-sm\">\r\n                                                <table className=\"w-full text-left\">\r\n                                                    <thead className=\"bg-slate-50 dark:bg-slate-950 text-xs uppercase font-bold text-slate-500 tracking-wider\">\r\n                                                        <tr>\r\n                                                            <th className=\"p-4 pl-6\">Documento</th>\r\n                                                            <th className=\"p-4\">Tama√±o</th>\r\n                                                            <th className=\"p-4\">Fecha</th>\r\n                                                            <th className=\"p-4 text-right pr-6\">Acciones</th>\r\n                                                        </tr>\r\n                                                    </thead>\r\n                                                    <tbody className=\"divide-y divide-slate-100 dark:divide-slate-800 text-sm\">\r\n                                                        {filteredResources.map(file => (\r\n                                                            <tr key={file.id} className=\"hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors group cursor-pointer\" onClick={() => setPreviewFile(file)}>\r\n                                                                <td className=\"p-4 pl-6 font-medium text-slate-900 dark:text-white flex items-center gap-3\">\r\n                                                                    <div className=\"transform scale-75\">{getFileIcon(file.type)}</div>\r\n                                                                    <div>\r\n                                                                        {file.title || file.name}\r\n                                                                        {file.isMock && <span className=\"ml-2 text-[9px] bg-slate-100 px-1 rounded text-slate-400\">EJEMPLO</span>}\r\n                                                                    </div>\r\n                                                                </td>\r\n                                                                <td className=\"p-4 text-slate-500 font-mono text-xs\">{formatBytes(file.size)}</td>\r\n                                                                <td className=\"p-4 text-slate-500\">{new Date().toLocaleDateString()}</td>\r\n                                                                <td className=\"p-4 text-right pr-6\">\r\n                                                                    <div className=\"flex justify-end gap-2\">\r\n                                                                        <button onClick={(e) => { e.stopPropagation(); /* Download logic */ }} title=\"Descargar\" className=\"p-1.5 text-slate-400 hover:text-indigo-600 rounded-lg hover:bg-slate-100\">\r\n                                                                            <Download className=\"w-4 h-4\" />\r\n                                                                        </button>\r\n                                                                        {!file.isMock && (\r\n                                                                            <button onClick={(e) => { e.stopPropagation(); handleDelete(file); }} title=\"Eliminar\" className=\"p-1.5 text-slate-400 hover:text-rose-600 rounded-lg hover:bg-rose-50\">\r\n                                                                                <Trash2 className=\"w-4 h-4\" />\r\n                                                                            </button>\r\n                                                                        )}\r\n                                                                    </div>\r\n                                                                </td>\r\n                                                            </tr>\r\n                                                        ))}\r\n                                                    </tbody>\r\n                                                </table>\r\n                                            </div>\r\n                                        )}\r\n                                    </>\r\n                                )}\r\n                            </div>\r\n                        </main>\r\n                    </>\r\n                ) : activeTab === 'guides' ? (\r\n                    <div className=\"flex-1 overflow-hidden bg-slate-50 dark:bg-slate-950\">\r\n                        <AdminGuidesPanel />\r\n                    </div>\r\n                ) : activeTab === 'requests' ? (\r\n                    <div className=\"flex-1 overflow-hidden bg-slate-50 dark:bg-slate-950\">\r\n                        <RequestsInbox />\r\n                    </div>\r\n                ) : activeTab === 'services' ? (\r\n                    <div className=\"flex-1 overflow-hidden bg-slate-50 dark:bg-slate-950\">\r\n                        <ServiceManager />\r\n                    </div>\r\n                ) : (\r\n                    <div className=\"flex-1 overflow-hidden p-6 bg-slate-50 dark:bg-slate-950\">\r\n                        <UserManual role=\"admin\" />\r\n                    </div>\r\n                )}\r\n            </div>\r\n\r\n            {/* MODALS */}\r\n            <ResourceUploadModal\r\n                isOpen={isUploadModalOpen}\r\n                onClose={() => setIsUploadModalOpen(false)}\r\n                onSuccess={() => { /* Reload trigger? */ }}\r\n            />\r\n\r\n            <DocPreviewModal\r\n                isOpen={!!previewFile}\r\n                onClose={() => setPreviewFile(null)}\r\n                file={previewFile ? { ...previewFile, name: previewFile.title || previewFile.name || '', url: previewFile.url || '' } : null}\r\n            />\r\n\r\n            <ConfirmationModal\r\n                isOpen={confirmDialog.isOpen}\r\n                onClose={() => setConfirmDialog(prev => ({ ...prev, isOpen: false }))}\r\n                onConfirm={confirmDialog.onConfirm!}\r\n                title={confirmDialog.title}\r\n                message={confirmDialog.message}\r\n                isDestructive={confirmDialog.isDestructive}\r\n                confirmText={confirmDialog.confirmText}\r\n            />\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default AdminResourcesPanel;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\AdminSimulationEditor.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\AdminSupportPanel.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":46,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":46,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1949,1952],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1949,1952],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, lazy, Suspense } from 'react';\r\nimport { MessageSquare, BarChart3, Download, Loader2 } from 'lucide-react';\r\nimport { SupportProvider } from '../../context/SupportContext';\r\nimport { useSupport } from '../../hooks/useSupport';\r\n\r\n// Sub-components\r\n// These might still be JSX, let's assume they are fine for now or will be migrated later.\r\n// We are importing from './support/...' \r\nimport SupportMetrics from './support/SupportMetrics';\r\nimport TicketList from './support/TicketList';\r\n\r\n// Lazy load TicketDetail to remove React Quill from main bundle\r\nconst TicketDetail = lazy(() => import('./support/TicketDetail'));\r\n\r\ntype ViewMode = 'cards' | 'analytics';\r\n\r\nconst AdminSupportContent = () => {\r\n    // access useSupport hook safely\r\n    const {\r\n        loading,\r\n        tickets,\r\n        exportToCSV,\r\n        handleClearAllTickets\r\n    } = useSupport();\r\n\r\n    const [viewMode, setViewMode] = useState<ViewMode>('cards');\r\n    const [isClearing, setIsClearing] = useState(false);\r\n\r\n    if (loading && tickets.length === 0) {\r\n        return (\r\n            <div className=\"h-screen flex items-center justify-center bg-white dark:bg-slate-950 transition-colors\">\r\n                <div className=\"flex flex-col items-center animate-pulse\">\r\n                    <Loader2 className=\"w-10 h-10 text-indigo-500 animate-spin mb-4\" />\r\n                    <p className=\"text-slate-500 dark:text-slate-400 font-semibold text-lg\">Cargando Centro de Soporte...</p>\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    const handleClear = async () => {\r\n        if (window.confirm('¬øEst√°s seguro de que deseas reiniciar el Centro de Soporte? Se eliminar√°n TODOS los tickets y mensajes de forma permanente.')) {\r\n            setIsClearing(true);\r\n            try {\r\n                await handleClearAllTickets();\r\n                alert('Centro de soporte reiniciado correctamente.');\r\n            } catch (error: any) {\r\n                alert(error.message);\r\n            } finally {\r\n                setIsClearing(false);\r\n            }\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"p-8 min-h-screen bg-slate-50 dark:bg-slate-950 font-sans text-slate-800 dark:text-slate-200 animate-in fade-in duration-500 transition-colors\">\r\n            {/* TOP BAR */}\r\n            <div className=\"flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8\">\r\n                <div className=\"flex items-center space-x-3\">\r\n                    <div className=\"w-12 h-12 bg-white dark:bg-slate-900 rounded-2xl flex items-center justify-center shadow-sm border border-slate-100 dark:border-slate-800 transition-colors\">\r\n                        <MessageSquare className=\"w-6 h-6 text-indigo-600 dark:text-indigo-400\" />\r\n                    </div>\r\n                    <div>\r\n                        <h1 className=\"text-2xl font-semibold text-slate-900 dark:text-white tracking-tight\">Support HQ</h1>\r\n                        <p className=\"text-slate-500 dark:text-slate-400 text-sm font-medium flex items-center gap-2\">\r\n                            <span className=\"bg-indigo-50 dark:bg-indigo-500/10 text-indigo-700 dark:text-indigo-400 px-1.5 py-0.5 rounded text-[10px] font-bold transition-colors\">‚åòK</span> Buscar\r\n                            <span className=\"text-slate-300 dark:text-slate-700\">‚Ä¢</span>\r\n                            Gesti√≥n Centralizada\r\n                        </p>\r\n                    </div>\r\n                </div>\r\n                <div className=\"flex items-center gap-3\">\r\n                    <button\r\n                        onClick={handleClear}\r\n                        disabled={isClearing}\r\n                        className=\"flex items-center space-x-2 px-4 py-2.5 bg-rose-50 dark:bg-rose-500/10 border border-rose-100 dark:border-rose-500/20 text-rose-600 dark:text-rose-400 rounded-xl font-semibold text-xs uppercase tracking-wider hover:bg-rose-100 dark:hover:bg-rose-500/20 transition-all active:scale-95 disabled:opacity-50\"\r\n                    >\r\n                        {isClearing ? <Loader2 size={14} className=\"animate-spin\" /> : <BarChart3 size={14} className=\"rotate-180\" />}\r\n                        <span>Reiniciar Centro</span>\r\n                    </button>\r\n                    <button\r\n                        onClick={() => setViewMode(v => v === 'cards' ? 'analytics' : 'cards')}\r\n                        className={`flex items-center space-x-2 px-4 py-2.5 rounded-xl font-semibold text-sm transition-all border ${viewMode === 'analytics'\r\n                            ? 'bg-indigo-50 dark:bg-indigo-500/10 border-indigo-200 dark:border-indigo-500/30 text-indigo-700 dark:text-indigo-400'\r\n                            : 'bg-white dark:bg-slate-900 border-slate-200 dark:border-slate-800 text-slate-600 dark:text-slate-400 hover:border-slate-300 dark:hover:border-slate-700'\r\n                            }`}\r\n                    >\r\n                        <BarChart3 className=\"w-4 h-4\" />\r\n                        <span>{viewMode === 'cards' ? 'Analytics' : 'Tickets'}</span>\r\n                    </button>\r\n                    <button\r\n                        onClick={exportToCSV}\r\n                        className=\"flex items-center space-x-2 px-4 py-2.5 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 text-slate-600 dark:text-slate-400 rounded-xl font-semibold text-sm hover:bg-slate-50 dark:hover:bg-slate-800 transition-all hover:text-slate-900 dark:hover:text-white\"\r\n                    >\r\n                        <Download className=\"w-4 h-4\" />\r\n                        <span>CSV</span>\r\n                    </button>\r\n                </div>\r\n            </div>\r\n\r\n            {/* METRICS / ANALYTICS */}\r\n            <SupportMetrics viewMode={viewMode} />\r\n\r\n            {/* MAIN CONTENT */}\r\n            {viewMode === 'cards' && (\r\n                <div className=\"grid grid-cols-1 lg:grid-cols-12 gap-6 h-[calc(100vh-280px)] min-h-[600px]\">\r\n                    {/* LEFT: LIST */}\r\n                    <div className=\"lg:col-span-4 h-full\">\r\n                        <TicketList />\r\n                    </div>\r\n\r\n                    {/* RIGHT: DETAIL */}\r\n                    <Suspense fallback={\r\n                        <div className=\"lg:col-span-8 bg-white dark:bg-slate-900 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-800 overflow-hidden flex items-center justify-center h-full transition-colors\">\r\n                            <Loader2 className=\"w-8 h-8 text-indigo-500 animate-spin\" />\r\n                        </div>\r\n                    }>\r\n                        <div className=\"lg:col-span-8 h-full\">\r\n                            <TicketDetail />\r\n                        </div>\r\n                    </Suspense>\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n};\r\n\r\nconst AdminSupportPanel = () => {\r\n    return (\r\n        <SupportProvider>\r\n            <AdminSupportContent />\r\n        </SupportProvider>\r\n    );\r\n};\r\n\r\nexport default AdminSupportPanel;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\AnnouncementSystem.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":15,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":15,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[582,585],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[582,585],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":130,"column":109,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":130,"endColumn":112,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5287,5290],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5287,5290],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":142,"column":105,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":142,"endColumn":108,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6115,6118],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6115,6118],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":258,"column":64,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":258,"endColumn":67,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13713,13716],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13713,13716],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\r\nimport { useAdminAnnouncements } from '../../hooks/useAdminAnnouncements';\r\nimport { db } from '../../lib/firebase';\r\nimport { collection, getDocs } from 'firebase/firestore';\r\nimport { Plus, Trash2, Megaphone, AlertTriangle, Info, X, Users, Eye } from 'lucide-react';\r\nimport { Card } from '../../ui/primitives/Card';\r\nimport Button from '../../ui/inputs/Button';\r\n\r\n// Interface for Franchise from Firestore\r\ninterface FranchiseUser {\r\n    id: string;\r\n    franchiseId?: string;\r\n    email: string;\r\n    role: string;\r\n    [key: string]: any;\r\n}\r\n\r\n// Interface for New Post State\r\ninterface NewPostState {\r\n    title: string;\r\n    content: string;\r\n    priority: 'normal' | 'high' | 'critical';\r\n    type: 'news' | 'alert' | 'poll';\r\n    targetAudience: 'all' | 'specific';\r\n    targetFranchises: string[];\r\n}\r\n\r\nconst AnnouncementSystem = () => {\r\n    // Assuming useAdminAnnouncements is properly typed, if not we infer types\r\n    const { announcements, loading, createAnnouncement, deleteAnnouncement } = useAdminAnnouncements();\r\n    const [isCreating, setIsCreating] = useState(false);\r\n\r\n    const [newPost, setNewPost] = useState<NewPostState>({\r\n        title: '',\r\n        content: '',\r\n        priority: 'normal',\r\n        type: 'news',\r\n        targetAudience: 'all', // 'all' or 'specific'\r\n        targetFranchises: []\r\n    });\r\n\r\n    // Franchise logic\r\n    const [franchises, setFranchises] = useState<FranchiseUser[]>([]);\r\n\r\n    // Load Franchise List on mount\r\n    React.useEffect(() => {\r\n        const loadFranchises = async () => {\r\n            try {\r\n                const snap = await getDocs(collection(db, \"users_config\"));\r\n                const list = snap.docs\r\n                    .map(d => ({ id: d.id, ...d.data() } as FranchiseUser))\r\n                    .filter(u => u.role === 'franchise');\r\n                setFranchises(list);\r\n            } catch (e) {\r\n                console.error(\"Error loading franchises\", e);\r\n            }\r\n        };\r\n        loadFranchises();\r\n    }, []);\r\n\r\n    const handleSubmit = async (e: React.FormEvent) => {\r\n        e.preventDefault();\r\n        if (!newPost.title || !newPost.content) return;\r\n\r\n        await createAnnouncement(\r\n            newPost.title,\r\n            newPost.content,\r\n            newPost.type,\r\n            newPost.priority,\r\n            newPost.targetAudience,\r\n            newPost.targetFranchises\r\n        );\r\n\r\n        setNewPost({\r\n            title: '',\r\n            content: '',\r\n            priority: 'normal',\r\n            type: 'news',\r\n            targetAudience: 'all',\r\n            targetFranchises: []\r\n        });\r\n        setIsCreating(false);\r\n    };\r\n\r\n    const toggleFranchiseSelection = (franchiseId: string) => {\r\n        setNewPost(prev => {\r\n            const current = prev.targetFranchises;\r\n            const newSelection = current.includes(franchiseId)\r\n                ? current.filter(id => id !== franchiseId)\r\n                : [...current, franchiseId];\r\n            return { ...prev, targetFranchises: newSelection };\r\n        });\r\n    };\r\n\r\n    if (loading) return <div className=\"p-4 text-center\">Cargando sistema de anuncios...</div>;\r\n\r\n    return (\r\n        <div className=\"space-y-6\">\r\n            <div className=\"flex justify-between items-center\">\r\n                <h2 className=\"text-2xl font-bold text-slate-800 flex items-center\">\r\n                    <Megaphone className=\"w-6 h-6 mr-3 text-blue-600\" />\r\n                    Centro de Comunicaci√≥n HQ\r\n                </h2>\r\n                <Button onClick={() => setIsCreating(!isCreating)} icon={isCreating ? X : Plus} variant={isCreating ? 'secondary' : 'primary'}>\r\n                    {isCreating ? 'Cancelar' : 'Nuevo Anuncio'}\r\n                </Button>\r\n            </div>\r\n\r\n            {/* CREATION FORM */}\r\n            {isCreating && (\r\n                <Card className=\"animate-fade-in-down border-blue-200 shadow-lg\">\r\n                    <form onSubmit={handleSubmit} className=\"space-y-4\">\r\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                            <div>\r\n                                <label className=\"block text-sm font-bold text-slate-700 mb-1\">T√≠tulo</label>\r\n                                <input\r\n                                    type=\"text\"\r\n                                    value={newPost.title}\r\n                                    onChange={e => setNewPost({ ...newPost, title: e.target.value })}\r\n                                    className=\"w-full rounded-lg border-slate-300 focus:ring-blue-500 focus:border-blue-500\"\r\n                                    placeholder=\"Ej: Cambio de Tarifas 2024\"\r\n                                    required\r\n                                />\r\n                            </div>\r\n                            <div className=\"grid grid-cols-2 gap-4\">\r\n                                <div>\r\n                                    <label className=\"block text-sm font-bold text-slate-700 mb-1\">Prioridad</label>\r\n                                    <select\r\n                                        value={newPost.priority}\r\n                                        onChange={e => setNewPost({ ...newPost, priority: e.target.value as any })}\r\n                                        className=\"w-full rounded-lg border-slate-300\"\r\n                                    >\r\n                                        <option value=\"normal\">Normal</option>\r\n                                        <option value=\"high\">Alta</option>\r\n                                        <option value=\"critical\">Cr√≠tica üö®</option>\r\n                                    </select>\r\n                                </div>\r\n                                <div>\r\n                                    <label className=\"block text-sm font-bold text-slate-700 mb-1\">Tipo</label>\r\n                                    <select\r\n                                        value={newPost.type}\r\n                                        onChange={e => setNewPost({ ...newPost, type: e.target.value as any })}\r\n                                        className=\"w-full rounded-lg border-slate-300\"\r\n                                    >\r\n                                        <option value=\"news\">Noticia</option>\r\n                                        <option value=\"alert\">Alerta</option>\r\n                                        <option value=\"poll\">Encuesta</option>\r\n                                    </select>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Audience Selector */}\r\n                        <div className=\"bg-slate-50 p-3 rounded-lg border border-slate-200\">\r\n                            <label className=\"block text-sm font-bold text-slate-700 mb-2\">Audiencia</label>\r\n                            <div className=\"flex gap-4 mb-3\">\r\n                                <label className=\"flex items-center gap-2 cursor-pointer\">\r\n                                    <input\r\n                                        type=\"radio\"\r\n                                        name=\"audience\"\r\n                                        value=\"all\"\r\n                                        checked={newPost.targetAudience === 'all'}\r\n                                        onChange={() => setNewPost({ ...newPost, targetAudience: 'all' })}\r\n                                    />\r\n                                    <span className=\"text-sm\">Toda la Red ({franchises.length})</span>\r\n                                </label>\r\n                                <label className=\"flex items-center gap-2 cursor-pointer\">\r\n                                    <input\r\n                                        type=\"radio\"\r\n                                        name=\"audience\"\r\n                                        value=\"specific\"\r\n                                        checked={newPost.targetAudience === 'specific'}\r\n                                        onChange={() => setNewPost({ ...newPost, targetAudience: 'specific' })}\r\n                                    />\r\n                                    <span className=\"text-sm\">Seleccionar Franquicias</span>\r\n                                </label>\r\n                            </div>\r\n\r\n                            {newPost.targetAudience === 'specific' && (\r\n                                <div className=\"max-h-40 overflow-y-auto grid grid-cols-2 md:grid-cols-3 gap-2 p-2 bg-white rounded border border-slate-200\">\r\n                                    {franchises.map(f => {\r\n                                        const fid = f.franchiseId || f.id;\r\n                                        return (\r\n                                            <label key={f.id} className=\"flex items-center gap-2 text-xs p-1 hover:bg-slate-50 rounded cursor-pointer\">\r\n                                                <input\r\n                                                    type=\"checkbox\"\r\n                                                    checked={newPost.targetFranchises.includes(fid)}\r\n                                                    onChange={() => toggleFranchiseSelection(fid)}\r\n                                                />\r\n                                                <span className=\"truncate\" title={fid || f.email}>\r\n                                                    {(fid || f.email).toUpperCase()}\r\n                                                </span>\r\n                                            </label>\r\n                                        );\r\n                                    })}\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n\r\n                        <div>\r\n                            <label className=\"block text-sm font-bold text-slate-700 mb-1\">Contenido</label>\r\n                            <textarea\r\n                                value={newPost.content}\r\n                                onChange={e => setNewPost({ ...newPost, content: e.target.value })}\r\n                                className=\"w-full rounded-lg border-slate-300 h-32 focus:ring-blue-500 focus:border-blue-500\"\r\n                                placeholder=\"Escribe el contenido del comunicado...\"\r\n                                required\r\n                            />\r\n                        </div>\r\n                        <div className=\"flex justify-end pt-2\">\r\n                            <Button type=\"submit\" variant=\"primary\">Publicar Comunicado</Button>\r\n                        </div>\r\n                    </form>\r\n                </Card>\r\n            )}\r\n\r\n            {/* LIST */}\r\n            <div className=\"grid gap-4\">\r\n                {announcements.map(item => (\r\n                    <Card key={item.id} className=\"relative group hover:shadow-md transition-shadow\">\r\n                        <button\r\n                            onClick={() => deleteAnnouncement(item.id)}\r\n                            className=\"absolute top-4 right-4 text-slate-300 hover:text-rose-500 transition-colors opacity-0 group-hover:opacity-100 p-1\"\r\n                            title=\"Eliminar anuncio\"\r\n                        >\r\n                            <Trash2 className=\"w-5 h-5\" />\r\n                        </button>\r\n\r\n                        <div className=\"flex items-start\">\r\n                            <div className={`\r\n                                w-10 h-10 rounded-full flex items-center justify-center shrink-0 mr-4\r\n                                ${item.priority === 'critical' ? 'bg-rose-100 text-rose-600' :\r\n                                    item.priority === 'high' ? 'bg-amber-100 text-amber-600' :\r\n                                        'bg-blue-100 text-blue-600'}\r\n                             `}>\r\n                                {item.priority === 'critical' ? <AlertTriangle className=\"w-6 h-6\" /> :\r\n                                    item.type === 'alert' ? <AlertTriangle className=\"w-6 h-6\" /> :\r\n                                        <Info className=\"w-6 h-6\" />}\r\n                            </div>\r\n                            <div className=\"flex-1\">\r\n                                <div className=\"flex items-center gap-2 mb-1 flex-wrap\">\r\n                                    <h3 className=\"font-bold text-lg text-slate-800\">{item.title}</h3>\r\n                                    {item.priority === 'critical' && <span className=\"bg-rose-100 text-rose-700 text-xs font-bold px-2 py-0.5 rounded-full uppercase\">Cr√≠tico</span>}\r\n\r\n                                    {/* Audience Badge */}\r\n                                    {item.targetAudience === 'specific' ? (\r\n                                        <span className=\"bg-purple-100 text-purple-700 text-xs font-bold px-2 py-0.5 rounded-full flex items-center gap-1\">\r\n                                            <Users className=\"w-3 h-3\" />\r\n                                            Segmentado ({item.targetFranchises?.length || 0})\r\n                                        </span>\r\n                                    ) : (\r\n                                        <span className=\"bg-slate-100 text-slate-600 text-xs font-bold px-2 py-0.5 rounded-full\">Global</span>\r\n                                    )}\r\n\r\n                                    <span className=\"text-xs text-slate-400 ml-auto\">\r\n                                        {item.createdAt instanceof Date ? item.createdAt.toLocaleDateString() :\r\n                                            // Handle Firestore Timestamp\r\n                                            (item.createdAt as any)?.toDate?.().toLocaleDateString() || 'Reciente'\r\n                                        }\r\n                                    </span>\r\n                                </div>\r\n                                <p className=\"text-slate-600 whitespace-pre-wrap text-sm leading-relaxed mb-3\">{item.content}</p>\r\n\r\n                                {/* Read Stats */}\r\n                                <div className=\"flex items-center gap-2 text-xs text-slate-400 bg-slate-50 px-2 py-1 rounded w-fit\">\r\n                                    <Eye className=\"w-3 h-3\" />\r\n                                    <span>Visto por {item.reads?.length || 0} usuarios</span>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </Card>\r\n                ))}\r\n                {announcements.length === 0 && (\r\n                    <div className=\"text-center py-12 text-slate-400 border-2 border-dashed border-slate-200 rounded-xl\">\r\n                        <Megaphone className=\"w-12 h-12 mx-auto mb-4 opacity-50\" />\r\n                        <p>No hay comunicados publicados.</p>\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default AnnouncementSystem;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\AuditPanel.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":14,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":14,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[541,544],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[541,544],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":15,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":15,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[566,569],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[566,569],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react';\r\nimport { db } from '../../lib/firebase';\r\nimport { collection, query, orderBy, limit, onSnapshot, Timestamp } from 'firebase/firestore';\r\nimport { ShieldAlert, RefreshCcw, User, Database, Ghost } from 'lucide-react';\r\nimport { migrationService } from '../../services/migrationService';\r\nimport EmptyState from '../../ui/feedback/EmptyState';\r\n\r\ninterface AuditLog {\r\n    id: string;\r\n    timestamp?: Timestamp;\r\n    actorEmail?: string;\r\n    actorId: string;\r\n    action: string;\r\n    details?: any;\r\n    [key: string]: any;\r\n}\r\n\r\nconst AuditPanel = () => {\r\n    const [logs, setLogs] = useState<AuditLog[]>([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const [isMigrating, setIsMigrating] = useState(false);\r\n    const [isCleaning, setIsCleaning] = useState(false);\r\n\r\n    const handleMigration = async () => {\r\n        if (!confirm(\"‚ö†Ô∏è ¬øEst√°s seguro de migrar las colecciones?\\nEsto mover√°:\\n- financial_data -> financial_records\\n- academy_modules -> academy_courses\")) return;\r\n\r\n        setIsMigrating(true);\r\n        const result = await migrationService.migrateCollections();\r\n        setIsMigrating(false);\r\n\r\n        if (result.success) {\r\n            alert(`Migraci√≥n completada.\\nDocumentos procesados: ${result.count}`);\r\n        } else {\r\n            alert(\"Error en la migraci√≥n. Revisa la consola.\");\r\n        }\r\n    };\r\n\r\n    const handleCleanGhosts = async () => {\r\n        if (!confirm(\"üëª ¬øEliminar turnos de usuarios borrados?\\nEsto eliminar√° permanentemente los turnos asignados a riders que ya no existen en la base de datos.\")) return;\r\n\r\n        setIsCleaning(true);\r\n        const result = await migrationService.cleanOrphanedShifts();\r\n        setIsCleaning(false);\r\n\r\n        if (result.success) {\r\n            alert(`Limpieza completada.\\nTurnos fantasmas eliminados: ${result.count}`);\r\n        } else {\r\n            alert(\"Error en la limpieza. Revisa la consola.\");\r\n        }\r\n    };\r\n\r\n    useEffect(() => {\r\n        // Query recent 100 logs\r\n        const q = query(collection(db, \"audit_logs\"), orderBy(\"timestamp\", \"desc\"), limit(100));\r\n        const unsubscribe = onSnapshot(q, (snapshot) => {\r\n            const fetchedLogs = snapshot.docs.map(doc => ({\r\n                id: doc.id,\r\n                ...doc.data()\r\n            } as AuditLog));\r\n            setLogs(fetchedLogs);\r\n            setLoading(false);\r\n        }, (error) => {\r\n            console.warn(\"Error fetching audit logs:\", error);\r\n            setLoading(false);\r\n        });\r\n        return () => unsubscribe();\r\n    }, []);\r\n\r\n    const formatTime = (ts?: Timestamp) => {\r\n        if (!ts) return \"Reciente...\";\r\n        return ts.toDate ? ts.toDate().toLocaleString() : new Date().toLocaleString();\r\n    };\r\n\r\n    const getActionColor = (action: string) => {\r\n        if (action.includes('LOGIN')) return 'text-emerald-600 bg-emerald-50';\r\n        if (action.includes('REVOKE') || action.includes('DELETE')) return 'text-rose-600 bg-rose-50';\r\n        if (action.includes('APPROVED')) return 'text-indigo-600 bg-indigo-50';\r\n        if (action.includes('TICKET')) return 'text-blue-600 bg-blue-50';\r\n        return 'text-slate-600 bg-slate-50';\r\n    };\r\n\r\n    if (loading) return <div className=\"p-8 text-center text-slate-400\">Cargando auditor√≠a...</div>;\r\n\r\n    return (\r\n        <div className=\"p-8 max-w-6xl mx-auto animate-fade-in-up\">\r\n            <div className=\"flex items-center justify-between mb-8\">\r\n                <div>\r\n                    <h2 className=\"text-2xl font-black text-slate-800 flex items-center\">\r\n                        <ShieldAlert className=\"w-8 h-8 mr-3 text-slate-700\" /> Registro de Auditor√≠a\r\n                    </h2>\r\n                    <p className=\"text-slate-500 mt-1\">Historial inmutable de acciones cr√≠ticas (√öltimos 100 eventos).</p>\r\n                </div>\r\n                <div className=\"flex items-center gap-3\">\r\n                    <button\r\n                        onClick={handleMigration}\r\n                        disabled={isMigrating}\r\n                        className=\"px-4 py-2 bg-indigo-600 text-white rounded-lg font-bold text-xs hover:bg-indigo-700 transition-colors flex items-center gap-2 disabled:opacity-50\"\r\n                    >\r\n                        <Database className={`w-3.5 h-3.5 ${isMigrating ? 'animate-bounce' : ''}`} />\r\n                        {isMigrating ? 'Migrando...' : 'Migrar BD'}\r\n                    </button>\r\n                    <button\r\n                        onClick={handleCleanGhosts}\r\n                        disabled={isCleaning}\r\n                        className=\"px-4 py-2 bg-rose-600 text-white rounded-lg font-bold text-xs hover:bg-rose-700 transition-colors flex items-center gap-2 disabled:opacity-50\"\r\n                        title=\"Eliminar turnos de usuarios borrados\"\r\n                    >\r\n                        <Ghost className={`w-3.5 h-3.5 ${isCleaning ? 'animate-pulse' : ''}`} />\r\n                        {isCleaning ? 'Limpiando...' : 'Borrar Fantasmas'}\r\n                    </button>\r\n                    <div className=\"bg-slate-100 px-3 py-1 rounded-full flex items-center text-xs font-bold text-slate-500\">\r\n                        <RefreshCcw className=\"w-3 h-3 mr-2 animate-spin-slow\" /> En vivo\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            <div className=\"bg-white rounded-2xl shadow-lg border border-slate-100 overflow-hidden\">\r\n                <div className=\"overflow-x-auto\">\r\n                    <table className=\"w-full text-left border-collapse\">\r\n                        <thead>\r\n                            <tr className=\"bg-slate-50/50 border-b border-slate-100 text-xs text-slate-500 uppercase tracking-wider\">\r\n                                <th className=\"px-6 py-4 font-bold\">Fecha / Hora</th>\r\n                                <th className=\"px-6 py-4 font-bold\">Actor (Usuario)</th>\r\n                                <th className=\"px-6 py-4 font-bold\">Acci√≥n</th>\r\n                                <th className=\"px-6 py-4 font-bold\">Detalles (JSON)</th>\r\n                            </tr>\r\n                        </thead>\r\n                        <tbody className=\"divide-y divide-slate-50\">\r\n                            {logs.map(log => (\r\n                                <tr key={log.id} className=\"hover:bg-slate-50/50 transition-colors\">\r\n                                    <td className=\"px-6 py-3 text-sm font-bold text-slate-500 whitespace-nowrap uppercase tracking-wider\">\r\n                                        {formatTime(log.timestamp)}\r\n                                    </td>\r\n                                    <td className=\"px-6 py-3\">\r\n                                        <div className=\"flex items-center\">\r\n                                            <div className=\"w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center mr-3 text-slate-400\">\r\n                                                <User className=\"w-4 h-4\" />\r\n                                            </div>\r\n                                            <div>\r\n                                                <p className=\"text-sm font-bold text-slate-800\">{log.actorEmail}</p>\r\n                                                <p className=\"text-[10px] text-slate-400 font-bold uppercase tracking-[0.2em]\">UID: {(log.actorId || '').slice(0, 6)}...</p>\r\n                                            </div>\r\n                                        </div>\r\n                                    </td>\r\n                                    <td className=\"px-6 py-3\">\r\n                                        <span className={`px-2 py-1 rounded text-xs font-black uppercase ${getActionColor(log.action)}`}>\r\n                                            {log.action}\r\n                                        </span>\r\n                                    </td>\r\n                                    <td className=\"px-6 py-3\">\r\n                                        <code className=\"text-[10px] bg-slate-100 p-1.5 rounded text-slate-600 break-all block max-w-xs font-bold uppercase tracking-widest\">\r\n                                            {JSON.stringify(log.details || {})}\r\n                                        </code>\r\n                                    </td>\r\n                                </tr>\r\n                            ))}\r\n                            {logs.length === 0 && (\r\n                                <tr>\r\n                                    <td colSpan={4} className=\"p-8\">\r\n                                        <EmptyState\r\n                                            icon={ShieldAlert}\r\n                                            title=\"Sin registros\"\r\n                                            description=\"No hay eventos de auditor√≠a registrados todav√≠a.\"\r\n                                            className=\"bg-slate-50 border-0\"\r\n                                        />\r\n                                    </td>\r\n                                </tr>\r\n                            )}\r\n                        </tbody>\r\n                    </table>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default AuditPanel;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\CreateFranchiseModal.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'initialFormState'. Either include it or remove the dependency array.","line":52,"column":8,"nodeType":"ArrayExpression","endLine":52,"endColumn":16,"suggestions":[{"desc":"Update the dependencies array to be: [initialFormState, isOpen]","fix":{"range":[1667,1675],"text":"[initialFormState, isOpen]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { X, AlertCircle, Loader } from 'lucide-react';\r\nimport { userService } from '../../services/userService'; // Updated import to allow destructuring later or direct use\r\n\r\n// Define interfaces for form data\r\ninterface FranchiseSettings {\r\n    minOrderAmount: number;\r\n    shippingCost: number;\r\n    isActive: boolean;\r\n}\r\n\r\ninterface LocationData {\r\n    address: string;\r\n    city: string;\r\n    zipCodes: string[];\r\n}\r\n\r\ninterface FranchiseFormData {\r\n    name: string;\r\n    slug: string;\r\n    settings: FranchiseSettings;\r\n    location: LocationData;\r\n}\r\n\r\ninterface CreateFranchiseModalProps {\r\n    isOpen: boolean;\r\n    onClose: () => void;\r\n    onSuccess: () => void;\r\n}\r\n\r\nconst CreateFranchiseModal: React.FC<CreateFranchiseModalProps> = ({ isOpen, onClose, onSuccess }) => {\r\n    // Estado Inicial Limpio (Reset on Open)\r\n    const initialFormState: FranchiseFormData = {\r\n        name: '',\r\n        slug: '',\r\n        settings: { minOrderAmount: 0, shippingCost: 0, isActive: true },\r\n        location: { address: '', city: '', zipCodes: [] } // Array vac√≠o por defecto\r\n    };\r\n\r\n    const [formData, setFormData] = useState<FranchiseFormData>(initialFormState);\r\n    const [zipInput, setZipInput] = useState(''); // Estado temporal para el input de CP\r\n    const [isSubmitting, setIsSubmitting] = useState(false);\r\n    const [error, setError] = useState<string | null>(null);\r\n\r\n    // Resetear formulario cuando se abre el modal\r\n    useEffect(() => {\r\n        if (isOpen) {\r\n            setFormData(initialFormState);\r\n            setError(null);\r\n            setZipInput('');\r\n        }\r\n    }, [isOpen]);\r\n\r\n    if (!isOpen) return null;\r\n\r\n    // --- Handlers L√≥gicos ---\r\n\r\n    const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n        const { name, value } = e.target;\r\n\r\n        // Auto-generar slug si estamos editando el nombre\r\n        if (name === 'name') {\r\n            const autoSlug = value.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)+/g, '');\r\n            setFormData(prev => ({ ...prev, name: value, slug: autoSlug }));\r\n        } else {\r\n            setFormData(prev => ({ ...prev, [name]: value }));\r\n        }\r\n    };\r\n\r\n    const handleSettingChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n        const { name, value } = e.target;\r\n        setFormData(prev => ({\r\n            ...prev,\r\n            settings: { ...prev.settings, [name]: parseFloat(value) || 0 }\r\n        }));\r\n    };\r\n\r\n    // Gesti√≥n de Array de ZIPs (Add/Remove)\r\n    const handleAddZip = () => {\r\n        // Prevent default if it's a form submission event, though here it's button or keydown\r\n        // e.preventDefault(); \r\n\r\n        const trimmedZip = zipInput.trim();\r\n        if (trimmedZip && !formData.location.zipCodes.includes(trimmedZip)) {\r\n            setFormData(prev => ({\r\n                ...prev,\r\n                location: { ...prev.location, zipCodes: [...prev.location.zipCodes, trimmedZip] }\r\n            }));\r\n            setZipInput('');\r\n        }\r\n    };\r\n\r\n    const handleRemoveZip = (zipToRemove: string) => {\r\n        setFormData(prev => ({\r\n            ...prev,\r\n            location: {\r\n                ...prev.location,\r\n                zipCodes: prev.location.zipCodes.filter(zip => zip !== zipToRemove)\r\n            }\r\n        }));\r\n    };\r\n\r\n    const handleSubmit = async (e: React.FormEvent) => {\r\n        e.preventDefault();\r\n\r\n        // Validaci√≥n de Bloqueo\r\n        if (formData.location.zipCodes.length === 0) {\r\n            setError(\"Debes a√±adir al menos un C√≥digo Postal.\");\r\n            return;\r\n        }\r\n\r\n        setIsSubmitting(true);\r\n        setError(null);\r\n\r\n        try {\r\n            await userService.createFranchise(formData);\r\n            onSuccess(); // Notificar al padre para recargar datos\r\n            onClose();   // Cerrar modal\r\n        } catch {\r\n            setError(\"Error al crear la franquicia. Int√©ntalo de nuevo.\");\r\n        } finally {\r\n            setIsSubmitting(false);\r\n        }\r\n    };\r\n\r\n    // --- Render ---\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4\">\r\n            <div className=\"bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto\">\r\n\r\n                {/* Header */}\r\n                <div className=\"flex justify-between items-center p-6 border-b border-gray-100\">\r\n                    <h2 className=\"text-xl font-bold text-gray-800\">Nueva Franquicia</h2>\r\n                    <button onClick={onClose} className=\"p-2 hover:bg-gray-100 rounded-full transition-colors\" title=\"Cerrar modal\">\r\n                        <X size={20} className=\"text-gray-500\" />\r\n                    </button>\r\n                </div>\r\n\r\n                {/* Body */}\r\n                <form onSubmit={handleSubmit} className=\"p-6 space-y-6\">\r\n\r\n                    {/* Mensaje de Error */}\r\n                    {error && (\r\n                        <div className=\"bg-red-50 text-red-600 p-4 rounded-lg flex items-center gap-3\">\r\n                            <AlertCircle size={20} />\r\n                            <span className=\"text-sm font-medium\">{error}</span>\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* Secci√≥n 1: Identidad */}\r\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                        <div>\r\n                            <label className=\"block text-sm font-medium text-gray-700 mb-1\">Nombre Comercial *</label>\r\n                            <input\r\n                                name=\"name\"\r\n                                value={formData.name}\r\n                                onChange={handleInputChange}\r\n                                className=\"w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none\"\r\n                                placeholder=\"Ej: Madrid Centro\"\r\n                                required\r\n                            />\r\n                        </div>\r\n                        <div>\r\n                            <label className=\"block text-sm font-medium text-gray-700 mb-1\">Slug (URL) *</label>\r\n                            <input\r\n                                name=\"slug\"\r\n                                value={formData.slug}\r\n                                onChange={handleInputChange}\r\n                                className=\"w-full px-4 py-2 border rounded-lg bg-gray-50 text-gray-600 font-bold uppercase tracking-wider text-sm\"\r\n                                required\r\n                                aria-label=\"Slug (URL)\"\r\n                            />\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Secci√≥n 2: Log√≠stica y ZIPs */}\r\n                    <div className=\"space-y-3\">\r\n                        <label className=\"block text-sm font-medium text-gray-700\">C√≥digos Postales de Reparto *</label>\r\n                        <div className=\"flex gap-2\">\r\n                            <input\r\n                                value={zipInput}\r\n                                onChange={(e) => setZipInput(e.target.value)}\r\n                                onKeyDown={(e) => {\r\n                                    if (e.key === 'Enter') {\r\n                                        e.preventDefault();\r\n                                        handleAddZip();\r\n                                    }\r\n                                }}\r\n                                className=\"flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none\"\r\n                                placeholder=\"Escribe un CP y pulsa Enter\"\r\n                            />\r\n                            <button\r\n                                type=\"button\"\r\n                                onClick={handleAddZip}\r\n                                className=\"px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium\"\r\n                            >\r\n                                A√±adir\r\n                            </button>\r\n                        </div>\r\n\r\n                        {/* Lista de Chips de CP */}\r\n                        <div className=\"flex flex-wrap gap-2 mt-2 min-h-[40px] p-2 bg-gray-50 rounded-lg border border-dashed border-gray-300\">\r\n                            {formData.location.zipCodes.length === 0 && (\r\n                                <span className=\"text-gray-400 text-sm italic p-1\">Sin zonas asignadas...</span>\r\n                            )}\r\n                            {formData.location.zipCodes.map(zip => (\r\n                                <span key={zip} className=\"inline-flex items-center gap-1 px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-medium\">\r\n                                    {zip}\r\n                                    <button type=\"button\" onClick={() => handleRemoveZip(zip)} className=\"hover:text-blue-900\" title={`Eliminar CP ${zip}`}>\r\n                                        <X size={14} />\r\n                                    </button>\r\n                                </span>\r\n                            ))}\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Secci√≥n 3: Configuraci√≥n Econ√≥mica */}\r\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t border-gray-100\">\r\n                        <div>\r\n                            <label className=\"block text-sm font-medium text-gray-700 mb-1\">Pedido M√≠nimo (‚Ç¨)</label>\r\n                            <input\r\n                                type=\"number\"\r\n                                name=\"minOrderAmount\"\r\n                                value={formData.settings.minOrderAmount}\r\n                                onChange={handleSettingChange}\r\n                                className=\"w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none\"\r\n                                min=\"0\"\r\n                                step=\"0.01\"\r\n                                aria-label=\"Pedido M√≠nimo (‚Ç¨)\"\r\n                            />\r\n                        </div>\r\n                        <div>\r\n                            <label className=\"block text-sm font-medium text-gray-700 mb-1\">Costo Env√≠o Base (‚Ç¨)</label>\r\n                            <input\r\n                                type=\"number\"\r\n                                name=\"shippingCost\"\r\n                                value={formData.settings.shippingCost}\r\n                                onChange={handleSettingChange}\r\n                                className=\"w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none\"\r\n                                min=\"0\"\r\n                                step=\"0.01\"\r\n                                aria-label=\"Costo Env√≠o Base (‚Ç¨)\"\r\n                            />\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Footer Actions */}\r\n                    <div className=\"flex justify-end gap-3 pt-6\">\r\n                        <button\r\n                            type=\"button\"\r\n                            onClick={onClose}\r\n                            className=\"px-6 py-2 text-gray-600 font-medium hover:bg-gray-100 rounded-lg transition-colors\"\r\n                            disabled={isSubmitting}\r\n                        >\r\n                            Cancelar\r\n                        </button>\r\n                        <button\r\n                            type=\"submit\"\r\n                            disabled={isSubmitting}\r\n                            className=\"px-6 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2\"\r\n                        >\r\n                            {isSubmitting ? (\r\n                                <>\r\n                                    <Loader size={18} className=\"animate-spin\" /> Creando...\r\n                                </>\r\n                            ) : (\r\n                                'Crear Franquicia'\r\n                            )}\r\n                        </button>\r\n                    </div>\r\n                </form>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default CreateFranchiseModal;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\FranchiseOnboarding.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":31,"column":68,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":31,"endColumn":71,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1143,1146],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1143,1146],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState } from 'react';\r\nimport { CheckCircle, ChevronRight, Building, CreditCard, Shield, Save, ArrowLeft } from 'lucide-react';\r\nimport { db } from '../../lib/firebase';\r\nimport { doc, setDoc, serverTimestamp } from 'firebase/firestore';\r\nimport { Card } from '../../ui/primitives/Card';\r\nimport Button from '../../ui/inputs/Button';\r\n\r\n// Initial State\r\nconst INITIAL_DATA = {\r\n    name: '',\r\n    email: '',\r\n    city: '',\r\n    taxId: '',\r\n    adminName: '',\r\n    adminPassword: '', // In a real app, use Auth service. Here we simulate config.\r\n    tariffPlan: 'standard' as 'standard' | 'premium', // standard, premium\r\n    baseFee: 15\r\n};\r\n\r\ninterface FranchiseOnboardingProps {\r\n    onCancel: () => void;\r\n    onComplete: (name: string) => void;\r\n}\r\n\r\nconst FranchiseOnboarding: React.FC<FranchiseOnboardingProps> = ({ onCancel, onComplete }) => {\r\n    const [step, setStep] = useState(1);\r\n    const [data, setData] = useState(INITIAL_DATA);\r\n    const [loading, setLoading] = useState(false);\r\n    const [error, setError] = useState<string | null>(null);\r\n\r\n    const handleChange = (field: keyof typeof INITIAL_DATA, value: any) => {\r\n        setData(prev => ({ ...prev, [field]: value }));\r\n    };\r\n\r\n    const handleNext = () => setStep(prev => prev + 1);\r\n    const handleBack = () => setStep(prev => prev - 1);\r\n\r\n    const handleSubmit = async () => {\r\n        setLoading(true);\r\n        setError(null);\r\n        try {\r\n            // Generate a simplified ID\r\n            const franchiseId = data.email.split('@')[0].toLowerCase().replace(/[^a-z0-9]/g, '');\r\n\r\n            // 1. Create Franchise Config\r\n            await setDoc(doc(db, \"users_config\", franchiseId), {\r\n                name: data.name,\r\n                email: data.email,\r\n                role: 'franchise',\r\n                city: data.city,\r\n                taxId: data.taxId,\r\n                active: true,\r\n                createdAt: serverTimestamp(),\r\n                plan: data.tariffPlan,\r\n                ownerName: data.adminName,\r\n                // In production, never store passwords in plain text. \r\n                // This is a config simulation for the \"factory\" demo.\r\n                tempPassword: data.adminPassword\r\n            });\r\n\r\n            // 2. Initialize Financial Config (Optional - simulation)\r\n            // await setDoc(doc(db, \"financial_config\", franchiseId), { ... });\r\n\r\n            onComplete(data.name);\r\n        } catch (err) {\r\n            console.error(\"Error creating franchise:\", err);\r\n            setError(\"Error al crear la franquicia. Revisa la consola o intenta de nuevo.\");\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"max-w-4xl mx-auto space-y-6 animate-fade-in-up\">\r\n            {/* Header */}\r\n            <div className=\"flex items-center justify-between mb-8\">\r\n                <div>\r\n                    <h2 className=\"text-3xl font-bold text-slate-800\">Alta de Nueva Franquicia</h2>\r\n                    <p className=\"text-slate-500 mt-1\">Wizard de configuraci√≥n inicial para expansi√≥n de red.</p>\r\n                </div>\r\n                <div className=\"flex items-center space-x-2\">\r\n                    <span className={`h-2 w-16 rounded-full ${step >= 1 ? 'bg-blue-600' : 'bg-slate-200'}`} />\r\n                    <span className={`h-2 w-16 rounded-full ${step >= 2 ? 'bg-blue-600' : 'bg-slate-200'}`} />\r\n                    <span className={`h-2 w-16 rounded-full ${step >= 3 ? 'bg-blue-600' : 'bg-slate-200'}`} />\r\n                </div>\r\n            </div>\r\n\r\n            <Card className=\"p-8 min-h-[400px] relative shadow-lg border-blue-100\">\r\n                {step === 1 && (\r\n                    <div className=\"space-y-6 animate-fade-in\">\r\n                        <h3 className=\"text-xl font-bold flex items-center text-slate-700\">\r\n                            <span className=\"bg-blue-100 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm\">1</span>\r\n                            Identidad Operativa\r\n                        </h3>\r\n\r\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\r\n                            <div>\r\n                                <label className=\"block text-sm font-bold text-slate-700 mb-2\">Nombre Comercial</label>\r\n                                <input\r\n                                    type=\"text\"\r\n                                    className=\"w-full rounded-lg border-slate-300 focus:ring-blue-500\"\r\n                                    placeholder=\"Ej: Repaart Sevilla Este\"\r\n                                    value={data.name}\r\n                                    onChange={e => handleChange('name', e.target.value)}\r\n                                />\r\n                            </div>\r\n                            <div>\r\n                                <label className=\"block text-sm font-bold text-slate-700 mb-2\">Ciudad / Zona</label>\r\n                                <input\r\n                                    type=\"text\"\r\n                                    className=\"w-full rounded-lg border-slate-300 focus:ring-blue-500\"\r\n                                    placeholder=\"Ej: Sevilla\"\r\n                                    value={data.city}\r\n                                    onChange={e => handleChange('city', e.target.value)}\r\n                                />\r\n                            </div>\r\n                            <div>\r\n                                <label className=\"block text-sm font-bold text-slate-700 mb-2\">CIF / ID Fiscal</label>\r\n                                <input\r\n                                    type=\"text\"\r\n                                    className=\"w-full rounded-lg border-slate-300 focus:ring-blue-500\"\r\n                                    placeholder=\"B-12345678\"\r\n                                    value={data.taxId}\r\n                                    onChange={e => handleChange('taxId', e.target.value)}\r\n                                />\r\n                            </div>\r\n                            <div>\r\n                                <label className=\"block text-sm font-bold text-slate-700 mb-2\">Email Corporativo</label>\r\n                                <div className=\"relative\">\r\n                                    <Building className=\"absolute left-3 top-3 text-slate-400 w-4 h-4\" />\r\n                                    <input\r\n                                        type=\"email\"\r\n                                        className=\"w-full pl-10 rounded-lg border-slate-300 focus:ring-blue-500\"\r\n                                        placeholder=\"sevilla@repaart.com\"\r\n                                        value={data.email}\r\n                                        onChange={e => handleChange('email', e.target.value)}\r\n                                    />\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                )}\r\n\r\n                {step === 2 && (\r\n                    <div className=\"space-y-6 animate-fade-in\">\r\n                        <h3 className=\"text-xl font-bold flex items-center text-slate-700\">\r\n                            <span className=\"bg-blue-100 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm\">2</span>\r\n                            Configuraci√≥n Financiera\r\n                        </h3>\r\n\r\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\r\n                            <div\r\n                                onClick={() => handleChange('tariffPlan', 'standard')}\r\n                                className={`p-4 rounded-xl border-2 cursor-pointer transition-all hover:shadow-md ${data.tariffPlan === 'standard' ? 'border-blue-500 bg-blue-50' : 'border-slate-200'}`}\r\n                            >\r\n                                <div className=\"flex justify-between items-center mb-2\">\r\n                                    <span className=\"font-bold text-slate-700\">Plan Est√°ndar</span>\r\n                                    {data.tariffPlan === 'standard' && <CheckCircle className=\"w-5 h-5 text-blue-500\" />}\r\n                                </div>\r\n                                <p className=\"text-sm text-slate-500 mb-3\">Tarifas base sin descuentos por volumen.</p>\r\n                                <p className=\"font-bold text-2xl text-slate-800\">15% <span className=\"text-xs font-normal text-slate-400\">Royalty</span></p>\r\n                            </div>\r\n\r\n                            <div\r\n                                onClick={() => handleChange('tariffPlan', 'premium')}\r\n                                className={`p-4 rounded-xl border-2 cursor-pointer transition-all hover:shadow-md ${data.tariffPlan === 'premium' ? 'border-purple-500 bg-purple-50' : 'border-slate-200'}`}\r\n                            >\r\n                                <div className=\"flex justify-between items-center mb-2\">\r\n                                    <span className=\"font-bold text-slate-700\">Plan Premium</span>\r\n                                    {data.tariffPlan === 'premium' && <CheckCircle className=\"w-5 h-5 text-purple-500\" />}\r\n                                </div>\r\n                                <p className=\"text-sm text-slate-500 mb-3\">Para franquicias con alta proyecci√≥n.</p>\r\n                                <p className=\"font-bold text-2xl text-slate-800\">12% <span className=\"text-xs font-normal text-slate-400\">Royalty (fijo + variable)</span></p>\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"p-4 bg-slate-50 rounded-lg border border-slate-200 flex items-start gap-3\">\r\n                            <CreditCard className=\"w-5 h-5 text-slate-400 mt-0.5\" />\r\n                            <div>\r\n                                <p className=\"text-sm font-bold text-slate-700\">Clonaci√≥n de Tarifas</p>\r\n                                <p className=\"text-xs text-slate-500\">Se copiar√°n autom√°ticamente las 35 tarifas vigentes del modelo {data.tariffPlan === 'standard' ? 'Est√°ndar 2024' : 'Growth 2025'}.</p>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                )}\r\n\r\n                {step === 3 && (\r\n                    <div className=\"space-y-6 animate-fade-in\">\r\n                        <h3 className=\"text-xl font-bold flex items-center text-slate-700\">\r\n                            <span className=\"bg-blue-100 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm\">3</span>\r\n                            Seguridad y Acceso\r\n                        </h3>\r\n\r\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\r\n                            <div>\r\n                                <label className=\"block text-sm font-bold text-slate-700 mb-2\">Nombre del Administrador</label>\r\n                                <input\r\n                                    type=\"text\"\r\n                                    className=\"w-full rounded-lg border-slate-300 focus:ring-blue-500\"\r\n                                    placeholder=\"Nombre Apellido\"\r\n                                    value={data.adminName}\r\n                                    onChange={e => handleChange('adminName', e.target.value)}\r\n                                />\r\n                            </div>\r\n                            <div>\r\n                                <label className=\"block text-sm font-bold text-slate-700 mb-2\">Contrase√±a Temporal</label>\r\n                                <div className=\"relative\">\r\n                                    <Shield className=\"absolute left-3 top-3 text-slate-400 w-4 h-4\" />\r\n                                    <input\r\n                                        type=\"text\"\r\n                                        className=\"w-full pl-10 rounded-lg border-slate-300 focus:ring-blue-500 font-bold uppercase tracking-wider\"\r\n                                        placeholder=\"Generar...\"\r\n                                        value={data.adminPassword}\r\n                                        onChange={e => handleChange('adminPassword', e.target.value)}\r\n                                    />\r\n                                </div>\r\n                                <p className=\"text-xs text-slate-400 mt-1\">El usuario deber√° cambiarla en el primer login.</p>\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"p-4 bg-amber-50 rounded-lg border border-amber-200 text-amber-800 text-sm mt-4\">\r\n                            <strong>Resumen de Alta:</strong>\r\n                            <ul className=\"list-disc list-inside mt-2 space-y-1 text-xs\">\r\n                                <li>Franquicia: <strong>{data.name}</strong> ({data.city})</li>\r\n                                <li>ID del Sistema: <strong>{data.email.split('@')[0]}</strong></li>\r\n                                <li>Plan: <strong>{data.tariffPlan.toUpperCase()}</strong></li>\r\n                            </ul>\r\n                        </div>\r\n                    </div>\r\n                )}\r\n\r\n                {/* Error Banner */}\r\n                {error && (\r\n                    <div className=\"absolute bottom-20 left-8 right-8 bg-rose-100 text-rose-600 p-3 rounded-lg text-sm text-center\">\r\n                        {error}\r\n                    </div>\r\n                )}\r\n\r\n                {/* Footer Controls */}\r\n                <div className=\"absolute bottom-8 left-8 right-8 flex justify-between items-center border-t border-slate-100 pt-6\">\r\n                    {step > 1 ? (\r\n                        <Button variant=\"ghost\" onClick={handleBack} icon={ArrowLeft}>Anterior</Button>\r\n                    ) : (\r\n                        <Button variant=\"ghost\" onClick={onCancel}>Cancelar</Button>\r\n                    )}\r\n\r\n                    {step < 3 ? (\r\n                        <Button variant=\"primary\" onClick={handleNext} disabled={!data.name || !data.email}>\r\n                            Siguiente <ChevronRight className=\"w-4 h-4 ml-2\" />\r\n                        </Button>\r\n                    ) : (\r\n                        <Button variant=\"primary\" onClick={handleSubmit} icon={loading ? (undefined) : Save} disabled={loading}>\r\n                            {loading ? 'Creando Franquicia...' : 'Finalizar Alta'}\r\n                        </Button>\r\n                    )}\r\n                </div>\r\n            </Card>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default FranchiseOnboarding;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\MigrationPanel.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":11,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":11,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[503,506],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[503,506],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":30,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":30,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1175,1178],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1175,1178],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":180,"column":62,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":180,"endColumn":65,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9198,9201],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9198,9201],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\r\nimport { Database, AlertCircle, CheckCircle, Loader2 } from 'lucide-react';\r\nimport { migrateFranchiseIds, verifyMigration } from '../../scripts/migrateFranchiseIds';\r\n\r\n/**\r\n * Admin panel component to run the franchise ID migration\r\n * Should only be accessible to root admins\r\n */\r\nconst MigrationPanel: React.FC = () => {\r\n    const [status, setStatus] = useState<'idle' | 'running' | 'success' | 'error'>('idle');\r\n    const [result, setResult] = useState<any>(null);\r\n    const [isDryRun, setIsDryRun] = useState(true);\r\n    const [showConfirm, setShowConfirm] = useState(false);\r\n\r\n    const handleRunMigration = async () => {\r\n        if (!isDryRun && !showConfirm) {\r\n            setShowConfirm(true);\r\n            return;\r\n        }\r\n\r\n        setStatus('running');\r\n        setResult(null);\r\n        setShowConfirm(false);\r\n\r\n        try {\r\n            console.log(`Starting migration (dry-run: ${isDryRun})`);\r\n            const migrationResult = await migrateFranchiseIds(isDryRun);\r\n            setResult(migrationResult);\r\n            setStatus(migrationResult.success ? 'success' : 'error');\r\n        } catch (error: any) {\r\n            console.error('Migration error:', error);\r\n            setResult({ success: false, errors: [error.message] });\r\n            setStatus('error');\r\n        }\r\n    };\r\n\r\n    const handleVerify = async () => {\r\n        setStatus('running');\r\n        try {\r\n            await verifyMigration();\r\n            setStatus('success');\r\n        } catch (error) {\r\n            console.error('Verification error:', error);\r\n            setStatus('error');\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"max-w-4xl mx-auto p-6\">\r\n            <div className=\"bg-slate-900/50 border border-slate-800 rounded-2xl p-8\">\r\n                {/* Header */}\r\n                <div className=\"flex items-center gap-4 mb-6\">\r\n                    <div className=\"p-3 bg-indigo-500/10 rounded-xl\">\r\n                        <Database className=\"w-6 h-6 text-indigo-400\" />\r\n                    </div>\r\n                    <div>\r\n                        <h2 className=\"text-2xl font-bold text-white\">Data Migration Tool</h2>\r\n                        <p className=\"text-slate-400 text-sm\">FranchiseId Custom ‚Üí UID Migration</p>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Warning */}\r\n                <div className=\"bg-amber-500/10 border border-amber-500/20 rounded-xl p-4 mb-6\">\r\n                    <div className=\"flex gap-3\">\r\n                        <AlertCircle className=\"w-5 h-5 text-amber-400 shrink-0 mt-0.5\" />\r\n                        <div className=\"text-sm\">\r\n                            <p className=\"font-bold text-amber-300 mb-1\">Critical Operation</p>\r\n                            <p className=\"text-amber-200/80\">\r\n                                This will update all financial records, shifts, vehicles, and riders to use UIDs\r\n                                instead of custom franchise IDs. Always run in DRY-RUN mode first!\r\n                            </p>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Controls */}\r\n                <div className=\"space-y-4 mb-6\">\r\n                    {/* Dry Run Toggle */}\r\n                    <div className=\"flex items-center justify-between p-4 bg-slate-800/50 rounded-xl\">\r\n                        <div>\r\n                            <p className=\"font-bold text-white\">Dry Run Mode</p>\r\n                            <p className=\"text-xs text-slate-400\">Preview changes without modifying data</p>\r\n                        </div>\r\n                        <button\r\n                            onClick={() => {\r\n                                setIsDryRun(!isDryRun);\r\n                                setShowConfirm(false);\r\n                            }}\r\n                            className={`relative w-14 h-7 rounded-full transition-colors ${isDryRun ? 'bg-emerald-500' : 'bg-slate-600'\r\n                                }`}\r\n                            title={isDryRun ? \"Desactivar modo prueba\" : \"Activar modo prueba\"}\r\n                        >\r\n                            <div className={`absolute top-1 left-1 w-5 h-5 bg-white rounded-full transition-transform ${isDryRun ? '' : 'translate-x-7'\r\n                                }`} />\r\n                        </button>\r\n                    </div>\r\n\r\n                    {/* Action Buttons */}\r\n                    <div className=\"grid grid-cols-2 gap-4\">\r\n                        <button\r\n                            onClick={handleRunMigration}\r\n                            disabled={status === 'running'}\r\n                            className={`px-6 py-3 rounded-xl font-bold transition-all ${isDryRun\r\n                                ? 'bg-indigo-600 hover:bg-indigo-700 text-white'\r\n                                : 'bg-rose-600 hover:bg-rose-700 text-white'\r\n                                } disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2`}\r\n                        >\r\n                            {status === 'running' ? (\r\n                                <>\r\n                                    <Loader2 className=\"w-4 h-4 animate-spin\" />\r\n                                    Running...\r\n                                </>\r\n                            ) : (\r\n                                <>{isDryRun ? 'Preview Changes' : 'Execute Migration'}</>\r\n                            )}\r\n                        </button>\r\n\r\n                        <button\r\n                            onClick={handleVerify}\r\n                            disabled={status === 'running'}\r\n                            className=\"px-6 py-3 rounded-xl font-bold bg-slate-700 hover:bg-slate-600 text-white transition-all disabled:opacity-50 flex items-center justify-center gap-2\"\r\n                        >\r\n                            Verify Status\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Confirmation Dialog */}\r\n                {showConfirm && (\r\n                    <div className=\"bg-rose-500/10 border-2 border-rose-500/30 rounded-xl p-6 mb-6\">\r\n                        <p className=\"font-bold text-rose-300 mb-4 text-lg\">‚ö†Ô∏è Final Confirmation Required</p>\r\n                        <p className=\"text-rose-200/80 mb-6\">\r\n                            You are about to execute a LIVE migration that will permanently modify data in Firestore.\r\n                            This operation cannot be undone via this tool. Have you:\r\n                        </p>\r\n                        <ul className=\"text-sm text-rose-200/80 space-y-2 mb-6 ml-4\">\r\n                            <li>‚úì Run and reviewed the dry-run results?</li>\r\n                            <li>‚úì Backed up critical data in Firebase Console?</li>\r\n                            <li>‚úì Verified the UID mapping is correct?</li>\r\n                        </ul>\r\n                        <div className=\"flex gap-3\">\r\n                            <button\r\n                                onClick={handleRunMigration}\r\n                                className=\"flex-1 px-6 py-3 bg-rose-600 hover:bg-rose-700 rounded-xl font-bold text-white transition-all\"\r\n                            >\r\n                                Yes, Execute Now\r\n                            </button>\r\n                            <button\r\n                                onClick={() => setShowConfirm(false)}\r\n                                className=\"flex-1 px-6 py-3 bg-slate-700 hover:bg-slate-600 rounded-xl font-bold text-white transition-all\"\r\n                            >\r\n                                Cancel\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                )}\r\n\r\n                {/* Results */}\r\n                {result && (\r\n                    <div className={`rounded-xl p-6 border-2 ${result.success\r\n                        ? 'bg-emerald-500/10 border-emerald-500/30'\r\n                        : 'bg-rose-500/10 border-rose-500/30'\r\n                        }`}>\r\n                        <div className=\"flex items-center gap-3 mb-4\">\r\n                            {result.success ? (\r\n                                <CheckCircle className=\"w-6 h-6 text-emerald-400\" />\r\n                            ) : (\r\n                                <AlertCircle className=\"w-6 h-6 text-rose-400\" />\r\n                            )}\r\n                            <h3 className={`text-lg font-bold ${result.success ? 'text-emerald-300' : 'text-rose-300'\r\n                                }`}>\r\n                                {result.success ? 'Migration Completed' : 'Migration Failed'}\r\n                            </h3>\r\n                        </div>\r\n\r\n                        {result.mappings && result.mappings.length > 0 && (\r\n                            <div className=\"mb-4\">\r\n                                <p className=\"text-sm font-bold text-white mb-2\">Franchise Mappings:</p>\r\n                                <div className=\"space-y-2\">\r\n                                    {result.mappings.map((m: any, i: number) => (\r\n                                        <div key={i} className=\"text-[10px] font-bold uppercase tracking-wider bg-black/30 rounded p-2 text-slate-300\">\r\n                                            <span className=\"text-amber-400\">{m.franchiseId}</span>\r\n                                            {' ‚Üí '}\r\n                                            <span className=\"text-emerald-400\">{m.uid}</span>\r\n                                            {' '}\r\n                                            <span className=\"text-slate-400\">({m.email})</span>\r\n                                        </div>\r\n                                    ))}\r\n                                </div>\r\n                            </div>\r\n                        )}\r\n\r\n                        {result.updated && (\r\n                            <div className=\"space-y-2\">\r\n                                <p className=\"text-sm font-bold text-white\">Documents Updated:</p>\r\n                                <div className=\"grid grid-cols-2 gap-2 text-xs\">\r\n                                    <div className=\"bg-black/30 rounded p-2\">\r\n                                        Financial Records: <span className=\"font-bold text-indigo-400\">{result.updated.financial_records}</span>\r\n                                    </div>\r\n                                    <div className=\"bg-black/30 rounded p-2\">\r\n                                        Shifts: <span className=\"font-bold text-indigo-400\">{result.updated.shifts}</span>\r\n                                    </div>\r\n                                    <div className=\"bg-black/30 rounded p-2\">\r\n                                        Motos: <span className=\"font-bold text-indigo-400\">{result.updated.motos}</span>\r\n                                    </div>\r\n                                    <div className=\"bg-black/30 rounded p-2\">\r\n                                        Riders: <span className=\"font-bold text-indigo-400\">{result.updated.riders}</span>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        )}\r\n\r\n                        {result.errors && result.errors.length > 0 && (\r\n                            <div className=\"mt-4\">\r\n                                <p className=\"text-sm font-bold text-rose-300 mb-2\">Errors:</p>\r\n                                <div className=\"space-y-1\">\r\n                                    {result.errors.map((err: string, i: number) => (\r\n                                        <code key={i} className=\"text-[10px] bg-slate-100 p-1.5 rounded text-slate-600 break-all block max-w-xs font-bold uppercase tracking-widest\">\r\n                                            {err}\r\n                                        </code>\r\n                                    ))}\r\n                                </div>\r\n                            </div>\r\n                        )}\r\n\r\n                        {isDryRun && result.success && (\r\n                            <div className=\"mt-4 p-3 bg-amber-500/10 rounded-lg\">\r\n                                <p className=\"text-xs text-amber-200\">\r\n                                    üí° This was a dry run. No data was modified. Toggle off &quot;Dry Run Mode&quot; to execute.\r\n                                </p>\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                )}\r\n\r\n                {/* Console Note */}\r\n                <div className=\"mt-6 p-4 bg-slate-800/50 rounded-xl border border-slate-700\">\r\n                    <p className=\"text-xs text-slate-400\">\r\n                        <span className=\"font-bold text-slate-300\">Developer Note:</span> This script is also available\r\n                        in browser console. Run <code className=\"bg-black/50 px-2 py-0.5 rounded\">await migrateFranchiseIds()</code> for dry-run\r\n                        or <code className=\"bg-black/50 px-2 py-0.5 rounded\">await migrateFranchiseIds(false)</code> to execute.\r\n                    </p>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default MigrationPanel;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\components\\FranchiseFeatureManager.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\components\\MigrationPanel.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":60,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":60,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3036,3039],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3036,3039],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":68,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":68,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3414,3417],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3414,3417],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\r\nimport { collection, getDocs, doc, setDoc, getDoc, serverTimestamp } from 'firebase/firestore';\r\nimport { db } from '../../../lib/firebase';\r\nimport { Button } from '../../../ui/primitives/Button';\r\nimport { Card } from '../../../ui/primitives/Card';\r\nimport { Database } from 'lucide-react';\r\n\r\nexport const MigrationPanel: React.FC = () => {\r\n    const [isLoading, setIsLoading] = useState(false);\r\n    const [logs, setLogs] = useState<string[]>([]);\r\n    const [stats, setStats] = useState({ total: 0, migrated: 0, errors: 0 });\r\n\r\n    const runMigration = async () => {\r\n        if (!confirm(\"¬øEst√°s seguro de ejecutar la migraci√≥n? Esto copiar√° riders de la colecci√≥n antigua a 'users'.\")) return;\r\n\r\n        setIsLoading(true);\r\n        setLogs(prev => [\"Inicio de migraci√≥n...\", ...prev]);\r\n        setStats({ total: 0, migrated: 0, errors: 0 });\r\n\r\n        try {\r\n            // 1. Fetch legacy riders\r\n            const ridersSnapshot = await getDocs(collection(db, 'riders'));\r\n            const total = ridersSnapshot.size;\r\n            setStats(prev => ({ ...prev, total }));\r\n            setLogs(prev => [`üîç Encontrados ${total} documentos en 'riders'`, ...prev]);\r\n\r\n            for (const riderDoc of ridersSnapshot.docs) {\r\n                const data = riderDoc.data();\r\n                const uid = riderDoc.id;\r\n\r\n                try {\r\n                    // 2. Check if exists in 'users'\r\n                    const userRef = doc(db, 'users', uid);\r\n                    const userSnap = await getDoc(userRef);\r\n\r\n                    if (!userSnap.exists() || !userSnap.data().role) {\r\n                        // 3. Migrate / Fix\r\n                        const newUserData = {\r\n                            uid: uid,\r\n                            email: data.email,\r\n                            displayName: data.fullName || data.name || 'Rider Sin Nombre',\r\n                            phoneNumber: data.phone || '',\r\n                            role: 'rider', // FORCE ROLE\r\n                            franchiseId: data.franchiseId || '',\r\n                            status: data.status || 'active',\r\n                            contractHours: data.contractHours || 40,\r\n                            photoURL: data.photoURL || '',\r\n                            migratedAt: serverTimestamp(),\r\n                            updatedAt: serverTimestamp(),\r\n                            // Keep legacy metrics if needed, but store in top level or specific object\r\n                            metrics: data.metrics || {}\r\n                        };\r\n\r\n                        await setDoc(userRef, newUserData, { merge: true });\r\n                        setStats(prev => ({ ...prev, migrated: prev.migrated + 1 }));\r\n                        setLogs(prev => [`‚úÖ Migrado: ${data.email} (${uid})`, ...prev]);\r\n                    } else {\r\n                        setLogs(prev => [`‚ÑπÔ∏è Saltado (Ya existe): ${data.email}`, ...prev]);\r\n                    }\r\n                } catch (err: any) {\r\n                    console.error(`Error migrating ${uid}:`, err);\r\n                    setStats(prev => ({ ...prev, errors: prev.errors + 1 }));\r\n                    setLogs(prev => [`‚ùå Error con ${data.email}: ${err.message}`, ...prev]);\r\n                }\r\n            }\r\n            setLogs(prev => [\"üèÅ Migraci√≥n completada.\", ...prev]);\r\n\r\n        } catch (error: any) {\r\n            console.error(\"Migration fatal error:\", error);\r\n            setLogs(prev => [`üî• Error Fatal: ${error.message}`, ...prev]);\r\n        } finally {\r\n            setIsLoading(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <Card className=\"p-6 space-y-4\">\r\n            <div className=\"flex items-center gap-3 mb-2\">\r\n                <div className=\"p-2 bg-amber-100 text-amber-700 rounded-lg\">\r\n                    <Database size={20} />\r\n                </div>\r\n                <div>\r\n                    <h3 className=\"text-lg font-bold text-slate-800 dark:text-white pb-0\">Migraci√≥n de Base de Datos</h3>\r\n                    <p className=\"text-sm text-slate-500\">Unificar riders antiguos a la nueva estructura de usuarios.</p>\r\n                </div>\r\n            </div>\r\n\r\n            <div className=\"bg-slate-50 dark:bg-slate-900 rounded-xl p-4 border border-slate-200 dark:border-slate-700 font-mono text-xs h-48 overflow-y-auto space-y-1\">\r\n                {logs.length === 0 ? (\r\n                    <span className=\"text-slate-400 opacity-50\">Esperando ejecuci√≥n...</span>\r\n                ) : (\r\n                    logs.map((log, i) => (\r\n                        <div key={i} className={`\r\n                            ${log.includes('‚úÖ') ? 'text-green-600' : ''}\r\n                            ${log.includes('‚ùå') || log.includes('üî•') ? 'text-red-500 font-bold' : ''}\r\n                            ${log.includes('‚ÑπÔ∏è') ? 'text-blue-400' : 'text-slate-600 dark:text-slate-300'}\r\n                        `}>\r\n                            {log}\r\n                        </div>\r\n                    ))\r\n                )}\r\n            </div>\r\n\r\n            <div className=\"flex justify-between items-center pt-2\">\r\n                <div className=\"flex gap-4 text-sm font-medium\">\r\n                    <span className=\"text-slate-500\">Total: <b className=\"text-slate-900 dark:text-white\">{stats.total}</b></span>\r\n                    <span className=\"text-green-600\">Migrados: <b>{stats.migrated}</b></span>\r\n                    <span className=\"text-red-500\">Errores: <b>{stats.errors}</b></span>\r\n                </div>\r\n\r\n                <Button\r\n                    onClick={runMigration}\r\n                    isLoading={isLoading}\r\n                    variant={isLoading ? 'secondary' : 'primary'}\r\n                    className={isLoading ? '' : 'bg-amber-600 hover:bg-amber-700 text-white border-transparent'}\r\n                >\r\n                    {isLoading ? 'Migrando...' : 'Ejecutar Migraci√≥n'}\r\n                </Button>\r\n            </div>\r\n        </Card>\r\n    );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\components\\SystemReset.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\dashboard\\AdminDashboard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\dashboard\\AdminFinanceInbox.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":121,"column":87,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":121,"endColumn":90,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6227,6230],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6227,6230],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { financeService } from '../../../services/financeService';\r\nimport type { FinancialRecord } from '../../../services/financeService';\r\nimport {\r\n    CheckCircle,\r\n    XCircle,\r\n    FileText,\r\n    Clock,\r\n    DollarSign\r\n} from 'lucide-react';\r\n\r\ninterface AuditModal {\r\n    isOpen: boolean;\r\n    record: FinancialRecord | null;\r\n    type: 'approve' | 'reject' | null;\r\n}\r\n\r\nconst AdminFinanceInbox: React.FC = () => {\r\n    const [records, setRecords] = useState<FinancialRecord[]>([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const [auditModal, setAuditModal] = useState<AuditModal>({ isOpen: false, record: null, type: null });\r\n    const [rejectionReason, setRejectionReason] = useState('');\r\n\r\n    useEffect(() => {\r\n        loadPendingRecords();\r\n    }, []);\r\n\r\n    const loadPendingRecords = async () => {\r\n        setLoading(true);\r\n        try {\r\n            const data = await financeService.getGlobalPendingRecords();\r\n            setRecords(data);\r\n        } catch (error) {\r\n            console.error(\"Error loading inbox:\", error);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    const handleActionClick = (record: FinancialRecord, type: 'approve' | 'reject') => {\r\n        setAuditModal({ isOpen: true, record, type });\r\n        setRejectionReason('');\r\n    };\r\n\r\n    const confirmAction = async () => {\r\n        if (!auditModal.record) return;\r\n\r\n        try {\r\n            if (auditModal.type === 'approve') {\r\n                await financeService.updateStatus(auditModal.record.id, 'approved', 'ADMIN_UID'); // TODO: Pass real Admin UID\r\n            } else {\r\n                if (!rejectionReason.trim()) return alert(\"Debes indicar un motivo de rechazo\");\r\n                await financeService.updateStatus(auditModal.record.id, 'rejected', undefined, rejectionReason);\r\n            }\r\n\r\n            // Refresh list\r\n            setRecords(prev => prev.filter(r => r.id !== auditModal.record!.id));\r\n            setAuditModal({ isOpen: false, record: null, type: null });\r\n        } catch (error) {\r\n            console.error(\"Error processing record:\", error);\r\n            alert(\"Error al procesar la solicitud\");\r\n        }\r\n    };\r\n\r\n    if (loading) return (\r\n        <div className=\"p-8 text-center space-y-4\">\r\n            <div className=\"animate-spin w-8 h-8 border-2 border-blue-500 border-t-transparent rounded-full mx-auto\" />\r\n            <p className=\"text-slate-400\">Buscando solicitudes pendientes...</p>\r\n        </div>\r\n    );\r\n\r\n    return (\r\n        <div className=\"space-y-6 animate-in fade-in duration-500\">\r\n            {/* Header */}\r\n            <div className=\"flex justify-between items-end\">\r\n                <div>\r\n                    <h2 className=\"text-2xl font-bold text-slate-900 dark:text-white flex items-center gap-3\">\r\n                        <FileText className=\"text-blue-600 dark:text-blue-400\" />\r\n                        Bandeja de Entrada Global\r\n                    </h2>\r\n                    <p className=\"text-slate-500 dark:text-slate-400 mt-1\">\r\n                        Hay <span className=\"text-slate-900 dark:text-white font-bold\">{records.length}</span> transacciones esperando revisi√≥n.\r\n                    </p>\r\n                </div>\r\n\r\n                <div className=\"flex gap-2\">\r\n                    <button onClick={loadPendingRecords} className=\"p-2 text-slate-400 hover:text-white rounded-lg hover:bg-slate-800 transition-colors\" aria-label=\"Actualizar registros\">\r\n                        <Clock size={20} />\r\n                    </button>\r\n                </div>\r\n            </div>\r\n\r\n            {/* List */}\r\n            {records.length === 0 ? (\r\n                <div className=\"bg-white dark:bg-slate-900/50 rounded-2xl border border-dashed border-slate-200 dark:border-slate-800 p-12 text-center shadow-sm\">\r\n                    <CheckCircle className=\"w-12 h-12 text-emerald-500/50 mx-auto mb-4\" />\r\n                    <h3 className=\"text-lg font-medium text-slate-900 dark:text-white\">Todo al d√≠a</h3>\r\n                    <p className=\"text-slate-500\">No hay solicitudes pendientes de aprobaci√≥n.</p>\r\n                </div>\r\n            ) : (\r\n                <div className=\"grid gap-4\">\r\n                    {records.map(record => (\r\n                        <div key={record.id} className=\"bg-white dark:bg-slate-900/80 p-4 rounded-xl border border-slate-200 dark:border-slate-800 hover:border-blue-400 dark:hover:border-blue-500/30 transition-all flex justify-between items-center group shadow-sm hover:shadow-md\">\r\n\r\n                            {/* Info */}\r\n                            <div className=\"flex items-start gap-4\">\r\n                                <div className={`p-3 rounded-lg ${record.type === 'income' ? 'bg-emerald-50 dark:bg-emerald-500/10 text-emerald-600 dark:text-emerald-400' : 'bg-rose-50 dark:bg-rose-500/10 text-rose-600 dark:text-rose-400'}`}>\r\n                                    <DollarSign size={20} />\r\n                                </div>\r\n                                <div>\r\n                                    <div className=\"flex items-center gap-2 mb-1\">\r\n                                        <span className=\"font-bold text-slate-900 dark:text-white text-lg\">\r\n                                            {Number(record.amount).toLocaleString('es-ES', { style: 'currency', currency: 'EUR' })}\r\n                                        </span>\r\n                                        <span className=\"text-xs px-2 py-0.5 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 border border-slate-200 dark:border-slate-700\">\r\n                                            {record.franchise_id.substring(0, 5)}...\r\n                                        </span>\r\n                                    </div>\r\n                                    <p className=\"text-sm text-slate-600 dark:text-slate-300 font-medium\">{record.description || 'Sin descripci√≥n'}</p>\r\n                                    <p className=\"text-xs text-slate-400 dark:text-slate-500 mt-0.5 capitalize\">\r\n                                        {record.category} ‚Ä¢ {new Date((record.date as any)?.seconds * 1000 || record.date).toLocaleDateString()}\r\n                                    </p>\r\n                                </div>\r\n                            </div>\r\n\r\n                            {/* Actions */}\r\n                            <div className=\"flex items-center gap-3\">\r\n                                <button\r\n                                    onClick={() => handleActionClick(record, 'reject')}\r\n                                    className=\"px-3 py-2 rounded-lg text-sm font-medium text-slate-500 hover:text-rose-600 dark:text-slate-400 dark:hover:text-rose-400 hover:bg-rose-50 dark:hover:bg-rose-500/10 transition-colors flex items-center gap-2\"\r\n                                >\r\n                                    Rechazar\r\n                                </button>\r\n                                <button\r\n                                    onClick={() => handleActionClick(record, 'approve')}\r\n                                    className=\"px-4 py-2 rounded-lg text-sm font-bold bg-emerald-600 hover:bg-emerald-500 text-white shadow-lg shadow-emerald-500/20 dark:shadow-emerald-900/20 transition-all active:scale-95 flex items-center gap-2\"\r\n                                >\r\n                                    <CheckCircle size={16} /> Aprobar\r\n                                </button>\r\n                            </div>\r\n                        </div>\r\n                    ))}\r\n                </div>\r\n            )}\r\n\r\n            {/* Audit Modal */}\r\n            {auditModal.isOpen && auditModal.record && (\r\n                <div className=\"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 dark:bg-black/80 backdrop-blur-sm\">\r\n                    <div className=\"bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 w-full max-w-md rounded-2xl p-6 shadow-2xl animate-in fade-in zoom-in-95 duration-200 transition-colors\">\r\n                        <h3 className=\"text-lg font-bold text-slate-900 dark:text-white mb-2 flex items-center gap-2\">\r\n                            {auditModal.type === 'approve' ? (\r\n                                <><CheckCircle className=\"text-emerald-500\" /> Confirmar Aprobaci√≥n</>\r\n                            ) : (\r\n                                <><XCircle className=\"text-rose-500\" /> Rechazar Solicitud</>\r\n                            )}\r\n                        </h3>\r\n\r\n                        <div className=\"bg-slate-50 dark:bg-slate-950 p-4 rounded-xl border border-slate-100 dark:border-slate-800 mb-6\">\r\n                            <p className=\"text-sm text-slate-500 dark:text-slate-400 mb-1\">Transacci√≥n</p>\r\n                            <div className=\"flex justify-between items-center font-bold uppercase tracking-wider\">\r\n                                <span className=\"text-slate-800 dark:text-white\">{auditModal.record.description}</span>\r\n                                <span className={auditModal.record.type === 'income' ? 'text-emerald-600 dark:text-emerald-400' : 'text-rose-600 dark:text-rose-400'}>\r\n                                    {Number(auditModal.record.amount).toLocaleString('es-ES', { style: 'currency', currency: 'EUR' })}\r\n                                </span>\r\n                            </div>\r\n                        </div>\r\n\r\n                        {auditModal.type === 'reject' && (\r\n                            <div className=\"mb-6\">\r\n                                <label className=\"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2\">Motivo del rechazo <span className=\"text-rose-500\">*</span></label>\r\n                                <textarea\r\n                                    value={rejectionReason}\r\n                                    onChange={(e) => setRejectionReason(e.target.value)}\r\n                                    className=\"w-full bg-white dark:bg-slate-950 border border-slate-300 dark:border-slate-700 rounded-xl p-3 text-slate-900 dark:text-white focus:ring-2 focus:ring-rose-500 outline-none resize-none h-24 text-sm\"\r\n                                    placeholder=\"Indica por qu√© rechazas este registro...\"\r\n                                    autoFocus\r\n                                />\r\n                            </div>\r\n                        )}\r\n\r\n                        <div className=\"flex gap-3\">\r\n                            <button\r\n                                onClick={() => setAuditModal({ isOpen: false, record: null, type: null })}\r\n                                className=\"flex-1 py-2.5 rounded-xl border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 font-medium hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors\"\r\n                            >\r\n                                Cancelar\r\n                            </button>\r\n                            <button\r\n                                onClick={confirmAction}\r\n                                disabled={auditModal.type === 'reject' && !rejectionReason.trim()}\r\n                                className={`flex-1 py-2.5 rounded-xl font-bold text-white transition-colors shadow-lg ${auditModal.type === 'approve'\r\n                                    ? 'bg-emerald-600 hover:bg-emerald-500 shadow-emerald-500/20 dark:shadow-emerald-900/20'\r\n                                    : 'bg-rose-600 hover:bg-rose-500 shadow-rose-500/20 dark:shadow-rose-900/20 disabled:opacity-50 disabled:cursor-not-allowed'\r\n                                    }`}\r\n                            >\r\n                                {auditModal.type === 'approve' ? 'Validar' : 'Rechazar'}\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default AdminFinanceInbox;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\dashboard\\AdminHero.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\dashboard\\AlertItem.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\dashboard\\DrillDownModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\dashboard\\FranchiseCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\dashboard\\FranchiseDirectory.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\dashboard\\FranchiseGrid.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\dashboard\\FranchiseSelector.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\dashboard\\IntelligenceGrid.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\dashboard\\IntelligenceWidget.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\dashboard\\OperationalMetrics.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":62,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":62,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2817,2820],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2817,2820],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-expressions","severity":2,"message":"Expected an assignment or function call and instead saw an expression.","line":64,"column":41,"nodeType":"ExpressionStatement","messageId":"unusedExpression","endLine":64,"endColumn":102},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":109,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":109,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5950,5953],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5950,5953],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-expressions","severity":2,"message":"Expected an assignment or function call and instead saw an expression.","line":111,"column":41,"nodeType":"ExpressionStatement","messageId":"unusedExpression","endLine":111,"endColumn":102}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\nimport { ResponsiveContainer, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Cell } from 'recharts';\r\nimport CustomChartTooltip from '../../../ui/data-display/CustomChartTooltip';\r\n\r\n\r\nimport { useQueryClient } from '@tanstack/react-query';\r\nimport { financeService } from '../../../services/financeService';\r\n\r\ninterface Franchise {\r\n    id: string;\r\n    name: string;\r\n    metrics: {\r\n        productivity: number;\r\n        avgDistance: number;\r\n    };\r\n}\r\n\r\ninterface OperationalMetricsProps {\r\n    franchises: Franchise[];\r\n    onChartClick?: (franchise: Franchise) => void;\r\n}\r\n\r\nconst OperationalMetrics: React.FC<OperationalMetricsProps> = ({ franchises, onChartClick }) => {\r\n    const queryClient = useQueryClient();\r\n    const handlePrefetch = (franchiseId: string) => {\r\n        if (!franchiseId) return;\r\n        const currentMonth = new Date().toISOString().slice(0, 7);\r\n        queryClient.prefetchQuery({\r\n            queryKey: ['finance', franchiseId, currentMonth],\r\n            queryFn: async () => {\r\n                const data = await financeService.getFinancialData(franchiseId, currentMonth);\r\n                return data;\r\n            },\r\n            staleTime: 5 * 60 * 1000\r\n        });\r\n    };\r\n\r\n    return (\r\n        <div className=\"bg-transparent\">\r\n            {/* Charts Grid */}\r\n            <div className=\"flex flex-col gap-4\">\r\n                {/* Productivity Chart */}\r\n                <div className=\"bg-slate-900/50 p-4 rounded-xl border border-slate-800 hover:border-slate-700 transition-colors\">\r\n                    <h4 className=\"flex justify-between items-center mb-4\">\r\n                        <span className=\"text-xs font-bold text-slate-400 uppercase tracking-wider\">Productividad (Peds/H)</span>\r\n                        <span className=\"px-2 py-0.5 bg-slate-800 border border-slate-700 rounded text-[10px] font-bold text-slate-400 uppercase tracking-widest\">\r\n                            Target {'>'} 2.5\r\n                        </span>\r\n                    </h4>\r\n                    <div className=\"h-40 cursor-pointer\">\r\n                        <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n                            <BarChart\r\n                                layout=\"vertical\"\r\n                                data={franchises.slice(0, 5).map(f => ({\r\n                                    ...f,\r\n                                    metrics: {\r\n                                        productivity: f.metrics?.productivity || 0,\r\n                                        avgDistance: f.metrics?.avgDistance || 0\r\n                                    }\r\n                                }))}\r\n                                margin={{ top: 0, right: 10, left: 10, bottom: 0 }}\r\n                                onClick={(state: any) => {\r\n                                    if (state && state.activePayload) {\r\n                                        onChartClick && onChartClick(state.activePayload[0].payload);\r\n                                    }\r\n                                }}\r\n                            >\r\n                                <CartesianGrid strokeDasharray=\"3 3\" horizontal={false} stroke=\"#334155\" />\r\n                                <XAxis type=\"number\" hide />\r\n                                <YAxis dataKey=\"name\" type=\"category\" width={80} tick={{ fontSize: 10, fill: '#94a3b8' }} axisLine={false} tickLine={false} />\r\n                                <Tooltip content={<CustomChartTooltip />} cursor={{ fill: '#1e293b' }} />\r\n                                <Bar dataKey=\"metrics.productivity\" name=\"Peds/H\" fill=\"#8b5cf6\" radius={[0, 4, 4, 0]} barSize={8}>\r\n                                    {franchises.slice(0, 5).map((entry, index) => {\r\n                                        const productivity = entry.metrics?.productivity || 0;\r\n                                        return (\r\n                                            <Cell\r\n                                                key={`cell-${index}`}\r\n                                                fill={productivity < 2 ? '#f43f5e' : '#8b5cf6'}\r\n                                                onMouseEnter={() => handlePrefetch(entry.id)}\r\n                                            />\r\n                                        );\r\n                                    })}\r\n                                </Bar>\r\n                            </BarChart>\r\n                        </ResponsiveContainer>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Distance Chart */}\r\n                <div className=\"bg-slate-900/50 p-4 rounded-xl border border-slate-800 hover:border-slate-700 transition-colors\">\r\n                    <h4 className=\"flex justify-between items-center mb-4\">\r\n                        <span className=\"text-xs font-bold text-slate-400 uppercase tracking-wider\">Eficiencia Log√≠stica</span>\r\n                        <span className=\"px-2 py-0.5 bg-slate-800 border border-slate-700 rounded text-[10px] font-bold text-slate-400 uppercase tracking-widest\">\r\n                            {'<'} 3.5km\r\n                        </span>\r\n                    </h4>\r\n                    <div className=\"h-40 cursor-pointer\">\r\n                        <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n                            <BarChart\r\n                                layout=\"vertical\"\r\n                                data={franchises.slice(0, 5).map(f => ({\r\n                                    ...f,\r\n                                    metrics: {\r\n                                        productivity: f.metrics?.productivity || 0,\r\n                                        avgDistance: f.metrics?.avgDistance || 0\r\n                                    }\r\n                                }))}\r\n                                margin={{ top: 0, right: 10, left: 10, bottom: 0 }}\r\n                                onClick={(state: any) => {\r\n                                    if (state && state.activePayload) {\r\n                                        onChartClick && onChartClick(state.activePayload[0].payload);\r\n                                    }\r\n                                }}\r\n                            >\r\n                                <CartesianGrid strokeDasharray=\"3 3\" horizontal={false} stroke=\"#334155\" />\r\n                                <XAxis type=\"number\" hide />\r\n                                <YAxis dataKey=\"name\" type=\"category\" width={80} tick={{ fontSize: 10, fill: '#94a3b8' }} axisLine={false} tickLine={false} />\r\n                                <Tooltip content={<CustomChartTooltip />} cursor={{ fill: '#1e293b' }} />\r\n                                <Bar dataKey=\"metrics.avgDistance\" name=\"Km\" fill=\"#06b6d4\" radius={[0, 4, 4, 0]} barSize={8} />\r\n                            </BarChart>\r\n                        </ResponsiveContainer>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default OperationalMetrics;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\dashboard\\PowerMetrics.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\dashboard\\SidebarWidgets.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":48,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":48,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1232,1235],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1232,1235],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { type FC } from 'react';\r\nimport { AlertTriangle, Award, Users } from 'lucide-react';\r\nimport { detectAnomalies } from '../../../lib/fraudDetection';\r\nimport { formatMoney } from '../../../lib/finance';\r\n\r\n\r\ninterface FranchiseMetrics {\r\n    profit: number;\r\n    totalKm: number;\r\n    gasoline?: number;\r\n    incidentCost: number;\r\n    otherExpenses: number;\r\n    laborRatio: number;\r\n    orders: number;\r\n    avgTicket: number;\r\n    productivity: number;\r\n    revenue: number;\r\n}\r\n\r\ninterface Franchise {\r\n    id: string;\r\n    name: string;\r\n    metrics: FranchiseMetrics;\r\n}\r\n\r\ninterface Alert {\r\n    type?: string;\r\n    title: string;\r\n    message: string;\r\n    metric?: string;\r\n}\r\n\r\ninterface EnrichedAlert extends Alert {\r\n    franchiseName: string;\r\n    franchiseId: string;\r\n    franchise: Franchise;\r\n}\r\n\r\ninterface SidebarWidgetsProps {\r\n    franchises: Franchise[];\r\n    setSelectedScorecard: (franchise: Franchise) => void;\r\n}\r\n\r\nconst SidebarWidgets: FC<SidebarWidgetsProps> = ({ franchises, setSelectedScorecard }) => {\r\n    console.log('DEBUG: SidebarWidgets mounted');\r\n    // Collect all alerts\r\n    const allAlerts: EnrichedAlert[] = franchises.flatMap(f => {\r\n        const fAlerts = detectAnomalies(f as any) as Alert[];\r\n        return fAlerts.map(a => ({ ...a, franchiseName: f.name, franchiseId: f.id, franchise: f }));\r\n    });\r\n\r\n    return (\r\n        <div className=\"space-y-6\">\r\n\r\n\r\n            {/* ALERTS SECTION (Dynamic Fraud Detection) */}\r\n            {allAlerts.length > 0 && (\r\n                <div className=\"bg-rose-50/50 backdrop-blur-md border border-rose-100 rounded-2xl p-6 relative overflow-hidden shadow-sm\">\r\n                    <div className=\"flex items-center mb-4 relative z-10\">\r\n                        <span className=\"bg-rose-100 p-1.5 rounded-lg mr-2\"><AlertTriangle className=\"w-4 h-4 text-rose-600\" /></span>\r\n                        <h3 className=\"font-bold text-rose-800 text-sm\">Centro de Alertas & Anomal√≠as</h3>\r\n                    </div>\r\n                    <div className=\"space-y-3 relative z-10 max-h-96 overflow-y-auto pr-1 scrollbar-thin scrollbar-thumb-rose-200\">\r\n                        {allAlerts.map((alert, idx) => (\r\n                            <div\r\n                                key={`${alert.franchiseId}-${idx}`}\r\n                                className=\"bg-white p-3 rounded-xl border border-rose-100 shadow-sm hover:shadow-md transition-shadow cursor-pointer group\"\r\n                                onClick={() => setSelectedScorecard(alert.franchise)}\r\n                            >\r\n                                <div className=\"flex justify-between items-start mb-1\">\r\n                                    <span className=\"font-bold text-slate-700 text-xs uppercase tracking-wider\">{alert.franchiseName}</span>\r\n                                    {alert.type === 'CRITICAL' && <span className=\"bg-rose-100 text-rose-600 text-[10px] font-bold px-1.5 py-0.5 rounded\">CR√çTICO</span>}\r\n                                </div>\r\n                                <p className=\"font-bold text-rose-800 text-sm leading-tight\">{alert.title}</p>\r\n                                <p className=\"text-xs text-slate-500 mt-1\">{alert.message}</p>\r\n                                <p className=\"text-xs font-black text-rose-500 mt-1 text-right tracking-tighter\">{alert.metric}</p>\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            {/* TOP 3 PODIUM */}\r\n            <div className=\"bg-white rounded-2xl shadow-lg border border-slate-100 p-6 relative overflow-hidden\">\r\n                <h3 className=\"font-bold text-slate-800 mb-6 flex items-center\">\r\n                    <Award className=\"w-5 h-5 mr-3 text-blue-500\" />\r\n                    Top Rendimiento\r\n                </h3>\r\n                <div className=\"space-y-4 relative z-10\">\r\n                    {franchises.map((f) => {\r\n                        const genericStyle = {\r\n                            border: 'border-slate-200',\r\n                            bg: 'bg-slate-100',\r\n                            color: 'text-slate-600',\r\n                            label: 'Franquicia',\r\n                            icon: Users // Using Users icon as a generic placeholder\r\n                        };\r\n                        return (\r\n                            <div key={f.id} onClick={() => setSelectedScorecard(f)} className={`flex items-center p-3 rounded-xl bg-slate-50 border ${genericStyle.border} hover:shadow-md transition-all cursor-pointer group`}>\r\n                                <div className={`w-10 h-10 rounded-full flex items-center justify-center mr-4 ${genericStyle.bg} ${genericStyle.color} shadow-sm group-hover:scale-110 transition-transform`}>\r\n                                    <Users className=\"w-5 h-5\" />\r\n                                </div>\r\n                                <div className=\"flex-1\">\r\n                                    <p className=\"text-[10px] font-bold text-slate-400 uppercase tracking-wider\">{genericStyle.label}</p>\r\n                                    <p className=\"font-bold text-slate-800\">{f.name}</p>\r\n                                </div>\r\n                                <div className=\"text-right\">\r\n                                    <p className=\"font-black text-emerald-600\">+{formatMoney(f.metrics.profit, 0)}‚Ç¨</p>\r\n                                </div>\r\n                            </div>\r\n                        )\r\n                    })}\r\n                </div>\r\n                {/* Decoration */}\r\n                <div className=\"absolute top-0 right-0 -mt-10 -mr-10 w-32 h-32 bg-gradient-to-br from-yellow-100 to-amber-100 rounded-full mix-blend-multiply opacity-50 blur-xl\" />\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default SidebarWidgets;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\dashboard\\TrendsSection.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":124,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":124,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4824,4827],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4824,4827],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { type FC, useState } from 'react';\r\nimport { TrendingUp } from 'lucide-react';\r\nimport { ResponsiveContainer, ComposedChart, CartesianGrid, XAxis, YAxis, Tooltip, Area, Line } from 'recharts';\r\nimport CustomChartTooltip from '../../../ui/data-display/CustomChartTooltip';\r\nimport InfoTooltip from '../../../ui/feedback/InfoTooltip';\r\nimport DrillDownModal from './DrillDownModal';\r\n\r\ntype TrendIndicator = 'up' | 'down';\r\n\r\ninterface TrendDataBreakdown {\r\n    taxes?: number;\r\n}\r\n\r\ninterface TrendDataPoint {\r\n    name: string;\r\n    revenue: number;\r\n    expenses: number;\r\n    profit: number;\r\n    orders: number;\r\n    logisticsIncome?: number;\r\n    breakdown?: TrendDataBreakdown;\r\n}\r\n\r\ninterface DrillDownItem {\r\n    label: string;\r\n    value: string;\r\n    trend: TrendIndicator;\r\n    pct: number | string;\r\n}\r\n\r\ninterface ChartClickData {\r\n    activePayload?: Array<{ payload: TrendDataPoint }>;\r\n}\r\n\r\ninterface TrendsSectionProps {\r\n    trendData: TrendDataPoint[];\r\n}\r\n\r\nconst TrendsSection: FC<TrendsSectionProps> = ({ trendData }) => {\r\n    // State for DrillDown\r\n    const [isModalOpen, setIsModalOpen] = useState(false);\r\n    const [modalData, setModalData] = useState<DrillDownItem[] | null>(null);\r\n    const [modalTitle, setModalTitle] = useState('');\r\n\r\n    const handleChartClick = (data: ChartClickData): void => {\r\n        if (data && data.activePayload && data.activePayload.length > 0) {\r\n            const payload = data.activePayload[0].payload;\r\n            const monthName = payload.name;\r\n\r\n            // Calculate margins\r\n            const revenue = payload.revenue || 0;\r\n            const expenses = payload.expenses || 0;\r\n            const profit = payload.profit || 0;\r\n            const orders = payload.orders || 0;\r\n\r\n            // Extract Details\r\n            const logisticsIncome = payload.logisticsIncome || 0; // Tarifas\r\n            const taxes = payload.breakdown?.taxes || 0; // Impuestos\r\n\r\n            // Format for DrillDownModal\r\n            const drillDownData: DrillDownItem[] = [\r\n                {\r\n                    label: 'Facturaci√≥n Total',\r\n                    value: `${(revenue / 1000).toFixed(1)}k‚Ç¨`,\r\n                    trend: 'up',\r\n                    pct: 100\r\n                },\r\n                {\r\n                    label: 'Pedidos',\r\n                    value: orders.toString(),\r\n                    trend: 'up',\r\n                    pct: orders > 0 ? ((revenue / orders).toFixed(1) + '‚Ç¨/order') : 0 // Show AOV instead of simple pct\r\n                },\r\n                {\r\n                    label: 'Tarifas (Log√≠stica)',\r\n                    value: `${(logisticsIncome / 1000).toFixed(1)}k‚Ç¨`,\r\n                    trend: 'down',\r\n                    pct: revenue > 0 ? ((logisticsIncome / revenue) * 100).toFixed(1) : 0\r\n                },\r\n                {\r\n                    label: 'Impuestos',\r\n                    value: `${(taxes / 1000).toFixed(1)}k‚Ç¨`,\r\n                    trend: 'down',\r\n                    pct: revenue > 0 ? ((taxes / revenue) * 100).toFixed(1) : 0\r\n                },\r\n                {\r\n                    label: 'Gastos Operativos',\r\n                    value: `${(expenses / 1000).toFixed(1)}k‚Ç¨`,\r\n                    trend: 'down',\r\n                    pct: revenue > 0 ? ((expenses / revenue) * 100).toFixed(1) : 0\r\n                },\r\n                {\r\n                    label: 'Beneficio Neto',\r\n                    value: `${(profit / 1000).toFixed(1)}k‚Ç¨`,\r\n                    trend: profit > 0 ? 'up' : 'down',\r\n                    pct: revenue > 0 ? ((profit / revenue) * 100).toFixed(1) : 0\r\n                }\r\n            ];\r\n\r\n            setModalTitle(`Detalle: ${monthName}`);\r\n            setModalData(drillDownData);\r\n            setIsModalOpen(true);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <>\r\n            <div className=\"w-full h-[300px] flex flex-col\">\r\n                <div className=\"flex justify-between items-center mb-2 px-2\">\r\n                    <div>\r\n                        <div className=\"flex items-center gap-2\">\r\n                            <TrendingUp className=\"w-4 h-4 text-indigo-400\" />\r\n                            <span className=\"text-xs font-bold text-slate-400 uppercase tracking-wider\">Evoluci√≥n Semestral</span>\r\n                        </div>\r\n                    </div>\r\n                    <InfoTooltip text=\"Ingresos vs Beneficios (6 meses). Click para detalle.\" />\r\n                </div>\r\n\r\n                <div className=\"flex-1 w-full min-h-0 cursor-pointer\">\r\n                    <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n                        <ComposedChart\r\n                            data={trendData}\r\n                            margin={{ top: 10, right: 10, bottom: 0, left: -20 }}\r\n                            onClick={(data: any) => handleChartClick(data)}\r\n                        >\r\n                            <defs>\r\n                                <linearGradient id=\"colorTrendRevenue\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\r\n                                    <stop offset=\"5%\" stopColor=\"#6366f1\" stopOpacity={0.3} />\r\n                                    <stop offset=\"95%\" stopColor=\"#6366f1\" stopOpacity={0} />\r\n                                </linearGradient>\r\n                            </defs>\r\n                            <CartesianGrid strokeDasharray=\"3 3\" vertical={false} stroke=\"rgba(255,255,255,0.05)\" />\r\n                            <XAxis\r\n                                dataKey=\"name\"\r\n                                stroke=\"#64748b\"\r\n                                tick={{ fontSize: 10 }}\r\n                                axisLine={false}\r\n                                tickLine={false}\r\n                                dy={10}\r\n                            />\r\n                            <YAxis\r\n                                yAxisId=\"left\"\r\n                                stroke=\"#64748b\"\r\n                                tick={{ fontSize: 10 }}\r\n                                axisLine={false}\r\n                                tickLine={false}\r\n                                tickFormatter={(value: number) => `${(value / 1000).toFixed(0)}k`}\r\n                                domain={[0, 'auto']}\r\n                            />\r\n                            <YAxis\r\n                                yAxisId=\"right\"\r\n                                orientation=\"right\"\r\n                                stroke=\"#10b981\"\r\n                                tick={{ fontSize: 10 }}\r\n                                axisLine={false}\r\n                                tickLine={false}\r\n                                tickFormatter={(value: number) => `${(value / 1000).toFixed(0)}k`}\r\n                                domain={[0, 'auto']}\r\n                            />\r\n                            <Tooltip content={<CustomChartTooltip />} cursor={{ fill: 'rgba(255,255,255,0.05)' }} />\r\n                            <Area\r\n                                yAxisId=\"left\"\r\n                                type=\"monotone\"\r\n                                dataKey=\"revenue\"\r\n                                name=\"Facturaci√≥n\"\r\n                                stroke=\"#818cf8\"\r\n                                fillOpacity={1}\r\n                                fill=\"url(#colorTrendRevenue)\"\r\n                                strokeWidth={2}\r\n                                activeDot={{ r: 6, strokeWidth: 0, fill: '#818cf8' }}\r\n                            />\r\n                            <Line\r\n                                yAxisId=\"right\"\r\n                                type=\"monotone\"\r\n                                dataKey=\"profit\"\r\n                                name=\"B¬∞ Neto\"\r\n                                stroke=\"#34d399\"\r\n                                strokeWidth={2}\r\n                                dot={{ r: 3, strokeWidth: 2, fill: '#0f172a' }}\r\n                                activeDot={{ r: 6, strokeWidth: 0, fill: '#34d399' }}\r\n                            />\r\n                        </ComposedChart>\r\n                    </ResponsiveContainer>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Drill Down Modal */}\r\n            {isModalOpen && (\r\n                <DrillDownModal\r\n                    isOpen={isModalOpen}\r\n                    onClose={() => setIsModalOpen(false)}\r\n                    data={modalData || []}\r\n                    title={modalTitle}\r\n                />\r\n            )}\r\n        </>\r\n    );\r\n};\r\n\r\nexport default TrendsSection;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\dashboard\\components\\DashboardGuideModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\dashboard\\widgets\\ControlEarningsWidget.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\dashboard\\widgets\\ControlEventsWidget.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\dashboard\\widgets\\ControlNetworkWidget.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\dashboard\\widgets\\IntelligenceWidget.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\dashboard\\widgets\\NetworkStatusWidget.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\dashboard\\widgets\\PendingActionsWidget.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":148,"column":75,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":148,"endColumn":78,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8047,8050],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8047,8050],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\nimport { Inbox, Ticket, Star, FileText, Bell, ArrowRight, AlertTriangle, CheckCircle2, Clock } from 'lucide-react';\r\nimport { useNavigate } from 'react-router-dom';\r\n\r\ninterface PendingAction {\r\n    id: string;\r\n    type: 'ticket' | 'premium' | 'record' | 'alert';\r\n    title: string;\r\n    subtitle: string;\r\n    priority: 'low' | 'normal' | 'high' | 'critical';\r\n    timestamp?: Date;\r\n}\r\n\r\ninterface ControlPendingActionsWidgetProps {\r\n    data: {\r\n        total: number;\r\n        tickets: number;\r\n        premium: number;\r\n        records: number;\r\n        alerts: number;\r\n        list: PendingAction[];\r\n    };\r\n    loading?: boolean;\r\n    onNavigate?: (tab: string) => void;\r\n}\r\n\r\nconst PendingActionsWidget: React.FC<ControlPendingActionsWidgetProps> = ({ data, loading, onNavigate }) => {\r\n    const navigate = useNavigate();\r\n\r\n    if (loading) {\r\n        return (\r\n            <div className=\"bg-white/50 dark:bg-slate-900/50 rounded-2xl border border-slate-200 dark:border-slate-800 p-6 h-full\">\r\n                <div className=\"h-5 w-32 bg-slate-200 dark:bg-slate-800 rounded mb-6\" />\r\n                <div className=\"space-y-4\">\r\n                    {[1, 2, 3].map(i => (\r\n                        <div key={i} className=\"h-14 bg-slate-100 dark:bg-slate-800/50 rounded-xl\" />\r\n                    ))}\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    const getRelativeTime = (date?: Date) => {\r\n        if (!date) return '2h';\r\n        return '2h';\r\n    };\r\n\r\n    return (\r\n        <div className=\"bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 p-6 flex flex-col h-full shadow-sm\">\r\n\r\n            {/* Header */}\r\n            <div className=\"flex justify-between items-center mb-6\">\r\n                <div>\r\n                    <h3 className=\"text-base font-semibold tracking-tight text-slate-900 dark:text-white flex items-center gap-2\">\r\n                        <Inbox className=\"w-5 h-5 text-indigo-600 dark:text-indigo-400\" />\r\n                        Acciones Pendientes\r\n                    </h3>\r\n                    <p className=\"text-sm text-slate-500 mt-1 font-medium\">\r\n                        {data.total} tareas requieren atenci√≥n\r\n                    </p>\r\n                </div>\r\n                <div className=\"flex -space-x-2\">\r\n                    <CountLabel count={data.tickets} icon={Ticket} color=\"bg-indigo-500\" />\r\n                    <CountLabel count={data.premium} icon={Star} color=\"bg-amber-500\" />\r\n                    <CountLabel count={data.records} icon={FileText} color=\"bg-emerald-500\" />\r\n                </div>\r\n            </div>\r\n\r\n            {/* List */}\r\n            <div className=\"flex-1 space-y-3 overflow-y-auto custom-scrollbar pr-1\">\r\n                {data.list.length === 0 ? (\r\n                    <div className=\"h-full flex flex-col items-center justify-center py-8 text-slate-400\">\r\n                        <CheckCircle2 className=\"w-10 h-10 mb-3 text-emerald-500/50\" />\r\n                        <p className=\"text-sm font-medium\">Todo al d√≠a</p>\r\n                    </div>\r\n                ) : (\r\n                    data.list.map(action => (\r\n                        <div\r\n                            key={action.id}\r\n                            onClick={() => {\r\n                                if (action.type === 'ticket' || action.type === 'premium') navigate('/admin/support');\r\n                                else if (action.type === 'record') {\r\n                                    if (onNavigate) onNavigate('inbox');\r\n                                    else navigate('/dashboard?view=inbox');\r\n                                }\r\n                            }}\r\n                            className={`group relative flex items-center justify-between p-4 rounded-xl border transition-all cursor-pointer ${action.priority === 'critical'\r\n                                ? 'bg-rose-50 dark:bg-rose-900/10 border-rose-100 dark:border-rose-800 hover:bg-rose-100 dark:hover:bg-rose-900/20'\r\n                                : 'bg-slate-50 dark:bg-slate-800/50 border-slate-100 dark:border-slate-800 hover:bg-white dark:hover:bg-slate-800 hover:border-indigo-200 dark:hover:border-indigo-900'\r\n                                }`}\r\n                        >\r\n                            <div className=\"flex items-center gap-4 w-full\">\r\n                                <div className={`p-2 rounded-lg shrink-0 ${action.priority === 'critical' ? 'bg-rose-100 dark:bg-rose-900/30 text-rose-600 dark:text-rose-400' :\r\n                                    action.type === 'ticket' ? 'bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400' :\r\n                                        action.type === 'premium' ? 'bg-amber-100 dark:bg-amber-900/30 text-amber-600 dark:text-amber-400' :\r\n                                            action.type === 'record' ? 'bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400' :\r\n                                                'bg-slate-100 dark:bg-slate-800 text-slate-500'\r\n                                    }`}>\r\n                                    <IconForType type={action.type} priority={action.priority} />\r\n                                </div>\r\n                                <div className=\"min-w-0 flex-1\">\r\n                                    <div className=\"flex justify-between items-center mb-0.5\">\r\n                                        <p className={`text-sm font-medium tracking-tight truncate ${action.priority === 'critical' ? 'text-rose-700 dark:text-rose-300' : 'text-slate-900 dark:text-white'\r\n                                            }`}>\r\n                                            {action.title}\r\n                                        </p>\r\n                                        <span className=\"text-xs text-slate-400 flex items-center gap-1 font-medium\">\r\n                                            <Clock className=\"w-3 h-3\" />\r\n                                            {getRelativeTime(action.timestamp)}\r\n                                        </span>\r\n                                    </div>\r\n                                    <div className=\"flex justify-between items-center\">\r\n                                        <p className=\"text-xs text-slate-500 truncate max-w-[180px]\">\r\n                                            {action.subtitle}\r\n                                        </p>\r\n                                        <ArrowRight className=\"w-3.5 h-3.5 text-slate-300 group-hover:text-indigo-500 group-hover:translate-x-1 transition-transform\" />\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    ))\r\n                )}\r\n            </div>\r\n\r\n            <button\r\n                onClick={() => navigate('/admin/support')}\r\n                className=\"mt-4 w-full py-2.5 rounded-lg border border-slate-200 dark:border-slate-700 text-xs font-medium text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-indigo-600 dark:hover:text-indigo-400 transition-all flex items-center justify-center gap-2 group\"\r\n            >\r\n                Ir al Centro de Soporte\r\n                <ArrowRight className=\"w-3.5 h-3.5 group-hover:translate-x-1 transition-transform\" />\r\n            </button>\r\n        </div>\r\n    );\r\n};\r\n\r\nconst IconForType = ({ type, priority }: { type: string, priority?: string }) => {\r\n    if (priority === 'critical') return <AlertTriangle className=\"w-4 h-4\" />;\r\n\r\n    switch (type) {\r\n        case 'ticket': return <Ticket className=\"w-4 h-4\" />;\r\n        case 'premium': return <Star className=\"w-4 h-4\" />;\r\n        case 'record': return <FileText className=\"w-4 h-4\" />;\r\n        case 'alert': return <Bell className=\"w-4 h-4\" />;\r\n        default: return <Inbox className=\"w-4 h-4\" />;\r\n    }\r\n}\r\n\r\nconst CountLabel = ({ count, icon: _Icon, color }: { count: number, icon: any, color: string }) => (\r\n    <div className={`flex items-center justify-center w-7 h-7 rounded-full ${color} text-white ring-2 ring-white dark:ring-slate-900 shadow-sm`} title={`${count} √≠tems`}>\r\n        <span className=\"text-xs font-bold tracking-tight\">{count}</span>\r\n    </div>\r\n);\r\n\r\nexport default PendingActionsWidget;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\dashboard\\widgets\\PendingTasksWidget.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":9,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":9,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[462,465],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[462,465],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":42,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":42,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1892,1895],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1892,1895],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState } from 'react';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { CheckCircle2, AlertCircle, ArrowRight, Loader2 } from 'lucide-react';\r\nimport { financeService } from '../../../../services/financeService';\r\nimport type { FinancialRecord } from '../../../../services/financeService';\r\nimport { userService } from '../../../../services/userService';\r\n\r\n// Helper for date to string\r\nconst dateToString = (date: Date | any): string => {\r\n    if (date instanceof Date) return date.toLocaleDateString();\r\n    return new Date(date).toLocaleDateString();\r\n};\r\n\r\ninterface PendingTasksWidgetProps {\r\n    limit?: number;\r\n    compact?: boolean;\r\n}\r\n\r\nconst PendingTasksWidget: React.FC<PendingTasksWidgetProps> = ({ limit = 3, compact = false }) => {\r\n    const navigate = useNavigate();\r\n    const [pendingRecords, setPendingRecords] = useState<FinancialRecord[]>([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const [franchiseNames, setFranchiseNames] = useState<Record<string, string>>({});\r\n    const [error, setError] = useState<string | null>(null);\r\n\r\n    useEffect(() => {\r\n        const loadData = async () => {\r\n            try {\r\n                // 1. Cargar tareas pendientes\r\n                const records = await financeService.getGlobalPendingRecords();\r\n                setPendingRecords(records);\r\n\r\n                // 2. Si hay tareas, cargar nombres de franquicias para no mostrar IDs feos\r\n                if (records.length > 0) {\r\n                    const franchises = await userService.fetchFranchises();\r\n                    const namesMap: Record<string, string> = {};\r\n                    franchises.forEach(f => {\r\n                        namesMap[f.id] = f.name || 'Franquicia Desconocida';\r\n                    });\r\n                    setFranchiseNames(namesMap);\r\n                }\r\n            } catch (err: any) {\r\n                console.error(\"Error loading pending tasks:\", err);\r\n                // Si falla, es probable que sea por el √≠ndice\r\n                if (err.code === 'failed-precondition') {\r\n                    setError(\"Falta √çndice en Firestore\");\r\n                } else {\r\n                    setError(\"Error cargando tareas\");\r\n                }\r\n            } finally {\r\n                setLoading(false);\r\n            }\r\n        };\r\n\r\n        loadData();\r\n    }, []);\r\n\r\n    if (loading) return (\r\n        <div className={`bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 animate-pulse flex items-center justify-center ${compact ? 'p-4 h-[100px]' : 'p-6 h-[200px]'}`}>\r\n            <Loader2 className=\"w-6 h-6 text-slate-400 dark:text-slate-500 animate-spin\" />\r\n        </div>\r\n    );\r\n\r\n    if (error) return (\r\n        <div className=\"bg-rose-900/20 border border-rose-500/30 rounded-xl p-6\">\r\n            <div className=\"flex items-center gap-3 text-rose-400 font-bold mb-2\">\r\n                <AlertCircle className=\"w-5 h-5\" />\r\n                Error de Configuraci√≥n\r\n            </div>\r\n            <p className=\"text-sm text-rose-300/80\">{error}. Verifica la consola y crea el √≠ndice compuesto.</p>\r\n        </div>\r\n    );\r\n\r\n    // ESTADO: Todo Limpio\r\n    if (pendingRecords.length === 0) return (\r\n        <div className={`bg-emerald-900/10 border border-emerald-500/20 rounded-xl flex items-center justify-between ${compact ? 'p-4' : 'p-6'}`}>\r\n            <div className=\"flex items-center gap-4\">\r\n                <div className={`bg-emerald-500/20 rounded-full flex items-center justify-center ${compact ? 'p-2' : 'p-3'}`}>\r\n                    <CheckCircle2 className={`${compact ? 'w-4 h-4' : 'w-6 h-6'} text-emerald-400`} />\r\n                </div>\r\n                <div>\r\n                    <h3 className={`${compact ? 'text-sm' : 'text-lg'} font-bold text-emerald-900 dark:text-white`}>Todo al d√≠a</h3>\r\n                    {!compact && <p className=\"text-emerald-700/70 dark:text-slate-400 text-sm\">No hay transacciones pendientes de revisi√≥n.</p>}\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n\r\n    // ESTADO: Hay Trabajo\r\n    return (\r\n        <div className={`bg-white dark:bg-slate-800 rounded-xl border border-blue-200 dark:border-blue-500/30 overflow-hidden relative group shadow-sm dark:shadow-none transition-colors ${compact ? 'p-0' : 'p-0'}`}>\r\n            <div className=\"absolute top-0 left-0 w-1 h-full bg-blue-500\" />\r\n\r\n            <div className={`${compact ? 'p-4' : 'p-6'}`}>\r\n                <div className={`flex justify-between items-start ${compact ? 'mb-2' : 'mb-4'}`}>\r\n                    <div>\r\n                        <h3 className={`${compact ? 'text-sm' : 'text-lg'} font-bold text-slate-900 dark:text-white flex items-center gap-2 transition-colors`}>\r\n                            <AlertCircle className={`${compact ? 'w-4 h-4' : 'w-5 h-5'} text-blue-600 dark:text-blue-400 fill-blue-500/10`} />\r\n                            Tareas Pendientes\r\n                        </h3>\r\n                        {!compact && (\r\n                            <p className=\"text-slate-500 dark:text-slate-400 text-sm transition-colors\">\r\n                                Tienes <span className=\"text-blue-600 dark:text-blue-400 font-bold\">{pendingRecords.length}</span> transacciones esperando aprobaci√≥n.\r\n                            </p>\r\n                        )}\r\n                        {compact && (\r\n                            <p className=\"text-slate-500 dark:text-slate-400 text-[10px] mt-1 transition-colors\">\r\n                                <span className=\"text-blue-600 dark:text-blue-400 font-bold\">{pendingRecords.length}</span> pendientes\r\n                            </p>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n\r\n                <div className=\"space-y-2\">\r\n                    {pendingRecords.slice(0, limit).map(record => (\r\n                        <div key={record.id} className={`bg-slate-50 dark:bg-slate-900/50 rounded-lg flex justify-between items-center border border-slate-100 dark:border-slate-700/50 transition-colors ${compact ? 'p-2 text-xs' : 'p-3 text-sm'}`}>\r\n                            <div>\r\n                                <div className=\"text-slate-900 dark:text-white font-medium truncate max-w-[120px] transition-colors\">\r\n                                    {franchiseNames[record.franchise_id] || record.franchise_id.slice(0, 8) + '...'}\r\n                                </div>\r\n                                <div className=\"text-slate-400 dark:text-slate-500 text-[10px] text-left transition-colors\">\r\n                                    {dateToString(record.date)}\r\n                                </div>\r\n                            </div>\r\n                            <div className=\"text-right\">\r\n                                <div className=\"font-black text-emerald-600 dark:text-emerald-400 transition-colors\">\r\n                                    {record.amount.toFixed(record.amount < 1000 ? 2 : 0)}‚Ç¨\r\n                                </div>\r\n                                {!compact && (\r\n                                    <button\r\n                                        onClick={() => navigate(`/admin/franchise/${record.franchise_id}`)}\r\n                                        className=\"text-[10px] text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 font-bold uppercase tracking-wide mt-1 flex items-center justify-end gap-1 transition-colors\"\r\n                                    >\r\n                                        Revisar <ArrowRight className=\"w-3 h-3\" />\r\n                                    </button>\r\n                                )}\r\n                            </div>\r\n                        </div>\r\n                    ))}\r\n\r\n                    {pendingRecords.length > limit && (\r\n                        <div className=\"text-center pt-2\">\r\n                            <span className=\"text-[10px] text-slate-500\">\r\n                                + {pendingRecords.length - limit} m√°s...\r\n                            </span>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default PendingTasksWidget;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\finance\\AdminNetworkDashboard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\finance\\TariffEditor.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\kanban\\KanbanBoard.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":68,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":68,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3604,3607],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3604,3607],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":76,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":76,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4086,4089],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4086,4089],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\kanban\\KanbanBoard.tsx:35:13\n  33 |\n  34 |             // eslint-disable-next-line\n> 35 |             setLocalTasks(prev => {\n     |             ^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  36 |                 if (JSON.stringify(prev) === JSON.stringify(backendTasks)) return prev;\n  37 |                 return backendTasks;\n  38 |             });","line":35,"column":13,"nodeType":null,"endLine":35,"endColumn":26,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useMemo, useEffect } from 'react';\r\nimport { DndContext, DragEndEvent, DragOverlay, PointerSensor, useSensor, useSensors, closestCorners, DragOverEvent, KeyboardSensor, DragStartEvent } from '@dnd-kit/core';\r\nimport { sortableKeyboardCoordinates } from '@dnd-kit/sortable';\r\nimport { Plus, Loader2 } from 'lucide-react';\r\nimport { useKanban, KanbanTask } from '../../../hooks/useKanban';\r\nimport KanbanColumn from './KanbanColumn';\r\nimport KanbanCard from './KanbanCard';\r\nimport KanbanFilters, { SortOption } from './KanbanFilters';\r\nimport TaskDetailModal from './TaskDetailModal';\r\nimport confetti from 'canvas-confetti';\r\n\r\nconst COLUMNS = [\r\n    { id: 'todo', title: 'Por Hacer', color: 'from-sky-400/10 via-sky-400/5 to-transparent', accent: 'text-sky-500', tint: 'bg-sky-500/5', border: 'border-sky-500/20' },\r\n    { id: 'in_progress', title: 'En Progreso', color: 'from-indigo-400/10 via-indigo-400/5 to-transparent', accent: 'text-indigo-500', tint: 'bg-indigo-500/5', border: 'border-indigo-500/20' },\r\n    { id: 'done', title: 'Completado', color: 'from-emerald-400/10 via-emerald-400/5 to-transparent', accent: 'text-emerald-500', tint: 'bg-emerald-500/5', border: 'border-emerald-500/20' }\r\n] as const;\r\n\r\nconst KanbanBoard: React.FC = () => {\r\n    const { tasks: backendTasks, isLoading, addTask, updateTask, deleteTask } = useKanban();\r\n\r\n    // UI state for smooth drag transitions\r\n    const [localTasks, setLocalTasks] = useState<KanbanTask[]>([]);\r\n    const [dragTask, setDragTask] = useState<KanbanTask | null>(null);\r\n    const [editingTask, setEditingTask] = useState<KanbanTask | null>(null);\r\n    const [searchQuery, setSearchQuery] = useState('');\r\n    const [priorityFilter, setPriorityFilter] = useState<string | null>(null);\r\n    const [sortBy, setSortBy] = useState<SortOption>('newest');\r\n\r\n    // Synchronize local tasks with backend, but only when not dragging\r\n    // Synchronize local tasks with backend, but only when not dragging\r\n    useEffect(() => {\r\n        if (!dragTask) {\r\n\r\n            // eslint-disable-next-line\r\n            setLocalTasks(prev => {\r\n                if (JSON.stringify(prev) === JSON.stringify(backendTasks)) return prev;\r\n                return backendTasks;\r\n            });\r\n        }\r\n    }, [backendTasks, dragTask]);\r\n\r\n    const sensors = useSensors(\r\n        useSensor(PointerSensor, { activationConstraint: { distance: 5 } }),\r\n        useSensor(KeyboardSensor, { coordinateGetter: sortableKeyboardCoordinates })\r\n    );\r\n\r\n    // Board Statistics\r\n    const stats = useMemo(() => {\r\n        const total = localTasks.length;\r\n        const done = localTasks.filter(t => t.status === 'done').length;\r\n        const inProgress = localTasks.filter(t => t.status === 'in_progress').length;\r\n        const completionRate = total > 0 ? Math.round((done / total) * 100) : 0;\r\n        return { total, done, inProgress, completionRate };\r\n    }, [localTasks]);\r\n\r\n    // Filtering & Sorting\r\n    const filteredTasks = useMemo(() => {\r\n        const result = localTasks.filter(task => {\r\n            const searchLower = searchQuery.toLowerCase();\r\n            const matchesSearch = task.title.toLowerCase().includes(searchLower) ||\r\n                task.tags?.some(tag => tag.toLowerCase().includes(searchLower));\r\n            const matchesPriority = priorityFilter && priorityFilter !== 'all' ? task.priority === priorityFilter : true;\r\n            return matchesSearch && matchesPriority;\r\n        });\r\n\r\n        result.sort((a, b) => {\r\n            if (sortBy === 'newest') {\r\n                const getDate = (d: any) => d?.toDate ? d.toDate() : (d ? new Date(d as string | number | Date) : new Date(0));\r\n                return getDate(b.createdAt).getTime() - getDate(a.createdAt).getTime();\r\n            }\r\n            if (sortBy === 'priority') {\r\n                const priorityOrder = { high: 0, medium: 1, low: 2 };\r\n                return priorityOrder[a.priority] - priorityOrder[b.priority];\r\n            }\r\n            if (sortBy === 'due_date') {\r\n                const getDate = (d: any) => d?.toDate ? d.toDate() : (d ? new Date(d as string | number | Date) : new Date(8640000000000000));\r\n                return getDate(a.dueDate).getTime() - getDate(b.dueDate).getTime();\r\n            }\r\n            return 0;\r\n        });\r\n\r\n        return result;\r\n    }, [localTasks, searchQuery, priorityFilter, sortBy]);\r\n\r\n    // Handlers\r\n    const handleDragStart = (event: DragStartEvent) => {\r\n        const task = localTasks.find(t => t.id === event.active.id);\r\n        if (task) setDragTask(task);\r\n    };\r\n\r\n    const handleDragOver = (event: DragOverEvent) => {\r\n        const { active, over } = event;\r\n        if (!over) return;\r\n\r\n        const activeId = active.id;\r\n        const overId = over.id;\r\n\r\n        const activeTask = localTasks.find(t => t.id === activeId);\r\n        if (!activeTask) return;\r\n\r\n        let newStatus: KanbanTask['status'] | undefined;\r\n        const isOverColumn = COLUMNS.some(col => col.id === overId);\r\n\r\n        if (isOverColumn) {\r\n            newStatus = overId as KanbanTask['status'];\r\n        } else {\r\n            const overTask = localTasks.find(t => t.id === overId);\r\n            if (overTask) newStatus = overTask.status;\r\n        }\r\n\r\n        if (newStatus && activeTask.status !== newStatus) {\r\n            setLocalTasks(prev => prev.map(t => t.id === activeId ? { ...t, status: newStatus! } : t));\r\n        }\r\n    };\r\n\r\n    const handleDragEnd = (event: DragEndEvent) => {\r\n        const { active, over } = event;\r\n        setDragTask(null);\r\n        if (!over) return;\r\n\r\n        const taskId = active.id as string;\r\n        const taskBeforeDrop = localTasks.find(t => t.id === taskId);\r\n\r\n        let finalStatus: KanbanTask['status'] | undefined;\r\n        if (COLUMNS.some(col => col.id === over.id)) {\r\n            finalStatus = over.id as KanbanTask['status'];\r\n        } else {\r\n            const overTask = localTasks.find(t => t.id === over.id);\r\n            if (overTask) finalStatus = overTask.status;\r\n        }\r\n\r\n        if (finalStatus && taskBeforeDrop) {\r\n            if (finalStatus === 'done' && taskBeforeDrop.status !== 'done') {\r\n                confetti({\r\n                    particleCount: 100,\r\n                    spread: 70,\r\n                    origin: { y: 0.6 },\r\n                    colors: ['#6366f1', '#10b981', '#f43f5e']\r\n                });\r\n            }\r\n            // Real update (optimistic update is inside useKanban mutation)\r\n            updateTask({ id: taskId, status: finalStatus });\r\n        }\r\n    };\r\n\r\n    const handleAddTask = (status: KanbanTask['status'] = 'todo') => {\r\n        const title = prompt(\"Nueva tarea:\");\r\n        if (title) {\r\n            addTask({ title, status, priority: 'medium' });\r\n        }\r\n    };\r\n\r\n    if (isLoading && localTasks.length === 0) {\r\n        return (\r\n            <div className=\"flex h-96 items-center justify-center\">\r\n                <Loader2 className=\"animate-spin text-indigo-500\" />\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <DndContext\r\n            sensors={sensors}\r\n            collisionDetection={closestCorners}\r\n            onDragStart={handleDragStart}\r\n            onDragOver={handleDragOver}\r\n            onDragEnd={handleDragEnd}\r\n        >\r\n            <div className=\"p-4 md:p-8 min-h-screen flex flex-col relative bg-slate-50/50 dark:bg-transparent\">\r\n                {/* üåå Atmospheric Glows */}\r\n                <div className=\"absolute top-[-5%] left-[-5%] w-[30%] h-[30%] bg-indigo-500/10 rounded-full blur-[100px] pointer-events-none\" />\r\n                <div className=\"absolute bottom-[-5%] right-[-5%] w-[30%] h-[30%] bg-emerald-500/5 rounded-full blur-[100px] pointer-events-none\" />\r\n\r\n                <div className=\"relative z-10 flex flex-col h-full\">\r\n                    {/* Header section */}\r\n                    <div className=\"flex flex-col xl:flex-row xl:items-end justify-between gap-8 mb-10\">\r\n                        <div className=\"space-y-2\">\r\n                            <div className=\"flex flex-col space-y-1\">\r\n                                <span className=\"inline-flex w-fit px-2 py-0.5 rounded-full bg-indigo-500/10 text-indigo-600 dark:text-indigo-400 text-[10px] font-bold uppercase tracking-wider border border-indigo-500/20\">\r\n                                    Productivity Suite\r\n                                </span>\r\n                                <h1 className=\"text-2xl md:text-3xl font-bold text-slate-800 dark:text-white tracking-tight\">\r\n                                    Project <span className=\"text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-indigo-400\">Flow</span>\r\n                                </h1>\r\n                            </div>\r\n                            <p className=\"text-xs font-medium text-slate-500 dark:text-slate-400 max-w-lg leading-relaxed\">\r\n                                Orquestaci√≥n de objetivos estrat√©gicos y tareas operativas.\r\n                            </p>\r\n                        </div>\r\n\r\n                        {/* Stats Dashboard */}\r\n                        <div className=\"grid grid-cols-2 lg:grid-cols-4 gap-4 bg-white/40 dark:bg-slate-900/40 backdrop-blur-md p-4 rounded-[2rem] border border-slate-200/50 dark:border-white/5 shadow-xl shadow-slate-200/20 dark:shadow-none\">\r\n                            <div className=\"space-y-0.5\">\r\n                                <p className=\"text-[10px] font-semibold text-slate-400 uppercase tracking-widest\">Total</p>\r\n                                <p className=\"text-xl font-bold text-slate-800 dark:text-white\">{stats.total}</p>\r\n                            </div>\r\n                            <div className=\"space-y-0.5\">\r\n                                <p className=\"text-[10px] font-semibold text-indigo-500 uppercase tracking-widest\">Activas</p>\r\n                                <p className=\"text-xl font-bold text-slate-800 dark:text-white\">{stats.inProgress}</p>\r\n                            </div>\r\n                            <div className=\"space-y-0.5\">\r\n                                <p className=\"text-[10px] font-semibold text-emerald-500 uppercase tracking-widest\">√âxito</p>\r\n                                <p className=\"text-xl font-bold text-slate-800 dark:text-white\">{stats.completionRate}%</p>\r\n                            </div>\r\n                            <div className=\"flex items-center justify-end\">\r\n                                <button\r\n                                    onClick={() => handleAddTask('todo')}\r\n                                    className=\"p-3 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white shadow-lg shadow-indigo-500/20 transition-all hover:scale-105 active:scale-95 group\"\r\n                                    title=\"A√±adir nueva tarea general\"\r\n                                >\r\n                                    <Plus size={20} className=\"group-hover:rotate-90 transition-transform duration-300\" />\r\n                                </button>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <KanbanFilters\r\n                        searchQuery={searchQuery}\r\n                        onSearchChange={setSearchQuery}\r\n                        priorityFilter={priorityFilter}\r\n                        onPriorityChange={setPriorityFilter}\r\n                        sortBy={sortBy}\r\n                        onSortChange={setSortBy}\r\n                    />\r\n\r\n                    {/* Columns Area - Horizontal Scroll on Mobile */}\r\n                    <div className=\"flex-1 overflow-hidden\">\r\n                        <div className=\"h-full overflow-x-auto pb-6 px-4 md:px-0 scrollbar-hide snap-x snap-mandatory\">\r\n                            <div className=\"flex gap-4 md:gap-6 min-h-full\">\r\n                                {COLUMNS.map((col) => (\r\n                                    <div key={col.id} className=\"flex-shrink-0 w-[85vw] md:w-80 snap-center first:pl-2 last:pr-2 md:first:pl-0 md:last:pr-0\">\r\n                                        <KanbanColumn\r\n                                            title={col.title}\r\n                                            colorConfig={col}\r\n                                            tasks={filteredTasks.filter(t => t.status === col.id)}\r\n                                            onCardClick={(task) => setEditingTask(task)}\r\n                                            onQuickAdd={(title) => addTask({ title, status: col.id, priority: 'medium' })}\r\n                                        />\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <DragOverlay dropAnimation={{\r\n                        sideEffects: ({ active }) => {\r\n                            const activeNode = active.data.current?.sortable?.node;\r\n                            if (activeNode) activeNode.style.opacity = '1';\r\n                        },\r\n                        duration: 250,\r\n                        easing: 'cubic-bezier(0.18, 0.67, 0.6, 1.22)',\r\n                    }}>\r\n                        {dragTask ? (\r\n                            <div className=\"rotate-[4deg] scale-110 cursor-grabbing w-[300px] shadow-2xl shadow-indigo-500/30\">\r\n                                <KanbanCard task={dragTask} />\r\n                            </div>\r\n                        ) : null}\r\n                    </DragOverlay>\r\n\r\n                    {editingTask && (\r\n                        <TaskDetailModal\r\n                            key={editingTask.id}\r\n                            isOpen={!!editingTask}\r\n                            task={editingTask}\r\n                            onClose={() => setEditingTask(null)}\r\n                            onUpdate={(id, updates) => updateTask({ id, ...updates })}\r\n                            onDelete={deleteTask}\r\n                        />\r\n                    )}\r\n                </div>\r\n            </div>\r\n        </DndContext>\r\n    );\r\n};\r\n\r\nexport default KanbanBoard;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\kanban\\KanbanCard.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":31,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":31,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[929,932],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[929,932],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":31,"column":71,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":31,"endColumn":74,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[961,964],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[961,964],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":31,"column":112,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":31,"endColumn":115,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1002,1005],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1002,1005],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":40,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":40,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1355,1358],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1355,1358],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":40,"column":71,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":40,"endColumn":74,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1387,1390],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1387,1390],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":40,"column":112,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":40,"endColumn":115,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1428,1431],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1428,1431],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useMemo } from 'react';\r\nimport { useSortable } from '@dnd-kit/sortable';\r\nimport { CSS } from '@dnd-kit/utilities';\r\nimport { CheckCircle2, Clock } from 'lucide-react';\r\nimport { KanbanTask } from '../../../hooks/useKanban';\r\nimport { format, isPast, isToday, addDays } from 'date-fns';\r\nimport { es } from 'date-fns/locale';\r\n\r\ninterface KanbanCardProps {\r\n    task: KanbanTask;\r\n    onCardClick?: (task: KanbanTask) => void;\r\n}\r\n\r\nconst KanbanCard: React.FC<KanbanCardProps> = ({ task, onCardClick }) => {\r\n    const {\r\n        attributes,\r\n        listeners,\r\n        setNodeRef,\r\n        transform,\r\n        transition,\r\n        isDragging\r\n    } = useSortable({ id: task.id });\r\n\r\n    const style = {\r\n        transform: CSS.Translate.toString(transform),\r\n        transition,\r\n    };\r\n\r\n    const dateStatus = useMemo(() => {\r\n        if (!task.dueDate) return null;\r\n        const date = (task.dueDate as any)?.toDate ? (task.dueDate as any).toDate() : new Date(task.dueDate as any);\r\n        if (isPast(date) && !isToday(date)) return 'overdue';\r\n        if (isToday(date)) return 'today';\r\n        if (date <= addDays(new Date(), 3)) return 'upcoming';\r\n        return 'normal';\r\n    }, [task.dueDate]);\r\n\r\n    const formattedDate = useMemo(() => {\r\n        if (!task.dueDate) return null;\r\n        const date = (task.dueDate as any)?.toDate ? (task.dueDate as any).toDate() : new Date(task.dueDate as any);\r\n        return format(date, 'd MMM', { locale: es });\r\n    }, [task.dueDate]);\r\n\r\n    const progress = useMemo(() => {\r\n        if (!task.checklist || task.checklist.length === 0) return 0;\r\n        const completed = task.checklist.filter(i => i.completed).length;\r\n        return Math.round((completed / task.checklist.length) * 100);\r\n    }, [task.checklist]);\r\n\r\n    return (\r\n        <div\r\n            ref={setNodeRef}\r\n            style={style}\r\n            {...attributes}\r\n            {...listeners}\r\n            onClick={() => onCardClick?.(task)}\r\n            className={`\r\n                group relative bg-white dark:bg-slate-900/60 rounded-xl border border-slate-200/60 dark:border-white/5 \r\n                transition-all duration-300 cursor-grab active:cursor-grabbing touch-none\r\n                hover:border-indigo-500/30 hover:shadow-lg hover:shadow-indigo-500/5 hover:-translate-y-1\r\n                ${isDragging ? 'opacity-20 scale-95' : 'opacity-100'}\r\n            `}\r\n        >\r\n            {/* Priority Line (Left Edge - Thinner) */}\r\n            <div className={`absolute top-3 bottom-3 left-0 w-1 rounded-r-md ${task.priority === 'high' ? 'bg-rose-500' :\r\n                task.priority === 'medium' ? 'bg-amber-400' : 'bg-emerald-400'\r\n                }`} />\r\n\r\n            <div className=\"pl-4 pr-3 py-3 space-y-2.5\">\r\n                {/* Header: Title & Tags */}\r\n                <div className=\"space-y-1.5\">\r\n                    {/* Tags Row */}\r\n                    {task.tags && task.tags.length > 0 && (\r\n                        <div className=\"flex flex-wrap gap-1.5 mb-1.5\">\r\n                            {task.tags.slice(0, 3).map(tag => (\r\n                                <span key={tag} className=\"px-1.5 py-0.5 bg-slate-50 dark:bg-slate-800 text-[9px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-tight rounded border border-slate-100 dark:border-white/5\">\r\n                                    {tag}\r\n                                </span>\r\n                            ))}\r\n                        </div>\r\n                    )}\r\n\r\n                    <h4 className=\"text-[13px] font-semibold text-slate-700 dark:text-slate-200 leading-snug tracking-tight group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors\">\r\n                        {task.title}\r\n                    </h4>\r\n                </div>\r\n\r\n                {/* Footer Metadata (Compact Row) */}\r\n                <div className=\"flex items-center justify-between pt-1 border-t border-slate-50 dark:border-white/5\">\r\n                    <div className=\"flex items-center gap-3\">\r\n                        {/* Date */}\r\n                        {formattedDate && (\r\n                            <div className={`flex items-center gap-1 ${dateStatus === 'overdue' ? 'text-rose-500' :\r\n                                dateStatus === 'today' ? 'text-amber-500' :\r\n                                    'text-slate-400'\r\n                                }`}>\r\n                                <Clock size={10} strokeWidth={2.5} />\r\n                                <span className=\"text-[10px] font-medium tracking-tight\">\r\n                                    {formattedDate}\r\n                                </span>\r\n                            </div>\r\n                        )}\r\n\r\n                        {/* Checklist */}\r\n                        {task.checklist && task.checklist.length > 0 && (\r\n                            <div className=\"flex items-center gap-1 text-slate-400\">\r\n                                <CheckCircle2 size={10} strokeWidth={2.5} className={progress === 100 ? 'text-emerald-500' : ''} />\r\n                                <span className=\"text-[10px] font-medium tracking-tight\">\r\n                                    {task.checklist.filter(i => i.completed).length}/{task.checklist.length}\r\n                                </span>\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n\r\n                    {/* Avatar/User or Priority Indicator if needed */}\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default KanbanCard;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\kanban\\KanbanColumn.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\kanban\\KanbanFilters.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\kanban\\TaskDetailModal.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":25,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":25,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1189,1192],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1189,1192],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":25,"column":65,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":25,"endColumn":68,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1228,1231],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1228,1231],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":99,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":99,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3796,3799],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3796,3799],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":265,"column":72,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":265,"endColumn":75,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15791,15794],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15791,15794],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":265,"column":109,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":265,"endColumn":112,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15828,15831],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15828,15831],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":265,"column":155,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":265,"endColumn":158,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15874,15877],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15874,15877],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\r\nimport { X, Calendar, CheckSquare, Tag, AlignLeft, Plus, Trash2, Clock, ArrowRight, Layers, CheckCircle2 } from 'lucide-react';\r\nimport { KanbanTask } from '../../../hooks/useKanban';\r\nimport { format, isToday, isYesterday } from 'date-fns';\r\nimport { es } from 'date-fns/locale';\r\nimport { useAuth } from '../../../context/AuthContext';\r\n\r\ninterface TaskDetailModalProps {\r\n    task: KanbanTask;\r\n    isOpen: boolean;\r\n    onClose: () => void;\r\n    onUpdate: (id: string, updates: Partial<KanbanTask>) => void;\r\n    onDelete: (id: string) => void;\r\n}\r\n\r\nconst TaskDetailModal: React.FC<TaskDetailModalProps> = ({ task, isOpen, onClose, onUpdate, onDelete }) => {\r\n    const { user } = useAuth();\r\n    const [title, setTitle] = useState(task.title);\r\n    const [description, setDescription] = useState(task.description || '');\r\n    const [newChecklistItem, setNewChecklistItem] = useState('');\r\n    const [checklist, setChecklist] = useState(task.checklist || []);\r\n    const [newTag, setNewTag] = useState('');\r\n    const [tags, setTags] = useState(task.tags || []);\r\n    const [dueDate, setDueDate] = useState<string>(\r\n        (task.dueDate as any)?.toDate ? format((task.dueDate as any).toDate(), 'yyyy-MM-dd') : ''\r\n    );\r\n\r\n    // Comments Logic\r\n    const [newComment, setNewComment] = useState('');\r\n    const [comments, setComments] = useState(task.comments || []);\r\n\r\n    const [isSaving, setIsSaving] = useState(false);\r\n\r\n    const [currentStatus, setCurrentStatus] = useState(task.status);\r\n    const [currentPriority, setCurrentPriority] = useState(task.priority);\r\n\r\n    if (!isOpen) return null;\r\n\r\n    const wrapUpdate = (updates: Partial<KanbanTask>) => {\r\n        setIsSaving(true);\r\n        onUpdate(task.id, updates);\r\n        setTimeout(() => setIsSaving(false), 800);\r\n    };\r\n\r\n    const handleTitleBlur = () => {\r\n        if (title !== task.title) wrapUpdate({ title });\r\n    };\r\n\r\n    const handleDescriptionBlur = () => {\r\n        if (description !== (task.description || '')) wrapUpdate({ description });\r\n    };\r\n\r\n    const addChecklistItem = (e: React.FormEvent) => {\r\n        e.preventDefault();\r\n        if (!newChecklistItem.trim()) return;\r\n        const newItem = { id: crypto.randomUUID(), text: newChecklistItem, completed: false };\r\n        const updatedList = [...checklist, newItem];\r\n        setChecklist(updatedList);\r\n        wrapUpdate({ checklist: updatedList });\r\n        setNewChecklistItem('');\r\n    };\r\n\r\n    const toggleChecklistItem = (itemId: string) => {\r\n        const updatedList = checklist.map(item =>\r\n            item.id === itemId ? { ...item, completed: !item.completed } : item\r\n        );\r\n        setChecklist(updatedList);\r\n        wrapUpdate({ checklist: updatedList });\r\n    };\r\n\r\n    const deleteChecklistItem = (itemId: string) => {\r\n        const updatedList = checklist.filter(item => item.id !== itemId);\r\n        setChecklist(updatedList);\r\n        wrapUpdate({ checklist: updatedList });\r\n    };\r\n\r\n    const addTag = (e: React.FormEvent) => {\r\n        e.preventDefault();\r\n        if (!newTag.trim() || tags.includes(newTag)) return;\r\n        const updatedTags = [...tags, newTag.trim()];\r\n        setTags(updatedTags);\r\n        wrapUpdate({ tags: updatedTags });\r\n        setNewTag('');\r\n    };\r\n\r\n    const removeTag = (tagToRemove: string) => {\r\n        const updatedTags = tags.filter(t => t !== tagToRemove);\r\n        setTags(updatedTags);\r\n        wrapUpdate({ tags: updatedTags });\r\n    };\r\n\r\n    const handleAddComment = (e: React.FormEvent) => {\r\n        e.preventDefault();\r\n        if (!newComment.trim() || !user) return;\r\n\r\n        const comment = {\r\n            id: crypto.randomUUID(),\r\n            text: newComment.trim(),\r\n            createdAt: new Date() as any, // Local optimistic date (handled by dual check in render)\r\n            userId: user.uid,\r\n            userName: user.displayName || 'Usuario'\r\n        };\r\n\r\n        const updatedComments = [comment, ...comments];\r\n        setComments(updatedComments);\r\n        wrapUpdate({ comments: updatedComments });\r\n        setNewComment('');\r\n    };\r\n\r\n    const handleDateChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n        const updatedDate = e.target.value;\r\n        setDueDate(updatedDate);\r\n        if (updatedDate) {\r\n            wrapUpdate({ dueDate: new Date(updatedDate) as unknown as KanbanTask['dueDate'] });\r\n        } else {\r\n            wrapUpdate({ dueDate: null as unknown as KanbanTask['dueDate'] });\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-950/20 dark:bg-slate-950/60 backdrop-blur-xl animate-in fade-in duration-500\">\r\n            <div className=\"bg-white dark:bg-slate-900 border border-slate-200 dark:border-white/10 w-full max-w-5xl max-h-[92vh] rounded-[3rem] shadow-[0_40px_80px_-20px_rgba(0,0,0,0.3)] overflow-hidden flex flex-col scale-in-center\">\r\n\r\n                {/* üåà Priority Glow Bar */}\r\n                <div className={`h-1.5 w-full ${currentPriority === 'high' ? 'bg-rose-500 shadow-[0_0_20px_rgba(244,63,94,0.4)]' :\r\n                    currentPriority === 'medium' ? 'bg-amber-500 shadow-[0_0_20px_rgba(245,158,11,0.4)]' :\r\n                        'bg-emerald-500 shadow-[0_0_20px_rgba(16,185,129,0.4)]'\r\n                    } transition-all duration-700`} />\r\n\r\n                <div className=\"flex flex-1 min-h-0\">\r\n                    {/* LEFT: MAIN WORKSPACE */}\r\n                    <div className=\"flex-1 overflow-y-auto custom-scrollbar p-8 md:p-14 space-y-12 bg-white dark:bg-transparent\">\r\n\r\n                        {/* Status/Save Indicator */}\r\n                        <div className=\"flex items-center justify-between mb-2\">\r\n                            <div className=\"flex items-center gap-3\">\r\n                                <span className=\"bg-indigo-50 dark:bg-indigo-500/10 text-indigo-600 dark:text-indigo-400 text-[10px] font-black uppercase tracking-[0.2em] px-4 py-1.5 rounded-full border border-indigo-100 dark:border-indigo-500/20\">\r\n                                    M√≥dulo de Tarea\r\n                                </span>\r\n                                {isSaving ? (\r\n                                    <span className=\"flex items-center gap-2 text-[10px] font-bold text-indigo-500 uppercase tracking-widest animate-pulse\">\r\n                                        <Clock size={12} className=\"animate-spin\" /> Guardando...\r\n                                    </span>\r\n                                ) : (\r\n                                    <span className=\"flex items-center gap-2 text-[10px] font-bold text-slate-300 dark:text-slate-600 uppercase tracking-widest\">\r\n                                        <CheckCircle2 size={12} /> Sincronizado\r\n                                    </span>\r\n                                )}\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Title Block */}\r\n                        <div className=\"space-y-3\">\r\n                            <textarea\r\n                                rows={1}\r\n                                value={title}\r\n                                onChange={(e) => setTitle(e.target.value)}\r\n                                onBlur={handleTitleBlur}\r\n                                className=\"w-full bg-transparent text-2xl font-bold text-slate-900 dark:text-white border-none focus:ring-0 p-0 placeholder:text-slate-200 dark:placeholder:text-slate-800 tracking-tight leading-tight resize-none\"\r\n                                placeholder=\"Nombre de la iniciativa...\"\r\n                            />\r\n                        </div>\r\n\r\n                        {/* Description Section */}\r\n                        <section className=\"space-y-4\">\r\n                            <div className=\"flex items-center gap-3\">\r\n                                <div className=\"p-2 rounded-xl bg-violet-500/5 text-violet-500 border border-violet-500/10\">\r\n                                    <AlignLeft size={16} />\r\n                                </div>\r\n                                <h3 className=\"text-[10px] font-bold uppercase tracking-[0.2em] text-slate-400 dark:text-slate-500\">Documentaci√≥n T√©cnica</h3>\r\n                            </div>\r\n                            <textarea\r\n                                value={description}\r\n                                onChange={(e) => setDescription(e.target.value)}\r\n                                onBlur={handleDescriptionBlur}\r\n                                placeholder=\"Escribe aqu√≠ los detalles, objetivos y contexto de la tarea...\"\r\n                                className=\"w-full bg-slate-50 dark:bg-slate-800/20 border border-slate-200/60 dark:border-white/5 rounded-2xl p-5 text-slate-600 dark:text-slate-300 text-sm focus:border-indigo-500/30 focus:ring-4 focus:ring-indigo-500/5 min-h-[120px] resize-none leading-relaxed transition-all outline-none shadow-inner\"\r\n                            />\r\n                        </section>\r\n\r\n                        {/* Action Plan Section */}\r\n                        <section className=\"space-y-4\">\r\n                            <div className=\"flex items-center justify-between\">\r\n                                <div className=\"flex items-center gap-3\">\r\n                                    <div className=\"p-2 rounded-xl bg-emerald-500/5 text-emerald-500 border border-emerald-500/10\">\r\n                                        <CheckSquare size={16} />\r\n                                    </div>\r\n                                    <h3 className=\"text-[10px] font-bold uppercase tracking-[0.2em] text-slate-400 dark:text-slate-500\">Plan de Ejecuci√≥n</h3>\r\n                                </div>\r\n                                {checklist.length > 0 && (\r\n                                    <div className=\"px-3 py-1.5 bg-emerald-500/10 rounded-xl border border-emerald-500/20\">\r\n                                        <span className=\"text-[9px] font-bold text-emerald-600 uppercase tracking-widest\">\r\n                                            {Math.round((checklist.filter(i => i.completed).length / checklist.length) * 100)}% Completado\r\n                                        </span>\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n\r\n                            <div className=\"space-y-2\">\r\n                                {checklist.map(item => (\r\n                                    <div key={item.id} className=\"group flex items-center gap-4 p-3 bg-white dark:bg-slate-800/40 rounded-xl border border-slate-100 dark:border-white/5 shadow-sm hover:shadow-lg hover:shadow-indigo-500/5 transition-all outline outline-2 outline-transparent hover:outline-indigo-500/10 hover:-translate-y-0.5\">\r\n                                        <input\r\n                                            type=\"checkbox\"\r\n                                            checked={item.completed}\r\n                                            onChange={() => toggleChecklistItem(item.id)}\r\n                                            className=\"w-5 h-5 rounded-md border-2 border-slate-200 dark:border-slate-700 bg-transparent text-indigo-600 focus:ring-indigo-500/20 cursor-pointer transition-all checked:bg-indigo-600\"\r\n                                            title={`Marcar \"${item.text}\"`}\r\n                                        />\r\n                                        <span className={`flex-1 text-[13px] font-medium tracking-tight transition-all ${item.completed ? 'text-slate-300 dark:text-slate-600 line-through' : 'text-slate-600 dark:text-slate-300'}`}>\r\n                                            {item.text}\r\n                                        </span>\r\n                                        <button\r\n                                            onClick={() => deleteChecklistItem(item.id)}\r\n                                            className=\"opacity-0 group-hover:opacity-100 p-1.5 text-slate-300 hover:text-rose-500 transition-all active:scale-90\"\r\n                                            title=\"Eliminar √≠tem\"\r\n                                        >\r\n                                            <Trash2 size={14} />\r\n                                        </button>\r\n                                    </div>\r\n                                ))}\r\n\r\n                                <form onSubmit={addChecklistItem}>\r\n                                    <div className=\"flex items-center gap-3 p-3 bg-slate-50/50 dark:bg-slate-900/40 border-2 border-dashed border-slate-200 dark:border-white/10 rounded-xl focus-within:border-indigo-500/40 focus-within:bg-white dark:focus-within:bg-slate-800 transition-all group\">\r\n                                        <Plus size={16} className=\"text-indigo-500 group-focus-within:rotate-90 transition-transform\" />\r\n                                        <input\r\n                                            type=\"text\"\r\n                                            value={newChecklistItem}\r\n                                            onChange={(e) => setNewChecklistItem(e.target.value)}\r\n                                            placeholder=\"¬øCu√°l es el siguiente paso?\"\r\n                                            className=\"w-full bg-transparent border-none focus:ring-0 p-0 text-[13px] font-bold text-slate-500 dark:text-slate-400 placeholder:text-slate-300 outline-none\"\r\n                                        />\r\n                                    </div>\r\n                                </form>\r\n                            </div>\r\n                        </section>\r\n\r\n                        {/* Comments Section */}\r\n                        <section className=\"space-y-4 pb-4\">\r\n                            <div className=\"flex items-center gap-3\">\r\n                                <div className=\"p-2 rounded-xl bg-slate-500/5 text-slate-500 border border-slate-500/10\">\r\n                                    <AlignLeft size={16} />\r\n                                </div>\r\n                                <h3 className=\"text-[10px] font-bold uppercase tracking-[0.2em] text-slate-400 dark:text-slate-500\">Actividad & Comentarios</h3>\r\n                            </div>\r\n\r\n                            {/* Comment Input */}\r\n                            <form onSubmit={handleAddComment} className=\"flex gap-3\">\r\n                                <div className=\"w-7 h-7 rounded-full bg-indigo-500 flex items-center justify-center text-white font-bold text-[10px] ring-4 ring-indigo-500/10\">\r\n                                    {user?.displayName?.charAt(0) || 'U'}\r\n                                </div>\r\n                                <div className=\"flex-1\">\r\n                                    <input\r\n                                        type=\"text\"\r\n                                        value={newComment}\r\n                                        onChange={(e) => setNewComment(e.target.value)}\r\n                                        placeholder=\"Escribe un comentario...\"\r\n                                        className=\"w-full bg-slate-50 dark:bg-slate-800/40 border border-slate-200 dark:border-white/5 rounded-xl px-4 py-2.5 text-[13px] focus:outline-none focus:border-indigo-500/50 transition-all\"\r\n                                    />\r\n                                </div>\r\n                            </form>\r\n\r\n                            {/* Comments List */}\r\n                            <div className=\"space-y-5 relative pl-3.5 border-l border-slate-100 dark:border-slate-800 ml-3.5\">\r\n                                {comments.map((comment) => {\r\n                                    const date = (comment.createdAt as any)?.toDate ? (comment.createdAt as any).toDate() : new Date(comment.createdAt as any);\r\n\r\n                                    let dateLabel = format(date, \"d MMM yyyy\", { locale: es });\r\n                                    if (isToday(date)) dateLabel = \"Hoy\";\r\n                                    if (isYesterday(date)) dateLabel = \"Ayer\";\r\n\r\n                                    return (\r\n                                        <div key={comment.id} className=\"relative pl-5 space-y-1.5 group\">\r\n                                            {/* Timestamp Dot */}\r\n                                            <div className=\"absolute -left-[18px] top-1.5 w-2.5 h-2.5 rounded-full bg-slate-200 dark:bg-slate-800 group-hover:bg-indigo-500 transition-colors border-2 border-white dark:border-slate-900\" />\r\n\r\n                                            <div className=\"flex flex-col gap-1\">\r\n                                                <div className=\"flex items-center gap-2\">\r\n                                                    <span className=\"text-[11px] font-bold text-slate-900 dark:text-white\">{comment.userName}</span>\r\n                                                    <span className=\"text-[9px] text-slate-400 font-medium\">{dateLabel}</span>\r\n                                                </div>\r\n                                                <p className=\"text-[13px] text-slate-600 dark:text-slate-300 bg-slate-50 dark:bg-slate-800/40 p-2.5 rounded-r-xl rounded-bl-xl inline-block\">\r\n                                                    {comment.text}\r\n                                                </p>\r\n                                            </div>\r\n                                        </div>\r\n                                    );\r\n                                })}\r\n                            </div>\r\n                        </section>\r\n                    </div>\r\n\r\n                    {/* RIGHT: PROPERTIES PANEL */}\r\n                    <div className=\"w-[320px] bg-slate-50/80 dark:bg-slate-900/40 backdrop-blur-md border-l border-slate-200 dark:border-white/10 p-8 space-y-10 overflow-y-auto custom-scrollbar\">\r\n\r\n                        <div className=\"flex justify-end\">\r\n                            <button\r\n                                onClick={onClose}\r\n                                className=\"p-4 rounded-3xl bg-white dark:bg-slate-800 text-slate-400 hover:text-slate-900 dark:hover:text-white border border-slate-100 dark:border-white/5 shadow-xl shadow-slate-200/20 hover:rotate-90 transition-all active:scale-95\"\r\n                                title=\"Cerrar Mesa de Trabajo\"\r\n                            >\r\n                                <X size={20} />\r\n                            </button>\r\n                        </div>\r\n\r\n                        {/* Management Stats */}\r\n                        <div className=\"grid grid-cols-1 gap-6\">\r\n                            <div className=\"space-y-4\">\r\n                                <label className=\"text-[10px] font-black uppercase tracking-[0.25em] text-slate-400 ml-1\">Estado del Flujo</label>\r\n                                <div className=\"flex flex-col gap-2.5\">\r\n                                    {(['todo', 'in_progress', 'done'] as const).map(s => (\r\n                                        <button\r\n                                            key={s}\r\n                                            onClick={() => {\r\n                                                setCurrentStatus(s);\r\n                                                wrapUpdate({ status: s });\r\n                                            }}\r\n                                            className={`flex items-center justify-between p-5 rounded-[1.5rem] border-2 font-black text-[10px] uppercase tracking-widest transition-all ${currentStatus === s\r\n                                                ? 'bg-indigo-600 text-white border-indigo-600 shadow-xl shadow-indigo-500/20 translate-x-2'\r\n                                                : 'bg-white dark:bg-slate-800/80 text-slate-500 dark:text-slate-400 border-transparent hover:border-slate-200 shadow-sm'\r\n                                                }`}\r\n                                        >\r\n                                            <div className=\"flex items-center gap-3\">\r\n                                                <Layers size={14} strokeWidth={2} />\r\n                                                {s.replace('_', ' ')}\r\n                                            </div>\r\n                                            {currentStatus === s && <ArrowRight size={14} />}\r\n                                        </button>\r\n                                    ))}\r\n                                </div>\r\n                            </div>\r\n\r\n                            <div className=\"h-px bg-slate-200 dark:bg-white/5\" />\r\n\r\n                            <div className=\"space-y-4\">\r\n                                <label className=\"text-[10px] font-black uppercase tracking-[0.25em] text-slate-400 ml-1\">Prioridad Cr√≠tica</label>\r\n                                <div className=\"flex gap-2\">\r\n                                    {(['low', 'medium', 'high'] as const).map(p => (\r\n                                        <button\r\n                                            key={p}\r\n                                            onClick={() => {\r\n                                                setCurrentPriority(p);\r\n                                                wrapUpdate({ priority: p });\r\n                                            }}\r\n                                            className={`flex-1 py-4 rounded-[1.25rem] border-2 font-black text-[9px] uppercase tracking-widest transition-all ${currentPriority === p\r\n                                                ? p === 'high' ? 'bg-rose-500 text-white border-rose-500 shadow-lg shadow-rose-500/20' :\r\n                                                    p === 'medium' ? 'bg-amber-500 text-white border-amber-500 shadow-lg shadow-amber-500/20' :\r\n                                                        'bg-emerald-500 text-white border-emerald-500 shadow-lg shadow-emerald-500/20'\r\n                                                : 'bg-white dark:bg-slate-800/80 text-slate-400 border-transparent'\r\n                                                }`}\r\n                                        >\r\n                                            {p}\r\n                                        </button>\r\n                                    ))}\r\n                                </div>\r\n                            </div>\r\n\r\n                            <div className=\"space-y-4\">\r\n                                <label className=\"text-[10px] font-black uppercase tracking-[0.25em] text-slate-400 ml-1\">Fecha de Entrega</label>\r\n                                <div className=\"relative group\">\r\n                                    <div className=\"absolute left-5 top-1/2 -translate-y-1/2 text-indigo-500 pointer-events-none\">\r\n                                        <Calendar size={18} />\r\n                                    </div>\r\n                                    <input\r\n                                        type=\"date\"\r\n                                        value={dueDate}\r\n                                        onChange={handleDateChange}\r\n                                        className=\"w-full bg-white dark:bg-slate-800/80 border-2 border-transparent focus:border-indigo-500/30 rounded-[1.25rem] p-5 pl-14 text-sm font-black text-slate-700 dark:text-slate-100 transition-all outline-none shadow-sm\"\r\n                                        title=\"Seleccionar fecha\"\r\n                                    />\r\n                                </div>\r\n                            </div>\r\n\r\n                            {/* Tags Section */}\r\n                            <div className=\"space-y-4 pt-4\">\r\n                                <label className=\"text-[10px] font-black uppercase tracking-[0.25em] text-slate-400 ml-1 flex items-center gap-2\">\r\n                                    <Tag size={12} /> Etiquetas\r\n                                </label>\r\n                                <div className=\"flex flex-wrap gap-2\">\r\n                                    {tags.map(tag => (\r\n                                        <span key={tag} className=\"group flex items-center gap-2 px-3 py-1.5 bg-indigo-500/5 text-indigo-600 dark:text-indigo-400 rounded-xl text-[9px] font-black uppercase tracking-wider border border-indigo-500/10\">\r\n                                            {tag}\r\n                                            <button onClick={() => removeTag(tag)} className=\"hover:text-rose-500\" title=\"Eliminar tag\">\r\n                                                <X size={10} />\r\n                                            </button>\r\n                                        </span>\r\n                                    ))}\r\n                                    <form onSubmit={addTag} className=\"flex-1 min-w-[100px]\">\r\n                                        <input\r\n                                            type=\"text\"\r\n                                            value={newTag}\r\n                                            onChange={(e) => setNewTag(e.target.value)}\r\n                                            placeholder=\"+ Nueva...\"\r\n                                            className=\"w-full bg-transparent border-none text-[10px] font-black uppercase tracking-widest text-indigo-400 placeholder:text-slate-300 focus:ring-0 p-1\"\r\n                                        />\r\n                                    </form>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Danger Zone */}\r\n                        <div className=\"pt-10\">\r\n                            <button\r\n                                onClick={() => {\r\n                                    if (confirm('¬øEliminar permanentemente este registro del ecosistema?')) {\r\n                                        onDelete(task.id);\r\n                                        onClose();\r\n                                    }\r\n                                }}\r\n                                className=\"w-full flex items-center justify-center gap-3 bg-white dark:bg-slate-800 hover:bg-rose-500 hover:text-white text-slate-400 border-2 border-transparent hover:border-rose-500/20 p-5 rounded-[1.5rem] text-[10px] font-black uppercase tracking-[0.2em] transition-all group\"\r\n                                title=\"Eliminar tarea\"\r\n                            >\r\n                                <Trash2 size={16} className=\"group-hover:scale-110 transition-transform\" />\r\n                                Eliminar Tarea\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default TaskDetailModal;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\knowledge\\AdminGuidesPanel.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":68,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":68,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2601,2604],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2601,2604],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":69,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":69,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2648,2651],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2648,2651],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":76,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":76,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2918,2921],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2918,2921],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":503,"column":101,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":503,"endColumn":104,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[29289,29292],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[29289,29292],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":523,"column":101,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":523,"endColumn":104,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[30787,30790],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[30787,30790],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { db } from '../../../lib/firebase';\r\nimport { collection, query, orderBy, onSnapshot, addDoc, updateDoc, deleteDoc, doc, serverTimestamp } from 'firebase/firestore';\r\nimport { generateGuideContent } from '../../../lib/gemini';\r\nimport { Plus, Save, Trash2, X, Type, PlayCircle, Search, Filter, ShieldAlert, Edit2, Sparkles, Wand2 } from 'lucide-react';\r\nimport { GUIDE_THEMES, GUIDE_ICONS } from '../../../lib/constants';\r\n\r\n// Internal Interface for the Guide Form\r\ninterface GuideData {\r\n    id?: string;\r\n    title: string;\r\n    description: string;\r\n    category: string;\r\n    theme: keyof typeof GUIDE_THEMES;\r\n    icon: keyof typeof GUIDE_ICONS;\r\n    isCritical: boolean;\r\n    url?: string;\r\n}\r\n\r\nconst INITIAL_FORM: GuideData = {\r\n    title: '',\r\n    description: '',\r\n    category: 'operativa',\r\n    theme: 'indigo',\r\n    icon: 'FileText',\r\n    isCritical: false,\r\n    url: ''\r\n};\r\n\r\nconst AdminGuidesPanel: React.FC = () => {\r\n    // Main States\r\n    const [guides, setGuides] = useState<GuideData[]>([]);\r\n    const [selectedGuide, setSelectedGuide] = useState<GuideData | null>(null);\r\n    const [formData, setFormData] = useState<GuideData>(INITIAL_FORM);\r\n    const [searchTerm, setSearchTerm] = useState('');\r\n    const [filterCategory, setFilterCategory] = useState<string>('all');\r\n    const [isDrawerOpen, setIsDrawerOpen] = useState(false);\r\n\r\n    // AI Assistant States\r\n    const [isAiModalOpen, setIsAiModalOpen] = useState(false);\r\n    const [aiPrompt, setAiPrompt] = useState('');\r\n    const [isGenerating, setIsGenerating] = useState(false);\r\n\r\n    // Fetch Guides\r\n    useEffect(() => {\r\n        const q = query(collection(db, \"guides\"), orderBy(\"createdAt\", \"desc\"));\r\n        const unsubscribe = onSnapshot(q, (snapshot) => {\r\n            setGuides(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() } as GuideData)));\r\n        }, (error) => {\r\n            console.error(\"Error fetching guides:\", error);\r\n        });\r\n        return () => unsubscribe();\r\n    }, []);\r\n\r\n    // AI Generation Handler\r\n    // AI Generation Handler\r\n    const handleAiGenerate = async () => {\r\n        if (!aiPrompt.trim()) return;\r\n        setIsGenerating(true);\r\n        try {\r\n            const result = await generateGuideContent(aiPrompt);\r\n            if (result) {\r\n                setFormData({\r\n                    ...INITIAL_FORM,\r\n                    title: result.title,\r\n                    description: result.description,\r\n                    category: result.category,\r\n                    theme: result.theme as any,\r\n                    icon: result.icon as any,\r\n                    isCritical: result.isCritical,\r\n                });\r\n                setIsAiModalOpen(false);\r\n                setIsDrawerOpen(true); // Open editor with result\r\n                setAiPrompt(''); // Clear\r\n            }\r\n        } catch (error: any) {\r\n            console.error(\"AI Error:\", error);\r\n            if (error.message.includes(\"Invalid JSON\")) {\r\n                alert(\"La IA gener√≥ una respuesta pero no pudimos leerla correctamente (Error de formato). Por favor, intenta simplificar el texto o int√©ntalo de nuevo.\");\r\n            } else if (error.message.includes(\"No JSON structure\")) {\r\n                alert(\"La IA no devolvi√≥ un formato v√°lido. Intenta ser m√°s claro en tu petici√≥n.\");\r\n            } else {\r\n                alert(\"Error de conexi√≥n o de la IA: \" + (error.message || \"Desconocido\"));\r\n            }\r\n        } finally {\r\n            setIsGenerating(false);\r\n        }\r\n    };\r\n\r\n    // Standard Handlers\r\n    const handleEdit = (guide: GuideData) => {\r\n        setSelectedGuide(guide);\r\n        setFormData(guide);\r\n        setIsDrawerOpen(true);\r\n    };\r\n\r\n    const handleNew = () => {\r\n        setSelectedGuide(null);\r\n        setFormData(INITIAL_FORM);\r\n        setIsDrawerOpen(true);\r\n    };\r\n\r\n    const handleCloseDrawer = () => {\r\n        setIsDrawerOpen(false);\r\n        setTimeout(() => {\r\n            setSelectedGuide(null);\r\n            setFormData(INITIAL_FORM);\r\n        }, 300); // Wait for animation\r\n    };\r\n\r\n    const handleSave = async () => {\r\n        try {\r\n            const dataToSave = {\r\n                title: formData.title,\r\n                description: formData.description,\r\n                category: formData.category,\r\n                theme: formData.theme,\r\n                icon: formData.icon,\r\n                isCritical: formData.isCritical,\r\n                url: formData.url || '',\r\n                updatedAt: serverTimestamp()\r\n            };\r\n\r\n            if (selectedGuide?.id) {\r\n                await updateDoc(doc(db, \"guides\", selectedGuide.id), dataToSave);\r\n            } else {\r\n                await addDoc(collection(db, \"guides\"), {\r\n                    ...dataToSave,\r\n                    createdAt: serverTimestamp()\r\n                });\r\n            }\r\n            handleCloseDrawer();\r\n        } catch (error) {\r\n            console.error(\"Error saving guide:\", error);\r\n            alert(\"Error al guardar la gu√≠a\");\r\n        }\r\n    };\r\n\r\n    const handleDelete = async (id: string) => {\r\n        if (!confirm(\"¬øEst√°s seguro de querer borrar esta gu√≠a?\")) return;\r\n        try {\r\n            await deleteDoc(doc(db, \"guides\", id));\r\n            if (selectedGuide?.id === id) handleCloseDrawer();\r\n        } catch (error) {\r\n            console.error(\"Error deleting guide:\", error);\r\n        }\r\n    };\r\n\r\n    const filteredGuides = guides.filter(guide => {\r\n        const matchesSearch = guide.title.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n            guide.description.toLowerCase().includes(searchTerm.toLowerCase());\r\n        const matchesCategory = filterCategory === 'all' || guide.category === filterCategory;\r\n        return matchesSearch && matchesCategory;\r\n    });\r\n\r\n    // Preview Helpers\r\n    const PreviewIcon = GUIDE_ICONS[formData.icon];\r\n    const themeStyles = GUIDE_THEMES[formData.theme];\r\n\r\n    return (\r\n        <div className=\"relative h-full flex flex-col bg-slate-50 dark:bg-slate-950 overflow-hidden\">\r\n\r\n            {/* --- HEADER TOOLBAR --- */}\r\n            <div className=\"flex flex-col md:flex-row md:items-center justify-between gap-4 p-6 pb-2 shrink-0\">\r\n                <div>\r\n                    <h2 className=\"text-2xl font-bold text-slate-900 dark:text-white tracking-tight\">Gesti√≥n de Gu√≠as</h2>\r\n                    <p className=\"text-slate-500 text-sm font-medium\">Administra los manuales y procedimientos visibles para la franquicia.</p>\r\n                </div>\r\n\r\n                <div className=\"flex items-center gap-3\">\r\n                    {/* Search */}\r\n                    <div className=\"relative group\">\r\n                        <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 group-focus-within:text-indigo-500 transition-colors\" />\r\n                        <input\r\n                            type=\"text\"\r\n                            placeholder=\"Buscar...\"\r\n                            value={searchTerm}\r\n                            onChange={(e) => setSearchTerm(e.target.value)}\r\n                            className=\"pl-9 pr-4 py-2 rounded-xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 focus:ring-2 focus:ring-indigo-500/20 w-48 focus:w-64 transition-all text-sm font-medium\"\r\n                        />\r\n                    </div>\r\n\r\n                    {/* Filter */}\r\n                    <div className=\"relative\">\r\n                        <select\r\n                            value={filterCategory}\r\n                            onChange={(e) => setFilterCategory(e.target.value)}\r\n                            title=\"Filtrar por categor√≠a\"\r\n                            aria-label=\"Filtrar por categor√≠a\"\r\n                            className=\"appearance-none pl-4 pr-10 py-2 rounded-xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 text-sm font-bold text-slate-700 dark:text-slate-300 focus:ring-2 focus:ring-indigo-500/20 cursor-pointer\"\r\n                        >\r\n                            <option value=\"all\">Todas las Categor√≠as</option>\r\n                            <option value=\"operativa\">Operativa</option>\r\n                            <option value=\"tecnico\">T√©cnico</option>\r\n                            <option value=\"rrhh\">RRHH</option>\r\n                            <option value=\"accidente\">Accidentes</option>\r\n                        </select>\r\n                        <Filter className=\"absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none\" />\r\n                    </div>\r\n\r\n                    <button\r\n                        onClick={() => setIsAiModalOpen(true)}\r\n                        className=\"flex items-center gap-2 px-5 py-2 bg-gradient-to-r from-violet-600 to-fuchsia-600 hover:from-violet-700 hover:to-fuchsia-700 text-white rounded-xl font-bold text-xs uppercase tracking-widest hover:scale-105 transition-all shadow-lg shadow-fuchsia-500/30 border border-white/10\"\r\n                    >\r\n                        <Sparkles className=\"w-4 h-4\" /> AUTO-GENERAR\r\n                    </button>\r\n\r\n                    <button\r\n                        onClick={handleNew}\r\n                        className=\"flex items-center gap-2 px-5 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold text-xs uppercase tracking-widest hover:scale-105 transition-all shadow-lg shadow-indigo-500/30\"\r\n                    >\r\n                        <Plus className=\"w-4 h-4\" /> Nueva Gu√≠a\r\n                    </button>\r\n                </div>\r\n            </div>\r\n\r\n            {/* --- GRID CONTENT --- */}\r\n            <div className=\"flex-1 overflow-y-auto p-6 custom-scrollbar\">\r\n                {filteredGuides.length > 0 ? (\r\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6\">\r\n                        {filteredGuides.map(guide => {\r\n                            const theme = GUIDE_THEMES[guide.theme];\r\n                            const Icon = GUIDE_ICONS[guide.icon];\r\n\r\n                            return (\r\n                                <div\r\n                                    key={guide.id}\r\n                                    onClick={() => handleEdit(guide)}\r\n                                    className=\"group relative bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-3xl p-6 hover:shadow-xl hover:shadow-indigo-500/10 hover:border-indigo-500/30 transition-all duration-300 cursor-pointer overflow-hidden\"\r\n                                >\r\n                                    {/* Edit Button Overlay */}\r\n                                    <div className=\"absolute top-4 right-4 z-20 opacity-0 group-hover:opacity-100 transition-opacity\">\r\n                                        <button\r\n                                            title=\"Editar gu√≠a\"\r\n                                            className=\"p-2 bg-white dark:bg-slate-800 rounded-full shadow-sm border border-slate-100 dark:border-slate-700 text-slate-400 hover:text-indigo-600 transition-colors\"\r\n                                        >\r\n                                            <Edit2 className=\"w-4 h-4\" />\r\n                                        </button>\r\n                                    </div>\r\n\r\n                                    {/* Icon & Badge */}\r\n                                    <div className=\"flex justify-between items-start mb-4\">\r\n                                        <div className={`w-12 h-12 rounded-2xl ${theme.bg} flex items-center justify-center transition-transform group-hover:scale-110`}>\r\n                                            <Icon className={`w-6 h-6 ${theme.text}`} />\r\n                                        </div>\r\n                                        {guide.isCritical && (\r\n                                            <span className=\"bg-rose-500 text-white text-[9px] font-bold px-2 py-1 rounded-full uppercase tracking-wider shadow-sm animate-pulse\">\r\n                                                Cr√≠tico\r\n                                            </span>\r\n                                        )}\r\n                                    </div>\r\n\r\n                                    {/* Text */}\r\n                                    <h3 className=\"font-bold text-slate-900 dark:text-white mb-2 leading-tight group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors\">\r\n                                        {guide.title}\r\n                                    </h3>\r\n                                    <p className=\"text-xs text-slate-500 dark:text-slate-400 font-medium line-clamp-2 mb-4\">\r\n                                        {guide.description}\r\n                                    </p>\r\n\r\n                                    {/* Footer */}\r\n                                    <div className=\"pt-4 border-t border-slate-100 dark:border-slate-800 flex items-center justify-between\">\r\n                                        <span className=\"text-[10px] uppercase font-bold text-slate-400 tracking-wider bg-slate-50 dark:bg-slate-800 px-2 py-1 rounded-md\">\r\n                                            {guide.category}\r\n                                        </span>\r\n                                        <div className=\"flex items-center gap-1 text-[10px] font-bold text-slate-300 group-hover:text-indigo-400 transition-colors\">\r\n                                            Editar <PlayCircle className=\"w-3 h-3\" />\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n                            );\r\n                        })}\r\n                    </div>\r\n                ) : (\r\n                    <div className=\"h-full flex flex-col items-center justify-center text-slate-400 opacity-60\">\r\n                        <Search className=\"w-12 h-12 mb-4 text-slate-300\" />\r\n                        <p className=\"text-sm font-bold\">No se encontraron gu√≠as</p>\r\n                        <p className=\"text-xs\">Intenta ajustar tu b√∫squeda o crea una nueva.</p>\r\n                    </div>\r\n                )}\r\n            </div>\r\n\r\n            {/* --- AI GENERATION MODAL --- */}\r\n            {isAiModalOpen && (\r\n                <div className=\"fixed inset-0 z-[60] flex items-center justify-center p-4\">\r\n                    <div className=\"absolute inset-0 bg-slate-900/60 backdrop-blur-sm\" onClick={() => setIsAiModalOpen(false)} />\r\n\r\n                    <div className=\"relative w-full max-w-lg bg-white dark:bg-slate-900 rounded-3xl p-8 shadow-2xl border border-slate-200 dark:border-slate-800 overflow-hidden\">\r\n                        {/* Decor */}\r\n                        <div className=\"absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-violet-500 via-fuchsia-500 to-indigo-500\" />\r\n                        <div className=\"absolute -right-10 -top-10 w-32 h-32 bg-fuchsia-500/20 blur-3xl rounded-full\" />\r\n\r\n                        <div className=\"relative\">\r\n                            <div className=\"flex justify-between items-start mb-6\">\r\n                                <div>\r\n                                    <h3 className=\"text-2xl font-bold text-slate-900 dark:text-white flex items-center gap-2\">\r\n                                        <Sparkles className=\"w-6 h-6 text-fuchsia-500\" />\r\n                                        Asistente IA\r\n                                    </h3>\r\n                                    <p className=\"text-sm text-slate-500 mt-1\">\r\n                                        Pega un texto borrador, un email o una nota r√°pida. Gemini estructurar√° la gu√≠a por ti.\r\n                                    </p>\r\n                                </div>\r\n                                <button\r\n                                    onClick={() => setIsAiModalOpen(false)}\r\n                                    className=\"text-slate-400 hover:text-slate-600 dark:hover:text-slate-200\"\r\n                                    title=\"Cerrar asistente IA\"\r\n                                >\r\n                                    <X className=\"w-6 h-6\" />\r\n                                </button>\r\n                            </div>\r\n\r\n                            <textarea\r\n                                value={aiPrompt}\r\n                                onChange={(e) => setAiPrompt(e.target.value)}\r\n                                placeholder=\"Ej: 'Avisar a todos que el lunes hay revisi√≥n de frenos obligatoria en el taller central de 9 a 14h. Es muy importante por seguridad.'\"\r\n                                className=\"w-full h-40 p-4 rounded-xl bg-slate-50 dark:bg-slate-800 border-2 border-slate-100 dark:border-slate-700 focus:border-fuchsia-500 focus:ring-4 focus:ring-fuchsia-500/10 transition-all font-medium text-slate-700 dark:text-slate-200 resize-none mb-6 placeholder-slate-400\"\r\n                            />\r\n\r\n                            <button\r\n                                onClick={handleAiGenerate}\r\n                                disabled={isGenerating || !aiPrompt.trim()}\r\n                                className=\"w-full py-4 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-2xl font-bold uppercase tracking-widest hover:scale-[1.02] active:scale-[0.98] transition-all disabled:opacity-50 disabled:scale-100 flex items-center justify-center gap-3 shadow-xl\"\r\n                            >\r\n                                {isGenerating ? (\r\n                                    <>\r\n                                        <div className=\"w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin\" />\r\n                                        Analizando y Redactando...\r\n                                    </>\r\n                                ) : (\r\n                                    <>\r\n                                        <Wand2 className=\"w-5 h-5\" />\r\n                                        Generar Gu√≠a Autom√°tica\r\n                                    </>\r\n                                )}\r\n                            </button>\r\n\r\n                            <p className=\"text-center text-[10px] text-slate-400 mt-4 font-bold uppercase tracking-widest opacity-60\">\r\n                                Powered by Google Gemini 2.5 Flash\r\n                            </p>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            {/* --- DRAWER (SLIDE-OVER) --- */}\r\n            {/* Backdrop */}\r\n            {isDrawerOpen && (\r\n                <div\r\n                    className=\"absolute inset-0 bg-slate-900/20 backdrop-blur-sm z-40 transition-opacity duration-300\"\r\n                    onClick={handleCloseDrawer}\r\n                />\r\n            )}\r\n\r\n            {/* Drawer Panel */}\r\n            <div\r\n                className={`absolute inset-y-0 right-0 w-full md:w-[600px] bg-white dark:bg-slate-950 border-l border-slate-200 dark:border-slate-800 shadow-2xl z-50 transform transition-transform duration-300 ease-in-out flex flex-col ${isDrawerOpen ? 'translate-x-0' : 'translate-x-full'}`}\r\n            >\r\n                {/* Drawer Header */}\r\n                <div className=\"px-6 py-4 border-b border-slate-100 dark:border-slate-800 flex items-center justify-between bg-white/50 dark:bg-slate-900/50 backdrop-blur-sm\">\r\n                    <h3 className=\"text-xl font-bold text-slate-900 dark:text-white\">\r\n                        {selectedGuide ? 'Editar Gu√≠a' : 'Nueva Gu√≠a'}\r\n                    </h3>\r\n                    <div className=\"flex items-center gap-2\">\r\n                        {selectedGuide?.id && (\r\n                            <button\r\n                                onClick={() => handleDelete(selectedGuide.id!)}\r\n                                className=\"p-2 text-rose-400 hover:text-rose-600 hover:bg-rose-50 dark:hover:bg-rose-900/10 rounded-lg transition-colors\"\r\n                                title=\"Eliminar Gu√≠a\"\r\n                            >\r\n                                <Trash2 className=\"w-5 h-5\" />\r\n                            </button>\r\n                        )}\r\n                        <button\r\n                            onClick={handleCloseDrawer}\r\n                            className=\"p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors\"\r\n                            title=\"Cerrar editor\"\r\n                        >\r\n                            <X className=\"w-6 h-6\" />\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Drawer Content - Scrollable */}\r\n                <div className=\"flex-1 overflow-y-auto p-8 space-y-8 custom-scrollbar\">\r\n\r\n                    {/* Live Preview Section (Sticky-ish feel) */}\r\n                    <div className=\"bg-slate-50 dark:bg-slate-900 rounded-3xl p-6 border border-slate-200 dark:border-slate-800 relative group overflow-hidden\">\r\n                        <div className=\"absolute top-3 left-1/2 -translate-x-1/2 px-3 py-1 bg-slate-200 dark:bg-slate-800 rounded-full text-[9px] font-bold uppercase tracking-widest text-slate-500\">Vista Previa</div>\r\n\r\n                        {/* Card Mockup */}\r\n                        <div className=\"mt-4 bg-white dark:bg-black/40 border border-slate-200 dark:border-slate-700/50 rounded-2xl p-5 shadow-sm relative overflow-hidden\">\r\n                            {/* Decorative Background Icon */}\r\n                            <div className=\"absolute -right-4 -top-4 opacity-5 pointer-events-none\">\r\n                                <PreviewIcon className={`w-32 h-32 ${themeStyles.text}`} />\r\n                            </div>\r\n\r\n                            <div className=\"flex justify-between items-start mb-4 relative z-10\">\r\n                                <div className={`w-12 h-12 rounded-xl ${themeStyles.bg} flex items-center justify-center`}>\r\n                                    <PreviewIcon className={`w-6 h-6 ${themeStyles.text}`} />\r\n                                </div>\r\n                                {formData.isCritical && (\r\n                                    <span className=\"bg-rose-500 text-white text-[9px] font-bold px-2 py-0.5 rounded-full uppercase shadow-sm\">\r\n                                        Cr√≠tico\r\n                                    </span>\r\n                                )}\r\n                            </div>\r\n\r\n                            <h4 className=\"text-lg font-bold text-slate-900 dark:text-white mb-2 leading-tight\">{formData.title || 'Tu T√≠tulo Aqu√≠'}</h4>\r\n                            <p className=\"text-xs text-slate-500 dark:text-slate-400 leading-relaxed font-medium\">{formData.description || 'La descripci√≥n de tu gu√≠a aparecer√° aqu√≠...'}</p>\r\n\r\n                            <div className=\"mt-4 pt-3 border-t border-dashed border-slate-200 dark:border-slate-800 flex items-center justify-between\">\r\n                                <span className={`text-[9px] font-bold uppercase ${themeStyles.text}`}>Ver Documento</span>\r\n                                <PlayCircle className={`w-4 h-4 ${themeStyles.text}`} />\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Form Fields */}\r\n                    <div className=\"space-y-6\">\r\n\r\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\r\n                            {/* Title */}\r\n                            <div className=\"md:col-span-2\">\r\n                                <label className=\"flex items-center gap-2 text-xs font-bold text-slate-500 uppercase tracking-widest mb-2\">\r\n                                    <Type className=\"w-3 h-3\" /> T√≠tulo\r\n                                </label>\r\n                                <input\r\n                                    type=\"text\"\r\n                                    value={formData.title}\r\n                                    onChange={e => setFormData({ ...formData, title: e.target.value })}\r\n                                    className=\"w-full px-4 py-3 rounded-xl bg-slate-50 dark:bg-slate-800 border-none focus:ring-2 focus:ring-indigo-500/50 font-bold text-slate-900 dark:text-white placeholder-slate-400 transition-all\"\r\n                                    placeholder=\"Ej: Protocolo de Apertura\"\r\n                                />\r\n                            </div>\r\n\r\n                            {/* Category */}\r\n                            <div>\r\n                                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2\">Categor√≠a</label>\r\n                                <select\r\n                                    value={formData.category}\r\n                                    onChange={e => setFormData({ ...formData, category: e.target.value })}\r\n                                    className=\"w-full px-4 py-3 rounded-xl bg-slate-50 dark:bg-slate-800 border-none font-bold text-sm text-slate-700 dark:text-slate-200\"\r\n                                    aria-label=\"Categor√≠a\"\r\n                                >\r\n                                    <option value=\"operativa\">Operativa</option>\r\n                                    <option value=\"tecnico\">T√©cnico</option>\r\n                                    <option value=\"accidente\">Accidentes</option>\r\n                                    <option value=\"rrhh\">Recursos Humanos</option>\r\n                                </select>\r\n                            </div>\r\n\r\n                            {/* Critical Toggle */}\r\n                            <div>\r\n                                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2\">Importancia</label>\r\n                                <button\r\n                                    onClick={() => setFormData({ ...formData, isCritical: !formData.isCritical })}\r\n                                    className={`w-full px-4 py-3 rounded-xl border transition-all flex items-center justify-center gap-2 font-bold text-sm uppercase tracking-wide ${formData.isCritical\r\n                                        ? 'bg-rose-50 dark:bg-rose-900/20 border-rose-200 dark:border-rose-800 text-rose-600 dark:text-rose-400'\r\n                                        : 'bg-slate-50 dark:bg-slate-800 border-transparent text-slate-400'\r\n                                        }`}\r\n                                >\r\n                                    {formData.isCritical ? <ShieldAlert className=\"w-4 h-4\" /> : <div className=\"w-4 h-4 rounded-full border-2 border-slate-300\" />}\r\n                                    {formData.isCritical ? 'Cr√≠tico' : 'Normal'}\r\n                                </button>\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Description */}\r\n                        <div>\r\n                            <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2\">Descripci√≥n</label>\r\n                            <textarea\r\n                                value={formData.description}\r\n                                onChange={e => setFormData({ ...formData, description: e.target.value })}\r\n                                rows={3}\r\n                                className=\"w-full px-4 py-3 rounded-xl bg-slate-50 dark:bg-slate-800 border-none focus:ring-2 focus:ring-indigo-500/50 text-sm font-medium text-slate-600 dark:text-slate-300 placeholder-slate-400 resize-none\"\r\n                                placeholder=\"Breve resumen del contenido...\"\r\n                            />\r\n                        </div>\r\n\r\n                        {/* URL */}\r\n                        <div>\r\n                            <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2\">Enlace de Destino</label>\r\n                            <input\r\n                                type=\"text\"\r\n                                value={formData.url}\r\n                                onChange={e => setFormData({ ...formData, url: e.target.value })}\r\n                                className=\"w-full px-4 py-3 rounded-xl bg-slate-50 dark:bg-slate-800 border-none font-medium text-sm text-blue-600 dark:text-blue-400\"\r\n                                placeholder=\"https://...\"\r\n                            />\r\n                        </div>\r\n\r\n                        {/* Visual Selectors */}\r\n                        <div className=\"space-y-4 pt-4 border-t border-slate-100 dark:border-slate-800\">\r\n\r\n                            {/* Color Theme */}\r\n                            <div>\r\n                                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-widest mb-3\">Color del Tema</label>\r\n                                <div className=\"flex flex-wrap gap-2\">\r\n                                    {Object.entries(GUIDE_THEMES).map(([key, theme]) => (\r\n                                        <button\r\n                                            key={key}\r\n                                            onClick={() => setFormData({ ...formData, theme: key as any })}\r\n                                            className={`w-8 h-8 rounded-full flex items-center justify-center transition-all ${formData.theme === key\r\n                                                ? 'ring-2 ring-offset-2 ring-indigo-500 scale-110'\r\n                                                : 'opacity-50 hover:opacity-100 hover:scale-105'\r\n                                                } ${theme.bg}`}\r\n                                            title={theme.label}\r\n                                        >\r\n                                            <div className={`w-3 h-3 rounded-full ${theme.bg.replace('bg-', 'bg-').replace('50', '500').replace('900/20', '500')}`} />\r\n                                        </button>\r\n                                    ))}\r\n                                </div>\r\n                            </div>\r\n\r\n                            {/* Icons - Horizontal Scroll */}\r\n                            <div>\r\n                                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-widest mb-3\">Icono</label>\r\n                                <div className=\"flex gap-2 overflow-x-auto pb-2 custom-scrollbar\">\r\n                                    {Object.entries(GUIDE_ICONS).map(([name, Icon]) => (\r\n                                        <button\r\n                                            key={name}\r\n                                            onClick={() => setFormData({ ...formData, icon: name as any })}\r\n                                            title={`Seleccionar icono ${name}`}\r\n                                            className={`shrink-0 w-10 h-10 rounded-xl flex items-center justify-center transition-all ${formData.icon === name\r\n                                                ? 'bg-slate-900 dark:bg-white text-white dark:text-slate-900 shadow-md transform -translate-y-1'\r\n                                                : 'bg-slate-50 dark:bg-slate-800 text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700'\r\n                                                }`}\r\n                                        >\r\n                                            <Icon className=\"w-5 h-5\" />\r\n                                        </button>\r\n                                    ))}\r\n                                </div>\r\n                            </div>\r\n\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"h-20\" /> {/* Spacer */}\r\n                </div>\r\n\r\n                {/* Drawer Footer */}\r\n                <div className=\"p-6 border-t border-slate-100 dark:border-slate-800 bg-white dark:bg-slate-900 flex justify-end gap-3 sticky bottom-0 z-10\">\r\n                    <button\r\n                        onClick={handleCloseDrawer}\r\n                        className=\"px-6 py-3 rounded-xl font-bold text-xs uppercase tracking-widest text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors\"\r\n                    >\r\n                        Cancelar\r\n                    </button>\r\n                    <button\r\n                        onClick={handleSave}\r\n                        className=\"px-8 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold uppercase tracking-widest shadow-lg shadow-indigo-500/20 hover:shadow-indigo-500/40 hover:-translate-y-0.5 transition-all flex items-center gap-2\"\r\n                    >\r\n                        <Save className=\"w-4 h-4\" />\r\n                        Guardar\r\n                    </button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default AdminGuidesPanel;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\overview\\OverviewTab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\resources\\RequestsInbox.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":25,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":25,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[686,689],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[686,689],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport {\r\n    Clock,\r\n    AlertCircle,\r\n    CheckCircle2,\r\n    XCircle,\r\n    FileText,\r\n    Paperclip,\r\n    Send,\r\n    Loader2,\r\n    UploadCloud\r\n} from 'lucide-react';\r\nimport { collection, query, orderBy, getDocs } from 'firebase/firestore';\r\nimport { db } from '../../../lib/firebase';\r\nimport { resourceRequestService, DocumentRequest } from '../../../services/resourceRequestService';\r\nimport { useAuth } from '../../../context/AuthContext';\r\n\r\nimport ResourceUploadModal from './ResourceUploadModal';\r\n\r\ninterface Resource {\r\n    id: string;\r\n    title?: string;\r\n    name?: string;\r\n    category?: string;\r\n    [key: string]: any;\r\n}\r\n\r\nconst RequestsInbox = () => {\r\n    const { user } = useAuth();\r\n    const [requests, setRequests] = useState<DocumentRequest[]>([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const [selectedRequest, setSelectedRequest] = useState<DocumentRequest | null>(null);\r\n\r\n    // Response State\r\n    const [isResponseModalOpen, setIsResponseModalOpen] = useState(false);\r\n    const [isUploadModalOpen, setIsUploadModalOpen] = useState(false);\r\n    const [responseType, setResponseType] = useState<'fulfill' | 'reject'>('fulfill');\r\n    const [resources, setResources] = useState<Resource[]>([]);\r\n    const [selectedResourceId, setSelectedResourceId] = useState('');\r\n    const [rejectionReason, setRejectionReason] = useState('');\r\n    const [isSubmitting, setIsSubmitting] = useState(false);\r\n\r\n    useEffect(() => {\r\n        loadRequests();\r\n        loadResources();\r\n    }, []);\r\n\r\n    const loadRequests = async () => {\r\n        // setLoading(true); // Don't block UI on refresh\r\n        const data = await resourceRequestService.getPendingRequests();\r\n        setRequests(data);\r\n        setLoading(false);\r\n    };\r\n\r\n    const loadResources = async () => {\r\n        const q = query(collection(db, 'resources'), orderBy('createdAt', 'desc'));\r\n        const snapshot = await getDocs(q);\r\n        setResources(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() } as Resource)));\r\n    };\r\n\r\n    const handleOpenResponse = (req: DocumentRequest) => {\r\n        setSelectedRequest(req);\r\n        setResponseType('fulfill');\r\n        setRejectionReason('');\r\n        setSelectedResourceId('');\r\n        setIsResponseModalOpen(true);\r\n    };\r\n\r\n    const handleUploadSuccess = async (resourceId?: string) => {\r\n        await loadResources();\r\n        if (resourceId) {\r\n            setSelectedResourceId(resourceId);\r\n        }\r\n    };\r\n\r\n    const handleSubmitResponse = async (e: React.FormEvent) => {\r\n        e.preventDefault();\r\n        if (!selectedRequest || !user) return;\r\n\r\n        setIsSubmitting(true);\r\n        try {\r\n            if (responseType === 'fulfill') {\r\n                if (!selectedResourceId) {\r\n                    alert(\"Debes seleccionar un archivo para adjuntar.\");\r\n                    setIsSubmitting(false);\r\n                    return;\r\n                }\r\n                const selectedRes = resources.find(r => r.id === selectedResourceId);\r\n                // Pass category name if possible in future service update\r\n                await resourceRequestService.fulfillRequest(selectedRequest.id, selectedResourceId, user.uid, selectedRes?.category);\r\n            } else {\r\n                if (!rejectionReason.trim()) {\r\n                    alert(\"Debes indicar un motivo para el rechazo.\");\r\n                    setIsSubmitting(false);\r\n                    return;\r\n                }\r\n                await resourceRequestService.rejectRequest(selectedRequest.id, rejectionReason, user.uid);\r\n            }\r\n\r\n            // Success\r\n            setIsResponseModalOpen(false);\r\n            loadRequests(); // Refresh list\r\n        } catch (error) {\r\n            console.error(\"Error submitting response:\", error);\r\n            alert(\"Error al procesar la respuesta.\");\r\n        } finally {\r\n            setIsSubmitting(false);\r\n        }\r\n    };\r\n\r\n    if (loading) {\r\n        return <div className=\"flex justify-center items-center h-64\"><Loader2 className=\"w-8 h-8 animate-spin text-indigo-500\" /></div>;\r\n    }\r\n\r\n    return (\r\n        <div className=\"p-6 h-full overflow-y-auto custom-scrollbar bg-slate-50 dark:bg-slate-950\">\r\n            <div className=\"max-w-5xl mx-auto\">\r\n                <div className=\"flex items-center justify-between mb-6\">\r\n                    <div>\r\n                        <h2 className=\"text-xl font-bold text-slate-900 dark:text-white flex items-center gap-2\">\r\n                            <span className=\"relative\">\r\n                                <FileText className=\"w-6 h-6 text-indigo-600\" />\r\n                                {requests.length > 0 && <span className=\"absolute -top-1 -right-1 w-2.5 h-2.5 bg-rose-500 rounded-full border-2 border-slate-50 dark:border-slate-950\" />}\r\n                            </span>\r\n                            Bandeja de Solicitudes\r\n                        </h2>\r\n                        <p className=\"text-sm text-slate-500 dark:text-slate-400\">Gestiona las peticiones de documentaci√≥n de las franquicias.</p>\r\n                    </div>\r\n                    <button title=\"Recargar solicitudes\" onClick={() => { setLoading(true); loadRequests(); }} className=\"p-2 hover:bg-slate-200 dark:hover:bg-slate-800 rounded-full transition-colors\">\r\n                        <Clock className=\"w-4 h-4 text-slate-400\" />\r\n                    </button>\r\n                </div>\r\n\r\n                {requests.length === 0 ? (\r\n                    <div className=\"text-center py-20 bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm\">\r\n                        <CheckCircle2 className=\"w-16 h-16 text-emerald-500 mx-auto mb-4 opacity-50\" />\r\n                        <h3 className=\"text-lg font-bold text-slate-700 dark:text-slate-300\">¬°Todo al d√≠a!</h3>\r\n                        <p className=\"text-slate-500 max-w-xs mx-auto\">No hay solicitudes pendientes de gestionar.</p>\r\n                    </div>\r\n                ) : (\r\n                    <div className=\"grid gap-4\">\r\n                        {requests.map(req => (\r\n                            <div key={req.id} className=\"bg-white dark:bg-slate-900 p-5 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm hover:shadow-md transition-shadow flex flex-col md:flex-row gap-4 justify-between items-start md:items-center\">\r\n                                <div className=\"flex-1\">\r\n                                    <div className=\"flex items-center gap-3 mb-2\">\r\n                                        {req.priority === 'urgent' ? (\r\n                                            <span className=\"bg-rose-100 text-rose-700 px-2 py-0.5 rounded-md text-[10px] font-bold border border-rose-200 flex items-center gap-1\">\r\n                                                <AlertCircle className=\"w-3 h-3\" /> URGENTE\r\n                                            </span>\r\n                                        ) : (\r\n                                            <span className=\"bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded-md text-[10px] font-bold border border-indigo-100\">\r\n                                                NORMAL\r\n                                            </span>\r\n                                        )}\r\n                                        <span className=\"text-xs font-mono text-slate-400\">\r\n                                            {req.createdAt?.seconds ? new Date(req.createdAt.seconds * 1000).toLocaleDateString() : 'Hoy'}\r\n                                        </span>\r\n                                        <span className=\"text-xs font-bold text-slate-700 dark:text-slate-300\">\r\n                                            {req.franchiseName}\r\n                                        </span>\r\n                                    </div>\r\n                                    <h4 className=\"font-bold text-slate-800 dark:text-slate-200 mb-1\">{req.explanation}</h4>\r\n                                    <p className=\"text-xs text-slate-500\">Categor√≠a solicitada: <span className=\"font-medium text-slate-700 dark:text-slate-300 uppercase\">{req.category}</span></p>\r\n                                </div>\r\n                                <button\r\n                                    onClick={() => handleOpenResponse(req)}\r\n                                    className=\"px-5 py-2.5 bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-bold rounded-xl shadow-lg shadow-indigo-500/20 active:scale-95 transition-all flex items-center gap-2 whitespace-nowrap\"\r\n                                >\r\n                                    <Send className=\"w-4 h-4\" />\r\n                                    Gestionar\r\n                                </button>\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n                )}\r\n            </div>\r\n\r\n            {/* Response Modal */}\r\n            {isResponseModalOpen && selectedRequest && (\r\n                <div className=\"fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm animate-in fade-in duration-200\" onClick={() => setIsResponseModalOpen(false)}>\r\n                    <div className=\"bg-white dark:bg-slate-900 w-full max-w-lg rounded-2xl shadow-2xl border border-slate-200 dark:border-slate-800 overflow-hidden\" onClick={e => e.stopPropagation()}>\r\n                        <div className=\"p-5 border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-950/50\">\r\n                            <h3 className=\"font-bold text-lg text-slate-800 dark:text-white\">Gestionar Solicitud</h3>\r\n                            <p className=\"text-xs text-slate-500\">Para: {selectedRequest.franchiseName}</p>\r\n                        </div>\r\n\r\n                        <form onSubmit={handleSubmitResponse} className=\"p-6 space-y-5\">\r\n                            <div className=\"flex bg-slate-100 dark:bg-slate-800 p-1 rounded-lg\">\r\n                                <button\r\n                                    type=\"button\"\r\n                                    onClick={() => setResponseType('fulfill')}\r\n                                    className={`flex-1 py-2 text-xs font-bold rounded-md transition-all flex items-center justify-center gap-2 ${responseType === 'fulfill'\r\n                                        ? 'bg-white dark:bg-slate-700 text-indigo-600 shadow-sm'\r\n                                        : 'text-slate-500 hover:text-slate-700'\r\n                                        }`}\r\n                                >\r\n                                    <Paperclip className=\"w-3 h-3\" />\r\n                                    Adjuntar Documento\r\n                                </button>\r\n                                <button\r\n                                    type=\"button\"\r\n                                    onClick={() => setResponseType('reject')}\r\n                                    className={`flex-1 py-2 text-xs font-bold rounded-md transition-all flex items-center justify-center gap-2 ${responseType === 'reject'\r\n                                        ? 'bg-white dark:bg-slate-700 text-rose-600 shadow-sm'\r\n                                        : 'text-slate-500 hover:text-slate-700'\r\n                                        }`}\r\n                                >\r\n                                    <XCircle className=\"w-3 h-3\" />\r\n                                    Rechazar Petici√≥n\r\n                                </button>\r\n                            </div>\r\n\r\n                            {responseType === 'fulfill' ? (\r\n                                <div className=\"space-y-4\">\r\n                                    <div className=\"space-y-2\">\r\n                                        <label htmlFor=\"resource-select\" className=\"text-xs font-bold text-slate-500 uppercase tracking-wide\">Seleccionar Documento</label>\r\n                                        <div className=\"flex gap-2\">\r\n                                            <select\r\n                                                id=\"resource-select\"\r\n                                                title=\"Seleccionar documento\"\r\n                                                value={selectedResourceId}\r\n                                                onChange={(e) => setSelectedResourceId(e.target.value)}\r\n                                                className=\"flex-1 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2.5 text-sm outline-none focus:ring-2 focus:ring-indigo-500/20 transition-all font-medium\"\r\n                                            >\r\n                                                <option value=\"\">-- Selecciona un archivo --</option>\r\n                                                {resources.map(res => (\r\n                                                    <option key={res.id} value={res.id}>{res.title || res.name}</option>\r\n                                                ))}\r\n                                            </select>\r\n                                            <button\r\n                                                type=\"button\"\r\n                                                onClick={() => setIsUploadModalOpen(true)}\r\n                                                className=\"bg-slate-100 dark:bg-slate-800 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 text-indigo-600 px-3 rounded-xl border border-slate-200 dark:border-slate-700 transition-colors\"\r\n                                                title=\"Subir nuevo archivo\"\r\n                                            >\r\n                                                <UploadCloud className=\"w-5 h-5\" />\r\n                                            </button>\r\n                                        </div>\r\n                                        <p className=\"text-[10px] text-slate-400\">\r\n                                            {selectedResourceId\r\n                                                ? \"Archivo seleccionado correctamente.\"\r\n                                                : \"Selecciona un archivo existente o sube uno nuevo.\"}\r\n                                        </p>\r\n                                    </div>\r\n                                    <div className=\"p-3 bg-indigo-50 dark:bg-indigo-900/10 border border-indigo-100 dark:border-indigo-800 rounded-lg\">\r\n                                        <p className=\"text-xs text-indigo-700 dark:text-indigo-300\">\r\n                                            <strong className=\"block mb-1\">Nota:</strong>\r\n                                            Al enviar, el franquiciado recibir√° una notificaci√≥n y podr√° acceder al documento desde su secci√≥n de &quot;Recursos&quot;.\r\n                                        </p>\r\n                                    </div>\r\n                                </div>\r\n                            ) : (\r\n                                <div className=\"space-y-2\">\r\n                                    <label className=\"text-xs font-bold text-slate-500 uppercase tracking-wide\">Motivo del Rechazo</label>\r\n                                    <textarea\r\n                                        value={rejectionReason}\r\n                                        onChange={(e) => setRejectionReason(e.target.value)}\r\n                                        placeholder=\"Explica por qu√© no se puede facilitar el documento...\"\r\n                                        className=\"w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-sm min-h-[100px] outline-none focus:ring-2 focus:ring-rose-500/20 transition-all resize-none\"\r\n                                    />\r\n                                </div>\r\n                            )}\r\n\r\n                            <div className=\"pt-2 flex justify-end gap-3\">\r\n                                <button\r\n                                    type=\"button\"\r\n                                    onClick={() => setIsResponseModalOpen(false)}\r\n                                    className=\"px-4 py-2 text-sm font-bold text-slate-500 hover:text-slate-700 transition-colors\"\r\n                                >\r\n                                    Cancelar\r\n                                </button>\r\n                                <button\r\n                                    type=\"submit\"\r\n                                    disabled={isSubmitting}\r\n                                    className={`px-6 py-2 text-white font-bold rounded-xl shadow-lg active:scale-95 transition-all flex items-center gap-2 ${responseType === 'fulfill'\r\n                                        ? 'bg-indigo-600 hover:bg-indigo-500 shadow-indigo-500/20'\r\n                                        : 'bg-rose-600 hover:bg-rose-500 shadow-rose-500/20'\r\n                                        }`}\r\n                                >\r\n                                    {isSubmitting ? <Loader2 className=\"w-4 h-4 animate-spin\" /> : <Send className=\"w-4 h-4\" />}\r\n                                    {responseType === 'fulfill' ? 'Enviar Documento' : 'Confirmar Rechazo'}\r\n                                </button>\r\n                            </div>\r\n                        </form>\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            <ResourceUploadModal\r\n                isOpen={isUploadModalOpen}\r\n                onClose={() => setIsUploadModalOpen(false)}\r\n                onSuccess={handleUploadSuccess}\r\n            />\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default RequestsInbox;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\resources\\ResourceUploadModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\roadmap\\CreateFeatureModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\roadmap\\EditFeatureModal.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":16,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":16,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[517,520],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[517,520],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":78,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":78,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2566,2569],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2566,2569],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\nimport { X, Trash2, Calendar, Tag } from 'lucide-react';\r\nimport { PREDEFINED_LABELS, getLabelColor } from '../../../constants/labels';\r\n\r\nimport FeatureComments from './FeatureComments';\r\n\r\ninterface EditFeatureModalProps {\r\n    isOpen: boolean;\r\n    onClose: () => void;\r\n    feature: {\r\n        id: string;\r\n        title: string;\r\n        description: string;\r\n        priority: 'low' | 'medium' | 'high';\r\n        status: 'proposed' | 'in_progress' | 'completed';\r\n        createdAt: any;\r\n        createdByEmail: string;\r\n        labels?: string[];\r\n\r\n\r\n    } | null;\r\n    onSave: (id: string, data: { title: string; description: string; priority: 'low' | 'medium' | 'high'; labels: string[] }) => Promise<void>;\r\n    onDelete: (id: string) => Promise<void>;\r\n}\r\n\r\nconst EditFeatureModal: React.FC<EditFeatureModalProps> = ({ isOpen, onClose, feature, onSave, onDelete }) => {\r\n    const [title, setTitle] = React.useState('');\r\n    const [description, setDescription] = React.useState('');\r\n    const [priority, setPriority] = React.useState<'low' | 'medium' | 'high'>('medium');\r\n    const [labels, setLabels] = React.useState<string[]>([]);\r\n    const [isSaving, setIsSaving] = React.useState(false);\r\n    const [isDeleting, setIsDeleting] = React.useState(false);\r\n    const [showDeleteConfirm, setShowDeleteConfirm] = React.useState(false);\r\n\r\n\r\n    React.useEffect(() => {\r\n        if (feature) {\r\n            setTitle(feature.title);\r\n            setDescription(feature.description);\r\n            setPriority(feature.priority);\r\n            setLabels(feature.labels || []);\r\n\r\n        }\r\n    }, [feature]);\r\n\r\n    const handleSave = async () => {\r\n        if (!feature || !title.trim() || !description.trim()) return;\r\n\r\n        setIsSaving(true);\r\n        try {\r\n            await onSave(feature.id, { title, description, priority, labels });\r\n            onClose();\r\n        } catch (error) {\r\n            console.error('Error saving:', error);\r\n            alert('Error al guardar');\r\n        } finally {\r\n            setIsSaving(false);\r\n        }\r\n    };\r\n\r\n    const handleDelete = async () => {\r\n        if (!feature) return;\r\n\r\n        setIsDeleting(true);\r\n        try {\r\n            await onDelete(feature.id);\r\n            onClose();\r\n        } catch (error) {\r\n            console.error('Error deleting:', error);\r\n            alert('Error al eliminar');\r\n        } finally {\r\n            setIsDeleting(false);\r\n        }\r\n    };\r\n\r\n    if (!isOpen || !feature) return null;\r\n\r\n    const formatDate = (timestamp: any) => {\r\n        if (!timestamp) return 'Reciente';\r\n        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);\r\n        return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });\r\n    };\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center p-4 animate-fade-in\" onClick={onClose}>\r\n            <div className=\"absolute inset-0 bg-black/80 backdrop-blur-sm\" />\r\n\r\n            <div\r\n                className=\"relative bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto animate-in zoom-in-95 duration-200\"\r\n                onClick={(e) => e.stopPropagation()}\r\n            >\r\n                {/* Header */}\r\n                <div className=\"flex items-center justify-between p-6 border-b border-slate-800\">\r\n                    <div>\r\n                        <h2 className=\"text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-cyan-400\">\r\n                            Editar Mejora\r\n                        </h2>\r\n                        <div className=\"flex items-center gap-3 mt-2 text-sm text-slate-400\">\r\n                            <span className=\"flex items-center gap-1\">\r\n                                <Calendar className=\"w-3 h-3\" />\r\n                                {formatDate(feature.createdAt)}\r\n                            </span>\r\n                            <span>‚Ä¢</span>\r\n                            <span>Por {feature.createdByEmail}</span>\r\n                        </div>\r\n                    </div>\r\n                    <button\r\n                        onClick={onClose}\r\n                        className=\"p-2 hover:bg-slate-800 rounded-lg transition-colors\"\r\n                        title=\"Cerrar\"\r\n                    >\r\n                        <X className=\"w-5 h-5 text-slate-400\" />\r\n                    </button>\r\n                </div>\r\n\r\n                {/* Form */}\r\n                <div className=\"p-6 space-y-6\">\r\n                    {/* Title */}\r\n                    <div>\r\n                        <label htmlFor=\"feature-title\" className=\"block text-sm font-bold text-slate-300 mb-2\">\r\n                            T√≠tulo <span className=\"text-red-400\">*</span>\r\n                        </label>\r\n                        <input\r\n                            id=\"feature-title\"\r\n                            type=\"text\"\r\n                            value={title}\r\n                            onChange={(e) => setTitle(e.target.value)}\r\n                            className=\"w-full bg-slate-800 border border-slate-700 text-slate-100 px-4 py-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500\"\r\n                            maxLength={100}\r\n                        />\r\n                        <p className=\"text-xs text-slate-500 mt-1\">{title.length}/100 caracteres</p>\r\n                    </div>\r\n\r\n                    {/* Description */}\r\n                    <div>\r\n                        <label htmlFor=\"feature-description\" className=\"block text-sm font-bold text-slate-300 mb-2\">\r\n                            Descripci√≥n <span className=\"text-red-400\">*</span>\r\n                        </label>\r\n                        <textarea\r\n                            id=\"feature-description\"\r\n                            value={description}\r\n                            onChange={(e) => setDescription(e.target.value)}\r\n                            rows={6}\r\n                            className=\"w-full bg-slate-800 border border-slate-700 text-slate-100 px-4 py-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-none\"\r\n                            maxLength={500}\r\n                        />\r\n                        <p className=\"text-xs text-slate-500 mt-1\">{description.length}/500 caracteres</p>\r\n                    </div>\r\n\r\n                    {/* Priority */}\r\n                    <div>\r\n                        <label className=\"block text-sm font-bold text-slate-300 mb-2\">\r\n                            Prioridad\r\n                        </label>\r\n                        <div className=\"grid grid-cols-3 gap-3\">\r\n                            {(['low', 'medium', 'high'] as const).map((p) => {\r\n                                const labels = { low: 'üü¢ Baja', medium: 'üü° Media', high: 'üî¥ Alta' };\r\n                                const colors = {\r\n                                    low: priority === 'low' ? 'bg-emerald-500/10 border-emerald-500 text-emerald-400' : 'bg-slate-800 border-slate-700 text-slate-400 hover:border-slate-600',\r\n                                    medium: priority === 'medium' ? 'bg-amber-500/10 border-amber-500 text-amber-400' : 'bg-slate-800 border-slate-700 text-slate-400 hover:border-slate-600',\r\n                                    high: priority === 'high' ? 'bg-red-500/10 border-red-500 text-red-400' : 'bg-slate-800 border-slate-700 text-slate-400 hover:border-slate-600'\r\n                                };\r\n\r\n                                return (\r\n                                    <button\r\n                                        key={p}\r\n                                        type=\"button\"\r\n                                        onClick={() => setPriority(p)}\r\n                                        className={`px-4 py-3 rounded-lg border-2 font-bold text-sm transition-all ${colors[p]}`}\r\n                                    >\r\n                                        {labels[p]}\r\n                                    </button>\r\n                                );\r\n                            })}\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Labels */}\r\n                    <div>\r\n                        <label className=\"block text-sm font-bold text-slate-300 mb-2\">\r\n                            <Tag className=\"w-4 h-4 inline mr-2\" />\r\n                            Etiquetas\r\n                        </label>\r\n                        <div className=\"flex flex-wrap gap-2\">\r\n                            {PREDEFINED_LABELS.map((label) => {\r\n                                const isSelected = labels.includes(label.id);\r\n                                const color = getLabelColor(label.id);\r\n\r\n                                return (\r\n                                    <button\r\n                                        key={label.id}\r\n                                        type=\"button\"\r\n                                        onClick={() => {\r\n                                            if (isSelected) {\r\n                                                setLabels(labels.filter(l => l !== label.id));\r\n                                            } else {\r\n                                                setLabels([...labels, label.id]);\r\n                                            }\r\n                                        }}\r\n                                        className={`px-4 py-2 rounded-lg border-2 font-bold text-sm transition-all ${isSelected\r\n                                            ? `${color} border-current`\r\n                                            : 'bg-slate-800 border-slate-700 text-slate-400 hover:border-slate-600'\r\n                                            }`}\r\n                                    >\r\n                                        {label.emoji} {label.label}\r\n                                    </button>\r\n                                );\r\n                            })}\r\n                        </div>\r\n                        {labels.length > 0 && (\r\n                            <p className=\"text-xs text-slate-500 mt-2\">\r\n                                {labels.length} etiqueta{labels.length > 1 ? 's' : ''} seleccionada{labels.length > 1 ? 's' : ''}\r\n                            </p>\r\n                        )}\r\n                    </div>\r\n\r\n\r\n                </div>\r\n\r\n                {/* Comments Section */}\r\n                <div className=\"px-6 pb-6\">\r\n                    <FeatureComments featureId={feature.id} />\r\n                </div>\r\n            </div>\r\n\r\n            {/* Actions */}\r\n            <div className=\"flex items-center justify-between p-6 border-t border-slate-800 bg-slate-900/50\">\r\n                {!showDeleteConfirm ? (\r\n                    <button\r\n                        onClick={() => setShowDeleteConfirm(true)}\r\n                        className=\"flex items-center gap-2 px-4 py-2 text-red-400 hover:bg-red-500/10 rounded-lg transition-colors font-medium\"\r\n                    >\r\n                        <Trash2 className=\"w-4 h-4\" />\r\n                        Eliminar\r\n                    </button>\r\n                ) : (\r\n                    <div className=\"flex items-center gap-3\">\r\n                        <p className=\"text-sm text-slate-400\">¬øSeguro?</p>\r\n                        <button\r\n                            onClick={handleDelete}\r\n                            disabled={isDeleting}\r\n                            className=\"px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-bold transition-colors disabled:opacity-50\"\r\n                        >\r\n                            {isDeleting ? 'Eliminando...' : 'S√≠, eliminar'}\r\n                        </button>\r\n                        <button\r\n                            onClick={() => setShowDeleteConfirm(false)}\r\n                            className=\"px-4 py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded-lg font-medium transition-colors\"\r\n                        >\r\n                            Cancelar\r\n                        </button>\r\n                    </div>\r\n                )}\r\n\r\n                <div className=\"flex items-center gap-3\">\r\n                    <button\r\n                        onClick={onClose}\r\n                        className=\"px-6 py-2.5 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-lg font-medium transition-colors\"\r\n                    >\r\n                        Cancelar\r\n                    </button>\r\n                    <button\r\n                        onClick={handleSave}\r\n                        disabled={isSaving || !title.trim() || !description.trim()}\r\n                        className=\"px-6 py-2.5 bg-gradient-to-r from-indigo-600 to-cyan-600 hover:from-indigo-500 hover:to-cyan-500 text-white rounded-lg font-bold shadow-lg shadow-indigo-500/20 transition-all disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                    >\r\n                        {isSaving ? 'Guardando...' : 'Guardar Cambios'}\r\n                    </button>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Delete Confirmation Backdrop */}\r\n            {showDeleteConfirm && (\r\n                <div className=\"absolute inset-0 bg-black/20 backdrop-blur-[2px] rounded-2xl pointer-events-none\" />\r\n            )}\r\n        </div>\r\n\r\n    );\r\n};\r\n\r\nexport default EditFeatureModal;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\roadmap\\FeatureBoard.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'toast'. Either include it or remove the dependency array.","line":82,"column":8,"nodeType":"ArrayExpression","endLine":82,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [isAdmin, toast]","fix":{"range":[3304,3313],"text":"[isAdmin, toast]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { db } from '../../../lib/firebase';\r\n\r\nimport { collection, query, orderBy, onSnapshot, addDoc, updateDoc, deleteDoc, doc, serverTimestamp, Timestamp, FieldValue } from 'firebase/firestore';\r\nimport { useAuth } from '../../../context/AuthContext';\r\n\r\nimport { Kanban, Plus, Loader2, Search, X } from 'lucide-react';\r\nimport { DndContext, DragEndEvent, DragOverlay, PointerSensor, useSensor, useSensors } from '@dnd-kit/core';\r\nimport FeatureCard from './FeatureCard';\r\nimport CreateFeatureModal from './CreateFeatureModal';\r\nimport EditFeatureModal from './EditFeatureModal';\r\n\r\ninterface FeatureRequest {\r\n    id: string;\r\n    title: string;\r\n    description: string;\r\n    status: 'proposed' | 'in_progress' | 'completed';\r\n    priority: 'low' | 'medium' | 'high';\r\n    createdBy: string;\r\n    createdByEmail: string;\r\n    createdAt: Timestamp | FieldValue;\r\n    updatedAt: Timestamp | FieldValue;\r\n    labels?: string[];\r\n    votes?: number;\r\n    votedBy?: string[];\r\n}\r\n\r\ntype NewFeatureData = Omit<FeatureRequest, 'id' | 'status' | 'createdBy' | 'createdByEmail' | 'createdAt' | 'updatedAt' | 'votes' | 'votedBy'>;\r\n\r\nconst COLUMNS = [\r\n    { id: 'proposed', title: 'üìã Propuesto', color: 'from-slate-500 to-slate-600' },\r\n    { id: 'in_progress', title: 'üî® En Desarrollo', color: 'from-amber-500 to-orange-600' },\r\n    { id: 'completed', title: '‚úÖ Completado', color: 'from-emerald-500 to-green-600' }\r\n] as const;\r\n\r\nimport { useToast } from '../../../hooks/useToast';\r\n\r\nimport confetti from 'canvas-confetti';\r\n\r\nconst FeatureBoard: React.FC = () => {\r\n    const { user, isAdmin } = useAuth();\r\n    const toastContext = useToast();\r\n    const toast = toastContext?.toast;\r\n    const [features, setFeatures] = useState<FeatureRequest[]>([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const [searchQuery, setSearchQuery] = useState('');\r\n    const [priorityFilter, setPriorityFilter] = useState<'all' | 'low' | 'medium' | 'high'>('all');\r\n    const [isCreateModalOpen, setIsCreateModalOpen] = useState(false);\r\n    const [editingFeature, setEditingFeature] = useState<FeatureRequest | null>(null);\r\n    const [activeId, setActiveId] = useState<string | null>(null);\r\n\r\n    const sensors = useSensors(\r\n        useSensor(PointerSensor, {\r\n            activationConstraint: {\r\n                distance: 8,\r\n            },\r\n        })\r\n    );\r\n\r\n    useEffect(() => {\r\n        // SECURITY: Only fetch if Admin. Double check client-side.\r\n        if (!isAdmin) {\r\n            const timer = setTimeout(() => setLoading(false), 0);\r\n            return () => clearTimeout(timer);\r\n        }\r\n\r\n        const q = query(collection(db, 'feature_requests'), orderBy('createdAt', 'desc'));\r\n        const unsubscribe = onSnapshot(q, (snapshot) => {\r\n            const featuresData = snapshot.docs.map(doc => ({\r\n                id: doc.id,\r\n                ...doc.data()\r\n            })) as FeatureRequest[];\r\n            setFeatures(featuresData);\r\n            setLoading(false);\r\n        }, (err) => {\r\n            console.error(\"Error fetching feature_requests:\", err);\r\n            toast?.error(\"Error de permisos cargando el roadmap.\");\r\n            setLoading(false);\r\n        });\r\n\r\n        return () => unsubscribe();\r\n    }, [isAdmin]);\r\n\r\n    const handleCreateFeature = async (featureData: NewFeatureData) => {\r\n        try {\r\n            await addDoc(collection(db, 'feature_requests'), {\r\n                ...featureData,\r\n                status: 'proposed',\r\n                // SIMPLIFICATION: Use auth object directly, no extra DB lookups\r\n                createdBy: user?.displayName || 'Admin',\r\n                createdByEmail: user?.email || 'admin@antigravity.com',\r\n                createdAt: serverTimestamp(),\r\n                updatedAt: serverTimestamp(),\r\n                votes: 0,\r\n                votedBy: []\r\n            });\r\n            toast?.success('Mejora propuesta creada');\r\n            setIsCreateModalOpen(false);\r\n        } catch (error) {\r\n            console.error('Error creating feature:', error);\r\n            toast?.error('Error al crear la mejora');\r\n        }\r\n    };\r\n\r\n    const handleUpdateFeature = async (featureId: string, updates: Partial<FeatureRequest>) => {\r\n        try {\r\n            await updateDoc(doc(db, 'feature_requests', featureId), {\r\n                ...updates,\r\n                updatedAt: serverTimestamp()\r\n            });\r\n            toast?.success('Mejora actualizada');\r\n            setEditingFeature(null);\r\n        } catch (error) {\r\n            console.error('Error updating feature:', error);\r\n            toast?.error('Error al actualizar');\r\n        }\r\n    };\r\n\r\n    const handleDeleteFeature = async (featureId: string) => {\r\n        if (!window.confirm(\"¬øSeguro que quieres eliminar esta tarjeta?\")) return;\r\n        try {\r\n            await deleteDoc(doc(db, 'feature_requests', featureId));\r\n            toast?.success('Mejora eliminada');\r\n            setEditingFeature(null);\r\n        } catch (error) {\r\n            console.error('Error deleting feature:', error);\r\n            toast?.error('Error al eliminar');\r\n        }\r\n    };\r\n\r\n    const handleStatusChange = async (featureId: string, newStatus: 'proposed' | 'in_progress' | 'completed') => {\r\n        try {\r\n            await updateDoc(doc(db, 'feature_requests', featureId), {\r\n                status: newStatus,\r\n                updatedAt: serverTimestamp()\r\n            });\r\n\r\n            // UX Feedback\r\n            const statusLabel = COLUMNS.find(c => c.id === newStatus)?.title;\r\n            toast?.success(`Movido a ${statusLabel}`);\r\n\r\n            if (newStatus === 'completed') {\r\n                confetti({\r\n                    particleCount: 100,\r\n                    spread: 70,\r\n                    origin: { y: 0.6 }\r\n                });\r\n            }\r\n\r\n        } catch (error) {\r\n            console.error('Error updating status:', error);\r\n            toast?.error('Error al actualizar el estado');\r\n        }\r\n    };\r\n\r\n    const handleDragStart = (event: DragEndEvent) => {\r\n        setActiveId(event.active.id as string);\r\n        document.body.style.cursor = 'grabbing';\r\n    };\r\n\r\n    const handleDragEnd = (event: DragEndEvent) => {\r\n        const { active, over } = event;\r\n        setActiveId(null);\r\n        document.body.style.cursor = '';\r\n\r\n        if (!over) return;\r\n\r\n        const featureId = active.id as string;\r\n        const newStatus = over.id as 'proposed' | 'in_progress' | 'completed';\r\n\r\n        const feature = features.find(f => f.id === featureId);\r\n        if (feature && feature.status !== newStatus) {\r\n            handleStatusChange(featureId, newStatus);\r\n        }\r\n    };\r\n\r\n    const getFeaturesByStatus = (status: 'proposed' | 'in_progress' | 'completed') => {\r\n        return features.filter(feature => {\r\n            const matchesStatus = feature.status === status;\r\n            const matchesSearch = feature.title.toLowerCase().includes(searchQuery.toLowerCase()) ||\r\n                feature.description.toLowerCase().includes(searchQuery.toLowerCase());\r\n            const matchesPriority = priorityFilter === 'all' || feature.priority === priorityFilter;\r\n\r\n            return matchesStatus && matchesSearch && matchesPriority;\r\n        });\r\n    };\r\n\r\n    const activeFeature = activeId ? features.find(f => f.id === activeId) : null;\r\n\r\n    if (loading) {\r\n        return (\r\n            <div className=\"flex items-center justify-center min-h-[400px]\">\r\n                <Loader2 className=\"w-8 h-8 text-indigo-500 animate-spin\" />\r\n            </div>\r\n        );\r\n    }\r\n\r\n    if (!isAdmin) return null;\r\n\r\n    return (\r\n        <DndContext sensors={sensors} onDragStart={handleDragStart} onDragEnd={handleDragEnd}>\r\n            <div className=\"min-h-screen bg-slate-950 p-4 md:p-8\">\r\n                {/* Header Simple (Admin Only) */}\r\n                <div className=\"mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4\">\r\n                    <div>\r\n                        <h1 className=\"text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-cyan-400 flex items-center\">\r\n                            <Kanban className=\"w-8 h-8 mr-3 text-indigo-400\" />\r\n                            Roadmap (Admin)\r\n                        </h1>\r\n                        <p className=\"text-slate-500 text-sm mt-1\">\r\n                            Gesti√≥n interna de funcionalidades.\r\n                        </p>\r\n                    </div>\r\n\r\n                    <button\r\n                        onClick={() => setIsCreateModalOpen(true)}\r\n                        className=\"flex items-center gap-2 px-6 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg shadow-lg shadow-indigo-500/20 transition-all font-bold\"\r\n                    >\r\n                        <Plus className=\"w-4 h-4\" />\r\n                        Nueva Tarea\r\n                    </button>\r\n                </div>\r\n\r\n                {/* Filters */}\r\n                <div className=\"mb-6 flex flex-wrap gap-4 items-center bg-slate-900/50 p-3 rounded-xl border border-slate-800\">\r\n                    <div className=\"relative flex-1 min-w-[200px]\">\r\n                        <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500\" />\r\n                        <input\r\n                            type=\"text\"\r\n                            value={searchQuery}\r\n                            onChange={(e) => setSearchQuery(e.target.value)}\r\n                            placeholder=\"Buscar...\"\r\n                            className=\"w-full bg-slate-950 border border-slate-700 text-slate-200 pl-9 pr-4 py-2 rounded-lg text-sm focus:outline-none focus:border-indigo-500\"\r\n                        />\r\n                        {searchQuery && (\r\n                            <button\r\n                                className=\"absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 hover:text-white\"\r\n                                title=\"Limpiar b√∫squeda\"\r\n                                aria-label=\"Limpiar b√∫squeda\"\r\n                            >\r\n                                <X className=\"w-3 h-3\" />\r\n                            </button>\r\n                        )}\r\n                    </div>\r\n\r\n                    <div className=\"flex gap-2\">\r\n                        {(['all', 'high', 'medium', 'low'] as const).map(p => (\r\n                            <button\r\n                                key={p}\r\n                                onClick={() => setPriorityFilter(p)}\r\n                                className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-colors border ${priorityFilter === p\r\n                                    ? 'bg-indigo-600/20 border-indigo-500 text-indigo-300'\r\n                                    : 'bg-slate-950 border-slate-700 text-slate-500 hover:border-slate-500'\r\n                                    }`}\r\n                            >\r\n                                {p === 'all' && 'Todos'}\r\n                                {p === 'high' && 'Alta'}\r\n                                {p === 'medium' && 'Media'}\r\n                                {p === 'low' && 'Baja'}\r\n                            </button>\r\n                        ))}\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Kanban Board */}\r\n                <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\r\n                    {COLUMNS.map(column => {\r\n                        const columnFeatures = getFeaturesByStatus(column.id);\r\n\r\n                        return (\r\n                            <div key={column.id} className=\"flex flex-col h-full\">\r\n                                {/* Column Header */}\r\n                                <div className={`bg-gradient-to-r ${column.color} p-3 rounded-t-xl shadow-lg flex justify-between items-center`}>\r\n                                    <h2 className=\"text-white font-bold text-sm\">\r\n                                        {column.title}\r\n                                    </h2>\r\n                                    <span className=\"bg-black/20 text-white/90 px-2 py-0.5 rounded text-[10px] font-black uppercase tracking-widest\">\r\n                                        {columnFeatures.length}\r\n                                    </span>\r\n                                </div>\r\n\r\n                                {/* Column Content */}\r\n                                <div\r\n                                    className=\"flex-1 bg-slate-900/30 border-x border-b border-slate-800 rounded-b-xl p-3 space-y-3 min-h-[400px]\"\r\n                                >\r\n                                    {columnFeatures.length === 0 ? (\r\n                                        <div className=\"flex flex-col items-center justify-center h-40 text-slate-600 border-2 border-dashed border-slate-800 rounded-lg\">\r\n                                            <p className=\"text-xs\">Vac√≠o</p>\r\n                                        </div>\r\n                                    ) : (\r\n                                        columnFeatures.map(feature => (\r\n                                            <div\r\n                                                key={feature.id}\r\n                                                onClick={() => setEditingFeature(feature)}\r\n                                                className=\"cursor-pointer hover:opacity-90 active:scale-[0.98] transition-all\"\r\n                                            >\r\n                                                <FeatureCard\r\n                                                    feature={feature}\r\n                                                    onStatusChange={handleStatusChange}\r\n                                                />\r\n                                            </div>\r\n                                        ))\r\n                                    )}\r\n                                </div>\r\n                            </div>\r\n                        );\r\n                    })}\r\n                </div>\r\n\r\n                {/* Create Modal */}\r\n                <CreateFeatureModal\r\n                    isOpen={isCreateModalOpen}\r\n                    onClose={() => setIsCreateModalOpen(false)}\r\n                    onCreate={handleCreateFeature}\r\n                />\r\n\r\n                {/* Edit Modal */}\r\n                <EditFeatureModal\r\n                    isOpen={!!editingFeature}\r\n                    onClose={() => setEditingFeature(null)}\r\n                    feature={editingFeature}\r\n                    onSave={handleUpdateFeature}\r\n                    onDelete={handleDeleteFeature}\r\n                />\r\n            </div>\r\n\r\n            {/* Drag Overlay */}\r\n            <DragOverlay dropAnimation={null}>\r\n                {activeFeature ? (\r\n                    <div className=\"opacity-80 rotate-3 cursor-grabbing w-[300px]\">\r\n                        <FeatureCard feature={activeFeature} onStatusChange={() => { }} />\r\n                    </div>\r\n                ) : null}\r\n            </DragOverlay>\r\n        </DndContext >\r\n    );\r\n};\r\n\r\nexport default FeatureBoard;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\roadmap\\FeatureCard.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":13,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":13,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[408,411],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[408,411],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":14,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":14,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[429,432],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[429,432],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":43,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":43,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1290,1293],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1290,1293],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":103,"column":79,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":103,"endColumn":82,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4029,4032],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4029,4032],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\nimport { Clock, User } from 'lucide-react';\r\nimport { getLabelDisplay, getLabelColor } from '../../../constants/labels';\r\n\r\ninterface FeatureRequest {\r\n    id: string;\r\n    title: string;\r\n    description: string;\r\n    status: 'proposed' | 'in_progress' | 'completed';\r\n    priority: 'low' | 'medium' | 'high';\r\n    createdBy: string;\r\n    createdByEmail: string;\r\n    createdAt: any;\r\n    updatedAt: any;\r\n    labels?: string[];\r\n    assignedTo?: string;\r\n}\r\n\r\ninterface FeatureCardProps {\r\n    feature: FeatureRequest;\r\n    onStatusChange: (id: string, newStatus: 'proposed' | 'in_progress' | 'completed') => void;\r\n}\r\n\r\nconst PRIORITY_STYLES = {\r\n    high: 'bg-red-500/10 text-red-400 border-red-500/20',\r\n    medium: 'bg-amber-500/10 text-amber-400 border-amber-500/20',\r\n    low: 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20'\r\n};\r\n\r\nconst PRIORITY_LABELS = {\r\n    high: 'üî¥ Alta',\r\n    medium: 'üü° Media',\r\n    low: 'üü¢ Baja'\r\n};\r\n\r\nconst STATUS_OPTIONS = [\r\n    { value: 'proposed', label: 'üìã Propuesto' },\r\n    { value: 'in_progress', label: 'üî® En Desarrollo' },\r\n    { value: 'completed', label: '‚úÖ Completado' }\r\n];\r\n\r\nconst FeatureCard: React.FC<FeatureCardProps> = ({ feature, onStatusChange }) => {\r\n    const formatDate = (timestamp: any) => {\r\n        if (!timestamp) return 'Reciente';\r\n        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);\r\n        return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });\r\n    };\r\n\r\n    return (\r\n        <div className=\"glass-panel-exec p-4 rounded-xl border border-slate-700/50 hover:border-indigo-500/50 transition-all group\">\r\n            {/* Priority Badge */}\r\n            <div className=\"mb-3\">\r\n                <span className={`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold border ${PRIORITY_STYLES[feature.priority]}`}>\r\n                    {PRIORITY_LABELS[feature.priority]}\r\n                </span>\r\n            </div>\r\n\r\n            {/* Title */}\r\n            <h3 className=\"text-slate-100 font-bold text-base mb-2 line-clamp-2\">\r\n                {feature.title}\r\n            </h3>\r\n\r\n            {/* Description */}\r\n            <p className=\"text-slate-400 text-sm mb-3 line-clamp-3\">\r\n                {feature.description}\r\n            </p>\r\n\r\n            {/* Labels */}\r\n            {feature.labels && feature.labels.length > 0 && (\r\n                <div className=\"flex flex-wrap gap-1.5 mb-3\">\r\n                    {feature.labels.slice(0, 3).map(labelId => (\r\n                        <span\r\n                            key={labelId}\r\n                            className={`inline-flex items-center px-2 py-0.5 rounded-md text-[10px] font-bold border ${getLabelColor(labelId)}`}\r\n                        >\r\n                            {getLabelDisplay(labelId)}\r\n                        </span>\r\n                    ))}\r\n                    {feature.labels.length > 3 && (\r\n                        <span className=\"inline-flex items-center px-2 py-0.5 rounded-md text-[10px] font-bold bg-slate-800 text-slate-400 border border-slate-700\">\r\n                            +{feature.labels.length - 3}\r\n                        </span>\r\n                    )}\r\n                </div>\r\n            )}\r\n\r\n            {/* Footer */}\r\n            <div className=\"flex items-center justify-between text-xs text-slate-500 mb-3\">\r\n                <div className=\"flex items-center gap-1\">\r\n                    <User className=\"w-3 h-3\" />\r\n                    <span className=\"truncate max-w-[120px]\">{feature.createdByEmail}</span>\r\n\r\n                </div>\r\n                <div className=\"flex items-center gap-1\">\r\n                    <Clock className=\"w-3 h-3\" />\r\n                    <span>{formatDate(feature.createdAt)}</span>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Status Selector */}\r\n            <select\r\n                value={feature.status}\r\n                onChange={(e) => onStatusChange(feature.id, e.target.value as any)}\r\n                className=\"w-full bg-slate-800 border border-slate-700 text-slate-200 text-sm rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 cursor-pointer hover:bg-slate-700 transition-colors\"\r\n                aria-label=\"Cambiar estado de la mejora\"\r\n            >\r\n                {STATUS_OPTIONS.map(option => (\r\n                    <option key={option.value} value={option.value}>\r\n                        {option.label}\r\n                    </option>\r\n                ))}\r\n            </select>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default FeatureCard;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\roadmap\\FeatureComments.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\services\\ServiceManager.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\settings\\FranchiseProfile.d.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":3,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":3,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[75,78],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[75,78],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\n\r\ndeclare const Component: React.ComponentType<any>;\r\nexport default Component;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\settings\\FranchiseProfile.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":136,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":136,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4914,4917],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4914,4917],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":136,"column":68,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":136,"endColumn":71,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4941,4944],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4941,4944],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":137,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":137,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5015,5018],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5015,5018],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":138,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":138,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5088,5091],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5088,5091],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":158,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":158,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6036,6039],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6036,6039],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":184,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":184,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7105,7108],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7105,7108],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":292,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":292,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11841,11844],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11841,11844],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":381,"column":71,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":381,"endColumn":74,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16720,16723],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16720,16723],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useContext, useEffect, useRef } from 'react';\r\nimport { ToastContext } from '../../../context/contexts';\r\n// import { useNavigate } from 'react-router-dom';\r\nimport { useForm, useFieldArray, SubmitHandler } from 'react-hook-form';\r\nimport {\r\n    Building, MapPin, Save, User, Camera,\r\n    Mail, Phone, Shield, Trash2, Plus, DollarSign, Lock\r\n} from 'lucide-react';\r\nimport { useAuth } from '../../../context/AuthContext';\r\nimport { userService, UserProfile } from '../../../services/userService';\r\nimport { updateProfile } from 'firebase/auth';\r\nimport { doc, setDoc, getDoc } from 'firebase/firestore';\r\nimport { ref, uploadBytes, getDownloadURL } from 'firebase/storage';\r\nimport { db, storage } from '../../../lib/firebase';\r\nimport { notificationService } from '../../../services/notificationService';\r\nimport PremiumBanner from '../../../components/common/PremiumBanner';\r\n\r\n// --- INTERFACES ---\r\n\r\ninterface LogisticsRate {\r\n    id?: string;\r\n    min: number;\r\n    max: number;\r\n    price: number;\r\n    name: string;\r\n}\r\n\r\n\r\n\r\ninterface FranchiseProfileFormData {\r\n    // Franchise Data\r\n    legalName: string;\r\n    name: string;\r\n    cif: string;\r\n    city: string; // New field for specific location\r\n    address: string;\r\n    email: string; // Business Email\r\n    phone: string; // Business Phone\r\n    role: string;\r\n    franchiseId: string;\r\n    pack: 'basic' | 'premium';\r\n    zipCodes: string[];\r\n    logisticsRates: LogisticsRate[];\r\n\r\n\r\n    // User Data (Personal)\r\n    userDisplayName: string;\r\n    userPhone: string;\r\n    userPhotoURL: string;\r\n}\r\n\r\n\r\n\r\ninterface FranchiseProfileProps {\r\n    franchiseId?: string;\r\n    readOnly?: boolean;\r\n}\r\n\r\nconst FranchiseProfile: React.FC<FranchiseProfileProps> = ({ franchiseId }) => {\r\n    const { user, isAdmin } = useAuth();\r\n    const { addToast } = useContext(ToastContext) || { addToast: () => { } };\r\n    // const navigate = useNavigate(); // Removed unused\r\n\r\n    // If no franchiseId provided, we assume we are editing the current user's franchise profile\r\n    // But if we are an admin editing another franchise, we might not want to edit *that user's personal profile* \r\n    // (admins usually edit franchise data, not the personal user data of the owner unless specified).\r\n    // For this unification, if franchiseId is provided (Admin View), we hide the \"User\" tab to avoid confusion.\r\n    const isSelfProfile = !franchiseId || franchiseId === user?.uid;\r\n\r\n    const [activeTab, setActiveTab] = useState('user'); // Default to User for a personal feel\r\n    const [loading, setLoading] = useState(false);\r\n    const fileInputRef = useRef<HTMLInputElement>(null);\r\n    const initialRatesRef = useRef<LogisticsRate[]>([]);\r\n\r\n    // --- RHF CONFIGURATION ---\r\n    const { register, control, handleSubmit, reset, watch, setValue, getValues, formState: { isDirty } } = useForm<FranchiseProfileFormData>({\r\n        defaultValues: {\r\n            legalName: '',\r\n            name: '',\r\n            cif: '',\r\n            city: '',\r\n            address: '',\r\n            email: '',\r\n            phone: '',\r\n            role: 'franchise',\r\n            franchiseId: '',\r\n            pack: 'basic',\r\n            zipCodes: [],\r\n            logisticsRates: [],\r\n\r\n            userDisplayName: '',\r\n            userPhone: '',\r\n            userPhotoURL: ''\r\n        }\r\n    });\r\n\r\n    const { fields: rateFields, append: appendRate, remove: removeRate } = useFieldArray({\r\n        control,\r\n        name: \"logisticsRates\" as const\r\n    });\r\n\r\n    const watchedUserPhoto = watch('userPhotoURL');\r\n\r\n    // --- LOAD DATA ---\r\n    useEffect(() => {\r\n        const loadProfile = async () => {\r\n            const targetId = franchiseId || user?.uid;\r\n            if (!targetId) return;\r\n\r\n            try {\r\n                // 1. Load Franchise Data\r\n                const franchiseData = await userService.getUserProfile(targetId);\r\n                const data = (franchiseData || {}) as UserProfile;\r\n\r\n                // 2. Load User Data (if self)\r\n                let userData = {\r\n                    displayName: user?.displayName || '',\r\n                    phone: user?.phoneNumber || '',\r\n                    photoURL: user?.photoURL || ''\r\n                };\r\n\r\n                if (isSelfProfile && user?.uid) {\r\n                    const userDoc = await getDoc(doc(db, \"users\", user.uid));\r\n                    if (userDoc.exists()) {\r\n                        const uData = userDoc.data();\r\n                        userData = {\r\n                            displayName: uData.displayName || userData.displayName,\r\n                            phone: uData.phone || userData.phone,\r\n                            photoURL: uData.photoURL || userData.photoURL\r\n                        };\r\n                    }\r\n                }\r\n\r\n                reset({\r\n                    // Franchise\r\n                    legalName: (data as any).legalName || (data as any).businessName || '',\r\n                    name: data.name || (data as any).franchiseName || '',\r\n                    cif: data.cif || (data as any).taxId || '',\r\n                    city: data.city || '',\r\n                    address: data.address || '',\r\n                    email: data.email || (targetId === user?.uid ? (user?.email || '') : ''),\r\n                    phone: data.phone || '', // Business phone (was data.phone)\r\n                    franchiseId: data.franchiseId || '',\r\n                    role: data.role || 'franchise',\r\n                    zipCodes: data.zipCodes || [],\r\n                    logisticsRates: data.logisticsRates || [],\r\n                    pack: data.pack || 'basic',\r\n\r\n                    // User\r\n                    userDisplayName: userData.displayName,\r\n                    userPhone: userData.phone, // Personal phone\r\n                    userPhotoURL: userData.photoURL\r\n                });\r\n\r\n                // Save initial rates for comparison\r\n                initialRatesRef.current = data.logisticsRates || [];\r\n\r\n            } catch (e: any) {\r\n                addToast(\"Error al cargar perfil: \" + (e.message || String(e)), \"error\");\r\n            }\r\n        };\r\n        loadProfile();\r\n    }, [user, reset, franchiseId, addToast, isSelfProfile]);\r\n\r\n    // --- HANDLERS ---\r\n\r\n    // Avatar Upload (User Personal)\r\n    const handleAvatarChange = async (e: React.ChangeEvent<HTMLInputElement>) => {\r\n        const file = e.target.files?.[0];\r\n        if (!file || !user) return;\r\n\r\n        setLoading(true);\r\n        try {\r\n            const storageRef = ref(storage, `avatars/${user.uid}`);\r\n            await uploadBytes(storageRef, file);\r\n            const downloadURL = await getDownloadURL(storageRef);\r\n\r\n            // Update Auth & Firestore immediately for Avatar\r\n            await updateProfile(user, { photoURL: downloadURL });\r\n            await setDoc(doc(db, \"users\", user.uid), { photoURL: downloadURL }, { merge: true });\r\n\r\n            setValue('userPhotoURL', downloadURL, { shouldDirty: true });\r\n            addToast(\"Foto de perfil actualizada\", \"success\");\r\n        } catch (error: any) {\r\n            console.error(\"[FranchiseProfile] Avatar upload failed:\", error);\r\n            addToast(\"Error al subir imagen\", \"error\");\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n\r\n\r\n    // --- MAIN SUBMIT ---\r\n    const onSubmit: SubmitHandler<FranchiseProfileFormData> = async (data) => {\r\n        const targetId = franchiseId || user?.uid;\r\n        if (!targetId) return;\r\n\r\n        setLoading(true);\r\n        try {\r\n            // 1. Update User Profile (Personal) if self\r\n            if (isSelfProfile && user) {\r\n                if (data.userDisplayName !== user.displayName) {\r\n                    await updateProfile(user, { displayName: data.userDisplayName });\r\n                }\r\n                await setDoc(doc(db, \"users\", user.uid), {\r\n                    displayName: data.userDisplayName,\r\n                    phone: data.userPhone, // Personal Phone\r\n                    photoURL: data.userPhotoURL\r\n                }, { merge: true });\r\n            }\r\n\r\n            // 2. Update Franchise Profile (Business)\r\n            const cleanFranchiseId = (data.franchiseId || '').toUpperCase().replace(/\\s+/g, '-').trim();\r\n            const franchisePayload = {\r\n                legalName: data.legalName,\r\n                name: data.name,\r\n                cif: data.cif,\r\n                address: data.address,\r\n                email: data.email, // Business Email\r\n                phone: data.phone, // Business Phone\r\n                role: data.role,\r\n                franchiseId: cleanFranchiseId,\r\n                pack: data.pack,\r\n                zipCodes: data.zipCodes,\r\n\r\n                logisticsRates: (data.logisticsRates || []).map(rate => ({\r\n                    ...rate,\r\n                    min: Number(rate.min || 0),\r\n                    max: Number(rate.max || 0),\r\n                    price: Number(rate.price || 0),\r\n                    name: (rate.min !== undefined && rate.max !== undefined)\r\n                        ? `${rate.min}-${rate.max} km`\r\n                        : (rate.name || 'Tarifa')\r\n                })),\r\n                city: data.city || (data.address ? data.address.split(',')[1]?.trim() : '')\r\n            };\r\n\r\n            await userService.updateUser(targetId, franchisePayload);\r\n\r\n            // 3. Smart Rate Notification\r\n            const newRates = franchisePayload.logisticsRates;\r\n            const ancientRates = initialRatesRef.current;\r\n\r\n            // Check for changes\r\n            let hasChanges = false;\r\n            let maxVariance = 0;\r\n            const changeDetails: string[] = [];\r\n\r\n            if (JSON.stringify(newRates) !== JSON.stringify(ancientRates)) {\r\n                hasChanges = true;\r\n\r\n                // Analyze variance\r\n                newRates.forEach(nr => {\r\n                    const oldRate = ancientRates.find(ar => ar.name === nr.name || (ar.min === nr.min && ar.max === nr.max));\r\n                    if (oldRate) {\r\n                        const variance = oldRate.price > 0 ? Math.abs((nr.price - oldRate.price) / oldRate.price) * 100 : 100;\r\n                        if (nr.price !== oldRate.price) {\r\n                            changeDetails.push(`${nr.name}: ${oldRate.price}‚Ç¨ -> ${nr.price}‚Ç¨`);\r\n                            if (variance > maxVariance) maxVariance = variance;\r\n                        }\r\n                    } else {\r\n                        changeDetails.push(`Nueva tarifa: ${nr.name} (${nr.price}‚Ç¨)`);\r\n                        maxVariance = 100; // Treat new rate as major change\r\n                    }\r\n                });\r\n            }\r\n\r\n            if (hasChanges) {\r\n                const isHighPriority = maxVariance > 20; // >20% change is high priority\r\n                await notificationService.notify(\r\n                    'RATE_CHANGE',\r\n                    cleanFranchiseId,\r\n                    data.name || 'Franquicia',\r\n                    {\r\n                        title: isHighPriority ? '‚ö†Ô∏è Cambio Brusco de Tarifas' : 'Actualizaci√≥n de Tarifas',\r\n                        message: `La franquicia ha modificado sus tarifas log√≠sticas. \\n${changeDetails.join('\\n')}`,\r\n                        priority: isHighPriority ? 'high' : 'normal',\r\n                        metadata: {\r\n                            oldRates: ancientRates,\r\n                            newRates: newRates,\r\n                            variance: maxVariance\r\n                        }\r\n                    }\r\n                );\r\n                // Update ref\r\n                initialRatesRef.current = newRates;\r\n            }\r\n\r\n            addToast(\"Perfil unificado guardado correctamente\", \"success\");\r\n            reset(data); // Reset form state\r\n        } catch (error: any) {\r\n            addToast(\"Error al guardar: \" + error.message, \"error\");\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"flex flex-col h-full bg-slate-50 overflow-y-auto pb-20\">\r\n\r\n            {/* Banner Superior - Premium Aurora */}\r\n            <PremiumBanner />\r\n\r\n            <div className=\"max-w-[1600px] mx-auto w-full px-6 md:px-10 -mt-20 relative z-10 flex flex-col gap-10\">\r\n\r\n\r\n\r\n                {/* --- HEADER IDENTITY SECTION --- */}\r\n                <div className=\"flex flex-col md:flex-row items-end gap-6 pb-6 border-b border-slate-200/60\">\r\n                    {/* Avatar / Logo */}\r\n                    <div className=\"relative group cursor-pointer\" onClick={() => isSelfProfile && fileInputRef.current?.click()}>\r\n                        <div className=\"w-32 h-32 rounded-full border-4 border-white shadow-2xl overflow-hidden bg-white flex items-center justify-center relative\">\r\n                            {watchedUserPhoto ? (\r\n                                <img src={watchedUserPhoto} alt=\"Avatar\" className=\"w-full h-full object-cover\" />\r\n                            ) : (\r\n                                <div className=\"text-4xl font-black text-slate-300\">\r\n                                    {user?.email?.charAt(0).toUpperCase()}\r\n                                </div>\r\n                            )}\r\n\r\n                            {isSelfProfile && (\r\n                                <div className=\"absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all duration-300 backdrop-blur-[2px]\">\r\n                                    <Camera className=\"w-8 h-8 text-white drop-shadow-md\" />\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                        <input\r\n                            type=\"file\"\r\n                            ref={fileInputRef}\r\n                            className=\"hidden\"\r\n                            accept=\"image/*\"\r\n                            onChange={handleAvatarChange}\r\n                            disabled={!isSelfProfile}\r\n                            title=\"Cambiar foto de perfil\"\r\n                        />\r\n                        {/* Online Status Dot */}\r\n                        <div className=\"absolute bottom-2 right-2 w-6 h-6 bg-emerald-500 border-4 border-white rounded-full shadow-sm\"></div>\r\n                    </div>\r\n\r\n                    {/* Text Info */}\r\n                    <div className=\"flex-1 mb-2\">\r\n                        <h1 className=\"text-3xl font-black text-slate-800 tracking-tight\">\r\n                            {isSelfProfile ? (watch('userDisplayName') || 'Tu Perfil') : (watch('name') || 'Franquicia')}\r\n                        </h1>\r\n                        <div className=\"flex items-center gap-3 text-slate-500 font-medium mt-1\">\r\n                            <Mail className=\"w-4 h-4\" />\r\n                            <span>{user?.email}</span>\r\n                            <span className=\"bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider\">\r\n                                {isAdmin ? 'Administrador' : 'Franquicia'}\r\n                            </span>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                <form onSubmit={handleSubmit(onSubmit)} className=\"flex-1 px-1 space-y-8\">\r\n\r\n                    {/* TABS COMPACTOS */}\r\n                    <div className=\"flex p-1 bg-slate-200/50 rounded-xl border border-slate-200 w-fit backdrop-blur-sm sticky top-0 z-20 shadow-sm\">\r\n\r\n                        {isSelfProfile && (\r\n                            <button\r\n                                type=\"button\"\r\n                                onClick={() => setActiveTab('user')}\r\n                                className={`flex items-center gap-2 px-5 py-2.5 rounded-lg text-sm font-bold transition-all duration-200 ${activeTab === 'user'\r\n                                    ? 'bg-white text-indigo-600 shadow-md translate-y-[-1px]'\r\n                                    : 'text-slate-500 hover:text-slate-700 hover:bg-white/50'\r\n                                    }`}\r\n                            >\r\n                                <User className=\"w-4 h-4\" /> Datos Personales\r\n                            </button>\r\n                        )}\r\n\r\n                        {[\r\n                            { id: 'general', label: 'Empresa', icon: Building },\r\n                            { id: 'logistics', label: 'Log√≠stica', icon: MapPin },\r\n                        ].map((tab) => (\r\n                            <button\r\n                                key={tab.id}\r\n                                type=\"button\"\r\n                                onClick={() => setActiveTab(tab.id as any)}\r\n                                className={`flex items-center gap-2 px-5 py-2.5 rounded-lg text-sm font-bold transition-all duration-200 ${activeTab === tab.id\r\n                                    ? 'bg-white text-slate-800 shadow-md translate-y-[-1px]'\r\n                                    : 'text-slate-500 hover:text-slate-700 hover:bg-white/50'\r\n                                    }`}\r\n                            >\r\n                                <tab.icon className={`w-4 h-4 ${activeTab === tab.id ? 'text-blue-600' : 'text-slate-400'}`} />\r\n                                {tab.label}\r\n                            </button>\r\n                        ))}\r\n                    </div>\r\n\r\n                    {/* --- TAB CONTENT AREA --- */}\r\n                    <div className=\"min-h-[400px]\">\r\n\r\n                        {/* TAB: USUARIO (PERSONAL) */}\r\n                        {activeTab === 'user' && isSelfProfile && (\r\n                            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-8 animate-in fade-in slide-in-from-bottom-2 duration-300\">\r\n                                <div className=\"space-y-4\">\r\n                                    <h3 className=\"text-lg font-bold text-slate-800 border-b border-slate-100 pb-2\">Informaci√≥n de Usuario</h3>\r\n\r\n                                    <div className=\"space-y-2\">\r\n                                        <label className=\"text-xs font-bold text-slate-500 uppercase tracking-wider\">Nombre Completo</label>\r\n                                        <div className=\"relative group\">\r\n                                            <User className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 group-focus-within:text-indigo-600 transition-colors\" />\r\n                                            <input {...register('userDisplayName')} className=\"w-full pl-10 pr-4 py-3 bg-white border border-slate-200 rounded-xl text-slate-700 focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none transition-all shadow-sm\" placeholder=\"Tu nombre real\" />\r\n                                        </div>\r\n                                    </div>\r\n\r\n                                    <div className=\"space-y-2\">\r\n                                        <label className=\"text-xs font-bold text-slate-500 uppercase tracking-wider\">Tel√©fono Personal</label>\r\n                                        <div className=\"relative group\">\r\n                                            <Phone className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 group-focus-within:text-indigo-600 transition-colors\" />\r\n                                            <input {...register('userPhone')} className=\"w-full pl-10 pr-4 py-3 bg-white border border-slate-200 rounded-xl text-slate-700 focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none transition-all shadow-sm\" placeholder=\"+34 600 000 000\" />\r\n                                        </div>\r\n                                    </div>\r\n\r\n                                    <div className=\"p-4 bg-indigo-50 border border-indigo-100 rounded-xl flex items-start gap-3\">\r\n                                        <Lock className=\"w-5 h-5 text-indigo-500 shrink-0 mt-0.5\" />\r\n                                        <div>\r\n                                            <h4 className=\"text-sm font-bold text-indigo-900\">Seguridad de la Cuenta</h4>\r\n                                            <p className=\"text-xs text-indigo-700/80 mt-1\">Para cambiar tu contrase√±a o email, contacta con soporte o usa la opci√≥n de recuperaci√≥n en el login.</p>\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        )}\r\n\r\n                        {/* TAB: GENERAL (EMPRESA) */}\r\n                        {activeTab === 'general' && (\r\n                            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6 animate-in fade-in slide-in-from-bottom-2 duration-300\">\r\n                                {/* NOMBRE COMERCIAL */}\r\n                                <div className=\"space-y-2\">\r\n                                    <label className=\"text-xs font-bold text-slate-500 uppercase tracking-wider\">Nombre Comercial</label>\r\n                                    <div className=\"relative group\">\r\n                                        <Building className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 group-focus-within:text-blue-600 transition-colors\" />\r\n                                        <input {...register('name')} className=\"w-full pl-10 pr-4 py-3 bg-white border border-slate-200 rounded-xl text-slate-700 focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none transition-all shadow-sm\" placeholder=\"Ej: Burger King Centro\" />\r\n                                    </div>\r\n                                </div>\r\n\r\n                                {/* RAZON SOCIAL */}\r\n                                <div className=\"space-y-2\">\r\n                                    <label className=\"text-xs font-bold text-slate-500 uppercase tracking-wider\">Raz√≥n Social</label>\r\n                                    <div className=\"relative group\">\r\n                                        <Building className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 group-focus-within:text-blue-600 transition-colors\" />\r\n                                        <input {...register('legalName')} className=\"w-full pl-10 pr-4 py-3 bg-white border border-slate-200 rounded-xl text-slate-700 focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none transition-all shadow-sm\" placeholder=\"Ej: Burger King Spain S.L.\" />\r\n                                    </div>\r\n                                </div>\r\n\r\n                                {/* CIF */}\r\n                                <div className=\"space-y-2\">\r\n                                    <label className=\"text-xs font-bold text-slate-500 uppercase tracking-wider\">CIF / NIF</label>\r\n                                    <div className=\"relative group\">\r\n                                        <Shield className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 group-focus-within:text-blue-600 transition-colors\" />\r\n                                        <input {...register('cif')} className=\"w-full pl-10 pr-4 py-3 bg-white border border-slate-200 rounded-xl text-slate-700 focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none transition-all shadow-sm\" placeholder=\"B12345678\" />\r\n                                    </div>\r\n                                </div>\r\n\r\n                                {/* TELEFONO EMPRESA */}\r\n                                <div className=\"space-y-2\">\r\n                                    <label className=\"text-xs font-bold text-slate-500 uppercase tracking-wider\">Tel√©fono de Contacto (P√∫blico)</label>\r\n                                    <div className=\"relative group\">\r\n                                        <Phone className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 group-focus-within:text-blue-600 transition-colors\" />\r\n                                        <input {...register('phone')} className=\"w-full pl-10 pr-4 py-3 bg-white border border-slate-200 rounded-xl text-slate-700 focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none transition-all shadow-sm\" placeholder=\"+34 600 000 000\" />\r\n                                    </div>\r\n                                </div>\r\n\r\n                                {/* EMAIL EMPRESA */}\r\n                                <div className=\"space-y-2\">\r\n                                    <label className=\"text-xs font-bold text-slate-500 uppercase tracking-wider\">Email Operativo</label>\r\n                                    <div className=\"relative group\">\r\n                                        <Mail className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 group-focus-within:text-blue-600 transition-colors\" />\r\n                                        <input {...register('email')} className=\"w-full pl-10 pr-4 py-3 bg-white border border-slate-200 rounded-xl text-slate-700 focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none transition-all shadow-sm\" placeholder=\"contacto@restaurante.com\" />\r\n                                    </div>\r\n                                </div>\r\n\r\n\r\n                                {/* CIUDAD (LOCALIDAD) */}\r\n                                <div className=\"space-y-2 col-span-1 md:col-span-2\">\r\n                                    <label className=\"text-xs font-bold text-slate-500 uppercase tracking-wider\">Localidad (Para el Tiempo)</label>\r\n                                    <div className=\"relative group\">\r\n                                        <MapPin className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 group-focus-within:text-blue-600 transition-colors\" />\r\n                                        <input {...register('city', { required: true })} className=\"w-full pl-10 pr-4 py-3 bg-white border border-slate-200 rounded-xl text-slate-700 focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none transition-all shadow-sm\" placeholder=\"Ej: Barcelona\" />\r\n                                    </div>\r\n                                    <p className=\"text-[10px] text-slate-400 ml-1\">Escribe solo la ciudad. El sistema asumir√° que es en Espa√±a.</p>\r\n                                </div>\r\n\r\n                                {/* DIRECCION */}\r\n                                <div className=\"space-y-2 col-span-1 md:col-span-2\">\r\n                                    <label className=\"text-xs font-bold text-slate-500 uppercase tracking-wider\">Direcci√≥n Completa</label>\r\n                                    <div className=\"relative group\">\r\n                                        <MapPin className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 group-focus-within:text-blue-600 transition-colors\" />\r\n                                        <input {...register('address')} className=\"w-full pl-10 pr-4 py-3 bg-white border border-slate-200 rounded-xl text-slate-700 focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none transition-all shadow-sm\" placeholder=\"Calle Ejemplo 123, Ciudad\" />\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        )}\r\n\r\n                        {/* TAB: LOGISTICS */}\r\n                        {activeTab === 'logistics' && (\r\n                            <div className=\"space-y-6 animate-in fade-in slide-in-from-bottom-2 duration-300\">\r\n                                {/* SECTION 2: TARIFAS (COMPACT GRID) */}\r\n                                <div className=\"bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden\">\r\n                                    <div className=\"px-6 py-4 border-b border-slate-100 bg-slate-50/50 flex items-center justify-between\">\r\n                                        <h4 className=\"text-sm font-bold text-slate-700 uppercase tracking-wider flex items-center gap-2\">\r\n                                            <DollarSign className=\"w-4 h-4 text-emerald-500\" /> Tarifas por Distancia\r\n                                        </h4>\r\n                                        <button\r\n                                            type=\"button\"\r\n                                            onClick={() => {\r\n                                                const currentRates = getValues().logisticsRates;\r\n                                                const lastRate = currentRates && currentRates.length > 0 ? currentRates[currentRates.length - 1] : null;\r\n                                                const newMin = lastRate ? (Number(lastRate.max) || 0) : 0;\r\n                                                const newMax = newMin + 2;\r\n                                                appendRate({ min: newMin, max: newMax, price: 0, name: `${newMin}-${newMax} km` });\r\n                                            }}\r\n                                            className=\"text-xs font-bold text-emerald-600 hover:text-emerald-700 bg-emerald-50 hover:bg-emerald-100 px-3 py-1.5 rounded-lg transition-colors flex items-center gap-1\"\r\n                                        >\r\n                                            <Plus className=\"w-3 h-3\" /> A√±adir Rango\r\n                                        </button>\r\n                                    </div>\r\n\r\n                                    {rateFields.length > 0 ? (\r\n                                        <div className=\"divide-y divide-slate-100\">\r\n                                            {/* Header Row */}\r\n                                            <div className=\"grid grid-cols-12 gap-4 px-6 py-3 bg-slate-50/30 text-xs font-bold text-slate-400 uppercase tracking-wider\">\r\n                                                <div className=\"col-span-1 text-center\">#</div>\r\n                                                <div className=\"col-span-5 md:col-span-6\">Distancia (KM)</div>\r\n                                                <div className=\"col-span-4 md:col-span-4 text-right pr-8\">Precio</div>\r\n                                                <div className=\"col-span-2 md:col-span-1\"></div>\r\n                                            </div>\r\n\r\n                                            {/* Rows */}\r\n                                            {rateFields.map((field, index) => (\r\n                                                <div key={field.id} className=\"grid grid-cols-12 gap-4 px-6 py-4 items-center hover:bg-slate-50 transition-colors group\">\r\n\r\n                                                    {/* Index */}\r\n                                                    <div className=\"col-span-1 flex justify-center\">\r\n                                                        <div className=\"w-6 h-6 rounded-full bg-slate-100 text-slate-500 text-xs font-bold flex items-center justify-center border border-slate-200\">\r\n                                                            {index + 1}\r\n                                                        </div>\r\n                                                    </div>\r\n\r\n                                                    {/* Distance Range Inputs */}\r\n                                                    <div className=\"col-span-5 md:col-span-6 flex items-center gap-3\">\r\n                                                        <div className=\"relative w-20 md:w-24\">\r\n                                                            <input\r\n                                                                type=\"number\"\r\n                                                                step=\"0.1\"\r\n                                                                {...register(`logisticsRates.${index}.min` as const, { valueAsNumber: true })}\r\n                                                                className=\"w-full bg-white border border-slate-200 rounded-lg py-1.5 px-2 text-center text-sm font-bold text-slate-700 focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none\"\r\n                                                                placeholder=\"0\"\r\n                                                            />\r\n                                                        </div>\r\n                                                        <span className=\"text-slate-300 font-bold\">-</span>\r\n                                                        <div className=\"relative w-20 md:w-24\">\r\n                                                            <input\r\n                                                                type=\"number\"\r\n                                                                step=\"0.1\"\r\n                                                                {...register(`logisticsRates.${index}.max` as const, { valueAsNumber: true })}\r\n                                                                className=\"w-full bg-white border border-slate-200 rounded-lg py-1.5 px-2 text-center text-sm font-bold text-slate-700 focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none\"\r\n                                                                placeholder=\"Max\"\r\n                                                            />\r\n                                                        </div>\r\n                                                        <span className=\"text-xs font-bold text-slate-400 hidden md:inline-block\">km</span>\r\n\r\n                                                        {/* Hidden Name Input */}\r\n                                                        <input type=\"hidden\" {...register(`logisticsRates.${index}.name` as const)} />\r\n                                                    </div>\r\n\r\n                                                    {/* Price Input */}\r\n                                                    <div className=\"col-span-4 md:col-span-4 flex items-center justify-end gap-2 pr-4 md:pr-8\">\r\n                                                        <div className=\"relative w-24 md:w-28\">\r\n                                                            <span className=\"absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs\">$</span>\r\n                                                            <input\r\n                                                                type=\"number\"\r\n                                                                step=\"0.01\"\r\n                                                                {...register(`logisticsRates.${index}.price` as const, { valueAsNumber: true })}\r\n                                                                className=\"w-full bg-white border border-slate-200 rounded-lg py-1.5 pl-6 pr-3 text-right text-sm font-bold text-emerald-600 focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 outline-none\"\r\n                                                                placeholder=\"0.00\"\r\n                                                            />\r\n                                                        </div>\r\n                                                    </div>\r\n\r\n                                                    {/* Delete Action */}\r\n                                                    <div className=\"col-span-2 md:col-span-1 flex justify-end\">\r\n                                                        <button\r\n                                                            type=\"button\"\r\n                                                            onClick={() => removeRate(index)}\r\n                                                            className=\"p-2 text-slate-300 hover:text-rose-500 hover:bg-rose-50 rounded-lg transition-colors opacity-0 group-hover:opacity-100\"\r\n                                                            title=\"Eliminar tarifa\"\r\n                                                        >\r\n                                                            <Trash2 className=\"w-4 h-4\" />\r\n                                                        </button>\r\n                                                    </div>\r\n                                                </div>\r\n                                            ))}\r\n                                        </div>\r\n                                    ) : (\r\n                                        <div className=\"p-12 flex flex-col items-center justify-center text-center\">\r\n                                            <div className=\"w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mb-4\">\r\n                                                <MapPin className=\"w-8 h-8 text-slate-300 p-0\" />\r\n                                            </div>\r\n                                            <h3 className=\"text-slate-900 font-bold mb-1\">Sin tarifas configuradas</h3>\r\n                                            <p className=\"text-slate-500 text-sm mb-6 max-w-xs mx-auto\">Configura los precios de env√≠o seg√∫n la distancia para calcular los costes autom√°ticamente.</p>\r\n                                            <button\r\n                                                type=\"button\"\r\n                                                onClick={() => appendRate({ min: 0, max: 3, price: 3.50, name: '0-3 km' })}\r\n                                                className=\"px-6 py-2 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-xl transition-all shadow-lg shadow-emerald-500/20 active:scale-95 flex items-center gap-2\"\r\n                                            >\r\n                                                <Plus className=\"w-4 h-4\" /> Crear Primera Tarifa\r\n                                            </button>\r\n                                        </div>\r\n                                    )}\r\n                                </div>\r\n                            </div>\r\n                        )}\r\n\r\n\r\n                    </div>\r\n                </form>\r\n\r\n                {/* FOOTER ACTIONS - Fixed at bottom */}\r\n                <div className=\"p-4 border-t border-slate-200 bg-white/90 backdrop-blur-sm flex justify-end shrink-0 fixed bottom-0 left-0 right-0 md:left-64 z-50\">\r\n                    <button\r\n                        onClick={handleSubmit(onSubmit)}\r\n                        disabled={loading || !isDirty}\r\n                        className=\"flex items-center gap-2 px-6 py-2.5 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl shadow-lg shadow-blue-500/20 transition-all active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                    >\r\n                        <Save className=\"w-4 h-4\" /> {loading ? 'Guardando...' : 'Guardar Cambios'}\r\n                    </button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default FranchiseProfile;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\support\\AdminSupportInbox.tsx","messages":[{"ruleId":"react-hooks/immutability","severity":2,"message":"Error: Cannot access variable before it is declared\n\n`loadData` is accessed before it is declared, which prevents the earlier access from updating when this value changes over time.\n\nC:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\support\\AdminSupportInbox.tsx:17:9\n  15 |\n  16 |     useEffect(() => {\n> 17 |         loadData();\n     |         ^^^^^^^^ `loadData` accessed before it is declared\n  18 |     }, [activeTab]);\n  19 |\n  20 |     const loadData = async () => {\n\nC:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\support\\AdminSupportInbox.tsx:20:5\n  18 |     }, [activeTab]);\n  19 |\n> 20 |     const loadData = async () => {\n     |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 21 |         if (activeTab === 'tickets') {\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 22 |             const data = await supportService.getAllTicketsForAdmin();\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 23 |             setTickets(data);\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 24 |         } else {\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 25 |             const data = await supportService.getAllPremiumRequests();\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 26 |             setPremiumRequests(data);\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 27 |         }\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 28 |     };\n     | ^^^^^^^ `loadData` is declared here\n  29 |\n  30 |     const handleReply = async (ticketId: string) => {\n  31 |         if (!replyMesssage.trim()) return;","line":17,"column":9,"nodeType":null,"endLine":17,"endColumn":17},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadData'. Either include it or remove the dependency array.","line":18,"column":8,"nodeType":"ArrayExpression","endLine":18,"endColumn":19,"suggestions":[{"desc":"Update the dependencies array to be: [activeTab, loadData]","fix":{"range":[839,850],"text":"[activeTab, loadData]"}}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react';\r\nimport { supportService, SupportTicket, PremiumRequest } from '../../support/SupportService';\r\nimport { notificationService } from '../../../services/notificationService';\r\nimport { MessageSquare, Star, Reply, CheckCircle2, XCircle } from 'lucide-react';\r\nimport { formatTimeAgo } from '../../../utils/dateHelpers';\r\n\r\nconst AdminSupportInbox = () => {\r\n    const [activeTab, setActiveTab] = useState<'tickets' | 'premium'>('tickets');\r\n    const [tickets, setTickets] = useState<SupportTicket[]>([]);\r\n    const [premiumRequests, setPremiumRequests] = useState<PremiumRequest[]>([]);\r\n\r\n    // Reply State\r\n    const [replyingTo, setReplyingTo] = useState<string | null>(null);\r\n    const [replyMesssage, setReplyMessage] = useState('');\r\n\r\n    useEffect(() => {\r\n        loadData();\r\n    }, [activeTab]);\r\n\r\n    const loadData = async () => {\r\n        if (activeTab === 'tickets') {\r\n            const data = await supportService.getAllTicketsForAdmin();\r\n            setTickets(data);\r\n        } else {\r\n            const data = await supportService.getAllPremiumRequests();\r\n            setPremiumRequests(data);\r\n        }\r\n    };\r\n\r\n    const handleReply = async (ticketId: string) => {\r\n        if (!replyMesssage.trim()) return;\r\n\r\n        await supportService.replyToTicket(ticketId, {\r\n            senderId: 'admin',\r\n            senderName: 'Soporte Admin',\r\n            message: replyMesssage,\r\n            isAdmin: true\r\n        });\r\n\r\n        // Notify Franchise about the reply\r\n        // We need the franchiseId from the ticket, sadly we only have ticketId here.\r\n        // But we have the 'tickets' state array!\r\n        const ticket = tickets.find(t => t.id === ticketId);\r\n        if (ticket && ticket.franchiseId) {\r\n            await notificationService.notifyFranchise(ticket.franchiseId, {\r\n                title: 'Nueva Respuesta en Soporte',\r\n                message: `Admin ha respondido a tu ticket: ${ticket.subject}`,\r\n                type: 'SUPPORT_TICKET',\r\n                link: '/support' // Or relevant path\r\n            });\r\n        }\r\n\r\n        setReplyingTo(null);\r\n        setReplyMessage('');\r\n        loadData(); // Refresh\r\n    };\r\n\r\n    const handleUpdatePremiumStatus = async (reqId: string, status: PremiumRequest['status']) => {\r\n        await supportService.updatePremiumStatus(reqId, status);\r\n\r\n        // Notify Franchise about status change\r\n        const request = premiumRequests.find(r => r.id === reqId);\r\n        if (request && request.franchiseId) {\r\n            await notificationService.notifyFranchise(request.franchiseId, {\r\n                title: `Solicitud Premium ${status === 'approved' ? 'Aprobada' : 'Rechazada'}`,\r\n                message: `Tu solicitud para ${request.serviceName} ha sido ${status === 'approved' ? 'aprobada' : 'rechazada'}.`,\r\n                type: 'PREMIUM_SERVICE_REQUEST',\r\n                priority: status === 'approved' ? 'high' : 'normal',\r\n                link: '/support'\r\n            });\r\n        }\r\n\r\n        loadData();\r\n    };\r\n\r\n    return (\r\n        <div className=\"h-full bg-slate-50 p-6 flex flex-col overflow-hidden\">\r\n            <header className=\"flex justify-between items-center mb-6 shrink-0\">\r\n                <div>\r\n                    <h1 className=\"text-2xl font-black text-slate-900 tracking-tight\">Centro de Soporte</h1>\r\n                    <p className=\"text-slate-500 text-sm\">Gestiona tickets y solicitudes de servicio.</p>\r\n                </div>\r\n\r\n                <div className=\"bg-white p-1 rounded-xl border border-slate-200 shadow-sm flex\">\r\n                    <button\r\n                        onClick={() => setActiveTab('tickets')}\r\n                        className={`px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition-all ${activeTab === 'tickets' ? 'bg-indigo-50 text-indigo-700' : 'text-slate-500 hover:text-indigo-600'}`}\r\n                    >\r\n                        <MessageSquare className=\"w-4 h-4\" /> Tickets\r\n                        {tickets.filter(t => t.status === 'open').length > 0 && (\r\n                            <span className=\"bg-rose-500 text-white text-[10px] px-1.5 rounded-full\">{tickets.filter(t => t.status === 'open').length}</span>\r\n                        )}\r\n                    </button>\r\n                    <div className=\"w-px bg-slate-100 mx-1\" />\r\n                    <button\r\n                        onClick={() => setActiveTab('premium')}\r\n                        className={`px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition-all ${activeTab === 'premium' ? 'bg-amber-50 text-amber-700' : 'text-slate-500 hover:text-amber-600'}`}\r\n                    >\r\n                        <Star className=\"w-4 h-4\" /> Premium\r\n                        {premiumRequests.filter(r => r.status === 'pending').length > 0 && (\r\n                            <span className=\"bg-amber-500 text-white text-[10px] px-1.5 rounded-full\">{premiumRequests.filter(r => r.status === 'pending').length}</span>\r\n                        )}\r\n                    </button>\r\n                </div>\r\n            </header>\r\n\r\n            <div className=\"flex-1 overflow-y-auto pr-2 space-y-4\">\r\n                {activeTab === 'tickets' && (\r\n                    <div className=\"space-y-4\">\r\n                        {tickets.map(ticket => (\r\n                            <div key={ticket.id} className=\"bg-white rounded-xl p-5 border border-slate-200 shadow-sm\">\r\n                                <div className=\"flex justify-between mb-3\">\r\n                                    <div className=\"flex items-center gap-2\">\r\n                                        <span className={`w-2 h-2 rounded-full ${ticket.status === 'open' ? 'bg-rose-500 animate-pulse' : 'bg-emerald-500'}`} />\r\n                                        <span className=\"font-bold text-slate-900\">{ticket.franchiseName || 'Franquicia Desconocida'}</span>\r\n                                        <span className=\"text-xs text-slate-400\">‚Ä¢ {formatTimeAgo(ticket.createdAt?.toDate())}</span>\r\n                                    </div>\r\n                                    <span className=\"text-[10px] bg-slate-100 text-slate-500 font-bold px-2 py-1 rounded-md uppercase\">{ticket.category}</span>\r\n                                </div>\r\n\r\n                                <h3 className=\"font-bold text-lg mb-2\">{ticket.subject}</h3>\r\n                                <p className=\"text-slate-600 text-sm bg-slate-50 p-3 rounded-lg border border-slate-100 mb-4\">{ticket.message}</p>\r\n\r\n                                {/* Quick Reply Area */}\r\n                                {replyingTo === ticket.id ? (\r\n                                    <div className=\"mt-4 animate-in fade-in slide-in-from-top-2\">\r\n                                        <textarea\r\n                                            className=\"w-full p-3 border border-indigo-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none mb-2 bg-indigo-50/30\"\r\n                                            placeholder=\"Escribe tu respuesta...\"\r\n                                            rows={3}\r\n                                            value={replyMesssage}\r\n                                            onChange={(e) => setReplyMessage(e.target.value)}\r\n                                            autoFocus\r\n                                        />\r\n                                        <div className=\"flex justify-end gap-2\">\r\n                                            <button onClick={() => setReplyingTo(null)} className=\"text-xs font-bold text-slate-500 px-3 py-2\">Cancelar</button>\r\n                                            <button onClick={() => handleReply(ticket.id!)} className=\"text-xs font-bold bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700\">Enviar Respuesta</button>\r\n                                        </div>\r\n                                    </div>\r\n                                ) : (\r\n                                    <div className=\"flex justify-end\">\r\n                                        <button onClick={() => setReplyingTo(ticket.id!)} className=\"flex items-center gap-2 text-indigo-600 font-bold text-xs hover:bg-indigo-50 px-3 py-2 rounded-lg transition-colors\">\r\n                                            <Reply className=\"w-4 h-4\" /> Responder\r\n                                        </button>\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n                )}\r\n\r\n                {activeTab === 'premium' && (\r\n                    <div className=\"grid gap-4\">\r\n                        {premiumRequests.map(req => (\r\n                            <div key={req.id} className=\"bg-white rounded-xl p-5 border border-slate-200 shadow-sm flex items-center justify-between\">\r\n                                <div>\r\n                                    <div className=\"flex items-center gap-2 mb-1\">\r\n                                        <span className=\"font-bold text-slate-900\">{req.franchiseName}</span>\r\n                                        <span className=\"text-xs text-slate-400\">‚Ä¢ {formatTimeAgo(req.createdAt?.toDate())}</span>\r\n                                    </div>\r\n                                    <p className=\"text-lg font-bold text-indigo-900\">{req.serviceName}</p>\r\n                                    <p className=\"text-xs text-slate-500 font-medium uppercase tracking-wider mt-1 flex items-center gap-1\">\r\n                                        Estado: <span className={req.status === 'approved' ? 'text-emerald-600' : req.status === 'rejected' ? 'text-rose-600' : 'text-amber-600'}>{req.status}</span>\r\n                                    </p>\r\n                                </div>\r\n\r\n                                {req.status === 'pending' && (\r\n                                    <div className=\"flex gap-2\">\r\n                                        <button onClick={() => handleUpdatePremiumStatus(req.id!, 'rejected')} className=\"p-2 hover:bg-rose-50 text-slate-400 hover:text-rose-600 rounded-lg transition-colors\" title=\"Rechazar\">\r\n                                            <XCircle className=\"w-6 h-6\" />\r\n                                        </button>\r\n                                        <button onClick={() => handleUpdatePremiumStatus(req.id!, 'approved')} className=\"p-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 shadow-md shadow-indigo-200 hover:scale-105 transition-all\" title=\"Aprobar Solicitud\">\r\n                                            <CheckCircle2 className=\"w-6 h-6\" />\r\n                                        </button>\r\n                                    </div>\r\n                                )}\r\n                                {req.status === 'approved' && <div className=\"bg-emerald-50 text-emerald-600 p-2 rounded-full\"><CheckCircle2 className=\"w-6 h-6\" /></div>}\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default AdminSupportInbox;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\support\\SupportMetrics.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\support\\TicketDetail.tsx","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Use \"@ts-expect-error\" instead of \"@ts-ignore\", as \"@ts-ignore\" will do nothing if the following line is error-free.","line":229,"column":34,"nodeType":"Block","messageId":"tsIgnoreInsteadOfExpectError","endLine":229,"endColumn":81,"suggestions":[{"messageId":"replaceTsIgnoreWithTsExpectError","fix":{"range":[13763,13810],"text":"/* @ts-expect-error - Firestore timestamp handling */"},"desc":"Replace \"@ts-ignore\" with \"@ts-expect-error\"."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { memo } from 'react';\r\nimport { User, Clock, Download, Lock, Send, Loader2, MessageSquare } from 'lucide-react';\r\nimport { getStatusConfig, TICKET_STATUSES } from '../../../lib/constants';\r\nimport { useSupport } from '../../../hooks/useSupport';\r\nimport { formatDate } from '../../../utils/formatDate';\r\nimport { Ticket, TicketMessage } from '../../../hooks/useSupportManager';\r\n\r\n// Define Context Interface\r\ninterface SupportContextDetailValue {\r\n    selectedTicket: Ticket | null;\r\n    messages: TicketMessage[];\r\n    handleStatusChange: (id: string, status: string) => void;\r\n    reply: string;\r\n    setReply: (val: string) => void;\r\n    isInternal: boolean;\r\n    setIsInternal: (val: boolean) => void;\r\n    handleReply: () => void;\r\n    isSendingReply: boolean;\r\n    handleDeleteTicket: (id: string) => void;\r\n    messagesEndRef: React.RefObject<HTMLDivElement>;\r\n}\r\n\r\n// --- SUB-COMPONENTS FOR PERFORMANCE ---\r\n\r\ninterface MessageItemProps {\r\n    msg: TicketMessage;\r\n    email?: string;\r\n    isAdmin?: boolean;\r\n}\r\n\r\nconst MessageItem = memo(({ msg, email }: MessageItemProps) => {\r\n    const isInternal = msg.isInternal;\r\n    // msg.senderRole can be 'admin' or 'user' or 'system'\r\n    const senderIsAdmin = msg.senderRole === 'admin';\r\n\r\n    if (isInternal) {\r\n        return (\r\n            <div className=\"flex justify-center my-8\">\r\n                <div className=\"bg-amber-50/50 dark:bg-amber-500/5 border border-amber-200/50 dark:border-amber-500/10 text-amber-800 dark:text-amber-400 p-5 rounded-3xl max-w-xl text-sm flex items-start gap-4 shadow-sm transition-all animate-in fade-in zoom-in-95 duration-500 underline-offset-4 decoration-amber-500/30\">\r\n                    <div className=\"w-8 h-8 rounded-xl bg-amber-100 dark:bg-amber-500/20 flex items-center justify-center shrink-0\">\r\n                        <Lock className=\"w-4 h-4\" />\r\n                    </div>\r\n                    <div>\r\n                        <p className=\"font-semibold text-[10px] uppercase mb-2 tracking-widest opacity-60\">Nota Interna (Privado)</p>\r\n                        <div\r\n                            className='prose prose-sm prose-amber dark:prose-invert font-medium leading-relaxed'\r\n                            dangerouslySetInnerHTML={{ __html: msg.text }}\r\n                        />\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className={`flex ${senderIsAdmin ? 'justify-end' : 'justify-start'} animate-in fade-in slide-in-from-bottom-2 duration-400`}>\r\n            <div className={`p-6 rounded-3xl max-w-[85%] lg:max-w-[75%] shadow-sm transition-all ${senderIsAdmin\r\n                ? 'bg-slate-900 dark:bg-indigo-600 text-white rounded-tr-none shadow-indigo-500/10'\r\n                : 'bg-white dark:bg-slate-800 border border-slate-200/50 dark:border-slate-700/50 text-slate-700 dark:text-slate-200 rounded-tl-none'\r\n                }`}>\r\n                <div className=\"flex items-center gap-3 mb-2.5\">\r\n                    <span className={`text-[10px] font-semibold uppercase tracking-wider ${senderIsAdmin ? 'text-indigo-200/70' : 'text-indigo-600 dark:text-indigo-400'}`}>\r\n                        {senderIsAdmin ? 'Soporte HQ' : email}\r\n                    </span>\r\n                    <span className={`text-[10px] font-medium opacity-50 ${senderIsAdmin ? 'text-indigo-100' : 'text-slate-500'}`}>\r\n                        {formatDate(msg.createdAt)}\r\n                    </span>\r\n                </div>\r\n                <div\r\n                    className={`prose prose-sm leading-relaxed ${senderIsAdmin ? 'prose-invert' : 'prose-slate dark:prose-invert font-medium text-slate-700 dark:text-slate-200'}`}\r\n                    dangerouslySetInnerHTML={{ __html: msg.text }}\r\n                />\r\n            </div>\r\n        </div>\r\n    );\r\n});\r\n\r\nMessageItem.displayName = 'MessageItem';\r\n\r\n// --- PURE PRESENTATIONAL COMPONENT ---\r\n\r\ninterface TicketDetailInnerProps {\r\n    selectedTicket: Ticket | null;\r\n    messages: TicketMessage[];\r\n    onStatusChange: (id: string, status: string) => void;\r\n    reply: string;\r\n    setReply: (val: string) => void;\r\n    isInternal: boolean;\r\n    setIsInternal: (val: boolean) => void;\r\n    onReply: () => void;\r\n    isSendingReply: boolean;\r\n    onDelete: (id: string) => void;\r\n    messagesEndRef: React.RefObject<HTMLDivElement>;\r\n}\r\n\r\nconst TicketDetailInner = memo(({\r\n    selectedTicket,\r\n    messages,\r\n    onStatusChange,\r\n    reply,\r\n    setReply,\r\n    isInternal,\r\n    setIsInternal,\r\n    onReply,\r\n    isSendingReply,\r\n    onDelete,\r\n    messagesEndRef\r\n}: TicketDetailInnerProps) => {\r\n    const [showDeleteConfirm, setShowDeleteConfirm] = React.useState(false);\r\n    const [isDeleting, setIsDeleting] = React.useState(false);\r\n\r\n    if (!selectedTicket) {\r\n        return (\r\n            <div className=\"bg-white/70 dark:bg-slate-900/70 backdrop-blur-xl rounded-3xl shadow-lg border border-slate-200/50 dark:border-slate-800/50 overflow-hidden flex flex-col h-full relative transition-all\">\r\n                <div className=\"h-full flex flex-col items-center justify-center text-slate-300 dark:text-slate-700 bg-slate-50/20 dark:bg-slate-950/20\">\r\n                    <div className=\"w-24 h-24 bg-white dark:bg-slate-800 rounded-[2.5rem] flex items-center justify-center mb-8 shadow-2xl shadow-indigo-500/10 dark:shadow-none transition-transform hover:scale-110 duration-700\">\r\n                        <MessageSquare className=\"w-10 h-10 text-indigo-500 dark:text-indigo-400\" />\r\n                    </div>\r\n                    <p className=\"text-2xl font-semibold text-slate-900 dark:text-white tracking-tight\">Atenci√≥n al Cliente</p>\r\n                    <p className=\"text-sm font-medium text-slate-400 dark:text-slate-500 mt-2.5\">Selecciona un caso para comenzar la gesti√≥n</p>\r\n                    <div className=\"mt-10 px-5 py-2.5 bg-white/80 dark:bg-slate-800/80 border border-slate-200 dark:border-slate-700 rounded-2xl flex items-center gap-4 shadow-sm backdrop-blur-sm\">\r\n                        <kbd className=\"font-bold bg-slate-100 dark:bg-slate-700 px-2.5 py-1 rounded-lg text-[10px] text-slate-600 dark:text-slate-400 transition-colors\">‚åòK</kbd>\r\n                        <span className=\"text-xs font-semibold text-slate-500 dark:text-slate-400 tracking-wide uppercase\">B√∫squeda R√°pida</span>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    const ticketStatus = getStatusConfig(selectedTicket.status);\r\n\r\n    const handleDelete = async () => {\r\n        setIsDeleting(true);\r\n        try {\r\n            await onDelete(selectedTicket.id);\r\n        } catch (error) {\r\n            console.error(error);\r\n        } finally {\r\n            setIsDeleting(false);\r\n            setShowDeleteConfirm(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"bg-white/70 dark:bg-slate-900/70 backdrop-blur-xl rounded-3xl shadow-xl border border-slate-200/50 dark:border-slate-800/50 overflow-hidden flex flex-col h-full relative transition-all\">\r\n            <div className=\"h-full flex flex-col animate-in fade-in slide-in-from-right-4 duration-500\">\r\n                {/* Detail Header */}\r\n                <div className=\"p-8 border-b border-slate-100/50 dark:border-slate-800/50 bg-white/40 dark:bg-slate-900/40 flex justify-between items-start\">\r\n                    <div className=\"max-w-xl\">\r\n                        <div className=\"flex items-center gap-4 mb-4\">\r\n                            <span className={`px-2.5 py-1 rounded-xl text-[10px] font-semibold uppercase tracking-wider border ${ticketStatus.bg} ${ticketStatus.text} ${ticketStatus.border} dark:bg-opacity-20 transition-all`}>\r\n                                {ticketStatus.label}\r\n                            </span>\r\n                            <span className=\"text-slate-200 dark:text-slate-700 font-bold\">‚Ä¢</span>\r\n                            <span className=\"text-[10px] text-slate-400 dark:text-slate-500 font-semibold uppercase tracking-[0.2em]\">Ref: {selectedTicket.id.slice(0, 8)}</span>\r\n                        </div>\r\n                        <h2 className=\"text-3xl font-semibold text-slate-900 dark:text-white mb-3 leading-tight tracking-tight\">{selectedTicket.subject}</h2>\r\n                        <div className=\"flex items-center gap-6 text-xs text-slate-500 dark:text-slate-400 font-medium tracking-wide\">\r\n                            <span className=\"flex items-center gap-2.5 group transition-colors hover:text-indigo-500\">\r\n                                <User className=\"w-4 h-4 text-slate-300 dark:text-slate-600 group-hover:text-indigo-400 transition-colors\" />\r\n                                <span className=\"uppercase\">{selectedTicket.email}</span>\r\n                            </span>\r\n                            <span className=\"flex items-center gap-2.5\">\r\n                                <Clock className=\"w-4 h-4 text-slate-300 dark:text-slate-600\" />\r\n                                <span>{formatDate(selectedTicket.createdAt)}</span>\r\n                            </span>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Actions Header */}\r\n                    <div className=\"flex flex-col items-end gap-4\">\r\n                        <div className=\"flex items-center gap-3\">\r\n                            {!showDeleteConfirm ? (\r\n                                <button\r\n                                    onClick={() => setShowDeleteConfirm(true)}\r\n                                    className=\"p-2.5 bg-rose-50 dark:bg-rose-500/10 text-rose-500 dark:text-rose-400 hover:bg-rose-100 dark:hover:bg-rose-500/20 rounded-xl transition-all active:scale-95\"\r\n                                    title=\"Eliminar Ticket\"\r\n                                >\r\n                                    <Download className=\"w-4 h-4 rotate-180\" />\r\n                                </button>\r\n                            ) : (\r\n                                <div className=\"flex items-center gap-2 animate-in slide-in-from-right-2 duration-300\">\r\n                                    <span className=\"text-[10px] font-bold text-rose-600 dark:text-rose-400 uppercase tracking-widest mr-1\">¬øConfirmar borrado?</span>\r\n                                    <button\r\n                                        onClick={handleDelete}\r\n                                        disabled={isDeleting}\r\n                                        className=\"px-3 py-1.5 bg-rose-600 text-white rounded-lg text-[10px] font-bold uppercase hover:bg-rose-700 transition-all disabled:opacity-50\"\r\n                                    >\r\n                                        {isDeleting ? '...' : 'S√ç'}\r\n                                    </button>\r\n                                    <button\r\n                                        onClick={() => setShowDeleteConfirm(false)}\r\n                                        className=\"px-3 py-1.5 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 rounded-lg text-[10px] font-bold uppercase hover:bg-slate-200 dark:hover:bg-slate-700 transition-all\"\r\n                                    >\r\n                                        NO\r\n                                    </button>\r\n                                </div>\r\n                            )}\r\n\r\n                            <div className=\"w-px h-8 bg-slate-100 dark:bg-slate-800 mx-1\" />\r\n\r\n                            <div className=\"flex flex-col items-end\">\r\n                                <select\r\n                                    value={selectedTicket.status || 'open'}\r\n                                    onChange={(e) => onStatusChange(selectedTicket.id, e.target.value)}\r\n                                    aria-label=\"Cambiar estado del ticket\"\r\n                                    className=\"bg-white/50 dark:bg-slate-950/50 border border-slate-200 dark:border-slate-800 rounded-2xl px-5 py-3 text-xs font-semibold text-slate-700 dark:text-slate-200 focus:outline-none focus:ring-4 focus:ring-indigo-500/10 cursor-pointer transition-all hover:bg-white dark:hover:bg-slate-900 shadow-sm appearance-none min-w-[160px]\"\r\n                                >\r\n                                    {Object.values(TICKET_STATUSES).map(s => (\r\n                                        <option key={s.id} value={s.id}>{s.label}</option>\r\n                                    ))}\r\n                                </select>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Content Scrollable - CHAT MODE */}\r\n                <div className=\"flex-1 overflow-y-auto p-8 space-y-10 bg-slate-50/20 dark:bg-slate-950/20 scroll-smooth\">\r\n                    {/* Original Ticket Info Block */}\r\n                    <div className=\"bg-white/80 dark:bg-slate-900/80 p-8 rounded-3xl border border-slate-100/50 dark:border-slate-800/50 shadow-sm relative overflow-hidden transition-all group hover:shadow-lg backdrop-blur-sm\">\r\n                        <div className=\"absolute top-0 left-0 w-2 h-full bg-indigo-500/80\" />\r\n                        <div className=\"flex items-center gap-4 mb-6\">\r\n                            <div className=\"w-12 h-12 rounded-2xl bg-indigo-50 dark:bg-indigo-500/10 flex items-center justify-center transition-colors shadow-inner\">\r\n                                <User className=\"w-6 h-6 text-indigo-600 dark:text-indigo-400\" />\r\n                            </div>\r\n                            <div>\r\n                                <p className=\"text-xs font-semibold text-slate-900 dark:text-white uppercase tracking-widest mb-1\">Descripci√≥n del Problema</p>\r\n                                {/* @ts-ignore - Firestore timestamp handling */}\r\n                                <p className=\"text-[10px] font-medium text-slate-400 dark:text-slate-500 uppercase tracking-tighter\">Iniciado {selectedTicket.createdAt?.toDate ? formatDate(selectedTicket.createdAt) : 'hace poco'}</p>\r\n                            </div>\r\n                        </div>\r\n                        <div className=\"pl-16\">\r\n                            <p className=\"text-slate-700 dark:text-slate-300 whitespace-pre-wrap font-medium leading-relaxed text-[15px]\">\r\n                                {selectedTicket.message}\r\n                            </p>\r\n\r\n                            {selectedTicket.attachmentUrl && (\r\n                                <div className=\"mt-8 pt-6 border-t border-slate-100 dark:border-slate-800/50\">\r\n                                    <a href={selectedTicket.attachmentUrl} target=\"_blank\" rel=\"noreferrer\" className=\"inline-flex items-center gap-3 px-5 py-3 bg-indigo-50 dark:bg-indigo-500/10 text-indigo-600 dark:text-indigo-400 hover:bg-indigo-100 dark:hover:bg-indigo-500/20 rounded-2xl text-[10px] font-semibold uppercase tracking-widest transition-all shadow-sm active:scale-95\">\r\n                                        <Download className=\"w-4 h-4\" /> Ver Material Adjunto\r\n                                    </a>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Messages Feed */}\r\n                    <div className=\"space-y-8 pb-4\">\r\n                        {messages.map(msg => (\r\n                            <MessageItem key={msg.id} msg={msg} email={selectedTicket.email} />\r\n                        ))}\r\n                    </div>\r\n                    <div ref={messagesEndRef} />\r\n                </div>\r\n\r\n                {/* Reply Box */}\r\n                {selectedTicket.status !== 'resolved' && (\r\n                    <div className=\"p-8 border-t border-slate-200/50 dark:border-slate-800/50 bg-white/60 dark:bg-slate-900/60 backdrop-blur-xl relative z-20\">\r\n                        <div className=\"max-w-4xl mx-auto relative group\">\r\n                            <div className={`rounded-3xl border-2 transition-all duration-300 shadow-sm overflow-hidden focus-within:shadow-2xl focus-within:shadow-indigo-500/10 ${isInternal\r\n                                ? \"bg-amber-50/50 dark:bg-amber-500/10 border-amber-200 dark:border-amber-500/30 focus-within:border-amber-400\"\r\n                                : \"bg-white dark:bg-slate-950 border-slate-200/50 dark:border-white/5 focus-within:border-indigo-500 dark:focus-within:border-indigo-400\"}`}>\r\n                                <textarea\r\n                                    value={reply}\r\n                                    onChange={(e) => setReply(e.target.value)}\r\n                                    placeholder={isInternal ? \"Escribe una nota interna privada (s√≥lo visible para el staff)...\" : \"Redacta tu respuesta al cliente...\"}\r\n                                    className={`w-full min-h-[160px] p-6 text-sm font-medium focus:outline-none bg-transparent text-slate-900 dark:text-slate-200 placeholder:text-slate-400 dark:placeholder:text-slate-600 resize-none transition-colors`}\r\n                                />\r\n                                <div className=\"flex items-center justify-between px-6 py-4 bg-slate-50/50 dark:bg-black/20 border-t border-inherit/50\">\r\n                                    <button\r\n                                        type=\"button\"\r\n                                        onClick={() => setIsInternal(!isInternal)}\r\n                                        className={`flex items-center gap-3 px-5 py-2.5 rounded-2xl transition-all font-semibold text-[10px] uppercase tracking-[0.15em] ${isInternal\r\n                                            ? 'bg-amber-500 text-white shadow-lg shadow-amber-500/30'\r\n                                            : 'bg-slate-200/50 dark:bg-slate-800/50 text-slate-500 dark:text-slate-400 hover:bg-slate-300/50 dark:hover:bg-slate-700'\r\n                                            }`}\r\n                                    >\r\n                                        <Lock size={14} className={isInternal ? 'animate-pulse' : ''} />\r\n                                        <span>{isInternal ? 'Nota Interna' : 'Hacer Interna'}</span>\r\n                                    </button>\r\n\r\n                                    <button\r\n                                        onClick={onReply}\r\n                                        disabled={isSendingReply || !reply.trim()}\r\n                                        className={`flex items-center justify-center gap-3 px-10 py-3 rounded-2xl font-semibold text-[10px] uppercase tracking-widest transition-all shadow-xl ${isSendingReply || !reply.trim()\r\n                                            ? 'bg-slate-200 dark:bg-slate-800 text-slate-400 dark:text-slate-600 cursor-not-allowed shadow-none'\r\n                                            : `text-white hover:scale-[1.02] active:scale-95 ${isInternal ? 'bg-amber-600 hover:bg-amber-500 shadow-amber-500/20' : 'bg-indigo-600 hover:bg-indigo-500 shadow-indigo-500/20'}`\r\n                                            }`}\r\n                                    >\r\n                                        {isSendingReply ? <Loader2 className=\"w-4 h-4 animate-spin\" /> : <Send className=\"w-4 h-4\" />}\r\n                                        <span>{isSendingReply ? 'Enviando' : isInternal ? 'Registrar Nota' : 'Enviar Respuesta'}</span>\r\n                                    </button>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n});\r\n\r\nTicketDetailInner.displayName = 'TicketDetailInner';\r\n\r\n// --- CONTAINER COMPONENT ---\r\n\r\nconst TicketDetail = () => {\r\n    const {\r\n        selectedTicket,\r\n        messages,\r\n        handleStatusChange,\r\n        reply,\r\n        setReply,\r\n        isInternal,\r\n        setIsInternal,\r\n        handleReply,\r\n        isSendingReply,\r\n        handleDeleteTicket,\r\n        messagesEndRef\r\n    } = useSupport() as unknown as SupportContextDetailValue;\r\n\r\n    return (\r\n        <TicketDetailInner\r\n            selectedTicket={selectedTicket}\r\n            messages={messages}\r\n            onStatusChange={handleStatusChange}\r\n            reply={reply}\r\n            setReply={setReply}\r\n            isInternal={isInternal}\r\n            setIsInternal={setIsInternal}\r\n            onReply={handleReply}\r\n            isSendingReply={isSendingReply}\r\n            onDelete={handleDeleteTicket}\r\n            messagesEndRef={messagesEndRef}\r\n        />\r\n    );\r\n};\r\n\r\nexport default TicketDetail;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\support\\TicketList.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\users\\CreateUserModal.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":24,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":24,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1080,1083],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1080,1083],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":55,"column":85,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":55,"endColumn":88,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1860,1863],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1860,1863],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/incompatible-library","severity":1,"message":"Compilation Skipped: Use of incompatible library\n\nThis API returns functions which cannot be memoized without leading to stale UI. To prevent this, by default React Compiler will skip memoizing this component/hook. However, you may see issues if values from this API are passed to other components/hooks that are memoized.\n\nC:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\users\\CreateUserModal.tsx:63:18\n  61 |     });\n  62 |\n> 63 |     const role = watch('role');\n     |                  ^^^^^ React Hook Form's `useForm()` API returns a `watch()` function which cannot be memoized safely.\n  64 |     const pack = watch('pack');\n  65 |     const name = watch('name');\n  66 |","line":63,"column":18,"nodeType":null,"endLine":63,"endColumn":23},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":142,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":142,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5392,5395],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5392,5395],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect } from 'react';\r\nimport { useForm } from 'react-hook-form';\r\nimport { zodResolver } from '@hookform/resolvers/zod';\r\nimport { createUserSchema, updateUserSchema, UserRole } from '../../../lib/schemas';\r\nimport { X, Mail, Building, Loader2, Lock, Briefcase, User } from 'lucide-react';\r\nimport { useToast } from '../../../hooks/useToast';\r\nimport { UserProfile } from '../../../services/userService';\r\nimport { z } from 'zod';\r\n\r\n// =====================================================\r\n// TYPES\r\n// =====================================================\r\nexport type CreateUserInput = z.infer<typeof createUserSchema>;\r\nexport type UpdateUserInput = z.infer<typeof updateUserSchema>;\r\n\r\nexport interface CreateUserModalProps {\r\n    isOpen: boolean;\r\n    onClose: () => void;\r\n    onCreate: (data: CreateUserInput, password?: string) => Promise<void>;\r\n    onUpdate: (uid: string, data: Partial<UpdateUserInput>) => Promise<void>;\r\n    userToEdit?: UserProfile | null;\r\n    isLoading?: boolean;\r\n    initialFranchiseId?: string | null;\r\n    initialData?: any;\r\n}\r\n\r\ntype FormValues = CreateUserInput & { id?: string };\r\n\r\n// =====================================================\r\n// COMPONENT\r\n// =====================================================\r\n\r\nconst CreateUserModal: React.FC<CreateUserModalProps> = ({\r\n    isOpen,\r\n    onClose,\r\n    onCreate,\r\n    onUpdate,\r\n    userToEdit = null,\r\n    isLoading = false,\r\n    initialFranchiseId = null,\r\n    initialData = null\r\n}) => {\r\n    const toastContext = useToast();\r\n    const toast = toastContext?.toast;\r\n\r\n    const {\r\n        register,\r\n        handleSubmit,\r\n        reset,\r\n        watch,\r\n        setValue,\r\n        setError,\r\n        formState: { errors }\r\n    } = useForm<FormValues>({\r\n        resolver: zodResolver((userToEdit ? updateUserSchema : createUserSchema) as any),\r\n        defaultValues: {\r\n            role: (initialFranchiseId ? 'rider' : 'franchise') as UserRole,\r\n            pack: 'basic',\r\n            status: 'active'\r\n        }\r\n    });\r\n\r\n    const role = watch('role');\r\n    const pack = watch('pack');\r\n    const name = watch('name');\r\n\r\n    // Auto-password logic\r\n    useEffect(() => {\r\n        if (!userToEdit && role === 'franchise' && name) {\r\n            const cleanName = name.trim();\r\n            if (cleanName.length > 2) {\r\n                const generated = `${cleanName.charAt(0).toUpperCase() + cleanName.slice(1).toLowerCase()}123!`;\r\n                setValue('password', generated);\r\n            }\r\n        }\r\n    }, [name, role, userToEdit, setValue]);\r\n\r\n    // Initialization Effect\r\n    useEffect(() => {\r\n        if (isOpen) {\r\n            // Logic to pre-fill form... (omitted for brevity, copied from previous logic)\r\n            // Simplified here for clarity of Rewrite\r\n            if (userToEdit) {\r\n                reset({\r\n                    email: userToEdit.email || '',\r\n                    password: '',\r\n                    displayName: userToEdit.displayName || '',\r\n                    phoneNumber: userToEdit.phoneNumber || '',\r\n                    role: (userToEdit.role as UserRole) || 'franchise',\r\n                    franchiseId: userToEdit.franchiseId || '',\r\n                    pack: userToEdit.pack || 'basic',\r\n                    status: (userToEdit.status as 'active' | 'pending' | 'banned') || 'active',\r\n                    name: userToEdit.name || '',\r\n                    legalName: (userToEdit.legalName as string) || '',\r\n                    cif: userToEdit.cif || '',\r\n                    address: userToEdit.address || ''\r\n                });\r\n            } else {\r\n                reset({\r\n                    email: initialData?.email || '',\r\n                    password: '',\r\n                    displayName: '',\r\n                    phoneNumber: '',\r\n                    role: (initialFranchiseId ? 'rider' : 'franchise') as UserRole,\r\n                    franchiseId: initialFranchiseId || '',\r\n                    pack: 'basic',\r\n                    status: 'active',\r\n                    name: '',\r\n                    legalName: initialData?.legalName || '',\r\n                    cif: initialData?.cif || '',\r\n                    address: ''\r\n                });\r\n            }\r\n        }\r\n    }, [isOpen, userToEdit, reset, initialFranchiseId, initialData]);\r\n\r\n    if (!isOpen) return null;\r\n\r\n    const onSubmit = async (data: FormValues) => {\r\n        try {\r\n            if (userToEdit) {\r\n                const updateData: Partial<UpdateUserInput> = {\r\n                    displayName: data.displayName,\r\n                    phoneNumber: data.phoneNumber,\r\n                    role: data.role,\r\n                    status: data.status,\r\n                    ...(data.role === 'franchise' && {\r\n                        franchiseId: data.franchiseId,\r\n                        pack: data.pack,\r\n                        name: data.name,\r\n                        legalName: data.legalName,\r\n                        cif: data.cif,\r\n                        address: data.address\r\n                    }),\r\n                    ...(data.password && { password: data.password })\r\n                };\r\n                await onUpdate(userToEdit.uid || userToEdit.id || '', updateData);\r\n            } else {\r\n                await onCreate(data, data.password);\r\n            }\r\n            onClose();\r\n        } catch (err: any) {\r\n            const firebaseCode = err.code;\r\n            if (firebaseCode && firebaseCode.includes('email')) {\r\n                setError('email', { message: 'El email ya est√° en uso o es inv√°lido' });\r\n            } else {\r\n                toast?.error('Error al guardar');\r\n            }\r\n        }\r\n    };\r\n\r\n    const getTitle = () => {\r\n        if (userToEdit) return 'Editar Perfil';\r\n        if (role === 'franchise') return 'Crear Franquicia';\r\n        return 'Nuevo Usuario';\r\n    };\r\n\r\n    return (\r\n        // OVERLAY\r\n        <div className=\"fixed inset-0 z-[9999] flex items-center justify-center bg-slate-900/30 backdrop-blur-sm p-4 animate-in fade-in duration-200\">\r\n\r\n            {/* MODAL WINDOW */}\r\n            <div className=\"w-full max-w-2xl bg-white dark:bg-slate-950 rounded-2xl shadow-2xl ring-1 ring-black/5 flex flex-col max-h-[85vh] relative overflow-hidden\">\r\n\r\n                {/* HEADER */}\r\n                <div className=\"flex items-center justify-between px-6 py-4 border-b border-slate-100 dark:border-slate-800 shrink-0\">\r\n                    <div className=\"flex flex-col\">\r\n                        <h2 className=\"text-lg font-semibold text-slate-900 dark:text-white tracking-tight\">\r\n                            {getTitle()}\r\n                        </h2>\r\n                        {!userToEdit && (\r\n                            <p className=\"text-xs text-slate-500\">Completa la informaci√≥n requerida</p>\r\n                        )}\r\n                    </div>\r\n                    <button\r\n                        onClick={onClose}\r\n                        title=\"Cerrar modal\"\r\n                        className=\"p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-400 hover:text-slate-600 transition-colors\"\r\n                    >\r\n                        <X className=\"w-5 h-5\" />\r\n                    </button>\r\n                </div>\r\n\r\n                {/* SCROLLABLE BODY */}\r\n                <div className=\"flex-1 overflow-y-auto p-6 custom-scrollbar\">\r\n                    <form id=\"create-user-form\" onSubmit={handleSubmit(onSubmit)} className=\"space-y-8\">\r\n\r\n                        {/* SECTION 1: CREDENTIALS */}\r\n                        <section>\r\n                            <h3 className=\"text-xs font-semibold uppercase tracking-wider text-slate-400 mb-4 flex items-center gap-2\">\r\n                                <Lock className=\"w-3 h-3\" /> Credenciales\r\n                            </h3>\r\n                            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-5\">\r\n                                <div className=\"space-y-1.5\">\r\n                                    <label className=\"text-sm font-medium text-slate-700 dark:text-slate-300\">Email Corporativo</label>\r\n                                    <div className=\"relative\">\r\n                                        <Mail className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400\" />\r\n                                        <input\r\n                                            {...register('email')}\r\n                                            disabled={!!userToEdit}\r\n                                            className=\"w-full pl-9 pr-3 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all\"\r\n                                            placeholder=\"ejemplo@repaart.es\"\r\n                                        />\r\n                                    </div>\r\n                                    {errors.email && <p className=\"text-xs text-rose-500 mt-1\">{errors.email.message as string}</p>}\r\n                                </div>\r\n                                <div className=\"space-y-1.5\">\r\n                                    <label className=\"text-sm font-medium text-slate-700 dark:text-slate-300\">Contrase√±a</label>\r\n                                    <input\r\n                                        type=\"password\"\r\n                                        {...register('password')}\r\n                                        className=\"w-full px-3 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all\"\r\n                                        placeholder={userToEdit ? \"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢\" : \"M√≠nimo 8 caracteres\"}\r\n                                    />\r\n                                </div>\r\n                            </div>\r\n                        </section>\r\n\r\n                        <div className=\"h-px bg-slate-100 dark:bg-slate-800\" />\r\n\r\n                        {/* SECTION 2: PERSONAL INFO */}\r\n                        <section>\r\n                            <h3 className=\"text-xs font-semibold uppercase tracking-wider text-slate-400 mb-4 flex items-center gap-2\">\r\n                                <User className=\"w-3 h-3\" /> Datos de Perfil\r\n                            </h3>\r\n                            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-5\">\r\n                                <div className=\"space-y-1.5\">\r\n                                    <label className=\"text-sm font-medium text-slate-700 dark:text-slate-300\">Nombre / Raz√≥n Social</label>\r\n                                    <input\r\n                                        {...register('displayName')}\r\n                                        className=\"w-full px-3 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all\"\r\n                                    />\r\n                                </div>\r\n                                <div className=\"space-y-1.5\">\r\n                                    <label className=\"text-sm font-medium text-slate-700 dark:text-slate-300\">Tel√©fono</label>\r\n                                    <input\r\n                                        {...register('phoneNumber')}\r\n                                        className=\"w-full px-3 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all\"\r\n                                    />\r\n                                </div>\r\n                            </div>\r\n                        </section>\r\n\r\n                        <div className=\"h-px bg-slate-100 dark:bg-slate-800\" />\r\n\r\n                        {/* SECTION 3: ROLE & CONTEXT */}\r\n                        <section>\r\n                            <h3 className=\"text-xs font-semibold uppercase tracking-wider text-slate-400 mb-4 flex items-center gap-2\">\r\n                                <Briefcase className=\"w-3 h-3\" /> Rol y Permisos\r\n                            </h3>\r\n                            <div className=\"space-y-4\">\r\n                                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-5\">\r\n                                    <div className=\"space-y-1.5\">\r\n                                        <label className=\"text-sm font-medium text-slate-700 dark:text-slate-300\">Rol de Sistema</label>\r\n                                        <select\r\n                                            {...register('role')}\r\n                                            title=\"Seleccionar rol\"\r\n                                            aria-label=\"Seleccionar rol\"\r\n                                            disabled={!!initialFranchiseId}\r\n                                            className=\"w-full px-3 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all\"\r\n                                        >\r\n                                            <option value=\"franchise\">Franquicia</option>\r\n                                            <option value=\"admin\">Administrador Global</option>\r\n                                            <option value=\"staff\">Staff / Soporte</option>\r\n                                            <option value=\"rider\">Rider / Repartidor</option>\r\n                                            <option value=\"user\">Usuario Final</option>\r\n                                        </select>\r\n                                    </div>\r\n                                    <div className=\"space-y-1.5\">\r\n                                        <label className=\"text-sm font-medium text-slate-700 dark:text-slate-300\">Estado</label>\r\n                                        <select\r\n                                            {...register('status')}\r\n                                            title=\"Seleccionar estado\"\r\n                                            aria-label=\"Seleccionar estado\"\r\n                                            className=\"w-full px-3 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all\"\r\n                                        >\r\n                                            <option value=\"active\">Activo</option>\r\n                                            <option value=\"pending\">Pendiente</option>\r\n                                            <option value=\"banned\">Suspendido</option>\r\n                                        </select>\r\n                                    </div>\r\n                                </div>\r\n\r\n                                {/* FRANCHISE FIELDS */}\r\n                                {role === 'franchise' && (\r\n                                    <div className=\"bg-slate-50 dark:bg-slate-900/50 p-4 rounded-xl border border-slate-200 dark:border-slate-800 space-y-4 animate-in slide-in-from-top-2\">\r\n                                        <div className=\"flex items-center justify-between\">\r\n                                            <h4 className=\"text-sm font-semibold text-slate-900 dark:text-white\">Datos de Franquicia</h4>\r\n                                            <Building className=\"w-4 h-4 text-slate-400\" />\r\n                                        </div>\r\n\r\n                                        <div className=\"grid grid-cols-2 gap-4\">\r\n                                            <div className=\"space-y-1\">\r\n                                                <label className=\"text-xs text-slate-500\">ID de Plaza (City)</label>\r\n                                                <input {...register('name')} placeholder=\"Madrid\" className=\"w-full p-2 text-sm border border-slate-200 rounded-md\" />\r\n                                            </div>\r\n                                            <div className=\"space-y-1\">\r\n                                                <label className=\"text-xs text-slate-500\">ID √önico (Firebase)</label>\r\n                                                <input {...register('franchiseId')} placeholder=\"MAD01\" className=\"w-full p-2 text-sm border border-slate-200 rounded-md\" />\r\n                                            </div>\r\n                                        </div>\r\n\r\n                                        <div className=\"space-y-2\">\r\n                                            <label className=\"text-xs font-medium text-slate-500\">Plan de Servicio</label>\r\n                                            <div className=\"grid grid-cols-2 gap-3\">\r\n                                                <button\r\n                                                    type=\"button\"\r\n                                                    onClick={() => setValue('pack', 'basic')}\r\n                                                    className={`py-2 text-xs font-medium rounded-lg border ${pack === 'basic' ? 'bg-white shadow-sm border-slate-300 text-slate-900' : 'text-slate-500 border-transparent hover:bg-slate-200'}`}\r\n                                                >\r\n                                                    Basic\r\n                                                </button>\r\n                                                <button\r\n                                                    type=\"button\"\r\n                                                    onClick={() => setValue('pack', 'premium')}\r\n                                                    className={`py-2 text-xs font-medium rounded-lg border ${pack === 'premium' ? 'bg-slate-800 text-white border-slate-900' : 'text-slate-500 border-transparent hover:bg-slate-200'}`}\r\n                                                >\r\n                                                    Premium\r\n                                                </button>\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n                        </section>\r\n                    </form>\r\n                </div>\r\n\r\n                {/* FOOTER */}\r\n                <div className=\"p-4 border-t border-slate-100 dark:border-slate-800 shrink-0 flex justify-end gap-3 bg-slate-50/50 dark:bg-slate-900/50\">\r\n                    <button\r\n                        onClick={onClose}\r\n                        className=\"px-4 py-2 text-sm font-medium text-slate-600 hover:text-slate-900 transition-colors\"\r\n                    >\r\n                        Cancelar\r\n                    </button>\r\n                    <button\r\n                        form=\"create-user-form\"\r\n                        type=\"submit\"\r\n                        disabled={isLoading}\r\n                        className=\"px-6 py-2 bg-slate-900 dark:bg-white text-white dark:text-slate-900 text-sm font-medium rounded-lg shadow-sm hover:shadow-md hover:-translate-y-0.5 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2\"\r\n                    >\r\n                        {isLoading && <Loader2 className=\"w-4 h-4 animate-spin\" />}\r\n                        {userToEdit ? 'Guardar Cambios' : 'Crear'}\r\n                    </button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default CreateUserModal;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\users\\UserManagementPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\admin\\users\\UserTable.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":109,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":109,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5660,5663],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5660,5663],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useRef, useState, useEffect } from 'react';\r\nimport { Shield, Trash2, Ban, Edit, Building, User } from 'lucide-react';\r\nimport { getStatusConfig } from '../../../lib/constants';\r\nimport { formatDate } from '../../../utils/formatDate';\r\nimport { UserProfile } from '../../../services/userService';\r\n\r\n// =====================================================\r\n// TYPES & INTERFACES\r\n// =====================================================\r\n\r\nexport type UserAction = 'edit' | 'delete' | 'toggleStatus';\r\n\r\ninterface UserRowProps {\r\n    user: UserProfile;\r\n    style?: React.CSSProperties;\r\n    onAction: (action: UserAction, user: UserProfile) => void;\r\n    currentUserRole: string;\r\n    readOnly?: boolean;\r\n    franchiseId?: string | null;\r\n}\r\n\r\ninterface UserTableProps {\r\n    users: UserProfile[];\r\n    onAction: (action: UserAction, user: UserProfile) => void;\r\n    currentUserRole: string;\r\n    readOnly?: boolean;\r\n    franchiseId?: string | null;\r\n}\r\n\r\n// =====================================================\r\n// COMPONENTS\r\n// =====================================================\r\n\r\n// --- ROW COMPONENT (Pure for performance) ---\r\nconst UserRow: React.FC<UserRowProps> = ({ user, style, onAction, currentUserRole, readOnly, franchiseId }) => {\r\n\r\n    const statusConfig = getStatusConfig(user.status ?? 'active');\r\n\r\n    // Role Badge Logic\r\n    const getRoleBadge = (role: string) => {\r\n        switch (role) {\r\n            case 'admin':\r\n                return { label: 'ADMINISTRADOR', bg: 'bg-indigo-500 text-white border-indigo-600', icon: <Shield className=\"w-3 h-3\" /> };\r\n            case 'franchise':\r\n                return { label: 'FRANQUICIA', bg: 'bg-amber-500 text-black border-amber-600 font-extrabold', icon: <Building className=\"w-3 h-3\" /> };\r\n            case 'rider':\r\n                return { label: 'RIDER', bg: 'bg-slate-700 text-slate-300 border-slate-600', icon: <User className=\"w-3 h-3\" /> };\r\n            default:\r\n                return { label: role.toUpperCase(), bg: 'bg-slate-800 text-slate-400 border-slate-700', icon: <User className=\"w-3 h-3\" /> };\r\n        }\r\n    };\r\n\r\n    const roleBadge = getRoleBadge(user.role || 'user');\r\n\r\n    return (\r\n        <div style={style} className=\"flex items-center border-b border-white/5 hover:bg-white/5 transition-colors px-4 group\">\r\n            {/* User Info */}\r\n            <div className=\"flex-1 flex items-center gap-3 min-w-[200px]\">\r\n                <div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold ring-1 ring-inset ${user.role === 'franchise' ? 'bg-amber-500/20 text-amber-400 ring-amber-500/30' : 'bg-indigo-500/20 text-indigo-300 ring-indigo-500/30'}`}>\r\n                    {(user.displayName || user.email || 'XX').substring(0, 2).toUpperCase()}\r\n                </div>\r\n                <div className=\"flex flex-col\">\r\n                    <span className=\"text-sm font-bold text-white tracking-tight truncate max-w-[180px]\" title={user.displayName}>{user.displayName || 'Usuario Sin Nombre'}</span>\r\n                    <span className=\"text-[10px] text-slate-400 font-medium uppercase tracking-wider truncate max-w-[180px]\" title={user.email}>{user.email || 'Sin email'}</span>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Role */}\r\n            <div className=\"w-[140px] hidden md:flex\">\r\n                <span className={`px-2 py-0.5 rounded text-[10px] font-bold uppercase border flex items-center gap-1.5 shadow-sm ${roleBadge.bg}`}>\r\n                    {roleBadge.icon}\r\n                    {roleBadge.label}\r\n                </span>\r\n            </div>\r\n\r\n            {/* Pack (Franchise Only) */}\r\n            <div className=\"w-[100px] hidden lg:flex items-center\">\r\n                {user.role === 'franchise' && user.pack && (\r\n                    <span className={`px-2 py-0.5 rounded text-[10px] font-black uppercase border tracking-tight ${user.pack === 'premium'\r\n                        ? 'bg-gradient-to-r from-amber-500 to-yellow-500 text-black border-amber-400'\r\n                        : 'bg-slate-800 text-slate-400 border-slate-700'\r\n                        }`}>\r\n                        {user.pack}\r\n                    </span>\r\n                )}\r\n            </div>\r\n\r\n            {/* Status */}\r\n            <div className=\"w-[100px] hidden sm:flex\">\r\n                <span className={`px-2 py-0.5 rounded text-[10px] font-bold uppercase border ${statusConfig.bg === 'bg-emerald-100' ? 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20' :\r\n                    user.status === 'pending' ? 'bg-amber-500/10 text-amber-400 border-amber-500/20' :\r\n                        'bg-rose-500/10 text-rose-400 border-rose-500/20'\r\n                    }`}>\r\n                    {user.status === 'active' ? 'ACTIVO' : user.status === 'pending' ? 'PENDIENTE' : 'BLOQUEADO'}\r\n                </span>\r\n            </div>\r\n\r\n            {!franchiseId && (\r\n                <div className=\"w-[120px] hidden xl:flex text-xs text-slate-500 font-medium truncate\" title={user.role === 'franchise' ? `UID: ${user.uid || user.id}` : user.franchiseId}>\r\n                    {user.role === 'franchise'\r\n                        ? <span className=\"font-mono text-[10px] bg-slate-100 dark:bg-slate-800 px-1 rounded\">{(user.uid || user.id || '').substring(0, 8)}...</span>\r\n                        : (user.franchiseId || '-')\r\n                    }\r\n                </div>\r\n            )}\r\n\r\n            {/* Date */}\r\n            <div className=\"w-[100px] hidden 2xl:flex text-[10px] text-slate-600 font-bold uppercase tracking-wider\">\r\n                {formatDate(user.createdAt as any)}\r\n            </div>\r\n\r\n            {/* Actions */}\r\n            <div className=\"w-[60px] flex justify-end\">\r\n                {currentUserRole === 'admin' && !readOnly && (\r\n                    <div className=\"flex items-center gap-1 opacity-100 md:opacity-0 md:group-hover:opacity-100 transition-opacity\">\r\n                        <button\r\n                            onClick={() => onAction('toggleStatus', user)}\r\n                            className={`p-1.5 rounded transition-colors ${user.status === 'active' ? 'text-green-500 hover:bg-green-500/10' : 'text-slate-400 hover:text-amber-400 hover:bg-amber-500/10'}`}\r\n                            title={user.status === 'active' ? \"Usuario Activo\" : \"Usuario Bloqueado/Pendiente\"}\r\n                        >\r\n                            <Ban className=\"w-4 h-4\" />\r\n                        </button>\r\n                        <button\r\n                            onClick={() => onAction('edit', user)}\r\n                            className=\"p-1.5 text-slate-400 hover:text-blue-400 rounded hover:bg-blue-500/10 transition-colors\"\r\n                            title=\"Editar Usuario\"\r\n                        >\r\n                            <Edit className=\"w-4 h-4\" />\r\n                        </button>\r\n                        <button\r\n                            onClick={() => onAction('delete', user)}\r\n                            className=\"p-1.5 text-slate-400 hover:text-rose-400 rounded hover:bg-rose-500/10 transition-colors\"\r\n                            title=\"Eliminar Usuario\"\r\n                        >\r\n                            <Trash2 className=\"w-4 h-4\" />\r\n                        </button>\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\n// --- VIRTUALIZED TABLE ---\r\n\r\nconst ROW_HEIGHT = 60; // Fixed height strictly enforced\r\n\r\nconst UserTable: React.FC<UserTableProps> = ({ users, onAction, currentUserRole, readOnly, franchiseId }) => {\r\n    const containerRef = useRef<HTMLDivElement>(null);\r\n    const [scrollTop, setScrollTop] = useState(0);\r\n    const [containerHeight, setContainerHeight] = useState(600);\r\n\r\n    // Dynamic resize handler\r\n    useEffect(() => {\r\n        const handleResize = (): void => {\r\n            if (containerRef.current) {\r\n                setContainerHeight(containerRef.current.clientHeight);\r\n            }\r\n        };\r\n        // Initial set\r\n        handleResize();\r\n        window.addEventListener('resize', handleResize);\r\n        return () => window.removeEventListener('resize', handleResize);\r\n    }, []);\r\n\r\n    // Virtualization Logic\r\n    const totalContentHeight = users.length * ROW_HEIGHT;\r\n    const startIndex = Math.max(0, Math.floor(scrollTop / ROW_HEIGHT) - 2); // Buffer top\r\n    const endIndex = Math.min(users.length, Math.floor((scrollTop + containerHeight) / ROW_HEIGHT) + 2); // Buffer bottom\r\n    const visibleUsers = users.slice(startIndex, endIndex);\r\n    const offsetY = startIndex * ROW_HEIGHT;\r\n\r\n    const handleScroll = (e: React.UIEvent<HTMLDivElement>): void => {\r\n        requestAnimationFrame(() => {\r\n            setScrollTop(e.currentTarget.scrollTop);\r\n        });\r\n    };\r\n\r\n    if (users.length === 0) {\r\n        return (\r\n            <div className=\"h-[400px] flex flex-col items-center justify-center text-slate-400 border-0 rounded-xl glass-panel-exec\">\r\n                <p className=\"font-bold\">No se encontraron usuarios</p>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"glass-panel-exec rounded-xl overflow-hidden shadow-lg flex flex-col h-full ring-1 ring-white/10\">\r\n            {/* Header - Fixed to avoid scroll */}\r\n            <div className=\"bg-white/5 border-b border-white/5 flex items-center px-4 h-[40px] shrink-0 backdrop-blur-sm\">\r\n                <div className=\"flex-1 text-xs font-bold text-indigo-300 uppercase tracking-wider\">Usuario</div>\r\n                <div className=\"w-[140px] hidden md:block text-xs font-bold text-indigo-300 uppercase tracking-wider\">Rol</div>\r\n                <div className=\"w-[100px] hidden lg:block text-xs font-bold text-indigo-300 uppercase tracking-wider\">Pack</div>\r\n                <div className=\"w-[100px] hidden sm:block text-xs font-bold text-indigo-300 uppercase tracking-wider\">Estado</div>\r\n                {!franchiseId && <div className=\"w-[120px] hidden xl:block text-xs font-bold text-indigo-300 uppercase tracking-wider\">ID Franq.</div>}\r\n                <div className=\"w-[100px] hidden 2xl:block text-xs font-bold text-indigo-300 uppercase tracking-wider\">Fecha</div>\r\n                <div className=\"w-[60px]\" />\r\n            </div>\r\n\r\n            {/* Virtual Scroll Container */}\r\n            {/* Virtual Scroll Container with Horizontal Scroll Support */}\r\n            <div\r\n                ref={containerRef}\r\n                onScroll={handleScroll}\r\n                className=\"flex-1 overflow-y-auto relative custom-scrollbar overflow-x-auto\"\r\n                style={{ height: '100%' }}\r\n            >\r\n                {/* Min-width wrapper to force horizontal scroll on small screens */}\r\n                <div style={{ height: totalContentHeight, position: 'relative', minWidth: '800px' }}>\r\n                    <div style={{ transform: `translateY(${offsetY}px)` }}>\r\n                        {visibleUsers.map((user) => (\r\n                            <UserRow\r\n                                key={user.uid || user.id}\r\n                                user={user}\r\n                                style={{ height: ROW_HEIGHT }}\r\n                                onAction={onAction}\r\n                                currentUserRole={currentUserRole}\r\n                                readOnly={readOnly}\r\n                                franchiseId={franchiseId}\r\n                            />\r\n                        ))}\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default UserTable;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\auth\\Login.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\auth\\ProtectedRoute.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\common\\UserManual\\UserManual.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'node' is defined but never used. Allowed unused args must match /^_/u.","line":93,"column":52,"nodeType":"Identifier","messageId":"unusedVar","endLine":93,"endColumn":56},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'node' is defined but never used. Allowed unused args must match /^_/u.","line":94,"column":48,"nodeType":"Identifier","messageId":"unusedVar","endLine":94,"endColumn":52},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'node' is defined but never used. Allowed unused args must match /^_/u.","line":95,"column":48,"nodeType":"Identifier","messageId":"unusedVar","endLine":95,"endColumn":52}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\r\nimport { MANUAL_TOPICS } from './manualContent';\r\nimport { Search, ChevronRight, BookOpen } from 'lucide-react';\r\nimport ReactMarkdown from 'react-markdown';\r\n\r\ninterface UserManualProps {\r\n    role: 'admin' | 'franchise';\r\n}\r\n\r\nconst UserManual: React.FC<UserManualProps> = ({ role }) => {\r\n    const [activeTopicId, setActiveTopicId] = useState<string>(MANUAL_TOPICS[0].id);\r\n    const [searchTerm, setSearchTerm] = useState('');\r\n\r\n    // Filter topics based on role and search\r\n    const filteredTopics = MANUAL_TOPICS.filter(topic => {\r\n        const roleMatch = topic.role === 'all' || topic.role === role;\r\n        const searchMatch = !searchTerm ||\r\n            topic.title.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n            topic.content.some(c => c.title.toLowerCase().includes(searchTerm.toLowerCase()) || c.body.toLowerCase().includes(searchTerm.toLowerCase()));\r\n\r\n        return roleMatch && searchMatch;\r\n    });\r\n\r\n    const activeTopic = MANUAL_TOPICS.find(t => t.id === activeTopicId) || MANUAL_TOPICS[0];\r\n\r\n    return (\r\n        <div className=\"flex h-[calc(100vh-200px)] bg-white/50 dark:bg-slate-900/50 backdrop-blur-xl border border-white/60 dark:border-slate-800 rounded-3xl overflow-hidden shadow-sm\">\r\n\r\n            {/* SIDEBAR */}\r\n            <div className=\"w-1/3 min-w-[250px] border-r border-slate-200 dark:border-slate-800 flex flex-col bg-slate-50/50 dark:bg-slate-900/50\">\r\n                <div className=\"p-4 border-b border-slate-200 dark:border-slate-800\">\r\n                    <div className=\"relative\">\r\n                        <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400\" />\r\n                        <input\r\n                            type=\"text\"\r\n                            placeholder=\"Buscar en el manual...\"\r\n                            value={searchTerm}\r\n                            onChange={(e) => setSearchTerm(e.target.value)}\r\n                            className=\"w-full bg-white dark:bg-slate-800 border-none rounded-xl py-2 pl-9 pr-4 text-sm focus:ring-2 focus:ring-indigo-500/20 outline-none transition-all\"\r\n                        />\r\n                    </div>\r\n                </div>\r\n\r\n                <div className=\"flex-1 overflow-y-auto p-2 space-y-1\">\r\n                    {filteredTopics.map(topic => (\r\n                        <button\r\n                            key={topic.id}\r\n                            onClick={() => setActiveTopicId(topic.id)}\r\n                            className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left transition-all ${activeTopicId === topic.id\r\n                                ? 'bg-white dark:bg-slate-800 text-indigo-600 dark:text-white shadow-sm ring-1 ring-slate-200 dark:ring-slate-700'\r\n                                : 'text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800/50 hover:text-slate-900 dark:hover:text-slate-200'\r\n                                }`}\r\n                        >\r\n                            <topic.icon className={`w-5 h-5 ${activeTopicId === topic.id ? 'text-indigo-500' : 'text-slate-400'}`} />\r\n                            <span className=\"font-bold text-sm tracking-tight flex-1\">{topic.title}</span>\r\n                            {activeTopicId === topic.id && <ChevronRight className=\"w-4 h-4 text-indigo-400\" />}\r\n                        </button>\r\n                    ))}\r\n\r\n                    {filteredTopics.length === 0 && (\r\n                        <div className=\"p-8 text-center text-slate-400 text-sm\">\r\n                            No se encontraron temas.\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            {/* CONTENT AREA */}\r\n            <div className=\"flex-1 overflow-y-auto p-8 lg:p-12 scroll-smooth\">\r\n                <div className=\"max-w-3xl mx-auto\">\r\n\r\n                    {/* Topic Header */}\r\n                    <div className=\"flex items-center gap-4 mb-8 pb-6 border-b border-slate-200 dark:border-slate-800\">\r\n                        <div className=\"p-3 bg-indigo-50 dark:bg-indigo-900/20 rounded-2xl text-indigo-600 dark:text-indigo-400\">\r\n                            <activeTopic.icon className=\"w-8 h-8\" />\r\n                        </div>\r\n                        <div>\r\n                            <span className=\"text-xs font-black uppercase tracking-widest text-slate-400 mb-1 block\">Manual de Usuario</span>\r\n                            <h2 className=\"text-3xl font-black text-slate-900 dark:text-white leading-none\">{activeTopic.title}</h2>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Topic Content Blocks */}\r\n                    <div className=\"space-y-10\">\r\n                        {activeTopic.content.map((block, idx) => (\r\n                            <div key={idx} className=\"animate-in fade-in slide-in-from-bottom-4 duration-700\" style={{ animationDelay: `${idx * 100}ms` }}>\r\n                                <h3 className=\"text-xl font-bold text-slate-800 dark:text-slate-100 mb-4 flex items-center gap-2\">\r\n                                    <span className=\"w-1.5 h-6 bg-indigo-500 rounded-full inline-block\" />\r\n                                    {block.title}\r\n                                </h3>\r\n                                <div className=\"prose prose-slate dark:prose-invert prose-sm max-w-none text-slate-600 dark:text-slate-400\">\r\n                                    <ReactMarkdown components={{\r\n                                        strong: ({ node, ...props }) => <span className=\"font-black text-slate-900 dark:text-white\" {...props} />,\r\n                                        ul: ({ node, ...props }) => <ul className=\"list-disc pl-4 space-y-2 mt-2\" {...props} />,\r\n                                        li: ({ node, ...props }) => <li className=\"pl-1\" {...props} />\r\n                                    }}>\r\n                                        {block.body}\r\n                                    </ReactMarkdown>\r\n                                </div>\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n\r\n                    {/* Footer */}\r\n                    <div className=\"mt-16 pt-8 border-t border-dashed border-slate-200 dark:border-slate-800 text-center\">\r\n                        <p className=\"text-xs text-slate-400 flex items-center justify-center gap-2\">\r\n                            <BookOpen className=\"w-3 h-3\" />\r\n                            Repaart Finanzas Doc v3.0\r\n                        </p>\r\n                    </div>\r\n\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default UserManual;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\common\\UserManual\\manualContent.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":14,"column":11,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":14,"endColumn":14,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[223,226],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[223,226],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import {\r\n    Book,\r\n    LayoutDashboard,\r\n    DollarSign,\r\n    Calendar,\r\n    Users,\r\n    Settings,\r\n    FolderOpen\r\n} from 'lucide-react';\r\n\r\nexport interface ManualTopic {\r\n    id: string;\r\n    title: string;\r\n    icon: any;\r\n    role: 'all' | 'admin' | 'franchise';\r\n    content: {\r\n        title: string;\r\n        body: string; // Markdown supported\r\n    }[];\r\n}\r\n\r\nexport const MANUAL_TOPICS: ManualTopic[] = [\r\n    // --- INTRO & COMMON ---\r\n    {\r\n        id: 'intro',\r\n        title: 'Introducci√≥n Exclusiva',\r\n        icon: Book,\r\n        role: 'all',\r\n        content: [\r\n            {\r\n                title: 'Bienvenido a Repaart Finanzas',\r\n                body: `Bienvenido a la plataforma centralizada de gesti√≥n. Esta herramienta ha sido dise√±ada bajo la filosof√≠a **\"Executive Glass\"**, combinando una est√©tica premium con funcionalidades cr√≠ticas de negocio.\r\n                \r\nSu objetivo es servir como la √∫nica fuente de la verdad para toda la operativa financiera, log√≠stica y de recursos humanos de la red.`\r\n            },\r\n            {\r\n                title: 'Primeros Pasos',\r\n                body: `La interfaz se divide en dos √°reas principales:\r\n                \r\n1.  **Barra Lateral de Navegaci√≥n**: Acceso r√°pido a todos los m√≥dulos (Dashboard, Usuarios, Finanzas, etc.).\r\n2.  **√Årea de Trabajo Principal**: Donde ocurre la acci√≥n. Cambia din√°micamente seg√∫n el m√≥dulo seleccionado.\r\n\r\n**Tip Pro**: Usa el atajo \\`Ctrl + K\\` (o el icono de lupa) para abrir la b√∫squeda global en cualquier momento.`\r\n            }\r\n        ]\r\n    },\r\n\r\n    // --- ADMIN MODULES ---\r\n    {\r\n        id: 'admin_dashboard',\r\n        title: 'Centro de Mando (Dashboard)',\r\n        icon: LayoutDashboard,\r\n        role: 'admin',\r\n        content: [\r\n            {\r\n                title: 'Visi√≥n de Alto Nivel',\r\n                body: `El Dashboard Admin no es solo un resumen; es un centro de control operativo.\r\n                \r\n*   **M√©tricas en Tiempo Real**: Las tarjetas superiores (\"Active Franchises\", \"Total Revenue\") se actualizan en vivo.\r\n*   **Estado del Sistema**: El widget \"System Health\" monitoriza la latencia de la base de datos y el estado de los servidores de autenticaci√≥n.\r\n*   **Mapa de Red**: Visualiza la distribuci√≥n geogr√°fica de tus unidades. Un punto rojo indica una alerta cr√≠tica.`\r\n            },\r\n            {\r\n                title: 'Inteligencia Artificial (Anomaly Detector)',\r\n                body: `El sistema monitoriza constantemente los flujos financieros en busca de irregularidades.\r\n                \r\n**¬øQu√© detecta?**\r\n*   **Ca√≠das de Ingresos**: Si una franquicia reporta 0‚Ç¨ en un d√≠a laborable.\r\n*   **M√°rgenes Cr√≠ticos**: Si los gastos superan el 95% de los ingresos.\r\n*   **Patrones Inusuales**: Picos de facturaci√≥n no justificados.\r\n\r\nCuando veas una alerta en el widget de \"Inteligencia\", haz clic para ver el detalle y contactar con la franquicia.`\r\n            }\r\n        ]\r\n    },\r\n    {\r\n        id: 'user_management',\r\n        title: 'Gesti√≥n de Usuarios',\r\n        icon: Users,\r\n        role: 'admin',\r\n        content: [\r\n            {\r\n                title: 'Alta de Nuevas Unidades',\r\n                body: `El proceso de alta es cr√≠tico para la seguridad.\r\n                \r\n1.  Navega a la pesta√±a **Usuarios**.\r\n2.  Pulsa **\"Crear Usuario\"**.\r\n3.  **Roles**:\r\n    *   **Franquicia**: Propietarios de unidad. Necesitan un ID de ubicaci√≥n √∫nico.\r\n    *   **Admin**: Acceso total. *√ösalo con precauci√≥n*.\r\n    *   **Rider**: Personal de reparto. Se asignan a una franquicia espec√≠fica.\r\n    \r\n**Importante**: La contrase√±a temporal debe ser comunicada por un canal seguro (ej. en persona o llamada), nunca por email.`\r\n            },\r\n            {\r\n                title: 'Control de Seguridad',\r\n                body: `Desde la tabla de usuarios puedes:\r\n*   **Resetear Contrase√±a**: Si un usuario la olvida.\r\n*   **Desactivar Cuenta**: Para empleados que abandonan la empresa. El acceso se revoca inmediatamente.\r\n*   **Auditor√≠a de Accesos**: Ver cu√°ndo fue la √∫ltima vez que un usuario inici√≥ sesi√≥n.`\r\n            }\r\n        ]\r\n    },\r\n    {\r\n        id: 'global_finance',\r\n        title: 'Finanzas Globales',\r\n        icon: DollarSign,\r\n        role: 'admin',\r\n        content: [\r\n            {\r\n                title: 'Flujo de Validaci√≥n Mensual',\r\n                body: `Como Admin, eres el responsable de validar la salud financiera de la red.\r\n                \r\n**El Ciclo de Cierre:**\r\n1.  La Franquicia env√≠a su cierre (d√≠as 1-5 del mes).\r\n2.  Aparece en tu **Bandeja de Entrada Financiera**.\r\n3.  **Revisi√≥n**: Analiza los Ticket Medio y el Margen Operativo.\r\n4.  **Decisi√≥n**:\r\n    *   **Validar**: Los datos se consolidan.\r\n    *   **Rechazar**: Debes aportar una raz√≥n. La franquicia recibe una notificaci√≥n para corregir.\r\n    \r\n**Bloqueo**: Una vez validado, el mes queda \"sellado\" y no se puede modificar.`\r\n            },\r\n            {\r\n                title: 'An√°lisis de Tendencias',\r\n                body: `Usa los gr√°ficos comparativos para detectar tendencias a medio plazo.\r\n                \r\n*   **L√≠nea Verde**: Crecimiento sostenido.\r\n*   **L√≠nea Roja**: Declive. Investiga si es estacional o un problema operativo.`\r\n            }\r\n        ]\r\n    },\r\n    {\r\n        id: 'digital_vault',\r\n        title: 'B√≥veda Digital (Recursos)',\r\n        icon: FolderOpen,\r\n        role: 'admin',\r\n        content: [\r\n            {\r\n                title: 'Gesti√≥n de Conocimiento',\r\n                body: `La B√≥veda Digital es el repositorio oficial de la empresa. Todo lo que subas aqu√≠ es visible para la red.\r\n                \r\n**Estructura Recomendada:**\r\n*   **Marco Legal**: Contratos y normativas.\r\n*   **Manuales Operativos**: Gu√≠as paso a paso (como esta).\r\n*   **Activos de Marca**: Logos y plantillas de marketing.\r\n                \r\n**Tip**: Usa el bot√≥n \"Pin\" (chincheta) para fijar documentos importantes al inicio de la lista.`\r\n            },\r\n            {\r\n                title: 'Subida de Archivos',\r\n                body: `El sistema previsualiza autom√°ticamente PDFs e im√°genes.\r\n                \r\n1.  Pulsa **\"Subir Nuevo Recurso\"**.\r\n2.  Arrastra el archivo o b√∫scalo en tu PC.\r\n3.  Asigna una **Categor√≠a** correcta (clave para que lo encuentren).\r\n4.  Pulsa **Subir**.\r\n                \r\n*L√≠mite de tama√±o: 25MB por archivo.*`\r\n            }\r\n        ]\r\n    },\r\n    {\r\n        id: 'system_settings',\r\n        title: 'Configuraci√≥n del Sistema',\r\n        icon: Settings,\r\n        role: 'admin',\r\n        content: [\r\n            {\r\n                title: 'Ajustes Globales',\r\n                body: `Aqu√≠ defines las reglas del juego para toda la red.\r\n                \r\n*   **L√≠mites de Gastos**: Umbrales que disparan alertas autom√°ticas.\r\n*   **Notificaciones**: Configura qu√© eventos env√≠an email adem√°s de aviso in-app.\r\n*   **Mantenimiento**: Opci√≥n para poner la plataforma en modo \"Solo Lectura\" durante actualizaciones.`\r\n            },\r\n            {\r\n                title: 'Logs de Auditor√≠a',\r\n                body: `El sistema registra *cada acci√≥n* importante (creaci√≥n de usuario, borrado de archivo, validaci√≥n financiera).\r\n                \r\nUsa el buscador de logs para investigar incidentes de seguridad o errores operativos. Cada entrada incluye: Qui√©n, Qu√©, Cu√°ndo y Desde d√≥nde (IP).`\r\n            }\r\n        ]\r\n    },\r\n\r\n    // --- FRANCHISE MODULES (Resumed) ---\r\n    {\r\n        id: 'franchise_dashboard',\r\n        title: 'Mi Negocio (Dashboard)',\r\n        icon: LayoutDashboard,\r\n        role: 'franchise',\r\n        content: [\r\n            {\r\n                title: 'Tus M√©tricas',\r\n                body: `Tu panel principal se enfoca en lo que importa hoy.\r\n*   **Facturaci√≥n Estimada**: Proyecci√≥n de cierre de mes.\r\n*   **Eficiencia**: Ratio de tickets por hora trabajada.\r\n*   **Avisos**: Recordatorios de cierres pendientes o documentos nuevos.`\r\n            }\r\n        ]\r\n    },\r\n    {\r\n        id: 'franchise_finance',\r\n        title: 'Mis Finanzas',\r\n        icon: DollarSign,\r\n        role: 'franchise',\r\n        content: [\r\n            {\r\n                title: 'Registro Diario',\r\n                body: `La disciplina es clave. Registra tus tickets al final de cada jornada.\r\n                \r\nEl sistema acumula autom√°ticamente tus ingresos y calcula el desglose de IVA y Royalties estimados en tiempo real.`\r\n            }\r\n        ]\r\n    },\r\n    {\r\n        id: 'franchise_ops',\r\n        title: 'Operativa Diaria',\r\n        icon: Calendar,\r\n        role: 'franchise',\r\n        content: [\r\n            {\r\n                title: 'Agenda y Citas',\r\n                body: `Gestiona tus servicios programados. La vista de calendario te permite arrastrar citas para reprogramarlas.\r\n                \r\nRecuerda marcar las citas como \"Completadas\" para que sumen a tu productividad.`\r\n            }\r\n        ]\r\n    }\r\n];\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\fleet\\RidersView.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":176,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":176,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7356,7359],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7356,7359],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState } from 'react';\r\nimport { Plus, Search, Edit2, Trash2 } from 'lucide-react';\r\nimport { useFleetStore, Rider } from '../../store/useFleetStore';\r\nimport { Table, Column } from '../../ui/data-display/Table';\r\nimport { Button } from '../../ui/primitives/Button';\r\nimport { Drawer } from '../../ui/overlays/Drawer';\r\nimport { RiderForm } from './components/RiderForm';\r\nimport { Card } from '../../ui/primitives/Card';\r\n\r\ninterface RidersViewProps {\r\n    franchiseId?: string;\r\n}\r\n\r\nexport const RidersView: React.FC<RidersViewProps> = ({ franchiseId }) => {\r\n    const { riders, isLoading, fetchRiders, deleteRider } = useFleetStore();\r\n    // ...\r\n\r\n    const [isDrawerOpen, setIsDrawerOpen] = useState(false);\r\n    const [selectedRider, setSelectedRider] = useState<Rider | null>(null);\r\n    const [search, setSearch] = useState('');\r\n\r\n    useEffect(() => {\r\n        fetchRiders(franchiseId);\r\n    }, [fetchRiders, franchiseId]);\r\n\r\n    const handleCreate = () => {\r\n        setSelectedRider(null);\r\n        setIsDrawerOpen(true);\r\n    };\r\n\r\n    const handleEdit = (rider: Rider) => {\r\n        setSelectedRider(rider);\r\n        setIsDrawerOpen(true);\r\n    };\r\n\r\n    const handleDelete = async (id: string) => {\r\n        if (confirm('¬øEst√°s seguro de eliminar este rider?')) {\r\n            await deleteRider(id);\r\n        }\r\n    };\r\n\r\n    const handleCloseDrawer = () => {\r\n        setIsDrawerOpen(false);\r\n        setSelectedRider(null);\r\n    };\r\n\r\n    const filteredRiders = riders.filter(r =>\r\n        r.fullName.toLowerCase().includes(search.toLowerCase()) ||\r\n        r.email.toLowerCase().includes(search.toLowerCase())\r\n    );\r\n\r\n    const columns: Column<Rider>[] = [\r\n        {\r\n            header: 'Rider',\r\n            cell: (rider) => (\r\n                <div>\r\n                    <div className=\"font-medium text-slate-900 dark:text-white\">{rider.fullName}</div>\r\n                    <div className=\"text-xs text-slate-500\">{rider.email}</div>\r\n                </div>\r\n            )\r\n        },\r\n        {\r\n            header: 'Estado',\r\n            cell: (rider) => {\r\n                const statusColors: Record<string, string> = {\r\n                    active: 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400',\r\n                    inactive: 'bg-slate-100 text-slate-700 dark:bg-slate-800 dark:text-slate-400',\r\n                    on_route: 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400',\r\n                    maintenance: 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400',\r\n                    deleted: 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400',\r\n                };\r\n                const labels: Record<string, string> = {\r\n                    active: 'Activo',\r\n                    inactive: 'Inactivo',\r\n                    on_route: 'En Ruta',\r\n                    maintenance: 'Mantenimiento',\r\n                    deleted: 'Eliminado'\r\n                };\r\n                return (\r\n                    <span className={`px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColors[rider.status] || statusColors.inactive}`}>\r\n                        {labels[rider.status] || rider.status}\r\n                    </span>\r\n                );\r\n            }\r\n        },\r\n        {\r\n            header: 'Tel√©fono',\r\n            accessorKey: 'phone',\r\n            className: 'text-slate-500'\r\n        },\r\n        {\r\n            header: 'Eficiencia',\r\n            cell: (rider) => (\r\n                <div className=\"flex items-center gap-2\">\r\n                    <div className=\"w-16 h-1.5 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden\">\r\n                        <div\r\n                            className=\"h-full bg-blue-500 rounded-full\"\r\n                            style={{ width: `${rider.metrics.efficiency}%` }}\r\n                        />\r\n                    </div>\r\n                    <span className=\"text-xs font-medium\">{rider.metrics.efficiency}%</span>\r\n                </div>\r\n            )\r\n        },\r\n        {\r\n            header: 'Franchise ID',\r\n            cell: (rider) => (\r\n                <div className=\"text-xs text-red-600 font-mono\">\r\n                    {rider.franchiseId || 'MISSING'}\r\n                </div>\r\n            )\r\n        },\r\n        {\r\n            header: 'Acciones',\r\n            className: 'text-right',\r\n            cell: (rider) => (\r\n                <div className=\"flex justify-end gap-2\">\r\n                    <button\r\n                        onClick={(e) => { e.stopPropagation(); handleEdit(rider); }}\r\n                        className=\"p-1.5 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg text-slate-400 hover:text-blue-500 transition-colors\"\r\n                    >\r\n                        <Edit2 className=\"w-4 h-4\" />\r\n                    </button>\r\n                    <button\r\n                        onClick={(e) => { e.stopPropagation(); handleDelete(rider.id); }}\r\n                        className=\"p-1.5 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg text-slate-400 hover:text-red-500 transition-colors\"\r\n                    >\r\n                        <Trash2 className=\"w-4 h-4\" />\r\n                    </button>\r\n                </div>\r\n            )\r\n        }\r\n    ];\r\n\r\n    return (\r\n        <div className=\"space-y-6\">\r\n            {/* Header / KPI Area could go here */}\r\n\r\n            <Card className=\"flex flex-col md:flex-row md:items-center justify-between gap-4\">\r\n                <div className=\"relative flex-1 max-w-md\">\r\n                    <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400\" />\r\n                    <input\r\n                        type=\"text\"\r\n                        placeholder=\"Buscar por nombre o email...\"\r\n                        value={search}\r\n                        onChange={(e) => setSearch(e.target.value)}\r\n                        className=\"w-full pl-10 pr-4 py-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-blue-500/20 focus:outline-none transition-all\"\r\n                    />\r\n                </div>\r\n                <Button onClick={handleCreate} icon={<Plus className=\"w-4 h-4\" />}>\r\n                    Nuevo Rider\r\n                </Button>\r\n            </Card>\r\n\r\n            <Table\r\n                data={filteredRiders}\r\n                columns={columns}\r\n                isLoading={isLoading}\r\n                onRowClick={handleEdit}\r\n                emptyMessage={search ? \"No se encontraron riders con esa b√∫squeda\" : \"No hay riders registrados\"}\r\n            />\r\n\r\n            <Drawer\r\n                isOpen={isDrawerOpen}\r\n                onClose={handleCloseDrawer}\r\n                title={selectedRider ? 'Editar Rider' : 'Nuevo Rider'}\r\n                description={selectedRider ? 'Modifica los datos del rider seleccionado' : 'Registra un nuevo miembro en la flota'}\r\n            >\r\n                <RiderForm\r\n                    franchiseId={franchiseId}\r\n                    onSuccess={handleCloseDrawer}\r\n                    onCancel={handleCloseDrawer}\r\n                    initialData={selectedRider ? {\r\n                        ...selectedRider,\r\n                        contractHours: selectedRider.contractHours || 40\r\n                    } as any : undefined}\r\n                />\r\n            </Drawer>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default RidersView;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\fleet\\components\\RiderForm.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":36,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":36,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1277,1280],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1277,1280],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":67,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":67,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2563,2566],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2563,2566],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\r\nimport { useForm } from 'react-hook-form';\r\nimport { zodResolver } from '@hookform/resolvers/zod';\r\nimport { riderSchema, RiderFormValues } from '../schemas/RiderSchema';\r\nimport { Button } from '../../../ui/primitives/Button';\r\nimport { useFleetStore } from '../../../store/useFleetStore';\r\nimport { Eye, EyeOff } from 'lucide-react';\r\n\r\ninterface RiderFormProps {\r\n    onSuccess: () => void;\r\n    onCancel: () => void;\r\n    initialData?: RiderFormValues & { id: string };\r\n    franchiseId?: string;\r\n}\r\n\r\nexport const RiderForm: React.FC<RiderFormProps> = ({ onSuccess, onCancel, initialData, franchiseId }) => {\r\n    const { addRider, updateRider } = useFleetStore();\r\n    const [showPassword, setShowPassword] = useState(false);\r\n    const [submitError, setSubmitError] = useState<string | null>(null);\r\n\r\n    const {\r\n        register,\r\n        handleSubmit,\r\n        formState: { errors, isSubmitting }\r\n    } = useForm<RiderFormValues>({\r\n        resolver: zodResolver(riderSchema),\r\n        defaultValues: initialData || {\r\n            fullName: '',\r\n            email: '',\r\n            phone: '',\r\n            status: 'active',\r\n            contractHours: 40\r\n        }\r\n    });\r\n\r\n    const getFirebaseErrorMessage = (error: any) => {\r\n        const code = error.code || error.message;\r\n        if (code?.includes('auth/email-already-in-use')) {\r\n            return 'Este correo electr√≥nico ya est√° registrado. Intenta con otro o busca al usuario existente.';\r\n        }\r\n        if (code?.includes('auth/weak-password')) {\r\n            return 'La contrase√±a es muy d√©bil. Debe tener al menos 6 caracteres.';\r\n        }\r\n        if (code?.includes('auth/invalid-email')) {\r\n            return 'El formato del correo electr√≥nico no es v√°lido.';\r\n        }\r\n        if (code?.includes('permission-denied')) {\r\n            return 'No tienes permisos para realizar esta acci√≥n.';\r\n        }\r\n        return error.message || \"Error al guardar el Rider. Int√©ntalo de nuevo.\";\r\n    };\r\n\r\n    const onSubmit = async (data: RiderFormValues) => {\r\n        setSubmitError(null);\r\n        try {\r\n            const payload = {\r\n                ...data,\r\n                contractHours: data.contractHours || 40 // Default handled by schema but good for safety\r\n            };\r\n\r\n            if (initialData?.id) {\r\n                await updateRider(initialData.id, payload);\r\n            } else {\r\n                await addRider({ ...payload, franchiseId });\r\n            }\r\n            onSuccess();\r\n        } catch (error: any) {\r\n            console.error('Error saving rider:', error);\r\n            setSubmitError(getFirebaseErrorMessage(error));\r\n        }\r\n    };\r\n\r\n    return (\r\n        <form onSubmit={handleSubmit(onSubmit)} className=\"space-y-6\">\r\n            {/* Full Name */}\r\n            <div className=\"space-y-1.5\">\r\n                <label className=\"text-sm font-medium text-slate-700 dark:text-slate-300\">\r\n                    Nombre Completo\r\n                </label>\r\n                <input\r\n                    {...register('fullName')}\r\n                    className={`\r\n                        w-full px-4 py-2 rounded-lg border bg-white dark:bg-slate-800 \r\n                        focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all\r\n                        ${errors.fullName\r\n                            ? 'border-red-500 focus:border-red-500'\r\n                            : 'border-slate-200 dark:border-slate-700'}\r\n                    `}\r\n                    placeholder=\"Ej: Juan P√©rez\"\r\n                />\r\n                {errors.fullName && (\r\n                    <p className=\"text-xs text-red-500\">{errors.fullName.message}</p>\r\n                )}\r\n            </div>\r\n\r\n            {/* Email */}\r\n            <div className=\"space-y-1.5\">\r\n                <label className=\"text-sm font-medium text-slate-700 dark:text-slate-300\">\r\n                    Email\r\n                </label>\r\n                <input\r\n                    {...register('email')}\r\n                    type=\"email\"\r\n                    className={`\r\n                        w-full px-4 py-2 rounded-lg border bg-white dark:bg-slate-800 \r\n                        focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all\r\n                        ${errors.email\r\n                            ? 'border-red-500 focus:border-red-500'\r\n                            : 'border-slate-200 dark:border-slate-700'}\r\n                    `}\r\n                    placeholder=\"rider@repaart.com\"\r\n                />\r\n                {errors.email && (\r\n                    <p className=\"text-xs text-red-500\">{errors.email.message}</p>\r\n                )}\r\n            </div>\r\n\r\n            {/* Password (Only for new Riders) */}\r\n            {!initialData && (\r\n                <div className=\"space-y-1.5\">\r\n                    <label className=\"text-sm font-medium text-slate-700 dark:text-slate-300\">\r\n                        Contrase√±a Inicial\r\n                    </label>\r\n                    <div className=\"relative\">\r\n                        <input\r\n                            {...register('password')}\r\n                            type={showPassword ? \"text\" : \"password\"}\r\n                            className={`\r\n                                w-full px-4 py-2 pr-10 rounded-lg border bg-white dark:bg-slate-800 \r\n                                focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all\r\n                                ${errors.password\r\n                                    ? 'border-red-500 focus:border-red-500'\r\n                                    : 'border-slate-200 dark:border-slate-700'}\r\n                            `}\r\n                            placeholder=\"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢\"\r\n                        />\r\n                        <button\r\n                            type=\"button\"\r\n                            onClick={() => setShowPassword(!showPassword)}\r\n                            className=\"absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 transition-colors\"\r\n                        >\r\n                            {showPassword ? <EyeOff size={18} /> : <Eye size={18} />}\r\n                        </button>\r\n                    </div>\r\n                    {errors.password && (\r\n                        <p className=\"text-xs text-red-500\">{errors.password.message}</p>\r\n                    )}\r\n                    <p className=\"text-xs text-slate-400\">\r\n                        El Rider usar√° este email y contrase√±a para acceder a su App.\r\n                    </p>\r\n                </div>\r\n            )}\r\n\r\n            {/* Phone */}\r\n            <div className=\"space-y-1.5\">\r\n                <label className=\"text-sm font-medium text-slate-700 dark:text-slate-300\">\r\n                    Tel√©fono\r\n                </label>\r\n                <input\r\n                    {...register('phone')}\r\n                    type=\"tel\"\r\n                    className={`\r\n                        w-full px-4 py-2 rounded-lg border bg-white dark:bg-slate-800 \r\n                        focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all\r\n                        ${errors.phone\r\n                            ? 'border-red-500 focus:border-red-500'\r\n                            : 'border-slate-200 dark:border-slate-700'}\r\n                    `}\r\n                    placeholder=\"+34 600 000 000\"\r\n                />\r\n                {errors.phone && (\r\n                    <p className=\"text-xs text-red-500\">{errors.phone.message}</p>\r\n                )}\r\n            </div>\r\n\r\n            {/* Contract Hours */}\r\n            <div className=\"space-y-1.5\">\r\n                <label className=\"text-sm font-medium text-slate-700 dark:text-slate-300\">\r\n                    Horas de Contrato (Semanal)\r\n                </label>\r\n                <div className=\"relative\">\r\n                    <input\r\n                        {...register('contractHours', { valueAsNumber: true })}\r\n                        type=\"number\"\r\n                        className={`\r\n                            w-full px-4 py-2 rounded-lg border bg-white dark:bg-slate-800 \r\n                            focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all\r\n                            ${errors.contractHours\r\n                                ? 'border-red-500 focus:border-red-500'\r\n                                : 'border-slate-200 dark:border-slate-700'}\r\n                        `}\r\n                        placeholder=\"40\"\r\n                    />\r\n                    <span className=\"absolute right-4 top-2 text-slate-400 text-sm\">h/semana</span>\r\n                </div>\r\n                {errors.contractHours && (\r\n                    <p className=\"text-xs text-red-500\">{errors.contractHours.message}</p>\r\n                )}\r\n            </div>\r\n\r\n            {/* Status */}\r\n            <div className=\"space-y-1.5\">\r\n                <label className=\"text-sm font-medium text-slate-700 dark:text-slate-300\">\r\n                    Estado\r\n                </label>\r\n                <select\r\n                    {...register('status')}\r\n                    className=\"w-full px-4 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800\"\r\n                >\r\n                    <option value=\"active\">Activo</option>\r\n                    <option value=\"inactive\">Inactivo</option>\r\n                    <option value=\"on_route\">En Ruta</option>\r\n                    <option value=\"maintenance\">Mantenimiento</option>\r\n                </select>\r\n                {errors.status && (\r\n                    <p className=\"text-xs text-red-500\">{errors.status.message}</p>\r\n                )}\r\n            </div>\r\n\r\n            {/* Error Message */}\r\n            {submitError && (\r\n                <div className=\"p-3 rounded-lg bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-600 dark:text-red-400 text-sm\">\r\n                    {submitError}\r\n                </div>\r\n            )}\r\n\r\n            {/* Actions */}\r\n            <div className=\"flex justify-end gap-3 pt-4 border-t border-slate-100 dark:border-slate-800\">\r\n                <Button\r\n                    type=\"button\"\r\n                    variant=\"ghost\"\r\n                    onClick={onCancel}\r\n                    disabled={isSubmitting}\r\n                >\r\n                    Cancelar\r\n                </Button>\r\n                <Button\r\n                    type=\"submit\"\r\n                    isLoading={isSubmitting}\r\n                >\r\n                    {initialData ? 'Guardar Cambios' : 'Crear Rider'}\r\n                </Button>\r\n            </div>\r\n        </form>\r\n    );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\fleet\\schemas\\RiderSchema.test.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":67,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":67,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2218,2221],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2218,2221],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { describe, it, expect } from 'vitest';\r\nimport { riderSchema } from './RiderSchema';\r\n\r\ndescribe('RiderSchema Validation', () => {\r\n    it('should validate a correct rider object', () => {\r\n        const validRider = {\r\n            fullName: 'Juan P√©rez',\r\n            email: 'juan@repaart.com',\r\n            phone: '+34 600 123 456',\r\n            status: 'active'\r\n        };\r\n\r\n        const result = riderSchema.safeParse(validRider);\r\n        expect(result.success).toBe(true);\r\n    });\r\n\r\n    it('should fail if name is too short', () => {\r\n        const invalidRider = {\r\n            fullName: 'J',\r\n            email: 'juan@repaart.com',\r\n            phone: '+34 600 123 456',\r\n            status: 'active'\r\n        };\r\n\r\n        const result = riderSchema.safeParse(invalidRider);\r\n        expect(result.success).toBe(false);\r\n        if (!result.success) {\r\n            expect(result.error.issues[0].message).toContain('al menos 2 caracteres');\r\n        }\r\n    });\r\n\r\n    it('should fail if email is invalid', () => {\r\n        const invalidRider = {\r\n            fullName: 'Juan P√©rez',\r\n            email: 'juan-no-email',\r\n            phone: '+34 600 123 456',\r\n            status: 'active'\r\n        };\r\n\r\n        const result = riderSchema.safeParse(invalidRider);\r\n        expect(result.success).toBe(false);\r\n        if (!result.success) {\r\n            expect(result.error.issues[0].message).toBe('Email inv√°lido');\r\n        }\r\n    });\r\n\r\n    it('should fail if phone format is invalid', () => {\r\n        const invalidRider = {\r\n            fullName: 'Juan P√©rez',\r\n            email: 'juan@repaart.com',\r\n            phone: '123', // Too short/invalid format\r\n            status: 'active'\r\n        };\r\n\r\n        const result = riderSchema.safeParse(invalidRider);\r\n        expect(result.success).toBe(false);\r\n        if (!result.success) {\r\n            expect(result.error.issues[0].message).toBe('N√∫mero de tel√©fono inv√°lido');\r\n        }\r\n    });\r\n\r\n    it('should fail if status is not allowed', () => {\r\n        const invalidRider = {\r\n            fullName: 'Juan P√©rez',\r\n            email: 'juan@repaart.com',\r\n            phone: '+34 600 123 456',\r\n            status: 'super-active' as any // Force invalid value bypassing TS\r\n        };\r\n\r\n        const result = riderSchema.safeParse(invalidRider);\r\n        expect(result.success).toBe(false);\r\n        if (!result.success) {\r\n            // Check if error map works, otherwise strictly check received error\r\n            // const msg = result.error.issues[0].message;\r\n            // expect(msg).toBe('Estado inv√°lido');\r\n            expect(result.success).toBe(false);\r\n        }\r\n    });\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\fleet\\schemas\\RiderSchema.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\fleet\\vehicles\\VehiclesView.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\fleet\\vehicles\\components\\VehicleForm.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":41,"column":61,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":41,"endColumn":64,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1726,1729],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1726,1729],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":43,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":43,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1809,1812],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1809,1812],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\nimport { useForm } from 'react-hook-form';\r\nimport { zodResolver } from '@hookform/resolvers/zod';\r\nimport { VehicleFormValues, VehicleFormSchema } from '../schemas/VehicleSchema';\r\nimport { Button } from '../../../../ui/primitives/Button';\r\nimport { useVehicleStore } from '../../../../store/useVehicleStore';\r\n// Use a hardcoded franchiseId for now or get from context context, but usually passed via props or store\r\n// Assuming franchiseId is handled by the parent or store for 'addVehicle' call. \r\n// Wait, store requires franchiseId for 'add'. I should pass it as prop or we grab it from auth store.\r\n// Let's grab global user/franchise ID if possible, or pass as prop.\r\n// For now, I'll assume the parent component knows the franchiseId.\r\n\r\ninterface VehicleFormProps {\r\n    onSuccess: () => void;\r\n    onCancel: () => void;\r\n    initialData?: VehicleFormValues & { id: string };\r\n    franchiseId: string; // Required for creating new\r\n}\r\n\r\nexport const VehicleForm: React.FC<VehicleFormProps> = ({ onSuccess, onCancel, initialData, franchiseId }) => {\r\n    const { addVehicle, updateVehicle } = useVehicleStore();\r\n\r\n    const {\r\n        register,\r\n        handleSubmit,\r\n        formState: { errors, isSubmitting }\r\n    } = useForm<VehicleFormValues>({\r\n        resolver: zodResolver(VehicleFormSchema),\r\n        defaultValues: initialData || {\r\n            matricula: '',\r\n            modelo: '',\r\n            km_actuales: 0,\r\n            proxima_revision_km: 5000,\r\n            estado: 'active'\r\n        }\r\n    });\r\n\r\n    const onSubmit = async (data: VehicleFormValues) => {\r\n        try {\r\n            if (initialData?.id) {\r\n                await updateVehicle(initialData.id, data as any);\r\n            } else {\r\n                await addVehicle(franchiseId, data as any);\r\n            }\r\n            onSuccess();\r\n        } catch (error) {\r\n            console.error('Error saving vehicle:', error);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <form onSubmit={handleSubmit(onSubmit)} className=\"space-y-6\">\r\n            {/* Matr√≠cula */}\r\n            <div className=\"space-y-1.5\">\r\n                <label className=\"text-sm font-medium text-slate-700 dark:text-slate-300\">\r\n                    Matr√≠cula\r\n                </label>\r\n                <input\r\n                    {...register('matricula')}\r\n                    className={`\r\n                        w-full px-4 py-2 rounded-lg border bg-white dark:bg-slate-800 \r\n                        focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all\r\n                        ${errors.matricula\r\n                            ? 'border-red-500 focus:border-red-500'\r\n                            : 'border-slate-200 dark:border-slate-700'}\r\n                    `}\r\n                    placeholder=\"1234-ABC\"\r\n                />\r\n                {errors.matricula && (\r\n                    <p className=\"text-xs text-red-500\">{errors.matricula.message}</p>\r\n                )}\r\n            </div>\r\n\r\n            {/* Modelo */}\r\n            <div className=\"space-y-1.5\">\r\n                <label className=\"text-sm font-medium text-slate-700 dark:text-slate-300\">\r\n                    Modelo\r\n                </label>\r\n                <input\r\n                    {...register('modelo')}\r\n                    className={`\r\n                        w-full px-4 py-2 rounded-lg border bg-white dark:bg-slate-800 \r\n                        focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all\r\n                        ${errors.modelo\r\n                            ? 'border-red-500 focus:border-red-500'\r\n                            : 'border-slate-200 dark:border-slate-700'}\r\n                    `}\r\n                    placeholder=\"Honda PCX 125\"\r\n                />\r\n                {errors.modelo && (\r\n                    <p className=\"text-xs text-red-500\">{errors.modelo.message}</p>\r\n                )}\r\n            </div>\r\n\r\n            {/* Grid for KM & Revision */}\r\n            <div className=\"grid grid-cols-2 gap-4\">\r\n                {/* KM Actuales */}\r\n                <div className=\"space-y-1.5\">\r\n                    <label className=\"text-sm font-medium text-slate-700 dark:text-slate-300\">\r\n                        KM Actuales\r\n                    </label>\r\n                    <input\r\n                        type=\"number\"\r\n                        {...register('km_actuales', { valueAsNumber: true })}\r\n                        className={`\r\n                            w-full px-4 py-2 rounded-lg border bg-white dark:bg-slate-800 \r\n                            focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all\r\n                            ${errors.km_actuales\r\n                                ? 'border-red-500 focus:border-red-500'\r\n                                : 'border-slate-200 dark:border-slate-700'}\r\n                        `}\r\n                        placeholder=\"0\"\r\n                    />\r\n                    {errors.km_actuales && (\r\n                        <p className=\"text-xs text-red-500\">{errors.km_actuales.message}</p>\r\n                    )}\r\n                </div>\r\n\r\n                {/* Pr√≥xima Revisi√≥n */}\r\n                <div className=\"space-y-1.5\">\r\n                    <label className=\"text-sm font-medium text-slate-700 dark:text-slate-300\">\r\n                        Pr√≥x. Revisi√≥n (KM)\r\n                    </label>\r\n                    <input\r\n                        type=\"number\"\r\n                        {...register('proxima_revision_km', { valueAsNumber: true })}\r\n                        className={`\r\n                            w-full px-4 py-2 rounded-lg border bg-white dark:bg-slate-800 \r\n                            focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all\r\n                            ${errors.proxima_revision_km\r\n                                ? 'border-red-500 focus:border-red-500'\r\n                                : 'border-slate-200 dark:border-slate-700'}\r\n                        `}\r\n                        placeholder=\"5000\"\r\n                    />\r\n                    {errors.proxima_revision_km && (\r\n                        <p className=\"text-xs text-red-500\">{errors.proxima_revision_km.message}</p>\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            {/* Estado */}\r\n            <div className=\"space-y-1.5\">\r\n                <label className=\"text-sm font-medium text-slate-700 dark:text-slate-300\">\r\n                    Estado\r\n                </label>\r\n                <select\r\n                    {...register('estado')}\r\n                    className=\"w-full px-4 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 focus:ring-2 focus:ring-blue-500/20 focus:outline-none\"\r\n                >\r\n                    <option value=\"active\">Activo</option>\r\n                    <option value=\"maintenance\">Mantenimiento</option>\r\n                    <option value=\"out_of_service\">Fuera de Servicio</option>\r\n                    <option value=\"deleted\">Baja</option>\r\n                </select>\r\n                {errors.estado && (\r\n                    <p className=\"text-xs text-red-500\">{errors.estado.message}</p>\r\n                )}\r\n            </div>\r\n\r\n            {/* Actions */}\r\n            <div className=\"flex justify-end gap-3 pt-4 border-t border-slate-100 dark:border-slate-800\">\r\n                <Button\r\n                    type=\"button\"\r\n                    variant=\"ghost\"\r\n                    onClick={onCancel}\r\n                    disabled={isSubmitting}\r\n                >\r\n                    Cancelar\r\n                </Button>\r\n                <Button\r\n                    type=\"submit\"\r\n                    isLoading={isSubmitting}\r\n                >\r\n                    {initialData ? 'Guardar Cambios' : 'Registrar Veh√≠culo'}\r\n                </Button>\r\n            </div>\r\n        </form>\r\n    );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\fleet\\vehicles\\schemas\\VehicleSchema.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\FinancialControlCenter.tsx","messages":[{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":44,"column":13,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":44,"endColumn":69,"suggestions":[{"messageId":"addBrackets","fix":{"range":[1648,3302],"text":"{ const laborCost = expenses.payroll + expenses.insurance;\r\n            const laborRatio = income > 0 ? (laborCost / income) * 100 : 0;\r\n            const costPerOrder = orders > 0 ? laborCost / orders : 0;\r\n\r\n            if (costPerOrder > 3.5 || laborRatio > 45) return {\r\n                title: 'Alerta: Coste Laboral Cr√≠tico',\r\n                content: `Tu coste por pedido es ${formatMoney(costPerOrder)}‚Ç¨ (Meta: <2.50‚Ç¨). ¬øEst√°s sobredimensionando la flota en horas valle ? Revisa el tiempo de espera en recogida.`,\r\n                status: 'danger',\r\n                metric: `${laborRatio.toFixed(1)}% vs 35 % `,\r\n                icon: <Flame className=\"w-6 h-6 text-red-500\" />\r\n            };\r\n            if (costPerOrder > 2.8) return {\r\n                title: 'Eficiencia Laboral Mejorable',\r\n                content: `Tu coste es de ${formatMoney(costPerOrder)}‚Ç¨/pedido. Est√°s ligeramente por encima del KPI √≥ptimo (2.50‚Ç¨). \\n\\nCausa probable: Tiempos de espera en restaurante largos (>10 min) que \"queman\" horas de rider productivas.`,\r\n                status: 'warning',\r\n                metric: `${formatMoney(costPerOrder)}‚Ç¨ / pedido`,\r\n                icon: <AlertTriangle className=\"w-6 h-6 text-amber-500\" />\r\n            };\r\n            return {\r\n                title: 'Excelente Gesti√≥n de Flota',\r\n                content: 'Mantienes un coste laboral √≥ptimo (<2.50‚Ç¨/drop). Esto indica una gran coordinaci√≥n entre cocina y reparto, minimizando los tiempos muertos.',\r\n                status: 'safe',\r\n                metric: 'Top 10% Sector',\r\n                icon: <CheckCircle className=\"w-6 h-6 text-emerald-500\" />\r\n            }; }"},"desc":"Add {} brackets around the case block."}]},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":45,"column":13,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":45,"endColumn":76,"suggestions":[{"messageId":"addBrackets","fix":{"range":[1648,3302],"text":"{ const laborCost = expenses.payroll + expenses.insurance;\r\n            const laborRatio = income > 0 ? (laborCost / income) * 100 : 0;\r\n            const costPerOrder = orders > 0 ? laborCost / orders : 0;\r\n\r\n            if (costPerOrder > 3.5 || laborRatio > 45) return {\r\n                title: 'Alerta: Coste Laboral Cr√≠tico',\r\n                content: `Tu coste por pedido es ${formatMoney(costPerOrder)}‚Ç¨ (Meta: <2.50‚Ç¨). ¬øEst√°s sobredimensionando la flota en horas valle ? Revisa el tiempo de espera en recogida.`,\r\n                status: 'danger',\r\n                metric: `${laborRatio.toFixed(1)}% vs 35 % `,\r\n                icon: <Flame className=\"w-6 h-6 text-red-500\" />\r\n            };\r\n            if (costPerOrder > 2.8) return {\r\n                title: 'Eficiencia Laboral Mejorable',\r\n                content: `Tu coste es de ${formatMoney(costPerOrder)}‚Ç¨/pedido. Est√°s ligeramente por encima del KPI √≥ptimo (2.50‚Ç¨). \\n\\nCausa probable: Tiempos de espera en restaurante largos (>10 min) que \"queman\" horas de rider productivas.`,\r\n                status: 'warning',\r\n                metric: `${formatMoney(costPerOrder)}‚Ç¨ / pedido`,\r\n                icon: <AlertTriangle className=\"w-6 h-6 text-amber-500\" />\r\n            };\r\n            return {\r\n                title: 'Excelente Gesti√≥n de Flota',\r\n                content: 'Mantienes un coste laboral √≥ptimo (<2.50‚Ç¨/drop). Esto indica una gran coordinaci√≥n entre cocina y reparto, minimizando los tiempos muertos.',\r\n                status: 'safe',\r\n                metric: 'Top 10% Sector',\r\n                icon: <CheckCircle className=\"w-6 h-6 text-emerald-500\" />\r\n            }; }"},"desc":"Add {} brackets around the case block."}]},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":46,"column":13,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":46,"endColumn":70,"suggestions":[{"messageId":"addBrackets","fix":{"range":[1648,3302],"text":"{ const laborCost = expenses.payroll + expenses.insurance;\r\n            const laborRatio = income > 0 ? (laborCost / income) * 100 : 0;\r\n            const costPerOrder = orders > 0 ? laborCost / orders : 0;\r\n\r\n            if (costPerOrder > 3.5 || laborRatio > 45) return {\r\n                title: 'Alerta: Coste Laboral Cr√≠tico',\r\n                content: `Tu coste por pedido es ${formatMoney(costPerOrder)}‚Ç¨ (Meta: <2.50‚Ç¨). ¬øEst√°s sobredimensionando la flota en horas valle ? Revisa el tiempo de espera en recogida.`,\r\n                status: 'danger',\r\n                metric: `${laborRatio.toFixed(1)}% vs 35 % `,\r\n                icon: <Flame className=\"w-6 h-6 text-red-500\" />\r\n            };\r\n            if (costPerOrder > 2.8) return {\r\n                title: 'Eficiencia Laboral Mejorable',\r\n                content: `Tu coste es de ${formatMoney(costPerOrder)}‚Ç¨/pedido. Est√°s ligeramente por encima del KPI √≥ptimo (2.50‚Ç¨). \\n\\nCausa probable: Tiempos de espera en restaurante largos (>10 min) que \"queman\" horas de rider productivas.`,\r\n                status: 'warning',\r\n                metric: `${formatMoney(costPerOrder)}‚Ç¨ / pedido`,\r\n                icon: <AlertTriangle className=\"w-6 h-6 text-amber-500\" />\r\n            };\r\n            return {\r\n                title: 'Excelente Gesti√≥n de Flota',\r\n                content: 'Mantienes un coste laboral √≥ptimo (<2.50‚Ç¨/drop). Esto indica una gran coordinaci√≥n entre cocina y reparto, minimizando los tiempos muertos.',\r\n                status: 'safe',\r\n                metric: 'Top 10% Sector',\r\n                icon: <CheckCircle className=\"w-6 h-6 text-emerald-500\" />\r\n            }; }"},"desc":"Add {} brackets around the case block."}]},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":71,"column":13,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":71,"endColumn":81,"suggestions":[{"messageId":"addBrackets","fix":{"range":[3340,4342],"text":"{ const fuelPerKm = estimatedKm > 0 ? expenses.fuel / estimatedKm : 0;\r\n            if (fuelPerKm > 0.06) return {\r\n                title: 'Desperdicio de Combustible',\r\n                content: `Tu consumo es de ${formatMoney(fuelPerKm)}‚Ç¨/km, un 50% superior a la media de flota eficiente (0.04‚Ç¨/km). \\n\\nChecklist: 1) Presi√≥n neum√°ticos, 2) Riders acelerando bruscamente, 3) Motos encendidas en espera.`,\r\n                status: 'danger',\r\n                metric: `${formatMoney(fuelPerKm)}‚Ç¨ / km`,\r\n                icon: <Flame className=\"w-6 h-6 text-red-500\" />\r\n            };\r\n            return {\r\n                title: 'Gasto en Combustible',\r\n                content: 'Est√°s en el rango √≥ptimo (~0.04‚Ç¨/km). Recuerda que una flota bien mantenida no solo ahorra gasolina, tambi√©n reduce un 15% el gasto en reparaciones a largo plazo.',\r\n                status: 'safe',\r\n                metric: 'Eficiente',\r\n                icon: <Lightbulb className=\"w-6 h-6 text-amber-500\" />\r\n            }; }"},"desc":"Add {} brackets around the case block."}]},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":88,"column":13,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":88,"endColumn":72,"suggestions":[{"messageId":"addBrackets","fix":{"range":[4382,5463],"text":"{ const density = estimatedKm > 0 ? orders / estimatedKm : 0;\r\n            const kmPerDrop = density > 0 ? 1 / density : 0;\r\n\r\n            if (density < 0.25) return {\r\n                title: 'Alerta: Rutas Ineficientes',\r\n                content: `Tus riders recorren ${kmPerDrop.toFixed(1)} km para entregar UN solo pedido. Es insostenible (Meta: <2.5 km/drop). \\n\\nAcci√≥n: Acota tu radio de entrega en la App o lanza promociones en c√≥digos postales cercanos (0-3km).`,\r\n                status: 'warning',\r\n                metric: `${density.toFixed(2)} ped/km`,\r\n                icon: <Truck className=\"w-6 h-6 text-amber-500\" />\r\n            };\r\n            return {\r\n                title: 'Alta Densidad de Entrega',\r\n                content: `¬°Genial! Est√°s entregando casi 1 pedido cada 2 km. Esta \"densidad\" es lo que diferencia a una franquicia rentable de una que pierde dinero en gasolina y moto.`,\r\n                status: 'safe',\r\n                metric: `${density.toFixed(2)} ped/km`,\r\n                icon: <Truck className=\"w-6 h-6 text-blue-500\" />\r\n            }; }"},"desc":"Add {} brackets around the case block."}]},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":89,"column":13,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":89,"endColumn":61,"suggestions":[{"messageId":"addBrackets","fix":{"range":[4382,5463],"text":"{ const density = estimatedKm > 0 ? orders / estimatedKm : 0;\r\n            const kmPerDrop = density > 0 ? 1 / density : 0;\r\n\r\n            if (density < 0.25) return {\r\n                title: 'Alerta: Rutas Ineficientes',\r\n                content: `Tus riders recorren ${kmPerDrop.toFixed(1)} km para entregar UN solo pedido. Es insostenible (Meta: <2.5 km/drop). \\n\\nAcci√≥n: Acota tu radio de entrega en la App o lanza promociones en c√≥digos postales cercanos (0-3km).`,\r\n                status: 'warning',\r\n                metric: `${density.toFixed(2)} ped/km`,\r\n                icon: <Truck className=\"w-6 h-6 text-amber-500\" />\r\n            };\r\n            return {\r\n                title: 'Alta Densidad de Entrega',\r\n                content: `¬°Genial! Est√°s entregando casi 1 pedido cada 2 km. Esta \"densidad\" es lo que diferencia a una franquicia rentable de una que pierde dinero en gasolina y moto.`,\r\n                status: 'safe',\r\n                metric: `${density.toFixed(2)} ped/km`,\r\n                icon: <Truck className=\"w-6 h-6 text-blue-500\" />\r\n            }; }"},"desc":"Add {} brackets around the case block."}]},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":107,"column":13,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":107,"endColumn":76,"suggestions":[{"messageId":"addBrackets","fix":{"range":[5506,6532],"text":"{ const cancelRate = orders > 0 ? (cancelled / orders) * 100 : 0;\r\n            if (cancelRate > 3) return {\r\n                title: 'Hemorragia de Ingresos',\r\n                content: `Tienes un ${cancelRate.toFixed(1)}% de fallos. El est√°ndar es <1%. \\n\\nImpacto Real: Si un pedido medio son 20‚Ç¨, est√°s perdiendo ${formatMoney(cancelled * 20)}‚Ç¨ directos, m√°s el coste de imagen. Revisa el packaging o los tiempos de cocina.`,\r\n                status: 'danger',\r\n                metric: `P√©rdida: ~${cancelled * 20}‚Ç¨`,\r\n                icon: <AlertTriangle className=\"w-6 h-6 text-red-500\" />\r\n            };\r\n            return {\r\n                title: 'Calidad del Servicio',\r\n                content: 'Tasa de cancelaci√≥n saludable (<1%). Mantener esto bajo es crucial porque recuperarse de una mala review cuesta 12 experiencias positivas nuevas.',\r\n                status: 'safe',\r\n                metric: `${cancelRate.toFixed(1)}%`,\r\n                icon: <Sparkles className=\"w-6 h-6 text-purple-500\" />\r\n            }; }"},"desc":"Add {} brackets around the case block."}]},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":124,"column":13,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":124,"endColumn":69,"suggestions":[{"messageId":"addBrackets","fix":{"range":[6573,7563],"text":"{ const costPerUnit = expenses.renting?.pricePerUnit || 0;\r\n            if (costPerUnit > 170) return {\r\n                title: 'Precio de Flota Fuera de Mercado',\r\n                content: `Pagas ${Math.round(costPerUnit)}‚Ç¨/moto. El precio de grupo negociado ronda los 154‚Ç¨. \\n\\nSi tienes flota propia antigua, considera el renting: incluye seguro y mantenimiento (que te ahorrar√≠a los gastos de la partida \"Reparaciones\").`,\r\n                status: 'warning',\r\n                metric: `${costPerUnit}‚Ç¨ / ud`,\r\n                icon: <Truck className=\"w-6 h-6 text-orange-500\" />\r\n            };\r\n            return {\r\n                title: 'Coste de Flota Controlado',\r\n                content: 'Tu coste unitario es correcto. Aseg√∫rate de rotar las motos entre riders para que todas tengan un desgaste similar y evitar penalizaciones por exceso de Km en una sola unidad.',\r\n                status: 'safe',\r\n                icon: <Truck className=\"w-6 h-6 text-blue-500\" />\r\n            }; }"},"desc":"Add {} brackets around the case block."}]},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":140,"column":13,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":140,"endColumn":90,"suggestions":[{"messageId":"addBrackets","fix":{"range":[7604,8584],"text":"{ const repairCostPerKm = estimatedKm > 0 ? expenses.repairs / estimatedKm : 0;\r\n            if (repairCostPerKm > 0.03 && expenses.renting.count > 0) return {\r\n                title: 'Reparaciones Sospechosas',\r\n                content: 'Si tienes motos de renting, el mantenimiento deber√≠a estar incluido. ¬øPor qu√© est√°s gastando en taller? Revisa si son da√±os por accidentes no cubiertos (franquicias).',\r\n                status: 'warning',\r\n                metric: `${formatMoney(expenses.repairs)}‚Ç¨`,\r\n                icon: <AlertTriangle className=\"w-6 h-6 text-orange-500\" />\r\n            };\r\n            return {\r\n                title: 'Mantenimiento de Flota',\r\n                content: 'El mantenimiento preventivo (aceite, frenos) evita el correctivo (motor gripado), que es 3 veces m√°s caro. Lleva un registro de \"√öltima Revisi√≥n\" por matr√≠cula.',\r\n                status: 'safe',\r\n                icon: <Lightbulb className=\"w-6 h-6 text-orange-500\" />\r\n            }; }"},"desc":"Add {} brackets around the case block."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":286,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":286,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14712,14715],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14712,14715],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":326,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":326,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16337,16340],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16337,16340],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":359,"column":106,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":359,"endColumn":109,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[17723,17726],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[17723,17726],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'user?.role' and 'user.uid'. Either include them or remove the dependency array.","line":383,"column":8,"nodeType":"ArrayExpression","endLine":383,"endColumn":41,"suggestions":[{"desc":"Update the dependencies array to be: [franchiseId, month, initialData, user?.role, user.uid]","fix":{"range":[18605,18638],"text":"[franchiseId, month, initialData, user?.role, user.uid]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":385,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":385,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18678,18681],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18678,18681],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":421,"column":62,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":421,"endColumn":65,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[20215,20218],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[20215,20218],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":422,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":422,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[20264,20267],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[20264,20267],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":526,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":526,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[26155,26158],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[26155,26158],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":584,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":584,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[28730,28733],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[28730,28733],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":618,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":618,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[29884,29887],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[29884,29887],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":1124,"column":73,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[66738,66739],"text":"&quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[66738,66739],"text":"&ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[66738,66739],"text":"&#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[66738,66739],"text":"&rdquo;"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":1124,"column":95,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[66760,66761],"text":"&quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[66760,66761],"text":"&ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[66760,66761],"text":"&#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[66760,66761],"text":"&rdquo;"},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":11,"fatalErrorCount":0,"warningCount":10,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { Truck, Users, DollarSign, CreditCard, Info, Lock, Save, Copy, Settings, X, Flame, AlertTriangle, CheckCircle, Lightbulb, Sparkles, TrendingDown, Target } from 'lucide-react';\r\nimport { useAuth } from '../../context/AuthContext';\r\nimport { financeService } from '../../services/financeService';\r\nimport { userService } from '../../services/userService';\r\nimport { notificationService } from '../../services/notificationService';\r\nimport { OrderCounts, ExpenseData, SimpleFinanceData } from './finance/types';\r\nimport { formatMoney } from '../../lib/finance';\r\n\r\n// --- TYPES ---\r\ntype AdvisoryStatus = 'safe' | 'warning' | 'danger' | 'neutral';\r\n\r\ninterface AdvisoryTip {\r\n    title: string;\r\n    content: string;\r\n    status: AdvisoryStatus;\r\n    metric?: string;\r\n    icon: React.ReactNode;\r\n}\r\n\r\n// --- HELPER: KM ESTIMATION ---\r\nconst estimateTotalKm = (orders: OrderCounts): number => {\r\n    const km0_4 = (orders['0-4 km'] || 0) * 3;\r\n    const km4_5 = (orders['4-5 km'] || 0) * 5;\r\n    const km5_6 = (orders['5-6 km'] || 0) * 6;\r\n    const km6_7 = (orders['6-7 km'] || 0) * 7;\r\n    const kmGt7 = (orders['>7 km'] || 0) * 9;\r\n    return km0_4 + km4_5 + km5_6 + km6_7 + kmGt7;\r\n};\r\n\r\n// --- DATA: DYNAMIC ADVISOR ENGINE ---\r\nconst getAdvisoryData = (\r\n    field: string,\r\n    values: {\r\n        income: number, expenses: ExpenseData, orders: number,\r\n        totalHours: number, estimatedKm: number, cancelled: number\r\n    }\r\n): AdvisoryTip => {\r\n\r\n    const { income, expenses, orders, estimatedKm, cancelled } = values;\r\n\r\n    switch (field) {\r\n        case 'labor':\r\n            const laborCost = expenses.payroll + expenses.insurance;\r\n            const laborRatio = income > 0 ? (laborCost / income) * 100 : 0;\r\n            const costPerOrder = orders > 0 ? laborCost / orders : 0;\r\n\r\n            if (costPerOrder > 3.5 || laborRatio > 45) return {\r\n                title: 'Alerta: Coste Laboral Cr√≠tico',\r\n                content: `Tu coste por pedido es ${formatMoney(costPerOrder)}‚Ç¨ (Meta: <2.50‚Ç¨). ¬øEst√°s sobredimensionando la flota en horas valle ? Revisa el tiempo de espera en recogida.`,\r\n                status: 'danger',\r\n                metric: `${laborRatio.toFixed(1)}% vs 35 % `,\r\n                icon: <Flame className=\"w-6 h-6 text-red-500\" />\r\n            };\r\n            if (costPerOrder > 2.8) return {\r\n                title: 'Eficiencia Laboral Mejorable',\r\n                content: `Tu coste es de ${formatMoney(costPerOrder)}‚Ç¨/pedido. Est√°s ligeramente por encima del KPI √≥ptimo (2.50‚Ç¨). \\n\\nCausa probable: Tiempos de espera en restaurante largos (>10 min) que \"queman\" horas de rider productivas.`,\r\n                status: 'warning',\r\n                metric: `${formatMoney(costPerOrder)}‚Ç¨ / pedido`,\r\n                icon: <AlertTriangle className=\"w-6 h-6 text-amber-500\" />\r\n            };\r\n            return {\r\n                title: 'Excelente Gesti√≥n de Flota',\r\n                content: 'Mantienes un coste laboral √≥ptimo (<2.50‚Ç¨/drop). Esto indica una gran coordinaci√≥n entre cocina y reparto, minimizando los tiempos muertos.',\r\n                status: 'safe',\r\n                metric: 'Top 10% Sector',\r\n                icon: <CheckCircle className=\"w-6 h-6 text-emerald-500\" />\r\n            };\r\n\r\n        case 'fuel':\r\n            const fuelPerKm = estimatedKm > 0 ? expenses.fuel / estimatedKm : 0;\r\n            if (fuelPerKm > 0.06) return {\r\n                title: 'Desperdicio de Combustible',\r\n                content: `Tu consumo es de ${formatMoney(fuelPerKm)}‚Ç¨/km, un 50% superior a la media de flota eficiente (0.04‚Ç¨/km). \\n\\nChecklist: 1) Presi√≥n neum√°ticos, 2) Riders acelerando bruscamente, 3) Motos encendidas en espera.`,\r\n                status: 'danger',\r\n                metric: `${formatMoney(fuelPerKm)}‚Ç¨ / km`,\r\n                icon: <Flame className=\"w-6 h-6 text-red-500\" />\r\n            };\r\n            return {\r\n                title: 'Gasto en Combustible',\r\n                content: 'Est√°s en el rango √≥ptimo (~0.04‚Ç¨/km). Recuerda que una flota bien mantenida no solo ahorra gasolina, tambi√©n reduce un 15% el gasto en reparaciones a largo plazo.',\r\n                status: 'safe',\r\n                metric: 'Eficiente',\r\n                icon: <Lightbulb className=\"w-6 h-6 text-amber-500\" />\r\n            };\r\n\r\n        case 'orders':\r\n            const density = estimatedKm > 0 ? orders / estimatedKm : 0;\r\n            const kmPerDrop = density > 0 ? 1 / density : 0;\r\n\r\n            if (density < 0.25) return {\r\n                title: 'Alerta: Rutas Ineficientes',\r\n                content: `Tus riders recorren ${kmPerDrop.toFixed(1)} km para entregar UN solo pedido. Es insostenible (Meta: <2.5 km/drop). \\n\\nAcci√≥n: Acota tu radio de entrega en la App o lanza promociones en c√≥digos postales cercanos (0-3km).`,\r\n                status: 'warning',\r\n                metric: `${density.toFixed(2)} ped/km`,\r\n                icon: <Truck className=\"w-6 h-6 text-amber-500\" />\r\n            };\r\n            return {\r\n                title: 'Alta Densidad de Entrega',\r\n                content: `¬°Genial! Est√°s entregando casi 1 pedido cada 2 km. Esta \"densidad\" es lo que diferencia a una franquicia rentable de una que pierde dinero en gasolina y moto.`,\r\n                status: 'safe',\r\n                metric: `${density.toFixed(2)} ped/km`,\r\n                icon: <Truck className=\"w-6 h-6 text-blue-500\" />\r\n            };\r\n\r\n        case 'cancelled':\r\n            const cancelRate = orders > 0 ? (cancelled / orders) * 100 : 0;\r\n            if (cancelRate > 3) return {\r\n                title: 'Hemorragia de Ingresos',\r\n                content: `Tienes un ${cancelRate.toFixed(1)}% de fallos. El est√°ndar es <1%. \\n\\nImpacto Real: Si un pedido medio son 20‚Ç¨, est√°s perdiendo ${formatMoney(cancelled * 20)}‚Ç¨ directos, m√°s el coste de imagen. Revisa el packaging o los tiempos de cocina.`,\r\n                status: 'danger',\r\n                metric: `P√©rdida: ~${cancelled * 20}‚Ç¨`,\r\n                icon: <AlertTriangle className=\"w-6 h-6 text-red-500\" />\r\n            };\r\n            return {\r\n                title: 'Calidad del Servicio',\r\n                content: 'Tasa de cancelaci√≥n saludable (<1%). Mantener esto bajo es crucial porque recuperarse de una mala review cuesta 12 experiencias positivas nuevas.',\r\n                status: 'safe',\r\n                metric: `${cancelRate.toFixed(1)}%`,\r\n                icon: <Sparkles className=\"w-6 h-6 text-purple-500\" />\r\n            };\r\n\r\n        case 'renting':\r\n            const costPerUnit = expenses.renting?.pricePerUnit || 0;\r\n            if (costPerUnit > 170) return {\r\n                title: 'Precio de Flota Fuera de Mercado',\r\n                content: `Pagas ${Math.round(costPerUnit)}‚Ç¨/moto. El precio de grupo negociado ronda los 154‚Ç¨. \\n\\nSi tienes flota propia antigua, considera el renting: incluye seguro y mantenimiento (que te ahorrar√≠a los gastos de la partida \"Reparaciones\").`,\r\n                status: 'warning',\r\n                metric: `${costPerUnit}‚Ç¨ / ud`,\r\n                icon: <Truck className=\"w-6 h-6 text-orange-500\" />\r\n            };\r\n            return {\r\n                title: 'Coste de Flota Controlado',\r\n                content: 'Tu coste unitario es correcto. Aseg√∫rate de rotar las motos entre riders para que todas tengan un desgaste similar y evitar penalizaciones por exceso de Km en una sola unidad.',\r\n                status: 'safe',\r\n                icon: <Truck className=\"w-6 h-6 text-blue-500\" />\r\n            };\r\n\r\n        case 'repairs':\r\n            const repairCostPerKm = estimatedKm > 0 ? expenses.repairs / estimatedKm : 0;\r\n            if (repairCostPerKm > 0.03 && expenses.renting.count > 0) return {\r\n                title: 'Reparaciones Sospechosas',\r\n                content: 'Si tienes motos de renting, el mantenimiento deber√≠a estar incluido. ¬øPor qu√© est√°s gastando en taller? Revisa si son da√±os por accidentes no cubiertos (franquicias).',\r\n                status: 'warning',\r\n                metric: `${formatMoney(expenses.repairs)}‚Ç¨`,\r\n                icon: <AlertTriangle className=\"w-6 h-6 text-orange-500\" />\r\n            };\r\n            return {\r\n                title: 'Mantenimiento de Flota',\r\n                content: 'El mantenimiento preventivo (aceite, frenos) evita el correctivo (motor gripado), que es 3 veces m√°s caro. Lleva un registro de \"√öltima Revisi√≥n\" por matr√≠cula.',\r\n                status: 'safe',\r\n                icon: <Lightbulb className=\"w-6 h-6 text-orange-500\" />\r\n            };\r\n\r\n        default:\r\n            return {\r\n                title: 'Asistente Log√≠stico IA',\r\n                content: 'Selecciona un campo para analizar tu operativa en tiempo real. Cruzar√© tus datos de costes con tus m√©tricas de reparto.',\r\n                status: 'neutral',\r\n                icon: <Sparkles className=\"w-6 h-6 text-indigo-500\" />\r\n            };\r\n    }\r\n};\r\n\r\n// --- NEW COMPONENT: HEALTH CHECK ---\r\nconst ActiveHealthCheck = ({\r\n    tips\r\n}: { tips: AdvisoryTip[] }) => {\r\n\r\n    // Filter only warnings and dangers\r\n    const alerts = tips.filter(t => t.status === 'warning' || t.status === 'danger');\r\n\r\n    if (alerts.length === 0) return (\r\n        <div className=\"bg-emerald-50 border border-emerald-100 rounded-xl p-4 flex items-start gap-3\">\r\n            <div className=\"p-2 bg-emerald-100 rounded-full shrink-0\">\r\n                <CheckCircle className=\"w-5 h-5 text-emerald-600\" />\r\n            </div>\r\n            <div>\r\n                <h4 className=\"font-bold text-emerald-900 text-sm\">Todo en Orden</h4>\r\n                <p className=\"text-emerald-700 text-xs mt-1\">\r\n                    Tus m√©tricas clave (Laboral, Gasolina, Pedidos) est√°n dentro de los rangos √≥ptimos. ¬°Buen trabajo de gesti√≥n!\r\n                </p>\r\n            </div>\r\n        </div>\r\n    );\r\n\r\n    return (\r\n        <div className=\"space-y-3\">\r\n            <h3 className=\"text-xs font-bold uppercase tracking-wider text-gray-500 flex items-center gap-2\">\r\n                <AlertTriangle className=\"w-4 h-4\" /> Alertas Activas ({alerts.length})\r\n            </h3>\r\n            {alerts.map((alert) => (\r\n                <div key={alert.title} className={`p-4 rounded-xl border flex gap-3 ${alert.status === 'danger'\r\n                    ? 'bg-rose-50 border-rose-100'\r\n                    : 'bg-amber-50 border-amber-100'\r\n                    }`}>\r\n                    <div className=\"shrink-0 mt-0.5\">\r\n                        {alert.icon}\r\n                    </div>\r\n                    <div>\r\n                        <div className=\"flex justify-between items-start\">\r\n                            <h4 className={`text-sm font-bold ${alert.status === 'danger' ? 'text-rose-900' : 'text-amber-900'\r\n                                }`}>\r\n                                {alert.title}\r\n                            </h4>\r\n                            {alert.metric && (\r\n                                <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded-full border ${alert.status === 'danger'\r\n                                    ? 'bg-rose-100 text-rose-700 border-rose-200'\r\n                                    : 'bg-amber-100 text-amber-700 border-amber-200'\r\n                                    }`}>\r\n                                    {alert.metric}\r\n                                </span>\r\n                            )}\r\n                        </div>\r\n                        <p className={`text-xs mt-1 leading-relaxed whitespace-pre-line ${alert.status === 'danger' ? 'text-rose-700' : 'text-amber-700'\r\n                            }`}>\r\n                            {alert.content}\r\n                        </p>\r\n                    </div>\r\n                </div>\r\n            ))}\r\n        </div>\r\n    );\r\n};\r\n\r\n// --- NEW COMPONENTS: FINANCIAL WIDGETS ---\r\n\r\nconst BreakEvenWidget = ({\r\n    fixedCosts,\r\n    variableCosts,\r\n    revenue,\r\n    totalOrders\r\n}: { fixedCosts: number, variableCosts: number, revenue: number, totalOrders: number }) => {\r\n\r\n    if (revenue <= 0) return null;\r\n\r\n    const contributionMargin = revenue - variableCosts;\r\n    const cmRatio = contributionMargin / revenue;\r\n\r\n    const breakEvenRevenue = cmRatio > 0 ? fixedCosts / cmRatio : 0;\r\n    const breakEvenOrders = revenue > 0 ? (breakEvenRevenue / (revenue / totalOrders)) : 0;\r\n\r\n    const progress = breakEvenRevenue > 0 ? (revenue / breakEvenRevenue) * 100 : 0;\r\n    const isProfitable = revenue > breakEvenRevenue;\r\n\r\n    return (\r\n        <div className=\"bg-white p-4 rounded-xl border border-gray-200 shadow-sm space-y-3\">\r\n            <div className=\"flex items-center justify-between\">\r\n                <h3 className=\"text-xs font-bold uppercase tracking-wider text-gray-500 flex items-center gap-2\">\r\n                    <Target className=\"w-4 h-4\" /> Punto de Equilibrio\r\n                </h3>\r\n                <span className={`text-xs font-bold px-2 py-1 rounded-full ${isProfitable ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700'}`}>\r\n                    {isProfitable ? 'En Beneficios' : 'En P√©rdidas'}\r\n                </span>\r\n            </div>\r\n\r\n            <div className=\"relative pt-1\">\r\n                <div className=\"flex mb-2 items-center justify-between text-xs\">\r\n                    <span className=\"text-gray-500 font-medium\">\r\n                        Meta: {formatMoney(breakEvenRevenue)}‚Ç¨\r\n                        <span className=\"text-gray-400 mx-1\">({Math.round(breakEvenOrders)} pedidos)</span>\r\n                    </span>\r\n                    <span className=\"text-gray-900 font-bold\">{Math.round(progress)}%</span>\r\n                </div>\r\n                <div className=\"overflow-hidden h-2.5 mb-2 text-xs flex rounded-full bg-gray-100\">\r\n                    <div\r\n                        style={{ width: `${Math.min(progress, 100)}%` }}\r\n                        className={`shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center transition-all duration-500 ${isProfitable ? 'bg-emerald-500' : 'bg-indigo-500'}`}\r\n                    />\r\n                </div>\r\n                <p className=\"text-[10px] text-gray-400\">\r\n                    {isProfitable\r\n                        ? `¬°Genial! Has superado el punto de equilibrio en ${formatMoney(revenue - breakEvenRevenue)}‚Ç¨.`\r\n                        : `Te faltan ${formatMoney(breakEvenRevenue - revenue)}‚Ç¨ para cubrir gastos.`}\r\n                </p>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\ninterface FinancialControlCenterProps {\r\n    franchiseId: string;\r\n    month: string;\r\n    onClose: () => void;\r\n    onSave?: (data: SimpleFinanceData) => void;\r\n    initialData?: any;\r\n}\r\n\r\nconst FinancialControlCenter: React.FC<FinancialControlCenterProps> = ({\r\n    franchiseId,\r\n    month,\r\n    onClose,\r\n    onSave,\r\n    initialData\r\n}) => {\r\n\r\n    const { user } = useAuth();\r\n    const [loading, setLoading] = useState(true);\r\n    const [saving, setSaving] = useState(false);\r\n    const [focusedField, setFocusedField] = useState<string>('default');\r\n    const [status, setStatus] = useState<'pending' | 'draft' | 'submitted' | 'approved' | 'unlock_requested' | 'locked'>('draft');\r\n\r\n    // Unlock Workflow State\r\n    const [showUnlockModal, setShowUnlockModal] = useState(false);\r\n    const [unlockReason, setUnlockReason] = useState('');\r\n    // State to hold rejection reason from Admin, if any\r\n    const [lastRejectionReason, setLastRejectionReason] = useState<string | null>(null);\r\n\r\n\r\n    const isLocked = status === 'submitted' || status === 'approved' || status === 'unlock_requested';\r\n\r\n    // --- STATE ---\r\n    const [orders, setOrders] = useState<OrderCounts>({});\r\n    const [cancelledOrders, setCancelledOrders] = useState(0);\r\n    const [totalIncome, setTotalIncome] = useState(0);\r\n    const [totalHours, setTotalHours] = useState(0);\r\n    const [expenses, setExpenses] = useState<ExpenseData>({\r\n        payroll: 0, quota: 0, insurance: 0,\r\n        fuel: 0, repairs: 0,\r\n        renting: { count: 0, pricePerUnit: 0 },\r\n        agencyFee: 0, prlFee: 0, accountingFee: 0, professionalServices: 0,\r\n        appFlyder: 0, marketing: 0, incidents: 0, other: 0,\r\n        royaltyPercent: 5,\r\n        irpfPercent: 20\r\n    });\r\n    const [logisticsRates, setLogisticsRates] = useState<any[]>([]);\r\n\r\n    // --- AUTO-CALCULATE INCOME ---\r\n    useEffect(() => {\r\n        if (logisticsRates.length > 0) {\r\n            let calculatedIncome = 0;\r\n            // Iterate over active orders to calculate sum\r\n            Object.entries(orders).forEach(([range, count]) => {\r\n                const rate = logisticsRates.find(r =>\r\n                    r.name === range ||\r\n                    `${r.min}-${r.max} km` === range\r\n                );\r\n                if (rate && typeof rate.price === 'number') {\r\n                    calculatedIncome += count * rate.price;\r\n                }\r\n            });\r\n\r\n            // Update totalIncome if calculatedIncome has changed\r\n            // We allow setting to 0 if orders were cleared\r\n            // SAFETY CHECK: Prevent Infinite Loop (NaN !== NaN is true)\r\n            if (!isNaN(calculatedIncome) && calculatedIncome !== totalIncome) {\r\n                if (calculatedIncome > 0 || Object.keys(orders).length > 0) {\r\n                    setTotalIncome(calculatedIncome);\r\n                }\r\n            }\r\n        }\r\n    }, [orders, logisticsRates, totalIncome]);\r\n\r\n    // --- LOAD DATA ---\r\n    useEffect(() => {\r\n        async function loadData() {\r\n            if (!franchiseId || !month) return;\r\n            try {\r\n                const data = initialData || await financeService.getFinancialData(franchiseId, month) as any;\r\n\r\n                // Fetch Profile for Rates (using UID if it's a franchise, else mapping by franchiseId)\r\n                let profile;\r\n                if (user?.role === 'franchise' && user?.uid) {\r\n                    profile = await userService.getUserProfile(user.uid);\r\n                } else {\r\n                    profile = await userService.getUserByFranchiseId(franchiseId);\r\n                }\r\n\r\n                if (profile && profile.logisticsRates) {\r\n                    setLogisticsRates(profile.logisticsRates);\r\n                }\r\n\r\n                if (data && Object.keys(data).length > 0) {\r\n                    mapDataToState(data);\r\n                }\r\n            } catch (err) {\r\n                console.error(\"Error loading data\", err);\r\n            } finally {\r\n                setLoading(false);\r\n            }\r\n        }\r\n        loadData();\r\n    }, [franchiseId, month, initialData]);\r\n\r\n    const mapDataToState = (data: any) => {\r\n        const revenue = data.revenue || data.totalIncome || 0;\r\n        setTotalIncome(revenue);\r\n        setTotalHours(data.totalHours || 0);\r\n        setCancelledOrders(data.cancelledOrders || 0);\r\n        setStatus(data.status || 'draft');\r\n\r\n        // Map Rejection Reason if it exists\r\n        if (data.rejectionReason) {\r\n            setLastRejectionReason(data.rejectionReason);\r\n        }\r\n\r\n        const reconstructedOrders: OrderCounts = {};\r\n\r\n        // 1. Try new dynamic field first\r\n        if (data.ordersDetail) {\r\n            Object.assign(reconstructedOrders, data.ordersDetail);\r\n        } else {\r\n            // 2. Fallback to Legacy Fixed Fields\r\n            if (data.ordersNew0To4) reconstructedOrders['0-4 km'] = data.ordersNew0To4;\r\n            if (data.ordersNew4To5) reconstructedOrders['4-5 km'] = data.ordersNew4To5;\r\n            if (data.ordersNew5To6) reconstructedOrders['5-6 km'] = data.ordersNew5To6;\r\n            if (data.ordersNew6To7) reconstructedOrders['6-7 km'] = data.ordersNew6To7;\r\n            if (data.ordersNewGt7) reconstructedOrders['>7 km'] = data.ordersNewGt7;\r\n        }\r\n\r\n        setOrders(reconstructedOrders);\r\n\r\n        setExpenses({\r\n            payroll: data.salaries || 0,\r\n            quota: data.quota || 0,\r\n            insurance: data.insurance || 0,\r\n            fuel: data.gasoline || 0,\r\n            repairs: data.repairs || 0,\r\n            renting: {\r\n                count: data.motoCount || 0,\r\n                pricePerUnit: data.motoCount > 0 && (data as any).rentingCost\r\n                    ? (data as any).rentingCost / data.motoCount\r\n                    : 154\r\n            },\r\n            agencyFee: data.agencyFee || 0,\r\n            prlFee: data.prlFee || 0,\r\n            accountingFee: data.accountingFee || 0,\r\n            professionalServices: data.services || 0,\r\n            appFlyder: data.appFlyder || 0,\r\n            marketing: data.marketing || 0,\r\n            incidents: data.incidents || 0,\r\n            other: data.otherExpenses || 0,\r\n            royaltyPercent: data.royaltyPercent ?? 5,\r\n            irpfPercent: data.irpfPercent ?? 20\r\n        });\r\n    };\r\n\r\n    // --- CALCULATIONS ---\r\n    const calculateStats = () => {\r\n        const rentingTotal = (expenses.renting?.count ?? 0) * (expenses.renting?.pricePerUnit ?? 0);\r\n        const royaltyAmount = totalIncome * ((expenses.royaltyPercent || 5) / 100);\r\n\r\n        const fixedCosts = expenses.payroll + expenses.quota + expenses.insurance +\r\n            expenses.agencyFee + expenses.prlFee + expenses.accountingFee +\r\n            expenses.professionalServices + expenses.appFlyder + expenses.marketing;\r\n\r\n        const variableCosts = expenses.fuel + expenses.repairs + rentingTotal +\r\n            expenses.incidents + expenses.other + royaltyAmount;\r\n\r\n        const totalExpenses = fixedCosts + variableCosts;\r\n        const profit = totalIncome - totalExpenses;\r\n\r\n        const totalOrders = Object.values(orders).reduce((sum, count) => sum + count, 0);\r\n        const estimatedKm = estimateTotalKm(orders);\r\n\r\n        return { totalExpenses, profit, fixedCosts, variableCosts, royaltyAmount, totalOrders, estimatedKm };\r\n    };\r\n\r\n    const stats = calculateStats();\r\n\r\n    // --- ADVISOR LOGIC ---\r\n    // 1. Get Active Tip based on Focus\r\n    const activeTip = getAdvisoryData(focusedField, {\r\n        income: totalIncome, expenses, orders: stats.totalOrders,\r\n        totalHours, estimatedKm: stats.estimatedKm, cancelled: cancelledOrders\r\n    });\r\n\r\n    // 2. Get All Tips for Health Check\r\n    const allTips = [\r\n        getAdvisoryData('labor', { income: totalIncome, expenses, orders: stats.totalOrders, totalHours, estimatedKm: stats.estimatedKm, cancelled: cancelledOrders }),\r\n        getAdvisoryData('fuel', { income: totalIncome, expenses, orders: stats.totalOrders, totalHours, estimatedKm: stats.estimatedKm, cancelled: cancelledOrders }),\r\n        getAdvisoryData('orders', { income: totalIncome, expenses, orders: stats.totalOrders, totalHours, estimatedKm: stats.estimatedKm, cancelled: cancelledOrders }),\r\n        getAdvisoryData('cancelled', { income: totalIncome, expenses, orders: stats.totalOrders, totalHours, estimatedKm: stats.estimatedKm, cancelled: cancelledOrders }),\r\n        getAdvisoryData('renting', { income: totalIncome, expenses, orders: stats.totalOrders, totalHours, estimatedKm: stats.estimatedKm, cancelled: cancelledOrders }),\r\n    ];\r\n\r\n    const handleSave = async () => {\r\n        if (!onSave) return;\r\n\r\n        // UNLOCK REQUEST LOGIC\r\n        // If the month is locked, the 'Save' button acts as 'Request Unlock'\r\n        if (isLocked) {\r\n            setShowUnlockModal(true);\r\n            return;\r\n        }\r\n\r\n        const confirmMsg = \"Al enviar el cierre, los datos quedar√°n bloqueados para su revisi√≥n por parte de la central. ¬øEst√°s seguro de que deseas continuar?\";\r\n        if (!window.confirm(confirmMsg)) return;\r\n\r\n        setSaving(true);\r\n        try {\r\n            // 1. Calculate Smart Alerts for Notification\r\n            const criticalAlerts = allTips.filter(t => t.status === 'danger');\r\n            const warningAlerts = allTips.filter(t => t.status === 'warning');\r\n            const hasIssues = criticalAlerts.length > 0 || warningAlerts.length > 0;\r\n\r\n            const notificationPriority = criticalAlerts.length > 0 ? 'high' : (warningAlerts.length > 0 ? 'normal' : 'low');\r\n            const issueSummary = criticalAlerts.map(a => a.title).join(', ');\r\n\r\n            const mappedData = {\r\n                month,\r\n                totalIncome, revenue: totalIncome, grossIncome: totalIncome,\r\n                salaries: expenses.payroll, quota: expenses.quota, insurance: expenses.insurance,\r\n                gasoline: expenses.fuel, gasolinePrice: 0, repairs: expenses.repairs,\r\n                motoCount: expenses.renting?.count ?? 0,\r\n                rentingCost: (expenses.renting?.count ?? 0) * (expenses.renting?.pricePerUnit ?? 0),\r\n                agencyFee: expenses.agencyFee, prlFee: expenses.prlFee, accountingFee: expenses.accountingFee, services: expenses.professionalServices,\r\n                appFlyder: expenses.appFlyder, marketing: expenses.marketing, incidents: expenses.incidents, otherExpenses: expenses.other,\r\n                totalExpenses: stats.totalExpenses, expenses: stats.totalExpenses, profit: stats.profit,\r\n                orders: stats.totalOrders,\r\n                ordersDetail: orders, // NEW: Store dynamic map\r\n                cancelledOrders: cancelledOrders,\r\n                // Legacy fields for backward compat (optional, but good for safety)\r\n                ...(orders['0-4 km'] !== undefined && { ordersNew0To4: orders['0-4 km'] }),\r\n                ...(orders['4-5 km'] !== undefined && { ordersNew4To5: orders['4-5 km'] }),\r\n                ...(orders['5-6 km'] !== undefined && { ordersNew5To6: orders['5-6 km'] }),\r\n                ...(orders['6-7 km'] !== undefined && { ordersNew6To7: orders['6-7 km'] }),\r\n                ...(orders['>7 km'] !== undefined && { ordersNewGt7: orders['>7 km'] }),\r\n                status: 'locked' as const, // LOCK upon save (Changed from submitted to locked as per user request for \"Green/Cerrado\")\r\n                is_locked: true,\r\n                royaltyPercent: expenses.royaltyPercent,\r\n                irpfPercent: expenses.irpfPercent,\r\n                updatedAt: new Date().toISOString()\r\n            };\r\n\r\n            await onSave(mappedData as any);\r\n\r\n            // 2. Send Smart Notification\r\n            await notificationService.notify(\r\n                'FINANCE_CLOSING',\r\n                franchiseId,\r\n                'Franquicia', // We should ideally get the name, but ID is critical\r\n                {\r\n                    title: `Cierre Mensual: ${month}`,\r\n                    message: hasIssues\r\n                        ? `Cierre enviado con alertas: ${issueSummary}`\r\n                        : `Cierre mensual de ${month} enviado correctamente.`,\r\n                    priority: notificationPriority,\r\n                    metadata: {\r\n                        month,\r\n                        profit: stats.profit,\r\n                        alerts: criticalAlerts.map(a => a.title),\r\n                        status: 'submitted'\r\n                    }\r\n                }\r\n            );\r\n\r\n            onClose();\r\n        } catch (error) {\r\n            console.error(\"Error saving\", error);\r\n        } finally {\r\n            setSaving(false);\r\n        }\r\n    };\r\n\r\n    /**\r\n     * DRAFT MODE: Save without locking or notifying.\r\n     */\r\n    const handleSaveDraft = async () => {\r\n        if (!onSave || isLocked) return;\r\n\r\n        setSaving(true);\r\n        try {\r\n            const mappedData = {\r\n                month,\r\n                totalIncome, revenue: totalIncome, grossIncome: totalIncome,\r\n                salaries: expenses.payroll, quota: expenses.quota, insurance: expenses.insurance,\r\n                gasoline: expenses.fuel, gasolinePrice: 0, repairs: expenses.repairs,\r\n                motoCount: expenses.renting?.count ?? 0,\r\n                rentingCost: (expenses.renting?.count ?? 0) * (expenses.renting?.pricePerUnit ?? 0),\r\n                agencyFee: expenses.agencyFee, prlFee: expenses.prlFee, accountingFee: expenses.accountingFee, services: expenses.professionalServices,\r\n                appFlyder: expenses.appFlyder, marketing: expenses.marketing, incidents: expenses.incidents, otherExpenses: expenses.other,\r\n                totalExpenses: stats.totalExpenses, expenses: stats.totalExpenses, profit: stats.profit,\r\n                orders: stats.totalOrders,\r\n                ordersDetail: orders,\r\n                cancelledOrders: cancelledOrders,\r\n                status: 'draft' as const, // DRAFT STATUS\r\n                is_locked: false, // NOT LOCKED\r\n                royaltyPercent: expenses.royaltyPercent,\r\n                irpfPercent: expenses.irpfPercent,\r\n                updatedAt: new Date().toISOString()\r\n            };\r\n\r\n            await onSave(mappedData as any);\r\n            // Don't close, just save toast ideally, but for now just finish\r\n            onClose();\r\n        } catch (error) {\r\n            console.error(\"Error saving draft\", error);\r\n        } finally {\r\n            setSaving(false);\r\n        }\r\n    };\r\n\r\n    const submitUnlockRequest = async () => {\r\n        if (!unlockReason.trim()) {\r\n            alert(\"Por favor, indica un motivo para la solicitud.\");\r\n            return;\r\n        }\r\n\r\n        setSaving(true);\r\n        try {\r\n            // Persist request in DB\r\n            await financeService.requestUnlock(franchiseId, month, unlockReason);\r\n\r\n            await notificationService.notify(\r\n                'UNLOCK_REQUEST',\r\n                franchiseId,\r\n                'Franquicia',\r\n                {\r\n                    title: `Solicitud Desbloqueo: ${month}`,\r\n                    message: `Motivo: ${unlockReason}`, // Include reason\r\n                    priority: 'normal',\r\n                    metadata: { month, status: 'locked', reason: unlockReason }\r\n                }\r\n            );\r\n\r\n            // Optimistic update\r\n            setStatus('unlock_requested' as any);\r\n\r\n            alert(\"Solicitud enviada al administrador.\");\r\n            setShowUnlockModal(false);\r\n            onClose();\r\n        } catch (error) {\r\n            console.error(\"Error asking for unlock\", error);\r\n        } finally {\r\n            setSaving(false);\r\n        }\r\n    };\r\n\r\n    const handleCopyPreviousMonth = async () => {\r\n        const date = new Date(month + '-01');\r\n        date.setMonth(date.getMonth() - 1);\r\n        const prevMonthStr = date.toISOString().slice(0, 7);\r\n\r\n        try {\r\n            setLoading(true);\r\n            const prevData = await financeService.getFinancialData(franchiseId, prevMonthStr);\r\n            if (prevData) {\r\n                const currentIncome = totalIncome;\r\n                const currentOrders = orders;\r\n\r\n                mapDataToState(prevData);\r\n\r\n                if (currentIncome > 0) {\r\n                    setTotalIncome(currentIncome);\r\n                    setOrders(currentOrders);\r\n                }\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Failed to copy\", error);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    const updateExpense = (field: keyof ExpenseData, value: number) => {\r\n        setExpenses(prev => ({ ...prev, [field]: value }));\r\n    };\r\n\r\n    // --- UI HELPERS ---\r\n    const getStatusColors = (status: AdvisoryStatus) => {\r\n        switch (status) {\r\n            case 'danger': return 'bg-red-50 border-red-100 shadow-red-100';\r\n            case 'warning': return 'bg-amber-50 border-amber-100 shadow-amber-100';\r\n            case 'safe': return 'bg-emerald-50 border-emerald-100 shadow-emerald-100';\r\n            default: return 'bg-white border-indigo-50 shadow-indigo-100';\r\n        }\r\n    };\r\n\r\n    // --- RENDER ---\r\n    if (loading) return <div className=\"fixed inset-0 bg-white/50 backdrop-blur-sm flex items-center justify-center z-50\"><div className=\"animate-spin text-indigo-600\">Loading...</div></div>;\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 bg-gray-50/95 backdrop-blur-md z-50 overflow-hidden flex flex-col items-center justify-center animate-in fade-in zoom-in-95 duration-200\">\r\n\r\n            <div className=\"w-full h-full max-w-[1920px] bg-white shadow-2xl flex flex-col\">\r\n\r\n                {/* HEADER */}\r\n                <header className=\"h-16 border-b border-gray-200 bg-white px-6 flex items-center justify-between shrink-0 z-10 sticky top-0\">\r\n                    <div className=\"flex items-center gap-4\">\r\n                        <button onClick={onClose} className=\"p-2 hover:bg-gray-100 rounded-full text-gray-400 hover:text-gray-900 transition-colors\">\r\n                            <X className=\"w-5 h-5\" />\r\n                        </button>\r\n                        <div>\r\n                            <h1 className=\"text-xl font-bold text-gray-900 flex items-center gap-3\">\r\n                                <span className={`w-2.5 h-2.5 rounded-full shadow-sm ${isLocked ? 'bg-amber-500' : 'bg-indigo-600'}`} />\r\n                                Cierre Mensual: <span className=\"font-normal text-gray-600 ml-1\">{month}</span>\r\n                                {isLocked && (\r\n                                    <span className=\"flex items-center gap-1 text-[10px] uppercase font-bold text-amber-600 bg-amber-50 px-2 py-0.5 rounded border border-amber-100\">\r\n                                        <Lock className=\"w-3 h-3\" /> Bloqueado\r\n                                    </span>\r\n                                )}\r\n                            </h1>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"flex items-center gap-3\">\r\n                        <button\r\n                            onClick={handleCopyPreviousMonth}\r\n                            className=\"flex items-center gap-2 px-3 py-1.5 rounded-lg bg-white border border-gray-300 hover:bg-gray-50 text-gray-600 hover:text-gray-900 transition-all text-sm font-medium shadow-sm\"\r\n                        >\r\n                            <Copy className=\"w-3.5 h-3.5\" />\r\n                            Copiar mes anterior\r\n                        </button>\r\n\r\n                        {/* SAVE DRAFT BUTTON */}\r\n                        {!isLocked && (\r\n                            <button\r\n                                onClick={handleSaveDraft}\r\n                                disabled={saving}\r\n                                className=\"flex items-center gap-2 px-3 py-1.5 rounded-lg bg-white border border-slate-300 hover:bg-slate-50 text-slate-600 hover:text-slate-900 transition-all text-sm font-medium shadow-sm\"\r\n                            >\r\n                                <Save className=\"w-3.5 h-3.5\" />\r\n                                Guardar Borrador\r\n                            </button>\r\n                        )}\r\n\r\n                        <button\r\n                            onClick={handleSave}\r\n                            disabled={saving || status === 'unlock_requested'}\r\n                            className={`flex items-center gap-2 px-5 py-2 rounded-lg font-semibold shadow-md transition-all hover:translate-y-[-1px] active:translate-y-0 disabled:opacity-50 disabled:cursor-not-allowed text-sm ${status === 'unlock_requested'\r\n                                ? 'bg-slate-100 text-slate-500 border border-slate-200 shadow-none'\r\n                                : isLocked\r\n                                    ? 'bg-amber-100 text-amber-700 hover:bg-amber-200 border border-amber-200 shadow-amber-500/10'\r\n                                    : 'bg-indigo-600 hover:bg-indigo-700 text-white shadow-indigo-500/20'\r\n                                }`}\r\n                        >\r\n                            {saving ? 'Procesando...' : status === 'unlock_requested' ? (\r\n                                <>\r\n                                    <Lock className=\"w-4 h-4 opacity-50\" />\r\n                                    Solicitud Enviada\r\n                                </>\r\n                            ) : (\r\n                                <>\r\n                                    {isLocked ? <Lock className=\"w-4 h-4\" /> : <Save className=\"w-4 h-4\" />}\r\n                                    {isLocked ? 'Solicitar Desbloqueo' : 'Cerrar Mes'}\r\n                                </>\r\n                            )}\r\n                        </button>\r\n                    </div>\r\n                </header>\r\n\r\n                {/* MAIN GRID */}\r\n                <div className={`flex-1 overflow-hidden grid grid-cols-1 lg:grid-cols-12 gap-0 bg-gray-50 ${isLocked ? 'pointer-events-none opacity-80 grayscale-[0.3]' : ''}`}>\r\n\r\n                    {/* COL 1: INCOME & OPS (Scrollable) */}\r\n                    <div className=\"lg:col-span-4 border-r border-gray-200 overflow-y-auto custom-scrollbar bg-white p-8 space-y-8\">\r\n                        <section>\r\n                            <h2 className=\"text-sm uppercase tracking-wide font-bold text-gray-900 mb-6 flex items-center gap-2\">\r\n                                <div className=\"p-1.5 bg-emerald-100/50 rounded-md text-emerald-600\">\r\n                                    <DollarSign className=\"w-4 h-4\" />\r\n                                </div>\r\n                                Ingresos\r\n                            </h2>\r\n\r\n                            <div className=\"bg-white p-6 rounded-2xl shadow-[0_4px_20px_-4px_rgba(0,0,0,0.1)] border border-indigo-50 space-y-2 ring-1 ring-emerald-100/50\">\r\n                                <div>\r\n                                    <label className=\"block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2\">Ingresos Totales (Bruto)</label>\r\n                                    <div className=\"relative group\">\r\n                                        <input\r\n                                            type=\"number\"\r\n                                            value={totalIncome || ''}\r\n                                            onChange={(e) => setTotalIncome(parseFloat(e.target.value) || 0)}\r\n                                            onFocus={() => setFocusedField('income')}\r\n                                            className=\"w-full bg-transparent border-0 border-b-2 border-gray-100 px-1 py-2 text-4xl font-mono font-bold text-gray-900 focus:ring-0 focus:border-emerald-500 outline-none transition-all placeholder-gray-200\"\r\n                                            placeholder=\"0.00\"\r\n                                            aria-label=\"Ingresos Totales (Bruto)\"\r\n                                        />\r\n                                        <span className=\"absolute right-0 top-1/2 -translate-y-1/2 text-emerald-600/20 text-4xl font-light pointer-events-none\">‚Ç¨</span>\r\n                                    </div>\r\n                                    <p className=\"text-[10px] text-gray-400 mt-2 text-right font-medium\">\r\n                                        Introduce el importe neto sin IVA si es posible\r\n                                    </p>\r\n                                </div>\r\n                            </div>\r\n                        </section>\r\n\r\n                        <section>\r\n                            <div className=\"flex items-center justify-between mb-6\">\r\n                                <h2 className=\"text-sm uppercase tracking-wide font-bold text-gray-900 flex items-center gap-2\">\r\n                                    <div className=\"p-1.5 bg-blue-100/50 rounded-md text-blue-600\">\r\n                                        <Truck className=\"w-4 h-4\" />\r\n                                    </div>\r\n                                    Distribuci√≥n & Eficiencia\r\n                                </h2>\r\n                                <a\r\n                                    href=\"/profile\"\r\n                                    className=\"text-[10px] uppercase font-bold text-blue-500 hover:text-blue-700 flex items-center gap-1 transition-colors group\"\r\n                                >\r\n                                    <Settings className=\"w-3 h-3 group-hover:rotate-90 transition-transform\" />\r\n                                    Configurar\r\n                                </a>\r\n                            </div>\r\n                            <div className=\"bg-white p-6 rounded-2xl shadow-[0_2px_8px_-2px_rgba(0,0,0,0.05)] border border-gray-100 space-y-4\">\r\n                                <div className=\"space-y-3\">\r\n                                    {(logisticsRates.length > 0 ? logisticsRates : []).map((rate, index) => {\r\n                                        const range = rate.name || (rate.min !== undefined && rate.max !== undefined ? `${rate.min}-${rate.max} km` : `Tarifa ${index + 1}`);\r\n                                        const price = rate.price || 0;\r\n\r\n                                        return (\r\n                                            <div key={index} className=\"flex items-center justify-between group\">\r\n                                                <div className=\"flex flex-col\">\r\n                                                    <label className=\"text-gray-500 text-xs font-semibold group-hover:text-blue-600 transition-colors\">{range}</label>\r\n                                                    <span className={`text-[10px] font-mono font-medium ${price > 0 ? 'text-emerald-600' : 'text-amber-500'}`}>\r\n                                                        {formatMoney(price)}‚Ç¨ <span className={`${price > 0 ? 'text-emerald-400' : 'text-amber-400'}`}>/ud</span>\r\n                                                        {price === 0 && <span className=\"ml-1 text-[9px] text-amber-500\">(Sin Tarifa)</span>}\r\n                                                    </span>\r\n                                                </div>\r\n                                                <div className=\"flex items-center gap-2\">\r\n                                                    <input\r\n                                                        type=\"number\"\r\n                                                        value={orders[rate.name] || ''}\r\n                                                        onChange={(e) => setOrders(prev => ({ ...prev, [rate.name]: parseInt(e.target.value) || 0 }))}\r\n                                                        onFocus={() => setFocusedField('orders')}\r\n                                                        className=\"w-20 bg-gray-50 hover:bg-white focus:bg-white border border-transparent hover:border-gray-200 focus:border-blue-500 rounded-lg px-2 py-1.5 text-right font-mono text-sm text-gray-900 transition-all outline-none\"\r\n                                                        placeholder=\"0\"\r\n                                                        aria-label={`Pedidos para tarifa ${range}`}\r\n                                                    />\r\n                                                    <span className=\"text-[10px] text-gray-300 w-4\">pd</span>\r\n                                                </div>\r\n                                            </div>\r\n                                        );\r\n                                    })}\r\n                                    {logisticsRates.length === 0 && (\r\n                                        <div className=\"text-center py-4\">\r\n                                            <p className=\"text-xs text-amber-500 font-medium\">No hay tarifas configuradas.</p>\r\n                                        </div>\r\n                                    )}\r\n                                </div>\r\n\r\n                                <div className=\"mt-4 pt-4 border-t border-dashed border-gray-200\">\r\n                                    <div className=\"flex justify-between items-center px-2\">\r\n                                        <span className=\"text-xs font-bold text-gray-400 uppercase tracking-wider\">Total Km Estimados</span>\r\n                                        <span className=\"text-sm font-mono font-bold text-blue-900\">{Math.round(stats.estimatedKm).toLocaleString()} km</span>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n\r\n                            <div className=\"mt-6\">\r\n                                <label className=\"text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 block pl-1\">Incidencias</label>\r\n                                <div className=\"bg-white p-4 rounded-xl border border-gray-200 hover:border-red-200 transition-colors shadow-sm flex items-center justify-between group\">\r\n                                    <span className=\"text-xs font-medium text-gray-600\">Pedidos Cancelados</span>\r\n                                    <input\r\n                                        type=\"number\"\r\n                                        value={cancelledOrders || ''}\r\n                                        onChange={(e) => setCancelledOrders(parseInt(e.target.value) || 0)}\r\n                                        onFocus={() => setFocusedField('cancelled')}\r\n                                        className=\"w-24 bg-red-50/50 border border-transparent focus:border-red-500 rounded-lg px-3 py-1.5 text-right font-mono text-red-900 outline-none transition-all group-hover:bg-red-50\"\r\n                                        aria-label=\"Pedidos Cancelados\"\r\n                                    />\r\n                                </div>\r\n                            </div>\r\n                        </section>\r\n\r\n                        <section>\r\n                            <h2 className=\"text-sm uppercase tracking-wide font-bold text-gray-900 mb-6 flex items-center gap-2\">\r\n                                <div className=\"p-1.5 bg-purple-100/50 rounded-md text-purple-600\">\r\n                                    <Users className=\"w-4 h-4\" />\r\n                                </div>\r\n                                Flota y Laboral\r\n                            </h2>\r\n                            <div className=\"bg-white p-6 rounded-2xl shadow-[0_2px_8px_-2px_rgba(0,0,0,0.05)] border border-gray-100\">\r\n                                <div>\r\n                                    <label className=\"block text-xs font-semibold text-gray-500 uppercase mb-2\">Horas Totales (Riders)</label>\r\n                                    <input\r\n                                        type=\"number\"\r\n                                        value={totalHours || ''}\r\n                                        onChange={(e) => setTotalHours(parseFloat(e.target.value) || 0)}\r\n                                        onFocus={() => setFocusedField('labor')}\r\n                                        className=\"w-full bg-gray-50 border border-transparent hover:border-gray-200 hover:bg-white focus:bg-white rounded-xl px-4 py-3 text-gray-900 font-mono text-lg focus:border-purple-500 focus:ring-4 focus:ring-purple-500/10 outline-none transition-all\"\r\n                                        placeholder=\"0.0 hours\"\r\n                                        aria-label=\"Horas Totales (Riders)\"\r\n                                    />\r\n                                </div>\r\n                            </div>\r\n                        </section>\r\n                    </div>\r\n\r\n                    {/* COL 2: EXPENSES (Scrollable) */}\r\n                    <div className=\"lg:col-span-5 overflow-y-auto custom-scrollbar p-8 space-y-8 bg-gray-50/50\">\r\n\r\n                        <div className=\"flex items-center justify-between mb-6 pb-6 border-b border-gray-200/60 sticky top-0 bg-gray-50/95 backdrop-blur-sm z-10 pt-2\">\r\n                            <h2 className=\"text-sm uppercase tracking-wide font-bold text-gray-900 flex items-center gap-2\">\r\n                                <div className=\"p-1.5 bg-rose-100/50 rounded-md text-rose-600\">\r\n                                    <CreditCard className=\"w-4 h-4\" />\r\n                                </div>\r\n                                Estructura de Costes\r\n                            </h2>\r\n                            <div className=\"flex flex-col items-end\">\r\n                                <span className=\"text-[10px] uppercase font-bold text-gray-400 tracking-wider\">Total Gastos</span>\r\n                                <span className=\"text-lg font-mono font-bold text-gray-900 tracking-tight\">{formatMoney(stats.totalExpenses)}‚Ç¨</span>\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* FIXED COSTS */}\r\n                        <div className=\"bg-white p-6 rounded-2xl shadow-[0_2px_8px_-2px_rgba(0,0,0,0.05)] border border-gray-100\">\r\n                            <h3 className=\"text-xs font-bold uppercase tracking-widest text-indigo-900/40 mb-5 flex items-center gap-2\">\r\n                                <span className=\"w-1.5 h-1.5 rounded-full bg-indigo-400\"></span>\r\n                                Fijos y Estructurales\r\n                            </h3>\r\n\r\n                            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5\">\r\n                                <ExpenseInput label=\"N√≥minas\" value={expenses.payroll} onChange={(v) => updateExpense('payroll', v)} onFocus={() => setFocusedField('labor')} totalIncome={totalIncome} />\r\n                                <ExpenseInput label=\"Seguridad Social\" value={expenses.insurance} onChange={(v) => updateExpense('insurance', v)} onFocus={() => setFocusedField('labor')} totalIncome={totalIncome} />\r\n                                <ExpenseInput label=\"Cuota Aut√≥nomos\" value={expenses.quota} onChange={(v) => updateExpense('quota', v)} onFocus={() => setFocusedField('quota')} totalIncome={totalIncome} />\r\n                                <ExpenseInput label=\"Gestor√≠a\" value={expenses.agencyFee} onChange={(v) => updateExpense('agencyFee', v)} onFocus={() => setFocusedField('agencyFee')} totalIncome={totalIncome} />\r\n                                <ExpenseInput label=\"PRL\" value={expenses.prlFee} onChange={(v) => updateExpense('prlFee', v)} onFocus={() => setFocusedField('prlFee')} totalIncome={totalIncome} />\r\n                                <ExpenseInput label=\"App Flyder\" value={expenses.accountingFee} onChange={(v) => updateExpense('accountingFee', v)} onFocus={() => setFocusedField('accountingFee')} totalIncome={totalIncome} />\r\n\r\n                                <ExpenseInput label=\"Servicios Financieros Repaart\" value={expenses.appFlyder} onChange={(v) => updateExpense('appFlyder', v)} onFocus={() => setFocusedField('appFlyder')} totalIncome={totalIncome} />\r\n                                <ExpenseInput label=\"Marketing Local\" value={expenses.marketing} onChange={(v) => updateExpense('marketing', v)} onFocus={() => setFocusedField('marketing')} totalIncome={totalIncome} />\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* VARIABLE COSTS */}\r\n                        <div className=\"bg-white p-6 rounded-2xl shadow-[0_2px_8px_-2px_rgba(0,0,0,0.05)] border border-gray-100\">\r\n                            <h3 className=\"text-xs font-bold uppercase tracking-widest text-amber-900/40 mb-5 flex items-center gap-2\">\r\n                                <span className=\"w-1.5 h-1.5 rounded-full bg-amber-400\"></span>\r\n                                Variables y Flota\r\n                            </h3>\r\n\r\n                            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5\">\r\n                                <ExpenseInput isVariable label=\"Gasolina\" value={expenses.fuel} onChange={(v) => updateExpense('fuel', v)} onFocus={() => setFocusedField('fuel')} totalIncome={totalIncome} />\r\n                                <ExpenseInput isVariable label=\"Reparaciones\" value={expenses.repairs} onChange={(v) => updateExpense('repairs', v)} onFocus={() => setFocusedField('repairs')} totalIncome={totalIncome} />\r\n                                <ExpenseInput isVariable label=\"Incidentes\" value={expenses.incidents} onChange={(v) => updateExpense('incidents', v)} onFocus={() => setFocusedField('incidents')} totalIncome={totalIncome} />\r\n                                <ExpenseInput isVariable label=\"Otros\" value={expenses.other} onChange={(v) => updateExpense('other', v)} onFocus={() => setFocusedField('other')} totalIncome={totalIncome} />\r\n                            </div>\r\n\r\n                            <div className=\"bg-slate-50 p-4 rounded-xl border border-slate-100 mt-6 shadow-sm\">\r\n                                <div className=\"flex justify-between items-center mb-3\">\r\n                                    <label className=\"text-sm font-bold text-gray-700\">Renting Motos</label>\r\n                                    <span className=\"text-xs font-mono font-medium text-gray-500\">{formatMoney((expenses.renting?.count ?? 0) * (expenses.renting?.pricePerUnit ?? 0))}‚Ç¨</span>\r\n                                </div>\r\n                                <div className=\"flex gap-4\">\r\n                                    <div>\r\n                                        <label className=\"text-xs text-gray-500 block mb-1\">Unidades</label>\r\n                                        <input\r\n                                            type=\"number\"\r\n                                            value={expenses.renting?.count || 0}\r\n                                            onChange={(e) => setExpenses(prev => ({ ...prev, renting: { ...prev.renting!, count: parseInt(e.target.value) || 0 } }))}\r\n                                            onFocus={() => setFocusedField('renting')}\r\n                                            className=\"w-full bg-white border border-gray-200 rounded-lg px-3 py-2 text-gray-900 font-mono text-sm focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 outline-none transition-all shadow-sm\"\r\n                                        />\r\n                                    </div>\r\n                                    <div className=\"flex-1\">\r\n                                        <label className=\"text-xs text-gray-500 block mb-1\">Precio / Unidad</label>\r\n                                        <input\r\n                                            type=\"number\"\r\n                                            value={expenses.renting?.pricePerUnit || 0}\r\n                                            onChange={(e) => setExpenses(prev => ({ ...prev, renting: { ...prev.renting!, pricePerUnit: parseFloat(e.target.value) || 0 } }))}\r\n                                            onFocus={() => setFocusedField('renting')}\r\n                                            className=\"w-full bg-white border border-gray-200 rounded-lg px-3 py-2 text-gray-900 font-mono text-sm focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 outline-none transition-all shadow-sm\"\r\n                                        />\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* ROYALTY & TAX */}\r\n                        <div className=\"bg-white p-6 rounded-2xl shadow-[0_2px_8px_-2px_rgba(0,0,0,0.05)] border border-gray-100\">\r\n                            <h3 className=\"text-xs font-bold uppercase tracking-widest text-indigo-900/40 mb-5 flex items-center gap-2\">\r\n                                <span className=\"w-1.5 h-1.5 rounded-full bg-indigo-500\"></span>\r\n                                Fiscalidad\r\n                            </h3>\r\n                            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\r\n                                <div>\r\n                                    <label className=\"text-xs font-bold text-gray-500 block mb-1.5\">% Royalty</label>\r\n                                    <input\r\n                                        type=\"number\"\r\n                                        value={expenses.royaltyPercent}\r\n                                        onChange={(e) => updateExpense('royaltyPercent', parseFloat(e.target.value))}\r\n                                        onFocus={() => setFocusedField('royalty')}\r\n                                        className=\"w-full bg-white border border-gray-200 rounded-lg px-3 py-2 text-gray-900 font-mono text-sm focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 outline-none shadow-sm\"\r\n                                        aria-label=\"Porcentaje de Royalty\"\r\n                                    />\r\n                                </div>\r\n                                <div>\r\n                                    <label className=\"text-xs font-bold text-gray-500 block mb-1.5\">% IRPF</label>\r\n                                    <input\r\n                                        type=\"number\"\r\n                                        value={expenses.irpfPercent}\r\n                                        onChange={(e) => updateExpense('irpfPercent', parseFloat(e.target.value))}\r\n                                        onFocus={() => setFocusedField('irpf')}\r\n                                        className=\"w-full bg-white border border-gray-200 rounded-lg px-3 py-2 text-gray-900 font-mono text-sm focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 outline-none shadow-sm\"\r\n                                        aria-label=\"Porcentaje de IRPF\"\r\n                                    />\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n\r\n                    </div>\r\n\r\n                    {/* COL 3: ANALYTICS SIDEBAR */}\r\n                    <div className=\"lg:col-span-3 bg-slate-50 border-l border-slate-200 flex flex-col relative overflow-hidden\">\r\n\r\n                        <div className=\"p-6 flex-1 overflow-y-auto relative z-10 flex flex-col gap-6\">\r\n\r\n                            <div className=\"flex items-center gap-2 mb-2\">\r\n                                <div className=\"p-2 bg-slate-800 rounded-lg shadow-sm\">\r\n                                    <TrendingDown className=\"w-5 h-5 text-white\" />\r\n                                </div>\r\n                                <div>\r\n                                    <h2 className=\"text-lg font-bold text-slate-900 leading-tight\">\r\n                                        An√°lisis CFO\r\n                                    </h2>\r\n                                    <span className=\"text-[10px] font-bold text-slate-500 uppercase tracking-widest\">Vista Directiva</span>\r\n                                </div>\r\n                            </div>\r\n\r\n                            {/* 1. ALWAYS SHOW BREAK EVEN (NORTH STAR) */}\r\n                            <BreakEvenWidget\r\n                                fixedCosts={stats.fixedCosts}\r\n                                variableCosts={stats.variableCosts}\r\n                                revenue={totalIncome}\r\n                                totalOrders={stats.totalOrders}\r\n                            />\r\n\r\n                            <div className=\"w-full h-px bg-gray-200 my-2\" />\r\n\r\n                            {/* 2. DYNAMIC CONTENT: TIP or HEALTH CHECK */}\r\n                            {focusedField !== 'default' ? (\r\n                                <div className={`rounded-xl p-5 shadow-sm border transition-all duration-300 animate-in fade-in slide-in-from-right-4 ${getStatusColors(activeTip.status)}`}>\r\n                                    <div className=\"mb-3\">\r\n                                        <div className=\"flex justify-between items-start mb-3\">\r\n                                            <div className=\"w-10 h-10 bg-white/80 rounded-full flex items-center justify-center shadow-sm\">\r\n                                                {activeTip.icon}\r\n                                            </div>\r\n                                            {activeTip.metric && (\r\n                                                <div className=\"bg-white/80 px-2.5 py-1 rounded-full text-[10px] font-bold shadow-sm border border-gray-100\">\r\n                                                    {activeTip.metric}\r\n                                                </div>\r\n                                            )}\r\n                                        </div>\r\n\r\n                                        <h3 className=\"text-sm font-bold text-gray-900 mb-1.5\">\r\n                                            {activeTip.title}\r\n                                        </h3>\r\n                                        <p className=\"text-gray-600 leading-relaxed text-xs whitespace-pre-line\">\r\n                                            {activeTip.content}\r\n                                        </p>\r\n                                    </div>\r\n                                    <button\r\n                                        onClick={() => setFocusedField('default')}\r\n                                        className=\"mt-2 w-full py-1.5 bg-white/50 hover:bg-white/80 text-gray-600 text-[10px] font-bold uppercase tracking-wider rounded-lg transition-colors border border-gray-100\"\r\n                                    >\r\n                                        Ver Resumen Global\r\n                                    </button>\r\n                                </div>\r\n                            ) : (\r\n                                <ActiveHealthCheck tips={allTips} />\r\n                            )}\r\n                        </div>\r\n\r\n                        {/* SIDEBAR FOOTER: EXECUTIVE KPIS */}\r\n                        <div className=\"p-4 bg-white border-t border-slate-200 mt-auto shrink-0 z-20\">\r\n                            <div className=\"grid grid-cols-2 gap-3\">\r\n                                <div\r\n                                    className=\"bg-slate-50 p-3 rounded-xl border border-slate-100 shadow-sm text-center group hover:bg-white hover:border-emerald-200 hover:shadow-md transition-all cursor-help\"\r\n                                    title=\"Rentabilidad real del negocio. F√≥rmula: ((Ingresos - Gastos) / Ingresos) √ó 100\"\r\n                                >\r\n                                    <div className=\"flex items-center justify-center gap-1 mb-1 opacity-60 group-hover:opacity-100 transition-opacity\">\r\n                                        <p className=\"text-[10px] text-slate-400 uppercase font-bold tracking-wider\">Margen Neto</p>\r\n                                        <Info className=\"w-3 h-3 text-slate-400\" />\r\n                                    </div>\r\n                                    <p className={`text-lg font-mono font-bold ${stats.profit > 0 ? 'text-emerald-600' : 'text-rose-600'}`}>\r\n                                        {totalIncome > 0 ? ((stats.profit / totalIncome) * 100).toFixed(1) : 0}%\r\n                                    </p>\r\n                                </div>\r\n                                <div\r\n                                    className=\"bg-slate-50 p-3 rounded-xl border border-slate-100 shadow-sm text-center group hover:bg-white hover:border-blue-200 hover:shadow-md transition-all cursor-help\"\r\n                                    title=\"Coste operativo promedio para entregar un pedido. F√≥rmula: Gastos Totales / N√∫mero de Pedidos\"\r\n                                >\r\n                                    <div className=\"flex items-center justify-center gap-1 mb-1 opacity-60 group-hover:opacity-100 transition-opacity\">\r\n                                        <p className=\"text-[10px] text-slate-400 uppercase font-bold tracking-wider\">Coste/Pedido</p>\r\n                                        <Info className=\"w-3 h-3 text-slate-400\" />\r\n                                    </div>\r\n                                    <p className=\"text-lg font-mono font-bold text-slate-700 group-hover:text-blue-700 transition-colors\">\r\n                                        {stats.totalOrders > 0 ? formatMoney(stats.totalExpenses / stats.totalOrders) : '0.00'}‚Ç¨\r\n                                    </p>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                </div >\r\n            </div >\r\n\r\n            {/* UNLOCK REASON MODAL */}\r\n            {\r\n                showUnlockModal && (\r\n                    <div className=\"fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] flex items-center justify-center p-4 animate-in fade-in duration-200\">\r\n                        <div className=\"bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 space-y-4 animate-in zoom-in-95 duration-200\">\r\n                            <div className=\"flex items-center gap-3 text-amber-600 mb-2\">\r\n                                <div className=\"p-2 bg-amber-100 rounded-lg\">\r\n                                    <Lock className=\"w-5 h-5\" />\r\n                                </div>\r\n                                <h3 className=\"text-lg font-bold text-gray-900\">Solicitar Desbloqueo</h3>\r\n                            </div>\r\n\r\n                            {/* VISUAL TIMELINE */}\r\n                            <div className=\"flex items-center justify-between px-4 py-3 bg-slate-50 rounded-xl border border-slate-100 mb-2 text-xs font-bold text-slate-400\">\r\n                                <div className=\"flex flex-col items-center gap-1 text-slate-900\">\r\n                                    <span className=\"w-2.5 h-2.5 rounded-full bg-slate-900\" />\r\n                                    <span>Bloqueado</span>\r\n                                </div>\r\n                                <div className=\"h-0.5 flex-1 bg-slate-200 mx-2\" />\r\n                                <div className=\"flex flex-col items-center gap-1 text-amber-600\">\r\n                                    <span className=\"w-2.5 h-2.5 rounded-full bg-amber-500 animate-pulse shadow-[0_0_0_3px_rgba(245,158,11,0.2)]\" />\r\n                                    <span>Solicitar...</span>\r\n                                </div>\r\n                                <div className=\"h-0.5 flex-1 bg-slate-200 mx-2\" />\r\n                                <div className=\"flex flex-col items-center gap-1\">\r\n                                    <span className=\"w-2.5 h-2.5 rounded-full bg-slate-300\" />\r\n                                    <span>Desbloqueo</span>\r\n                                </div>\r\n                            </div>\r\n\r\n                            {/* REJECTION REASON IF EXISTS */}\r\n                            {lastRejectionReason && (\r\n                                <div className=\"bg-rose-50 border border-rose-100 rounded-lg p-3 text-xs mb-3\">\r\n                                    <p className=\"font-bold text-rose-800 uppercase tracking-wider mb-1 flex items-center gap-1\">\r\n                                        <X className=\"w-3 h-3\" /> Motivo del Rechazo Anterior\r\n                                    </p>\r\n                                    <p className=\"text-rose-700 italic\">\"{lastRejectionReason}\"</p>\r\n                                </div>\r\n                            )}\r\n\r\n                            <p className=\"text-sm text-gray-500\">\r\n                                Para desbloquear el mes de <strong>{month}</strong>, debes indicar al administrador el motivo de la correcci√≥n.\r\n                            </p>\r\n\r\n                            <div className=\"space-y-2\">\r\n                                <label className=\"text-xs font-bold text-gray-700 uppercase tracking-wider\">Motivo</label>\r\n                                <textarea\r\n                                    value={unlockReason}\r\n                                    onChange={(e) => setUnlockReason(e.target.value)}\r\n                                    className=\"w-full h-24 p-3 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-amber-500/20 focus:border-amber-500 outline-none resize-none\"\r\n                                    placeholder=\"Ej: Olvid√© incluir una factura de proveedor...\"\r\n                                    autoFocus\r\n                                />\r\n                            </div>\r\n\r\n                            <div className=\"flex gap-3 justify-end pt-2\">\r\n                                <button\r\n                                    onClick={() => setShowUnlockModal(false)}\r\n                                    className=\"px-4 py-2 text-sm font-medium text-gray-600 hover:bg-gray-50 rounded-lg transition-colors\"\r\n                                >\r\n                                    Cancelar\r\n                                </button>\r\n                                <button\r\n                                    onClick={submitUnlockRequest}\r\n                                    disabled={saving || !unlockReason.trim()}\r\n                                    className=\"px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white text-sm font-bold rounded-lg shadow-lg shadow-amber-500/20 transition-all disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                                >\r\n                                    {saving ? 'Enviando...' : 'Enviar Solicitud'}\r\n                                </button>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                )\r\n            }\r\n        </div >\r\n    );\r\n};\r\n\r\n// --- HELPER COMPONENTS ---\r\n\r\nconst ExpenseInput = ({\r\n    label,\r\n    value,\r\n    onChange,\r\n    onFocus,\r\n    totalIncome, // New Prop for Context\r\n    isVariable = false\r\n}: {\r\n    label: string,\r\n    value: number,\r\n    onChange: (val: number) => void,\r\n    onFocus: () => void,\r\n    totalIncome?: number,\r\n    isVariable?: boolean\r\n}) => {\r\n    const ratio = totalIncome && totalIncome > 0 && value > 0\r\n        ? ((value / totalIncome) * 100).toFixed(1)\r\n        : null;\r\n\r\n    return (\r\n        <div className=\"group relative transition-all duration-300 hover:-translate-y-0.5\">\r\n            <div className=\"flex justify-between items-baseline mb-1.5\">\r\n                <label className=\"text-xs font-semibold text-gray-500 tracking-tight\">{label}</label>\r\n                {ratio && (\r\n                    <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded-full ${isVariable ? 'bg-amber-50 text-amber-700' : 'bg-slate-100 text-slate-600'\r\n                        }`}>\r\n                        {ratio}%\r\n                    </span>\r\n                )}\r\n            </div>\r\n            <div className=\"relative\">\r\n                <input\r\n                    type=\"number\"\r\n                    value={value || ''}\r\n                    onChange={(e) => onChange(parseFloat(e.target.value) || 0)}\r\n                    onFocus={onFocus}\r\n                    className=\"w-full bg-white border border-gray-200 rounded-lg px-3 py-2 text-gray-900 font-mono text-sm transition-all focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 outline-none placeholder-gray-300 hover:border-gray-300 shadow-sm\"\r\n                    placeholder=\"0.00\"\r\n                    aria-label={label}\r\n                />\r\n                <span className=\"absolute right-3 top-1/2 -translate-y-1/2 text-gray-300 text-xs pointer-events-none\">‚Ç¨</span>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default FinancialControlCenter;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\FranchiseDashboard.tsx","messages":[{"ruleId":"prefer-const","severity":2,"message":"'breakdownList' is never reassigned. Use 'const' instead.","line":83,"column":9,"nodeType":"Identifier","messageId":"useConst","endLine":83,"endColumn":22,"fix":{"range":[3129,3180],"text":"const breakdownList = [...(report?.breakdown || [])];"}},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":111,"column":72,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":111,"endColumn":75,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4507,4510],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4507,4510],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":1,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\r\nimport { useOutletContext } from 'react-router-dom';\r\n\r\n// Components\r\nimport DashboardSkeleton from '../../ui/layout/DashboardSkeleton';\r\nimport FranchiseDashboardView, { BreakdownItem, DashboardTrendItem } from './FranchiseDashboardView';\r\n\r\nimport { AuthUser } from '../../context/AuthContext';\r\nimport { useFranchiseFinance } from '../../hooks/useFranchiseFinance';\r\n\r\n// TYPE DEFINITIONS\r\ninterface DashboardContextType {\r\n    user: AuthUser | null;\r\n    franchiseId?: string;\r\n    selectedMonth: string;\r\n    handleUpdate?: () => Promise<void>;\r\n    setSelectedMonth: (month: string) => void;\r\n}\r\n\r\n// PROPS for Admin usage (Optional)\r\ninterface FranchiseDashboardProps {\r\n    franchiseId?: string;\r\n    readOnly?: boolean;\r\n}\r\n\r\nconst FranchiseDashboard: React.FC<FranchiseDashboardProps> = ({ franchiseId: propId, readOnly = false }) => {\r\n    // Try to get context, but don't fail if it's missing (Admin usage)\r\n    const context = useOutletContext<DashboardContextType | null>();\r\n\r\n    // Derive values\r\n    const selectedMonth = context?.selectedMonth || new Date().toISOString().slice(0, 7);\r\n    const user = context?.user || null;\r\n    const activeFranchiseId = propId || context?.franchiseId || user?.uid;\r\n\r\n    // Helper for Admin Date Switch\r\n    const [localMonth, setLocalMonth] = useState(selectedMonth);\r\n    const effectiveMonth = propId ? localMonth : selectedMonth;\r\n    const effectiveSetMonth = propId ? setLocalMonth : (context?.setSelectedMonth || (() => { }));\r\n\r\n    // --- UNIFIED FINANCE HOOK ---\r\n    const {\r\n        accounting,\r\n        rawData,\r\n        trendData,\r\n        loading,\r\n        updateFinance\r\n    } = useFranchiseFinance({\r\n        franchiseId: activeFranchiseId || '', // Pass empty string if undefined to be safe, hook should handle it\r\n        month: effectiveMonth\r\n    });\r\n\r\n    const { report, revenue, orders } = accounting;\r\n    const handleUpdate = updateFinance;\r\n\r\n    // --- UI STATE (Passed to View) ---\r\n    const [isWizardOpen, setIsWizardOpen] = useState(false);\r\n    const [isSimulatorOpen, setIsSimulatorOpen] = useState(false);\r\n    const [isHistoryView, setIsHistoryView] = useState(false);\r\n    const [drillDown, setDrillDown] = useState<string | null>(null);\r\n    const [isLegendOpen, setIsLegendOpen] = useState(false);\r\n    const [showGuide, setShowGuide] = useState(false);\r\n\r\n    // If no props and no context, we are lost (Check AFTER hooks)\r\n    if (!propId && !context) return <DashboardSkeleton />;\r\n\r\n    if (loading) return <DashboardSkeleton />;\r\n\r\n    // --- METRICS CALCULATION (Container Logic) ---\r\n    const totalExpenses = report?.totalExpenses || 0;\r\n\r\n    // Cost Per Hour\r\n    const totalHours = Number(rawData?.totalHours || 0);\r\n    // costPerHour removed\r\n\r\n\r\n    // Trends\r\n    const previousMonthData = trendData.length > 1 ? trendData[trendData.length - 2] : null;\r\n    const revenueTrend = previousMonthData && previousMonthData.revenue > 0\r\n        ? ((revenue - previousMonthData.revenue) / previousMonthData.revenue) * 100\r\n        : 0;\r\n\r\n    // Expense Breakdown Preparation\r\n    let breakdownList = [...(report?.breakdown || [])];\r\n\r\n    // 1. Find existing Royalty item\r\n    const royaltyIndex = breakdownList.findIndex(i => i.name.includes('Royalty'));\r\n\r\n    // 2. Calculate the robust value (Never be less than 5% if revenue exists)\r\n    const storedRoyalty = Number(rawData?.breakdown?.['Royalty'] || rawData?.breakdown?.['Royalty Flyder'] || 0);\r\n    const fallbackRoyalty = (revenue || 0) * 0.05;\r\n    const currentReportRoyalty = breakdownList[royaltyIndex]?.value || 0;\r\n\r\n    const finalRoyaltyValue = Math.max(currentReportRoyalty, storedRoyalty, fallbackRoyalty);\r\n\r\n    if (royaltyIndex >= 0) {\r\n        breakdownList[royaltyIndex] = { ...breakdownList[royaltyIndex], value: finalRoyaltyValue };\r\n    } else if (finalRoyaltyValue > 0) {\r\n        breakdownList.push({ name: 'Royalty Flyder', value: finalRoyaltyValue, type: 'variable' });\r\n    }\r\n\r\n    const fullExpenseBreakdown: BreakdownItem[] = breakdownList\r\n        .filter(item => item.value > 0)\r\n        .sort((a, b) => b.value - a.value)\r\n        .map((item, index) => ({\r\n            label: item.name,\r\n            amount: item.value,\r\n            color: ['#6366f1', '#f43f5e', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#06b6d4', '#14b8a6'][index % 8]\r\n        }));\r\n\r\n    // Historical Chart Data formatting\r\n    const formattedTrendData: DashboardTrendItem[] = trendData.map((d: any) => ({\r\n        month: d.name || d.monthName || d.month || 'Mes',\r\n        revenue: d.revenue || d.income || 0,\r\n        expenses: d.expenses || d.totalExpenses || 0\r\n    }));\r\n\r\n    return (\r\n        <FranchiseDashboardView\r\n            franchiseId={activeFranchiseId}\r\n            effectiveMonth={effectiveMonth}\r\n            readOnly={readOnly}\r\n\r\n            // Metrics\r\n            revenue={revenue}\r\n            orders={orders}\r\n            totalExpenses={totalExpenses}\r\n            totalHours={totalHours}\r\n            revenueTrend={revenueTrend}\r\n\r\n            // Data\r\n            report={report}\r\n            rawData={rawData}\r\n            trendData={trendData}\r\n            formattedTrendData={formattedTrendData}\r\n            fullExpenseBreakdown={fullExpenseBreakdown}\r\n\r\n            // State\r\n            isWizardOpen={isWizardOpen}\r\n            setIsWizardOpen={setIsWizardOpen}\r\n            isSimulatorOpen={isSimulatorOpen}\r\n            setIsSimulatorOpen={setIsSimulatorOpen}\r\n            isHistoryView={isHistoryView}\r\n            setIsHistoryView={setIsHistoryView}\r\n            drillDown={drillDown}\r\n            setDrillDown={setDrillDown}\r\n            isLegendOpen={isLegendOpen}\r\n            setIsLegendOpen={setIsLegendOpen}\r\n            showGuide={showGuide}\r\n            setShowGuide={setShowGuide}\r\n\r\n            // Handlers\r\n            onMonthChange={effectiveSetMonth}\r\n            onUpdateFinance={handleUpdate}\r\n        />\r\n    );\r\n};\r\n\r\nexport default FranchiseDashboard;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\FranchiseDashboardView.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":23,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":23,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1177,1180],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1177,1180],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":49,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":49,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1771,1774],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1771,1774],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":69,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":69,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2472,2475],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2472,2475],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":243,"column":62,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":243,"endColumn":65,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13994,13997],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13994,13997],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":258,"column":62,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":258,"endColumn":65,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14838,14841],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14838,14841],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":335,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":335,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18536,18539],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18536,18539],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":362,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":362,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[20594,20597],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[20594,20597],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\nimport { PlayCircle, FileText, HelpCircle, Sparkles, ChevronLeft, ChevronRight, Lock, TrendingUp } from 'lucide-react';\r\nimport { formatMoney, FinancialReport, MonthlyData } from '../../lib/finance';\r\n\r\n// Components\r\nimport TaxVaultWidget from './finance/TaxVaultWidget';\r\nimport FinancialControlCenter from './FinancialControlCenter';\r\nimport FranchiseHistoryView from './finance/FranchiseHistoryView';\r\nimport ScenarioSimulator from './finance/ScenarioSimulator';\r\nimport DrillDownModal from '../admin/dashboard/DrillDownModal';\r\nimport ExpenseBreakdownWidget from './dashboard/widgets/ExpenseBreakdownWidget';\r\nimport TakeHomeProfitWidget from './dashboard/widgets/TakeHomeProfitWidget';\r\nimport RevenueAreaChart from './dashboard/widgets/RevenueAreaChart';\r\nimport KPICard from './dashboard/widgets/KPICard';\r\nimport HourlyCostWidget from './dashboard/widgets/HourlyCostWidget';\r\nimport WidgetLegendModal from './dashboard/WidgetLegendModal';\r\nimport FinancialWorkflowGuide from './components/FinancialWorkflowGuide';\r\n\r\nexport interface DashboardTrendItem {\r\n    month: string;\r\n    revenue: number;\r\n    expenses: number;\r\n    [key: string]: any;\r\n}\r\n\r\nexport interface BreakdownItem {\r\n    label: string;\r\n    amount: number;\r\n    color: string;\r\n}\r\n\r\nexport interface FranchiseDashboardViewProps {\r\n    // Context & Config\r\n    franchiseId?: string;\r\n    effectiveMonth: string;\r\n    readOnly: boolean;\r\n\r\n    // Metrics & Data\r\n    revenue: number;\r\n    orders: number;\r\n    totalExpenses: number;\r\n    totalHours: number;\r\n    // costPerHour removed\r\n    revenueTrend: number;\r\n\r\n    // Data Structures\r\n    report: FinancialReport | null; // Using FinancialReport from lib/finance\r\n    rawData: MonthlyData | null;\r\n    trendData: any[]; // Raw trend data for sparklines\r\n    formattedTrendData: DashboardTrendItem[];\r\n    fullExpenseBreakdown: BreakdownItem[];\r\n\r\n    // View State\r\n    isWizardOpen: boolean;\r\n    setIsWizardOpen: (open: boolean) => void;\r\n    isSimulatorOpen: boolean;\r\n    setIsSimulatorOpen: (open: boolean) => void;\r\n    isHistoryView: boolean;\r\n    setIsHistoryView: (view: boolean) => void;\r\n    drillDown: string | null;\r\n    setDrillDown: (val: string | null) => void;\r\n    isLegendOpen: boolean;\r\n    setIsLegendOpen: (open: boolean) => void;\r\n    showGuide: boolean;\r\n    setShowGuide: (show: boolean) => void;\r\n\r\n    // Actions\r\n    onMonthChange: (month: string) => void;\r\n    onUpdateFinance: (data: any) => Promise<void>;\r\n}\r\n\r\nconst FranchiseDashboardView: React.FC<FranchiseDashboardViewProps> = ({\r\n    franchiseId,\r\n    effectiveMonth,\r\n    readOnly,\r\n    revenue,\r\n    orders,\r\n    totalExpenses,\r\n    totalHours,\r\n    // costPerHour removed\r\n    revenueTrend,\r\n    report,\r\n    rawData,\r\n    trendData,\r\n    formattedTrendData,\r\n    fullExpenseBreakdown,\r\n    isWizardOpen,\r\n    setIsWizardOpen,\r\n    isSimulatorOpen,\r\n    setIsSimulatorOpen,\r\n    isHistoryView,\r\n    setIsHistoryView,\r\n    drillDown,\r\n    setDrillDown,\r\n    isLegendOpen,\r\n    setIsLegendOpen,\r\n    showGuide,\r\n    setShowGuide,\r\n    onMonthChange,\r\n    onUpdateFinance\r\n}) => {\r\n    return (\r\n        <div className=\"min-h-screen bg-[#fafbfc] dark:bg-slate-950 font-sans text-slate-900 dark:text-slate-100 selection:bg-indigo-100 dark:selection:bg-indigo-900/30 transition-colors duration-300\">\r\n            <div className=\"max-w-[1600px] mx-auto p-6 md:p-10 space-y-8\">\r\n\r\n                {/* HEADER */}\r\n                <div className=\"flex flex-col md:flex-row items-center justify-between gap-6 pb-2\">\r\n                    <div className=\"flex items-center gap-4\">\r\n                        <div className=\"flex items-center gap-2 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 p-2 rounded-2xl shadow-sm\">\r\n                            <button\r\n                                onClick={() => {\r\n                                    const date = new Date(effectiveMonth + '-01');\r\n                                    date.setMonth(date.getMonth() - 1);\r\n                                    onMonthChange(date.toISOString().slice(0, 7));\r\n                                }}\r\n                                className=\"p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl transition-colors text-slate-500\"\r\n                                title=\"Mes Anterior\"\r\n                            >\r\n                                <ChevronLeft className=\"w-5 h-5\" />\r\n                            </button>\r\n                            <h2 className=\"text-2xl font-bold text-slate-900 dark:text-white tracking-tight px-6 min-w-[200px] text-center uppercase tabular-nums\">\r\n                                {new Date(effectiveMonth + '-01').toLocaleDateString('es-ES', { month: 'long', year: 'numeric' })}\r\n                            </h2>\r\n                            <button\r\n                                onClick={() => {\r\n                                    const date = new Date(effectiveMonth + '-01');\r\n                                    date.setMonth(date.getMonth() + 1);\r\n                                    onMonthChange(date.toISOString().slice(0, 7));\r\n                                }}\r\n                                className=\"p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl transition-colors text-slate-500\"\r\n                                title=\"Mes Siguiente\"\r\n                            >\r\n                                <ChevronRight className=\"w-5 h-5\" />\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n\r\n\r\n                    <div className=\"flex items-center gap-3\">\r\n                        {/* Help Button */}\r\n                        <button\r\n                            onClick={() => setIsLegendOpen(true)}\r\n                            className=\"group bg-white dark:bg-slate-900 border-2 border-indigo-200 dark:border-indigo-900 hover:border-indigo-400 dark:hover:border-indigo-700 text-indigo-600 dark:text-indigo-400 px-4 py-3 rounded-xl text-xs font-bold uppercase tracking-widest transition-all shadow-sm hover:shadow-md hover:-translate-y-0.5 flex items-center gap-2\"\r\n                            title=\"Gu√≠a de Widgets\"\r\n                        >\r\n                            <HelpCircle className=\"w-4 h-4 group-hover:rotate-12 transition-transform\" />\r\n                            <span className=\"hidden sm:inline\">Ayuda</span>\r\n                        </button>\r\n\r\n                        {/* Workflow Guide Button - Only visible in History View */}\r\n                        {isHistoryView && (\r\n                            <button\r\n                                onClick={() => setShowGuide(true)}\r\n                                className=\"bg-white dark:bg-slate-900 border-2 border-slate-200 dark:border-slate-800 hover:border-indigo-300 dark:hover:border-indigo-700 text-slate-600 dark:text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-400 px-4 py-3 rounded-xl text-xs font-bold uppercase tracking-widest transition-all shadow-sm hover:shadow-md hover:-translate-y-0.5 flex items-center gap-2 animate-in fade-in slide-in-from-right-4\"\r\n                                title=\"Gu√≠a del Proceso de Cierre\"\r\n                            >\r\n                                <FileText className=\"w-4 h-4\" />\r\n                                <span className=\"hidden sm:inline\">Gu√≠a</span>\r\n                            </button>\r\n                        )}\r\n\r\n                        {/* Simulator Trigger - Striking Amber Style */}\r\n                        <button\r\n                            onClick={() => setIsSimulatorOpen(true)}\r\n                            className=\"relative group overflow-hidden bg-amber-500 hover:bg-amber-600 text-white px-6 py-3.5 rounded-xl text-xs font-bold uppercasetracking-widest transition-all shadow-lg shadow-amber-500/20 hover:shadow-amber-500/40 hover:-translate-y-0.5 flex items-center gap-2 border border-amber-400/50\"\r\n                        >\r\n                            <div className=\"absolute inset-x-0 bottom-0 h-1 bg-white/20 transform scale-x-0 group-hover:scale-x-100 transition-transform origin-left\" />\r\n                            <PlayCircle className=\"w-4 h-4 text-amber-100 group-hover:rotate-12 transition-transform\" />\r\n                            <span>Simular</span>\r\n                        </button>\r\n\r\n                        <button\r\n                            onClick={() => setIsHistoryView(!isHistoryView)}\r\n                            className={`text-xs font-bold uppercase tracking-widest px-6 py-3.5 rounded-xl transition-all shadow-sm ${isHistoryView\r\n                                ? 'bg-slate-800 dark:bg-slate-700 text-white shadow-lg shadow-slate-800/20 hover:bg-slate-900 dark:hover:bg-slate-600'\r\n                                : 'bg-white dark:bg-slate-900 text-slate-500 dark:text-slate-400 border border-slate-100 dark:border-slate-800 hover:border-slate-200 hover:text-slate-700 dark:hover:text-slate-200'\r\n                                }`}\r\n                            title={isHistoryView ? \"Cambiar a Vista Mensual\" : \"Cambiar a Vista Hist√≥rica\"}\r\n                        >\r\n                            {isHistoryView ? 'Mensual' : 'Hist√≥rico'}\r\n                        </button>\r\n\r\n                        {!readOnly && (\r\n                            <button\r\n                                onClick={() => setIsWizardOpen(true)}\r\n                                className={`px-6 py-3.5 rounded-xl text-xs font-bold uppercase tracking-widest transition-all flex items-center gap-2 shadow-sm hover:shadow-md border ${rawData?.is_locked || rawData?.status === 'submitted' || rawData?.status === 'approved' || rawData?.status === 'locked'\r\n                                    ? 'bg-emerald-50 dark:bg-emerald-900/20 text-emerald-600 dark:text-emerald-400 border-emerald-200 dark:border-emerald-800 hover:bg-emerald-100 dark:hover:bg-emerald-900/40'\r\n                                    : 'bg-white dark:bg-slate-900 hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-700 dark:text-slate-200 border-slate-200 dark:border-slate-700 hover:border-slate-300 dark:hover:border-slate-600'\r\n                                    }`}\r\n                                title={rawData?.is_locked ? \"Ver Cierre (Bloqueado)\" : \"Iniciar Cierre de Mes\"}\r\n                            >\r\n                                {rawData?.is_locked || rawData?.status === 'submitted' || rawData?.status === 'approved' || rawData?.status === 'locked' ? (\r\n                                    <>\r\n                                        <Lock className=\"w-4 h-4 text-emerald-500\" />\r\n                                        <span>Ver Cierre</span>\r\n                                    </>\r\n                                ) : (\r\n                                    <>\r\n                                        <Sparkles className=\"w-4 h-4 text-indigo-500\" />\r\n                                        <span>Cerrar Mes</span>\r\n                                    </>\r\n                                )}\r\n                            </button>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n\r\n                {/* CONTENT AREA */}\r\n                {!isHistoryView ? (\r\n                    <div className=\"space-y-8 animate-in fade-in duration-700 slide-in-from-bottom-4\">\r\n\r\n                        {/* --- PREMIUM PROMO STRIP (Small, Animated, Effective) --- */}\r\n                        <div className=\"mb-2 group relative overflow-hidden rounded-xl bg-white dark:bg-slate-900 border border-indigo-100 dark:border-indigo-900/50 shadow-sm hover:shadow-md transition-all duration-300 cursor-pointer\"\r\n                            onClick={() => window.location.href = '/support'} // Simple redirect\r\n                        >\r\n                            {/* Animated Background Sheen */}\r\n                            <div className=\"absolute inset-0 bg-gradient-to-r from-transparent via-indigo-50/30 dark:via-indigo-500/10 to-transparent -translate-x-full group-hover:animate-[shimmer_1.5s_infinite] z-0\" />\r\n\r\n                            <div className=\"relative z-10 flex items-center justify-between px-4 py-3\">\r\n                                <div className=\"flex items-center gap-3\">\r\n                                    <div className=\"flex -space-x-1\">\r\n                                        <div className=\"w-2 h-2 rounded-full bg-indigo-400 animate-pulse\" />\r\n                                        <div className=\"w-2 h-2 rounded-full bg-purple-400 animate-pulse delay-75\" />\r\n                                        <div className=\"w-2 h-2 rounded-full bg-blue-400 animate-pulse delay-150\" />\r\n                                    </div>\r\n                                    <p className=\"text-sm font-medium text-slate-700 dark:text-slate-300\">\r\n                                        <span className=\"font-bold text-indigo-600 dark:text-indigo-400\">Nuevo Marketplace:</span> Accede a servicios exclusivos para maximizar tu rentabilidad.\r\n                                    </p>\r\n                                </div>\r\n                                <div className=\"flex items-center gap-2 text-xs font-bold text-indigo-600 dark:text-indigo-400 group-hover:translate-x-1 transition-transform\">\r\n                                    Ver Cat√°logo <ChevronRight className=\"w-3.5 h-3.5\" />\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* ROW 1: CORE METRICS & WEALTH */}\r\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6\">\r\n                            {/* 1. Ingresos */}\r\n                            <KPICard\r\n                                title=\"Ingresos\"\r\n                                value={formatMoney(revenue || 0) + '‚Ç¨'}\r\n                                trend={Number(revenueTrend.toFixed(1))}\r\n                                trendData={trendData.map((d: any) => d.revenue)}\r\n                                icon={<TrendingUp />}\r\n                                color=\"blue\"\r\n                                subtext={`${orders} pedidos`}\r\n                                monthlyGoal={16000}\r\n                                lastYearValue={revenue > 0 ? revenue * 0.85 : undefined}\r\n                                showPrediction={true}\r\n                            />\r\n\r\n                            {/* 2. Tu Bolsillo */}\r\n                            <div className=\"h-full\">\r\n                                <TakeHomeProfitWidget\r\n                                    revenue={revenue || 0}\r\n                                    totalExpenses={totalExpenses}\r\n                                    irpfPercent={rawData?.irpfPercent || 20}\r\n                                    trend={trendData.map((d: any) => d.profit || 0)}\r\n                                />\r\n                            </div>\r\n\r\n                            {/* 3. La Hucha */}\r\n                            <div className=\"h-full\">\r\n                                <TaxVaultWidget\r\n                                    taxes={report?.taxes || {\r\n                                        ivaRepercutido: 0,\r\n                                        ivaSoportado: 0,\r\n                                        ivaAPagar: 0,\r\n                                        irpfPago: 0,\r\n                                        totalReserve: 0,\r\n                                        irpfPercent: 20,\r\n                                        netProfitPostTax: 0,\r\n                                        netProfit: 0,\r\n                                        margin: 0,\r\n                                        vat: { toPay: 0 }\r\n                                    }}\r\n                                    minimal\r\n                                />\r\n                            </div>\r\n\r\n                            {/* 4. Coste por Hora */}\r\n                            <div className=\"h-full\">\r\n                                <HourlyCostWidget\r\n                                    totalCost={totalExpenses}\r\n                                    totalHours={totalHours}\r\n                                    trend={0} // Trend calculation logic moved out or simplified\r\n                                    laborCost={Number(rawData?.salaries || 0)}\r\n                                    otherCosts={totalExpenses - Number(rawData?.salaries || 0)}\r\n                                />\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* ROW 2: DETAILED ANALYSIS & TOOLS */}\r\n                        <div className=\"grid grid-cols-1 lg:grid-cols-12 gap-6\">\r\n                            {/* Left Column: Historical Evolution */}\r\n                            <div className=\"lg:col-span-8 h-[300px]\">\r\n                                <RevenueAreaChart data={formattedTrendData} />\r\n                            </div>\r\n\r\n                            {/* Right Column: Breakdown */}\r\n                            <div className=\"lg:col-span-4 flex flex-col gap-6\">\r\n                                <div className=\"h-[350px] w-full\">\r\n                                    <ExpenseBreakdownWidget breakdown={fullExpenseBreakdown} />\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n\r\n                    </div>\r\n                ) : (\r\n                    <FranchiseHistoryView franchiseId={franchiseId || ''} />\r\n                )}\r\n\r\n                {isWizardOpen && (\r\n                    <FinancialControlCenter\r\n                        franchiseId={franchiseId || ''}\r\n                        month={effectiveMonth}\r\n                        onClose={() => setIsWizardOpen(false)}\r\n                        onSave={async (data) => {\r\n                            try {\r\n                                await onUpdateFinance(data);\r\n                                setIsWizardOpen(false);\r\n                            } catch (error) {\r\n                                console.error('Error saving financial data:', error);\r\n                            }\r\n                        }}\r\n                        initialData={rawData}\r\n                    />\r\n                )}\r\n\r\n                <ScenarioSimulator\r\n                    isOpen={isSimulatorOpen}\r\n                    onClose={() => setIsSimulatorOpen(false)}\r\n                    currentData={{\r\n                        ...report,\r\n                        revenue: revenue || (report as any)?.totalIncome || 0,\r\n                        orders: orders || 0,\r\n                        totalExpenses: report?.totalExpenses || 0,\r\n                        // Ensure required props for ScenarioSimulator (it might expect more strict types now)\r\n                        fixed: report?.fixed || { total: 0, salaries: 0, renting: 0, insurance: 0, services: 0, quota: 0, other: 0 },\r\n                        variable: report?.variable || { total: 0, gasoline: 0, repairs: 0, flyderFee: 0, royalty: 0 },\r\n                        netProfit: report?.netProfit || 0,\r\n                        taxes: report?.taxes || { ivaRepercutido: 0, ivaSoportado: 0, ivaAPagar: 0, irpfPago: 0, totalReserve: 0, irpfPercent: 20, netProfitPostTax: 0, netProfit: 0, margin: 0, vat: { toPay: 0 } },\r\n                        metrics: report?.metrics || { avgTicket: 0, costPerOrder: 0, breakEvenOrders: 0, profitMargin: 0, activeRiders: 0, productivity: 0, revenuePerHour: 0, costPerHour: 0, profitPerRider: 0, totalKm: 0, revenuePerKm: 0, costPerKm: 0, dropDensity: 0, safetyMargin: 0, laborRatio: 0, incidentRatio: 0, marketingSpend: 0, incidentCost: 0 },\r\n                        breakdown: report?.breakdown || []\r\n                    }}\r\n                />\r\n\r\n                <DrillDownModal\r\n                    isOpen={!!drillDown}\r\n                    onClose={() => setDrillDown(null)}\r\n                    title={drillDown === 'revenue' ? 'Desglose de Ingresos' : 'Desglose de Gastos'}\r\n                    data={drillDown === 'revenue' ? (\r\n                        Object.entries(rawData || {})\r\n                            .filter(([key, val]) => typeof val === 'number' && key !== 'totalHours' && val > 0)\r\n                            .map(([key, val]) => ({\r\n                                label: key,\r\n                                value: `${val} pedidos`,\r\n                                pct: 0,\r\n                                trend: 'up'\r\n                            }))\r\n                    ) : (\r\n                        fullExpenseBreakdown.map((item: any) => ({\r\n                            label: item.label,\r\n                            value: formatMoney(item.amount) + '‚Ç¨',\r\n                            pct: Math.round((item.amount / (totalExpenses || 1)) * 100),\r\n                            trend: 'down'\r\n                        }))\r\n                    )}\r\n                />\r\n            </div>\r\n\r\n            {/* Widget Legend Modal */}\r\n            <WidgetLegendModal\r\n                isOpen={isLegendOpen}\r\n                onClose={() => setIsLegendOpen(false)}\r\n            />\r\n            {/* Workflow Guide */}\r\n            <FinancialWorkflowGuide\r\n                isOpen={showGuide}\r\n                onClose={() => setShowGuide(false)}\r\n            />\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default FranchiseDashboardView;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\FranchiseRateConfigurator.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\ResourcesPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\SupportHub.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":21,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":21,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1021,1024],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1021,1024],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\r\nimport { useAuth } from '../../context/AuthContext';\r\nimport { useSupportHub } from '../../hooks/useSupportHub';\r\nimport TicketHistory from './support/TicketHistory';\r\nimport NewTicketForm from './support/NewTicketForm';\r\n\r\nimport UserProfileModal from '../user/UserProfileModal'; // Import modal\r\nimport PremiumServicesPanel from './support/PremiumServicesPanel';\r\nimport { Activity, HelpCircle, BadgePercent, Ticket } from 'lucide-react'; // Import icons\r\n\r\nimport { useLocation } from 'react-router-dom';\r\n\r\nconst SupportHub: React.FC = () => {\r\n    const { user } = useAuth(); // Get logout\r\n    const location = useLocation();\r\n    const [isProfileOpen, setIsProfileOpen] = useState(false); // Local state for modal\r\n    const [showInfo, setShowInfo] = useState(false); // Toggle for FAQ info\r\n\r\n    // Default to ticket, but check location state for override\r\n    const [activeTab, setActiveTab] = useState<'ticket' | 'services'>(() => {\r\n        return (location.state as any)?.activeTab === 'services' ? 'services' : 'ticket';\r\n    });\r\n\r\n    // Logic Hook\r\n    const {\r\n        tickets,\r\n        allTicketsCount,\r\n        loading,\r\n        sending,\r\n        success,\r\n        suggestions,\r\n        file,\r\n        uploading,\r\n        ticketFilter,\r\n        setTicketFilter,\r\n        handleSubjectChange,\r\n        createTicket,\r\n        setSuccess,\r\n        setFile,\r\n    } = useSupportHub(user);\r\n\r\n    // Derived counts for UI badges\r\n    const filteredCount = tickets.length;\r\n\r\n\r\n\r\n    return (\r\n        <div className=\"p-6 h-screen max-h-screen bg-slate-50 dark:bg-slate-950 flex flex-col overflow-hidden relative\">\r\n\r\n            {/* Top Bar Actions */}\r\n            <div className=\"flex flex-col sm:flex-row justify-between items-end sm:items-center mb-6 shrink-0 gap-4 sm:gap-0\">\r\n                <div>\r\n                    <h1 className=\"text-3xl font-black text-slate-900 dark:text-white tracking-tighter leading-none mb-1\">Soporte & Ayuda</h1>\r\n                    <p className=\"text-xs text-slate-500 dark:text-slate-400 font-bold uppercase tracking-widest pl-0.5\">Centro de Control de Incidencias</p>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Main Split Layout */}\r\n            <div className=\"flex-1 grid grid-cols-1 lg:grid-cols-12 gap-6 min-h-0\">\r\n\r\n                {/* LEFT PANEL: History (4 cols) */}\r\n                <div className=\"lg:col-span-4 flex flex-col bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden\">\r\n                    {/* Mini-Dashboard Header */}\r\n                    <div className=\"p-5 border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-900/50 backdrop-blur-sm z-10\">\r\n                        <div className=\"flex items-center gap-3 mb-4\">\r\n                            <div className=\"w-10 h-10 bg-indigo-100 dark:bg-indigo-500/20 rounded-xl flex items-center justify-center text-indigo-600 dark:text-indigo-400 shadow-sm\">\r\n                                <Activity className=\"w-5 h-5\" />\r\n                            </div>\r\n                            <div>\r\n                                <h2 className=\"text-sm font-black text-slate-900 dark:text-white uppercase tracking-wider\">Actividad Reciente</h2>\r\n                                <p className=\"text-[10px] text-slate-500 font-bold uppercase tracking-widest\">Resumen de Soporte</p>\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* KPI Grid */}\r\n                        <div className=\"grid grid-cols-2 gap-3\">\r\n                            <div className=\"bg-white dark:bg-slate-800 p-3 rounded-xl border border-slate-100 dark:border-slate-700/50 shadow-sm\">\r\n                                <div className=\"text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1\">Abiertos</div>\r\n                                <div className=\"text-xl font-black text-slate-800 dark:text-white flex items-end gap-1\">\r\n                                    {tickets.filter(t => t.status === 'open' || t.status === 'investigating').length}\r\n                                    <span className=\"text-[10px] text-indigo-500 mb-1 font-bold\">Activos</span>\r\n                                </div>\r\n                            </div>\r\n                            <div className=\"bg-white dark:bg-slate-800 p-3 rounded-xl border border-slate-100 dark:border-slate-700/50 shadow-sm\">\r\n                                <div className=\"text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1\">Total</div>\r\n                                <div className=\"text-xl font-black text-slate-800 dark:text-white flex items-end gap-1\">\r\n                                    {allTicketsCount}\r\n                                    <span className=\"text-[10px] text-slate-400 mb-1 font-bold\">Hist√≥rico</span>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar\">\r\n                        <TicketHistory\r\n                            tickets={tickets}\r\n                            loading={loading}\r\n                            filter={ticketFilter}\r\n                            setFilter={setTicketFilter}\r\n                            allCount={allTicketsCount}\r\n                            filteredCount={filteredCount}\r\n                        />\r\n                    </div>\r\n                </div>\r\n\r\n                {/* RIGHT PANEL: New Ticket Form (8 cols) */}\r\n                <div className=\"lg:col-span-8 flex flex-col overflow-hidden relative rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm bg-white dark:bg-slate-900\">\r\n\r\n                    {/* Quick Actions Header */}\r\n                    <div className=\"absolute top-5 right-6 z-30 flex flex-col items-end gap-2\">\r\n                        <div className=\"flex gap-2\">\r\n                            {/* FAQ / Info Button */}\r\n                            <button\r\n                                onClick={() => setShowInfo(!showInfo)}\r\n                                className={`\r\n                                    flex items-center gap-2 px-3 py-1.5 backdrop-blur-md border rounded-lg text-[10px] font-bold uppercase tracking-wider transition-all shadow-sm\r\n                                    ${showInfo\r\n                                        ? 'bg-indigo-100 dark:bg-indigo-900/40 border-indigo-200 dark:border-indigo-700 text-indigo-700 dark:text-indigo-300'\r\n                                        : 'bg-white/80 dark:bg-slate-800/80 border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800'\r\n                                    }\r\n                                `}\r\n                            >\r\n                                <HelpCircle className=\"w-3.5 h-3.5\" />\r\n                                <span className=\"hidden sm:inline\">FAQ / Normas</span>\r\n                            </button>\r\n                        </div>\r\n\r\n                        {/* Info Card Popover */}\r\n                        {showInfo && (\r\n                            <div className=\"bg-white/95 dark:bg-slate-900/95 backdrop-blur-xl border border-slate-200 dark:border-slate-700 p-4 rounded-xl shadow-xl w-64 animate-in fade-in slide-in-from-top-2 duration-200 text-right sm:text-left\">\r\n                                <h4 className=\"text-xs font-black text-slate-900 dark:text-white uppercase tracking-wider mb-2 border-b border-slate-100 dark:border-slate-800 pb-2\">\r\n                                    Informaci√≥n Importante\r\n                                </h4>\r\n                                <ul className=\"space-y-2\">\r\n                                    <li className=\"flex items-start gap-2 text-[11px] text-slate-600 dark:text-slate-300 font-medium\">\r\n                                        <div className=\"w-1.5 h-1.5 rounded-full bg-emerald-500 mt-1 shrink-0\" />\r\n                                        <span>Horario: Lunes a Viernes de <b>10:00</b> a <b>15:00</b>.</span>\r\n                                    </li>\r\n                                    <li className=\"flex items-start gap-2 text-[11px] text-slate-600 dark:text-slate-300 font-medium\">\r\n                                        <div className=\"w-1.5 h-1.5 rounded-full bg-indigo-500 mt-1 shrink-0\" />\r\n                                        <span>Comunicaci√≥n <b>exclusiva</b> v√≠a Tickets.</span>\r\n                                    </li>\r\n                                    <li className=\"flex items-start gap-2 text-[11px] text-slate-600 dark:text-slate-300 font-medium\">\r\n                                        <div className=\"w-1.5 h-1.5 rounded-full bg-amber-500 mt-1 shrink-0\" />\r\n                                        <span>Tiempo respuesta estimado: <b>&lt; 24h</b>.</span>\r\n                                    </li>\r\n                                </ul>\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n\r\n                    {/* Tab Switcher - Absolute positioned in header */}\r\n                    <div className=\"absolute top-5 left-6 z-30 flex gap-1 bg-slate-100/80 dark:bg-slate-800/80 p-1 rounded-xl backdrop-blur-md border border-slate-200 dark:border-slate-700\">\r\n                        <button\r\n                            onClick={() => setActiveTab('ticket')}\r\n                            className={`\r\n                                    px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase tracking-wider flex items-center gap-2 transition-all\r\n                                    ${activeTab === 'ticket'\r\n                                    ? 'bg-white dark:bg-slate-700 text-indigo-600 dark:text-indigo-400 shadow-sm'\r\n                                    : 'text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-300'\r\n                                }\r\n                                `}\r\n                        >\r\n                            <Ticket className=\"w-3.5 h-3.5\" />\r\n                            <span>Incidencia</span>\r\n                        </button>\r\n                        <button\r\n                            onClick={() => setActiveTab('services')}\r\n                            className={`\r\n                                    px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase tracking-wider flex items-center gap-2 transition-all\r\n                                    ${activeTab === 'services'\r\n                                    ? 'bg-white dark:bg-slate-700 text-purple-600 dark:text-purple-400 shadow-sm'\r\n                                    : 'text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-300'\r\n                                }\r\n                                `}\r\n                        >\r\n                            <BadgePercent className=\"w-3.5 h-3.5\" />\r\n                            <span>Servicios</span>\r\n                        </button>\r\n                    </div>\r\n\r\n\r\n                    {/* Content Area */}\r\n                    <div className=\"flex-1 overflow-hidden mt-16\"> {/* Add top margin to clear absolute headers if needed, or use flex w/ padding */}\r\n                        {activeTab === 'ticket' ? (\r\n                            <NewTicketForm\r\n                                onSubmit={createTicket}\r\n                                onSubjectChange={handleSubjectChange}\r\n                                sending={sending}\r\n                                success={success}\r\n                                setSuccess={(v) => setSuccess(v)}\r\n                                suggestions={suggestions}\r\n                                file={file}\r\n                                setFile={setFile}\r\n                                uploading={uploading}\r\n                            />\r\n                        ) : (\r\n                            <PremiumServicesPanel />\r\n                        )}\r\n                    </div>\r\n                </div>\r\n\r\n            </div>\r\n\r\n            {/* Profile Modal */}\r\n            <UserProfileModal\r\n                isOpen={isProfileOpen}\r\n                onClose={() => setIsProfileOpen(false)}\r\n                user={user}\r\n            />\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default SupportHub;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\components\\AIInsightCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\components\\DocumentRequestModal.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadHistory'. Either include it or remove the dependency array.","line":44,"column":8,"nodeType":"ArrayExpression","endLine":44,"endColumn":38,"suggestions":[{"desc":"Update the dependencies array to be: [activeTab, loadHistory, user?.franchiseId]","fix":{"range":[1360,1390],"text":"[activeTab, loadHistory, user?.franchiseId]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\components\\FinancialWorkflowGuide.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\components\\PrintReport.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\dashboard\\WidgetLegendModal.tsx","messages":[{"ruleId":"no-misleading-character-class","severity":2,"message":"Unexpected combined character in character class.","line":359,"column":77,"nodeType":"Literal","messageId":"combiningClass","endLine":359,"endColumn":79}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\r\nimport { X, HelpCircle, TrendingUp, DollarSign, PiggyBank, Clock, Target, ChevronRight, Info } from 'lucide-react';\r\n\r\ninterface WidgetLegendModalProps {\r\n    isOpen: boolean;\r\n    onClose: () => void;\r\n}\r\n\r\ninterface LegendItem {\r\n    term: string;\r\n    definition: string;\r\n    example?: string;\r\n    delivery?: string;\r\n}\r\n\r\ninterface LegendSection {\r\n    title: string;\r\n    icon: React.ReactNode;\r\n    color: 'indigo' | 'blue' | 'emerald' | 'purple' | 'amber';\r\n    intro: string;\r\n    sections?: { title: string; content: string }[];\r\n    items?: LegendItem[];\r\n    decisions?: string[];\r\n}\r\n\r\nconst WidgetLegendModal: React.FC<WidgetLegendModalProps> = ({ isOpen, onClose }) => {\r\n    const [activeTab, setActiveTab] = useState<'ingresos' | 'bolsillo' | 'hucha' | 'coste' | 'guia' | 'objetivos'>('guia');\r\n\r\n    if (!isOpen) return null;\r\n\r\n    const legendContent: Record<string, LegendSection> = {\r\n        guia: {\r\n            title: 'C√≥mo Leer Tu Dashboard',\r\n            icon: <Info className=\"w-6 h-6\" />,\r\n            color: 'indigo',\r\n            intro: 'Tu dashboard es como el panel de control de tu moto de reparto: te dice todo lo que necesitas saber para tomar buenas decisiones.',\r\n            sections: [\r\n                {\r\n                    title: 'üéØ 1. Empieza por los N√∫meros Grandes',\r\n                    content: 'Los 4 widgets principales (Ingresos, Bolsillo, Hucha, Coste/Hora) son tus indicadores clave. Si alguno est√° en rojo o naranja, presta atenci√≥n ah√≠ primero.'\r\n                },\r\n                {\r\n                    title: 'üìä 2. Compara con el Mes Pasado',\r\n                    content: 'La flecha verde ‚Üë o roja ‚Üì te dice si vas mejor o peor que el mes anterior. No te alarmes por un mes malo: lo importante es la tendencia de varios meses.'\r\n                },\r\n                {\r\n                    title: 'üí° 3. Usa los Objetivos como Gu√≠a',\r\n                    content: 'El panel de \"Objetivos del Mes\" te marca metas realistas. Si est√°s en Bronce o Plata a mitad de mes, puedes recuperar. Si llegas a Oro/Platino, ¬°vas genial!'\r\n                },\r\n                {\r\n                    title: '‚ö†Ô∏è 4. Act√∫a R√°pido en Alertas',\r\n                    content: 'Si ves \"‚ö†Ô∏è Alerta: Ca√≠da significativa\" en Ingresos, significa que has bajado >20%. Revisa: ¬ømenos pedidos? ¬øcompetencia? ¬øclima? ¬øproblemas con riders?'\r\n                },\r\n                {\r\n                    title: 'üìà 5. Proyecciones = Tu Futuro',\r\n                    content: 'Las proyecciones te dicen c√≥mo vas a terminar el mes si sigues as√≠. Si la proyecci√≥n dice \"2.800‚Ç¨\" pero necesitas 3.500‚Ç¨, ajusta ahora: m√°s horas, m√°s marketing, menos gastos.'\r\n                }\r\n            ]\r\n        },\r\n        ingresos: {\r\n            title: 'KPI: Ingresos',\r\n            icon: <TrendingUp className=\"w-6 h-6\" />,\r\n            color: 'blue',\r\n            intro: 'Tus ingresos son el dinero total que entra por pedidos completados. Es tu \"facturaci√≥n bruta\".',\r\n            items: [\r\n                {\r\n                    term: 'Valor Principal',\r\n                    definition: 'Suma de TODOS los pedidos completados y pagados este mes.',\r\n                    example: '3.360‚Ç¨ (280 pedidos √ó 12‚Ç¨ promedio)',\r\n                    delivery: 'üí° Si baja: Menos pedidos (¬øclima malo? ¬øcompetencia?), ticket promedio bajo (¬øfalta de combos?), horarios mal ajustados (¬øriders sin trabajo en prime time?).'\r\n                },\r\n                {\r\n                    term: 'Tendencia %',\r\n                    definition: 'Comparaci√≥n vs mes anterior. Verde = crecimiento, Rojo = descenso.',\r\n                    example: '+12.5% vs mes anterior',\r\n                    delivery: 'üí° Ejemplo delivery: Si febrero sube +15% vs enero, puede ser por San Valent√≠n (m√°s pedidos). Si baja -20%, revisa si perdiste riders clave o hubo problemas t√©cnicos.'\r\n                },\r\n                {\r\n                    term: 'YoY (Year over Year)',\r\n                    definition: 'Comparaci√≥n con el MISMO mes del a√±o pasado. Mide crecimiento real descontando estacionalidad.',\r\n                    example: '+15.2% vs hace 1 a√±o',\r\n                    delivery: 'üí° Si enero 2026 vs enero 2025 es +20%, vas bien. Si es -10%, la competencia te est√° ganando terreno.'\r\n                },\r\n                {\r\n                    term: 'Proyecci√≥n',\r\n                    definition: 'Estimaci√≥n de c√≥mo terminar√°s el mes si sigues a este ritmo.',\r\n                    example: 'Va a terminar en: 3.780‚Ç¨',\r\n                    delivery: 'üí° A d√≠a 15 llevas 1.680‚Ç¨ ‚Üí Proyecci√≥n: 3.360‚Ç¨. Si necesitas 4.000‚Ç¨, debes acelerar: m√°s horario prime, campa√±as, descuentos.'\r\n                },\r\n                {\r\n                    term: 'Objetivo Mensual',\r\n                    definition: 'Meta que definiste. La barra muestra progreso.',\r\n                    example: '85% del objetivo (falta 15%)',\r\n                    delivery: 'üí° Si llegas solo al 70% del objetivo, ajusta expectativas o estrategia para el pr√≥ximo mes.'\r\n                }\r\n            ],\r\n            decisions: [\r\n                '‚úÖ Si sube: Repite lo que funcion√≥ (¬øm√°s riders? ¬ømejor zona? ¬ønuevos men√∫s?).',\r\n                '‚ö†Ô∏è Si baja <10%: Normal, monitorea.',\r\n                '‚ùå Si baja >20%: URGENTE - Revisa competencia, calidad, riders disponibles, tecnolog√≠a.'\r\n            ]\r\n        },\r\n        bolsillo: {\r\n            title: 'Tu Bolsillo (Beneficio Neto)',\r\n            icon: <DollarSign className=\"w-6 h-6\" />,\r\n            color: 'emerald',\r\n            intro: 'Este es el dinero REAL que te llevas a casa despu√©s de pagar TODO (riders, cocina, impuestos, plataformas).',\r\n            items: [\r\n                {\r\n                    term: 'Beneficio Neto',\r\n                    definition: 'Ingresos MENOS todos los gastos e impuestos. Tu sueldo real.',\r\n                    example: '2.730‚Ç¨',\r\n                    delivery: 'üí° Si ganas 3.360‚Ç¨ pero gastas 630‚Ç¨, te quedan 2.730‚Ç¨. Eso es ~2.730‚Ç¨/30d√≠as = 91‚Ç¨/d√≠a netos.'\r\n                },\r\n                {\r\n                    term: 'Sem√°foro de Salud',\r\n                    definition: 'üü¢ Excelente (‚â•20%), üü° Estable (12-20%), üî¥ Peligro (<8%). Es tu \"margen de beneficio\".',\r\n                    example: 'üü¢ Excelente (23.4% margen)',\r\n                    delivery: 'üí° Si est√°s en üî¥ con 7% margen, significa que de cada 100‚Ç¨ que facturas, solo 7‚Ç¨ son tuyos. Urgente: reduce riders ociosos, negocia con proveedores, sube precios.'\r\n                },\r\n                {\r\n                    term: 'Desglose Detallado',\r\n                    definition: 'Click para ver d√≥nde va cada euro: Riders, Cocina, Marketing, Plataformas...',\r\n                    example: 'Ver categor√≠as',\r\n                    delivery: 'üí° Si \"Riders\" es 60% de gastos pero Ingresos no crecen, tienes sobrecapacidad. Si \"Marketing\" es 25%, est√°s gastando mucho en adquisici√≥n.'\r\n                },\r\n                {\r\n                    term: 'Proyecci√≥n Anual',\r\n                    definition: 'Beneficio mensual √ó 12. Tu \"sueldo anual\" si el mes se repite.',\r\n                    example: '32.760‚Ç¨/a√±o (2.730‚Ç¨ √ó 12)',\r\n                    delivery: 'üí° ¬øTe basta con 32k al a√±o? Si no, necesitas crecer Ingresos o cortar Gastos.'\r\n                }\r\n            ],\r\n            decisions: [\r\n                '‚úÖ Margen >20%: Operaci√≥n saludable, puedes reinvertir.',\r\n                '‚ö†Ô∏è Margen 12-20%: Estable pero ajustado, cuidado con gastos extra.',\r\n                '‚ùå Margen <12%: CR√çTICO - Revisa TODOS los gastos, especialmente riders en horas muertas.'\r\n            ]\r\n        },\r\n        hucha: {\r\n            title: 'La Hucha (Reserva Fiscal)',\r\n            icon: <PiggyBank className=\"w-6 h-6\" />,\r\n            color: 'purple',\r\n            intro: 'Dinero que DEBES guardar para Hacienda. NO es tuyo, ¬°no lo toques para gastos!',\r\n            items: [\r\n                {\r\n                    term: 'Reserva Total',\r\n                    definition: 'IVA que cobraste + IRPF que debes. Gu√°rdalo en cuenta separada.',\r\n                    example: '1.200‚Ç¨ (840‚Ç¨ IVA + 360‚Ç¨  IRPF)',\r\n                    delivery: 'üí° Regla delivery: Guarda el 25% de cada ingreso. Si cobras 100‚Ç¨, separa 25‚Ç¨ inmediatamente a la \"cuenta de impuestos\".'\r\n                },\r\n                {\r\n                    term: 'Pr√≥ximo Pago IVA',\r\n                    definition: 'Trimestral: Abril, Julio, Octubre, Enero. D√≠a 20 del mes siguiente.',\r\n                    example: '20 Abr 2026 (45 d√≠as)',\r\n                    delivery: 'üí° Si est√°s a 15 d√≠as del pago y no tienes el dinero guardado, P√ÅNICO. Empieza a juntar YA o pide facilidades a Hacienda.'\r\n                },\r\n                {\r\n                    term: 'Pr√≥ximo Pago IRPF',\r\n                    definition: 'Declaraci√≥n anual en junio. Pagas seg√∫n beneficios del a√±o.',\r\n                    example: '30 Jun 2026',\r\n                    delivery: 'üí° Si tuviste un a√±o muy bueno, el IRPF puede ser sorpresa desagradable. Guarda m√≠nimo 20% de beneficios netos.'\r\n                }\r\n            ],\r\n            decisions: [\r\n                '‚úÖ Reserva ‚â• Pr√≥ximo pago: Tranquilo, tienes cubierto.',\r\n                '‚ö†Ô∏è Reserva < Pr√≥ximo pago: Junta dinero urgente o reduce gastos personales.',\r\n                '‚ùå Reserva casi vac√≠a a 30 d√≠as del pago: Crisis. Habla con gestor fiscal, pide fraccionamiento.'\r\n            ]\r\n        },\r\n        coste: {\r\n            title: 'Coste Operativo por Hora',\r\n            icon: <Clock className=\"w-6 h-6\" />,\r\n            color: 'amber',\r\n            intro: 'Cu√°nto te cuesta cada hora que est√° abierto tu negocio. Si es muy alto, est√°s quemando dinero.',\r\n            items: [\r\n                {\r\n                    term: 'Coste/Hora',\r\n                    definition: 'Gastos totales √∑ Horas abiertas. Mide eficiencia.',\r\n                    example: '22.50‚Ç¨/h',\r\n                    delivery: 'üí° Si abres 10h/d√≠a √ó 30 d√≠as = 300h/mes. Si gastas 6.750‚Ç¨, coste = 22.50‚Ç¨/h. Cada hora que est√°s abierto \"quema\" 22.50‚Ç¨.'\r\n                },\r\n                {\r\n                    term: 'Benchmark Industria',\r\n                    definition: 'Rango normal para delivery/reparto: 15-25‚Ç¨/h. Ideal: ~20‚Ç¨/h.',\r\n                    example: 'Est√°s en 22.50‚Ç¨/h = Normal',\r\n                    delivery: 'üí° Si est√°s en 30‚Ç¨/h, tienes riders de m√°s o alquiler car√≠simo. Si est√°s en 12‚Ç¨/h, puede que pagues mal (¬°problemas futuros!).'\r\n                },\r\n                {\r\n                    term: 'vs Ideal (20‚Ç¨/h)',\r\n                    definition: 'Diferencia contra el benchmark. Positivo = m√°s caro.',\r\n                    example: '+2.50‚Ç¨/h vs ideal',\r\n                    delivery: 'üí° Si est√°s 5‚Ç¨ por encima del ideal, multiplica: 5‚Ç¨ √ó 300h = 1.500‚Ç¨/mes  perdidos en ineficiencia.'\r\n                },\r\n                {\r\n                    term: 'Desglose: Personal vs Otros',\r\n                    definition: 'Cu√°nto va a riders/cocina vs alquiler/marketing/etc.',\r\n                    example: '60% Personal, 40% Otros',\r\n                    delivery: 'üí° Si Personal es 70%, tienes sobrecapacidad de riders. Si Otros es 50%, revisa alquiler, motos, plataformas.'\r\n                }\r\n            ],\r\n            decisions: [\r\n                '‚úÖ 15-20‚Ç¨/h: √ìptimo, sigue as√≠.',\r\n                '‚ö†Ô∏è 20-25‚Ç¨/h: Aceptable pero mejorable. Busca eficiencias peque√±as.',\r\n                '‚ùå >25‚Ç¨/h: URGENTE - Reduce riders en horas muertas, negocia alquiler, cambia de zona.'\r\n            ]\r\n        },\r\n        objetivos: {\r\n            title: 'Objetivos Mensuales',\r\n            icon: <Target className=\"w-6 h-6\" />,\r\n            color: 'indigo',\r\n            intro: 'Sistema de retos gamificado para maximizar el rendimiento operativo de la franquicia.',\r\n            items: [\r\n                {\r\n                    term: 'Nivel de Misi√≥n (XP)',\r\n                    definition: 'Tu rango general (C, B, A, S) basado en el cumplimiento de los 4 retos clave.',\r\n                    example: 'Nivel A (75% completado)',\r\n                    delivery: 'üí° Para subir a Nivel S, necesitas que la barra de \"Progreso Total\" llegue al 100%. Enf√≥cate en el objetivo m√°s bajo.'\r\n                },\r\n                {\r\n                    term: 'Estatus del Reto',\r\n                    definition: 'Muestra qu√© porcentaje de la meta has alcanzado hoy.',\r\n                    example: 'Ventas: ¬°LOGRADO! (102%)',\r\n                    delivery: 'üí° Si un reto dice \"Falta 15%\" a falta de 3 d√≠as para cerrar mes, lanza una promoci√≥n flash para cerrar la brecha.'\r\n                },\r\n                {\r\n                    term: 'Sal√≥n de la Fama',\r\n                    definition: 'Medallas exclusivas por superar expectativas (logros platino).',\r\n                    example: 'Medalla \"Superventas\" (Ventas >110%)',\r\n                    delivery: 'üí° Los logros no son solo visuales: indican que est√°s operando por encima de la media del mercado.'\r\n                }\r\n            ],\r\n            decisions: [\r\n                '‚úÖ Nivel S: Operaci√≥n perfecta. Documenta qu√© hiciste para repetirlo.',\r\n                '‚ö†Ô∏è Nivel B/C: Revisa el widget de \"Coste/Hora\" para ver si la ineficiencia viene de ah√≠.',\r\n                '‚ùå Sin medallas: Est√°s cumpliendo lo m√≠nimo. Considera incentivos para el equipo de cocina y riders.'\r\n            ]\r\n        }\r\n    };\r\n\r\n    const activeContent = legendContent[activeTab];\r\n    const colorMap: Record<'indigo' | 'blue' | 'emerald' | 'purple' | 'amber', { bg: string, text: string, border: string }> = {\r\n        indigo: { bg: 'bg-indigo-50 dark:bg-indigo-950/20', text: 'text-indigo-600 dark:text-indigo-400', border: 'border-indigo-200 dark:border-indigo-900' },\r\n        blue: { bg: 'bg-blue-50 dark:bg-blue-950/20', text: 'text-blue-600 dark:text-blue-400', border: 'border-blue-200 dark:border-blue-900' },\r\n        emerald: { bg: 'bg-emerald-50 dark:bg-emerald-950/20', text: 'text-emerald-600 dark:text-emerald-400', border: 'border-emerald-200 dark:border-emerald-900' },\r\n        purple: { bg: 'bg-purple-50 dark:bg-purple-950/20', text: 'text-purple-600 dark:text-purple-400', border: 'border-purple-200 dark:border-purple-900' },\r\n        amber: { bg: 'bg-amber-50 dark:bg-amber-950/20', text: 'text-amber-600 dark:text-amber-400', border: 'border-amber-200 dark:border-amber-900' }\r\n    };\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4\">\r\n            <div className=\"bg-white dark:bg-slate-900 rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden border border-slate-200 dark:border-slate-800\">\r\n                {/* Header */}\r\n                <div className=\"flex items-center justify-between p-6 border-b border-slate-200 dark:border-slate-800\">\r\n                    <div className=\"flex items-center gap-3\">\r\n                        <div className=\"w-12 h-12 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center\">\r\n                            <HelpCircle className=\"w-6 h-6 text-white\" />\r\n                        </div>\r\n                        <div>\r\n                            <h2 className=\"text-2xl font-black text-slate-900 dark:text-white\">Gu√≠a del Dashboard</h2>\r\n                            <p className=\"text-sm text-slate-500\">Aprende a tomar decisiones con tus datos</p>\r\n                        </div>\r\n                    </div>\r\n                    <button\r\n                        onClick={onClose}\r\n                        title=\"Cerrar Gu√≠a\"\r\n                        aria-label=\"Cerrar Gu√≠a\"\r\n                        className=\"w-10 h-10 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 flex items-center justify-center transition-colors\"\r\n                    >\r\n                        <X className=\"w-5 h-5 text-slate-400\" />\r\n                    </button>\r\n                </div>\r\n\r\n                {/* Tabs */}\r\n                <div className=\"flex border-b border-slate-200 dark:border-slate-800 px-6 gap-2 overflow-x-auto\">\r\n                    {(['guia', 'ingresos', 'bolsillo', 'hucha', 'coste', 'objetivos'] as const).map((tab) => (\r\n                        <button\r\n                            key={tab}\r\n                            onClick={() => setActiveTab(tab)}\r\n                            className={`px-4 py-3 text-sm font-bold transition-all whitespace-nowrap ${activeTab === tab\r\n                                ? 'border-b-2 border-indigo-600 text-indigo-600 dark:text-indigo-400'\r\n                                : 'text-slate-500 hover:text-slate-700 dark:hover:text-slate-300'\r\n                                }`}\r\n                        >\r\n                            {legendContent[tab].title}\r\n                        </button>\r\n                    ))}\r\n                </div>\r\n\r\n                {/* Content */}\r\n                <div className=\"p-6 overflow-y-auto max-h-[calc(90vh-200px)]\">\r\n                    {/* Title */}\r\n                    <div className={`flex items-center gap-3 mb-6 p-4 rounded-xl border-2 ${colorMap[activeContent.color].border} ${colorMap[activeContent.color].bg}`}>\r\n                        <div className={`${colorMap[activeContent.color].text}`}>\r\n                            {activeContent.icon}\r\n                        </div>\r\n                        <div className=\"flex-1\">\r\n                            <h3 className=\"text-xl font-black text-slate-900 dark:text-white\">{activeContent.title}</h3>\r\n                            <p className=\"text-sm text-slate-600 dark:text-slate-400 mt-1\">{activeContent.intro}</p>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Gu√≠a o Terms */}\r\n                    {activeTab === 'guia' && activeContent.sections ? (\r\n                        <div className=\"space-y-4\">\r\n                            {activeContent.sections.map((section, idx) => (\r\n                                <div key={idx} className=\"p-4 rounded-xl bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700\">\r\n                                    <h4 className=\"text-sm font-bold text-slate-900 dark:text-white mb-2\">{section.title}</h4>\r\n                                    <p className=\"text-xs text-slate-600 dark:text-slate-400 leading-relaxed\">{section.content}</p>\r\n                                </div>\r\n                            ))}\r\n                        </div>\r\n                    ) : (\r\n                        <>\r\n                            {/* Terms */}\r\n                            <div className=\"space-y-4 mb-6\">\r\n                                {activeContent.items?.map((item, idx) => (\r\n                                    <div key={idx} className=\"p-4 rounded-xl bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700\">\r\n                                        <div className=\"flex items-start gap-3\">\r\n                                            <div className=\"mt-1\">\r\n                                                <ChevronRight className=\"w-4 h-4 text-indigo-500\" />\r\n                                            </div>\r\n                                            <div className=\"flex-1\">\r\n                                                <h4 className=\"text-sm font-bold text-slate-900 dark:text-white mb-1\">{item.term}</h4>\r\n                                                <p className=\"text-xs text-slate-600 dark:text-slate-400 leading-relaxed mb-2\">\r\n                                                    {item.definition}\r\n                                                </p>\r\n                                                {item.example && (\r\n                                                    <div className=\"px-3 py-1.5 rounded-lg bg-blue-50 dark:bg-blue-950/30 border border-blue-200 dark:border-blue-800 mb-2\">\r\n                                                        <span className=\"text-xs font-mono font-bold text-blue-700 dark:text-blue-300\">\r\n                                                            üìä {item.example}\r\n                                                        </span>\r\n                                                    </div>\r\n                                                )}\r\n                                                {item.delivery && (\r\n                                                    <div className=\"px-3 py-2 rounded-lg bg-green-50 dark:bg-green-950/30 border border-green-200 dark:border-green-800\">\r\n                                                        <p className=\"text-xs text-green-800 dark:text-green-200 leading-relaxed\">\r\n                                                            {item.delivery}\r\n                                                        </p>\r\n                                                    </div>\r\n                                                )}\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n\r\n                            {/* Decisions */}\r\n                            {activeContent.decisions && (\r\n                                <div className=\"p-5 rounded-xl bg-gradient-to-r from-indigo-50 to-purple-50 dark:from-indigo-950/20 dark:to-purple-950/20 border border-indigo-200 dark:border-indigo-800\">\r\n                                    <h4 className=\"text-sm font-bold text-indigo-900 dark:text-indigo-300 mb-3 flex items-center gap-2\">\r\n                                        <Target className=\"w-4 h-4\" />\r\n                                        Decisiones a Tomar\r\n                                    </h4>\r\n                                    <ul className=\"space-y-2\">\r\n                                        {activeContent.decisions.map((decision, idx) => (\r\n                                            <li key={idx} className=\"text-xs text-indigo-800 dark:text-indigo-200 leading-relaxed flex items-start gap-2\">\r\n                                                <span className=\"mt-0.5\">{decision.startsWith('‚úÖ') ? '‚úÖ' : decision.startsWith('‚ö†Ô∏è') ? '‚ö†Ô∏è' : decision.startsWith('‚ùå') ? '‚ùå' : 'üéØ'}</span>\r\n                                                <span>{decision.replace(/^[‚úÖ‚ö†Ô∏è‚ùå]\\s*/, '')}</span>\r\n                                            </li>\r\n                                        ))}\r\n                                    </ul>\r\n                                </div>\r\n                            )}\r\n                        </>\r\n                    )}\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default WidgetLegendModal;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\dashboard\\widgets\\AlertsWidget.d.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":3,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":3,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[75,78],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[75,78],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\n\r\ndeclare const Component: React.ComponentType<any>;\r\nexport default Component;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\dashboard\\widgets\\AlertsWidget.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\dashboard\\widgets\\CashBalanceHero.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\dashboard\\widgets\\CoverageStats.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\dashboard\\widgets\\DashboardCharts.d.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":3,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":3,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[75,78],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[75,78],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\n\r\ndeclare const Component: React.ComponentType<any>;\r\nexport default Component;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\dashboard\\widgets\\DashboardCharts.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\dashboard\\widgets\\ExpenseBreakdownWidget.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":19,"column":60,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":19,"endColumn":63,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[638,641],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[638,641],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\r\nimport { PieChart, Pie, Cell, ResponsiveContainer, Tooltip } from 'recharts';\r\nimport { List, PieChart as PieChartIcon } from 'lucide-react';\r\nimport { formatMoney } from '../../../../lib/finance';\r\nimport { Card } from '../../../../ui/primitives/Card';\r\nimport { SectionHeader } from '../../../../ui/primitives/SectionHeader';\r\n\r\ninterface ExpenseCategory {\r\n    label: string;\r\n    amount: number;\r\n    color?: string;\r\n}\r\n\r\ninterface ExpenseBreakdownWidgetProps {\r\n    breakdown: ExpenseCategory[];\r\n}\r\n\r\n// Custom tooltip for donut\r\nconst CustomTooltip = ({ active, payload, totalExpenses }: any) => {\r\n    if (active && payload && payload.length) {\r\n        const data = payload[0];\r\n        const percent = totalExpenses > 0 ? (data.value / totalExpenses) * 100 : 0;\r\n        return (\r\n            <div className=\"bg-white border border-slate-200 rounded-xl p-3 shadow-lg\">\r\n                <p className=\"text-xs font-bold text-slate-800 mb-1\">{data.name}</p>\r\n                <p className=\"text-sm font-black text-indigo-600 tabular-nums\">\r\n                    {formatMoney(data.value)}‚Ç¨\r\n                </p>\r\n                <p className=\"text-[10px] text-slate-500 mt-0.5\">\r\n                    {percent.toFixed(1)}% del total\r\n                </p>\r\n            </div>\r\n        );\r\n    }\r\n    return null;\r\n};\r\n\r\nconst ExpenseBreakdownWidget: React.FC<ExpenseBreakdownWidgetProps> = ({ breakdown }) => {\r\n    const [viewMode, setViewMode] = useState<'list' | 'chart'>('list');\r\n\r\n    // 1. Sort by amount descending\r\n    const sortedData = [...breakdown].sort((a, b) => b.amount - a.amount);\r\n\r\n    // 2. Calculate total for percentage bars\r\n    const totalExpenses = sortedData.reduce((sum, item) => sum + item.amount, 0);\r\n\r\n    // Modern Finance Color Palette - Repeating if necessary\r\n    const COLORS = ['#6366f1', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#3b82f6', '#ef4444', '#14b8a6', '#f97316'];\r\n\r\n    // Prepare data for donut chart\r\n    const chartData = sortedData.map((item, index) => ({\r\n        name: item.label,\r\n        value: item.amount,\r\n        color: item.color || COLORS[index % COLORS.length]\r\n    }));\r\n\r\n\r\n\r\n    return (\r\n        <Card className=\"h-full flex flex-col overflow-hidden\">\r\n            {/* Header with Toggle */}\r\n            <SectionHeader\r\n                title=\"Desglose de Gastos\"\r\n                subtitle={viewMode === 'list' ? `${sortedData.length} categor√≠as` : 'Visualizaci√≥n gr√°fica'}\r\n                action={\r\n                    <div className=\"bg-slate-100 dark:bg-slate-800 rounded-xl p-1 flex gap-1 border border-slate-200 dark:border-slate-700\">\r\n                        <button\r\n                            onClick={() => setViewMode('list')}\r\n                            className={`p-1.5 rounded-lg transition-all ${viewMode === 'list'\r\n                                ? 'bg-indigo-600 text-white shadow-sm'\r\n                                : 'text-slate-400 hover:text-slate-600 dark:hover:text-slate-300'\r\n                                }`}\r\n                            title=\"Lista\"\r\n                        >\r\n                            <List className=\"w-3.5 h-3.5\" />\r\n                        </button>\r\n                        <button\r\n                            onClick={() => setViewMode('chart')}\r\n                            className={`p-1.5 rounded-lg transition-all ${viewMode === 'chart'\r\n                                ? 'bg-indigo-600 text-white shadow-sm'\r\n                                : 'text-slate-400 hover:text-slate-600 dark:hover:text-slate-300'\r\n                                }`}\r\n                            title=\"Gr√°fico\"\r\n                        >\r\n                            <PieChartIcon className=\"w-3.5 h-3.5\" />\r\n                        </button>\r\n                    </div>\r\n                }\r\n            />\r\n\r\n            {/* Content Area */}\r\n            <div className=\"flex-1 overflow-hidden\">\r\n                {viewMode === 'list' ? (\r\n                    /* COMPACT LIST VIEW - ALL EXPENSES */\r\n                    <div className=\"h-full overflow-auto custom-scrollbar pr-2 space-y-1.5\">\r\n                        {sortedData.map((item, index) => {\r\n                            const percent = totalExpenses > 0 ? (item.amount / totalExpenses) * 100 : 0;\r\n                            const color = item.color || COLORS[index % COLORS.length];\r\n\r\n                            return (\r\n                                <div\r\n                                    key={index}\r\n                                    className=\"group flex items-center justify-between py-2 px-3 hover:bg-slate-50 dark:hover:bg-slate-800/50 rounded-lg transition-colors\"\r\n                                >\r\n                                    {/* Left: Color Dot + Label */}\r\n                                    <div className=\"flex items-center gap-2 flex-1 min-w-0\">\r\n                                        <div\r\n                                            className=\"w-2.5 h-2.5 rounded-full flex-shrink-0\"\r\n                                             \r\n                                            style={{ backgroundColor: color }}\r\n                                        />\r\n                                        <span className=\"text-xs font-medium text-slate-700 dark:text-slate-300 truncate\">\r\n                                            {item.label}\r\n                                        </span>\r\n                                    </div>\r\n\r\n                                    {/* Right: Amount + % + Mini Bar */}\r\n                                    <div className=\"flex items-center gap-3 flex-shrink-0\">\r\n                                        <span className=\"text-sm font-bold text-slate-900 dark:text-white tabular-nums min-w-[70px] text-right\">\r\n                                            {formatMoney(item.amount)}‚Ç¨\r\n                                        </span>\r\n                                        <span className=\"text-[10px] text-slate-400 w-10 text-right tabular-nums font-bold\">\r\n                                            {percent.toFixed(1)}%\r\n                                        </span>\r\n                                        {/* Mini Progress Bar */}\r\n                                        <div className=\"w-16 h-1 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden\">\r\n                                            <div\r\n                                                className=\"h-full rounded-full\"\r\n                                                 \r\n                                                style={{\r\n                                                    width: `${Math.max(percent, 2)}%`,\r\n                                                    backgroundColor: color\r\n                                                }}\r\n                                            />\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n                            );\r\n                        })}\r\n\r\n                        {/* Total Box - Compact */}\r\n                        <div className=\"bg-gradient-to-br from-indigo-50 to-purple-50 dark:from-indigo-950/20 dark:to-purple-900/20 border border-indigo-100 dark:border-indigo-900 rounded-xl p-3 mt-3 sticky bottom-0\">\r\n                            <div className=\"flex items-center justify-between\">\r\n                                <span className=\"text-xs text-indigo-600 dark:text-indigo-400 font-bold uppercase tracking-wide\">\r\n                                    Total\r\n                                </span>\r\n                                <span className=\"text-xl font-black text-indigo-900 dark:text-indigo-100 tabular-nums\">\r\n                                    {formatMoney(totalExpenses)}‚Ç¨\r\n                                </span>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                ) : (\r\n                    /* DONUT CHART VIEW */\r\n                    <div className=\"h-full flex flex-col\">\r\n                        {/* Donut Chart */}\r\n                        <div className=\"w-full h-[180px] flex-shrink-0\">\r\n                            <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n                                <PieChart>\r\n                                    <Pie\r\n                                        data={chartData}\r\n                                        cx=\"50%\"\r\n                                        cy=\"50%\"\r\n                                        innerRadius={45}\r\n                                        outerRadius={70}\r\n                                        paddingAngle={2}\r\n                                        dataKey=\"value\"\r\n                                    >\r\n                                        {chartData.map((entry, index) => (\r\n                                            <Cell key={`cell-${index}`} fill={entry.color} />\r\n                                        ))}\r\n                                    </Pie>\r\n                                    <Tooltip content={<CustomTooltip totalExpenses={totalExpenses} />} />\r\n                                </PieChart>\r\n                            </ResponsiveContainer>\r\n                        </div>\r\n\r\n                        {/* Center Total */}\r\n                        <div className=\"text-center py-3 flex-shrink-0 border-b border-slate-100 dark:border-slate-800\">\r\n                            <p className=\"text-[10px] text-slate-500 font-medium uppercase tracking-wide\">Total Gastos</p>\r\n                            <p className=\"text-xl font-black text-slate-900 dark:text-white tabular-nums mt-0.5\">\r\n                                {formatMoney(totalExpenses)}‚Ç¨\r\n                            </p>\r\n                        </div>\r\n\r\n                        {/* Legend - Compact & Scrollable */}\r\n                        <div className=\"flex-1 overflow-auto custom-scrollbar mt-3 space-y-1 px-1\">\r\n                            {chartData.map((item, index) => {\r\n                                const percent = (item.value / totalExpenses) * 100;\r\n                                return (\r\n                                    <div key={index} className=\"flex items-center justify-between py-1.5 px-2 hover:bg-slate-50 dark:hover:bg-slate-800/30 rounded transition-colors text-xs\">\r\n                                        <div className=\"flex items-center gap-2 flex-1 min-w-0\">\r\n                                            <div\r\n                                                className=\"w-2.5 h-2.5 rounded-full flex-shrink-0\"\r\n                                                 \r\n                                                style={{ backgroundColor: item.color }}\r\n                                            />\r\n                                            <span className=\"font-medium text-slate-600 dark:text-slate-400 truncate\">\r\n                                                {item.name}\r\n                                            </span>\r\n                                        </div>\r\n                                        <div className=\"flex items-baseline gap-2 flex-shrink-0\">\r\n                                            <span className=\"font-bold text-slate-800 dark:text-slate-200 tabular-nums\">\r\n                                                {formatMoney(item.value)}‚Ç¨\r\n                                            </span>\r\n                                            <span className=\"text-[10px] text-slate-400 w-10 text-right tabular-nums\">\r\n                                                {percent.toFixed(1)}%\r\n                                            </span>\r\n                                        </div>\r\n                                    </div>\r\n                                );\r\n                            })}\r\n                        </div>\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </Card>\r\n    );\r\n};\r\n\r\nexport default ExpenseBreakdownWidget;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\dashboard\\widgets\\ExpenseStack.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\dashboard\\widgets\\FinancialAdvisorWidget.d.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":3,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":3,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[75,78],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[75,78],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\n\r\ndeclare const Component: React.ComponentType<any>;\r\nexport default Component;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\dashboard\\widgets\\FinancialAdvisorWidget.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\dashboard\\widgets\\FleetCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\dashboard\\widgets\\FlipCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\dashboard\\widgets\\ForecastingWidget.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\dashboard\\widgets\\FranchiseScorecard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\dashboard\\widgets\\GamificationWidget.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\dashboard\\widgets\\HourlyCostWidget.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\dashboard\\widgets\\KPICard.d.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":3,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":3,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[75,78],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[75,78],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\n\r\ndeclare const Component: React.ComponentType<any>;\r\nexport default Component;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\dashboard\\widgets\\KPICard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\dashboard\\widgets\\MonthlyTaxWidget.d.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":3,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":3,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[75,78],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[75,78],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\n\r\ndeclare const Component: React.ComponentType<any>;\r\nexport default Component;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\dashboard\\widgets\\MonthlyTaxWidget.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\dashboard\\widgets\\MonthlyTrendChart.d.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":3,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":3,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[75,78],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[75,78],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\n\r\ndeclare const Component: React.ComponentType<any>;\r\nexport default Component;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\dashboard\\widgets\\MonthlyTrendChart.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\dashboard\\widgets\\NewsFeedWidget.d.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":3,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":3,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[75,78],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[75,78],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\n\r\ndeclare const Component: React.ComponentType<any>;\r\nexport default Component;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\dashboard\\widgets\\NewsFeedWidget.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\dashboard\\widgets\\RevenueAreaChart.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\dashboard\\widgets\\SimulatorWidgetAdvanced.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\dashboard\\widgets\\TakeHomeProfitWidget.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\dashboard\\widgets\\TaxVaultWidget.d.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":3,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":3,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[75,78],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[75,78],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\n\r\ndeclare const Component: React.ComponentType<any>;\r\nexport default Component;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\dashboard\\widgets\\TaxVaultWidget.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\finance\\BreakEvenWidget.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":4,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":4,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[182,185],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[182,185],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":9,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":9,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[429,432],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[429,432],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { AreaChart, Area, XAxis, YAxis, Tooltip, ResponsiveContainer } from 'recharts';\r\nimport { Info } from 'lucide-react';\r\n\r\nconst BreakEvenWidget = ({ trendData }: { trendData: any[] }) => {\r\n    // 1. Process Data for the Formula\r\n    // BEP (Orders/Hour) = (Total Expenses / (Revenue / Orders)) / Total Hours\r\n    // Simplified: BEP = Total Expenses / (Avg Ticket * Total Hours)\r\n\r\n    const chartData = trendData.map((d: any) => {\r\n        const avgTicket = d.orders > 0 ? d.revenue / d.orders : 0;\r\n        const totalExpenses = d.expenses || 0;\r\n        const totalHours = d.totalHours || 0;\r\n\r\n        // Calculate Break Even Orders (Volume needed to cover expenses)\r\n        const breakEvenOrders = avgTicket > 0 ? totalExpenses / avgTicket : 0;\r\n\r\n        // Calculate Break Even Productivity (Orders/Hour needed)\r\n        // Guard against division by zero\r\n        const breakEvenProductivity = totalHours > 0 ? breakEvenOrders / totalHours : 0;\r\n\r\n        // Actual Productivity\r\n        const actualProductivity = totalHours > 0 ? d.orders / totalHours : 0;\r\n\r\n        return {\r\n            name: d.name,\r\n            fullDate: d.fullDate,\r\n            actual: Number(actualProductivity.toFixed(2)),\r\n            required: Number(breakEvenProductivity.toFixed(2)),\r\n            // Metadata for tooltip\r\n            expenses: totalExpenses,\r\n            avgTicket: Number(avgTicket.toFixed(2)),\r\n            hours: totalHours\r\n        };\r\n    }).reverse(); // Show oldest to newest? No, trendData is usually usually newest to oldest?\r\n    // trendData in useFranchiseFinance comes from financeService, which builds it back-to-front (monthsBack to 0).\r\n    // Let's verify sort. The loop goes i=monthsBack down to 0. So it is Oldest -> Newest. Correct.\r\n\r\n    const currentMonth = chartData[chartData.length - 1] || {};\r\n    const isProfitable = (currentMonth.actual || 0) >= (currentMonth.required || 0);\r\n\r\n    return (\r\n        <div className=\"bg-slate-900 rounded-2xl p-6 h-full flex flex-col border border-slate-800/50\">\r\n            <div className=\"flex justify-between items-start mb-6\">\r\n                <div>\r\n                    <h3 className=\"text-sm font-bold text-white uppercase tracking-wider flex items-center gap-2\">\r\n                        Punto Muerto TOTAL (Cubre Todo)\r\n                        <div className=\"group relative\">\r\n                            <Info className=\"w-3.5 h-3.5 text-slate-500 cursor-help\" />\r\n                            <div className=\"absolute left-0 bottom-full mb-2 w-64 p-3 bg-slate-800 rounded-xl border border-slate-700 shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-20 pointer-events-none\">\r\n                                <p className=\"text-[10px] text-slate-300 leading-relaxed\">\r\n                                    <strong>F√≥rmula Definitiva:</strong> Pedidos/Hora necesarios para pagar N√ìMINAS, ALQUILER, LUZ y TODOS los gastos.\r\n                                </p>\r\n                            </div>\r\n                        </div>\r\n                    </h3>\r\n                    <p className=\"text-xs text-slate-500 mt-1\">Tu carrera hacia la rentabilidad real.</p>\r\n                </div>\r\n                <div className={`px-3 py-1 rounded-full text-xs font-bold border ${isProfitable\r\n                    ? 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20'\r\n                    : 'bg-rose-500/10 text-rose-400 border-rose-500/20'\r\n                    }`}>\r\n                    {isProfitable ? 'RENTABLE' : 'D√âFICIT'}\r\n                </div>\r\n            </div>\r\n\r\n            <div className=\"flex-1 min-h-[200px] w-full\">\r\n                <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n                    <AreaChart data={chartData} margin={{ top: 10, right: 10, left: -20, bottom: 0 }}>\r\n                        <defs>\r\n                            <linearGradient id=\"colorActual\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\r\n                                <stop offset=\"5%\" stopColor=\"#6366f1\" stopOpacity={0.3} />\r\n                                <stop offset=\"95%\" stopColor=\"#6366f1\" stopOpacity={0} />\r\n                            </linearGradient>\r\n                            <linearGradient id=\"colorRequired\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\r\n                                <stop offset=\"5%\" stopColor=\"#f43f5e\" stopOpacity={0.3} />\r\n                                <stop offset=\"95%\" stopColor=\"#f43f5e\" stopOpacity={0} />\r\n                            </linearGradient>\r\n                        </defs>\r\n                        <XAxis\r\n                            dataKey=\"name\"\r\n                            stroke=\"#475569\"\r\n                            fontSize={10}\r\n                            tickLine={false}\r\n                            axisLine={false}\r\n                        />\r\n                        <YAxis\r\n                            stroke=\"#475569\"\r\n                            fontSize={10}\r\n                            tickLine={false}\r\n                            axisLine={false}\r\n                            tickFormatter={(value) => `${value}`}\r\n                        />\r\n                        <Tooltip\r\n                            contentStyle={{ backgroundColor: '#0f172a', borderColor: '#1e293b', borderRadius: '12px', fontSize: '12px' }}\r\n                            itemStyle={{ padding: 0 }}\r\n                            formatter={(value, name) => [\r\n                                `${value} peds/h`,\r\n                                name === 'actual' ? 'Eficiencia Real' : 'Necesario (B.E.P)'\r\n                            ]}\r\n                            labelStyle={{ color: '#94a3b8', marginBottom: '8px' }}\r\n                        />\r\n                        <Area\r\n                            type=\"monotone\"\r\n                            dataKey=\"required\"\r\n                            stroke=\"#f43f5e\"\r\n                            strokeWidth={2}\r\n                            strokeDasharray=\"5 5\"\r\n                            fillOpacity={1}\r\n                            fill=\"url(#colorRequired)\"\r\n                            name=\"required\"\r\n                        />\r\n                        <Area\r\n                            type=\"monotone\"\r\n                            dataKey=\"actual\"\r\n                            stroke=\"#6366f1\"\r\n                            strokeWidth={3}\r\n                            fillOpacity={1}\r\n                            fill=\"url(#colorActual)\"\r\n                            name=\"actual\"\r\n                            activeDot={{ r: 6, strokeWidth: 0 }}\r\n                        />\r\n                    </AreaChart>\r\n                </ResponsiveContainer>\r\n            </div>\r\n\r\n            <div className=\"mt-4 grid grid-cols-2 gap-4 border-t border-slate-800 pt-4\">\r\n                <div>\r\n                    <p className=\"text-[10px] text-slate-500 uppercase font-bold tracking-wider mb-0.5\">Ticket Medio</p>\r\n                    <p className=\"text-lg font-mono font-bold text-slate-300\">\r\n                        {currentMonth.avgTicket ? currentMonth.avgTicket.toFixed(2) : '0.00'}‚Ç¨\r\n                    </p>\r\n                </div>\r\n                <div className=\"text-right\">\r\n                    <p className=\"text-[10px] text-slate-500 uppercase font-bold tracking-wider mb-0.5\">Margen Seguridad</p>\r\n                    <p className={`text-lg font-mono font-bold ${(currentMonth.actual - currentMonth.required) > 0 ? 'text-emerald-400' : 'text-rose-400'\r\n                        }`}>\r\n                        {((currentMonth.actual - currentMonth.required) || 0).toFixed(2)} peds/h\r\n                    </p>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default BreakEvenWidget;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\finance\\FranchiseHistoryView.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":13,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":13,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[569,572],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[569,572],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":19,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":19,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[931,934],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[931,934],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\nimport { useFranchiseHistory } from '../../../hooks/useFranchiseHistory';\r\nimport MonthlyHistoryTable from './MonthlyHistoryTable';\r\nimport { ResponsiveContainer, CartesianGrid, XAxis, YAxis, Tooltip, Area, Bar, ComposedChart } from 'recharts';\r\nimport { formatMoney } from '../../../lib/finance';\r\nimport { Activity, TrendingUp, DollarSign } from 'lucide-react';\r\nimport KPICard from '../dashboard/widgets/KPICard';\r\n\r\ninterface FranchiseHistoryViewProps {\r\n    franchiseId: string;\r\n}\r\n\r\nconst CustomTooltip = ({ active, payload, label }: any) => {\r\n    if (active && payload && payload.length) {\r\n        return (\r\n            <div className=\"bg-white border border-slate-200 p-4 rounded-xl shadow-xl z-50\">\r\n                <p className=\"text-slate-800 font-bold mb-3 border-b border-slate-100 pb-2\">{label}</p>\r\n                <div className=\"space-y-2\">\r\n                    {payload.map((entry: any, index: number) => (\r\n                        <div key={index} className=\"flex items-center gap-3 text-xs\">\r\n                            <div className=\"w-2 h-2 rounded-full\" style={{ backgroundColor: entry.color }} />\r\n                            <span className=\"text-slate-500 w-20\">{entry.name}:</span>\r\n                            <span className=\"text-slate-900 font-mono font-bold\">\r\n                                {formatMoney(entry.value)}‚Ç¨\r\n                            </span>\r\n                        </div>\r\n                    ))}\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n    return null;\r\n};\r\n\r\nconst FranchiseHistoryView: React.FC<FranchiseHistoryViewProps> = ({ franchiseId }) => {\r\n    const { records, loading, error } = useFranchiseHistory(franchiseId);\r\n\r\n    if (loading) return (\r\n        <div className=\"p-24 text-center flex flex-col items-center gap-6 animate-in fade-in duration-700\">\r\n            <div className=\"w-16 h-16 border-4 border-indigo-500/10 border-t-indigo-500 rounded-full animate-spin\"></div>\r\n            <p className=\"text-slate-400 font-medium tracking-tight\">Analizando hist√≥rico...</p>\r\n        </div>\r\n    );\r\n\r\n    if (error) return <div className=\"p-12 text-center text-rose-500 bg-rose-50 rounded-2xl border border-rose-100\">Error: {error}</div>;\r\n\r\n    // Sort oldest to newest for the chart\r\n    const sortedRecords = [...records].sort((a, b) => a.month.localeCompare(b.month));\r\n\r\n    // If no records, just show table (which handles empty state)\r\n    if (!records || records.length === 0) return <MonthlyHistoryTable franchiseId={franchiseId} />;\r\n\r\n    // --- AGGREGATE STATS ---\r\n    const totalRev = records.reduce((acc, r) => acc + r.revenue, 0);\r\n    const totalProfit = records.reduce((acc, r) => acc + r.profit, 0);\r\n    const avgMargin = totalRev > 0 ? (totalProfit / totalRev) * 100 : 0;\r\n\r\n    // Trend Analysis (Simple: compare last month vs avg)\r\n    const lastRecord = sortedRecords[sortedRecords.length - 1];\r\n    const isTrendingUp = lastRecord && ((lastRecord.profit / lastRecord.revenue) * 100) > avgMargin;\r\n\r\n    return (\r\n        <div className=\"space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-1000 ease-out\">\r\n\r\n            {/* COMPACT SUMMARY CARDS */}\r\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n                <KPICard\r\n                    title=\"Facturaci√≥n Hist√≥rica\"\r\n                    value={formatMoney(totalRev) + '‚Ç¨'}\r\n                    trend={isTrendingUp ? 5.2 : -2.1} // Simple trend indicator based on last month\r\n                    trendData={sortedRecords.map(r => r.revenue)}\r\n                    icon={<Activity />}\r\n                    color=\"blue\"\r\n                    subtext=\"Acumulado Total\"\r\n                />\r\n\r\n                <KPICard\r\n                    title=\"Beneficio Acumulado\"\r\n                    value={formatMoney(totalProfit) + '‚Ç¨'}\r\n                    trend={isTrendingUp ? 8.4 : -1.5}\r\n                    trendData={sortedRecords.map(r => r.profit)}\r\n                    icon={<DollarSign />}\r\n                    color=\"emerald\"\r\n                    subtext={`${avgMargin.toFixed(1)}% Margen Medio`}\r\n                />\r\n\r\n                <KPICard\r\n                    title=\"Promedio Mensual\"\r\n                    value={formatMoney(totalRev / (records.length || 1)) + '‚Ç¨'}\r\n                    trend={0}\r\n                    trendData={sortedRecords.map(r => r.revenue)} // Just to show activity\r\n                    icon={<TrendingUp />}\r\n                    color=\"purple\"\r\n                    subtext=\"Ingreso Medio\"\r\n                />\r\n            </div>\r\n\r\n            {/* MAIN CHART */}\r\n            <div className=\"bg-white border border-slate-100 rounded-xl p-4 shadow-sm\">\r\n                <div className=\"flex items-center justify-between mb-4\">\r\n                    <div>\r\n                        <h3 className=\"text-sm font-bold text-slate-900 flex items-center gap-2 tracking-tight\">\r\n                            Evoluci√≥n Financiera\r\n                        </h3>\r\n                        <p className=\"text-[10px] text-slate-400 mt-0.5 font-medium\">Ingresos vs Gastos (√öltimos 12 meses)</p>\r\n                    </div>\r\n                    {/* Legend */}\r\n                    <div className=\"flex gap-3 text-[9px] font-bold uppercase tracking-widest\">\r\n                        <div className=\"flex items-center gap-1.5\">\r\n                            <span className=\"w-1.5 h-1.5 rounded-full bg-indigo-500 shadow-sm ring-1 ring-indigo-50\"></span>\r\n                            <span className=\"text-slate-500\">Ingresos</span>\r\n                        </div>\r\n                        <div className=\"flex items-center gap-1.5\">\r\n                            <span className=\"w-1.5 h-1.5 rounded-md bg-emerald-500 shadow-sm ring-1 ring-emerald-50\"></span>\r\n                            <span className=\"text-slate-500\">Beneficio</span>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                <div className=\"h-[250px] w-full\">\r\n                    <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n                        <ComposedChart data={sortedRecords} margin={{ top: 5, right: 0, left: -20, bottom: 0 }}>\r\n                            <defs>\r\n                                <linearGradient id=\"colorIngresos\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\r\n                                    <stop offset=\"5%\" stopColor=\"#6366f1\" stopOpacity={0.15} />\r\n                                    <stop offset=\"95%\" stopColor=\"#6366f1\" stopOpacity={0} />\r\n                                </linearGradient>\r\n                            </defs>\r\n                            <CartesianGrid strokeDasharray=\"3 3\" vertical={false} stroke=\"#f1f5f9\" />\r\n                            <XAxis\r\n                                dataKey=\"month\"\r\n                                stroke=\"#94a3b8\"\r\n                                tick={{ fontSize: 9, fill: '#94a3b8', fontWeight: 600 }}\r\n                                axisLine={false}\r\n                                tickLine={false}\r\n                                dy={10}\r\n                            />\r\n                            <YAxis\r\n                                stroke=\"#94a3b8\"\r\n                                tick={{ fontSize: 9, fill: '#94a3b8', fontWeight: 600, fontFamily: 'monospace' }}\r\n                                axisLine={false}\r\n                                tickLine={false}\r\n                                tickFormatter={(val) => `${(val / 1000).toFixed(0)}k`}\r\n                            />\r\n                            <Tooltip content={<CustomTooltip />} cursor={{ fill: '#f8fafc', opacity: 0.8 }} />\r\n\r\n                            <Area\r\n                                type=\"monotone\"\r\n                                dataKey=\"revenue\"\r\n                                name=\"Ingresos\"\r\n                                stroke=\"#6366f1\"\r\n                                fillOpacity={1}\r\n                                fill=\"url(#colorIngresos)\"\r\n                                strokeWidth={2}\r\n                                strokeLinecap=\"round\"\r\n                            />\r\n                            <Bar\r\n                                dataKey=\"profit\"\r\n                                name=\"Beneficio\"\r\n                                barSize={24}\r\n                                fill=\"#10b981\"\r\n                                radius={[4, 4, 0, 0]}\r\n                                opacity={1}\r\n                            />\r\n                        </ComposedChart>\r\n                    </ResponsiveContainer>\r\n                </div>\r\n            </div>\r\n\r\n            {/* DATA TABLE */}\r\n            <div>\r\n                <MonthlyHistoryTable franchiseId={franchiseId} records={records} />\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default FranchiseHistoryView;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\finance\\MonthComparisonModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\finance\\MonthlyHistoryTable.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":40,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":40,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2270,2273],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2270,2273],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":40,"column":65,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":40,"endColumn":68,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2305,2308],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2305,2308],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":84,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":84,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4216,4219],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4216,4219],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":339,"column":75,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":339,"endColumn":78,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19173,19176],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19173,19176],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":339,"column":102,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":339,"endColumn":105,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19200,19203],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19200,19203],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":389,"column":69,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":389,"endColumn":72,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[23412,23415],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[23412,23415],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":390,"column":237,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":390,"endColumn":240,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[23675,23678],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[23675,23678],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":403,"column":73,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":403,"endColumn":76,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[24559,24562],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[24559,24562],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":403,"column":102,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":403,"endColumn":105,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[24588,24591],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[24588,24591],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":403,"column":141,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":403,"endColumn":144,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[24627,24630],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[24627,24630],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":406,"column":144,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":406,"endColumn":147,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[24971,24974],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[24971,24974],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":410,"column":75,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":410,"endColumn":78,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[25425,25428],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[25425,25428],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":412,"column":102,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":412,"endColumn":105,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[25681,25684],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[25681,25684],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":437,"column":74,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":437,"endColumn":77,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[27727,27730],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[27727,27730],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":437,"column":103,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":437,"endColumn":106,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[27756,27759],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[27756,27759],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":437,"column":142,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":437,"endColumn":145,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[27795,27798],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[27795,27798],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":437,"column":184,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":437,"endColumn":187,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[27837,27840],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[27837,27840],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":489,"column":63,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":489,"endColumn":66,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[31049,31052],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[31049,31052],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":489,"column":101,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":489,"endColumn":104,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[31087,31090],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[31087,31090],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":489,"column":149,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":489,"endColumn":152,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[31135,31138],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[31135,31138],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":489,"column":207,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":489,"endColumn":210,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[31193,31196],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[31193,31196],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":21,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useMemo } from 'react';\r\nimport { formatMoney } from '../../../lib/finance';\r\nimport { TrendingUp, TrendingDown, Calendar, Edit3, Eye, Search, X, GitCompare, Trash2, Unlock, Lock, Shield, CheckCircle, AlertTriangle, FileText, Clock } from 'lucide-react';\r\nimport { financeService } from '../../../services/financeService';\r\nimport { notificationService } from '../../../services/notificationService';\r\nimport FinancialControlCenter from '../FinancialControlCenter';\r\nimport { MonthlyRecord, useFranchiseHistory } from '../../../hooks/useFranchiseHistory';\r\nimport { formatTimeAgo } from '../../../utils/dateHelpers';\r\nimport { useAuth } from '../../../context/AuthContext'; // Added context\r\nimport { userService } from '../../../services/userService'; // Import userService\r\nimport QuickViewPanel from './QuickViewPanel';\r\nimport MonthComparisonModal from './MonthComparisonModal';\r\n\r\ninterface MonthlyHistoryTableProps {\r\n    franchiseId: string;\r\n    onUpdate?: () => void;\r\n    records?: MonthlyRecord[];\r\n}\r\n\r\nconst MonthlyHistoryTable: React.FC<MonthlyHistoryTableProps> = ({ franchiseId, onUpdate, records: externalRecords }) => {\r\n    const { records: fetchedRecords, loading: fetching, refresh } = useFranchiseHistory(externalRecords ? undefined : franchiseId);\r\n\r\n    const records = externalRecords || fetchedRecords;\r\n    const loading = externalRecords ? false : fetching;\r\n\r\n    const [editingMonth, setEditingMonth] = useState<string | null>(null);\r\n    const [quickViewRecord, setQuickViewRecord] = useState<MonthlyRecord | null>(null);\r\n    const [requestingUnlock, setRequestingUnlock] = useState<MonthlyRecord | null>(null); // For Franchise request\r\n    const [unlockRequestReason, setUnlockRequestReason] = useState('');\r\n    const [selectedForComparison, setSelectedForComparison] = useState<string[]>([]);\r\n    const [showComparison, setShowComparison] = useState(false);\r\n\r\n    // Unlock Review Modal State\r\n    const [pendingUnlock, setPendingUnlock] = useState<MonthlyRecord | null>(null);\r\n    const [rejectionReason, setRejectionReason] = useState('');\r\n    const [actionLoading, setActionLoading] = useState(false);\r\n\r\n    const { user } = useAuth();\r\n    // Safe check for admin role\r\n    const isAdmin = (user as any)?.role === 'admin' || (user as any)?.customClaims?.role === 'admin' || (user?.email?.includes('admin'));\r\n\r\n    const handleProcessUnlock = async (approved: boolean) => {\r\n        if (!pendingUnlock) return;\r\n\r\n        const month = pendingUnlock.month;\r\n        setActionLoading(true);\r\n        try {\r\n            if (approved) {\r\n                await financeService.unlockMonth(franchiseId, month);\r\n\r\n                // FIX: Resolve UID from FranchiseID for Notification\r\n                const franchiseUser = await userService.getUserByFranchiseId(franchiseId);\r\n                const targetUid = franchiseUser?.uid || franchiseId; // Fallback to ID if not found (though unlikely for valid franchises)\r\n\r\n                await notificationService.notifyFranchise(targetUid, {\r\n                    title: `Mes Desbloqueado: ${month}`,\r\n                    message: `El administrador ha desbloqueado el cierre de ${month}. Ya puedes editar.`,\r\n                    type: 'MONTH_UNLOCKED',\r\n                    priority: 'normal',\r\n                    link: '/dashboard/finance'\r\n                });\r\n                alert(\"Mes desbloqueado.\");\r\n            } else {\r\n                await financeService.rejectUnlock(franchiseId, month);\r\n                // Notify rejection?\r\n                // Currently just resetting to locked.\r\n                alert(\"Solicitud rechazada (estado devuelto a 'Cerrado').\");\r\n            }\r\n            if (refresh) await refresh();\r\n            onUpdate?.();\r\n            setPendingUnlock(null);\r\n        } catch (error) {\r\n            console.error(\"Error processing unlock:\", error);\r\n            alert(\"Error al procesar la solicitud.\");\r\n        } finally {\r\n            setActionLoading(false);\r\n        }\r\n    };\r\n\r\n    // Filters state\r\n    const [searchTerm, setSearchTerm] = useState('');\r\n    const [yearFilter, setYearFilter] = useState<string>('');\r\n\r\n    const handleSaveEdit = async (data: any) => {\r\n        if (!editingMonth) return;\r\n        try {\r\n            console.log(\"Saving edited month:\", editingMonth, data);\r\n            await financeService.updateFinancialData(franchiseId, editingMonth, {\r\n                ...data,\r\n                status: 'locked', // Force lock on save from wizard\r\n                is_locked: true\r\n            });\r\n            if (refresh) await refresh();\r\n            setEditingMonth(null);\r\n            onUpdate?.();\r\n        } catch (error) {\r\n            console.error(\"Error saving month:\", error);\r\n            alert(\"Error al guardar los cambios.\");\r\n        }\r\n    };\r\n\r\n    const handleDelete = async (month: string) => {\r\n        if (window.confirm(`¬øEst√°s seguro de que deseas eliminar permanentemente el cierre de ${month}? Esta acci√≥n no se puede deshacer y borrar√° todos los datos asociados.`)) {\r\n            try {\r\n                await financeService.resetMonthSummary(franchiseId, month);\r\n\r\n                // Only notify if Admin performs the deletion (Audit/Alert for Franchise)\r\n                if (isAdmin) {\r\n                    // FIX: Resolve UID for Notification\r\n                    const franchiseUser = await userService.getUserByFranchiseId(franchiseId);\r\n                    const targetUid = franchiseUser?.uid || franchiseId;\r\n\r\n                    await notificationService.notifyFranchise(targetUid, {\r\n                        title: `Cierre Eliminado: ${month}`,\r\n                        message: `El administrador ha eliminado el cierre del mes de ${month}.`,\r\n                        type: 'ALERT',\r\n                        priority: 'high',\r\n                        link: '/dashboard/finance'\r\n                    });\r\n                }\r\n                if (refresh) await refresh();\r\n                onUpdate?.();\r\n            } catch (error) {\r\n                console.error(\"Error deleting record:\", error);\r\n                alert(\"Error al eliminar el registro.\");\r\n            }\r\n        }\r\n    };\r\n\r\n    // Get unique years from records\r\n    const availableYears = useMemo(() => {\r\n        const years = new Set(records.map(r => r.month.split('-')[0]));\r\n        return Array.from(years).sort().reverse();\r\n    }, [records]);\r\n\r\n    // Filtered records with search and filters\r\n    const filteredRecords = useMemo(() => {\r\n        return records.filter(record => {\r\n            const matchesSearch = record.month.toLowerCase().includes(searchTerm.toLowerCase());\r\n            const matchesYear = !yearFilter || record.month.startsWith(yearFilter);\r\n            return matchesSearch && matchesYear;\r\n        });\r\n    }, [records, searchTerm, yearFilter]);\r\n\r\n    const handleResetFilters = () => {\r\n        setSearchTerm('');\r\n        setYearFilter('');\r\n    };\r\n\r\n    const hasActiveFilters = searchTerm || yearFilter;\r\n\r\n    const toggleComparison = (month: string) => {\r\n        setSelectedForComparison(prev => {\r\n            if (prev.includes(month)) {\r\n                return prev.filter(m => m !== month);\r\n            }\r\n            if (prev.length < 2) {\r\n                return [...prev, month];\r\n            }\r\n            // Replace first if already 2 selected\r\n            return [prev[1], month];\r\n        });\r\n    };\r\n\r\n    if (loading) {\r\n        return (\r\n            <div className=\"bg-white border border-slate-200 rounded-2xl p-12 text-center\">\r\n                <div className=\"animate-pulse flex flex-col items-center gap-4\">\r\n                    <div className=\"w-12 h-12 bg-slate-100 rounded-full\"></div>\r\n                    <div className=\"h-4 bg-slate-100 rounded w-32\"></div>\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    if (!records || records.length === 0) {\r\n        return (\r\n            <div className=\"bg-white border border-dashed border-slate-200 rounded-2xl p-12 text-center flex flex-col items-center gap-4\">\r\n                <div className=\"p-4 bg-slate-50 rounded-full text-slate-400\">\r\n                    <Calendar className=\"w-8 h-8\" />\r\n                </div>\r\n                <div>\r\n                    <p className=\"text-slate-800 font-medium text-lg\">Sin historial disponible</p>\r\n                    <p className=\"text-sm text-slate-500 max-w-xs mx-auto mt-1\">\r\n                        Los cierres mensuales que realices aparecer√°n aqu√≠ detallados.\r\n                    </p>\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <>\r\n            {/* FILTERS BAR - Compact */}\r\n            <div className=\"bg-white border border-slate-100 rounded-xl p-2 mb-4 flex flex-wrap gap-2 shadow-sm items-center\">\r\n                {/* Search */}\r\n                <div className=\"flex-1 min-w-[200px] relative group\">\r\n                    <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-slate-400 group-focus-within:text-indigo-500 transition-colors\" />\r\n                    <input\r\n                        type=\"text\"\r\n                        placeholder=\"Buscar periodo...\"\r\n                        value={searchTerm}\r\n                        onChange={(e) => setSearchTerm(e.target.value)}\r\n                        className=\"w-full bg-slate-50 border-0 rounded-lg pl-9 pr-3 py-2 text-xs text-slate-800 placeholder-slate-400 focus:ring-1 focus:ring-indigo-100 focus:bg-white transition-all font-medium\"\r\n                    />\r\n                </div>\r\n\r\n                {/* Year Filter */}\r\n                <select\r\n                    value={yearFilter}\r\n                    onChange={(e) => setYearFilter(e.target.value)}\r\n                    className=\"bg-slate-50 border-0 rounded-lg px-3 py-2 text-xs text-slate-700 focus:ring-1 focus:ring-indigo-100 focus:bg-white transition-all font-bold cursor-pointer hover:bg-slate-100\"\r\n                    aria-label=\"Filtrar por a√±o\"\r\n                >\r\n                    <option value=\"\">Todo el hist√≥rico</option>\r\n                    {availableYears.map(year => (\r\n                        <option key={year} value={year}>A√±o {year}</option>\r\n                    ))}\r\n                </select>\r\n\r\n                {/* Reset Button */}\r\n                {hasActiveFilters && (\r\n                    <button\r\n                        onClick={handleResetFilters}\r\n                        className=\"flex items-center gap-2 px-3 py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-lg text-xs font-bold transition-all hover:-translate-y-0.5\"\r\n                        title=\"Limpiar filtros\"\r\n                    >\r\n                        <X className=\"w-3.5 h-3.5\" />\r\n                    </button>\r\n                )}\r\n\r\n                {/* Results Counter - Now more subtle */}\r\n                <div className=\"px-3 py-1 text-[10px] text-slate-400 font-medium hidden md:block\">\r\n                    <span className=\"font-mono font-bold text-slate-600\">{filteredRecords.length}</span> resultados\r\n                </div>\r\n\r\n                {/* Comparison Button - Prominent */}\r\n                {selectedForComparison.length === 2 && (\r\n                    <button\r\n                        className=\"flex items-center gap-1.5 px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-xs font-bold transition-all shadow-sm shadow-indigo-500/20 hover:shadow-md hover:shadow-indigo-500/30 hover:-translate-y-0.5 animate-in fade-in slide-in-from-right-2\"\r\n                        onClick={() => setShowComparison(true)}\r\n                    >\r\n                        <GitCompare className=\"w-3.5 h-3.5\" />\r\n                        Comparar\r\n                    </button>\r\n                )}\r\n            </div>\r\n\r\n            <div className=\"bg-white border border-slate-100 rounded-xl overflow-hidden shadow-sm\">\r\n                <div className=\"overflow-x-auto\">\r\n                    <table className=\"w-full\">\r\n                        <thead>\r\n                            <tr className=\"border-b border-slate-100 bg-slate-50/50\">\r\n                                <th className=\"px-4 py-3 text-left text-[10px] font-bold text-slate-500 uppercase tracking-wider\">\r\n                                    Periodo\r\n                                </th>\r\n                                <th className=\"px-4 py-3 text-right text-[10px] font-bold text-slate-500 uppercase tracking-wider\">\r\n                                    Ingresos\r\n                                </th>\r\n                                <th className=\"px-4 py-3 text-right text-[10px] font-bold text-slate-500 uppercase tracking-wider\">\r\n                                    Gastos\r\n                                </th>\r\n                                <th className=\"px-4 py-3 text-right text-[10px] font-bold text-slate-500 uppercase tracking-wider\">\r\n                                    Resultado\r\n                                </th>\r\n                                <th className=\"px-4 py-3 text-center text-[10px] font-bold text-slate-500 uppercase tracking-wider\">\r\n                                    Estado\r\n                                </th>\r\n                                <th className=\"px-4 py-3 text-right text-[10px] font-bold text-slate-500 uppercase tracking-wider\">\r\n                                    Acciones\r\n                                </th>\r\n                            </tr>\r\n                        </thead>\r\n                        <tbody className=\"divide-y divide-slate-50\">\r\n                            {filteredRecords.map((record) => {\r\n                                const isPositive = record.profit >= 0;\r\n                                const margin = record.revenue > 0 ? (record.profit / record.revenue) * 100 : 0;\r\n                                const isSelected = selectedForComparison.includes(record.month);\r\n\r\n                                return (\r\n                                    <tr\r\n                                        key={record.id}\r\n                                        className={`group transition-all duration-200 ${isSelected ? 'bg-indigo-50/50' : 'hover:bg-slate-50'}`}\r\n                                    >\r\n                                        <td className=\"px-4 py-3\">\r\n                                            <div className=\"flex items-center gap-3\">\r\n                                                <div className=\"relative\">\r\n                                                    <input\r\n                                                        type=\"checkbox\"\r\n                                                        checked={isSelected}\r\n                                                        onChange={() => toggleComparison(record.month)}\r\n                                                        className={`w-4 h-4 rounded border-2 transition-all cursor-pointer ${isSelected ? 'border-indigo-500 bg-indigo-500' : 'border-slate-200 bg-white hover:border-indigo-300'}`}\r\n                                                        title=\"Comparar\"\r\n                                                    />\r\n                                                </div>\r\n\r\n                                                <div className={`p-1.5 rounded-lg transition-colors ${isSelected ? 'bg-indigo-100 text-indigo-600' : 'bg-slate-100 text-slate-400 group-hover:bg-white group-hover:text-indigo-600 group-hover:shadow-sm'}`}>\r\n                                                    <Calendar className=\"w-3.5 h-3.5\" />\r\n                                                </div>\r\n                                                <div className=\"flex flex-col\">\r\n                                                    <span className={`font-mono text-sm font-bold tracking-tight transition-colors capitalize ${isSelected ? 'text-indigo-900' : 'text-slate-700 group-hover:text-slate-900'}`}>\r\n                                                        {(() => {\r\n                                                            const [y, m] = record.month.split('-');\r\n                                                            const date = new Date(parseInt(y), parseInt(m) - 1);\r\n                                                            return date.toLocaleDateString('es-ES', { month: 'long', year: '2-digit' }).replace(' de ', '-').replace(' ', '-');\r\n                                                        })()}\r\n                                                    </span>\r\n                                                    {record.updated_at && (\r\n                                                        <span className=\"text-[9px] text-slate-400 font-medium\">\r\n                                                            {formatTimeAgo(record.updated_at)}\r\n                                                        </span>\r\n                                                    )}\r\n                                                </div>\r\n                                            </div>\r\n                                        </td>\r\n                                        <td className=\"px-4 py-3 text-right\">\r\n                                            <div className=\"font-mono text-slate-700 font-medium group-hover:text-indigo-600 transition-colors text-sm tracking-tight\">\r\n                                                {formatMoney(record.revenue)}‚Ç¨\r\n                                            </div>\r\n                                        </td>\r\n                                        <td className=\"px-4 py-3 text-right\">\r\n                                            <div className=\"font-mono text-slate-500 text-sm tracking-tight\">\r\n                                                {formatMoney(record.totalExpenses)}‚Ç¨\r\n                                            </div>\r\n                                        </td>\r\n                                        <td className=\"px-4 py-3 text-right\">\r\n                                            <div className=\"flex flex-col items-end gap-0.5\">\r\n                                                <div className={`font-mono font-bold text-sm tracking-tight flex items-center gap-1.5 ${isPositive ? 'text-emerald-600' : 'text-rose-600'}`}>\r\n                                                    {formatMoney(record.profit)}‚Ç¨\r\n                                                </div>\r\n                                                <div className={`flex items-center gap-1 px-1.5 py-0.5 rounded text-[9px] font-bold ${isPositive ? 'bg-emerald-50 text-emerald-700' : 'bg-rose-50 text-rose-700'}`}>\r\n                                                    {isPositive ? <TrendingUp className=\"w-2.5 h-2.5\" /> : <TrendingDown className=\"w-2.5 h-2.5\" />}\r\n                                                    {margin.toFixed(1)}%\r\n                                                </div>\r\n                                            </div>\r\n                                        </td>\r\n                                        <td className=\"px-4 py-3 text-center\">\r\n                                            {(() => {\r\n                                                const status = (record as any).status || ((record as any).is_locked ? 'locked' : 'draft');\r\n\r\n                                                const getStatusConfig = (s: string) => {\r\n                                                    switch (s) {\r\n                                                        case 'locked': return {\r\n                                                            label: 'Cerrado',\r\n                                                            icon: <Lock className=\"w-3 h-3\" />,\r\n                                                            className: 'bg-slate-100 text-slate-600 border-slate-200'\r\n                                                        };\r\n                                                        case 'approved': return {\r\n                                                            label: 'Aprobado',\r\n                                                            icon: <CheckCircle className=\"w-3 h-3\" />,\r\n                                                            className: 'bg-emerald-50 text-emerald-700 border-emerald-200 shadow-sm'\r\n                                                        };\r\n                                                        case 'draft': return {\r\n                                                            label: 'Borrador',\r\n                                                            icon: <FileText className=\"w-3 h-3\" />,\r\n                                                            className: 'bg-yellow-50 text-yellow-700 border-yellow-200 border-dashed'\r\n                                                        };\r\n                                                        case 'open': return {\r\n                                                            label: 'Abierto',\r\n                                                            icon: <Edit3 className=\"w-3 h-3\" />,\r\n                                                            className: 'bg-indigo-50 text-indigo-600 border-indigo-200'\r\n                                                        };\r\n                                                        case 'unlock_requested': return {\r\n                                                            label: 'Solicitado',\r\n                                                            icon: <Clock className=\"w-3 h-3 animate-pulse\" />,\r\n                                                            className: 'bg-amber-50 text-amber-700 border-amber-200'\r\n                                                        };\r\n                                                        case 'rejected': return {\r\n                                                            label: 'Rechazado',\r\n                                                            icon: <AlertTriangle className=\"w-3 h-3\" />,\r\n                                                            className: 'bg-rose-50 text-rose-700 border-rose-200'\r\n                                                        };\r\n                                                        default: return {\r\n                                                            label: s,\r\n                                                            icon: <Shield className=\"w-3 h-3\" />,\r\n                                                            className: 'bg-slate-50 text-slate-500 border-slate-200'\r\n                                                        };\r\n                                                    }\r\n                                                };\r\n\r\n                                                const config = getStatusConfig(status);\r\n\r\n                                                return (\r\n                                                    <div className=\"flex flex-col items-center gap-1.5\">\r\n                                                        <span className={`inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider border transition-all ${config.className}`} title={config.label}>\r\n                                                            {config.icon}\r\n                                                            {config.label}\r\n                                                        </span>\r\n                                                        {(record as any).rejectionReason && (\r\n                                                            <span className=\"flex items-center gap-1 text-[9px] text-rose-500 font-medium bg-rose-50 px-1.5 py-0.5 rounded border border-rose-100 max-w-[100px] truncate\" title={(record as any).rejectionReason}>\r\n                                                                <X className=\"w-2.5 h-2.5\" />\r\n                                                                Rechazado\r\n                                                            </span>\r\n                                                        )}\r\n                                                    </div>\r\n                                                );\r\n                                            })()}\r\n                                        </td>\r\n                                        <td className=\"px-4 py-3\">\r\n                                            <div className=\"flex items-center justify-end gap-2 opacity-100 transition-all duration-200\">\r\n\r\n                                                {/* ADMIN UNLOCK */}\r\n                                                {isAdmin && ((record as any).is_locked || (record as any).status === 'locked' || (record as any).status === 'unlock_requested') && (\r\n                                                    <button\r\n                                                        onClick={() => setPendingUnlock(record)}\r\n                                                        className={`p-2 rounded-lg transition-all border shadow-sm group relative ${(record as any).status === 'unlock_requested'\r\n                                                            ? 'bg-amber-100 text-amber-700 border-amber-200 hover:bg-amber-200'\r\n                                                            : 'bg-white text-slate-400 border-slate-200 hover:border-amber-300 hover:text-amber-600'\r\n                                                            }`}\r\n                                                        title={(record as any).status === 'unlock_requested' ? \"Revisar solicitud pendiente\" : \"Desbloquear administraci√≥n\"}\r\n                                                    >\r\n                                                        <Unlock className={`w-3.5 h-3.5 ${(record as any).status === 'unlock_requested' ? 'animate-pulse' : ''}`} />\r\n                                                    </button>\r\n                                                )}\r\n\r\n                                                {/* QUICK VIEW */}\r\n                                                <button\r\n                                                    onClick={() => setQuickViewRecord(record)}\r\n                                                    className=\"p-2 bg-white hover:bg-indigo-50 text-slate-400 hover:text-indigo-600 border border-slate-200 hover:border-indigo-200 rounded-lg transition-all shadow-sm\"\r\n                                                    title=\"Ver Detalle Mensual\"\r\n                                                >\r\n                                                    <Eye className=\"w-3.5 h-3.5\" />\r\n                                                </button>\r\n\r\n                                                {/* EDIT (If allowed) */}\r\n                                                {(isAdmin || (!record.is_locked && record.status !== 'locked' && record.status !== 'unlock_requested' && record.status !== 'approved')) && (\r\n                                                    <button\r\n                                                        onClick={() => setEditingMonth(record.month)}\r\n                                                        className=\"p-2 bg-white hover:bg-indigo-50 text-slate-400 hover:text-indigo-600 border border-slate-200 hover:border-indigo-200 rounded-lg transition-all shadow-sm\"\r\n                                                        title=\"Editar Datos\"\r\n                                                    >\r\n                                                        <Edit3 className=\"w-3.5 h-3.5\" />\r\n                                                    </button>\r\n                                                )}\r\n\r\n                                                {/* FRANCHISE REQUEST UNLOCK */}\r\n                                                {!isAdmin && ((record as any).is_locked || (record as any).status === 'locked' || (record as any).status === 'approved') && (record as any).status !== 'unlock_requested' && (\r\n                                                    <button\r\n                                                        onClick={() => setRequestingUnlock(record)}\r\n                                                        className=\"p-2 bg-white hover:bg-amber-50 text-slate-400 hover:text-amber-600 border border-slate-200 hover:border-amber-200 rounded-lg transition-all shadow-sm\"\r\n                                                        title=\"Solicitar Desbloqueo\"\r\n                                                    >\r\n                                                        <Lock className=\"w-3.5 h-3.5\" />\r\n                                                    </button>\r\n                                                )}\r\n\r\n                                                {/* DELETE */}\r\n                                                {(isAdmin || (!record.is_locked && record.status !== 'locked' && record.status !== 'unlock_requested' && record.status !== 'approved')) && (\r\n                                                    <button\r\n                                                        onClick={() => handleDelete(record.month)}\r\n                                                        className=\"p-2 bg-white hover:bg-rose-50 text-slate-400 hover:text-rose-600 border border-slate-200 hover:border-rose-200 rounded-lg transition-all shadow-sm group\"\r\n                                                        title=\"Eliminar registro\"\r\n                                                    >\r\n                                                        <Trash2 className=\"w-3.5 h-3.5 group-hover:shake\" />\r\n                                                    </button>\r\n                                                )}\r\n                                            </div>\r\n                                        </td>\r\n                                    </tr>\r\n                                )\r\n                            })}\r\n                        </tbody>\r\n                    </table>\r\n                </div>\r\n\r\n                <div className=\"px-4 py-3 bg-slate-50/50 border-t border-slate-100 flex justify-between items-center\">\r\n                    <span className=\"text-[9px] font-bold uppercase tracking-widest text-slate-400\">Historial Completo</span>\r\n                    <span className=\"text-[10px] text-slate-500 font-medium\">Mostrando {filteredRecords.length} registros</span>\r\n                </div>\r\n            </div>\r\n\r\n            {editingMonth && (\r\n                <FinancialControlCenter\r\n                    franchiseId={franchiseId}\r\n                    month={editingMonth}\r\n                    onClose={() => setEditingMonth(null)}\r\n                    onSave={handleSaveEdit}\r\n                />\r\n            )}\r\n\r\n            {quickViewRecord && (\r\n                <QuickViewPanel\r\n                    record={quickViewRecord}\r\n                    onClose={() => setQuickViewRecord(null)}\r\n                    onEdit={() => {\r\n                        setEditingMonth(quickViewRecord.month);\r\n                        setQuickViewRecord(null);\r\n                    }}\r\n                    canEdit={isAdmin || (!(quickViewRecord as any).is_locked && (quickViewRecord as any).status !== 'locked' && (quickViewRecord as any).status !== 'unlock_requested' && (quickViewRecord as any).status !== 'approved')}\r\n                />\r\n            )}\r\n\r\n            {showComparison && selectedForComparison.length === 2 && (() => {\r\n                const month1Record = records.find(r => r.month === selectedForComparison[0]);\r\n                const month2Record = records.find(r => r.month === selectedForComparison[1]);\r\n\r\n                if (month1Record && month2Record) {\r\n                    return (\r\n                        <MonthComparisonModal\r\n                            month1={month1Record}\r\n                            month2={month2Record}\r\n                            onClose={() => {\r\n                                setShowComparison(false);\r\n                                setSelectedForComparison([]);\r\n                            }}\r\n                        />\r\n                    );\r\n                }\r\n                return null;\r\n            })()}\r\n\r\n            {/* FRANCHISE UNLOCK REQUEST MODAL */}\r\n            {requestingUnlock && (\r\n                <div className=\"fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] flex items-center justify-center p-4 animate-in fade-in duration-200\">\r\n                    <div className=\"bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 space-y-5 animate-in zoom-in-95 duration-200\">\r\n                        <div className=\"flex items-center gap-3 text-amber-600 mb-2\">\r\n                            <div className=\"p-2 bg-amber-100 rounded-lg\">\r\n                                <Unlock className=\"w-5 h-5\" />\r\n                            </div>\r\n                            <h3 className=\"text-lg font-bold text-gray-900\">Solicitar Desbloqueo</h3>\r\n                        </div>\r\n\r\n                        {/* Visual Status Timeline */}\r\n                        <div className=\"flex items-center justify-between px-4 py-3 bg-slate-50 rounded-xl border border-slate-100 mb-4 text-xs font-bold text-slate-400\">\r\n                            <div className=\"flex flex-col items-center gap-1 text-slate-900\">\r\n                                <span className=\"w-2.5 h-2.5 rounded-full bg-slate-900\" />\r\n                                <span>Bloqueado</span>\r\n                            </div>\r\n                            <div className=\"h-0.5 flex-1 bg-slate-200 mx-2\" />\r\n                            <div className=\"flex flex-col items-center gap-1 text-amber-600\">\r\n                                <span className=\"w-2.5 h-2.5 rounded-full bg-amber-500 animate-pulse shadow-[0_0_0_3px_rgba(245,158,11,0.2)]\" />\r\n                                <span>Solicitando...</span>\r\n                            </div>\r\n                            <div className=\"h-0.5 flex-1 bg-slate-200 mx-2\" />\r\n                            <div className=\"flex flex-col items-center gap-1\">\r\n                                <span className=\"w-2.5 h-2.5 rounded-full bg-slate-300\" />\r\n                                <span>Abierto</span>\r\n                            </div>\r\n                        </div>\r\n\r\n                        <p className=\"text-sm text-gray-600\">\r\n                            Indica el motivo por el cual necesitas modificar el cierre de <strong>{requestingUnlock.month}</strong>.\r\n                            El administrador revisar√° tu solicitud.\r\n                        </p>\r\n\r\n                        <div className=\"space-y-1\">\r\n                            <label className=\"text-xs font-bold text-gray-500 uppercase tracking-wider\">Motivo</label>\r\n                            <textarea\r\n                                value={unlockRequestReason}\r\n                                onChange={(e) => setUnlockRequestReason(e.target.value)}\r\n                                className=\"w-full h-24 p-3 bg-slate-50 border border-slate-200 rounded-lg text-sm resize-none focus:ring-2 focus:ring-amber-500/20 focus:border-amber-500 outline-none transition-all\"\r\n                                placeholder=\"Ej: Olvid√© incluir una factura de combustible...\"\r\n                                autoFocus\r\n                            />\r\n                        </div>\r\n\r\n                        <div className=\"flex gap-3 pt-2\">\r\n                            <button\r\n                                onClick={() => {\r\n                                    setRequestingUnlock(null);\r\n                                    setUnlockRequestReason('');\r\n                                }}\r\n                                className=\"flex-1 px-4 py-2 bg-white border border-slate-200 text-slate-700 rounded-xl font-bold text-xs hover:bg-slate-50 transition-colors\"\r\n                            >\r\n                                Cancelar\r\n                            </button>\r\n                            <button\r\n                                onClick={async () => {\r\n                                    if (!unlockRequestReason.trim()) return alert(\"Debes indicar un motivo.\");\r\n                                    try {\r\n                                        await financeService.requestUnlock(franchiseId, requestingUnlock.month, unlockRequestReason);\r\n                                        try {\r\n                                            // Attempt primary notification type\r\n                                            await notificationService.notify(\r\n                                                'UNLOCK_REQUEST',\r\n                                                franchiseId,\r\n                                                'Franquicia',\r\n                                                {\r\n                                                    title: `Solicitud Desbloqueo: ${requestingUnlock.month}`,\r\n                                                    message: `Motivo: ${unlockRequestReason}`,\r\n                                                    priority: 'normal',\r\n                                                    metadata: { month: requestingUnlock.month, status: 'locked', reason: unlockRequestReason }\r\n                                                }\r\n                                            );\r\n                                        } catch (notifyError) {\r\n                                            console.warn(\"UNLOCK_REQUEST notification failed, trying fallback...\", notifyError);\r\n                                            try {\r\n                                                await notificationService.notify(\r\n                                                    'FINANCE_CLOSING',\r\n                                                    franchiseId,\r\n                                                    'Franquicia',\r\n                                                    {\r\n                                                        title: `[SOLICITUD RETENIDA] ${requestingUnlock.month}`,\r\n                                                        message: `Motivo desbloqueo: ${unlockRequestReason}`,\r\n                                                        priority: 'high',\r\n                                                        metadata: { month: requestingUnlock.month, status: 'locked', reason: unlockRequestReason }\r\n                                                    }\r\n                                                );\r\n                                            } catch (fallbackError) {\r\n                                                console.error(\"All notification attempts failed\", fallbackError);\r\n                                                alert(\"Solicitud registrada, pero no se pudo enviar la notificaci√≥n al administrador.\");\r\n                                            }\r\n                                        }\r\n\r\n                                        // Also need to Refresh\r\n                                        if (refresh) await refresh();\r\n                                        setRequestingUnlock(null);\r\n                                        setUnlockRequestReason('');\r\n                                        // alert(\"Solicitud enviada correctamente.\");\r\n                                    } catch (err) {\r\n                                        console.error(err);\r\n                                        alert(\"Error al enviar solicitud.\");\r\n                                    }\r\n                                }}\r\n                                className=\"flex-1 px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-xl font-bold text-xs shadow-lg shadow-amber-500/20 transition-all active:scale-95\"\r\n                            >\r\n                                Enviar Solicitud\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            {/* UNLOCK REVIEW MODAL */}\r\n            {pendingUnlock && (\r\n                <div className=\"fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] flex items-center justify-center p-4 animate-in fade-in duration-200\">\r\n                    <div className=\"bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 space-y-4 animate-in zoom-in-95 duration-200\">\r\n                        <div className=\"flex items-center gap-3 text-amber-600 mb-2\">\r\n                            <div className=\"p-2 bg-amber-100 rounded-lg\">\r\n                                <Unlock className=\"w-5 h-5\" />\r\n                            </div>\r\n                            <h3 className=\"text-lg font-bold text-gray-900\">Revisar Solicitud de Desbloqueo</h3>\r\n                        </div>\r\n\r\n                        {/* Visual Status Timeline - Admin View */}\r\n                        <div className=\"flex items-center justify-between px-4 py-3 bg-slate-50 rounded-xl border border-slate-100 mb-4 text-xs font-bold text-slate-400\">\r\n                            <div className=\"flex flex-col items-center gap-1 text-slate-900\">\r\n                                <span className=\"w-2.5 h-2.5 rounded-full bg-slate-900\" />\r\n                                <span>Bloqueado</span>\r\n                            </div>\r\n                            <div className=\"h-0.5 flex-1 bg-amber-500 mx-2\" />\r\n                            <div className=\"flex flex-col items-center gap-1 text-amber-600\">\r\n                                <span className=\"w-2.5 h-2.5 rounded-full bg-amber-500 shadow-[0_0_0_3px_rgba(245,158,11,0.2)]\" />\r\n                                <span>Solicitado</span>\r\n                            </div>\r\n                            <div className=\"h-0.5 flex-1 bg-slate-200 mx-2\" />\r\n                            <div className=\"flex flex-col items-center gap-1\">\r\n                                <span className=\"w-2.5 h-2.5 rounded-full bg-slate-300\" />\r\n                                <span>Desbloquear</span>\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"bg-slate-50 p-4 rounded-xl border border-slate-100\">\r\n                            <p className=\"text-xs font-bold text-gray-500 uppercase tracking-wider mb-1\">\r\n                                Mes Solicitado\r\n                            </p>\r\n                            <p className=\"text-sm font-semibold text-gray-900 mb-3\">{pendingUnlock.month}</p>\r\n\r\n                            <p className=\"text-xs font-bold text-gray-500 uppercase tracking-wider mb-1\">\r\n                                Motivo de la Franquicia\r\n                            </p>\r\n                            <div className=\"text-sm text-gray-700 bg-white p-3 rounded-lg border border-slate-200 italic\">\r\n                                &quot;{pendingUnlock.unlockReason || 'Sin motivo especificado'}&quot;\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"space-y-1\">\r\n                            <label className=\"text-xs font-bold text-gray-500 uppercase tracking-wider\">Motivo de Rechazo (Opcional)</label>\r\n                            <textarea\r\n                                value={rejectionReason}\r\n                                onChange={(e) => setRejectionReason(e.target.value)}\r\n                                className=\"w-full h-20 p-3 bg-white border border-gray-200 rounded-lg text-sm resize-none focus:ring-2 focus:ring-rose-500/20 focus:border-rose-500 outline-none\"\r\n                                placeholder=\"Explica por qu√© rechazas la solicitud...\"\r\n                            />\r\n                        </div>\r\n\r\n                        <div className=\"flex gap-3 pt-2\">\r\n                            <button\r\n                                onClick={() => handleProcessUnlock(false)}\r\n                                disabled={actionLoading}\r\n                                className=\"flex-1 py-2.5 text-sm font-bold text-rose-600 bg-rose-50 hover:bg-rose-100 rounded-xl transition-colors border border-rose-100\"\r\n                            >\r\n                                {actionLoading ? '...' : 'Rechazar'}\r\n                            </button>\r\n                            <button\r\n                                onClick={() => handleProcessUnlock(true)}\r\n                                disabled={actionLoading}\r\n                                className=\"flex-1 py-2.5 text-sm font-bold text-white bg-amber-500 hover:bg-amber-600 rounded-xl shadow-lg shadow-amber-500/20 transition-all\"\r\n                            >\r\n                                {actionLoading ? 'Procesando...' : 'Aprobar y Desbloquear'}\r\n                            </button>\r\n                        </div>\r\n\r\n                        <button\r\n                            onClick={() => setPendingUnlock(null)}\r\n                            disabled={actionLoading}\r\n                            className=\"w-full text-xs text-center text-gray-400 hover:text-gray-600 pt-2\"\r\n                        >\r\n                            Cancelar\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n        </>\r\n    );\r\n};\r\n\r\nexport default MonthlyHistoryTable;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\finance\\QuickViewPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\finance\\ScenarioSimulator.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":8,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":8,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[346,349],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[346,349],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useMemo } from 'react';\r\nimport { X, PlayCircle, RefreshCw, DollarSign, ShoppingBag, Users, TrendingUp, BookOpen, AlertCircle, Fuel, Target } from 'lucide-react';\r\nimport { formatMoney } from '../../../lib/finance';\r\n\r\ninterface ScenarioSimulatorProps {\r\n    isOpen: boolean;\r\n    onClose: () => void;\r\n    currentData: any; // The real month data to use as baseline\r\n}\r\n\r\n// Educational Content Constant\r\nconst FINANCIAL_RESOURCES = [\r\n    {\r\n        title: \"EBITDA vs Beneficio Neto\",\r\n        content: \"El EBITDA (Beneficio antes de Intereses, Impuestos, Depreciaciones y Amortizaciones) es clave en el delivery para medir la eficiencia operativa pura, ignorando la estructura de deuda o impuestos. Un EBITDA saludable en franquicias de reparto deber√≠a rondar el 15-20%.\",\r\n        icon: Target\r\n    },\r\n    {\r\n        title: \"Optimizaci√≥n del Cash Flow\",\r\n        content: \"En el reparto, el Cash Flow mata m√°s negocios que la falta de rentabilidad. Vigila los ciclos de pago de las plataformas (15-30 d√≠as) vs tus pagos a riders (mensual/semanal). Mant√©n un fondo de maniobra de al menos 1.5 meses de gastos operativos.\",\r\n        icon: DollarSign\r\n    },\r\n    {\r\n        title: \"Ratio de Eficiencia Laboral\",\r\n        content: \"Tu coste laboral total (Salarios + SS) no deber√≠a superar el 65-70% de tus ingresos netos. Si superas este umbral, revisa la eficiencia de tus riders (pedidos/hora). El objetivo es maximizar horas activas vs horas valle.\",\r\n        icon: Users\r\n    },\r\n    {\r\n        title: \"Costes Variables vs Fijos\",\r\n        content: \"El delivery es un negocio de volumen. Tus costes fijos (alquiler, gestor√≠a) se diluyen con cada pedido extra. Sin embargo, vigila los costes variables 'ocultos' como reparaciones de motos o gasolina. Un aumento del 10% en gasolina puede comerse un 2% de tu margen neto.\",\r\n        icon: Fuel\r\n    }\r\n];\r\n\r\nconst ScenarioSimulator: React.FC<ScenarioSimulatorProps> = ({ isOpen, onClose, currentData }) => {\r\n    const [activeTab, setActiveTab] = useState<'simulation' | 'resources'>('simulation');\r\n\r\n    // --- LEVERS ---\r\n    const [volumeDelta, setVolumeDelta] = useState(0); // -30% to +50%\r\n    const [ticketDelta, setTicketDelta] = useState(0); // -2‚Ç¨ to +5‚Ç¨\r\n    const [staffDelta, setStaffDelta] = useState(0); // -2 to +5 riders\r\n    const [variableCostDelta, setVariableCostDelta] = useState(0); // Efficiency in variable costs (-10% to +20%)\r\n\r\n    // --- CALCULATIONS (using useMemo for derived state) ---\r\n    const { results, warnings } = useMemo(() => {\r\n        if (!currentData) return {\r\n            results: { revenue: 0, expenses: 0, netProfit: 0, margin: 0, breakEven: 0 },\r\n            warnings: []\r\n        };\r\n\r\n        // 1. BASELINE EXTRACTION\r\n        const baseRevenue = currentData.revenue || currentData.totalIncome || 0;\r\n        const baseOrders = currentData.orders || 1; // Avoid div by 0\r\n        const baseTotalExpenses = currentData.totalExpenses || 0;\r\n\r\n        // Approximate breakdowns if not strictly provided\r\n        const baseLabor = currentData.salaries || (baseTotalExpenses * 0.60); // Default 60% labor if missing\r\n        const baseVariable = (baseTotalExpenses - baseLabor) * 0.40; // Approx 40% of non-labor is variable (gas, repairs)\r\n        const baseFixed = baseTotalExpenses - baseLabor - baseVariable;\r\n\r\n        const baseTicket = baseRevenue / baseOrders;\r\n        // Assume rough base riders count if not provided (e.g., 200 orders/rider/month)\r\n        const estimatedRiders = Math.max(2, Math.round(baseOrders / 300));\r\n\r\n        // 2. SIMULATION MATH\r\n        // New Volume\r\n        const simOrders = baseOrders * (1 + volumeDelta / 100);\r\n\r\n        // New Revenue\r\n        const simTicket = baseTicket + ticketDelta;\r\n        const simRevenue = simOrders * simTicket;\r\n\r\n        // New Expenses\r\n        // Labor: cost scales with staff delta. (BaseCost / BaseRiders) * (BaseRiders + Delta)\r\n        const costPerRider = baseLabor / estimatedRiders;\r\n        const simRiders = Math.max(1, estimatedRiders + staffDelta);\r\n        const simLabor = costPerRider * simRiders;\r\n\r\n        // Variable: specific efficiency lever applied to variable costs (fuel/repairs)\r\n        // Scale with volume FIRST, then apply efficiency delta\r\n        const rawVariable = (baseVariable / baseOrders) * simOrders;\r\n        const simVariable = rawVariable * (1 + variableCostDelta / 100);\r\n\r\n        // Fixed: Remains constant\r\n        const simFixed = baseFixed;\r\n\r\n        const simTotalExpenses = simLabor + simVariable + simFixed;\r\n        const simNetProfit = simRevenue - simTotalExpenses;\r\n        const simMargin = simRevenue > 0 ? (simNetProfit / simRevenue) * 100 : 0;\r\n\r\n        // Break Even (Orders needed to cover Fixed + Labor with current Contribution Margin)\r\n        // CM per order = Ticket - VariableCostPerOrder\r\n        const variableCostPerOrder = simVariable / simOrders;\r\n        const contributionMargin = simTicket - variableCostPerOrder;\r\n        const breakEvenOrders = contributionMargin > 0 ? (simFixed + simLabor) / contributionMargin : 99999;\r\n\r\n        // 3. WARNINGS / INSIGHTS\r\n        const newWarnings = [];\r\n        // Saturation Check: If volume up > 20% but staff same/down -> High Risk\r\n        if (volumeDelta > 20 && staffDelta <= 0) {\r\n            newWarnings.push(\"ALERTA DE SATURACI√ìN: Aumento de pedidos sin a√±adir riders puede colapsar el servicio.\");\r\n        }\r\n        // Profitability Check\r\n        if (simMargin < 5) {\r\n            newWarnings.push(\"MARGEN CR√çTICO: El beneficio neto es inferior al 5%. Riesgo financiero alto.\");\r\n        }\r\n\r\n        return {\r\n            results: {\r\n                revenue: simRevenue,\r\n                expenses: simTotalExpenses,\r\n                netProfit: simNetProfit,\r\n                margin: simMargin,\r\n                breakEven: breakEvenOrders\r\n            },\r\n            warnings: newWarnings\r\n        };\r\n\r\n    }, [currentData, volumeDelta, ticketDelta, staffDelta, variableCostDelta]);\r\n\r\n    if (!isOpen) return null;\r\n\r\n    const baselineNet = (currentData?.revenue || 0) - (currentData?.totalExpenses || 0);\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-950/90 backdrop-blur-sm animate-in fade-in duration-300\">\r\n            <div className=\"bg-slate-900 border border-slate-700 w-full max-w-5xl shadow-2xl rounded-3xl overflow-hidden flex flex-col max-h-[90vh]\">\r\n\r\n                {/* HEADER */}\r\n                <div className=\"p-6 border-b border-slate-800 flex justify-between items-center bg-slate-800/50\">\r\n                    <div className=\"flex items-center gap-4\">\r\n                        <div className=\"p-3 bg-indigo-500/20 rounded-2xl border border-indigo-500/30\">\r\n                            <PlayCircle className=\"w-8 h-8 text-indigo-400\" />\r\n                        </div>\r\n                        <div>\r\n                            <h2 className=\"text-2xl font-black text-white tracking-tight\">Simulador Financiero Pro</h2>\r\n                            <p className=\"text-sm text-slate-400 font-medium\">Modelado avanzado para franquicias de reparto</p>\r\n                        </div>\r\n                    </div>\r\n                    <div className=\"flex items-center gap-4\">\r\n                        <div className=\"flex bg-slate-800 p-1 rounded-xl border border-slate-700\">\r\n                            <button\r\n                                onClick={() => setActiveTab('simulation')}\r\n                                className={`px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all ${activeTab === 'simulation' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}\r\n                            >\r\n                                Simulaci√≥n\r\n                            </button>\r\n                            <button\r\n                                onClick={() => setActiveTab('resources')}\r\n                                className={`px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all ${activeTab === 'resources' ? 'bg-emerald-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}\r\n                            >\r\n                                Recursos\r\n                            </button>\r\n                        </div>\r\n                        <button onClick={onClose} className=\"p-2 hover:bg-slate-800 rounded-full text-slate-500 transition-colors\">\r\n                            <X className=\"w-6 h-6\" />\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* CONTENT */}\r\n                <div className=\"flex-1 overflow-y-auto bg-slate-900/50 p-8\">\r\n\r\n                    {activeTab === 'simulation' ? (\r\n                        <div className=\"grid grid-cols-1 lg:grid-cols-12 gap-8 h-full\">\r\n\r\n                            {/* LEFT: CONTROLS */}\r\n                            <div className=\"lg:col-span-4 space-y-8 pr-2\">\r\n                                <h3 className=\"text-xs font-bold text-slate-500 uppercase tracking-widest border-b border-slate-800 pb-2\">Variables Operativas</h3>\r\n\r\n                                {/* Control 1: Volumen */}\r\n                                <div className=\"space-y-3\">\r\n                                    <div className=\"flex justify-between\">\r\n                                        <label className=\"text-sm font-bold text-slate-300 flex items-center gap-2\">\r\n                                            <ShoppingBag className=\"w-4 h-4 text-blue-400\" /> Volumen Pedidos\r\n                                        </label>\r\n                                        <span className={`text-xs font-mono font-bold ${volumeDelta > 0 ? 'text-emerald-400' : 'text-slate-400'}`}>{volumeDelta > 0 ? '+' : ''}{volumeDelta}%</span>\r\n                                    </div>\r\n                                    <input type=\"range\" min=\"-30\" max=\"50\" step=\"5\" value={volumeDelta} onChange={(e) => setVolumeDelta(Number(e.target.value))} className=\"w-full h-2 bg-slate-800 rounded-lg accent-blue-500 cursor-pointer\" />\r\n                                </div>\r\n\r\n                                {/* Control 2: Ticket */}\r\n                                <div className=\"space-y-3\">\r\n                                    <div className=\"flex justify-between\">\r\n                                        <label className=\"text-sm font-bold text-slate-300 flex items-center gap-2\">\r\n                                            <DollarSign className=\"w-4 h-4 text-emerald-400\" /> Ticket Medio\r\n                                        </label>\r\n                                        <span className={`text-xs font-mono font-bold ${ticketDelta > 0 ? 'text-emerald-400' : 'text-slate-400'}`}>{ticketDelta > 0 ? '+' : ''}{ticketDelta}‚Ç¨</span>\r\n                                    </div>\r\n                                    <input type=\"range\" min=\"-2\" max=\"5\" step=\"0.5\" value={ticketDelta} onChange={(e) => setTicketDelta(Number(e.target.value))} className=\"w-full h-2 bg-slate-800 rounded-lg accent-emerald-500 cursor-pointer\" />\r\n                                </div>\r\n\r\n                                {/* Control 3: Staffing */}\r\n                                <div className=\"space-y-3\">\r\n                                    <div className=\"flex justify-between\">\r\n                                        <label className=\"text-sm font-bold text-slate-300 flex items-center gap-2\">\r\n                                            <Users className=\"w-4 h-4 text-indigo-400\" /> Flota (Riders)\r\n                                        </label>\r\n                                        <span className={`text-xs font-mono font-bold ${staffDelta > 0 ? 'text-rose-400' : 'text-emerald-400'}`}>{staffDelta > 0 ? '+' : ''}{staffDelta}</span>\r\n                                    </div>\r\n                                    <input type=\"range\" min=\"-3\" max=\"5\" step=\"1\" value={staffDelta} onChange={(e) => setStaffDelta(Number(e.target.value))} className=\"w-full h-2 bg-slate-800 rounded-lg accent-indigo-500 cursor-pointer\" />\r\n                                    <p className=\"text-[10px] text-slate-500\">M√°s riders aumentan el coste fijo, pero evitan saturaci√≥n.</p>\r\n                                </div>\r\n\r\n                                {/* Control 4: Variable Efficiency */}\r\n                                <div className=\"space-y-3\">\r\n                                    <div className=\"flex justify-between\">\r\n                                        <label className=\"text-sm font-bold text-slate-300 flex items-center gap-2\">\r\n                                            <Fuel className=\"w-4 h-4 text-amber-400\" /> Costes Variables (Motos/Gas)\r\n                                        </label>\r\n                                        <span className={`text-xs font-mono font-bold ${variableCostDelta < 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{variableCostDelta > 0 ? '+' : ''}{variableCostDelta}%</span>\r\n                                    </div>\r\n                                    <input type=\"range\" min=\"-20\" max=\"20\" step=\"1\" value={variableCostDelta} onChange={(e) => setVariableCostDelta(Number(e.target.value))} className=\"w-full h-2 bg-slate-800 rounded-lg accent-amber-500 cursor-pointer\" />\r\n                                    <p className=\"text-[10px] text-slate-500\">Ajusta gastos de mantenimiento y consumo de combustible.</p>\r\n                                </div>\r\n\r\n                                <button onClick={() => { setVolumeDelta(0); setTicketDelta(0); setStaffDelta(0); setVariableCostDelta(0); }} className=\"w-full py-3 rounded-xl border border-slate-700 text-slate-400 hover:bg-slate-800 hover:text-white text-xs font-bold uppercase transition-all flex items-center justify-center gap-2\">\r\n                                    <RefreshCw className=\"w-4 h-4\" /> Resetear Valores\r\n                                </button>\r\n                            </div>\r\n\r\n                            {/* RIGHT: DASHBOARD */}\r\n                            <div className=\"lg:col-span-8 space-y-6\">\r\n                                {/* Top KPIs */}\r\n                                <div className=\"grid grid-cols-2 gap-4\">\r\n                                    <div className=\"bg-slate-800/50 rounded-2xl p-5 border border-slate-700\">\r\n                                        <p className=\"text-xs font-bold text-slate-500 uppercase\">Resultado Actual</p>\r\n                                        <div className=\"text-3xl font-mono text-slate-400 mt-1\">{formatMoney(baselineNet)}‚Ç¨</div>\r\n                                        <div className=\"text-xs text-slate-500 mt-2\">Margen Real</div>\r\n                                    </div>\r\n                                    <div className={`rounded-2xl p-5 border transition-colors duration-300 ${results.netProfit >= baselineNet ? 'bg-emerald-500/10 border-emerald-500/30' : 'bg-rose-500/10 border-rose-500/30'}`}>\r\n                                        <p className={`text-xs font-bold uppercase ${results.netProfit >= baselineNet ? 'text-emerald-400' : 'text-rose-400'}`}>Resultado Simulado</p>\r\n                                        <div className={`text-4xl font-black font-mono mt-1 ${results.netProfit >= baselineNet ? 'text-emerald-300' : 'text-rose-300'}`}>\r\n                                            {formatMoney(results.netProfit)}‚Ç¨\r\n                                        </div>\r\n                                        <div className=\"flex gap-4 mt-2\">\r\n                                            <span className={`text-xs font-bold px-2 py-0.5 rounded ${results.margin >= 10 ? 'bg-emerald-500/20 text-emerald-300' : 'bg-amber-500/20 text-amber-300'}`}>\r\n                                                Margen: {results.margin.toFixed(1)}%\r\n                                            </span>\r\n                                            <span className=\"text-xs text-slate-400 flex items-center gap-1\">\r\n                                                <Target className=\"w-3 h-3\" /> Break-even: {Math.round(results.breakEven)} pedidos\r\n                                            </span>\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n\r\n                                {/* Warnings Area */}\r\n                                {warnings.length > 0 && (\r\n                                    <div className=\"space-y-2\">\r\n                                        {warnings.map((w, i) => (\r\n                                            <div key={i} className=\"bg-amber-500/10 border border-amber-500/20 text-amber-200 px-4 py-3 rounded-xl flex items-center gap-3 text-sm font-medium animate-in slide-in-from-top-2\">\r\n                                                <AlertCircle className=\"w-5 h-5 text-amber-500 flex-shrink-0\" />\r\n                                                {w}\r\n                                            </div>\r\n                                        ))}\r\n                                    </div>\r\n                                )}\r\n\r\n                                {/* Graph / Visualizer Placeholder */}\r\n                                <div className=\"bg-slate-800/30 rounded-2xl p-6 border border-slate-800 h-48 flex items-center justify-center relative overflow-hidden group\">\r\n                                    <div className=\"absolute inset-0 bg-gradient-to-r from-indigo-500/5 to-emerald-500/5 group-hover:opacity-100 opacity-50 transition-opacity\" />\r\n                                    <div className=\"text-center relative z-10\">\r\n                                        <TrendingUp className=\"w-12 h-12 text-slate-700 mx-auto mb-3\" />\r\n                                        <p className=\"text-slate-500 text-sm font-medium\">Proyecci√≥n de Ingresos vs Gastos</p>\r\n                                        <div className=\"mt-4 flex items-center justify-center gap-8\">\r\n                                            <div className=\"text-center\">\r\n                                                <div className=\"text-xs text-slate-500 uppercase\">Ingresos</div>\r\n                                                <div className=\"text-lg font-bold text-white\">{formatMoney(results.revenue)}‚Ç¨</div>\r\n                                            </div>\r\n                                            <div className=\"h-8 w-px bg-slate-700\" />\r\n                                            <div className=\"text-center\">\r\n                                                <div className=\"text-xs text-slate-500 uppercase\">Gastos</div>\r\n                                                <div className=\"text-lg font-bold text-rose-300\">{formatMoney(results.expenses)}‚Ç¨</div>\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n\r\n                            </div>\r\n                        </div>\r\n                    ) : (\r\n                        // RESOURCES TAB\r\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6 animate-in fade-in slide-in-from-right-4\">\r\n                            {FINANCIAL_RESOURCES.map((res, idx) => (\r\n                                <div key={idx} className=\"bg-slate-800 border border-slate-700 rounded-2xl p-6 hover:border-indigo-500/50 hover:bg-slate-800/80 transition-all group\">\r\n                                    <div className=\"flex items-start gap-4\">\r\n                                        <div className=\"p-3 rounded-xl bg-slate-900 border border-slate-700 group-hover:border-indigo-500/50 transition-colors\">\r\n                                            <res.icon className=\"w-6 h-6 text-indigo-400 group-hover:text-indigo-300\" />\r\n                                        </div>\r\n                                        <div>\r\n                                            <h4 className=\"text-lg font-bold text-white mb-2 group-hover:text-indigo-200 transition-colors\">{res.title}</h4>\r\n                                            <p className=\"text-sm text-slate-400 leading-relaxed\">{res.content}</p>\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n                            ))}\r\n                            <div className=\"col-span-1 md:col-span-2 mt-4 p-6 bg-indigo-600/10 border border-indigo-500/20 rounded-2xl flex items-center justify-between\">\r\n                                <div>\r\n                                    <h4 className=\"text-indigo-300 font-bold mb-1\">¬øNecesitas un an√°lisis m√°s profundo?</h4>\r\n                                    <p className=\"text-indigo-200/60 text-sm\">Descarga el manual completo de finanzas para franquiciados.</p>\r\n                                </div>\r\n                                <button className=\"px-6 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg text-xs font-bold uppercase tracking-wider flex items-center gap-2 transition-colors\">\r\n                                    <BookOpen className=\"w-4 h-4\" />\r\n                                    Descargar PDF\r\n                                </button>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default ScenarioSimulator;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\finance\\SmartInsightsWidget.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":8,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":8,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[297,300],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[297,300],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":18,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":18,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[526,529],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[526,529],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":19,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":19,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[547,550],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[547,550],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":32,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":32,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[801,804],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[801,804],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":137,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":137,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5462,5465],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5462,5465],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":151,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":151,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6146,6149],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6146,6149],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":162,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":162,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6680,6683],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6680,6683],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\nimport { AlertTriangle, CheckCircle, Search, TrendingUp, Brain, Zap, Target, Activity } from 'lucide-react';\r\nimport { formatMoney } from '../../../lib/finance';\r\n\r\ninterface SmartInsightsProps {\r\n    mode?: 'franchise' | 'admin';\r\n    // Franchise Props\r\n    report?: any;\r\n    revenue?: number;\r\n    orders?: number;\r\n    // Admin Props\r\n    stats?: {\r\n        totalRevenue: number;\r\n        totalProfit: number;\r\n        margin: number;\r\n        franchiseCount: number;\r\n    };\r\n    trendData?: any[];\r\n    alerts?: any[];\r\n}\r\n\r\nconst SmartInsightsWidget: React.FC<SmartInsightsProps> = ({\r\n    mode = 'franchise',\r\n    report,\r\n    revenue = 0,\r\n    orders = 0,\r\n    stats,\r\n    trendData,\r\n    alerts\r\n}) => {\r\n    // --- LOGIC: THE DETECTIVE ---\r\n    const insights: any[] = [];\r\n\r\n    // ==========================================\r\n    // üõ°Ô∏è ADMIN MODE LOGIC\r\n    // ==========================================\r\n    if (mode === 'admin') {\r\n        if (stats) {\r\n            // 1. PROJECTED REVENUE (New \"Powerful\" Feature)\r\n            // Simple extrapolation: (Revenue / Day) * TotalDays\r\n            const today = new Date();\r\n            const dayOfMonth = today.getDate();\r\n            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();\r\n\r\n            if (dayOfMonth > 5) { // Only project after day 5 for stability\r\n                const projected = (stats.totalRevenue / dayOfMonth) * daysInMonth;\r\n\r\n                // Let's just show the projection info\r\n                insights.push({\r\n                    type: 'info',\r\n                    title: 'Proyecci√≥n de Cierre',\r\n                    message: `Al ritmo actual, cerrar√°s el mes en ~${formatMoney(projected)}‚Ç¨.`,\r\n                    icon: <Target className=\"w-4 h-4 text-indigo-400\" />\r\n                });\r\n            }\r\n\r\n            // 2. MARGIN CHECK (Network Wide)\r\n            if (stats.margin < 12) {\r\n                insights.push({\r\n                    type: 'warning',\r\n                    title: 'Margen de Red Bajo',\r\n                    message: `Promedio global: ${stats.margin.toFixed(1)}%. Objetivo: >15%.`,\r\n                    icon: <TrendingUp className=\"w-4 h-4 text-amber-500\" />\r\n                });\r\n            } else if (stats.margin > 18) {\r\n                insights.push({\r\n                    type: 'success',\r\n                    title: 'Rentabilidad Alta',\r\n                    message: `Margen de red excelente: ${stats.margin.toFixed(1)}%.`,\r\n                    icon: <CheckCircle className=\"w-4 h-4 text-emerald-500\" />\r\n                });\r\n            }\r\n\r\n            // 3. REVENUE TREND\r\n            if (trendData && trendData.length >= 2) {\r\n                const current = trendData[trendData.length - 1].value;\r\n                const previous = trendData[trendData.length - 2].value;\r\n                const growth = ((current - previous) / previous) * 100;\r\n\r\n                if (growth > 10) {\r\n                    insights.push({\r\n                        type: 'success',\r\n                        title: 'Crecimiento Acelerado',\r\n                        message: `+${growth.toFixed(0)}% vs mes anterior. Tendencia positiva.`,\r\n                        icon: <TrendingUp className=\"w-4 h-4 text-emerald-500\" />\r\n                    });\r\n                } else if (growth < -10) {\r\n                    insights.push({\r\n                        type: 'warning',\r\n                        title: 'Desaceleraci√≥n',\r\n                        message: `Ca√≠da del ${Math.abs(growth).toFixed(0)}% en facturaci√≥n vs mes anterior.`,\r\n                        icon: <TrendingUp className=\"w-4 h-4 text-rose-500 rotate-90\" />\r\n                    });\r\n                }\r\n            }\r\n        }\r\n\r\n        // 4. SYSTEM ALERTS & EFFICIENCY\r\n        if (alerts && alerts.length > 0) {\r\n            insights.push({\r\n                type: 'warning',\r\n                title: 'Atenci√≥n Requerida',\r\n                message: `${alerts.length} incidencias cr√≠ticas en la red.`,\r\n                icon: <AlertTriangle className=\"w-4 h-4 text-rose-400\" />\r\n            });\r\n        }\r\n\r\n    } else {\r\n        // ==========================================\r\n        // üè™ FRANCHISE MODE LOGIC (Existing + Enhanced)\r\n        // ==========================================\r\n        if (!report || !report.breakdown) return null;\r\n\r\n        // 1. ORDER VOLUME & TICKET ANALYSIS (New)\r\n        if (orders > 0 && revenue > 0) {\r\n            const avgTicket = revenue / orders;\r\n\r\n            // Insight: High Volume vs High Ticket\r\n            if (avgTicket < 5 && orders > 2000) {\r\n                insights.push({\r\n                    type: 'info',\r\n                    title: 'Volumen Alto / Ticket Bajo',\r\n                    message: `Ticket medio bajo (${avgTicket.toFixed(2)}‚Ç¨). El negocio depende del volumen masivo.`,\r\n                    icon: <Activity className=\"w-4 h-4 text-blue-400\" />\r\n                });\r\n            } else if (avgTicket > 6) {\r\n                insights.push({\r\n                    type: 'success',\r\n                    title: 'Ticket Medio Saludable',\r\n                    message: `Excelente ticket medio de ${avgTicket.toFixed(2)}‚Ç¨. Maximiza cada entrega.`,\r\n                    icon: <TrendingUp className=\"w-4 h-4 text-emerald-500\" />\r\n                });\r\n            }\r\n        }\r\n\r\n        // 2. FUEL CHECK (Gasoline)\r\n        const fuelExpense = report.breakdown.find((i: any) => i.id === 'fuel' || i.name.toLowerCase().includes('gasolina') || i.name.toLowerCase().includes('combustible'));\r\n        if (fuelExpense && revenue > 0) {\r\n            const fuelRatio = (fuelExpense.value / revenue) * 100;\r\n            if (fuelRatio > 8) {\r\n                insights.push({\r\n                    type: 'warning',\r\n                    title: 'Exceso en Combustible',\r\n                    message: `Gasto: ${fuelRatio.toFixed(1)}% (Obj: <5%). Revisa rutas.`,\r\n                    icon: <Zap className=\"w-4 h-4 text-amber-500\" />\r\n                });\r\n            }\r\n        }\r\n\r\n        // 3. REPAIRS CHECK\r\n        const repairExpense = report.breakdown.find((i: any) => i.id === 'repairs' || i.name.toLowerCase().includes('reparaci'));\r\n        if (repairExpense && repairExpense.value > 300) {\r\n            insights.push({\r\n                type: 'warning',\r\n                title: 'Pico en Taller',\r\n                message: `Gasto inusual de ${formatMoney(repairExpense.value)}‚Ç¨ en reparaciones.`,\r\n                icon: <AlertTriangle className=\"w-4 h-4 text-rose-500\" />\r\n            });\r\n        }\r\n\r\n        // 4. ANOMALY IN \"OTHERS\"\r\n        const otherExpense = report.breakdown.find((i: any) => i.id === 'other' || i.name.toLowerCase().includes('otros'));\r\n        if (otherExpense && otherExpense.value > 500) {\r\n            insights.push({\r\n                type: 'info',\r\n                title: 'Auditor√≠a Sugerida',\r\n                message: `Categor√≠a \"Otros\" excesiva (${formatMoney(otherExpense.value)}‚Ç¨). Desglosar.`,\r\n                icon: <Search className=\"w-4 h-4 text-blue-400\" />\r\n            });\r\n        }\r\n\r\n\r\n\r\n        // 6. PROFITABILITY\r\n        if (report.taxes && report.taxes.margin > 18) {\r\n            insights.push({\r\n                type: 'success',\r\n                title: 'Franquicia Top Performer',\r\n                message: `Margen neto del ${report.taxes.margin.toFixed(1)}%. ¬°Excelente gesti√≥n!`,\r\n                icon: <CheckCircle className=\"w-4 h-4 text-emerald-500\" />\r\n            });\r\n        }\r\n    }\r\n\r\n    // HAPPY STATE\r\n    if (insights.length === 0) {\r\n        return (\r\n            <div className=\"bg-white dark:bg-slate-900/50 border border-slate-200 dark:border-slate-800/60 rounded-3xl p-6 backdrop-blur-md h-full flex flex-col justify-between group shadow-sm dark:shadow-none transition-colors\">\r\n                <div className=\"flex items-center gap-3\">\r\n                    <div className=\"p-2 bg-emerald-500/10 rounded-xl group-hover:bg-emerald-500/20 transition-colors\">\r\n                        <CheckCircle className=\"w-5 h-5 text-emerald-600 dark:text-emerald-400\" />\r\n                    </div>\r\n                    <div>\r\n                        <h3 className=\"text-sm font-bold text-slate-900 dark:text-slate-200 transition-colors\">Sistema Optimizado</h3>\r\n                        <p className=\"text-[10px] text-slate-400 dark:text-slate-500 font-medium transition-colors\">Sin anomal√≠as detectadas</p>\r\n                    </div>\r\n                </div>\r\n                {/* Visual decoration */}\r\n                <div className=\"h-12 flex items-end justify-center gap-1 opacity-20\">\r\n                    <div className=\"w-1 h-4 bg-emerald-400 rounded-t\" />\r\n                    <div className=\"w-1 h-6 bg-emerald-400 rounded-t\" />\r\n                    <div className=\"w-1 h-8 bg-emerald-400 rounded-t\" />\r\n                    <div className=\"w-1 h-5 bg-emerald-400 rounded-t\" />\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"bg-white dark:bg-slate-900/50 border border-slate-200 dark:border-slate-800/60 rounded-3xl p-5 backdrop-blur-md h-full overflow-hidden flex flex-col relative group hover:border-indigo-300 dark:hover:border-indigo-500/30 transition-all shadow-sm dark:shadow-none\">\r\n            {/* Glowing header effect (subtle) */}\r\n            <div className=\"absolute top-0 left-0 w-full h-px bg-gradient-to-r from-transparent via-indigo-500/50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity\" />\r\n\r\n            <div className=\"flex items-center gap-3 mb-4 shrink-0\">\r\n                <div className=\"p-2 bg-indigo-500/10 rounded-xl text-indigo-600 dark:text-indigo-400 group-hover:text-white group-hover:bg-indigo-600 transition-all shadow-[0_0_15px_rgba(99,102,241,0.05)] group-hover:shadow-[0_0_20px_rgba(99,102,241,0.2)]\">\r\n                    <Brain className=\"w-5 h-5\" />\r\n                </div>\r\n                <div>\r\n                    <h3 className=\"text-sm font-bold text-slate-900 dark:text-slate-200 group-hover:text-white transition-colors\">Smart Insights</h3>\r\n                    <p className=\"text-[10px] text-slate-500 dark:text-slate-500 font-medium\">\r\n                        {mode === 'admin' ? 'Inteligencia de Red' : 'Auditor√≠a Autom√°tica'}\r\n                    </p>\r\n                </div>\r\n            </div>\r\n\r\n            <div className=\"space-y-2 overflow-y-auto custom-scrollbar pr-1 -mr-2\">\r\n                {insights.map((insight, idx) => (\r\n                    <div key={idx} className={`p-3 rounded-xl border flex items-start gap-3 transition-all hover:translate-x-1 ${insight.type === 'warning' ? 'bg-amber-50 dark:bg-amber-500/5 border-amber-200 dark:border-amber-500/20 hover:border-amber-500' :\r\n                        insight.type === 'success' ? 'bg-emerald-50 dark:bg-emerald-500/5 border-emerald-200 dark:border-emerald-500/20 hover:border-emerald-500' :\r\n                            insight.type === 'info' ? 'bg-blue-50 dark:bg-blue-500/5 border-blue-200 dark:border-blue-500/20 hover:border-blue-500' :\r\n                                'bg-slate-50 dark:bg-slate-800/30 border-slate-200 dark:border-slate-700'\r\n                        }`}>\r\n                        <div className=\"mt-0.5 shrink-0\">\r\n                            {insight.icon}\r\n                        </div>\r\n                        <div>\r\n                            <p className={`text-xs font-bold mb-0.5 ${insight.type === 'warning' ? 'text-amber-600 dark:text-amber-400' :\r\n                                insight.type === 'success' ? 'text-emerald-600 dark:text-emerald-400' :\r\n                                    insight.type === 'info' ? 'text-blue-600 dark:text-blue-400' :\r\n                                        'text-slate-700 dark:text-slate-300'\r\n                                }`}>\r\n                                {insight.title}\r\n                            </p>\r\n                            <p className=\"text-[11px] text-slate-600 dark:text-slate-400 leading-snug\">\r\n                                {insight.message}\r\n                            </p>\r\n                        </div>\r\n                    </div>\r\n                ))}\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default SmartInsightsWidget;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\finance\\TaxVaultWidget.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\finance\\types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\steps\\ExpenseStep.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":29,"column":92,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":29,"endColumn":95,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1070,1073],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1070,1073],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":52,"column":112,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":52,"endColumn":115,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2305,2308],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2305,2308],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useMemo, useState } from 'react';\r\nimport {\r\n    Users, Fuel, Briefcase, Bike, Shield,\r\n    Smartphone, Megaphone, MoreHorizontal,\r\n    TrendingUp, AlertTriangle, PieChart as PieIcon,\r\n    ChevronDown, ChevronRight, CheckCircle2\r\n} from 'lucide-react';\r\nimport { formatMoney } from '../../../lib/finance';\r\nimport { ExpenseData, RentingData } from '../types';\r\nimport { PieChart, Pie, Cell, ResponsiveContainer, Tooltip as RechartsTooltip, Legend } from 'recharts';\r\n\r\ninterface ExpenseStepProps {\r\n    data: ExpenseData;\r\n    onChange: (data: ExpenseData) => void;\r\n    total: number;\r\n    totalHours: number;\r\n    onTotalHoursChange: (val: number) => void;\r\n}\r\n\r\n// --- COLORS & CONFIG ---\r\nconst CATEGORY_COLORS = {\r\n    team: '#6366f1',    // Indigo (Payroll)\r\n    fleet: '#f43f5e',   // Rose (Motos, Gas, Repairs)\r\n    services: '#10b981', // Emerald (Professional Services)\r\n    ops: '#f59e0b'      // Amber (Marketing, App, Others)\r\n};\r\n\r\n// Input Helper\r\nconst InputRow = ({ label, icon: Icon, value, onChange, placeholder = \"0\", suffix = \"‚Ç¨\" }: any) => (\r\n    <div className=\"flex items-center justify-between p-3 bg-slate-900/50 rounded-lg hover:bg-slate-900 transition-colors border border-transparent hover:border-slate-700 group\">\r\n        <div className=\"flex items-center gap-3\">\r\n            <div className={`p-2 rounded-lg bg-slate-800 text-slate-400 group-hover:text-white transition-colors`}>\r\n                <Icon className=\"w-4 h-4\" />\r\n            </div>\r\n            <span className=\"text-sm text-slate-300 font-medium\">{label}</span>\r\n        </div>\r\n        <div className=\"flex items-center gap-2\">\r\n            <input\r\n                type=\"number\"\r\n                min=\"0\"\r\n                placeholder={placeholder}\r\n                value={value || ''}\r\n                onChange={(e) => onChange(parseFloat(e.target.value) || 0)}\r\n                className=\"w-24 bg-transparent text-right text-white font-bold focus:outline-none focus:border-b border-indigo-500 transition-all font-mono\"\r\n            />\r\n            <span className=\"text-xs text-slate-500 font-bold w-4\">{suffix}</span>\r\n        </div>\r\n    </div>\r\n);\r\n\r\n// Section Toggle Helper\r\nconst SectionHeader = ({ id, title, icon: Icon, color, total: sectionTotal, activeSection, setActiveSection }: any) => (\r\n    <button\r\n        onClick={() => setActiveSection(activeSection === id ? null : id)}\r\n        className={`w-full flex items-center justify-between p-4 rounded-xl border transition-all duration-300 ${activeSection === id\r\n            ? `bg-slate-900 border-${color}-500/50 shadow-lg shadow-${color}-500/10`\r\n            : 'bg-slate-950/50 border-slate-800 hover:border-slate-700'\r\n            }`}\r\n    >\r\n        <div className=\"flex items-center gap-4\">\r\n            <div className={`p-2.5 rounded-lg ${activeSection === id ? `bg-${color}-500 text-white` : `bg-slate-900 text-${color}-400`}`}>\r\n                <Icon className=\"w-5 h-5\" />\r\n            </div>\r\n            <div className=\"text-left\">\r\n                <h4 className={`font-bold ${activeSection === id ? 'text-white' : 'text-slate-300'}`}>{title}</h4>\r\n                <p className=\"text-xs text-slate-500\">{activeSection === id ? 'Edici√≥n activa' : 'Click para editar'}</p>\r\n            </div>\r\n        </div>\r\n        <div className=\"text-right\">\r\n            <span className={`block font-mono font-bold ${activeSection === id ? 'text-white' : 'text-slate-400'}`}>\r\n                {formatMoney(sectionTotal)}‚Ç¨\r\n            </span>\r\n            {activeSection === id ? <ChevronDown className=\"w-4 h-4 ml-auto mt-1 text-slate-500\" /> : <ChevronRight className=\"w-4 h-4 ml-auto mt-1 text-slate-500\" />}\r\n        </div>\r\n    </button>\r\n);\r\n\r\nconst ExpenseStep: React.FC<ExpenseStepProps> = ({ data, onChange, total, totalHours, onTotalHoursChange }) => {\r\n\r\n    const [activeSection, setActiveSection] = useState<string | null>('team');\r\n\r\n    const updateField = (field: keyof ExpenseData, value: number) => {\r\n        onChange({ ...data, [field]: value });\r\n    };\r\n\r\n    const updateRenting = (field: keyof RentingData, value: number) => {\r\n        onChange({\r\n            ...data,\r\n            renting: { ...data.renting, [field]: value }\r\n        });\r\n    };\r\n\r\n    // --- CALCULATIONS FOR CHART ---\r\n    const chartData = useMemo(() => {\r\n        const team = data.payroll + data.insurance;\r\n        const fleet = (data.renting.count * data.renting.pricePerUnit) + data.fuel + data.repairs;\r\n        const services = data.professionalServices + data.agencyFee + data.prlFee + data.accountingFee;\r\n        const ops = data.appFlyder + data.marketing + data.incidents + data.other + (data.royaltyPercent ? (total * (data.royaltyPercent / 100)) : 0);\r\n\r\n        return [\r\n            { name: 'Equipo', value: team, color: CATEGORY_COLORS.team },\r\n            { name: 'Flota', value: fleet, color: CATEGORY_COLORS.fleet },\r\n            { name: 'Servicios', value: services, color: CATEGORY_COLORS.services },\r\n            { name: 'Operativo', value: ops, color: CATEGORY_COLORS.ops },\r\n        ].filter(item => item.value > 0);\r\n    }, [data, total]);\r\n\r\n\r\n\r\n    return (\r\n        <div className=\"flex flex-col lg:flex-row gap-6 h-full text-slate-200\">\r\n\r\n            {/* LEFT COLUMN: INPUTS (Scrollable) */}\r\n            <div className=\"flex-1 space-y-4 lg:overflow-y-auto lg:pr-2 custom-scrollbar pb-20\">\r\n\r\n                {/* 1. TEAM SECTION */}\r\n                <div className=\"space-y-2\">\r\n                    <SectionHeader\r\n                        id=\"team\"\r\n                        title=\"Equipo Humano\"\r\n                        icon={Users}\r\n                        color=\"indigo\"\r\n                        total={data.payroll + data.insurance}\r\n                        activeSection={activeSection}\r\n                        setActiveSection={setActiveSection}\r\n                    />\r\n                    {activeSection === 'team' && (\r\n                        <div className=\"p-4 bg-slate-950/30 border border-slate-800/50 border-t-0 rounded-b-xl space-y-3 animate-in slide-in-from-top-2\">\r\n                            <InputRow label=\"N√≥minas (Neto)\" icon={Users} value={data.payroll} onChange={(v: number) => updateField('payroll', v)} />\r\n                            <InputRow label=\"Seguros Sociales\" icon={Shield} value={data.insurance} onChange={(v: number) => updateField('insurance', v)} />\r\n                            <div className=\"mt-4 p-3 bg-indigo-500/10 rounded-lg border border-indigo-500/20 flex items-center gap-3\">\r\n                                <AlertTriangle className=\"w-4 h-4 text-indigo-400\" />\r\n                                <p className=\"text-xs text-indigo-300\">\r\n                                    Recuerda: El coste de empresa suele ser un <strong>30-35%</strong> superior al neto.\r\n                                </p>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n\r\n                {/* 2. FLEET SECTION */}\r\n                <div className=\"space-y-2\">\r\n                    <SectionHeader\r\n                        id=\"fleet\"\r\n                        title=\"Flota y Transporte\"\r\n                        icon={Fuel}\r\n                        color=\"rose\"\r\n                        total={(data.renting.count * data.renting.pricePerUnit) + data.fuel + data.repairs}\r\n                        activeSection={activeSection}\r\n                        setActiveSection={setActiveSection}\r\n                    />\r\n                    {activeSection === 'fleet' && (\r\n                        <div className=\"p-4 bg-slate-950/30 border border-slate-800/50 border-t-0 rounded-b-xl space-y-3 animate-in slide-in-from-top-2\">\r\n                            <div className=\"grid grid-cols-2 gap-3 mb-2\">\r\n                                <div className=\"p-3 bg-slate-900/50 rounded-lg border border-slate-800\">\r\n                                    <label className=\"text-xs text-slate-500 font-bold block mb-1\">MOTOS</label>\r\n                                    <input\r\n                                        type=\"number\"\r\n                                        value={data.renting.count || ''}\r\n                                        onChange={(e) => updateRenting('count', parseFloat(e.target.value) || 0)}\r\n                                        className=\"w-full bg-transparent text-xl font-bold text-white focus:outline-none\"\r\n                                        placeholder=\"0\"\r\n                                    />\r\n                                </div>\r\n                                <div className=\"p-3 bg-slate-900/50 rounded-lg border border-slate-800\">\r\n                                    <label className=\"text-xs text-slate-500 font-bold block mb-1\">PRECIO/UNIDAD</label>\r\n                                    <input\r\n                                        type=\"number\"\r\n                                        value={data.renting.pricePerUnit || ''}\r\n                                        onChange={(e) => updateRenting('pricePerUnit', parseFloat(e.target.value) || 0)}\r\n                                        className=\"w-full bg-transparent text-xl font-bold text-white focus:outline-none\"\r\n                                        placeholder=\"0\"\r\n                                    />\r\n                                </div>\r\n                            </div>\r\n                            <InputRow label=\"Gasolina\" icon={Fuel} value={data.fuel} onChange={(v: number) => updateField('fuel', v)} />\r\n                            <InputRow label=\"Reparaciones\" icon={Bike} value={data.repairs} onChange={(v: number) => updateField('repairs', v)} />\r\n                        </div>\r\n                    )}\r\n                </div>\r\n\r\n                {/* 3. SERVICES SECTION */}\r\n                <div className=\"space-y-2\">\r\n                    <SectionHeader\r\n                        id=\"services\"\r\n                        title=\"Servicios Profesionales\"\r\n                        icon={Briefcase}\r\n                        color=\"emerald\"\r\n                        total={data.professionalServices + data.agencyFee + data.prlFee + data.accountingFee}\r\n                        activeSection={activeSection}\r\n                        setActiveSection={setActiveSection}\r\n                    />\r\n                    {activeSection === 'services' && (\r\n                        <div className=\"p-4 bg-slate-950/30 border border-slate-800/50 border-t-0 rounded-b-xl space-y-3 animate-in slide-in-from-top-2\">\r\n                            <InputRow label=\"Gestor√≠a\" icon={Briefcase} value={data.agencyFee} onChange={(v: number) => updateField('agencyFee', v)} />\r\n                            <InputRow label=\"PRL (Prevenci√≥n)\" icon={Shield} value={data.prlFee} onChange={(v: number) => updateField('prlFee', v)} />\r\n                            <InputRow label=\"Contabilidad\" icon={Briefcase} value={data.accountingFee} onChange={(v: number) => updateField('accountingFee', v)} />\r\n                            <InputRow label=\"Otros Servicios\" icon={MoreHorizontal} value={data.professionalServices} onChange={(v: number) => updateField('professionalServices', v)} />\r\n                        </div>\r\n                    )}\r\n                </div>\r\n\r\n                {/* 4. OPS & MARKETING */}\r\n                <div className=\"space-y-2\">\r\n                    <SectionHeader\r\n                        id=\"ops\"\r\n                        title=\"Marketing y Operativa\"\r\n                        icon={Megaphone}\r\n                        color=\"amber\"\r\n                        total={data.appFlyder + data.marketing + data.incidents + data.other}\r\n                        activeSection={activeSection}\r\n                        setActiveSection={setActiveSection}\r\n                    />\r\n                    {activeSection === 'ops' && (\r\n                        <div className=\"p-4 bg-slate-950/30 border border-slate-800/50 border-t-0 rounded-b-xl space-y-3 animate-in slide-in-from-top-2\">\r\n                            <InputRow label=\"Marketing Digital\" icon={Megaphone} value={data.marketing} onChange={(v: number) => updateField('marketing', v)} />\r\n                            <InputRow label=\"App Flyder\" icon={Smartphone} value={data.appFlyder} onChange={(v: number) => updateField('appFlyder', v)} />\r\n                            <InputRow label=\"Incidencias\" icon={AlertTriangle} value={data.incidents} onChange={(v: number) => updateField('incidents', v)} />\r\n                            <InputRow label=\"Otros Gastos\" icon={MoreHorizontal} value={data.other} onChange={(v: number) => updateField('other', v)} />\r\n\r\n                            <div className=\"my-4 pt-4 border-t border-slate-800\">\r\n                                <label className=\"text-xs font-bold text-amber-500 uppercase tracking-wider mb-2 block\">Royalty</label>\r\n                                <div className=\"flex items-center justify-between bg-slate-900/50 p-3 rounded-lg border border-amber-500/20\">\r\n                                    <span className=\"text-sm text-slate-300\">Porcentaje sobre Ventas</span>\r\n                                    <div className=\"flex items-center gap-2\">\r\n                                        <input\r\n                                            type=\"number\"\r\n                                            value={data.royaltyPercent || ''}\r\n                                            onChange={(e) => updateField('royaltyPercent', parseFloat(e.target.value))}\r\n                                            placeholder=\"5\"\r\n                                            className=\"w-16 bg-transparent text-right font-bold text-white border-b border-amber-500/50 focus:border-amber-500 focus:outline-none\"\r\n                                        />\r\n                                        <span className=\"text-amber-500 font-bold\">%</span>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n\r\n                {/* EXTRA: Total Hours */}\r\n                <div className=\"mt-8 p-4 bg-slate-900 rounded-xl border border-slate-800 flex items-center justify-between\">\r\n                    <div className=\"flex items-center gap-3\">\r\n                        <div className=\"p-2 bg-blue-500/10 rounded-full\">\r\n                            <TrendingUp className=\"w-5 h-5 text-blue-500\" />\r\n                        </div>\r\n                        <div>\r\n                            <h4 className=\"text-white font-bold\">Horas Operativas</h4>\r\n                            <p className=\"text-xs text-slate-400\">Total horas trabajadas por el equipo</p>\r\n                        </div>\r\n                    </div>\r\n                    <div className=\"flex items-center gap-2\">\r\n                        <input\r\n                            type=\"number\"\r\n                            value={totalHours || ''}\r\n                            onChange={(e) => onTotalHoursChange(parseFloat(e.target.value) || 0)}\r\n                            className=\"bg-slate-950 border border-slate-800 rounded-lg py-2 px-3 w-24 text-right font-mono font-bold text-white focus:ring-2 focus:ring-blue-500 focus:outline-none\"\r\n                            placeholder=\"0\"\r\n                        />\r\n                        <span className=\"text-xs font-bold text-slate-500\">H</span>\r\n                    </div>\r\n                </div>\r\n\r\n            </div>\r\n\r\n            {/* RIGHT COLUMN: VISUALIZATIONS (Sticky) */}\r\n            <div className=\"w-full lg:w-[380px] space-y-6\">\r\n\r\n                {/* 1. TOTAL CARD */}\r\n                <div className=\"bg-gradient-to-br from-slate-900 to-slate-950 p-6 rounded-2xl border border-slate-800 shadow-2xl relative overflow-hidden\">\r\n                    <div className=\"absolute top-0 right-0 p-4 opacity-10\">\r\n                        <PieIcon className=\"w-32 h-32 text-indigo-500\" />\r\n                    </div>\r\n                    <p className=\"text-slate-400 text-sm font-medium uppercase tracking-wider mb-1\">Total Gastos</p>\r\n                    <h2 className=\"text-4xl font-black text-white tracking-tight mb-2\">\r\n                        {formatMoney(total)}‚Ç¨\r\n                    </h2>\r\n                    <div className=\"flex items-center gap-2 text-xs font-medium text-slate-400 bg-slate-900/50 w-fit px-3 py-1.5 rounded-full border border-slate-800\">\r\n                        <CheckCircle2 className=\"w-3.5 h-3.5 text-emerald-500\" />\r\n                        IVA Estimadoo: {formatMoney(total * 0.21)}‚Ç¨ approx\r\n                    </div>\r\n                </div>\r\n\r\n                {/* 2. CHART */}\r\n                <div className=\"bg-slate-900/50 p-6 rounded-2xl border border-slate-800 h-[320px] relative\">\r\n                    <h3 className=\"text-sm font-bold text-white mb-4\">Distribuci√≥n de Gastos</h3>\r\n                    {total > 0 ? (\r\n                        <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n                            <PieChart>\r\n                                <Pie\r\n                                    data={chartData}\r\n                                    cx=\"50%\"\r\n                                    cy=\"50%\"\r\n                                    innerRadius={60}\r\n                                    outerRadius={80}\r\n                                    paddingAngle={5}\r\n                                    dataKey=\"value\"\r\n                                >\r\n                                    {chartData.map((entry, index) => (\r\n                                        <Cell key={`cell-${index}`} fill={entry.color} stroke=\"rgba(0,0,0,0.2)\" />\r\n                                    ))}\r\n                                </Pie>\r\n                                <RechartsTooltip\r\n                                    formatter={(value: number) => formatMoney(value) + '‚Ç¨'}\r\n                                    contentStyle={{ backgroundColor: '#0f172a', borderColor: '#1e293b', borderRadius: '12px', color: '#fff' }}\r\n                                    itemStyle={{ color: '#fff' }}\r\n                                />\r\n                                <Legend\r\n                                    layout=\"horizontal\"\r\n                                    verticalAlign=\"bottom\"\r\n                                    align=\"center\"\r\n                                    iconType=\"circle\"\r\n                                    iconSize={8}\r\n                                    wrapperStyle={{ fontSize: '10px', paddingTop: '20px' }}\r\n                                />\r\n                            </PieChart>\r\n                        </ResponsiveContainer>\r\n                    ) : (\r\n                        <div className=\"h-full flex flex-col items-center justify-center text-slate-500 space-y-2\">\r\n                            <PieIcon className=\"w-12 h-12 opacity-20\" />\r\n                            <p className=\"text-sm\">A√±ade gastos para ver el gr√°fico</p>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n\r\n                {/* 3. ALERTS */}\r\n                <div className=\"space-y-3\">\r\n                    {data.fuel > (total * 0.15) && total > 0 && (\r\n                        <div className=\"p-3 bg-rose-500/10 border border-rose-500/20 rounded-xl flex gap-3 text-sm\">\r\n                            <AlertTriangle className=\"w-5 h-5 text-rose-500 shrink-0\" />\r\n                            <div>\r\n                                <p className=\"font-bold text-rose-400\">Gasto en Gasolina Alto</p>\r\n                                <p className=\"text-rose-200/70 text-xs\">Supone el {((data.fuel / total) * 100).toFixed(1)}% del total.</p>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                    {data.marketing < 100 && (\r\n                        <div className=\"p-3 bg-indigo-500/10 border border-indigo-500/20 rounded-xl flex gap-3 text-sm\">\r\n                            <Megaphone className=\"w-5 h-5 text-indigo-500 shrink-0\" />\r\n                            <div>\r\n                                <p className=\"font-bold text-indigo-400\">Impulsa tu negocio</p>\r\n                                <p className=\"text-indigo-200/70 text-xs\">Invertir en marketing es clave para crecer.</p>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default ExpenseStep;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\steps\\IncomeStep.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":86,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":86,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3232,3235],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3232,3235],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'user?.role' and 'user.uid'. Either include them or remove the dependency array.","line":99,"column":8,"nodeType":"ArrayExpression","endLine":99,"endColumn":21,"suggestions":[{"desc":"Update the dependencies array to be: [franchiseId, user?.role, user.uid]","fix":{"range":[3673,3686],"text":"[franchiseId, user?.role, user.uid]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'calculateTotal'. Either include it or remove the dependency array.","line":124,"column":8,"nodeType":"ArrayExpression","endLine":124,"endColumn":36,"suggestions":[{"desc":"Update the dependencies array to be: [data, rates, onTotalChange, calculateTotal]","fix":{"range":[4393,4421],"text":"[data, rates, onTotalChange, calculateTotal]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { Package, AlertCircle } from 'lucide-react';\r\nimport { doc, getDoc } from 'firebase/firestore';\r\nimport { db } from '../../../lib/firebase';\r\nimport { useAuth } from '../../../context/AuthContext';\r\nimport { formatMoney } from '../../../lib/finance';\r\n\r\n// =====================================================\r\n// TYPES\r\n// =====================================================\r\n\r\ninterface LogisticsRate {\r\n    id?: string;\r\n    name: string;   // \"0-4 km\", \"4-8 km\", etc. (Legacy or Generated)\r\n    min?: number;   // New structure\r\n    max?: number;   // New structure\r\n    price: number;  // SIN IVA\r\n}\r\n\r\nimport { OrderCounts } from '../types';\r\n\r\ninterface IncomeStepProps {\r\n    data: OrderCounts;\r\n    onChange: (data: OrderCounts) => void;\r\n    total: number;\r\n    franchiseId: string;\r\n    onTotalChange: (total: number) => void;\r\n}\r\n\r\n// Tooltip component removed as it was unused\r\n\r\n// =====================================================\r\n// MAIN COMPONENT\r\n// =====================================================\r\n\r\nconst IncomeStep: React.FC<IncomeStepProps> = ({\r\n    data,\r\n    onChange,\r\n    franchiseId,\r\n    onTotalChange\r\n}) => {\r\n    const { user } = useAuth();\r\n    const [rates, setRates] = useState<LogisticsRate[]>([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const [error, setError] = useState<string | null>(null);\r\n\r\n    useEffect(() => {\r\n        const loadRates = async () => {\r\n            setLoading(true);\r\n            setError(null);\r\n\r\n            try {\r\n                // DETERMINAR ID CORRECTO DEL DOCUMENTO DE USUARIO\r\n                let targetId = franchiseId;\r\n\r\n                // Si el usuario es franquicia, priorizamos su propio UID porque ah√≠ es donde FranchiseProfile guarda los datos.\r\n                if (user?.role === 'franchise' && user?.uid) {\r\n                    targetId = user.uid;\r\n                }\r\n\r\n                if (!targetId) throw new Error(\"ID de franquicia no disponible\");\r\n\r\n                if (import.meta.env.DEV) {\r\n                    console.log(`IncomeStep: Loading rates from users/${targetId}`);\r\n                }\r\n                const docRef = doc(db, 'users', targetId);\r\n                const docSnap = await getDoc(docRef);\r\n\r\n                if (docSnap.exists()) {\r\n                    const userData = docSnap.data();\r\n                    const logisticsRates = userData.logisticsRates || [];\r\n                    if (import.meta.env.DEV) {\r\n                        console.log('IncomeStep: Loaded rates', logisticsRates.length);\r\n                    }\r\n                    setRates(logisticsRates);\r\n                } else {\r\n                    if (import.meta.env.DEV) {\r\n                        console.warn(`IncomeStep: Doc ${targetId} not found`);\r\n                    }\r\n                    // Fallback para staff o discrepancias\r\n                    if (targetId !== user?.uid && user?.uid) {\r\n                        const fallbackSnap = await getDoc(doc(db, 'users', user.uid));\r\n                        if (fallbackSnap.exists()) setRates(fallbackSnap.data().logisticsRates || []);\r\n                    }\r\n                }\r\n            } catch (err: any) {\r\n                console.error(\"Error loading rates:\", err);\r\n                if (err.code === 'permission-denied') {\r\n                    setError(\"No tienes permisos para leer la configuraci√≥n de tarifas.\");\r\n                } else {\r\n                    setError(\"Error al cargar tarifas.\");\r\n                }\r\n            } finally {\r\n                setLoading(false);\r\n            }\r\n        };\r\n\r\n        loadRates();\r\n    }, [franchiseId]);\r\n\r\n    const handleChange = (rateName: string, value: string) => {\r\n        const numValue = value === '' ? 0 : parseInt(value) || 0;\r\n        onChange({\r\n            ...data,\r\n            [rateName]: numValue\r\n        });\r\n    };\r\n\r\n    const calculateTotal = () => {\r\n        let totalIncome = 0;\r\n        rates.forEach(rate => {\r\n            const orders = data[rate.name] || 0;\r\n            totalIncome += orders * rate.price;\r\n        });\r\n        return totalIncome;\r\n    };\r\n\r\n    // Effect to notify parent of total changes\r\n    useEffect(() => {\r\n        if (rates.length > 0 && onTotalChange) {\r\n            const total = calculateTotal();\r\n            onTotalChange(total);\r\n        }\r\n    }, [data, rates, onTotalChange]);\r\n\r\n    if (loading) {\r\n        return (\r\n            <div className=\"flex items-center justify-center py-12\">\r\n                <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500\" />\r\n                <span className=\"ml-3 text-slate-400\">Cargando tarifas...</span>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    if (error === \"no-rates\") {\r\n        return (\r\n            <div className=\"space-y-6\">\r\n                <div className=\"text-center\">\r\n                    <div className=\"inline-flex items-center justify-center w-16 h-16 bg-amber-500/10 rounded-2xl mb-4\">\r\n                        <AlertCircle className=\"w-8 h-8 text-amber-400\" />\r\n                    </div>\r\n                    <h3 className=\"text-2xl font-black text-slate-900 mb-2\">\r\n                        No tienes tarifas configuradas\r\n                    </h3>\r\n                    <p className=\"text-slate-500 text-sm mb-6\">\r\n                        Antes de poder registrar ingresos, necesitas configurar tus tarifas por distancia.\r\n                    </p>\r\n\r\n                    <div className=\"max-w-md mx-auto bg-blue-500/10 border border-blue-500/30 rounded-xl p-4\">\r\n                        <p className=\"text-sm text-blue-400 leading-relaxed\">\r\n                            <strong>¬øC√≥mo configurar tarifas?</strong><br />\r\n                            1. Ve a <strong>Configuraci√≥n ‚Üí Configuraci√≥n Sede</strong><br />\r\n                            2. Selecciona la pesta√±a <strong>&quot;Log√≠stica y Zonas&quot;</strong><br />\r\n                            3. A√±ade tus tarifas por distancia (ej: 0-4 km = 15‚Ç¨)<br />\r\n                            4. Guarda y vuelve aqu√≠\r\n                        </p>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    if (error) {\r\n        return (\r\n            <div className=\"text-center py-12\">\r\n                <AlertCircle className=\"w-12 h-12 text-rose-400 mx-auto mb-4\" />\r\n                <p className=\"text-rose-400\">{error}</p>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    const calculatedTotal = calculateTotal();\r\n\r\n    return (\r\n        <div className=\"space-y-6 animate-in fade-in slide-in-from-right-8 duration-500\">\r\n            {/* Header / Summary */}\r\n            <div className=\"flex gap-4\">\r\n                <div className=\"flex-1 bg-white p-4 rounded-xl border border-slate-200 flex justify-between items-center shadow-sm\">\r\n                    <div className=\"flex items-center gap-3\">\r\n                        <div className=\"p-2 bg-emerald-50 rounded-lg border border-emerald-100\">\r\n                            <Package className=\"w-5 h-5 text-emerald-600\" />\r\n                        </div>\r\n                        <div>\r\n                            <p className=\"text-xs text-slate-500 font-bold uppercase tracking-wider\">Total Ingresos</p>\r\n                            <h3 className=\"text-2xl font-black text-slate-900 font-mono\">\r\n                                {formatMoney(calculatedTotal)}‚Ç¨\r\n                            </h3>\r\n                        </div>\r\n                    </div>\r\n                    <div className=\"text-right\">\r\n                        <p className=\"text-[10px] text-slate-500 font-bold uppercase tracking-wider mb-1\">Pedidos Totales</p>\r\n                        <span className=\"bg-slate-100 border border-slate-200 text-slate-700 px-3 py-1 rounded-lg text-sm font-mono font-bold\">\r\n                            {Object.values(data).reduce((sum, val) => sum + val, 0)}\r\n                        </span>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Rates Grid */}\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                {rates.map((rate, index) => {\r\n                    const orders = data[rate.name] || 0;\r\n\r\n                    return (\r\n                        <div key={index} className=\"bg-white p-4 rounded-xl border border-slate-200 hover:border-slate-300 transition-all group relative shadow-sm\">\r\n                            <div className=\"flex items-center justify-between mb-3\">\r\n                                <div className=\"flex items-center gap-3\">\r\n                                    <div className=\"flex flex-col\">\r\n                                        <label className=\"text-sm font-bold text-slate-700 block\">\r\n                                            {rate.min !== undefined && rate.max !== undefined\r\n                                                ? `${rate.min} - ${rate.max} km`\r\n                                                : rate.name}\r\n                                        </label>\r\n                                        <p className=\"text-[10px] text-slate-500 font-mono\">\r\n                                            Tarifa: <span className=\"text-slate-700 font-bold\">{rate.price.toFixed(2)}‚Ç¨</span>\r\n                                        </p>\r\n                                    </div>\r\n                                </div>\r\n                                {orders > 0 && (\r\n                                    <div className=\"text-right\">\r\n                                        <span className=\"text-xs text-emerald-600 font-bold font-mono\">\r\n                                            +{(orders * rate.price).toFixed(2)}‚Ç¨\r\n                                        </span>\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n\r\n                            <div className=\"relative\">\r\n                                <input\r\n                                    type=\"number\"\r\n                                    min=\"0\"\r\n                                    step=\"1\"\r\n                                    value={orders === 0 ? '' : orders}\r\n                                    onChange={(e) => handleChange(rate.name, e.target.value)}\r\n                                    className=\"w-full bg-slate-50 border border-slate-200 rounded-lg py-2 pl-3 pr-12 text-slate-900 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 transition-all font-mono text-lg font-bold placeholder-slate-400\"\r\n                                    placeholder=\"0\"\r\n                                />\r\n                                <span className=\"absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-[10px] font-bold uppercase tracking-wider\">\r\n                                    PEDS\r\n                                </span>\r\n                            </div>\r\n                        </div>\r\n                    );\r\n                })}\r\n            </div>\r\n\r\n            {/* Help note */}\r\n            <div className=\"max-w-2xl mx-auto text-center\">\r\n                <p className=\"text-[10px] text-slate-500\">\r\n                    <strong className=\"text-blue-400\">Nota:</strong> Introduce el n√∫mero de pedidos. El sistema calcula autom√°ticamente los ingresos base (sin IVA).\r\n                </p>\r\n            </div>\r\n        </div >\r\n    );\r\n};\r\n\r\nexport default IncomeStep;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\steps\\NumberInput.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\steps\\SummaryStep.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":23,"column":61,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":23,"endColumn":64,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[773,776],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[773,776],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":24,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":24,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[802,805],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[802,805],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":39,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":39,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1582,1585],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1582,1585],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'expenses' logical expression could make the dependencies of useMemo Hook (at line 62) change on every render. To fix this, wrap the initialization of 'expenses' in its own useMemo() Hook.","line":50,"column":11,"nodeType":"VariableDeclarator","endLine":50,"endColumn":73}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\nimport { TrendingUp } from 'lucide-react';\r\nimport { formatMoney } from '../../../lib/finance';\r\nimport { ExpenseData } from '../types';\r\nimport { PieChart, Pie, Cell, ResponsiveContainer, Tooltip } from 'recharts';\r\n\r\ninterface SummaryStepProps {\r\n    // Polymorphic props to support both Wizards\r\n    income?: number; // SimpleFinanceWizard\r\n    totalIncome?: number; // FinancialClerkWizard\r\n\r\n    expensesTotal?: number; // SimpleFinanceWizard\r\n    totalExpenses?: number; // FinancialClerkWizard\r\n\r\n    data?: ExpenseData; // SimpleFinanceWizard\r\n    expenses?: ExpenseData; // FinancialClerkWizard\r\n\r\n    grossProfit: number;\r\n    totalHours: number;\r\n}\r\n\r\n// Helper Components\r\nconst SummaryCard = ({ title, value, color, suffix = \"‚Ç¨\" }: any) => {\r\n    const colors: any = {\r\n        emerald: \"text-emerald-400 bg-emerald-500/10 border-emerald-500/20\",\r\n        rose: \"text-rose-400 bg-rose-500/10 border-rose-500/20\",\r\n        indigo: \"text-indigo-400 bg-indigo-500/10 border-indigo-500/20\",\r\n        orange: \"text-orange-400 bg-orange-500/10 border-orange-500/20\",\r\n        blue: \"text-blue-400 bg-blue-500/10 border-blue-500/20\",\r\n    };\r\n    return (\r\n        <div className={`p-6 rounded-2xl border ${colors[color]} flex flex-col items-center justify-center text-center`}>\r\n            <span className=\"text-[10px] uppercase font-bold tracking-wider opacity-70 mb-2\">{title}</span>\r\n            <span className={`text-xl font-black font-mono`}>{formatMoney(value)}{suffix}</span>\r\n        </div>\r\n    );\r\n};\r\n\r\nconst Row = ({ label, value }: any) => (\r\n    <div className=\"flex justify-between items-center py-2 border-b border-slate-800/50 last:border-0 hover:bg-slate-800/20 px-2 rounded-lg transition-colors\">\r\n        <span className=\"text-slate-400\">{label}</span>\r\n        <span className=\"text-white font-mono font-bold\">{formatMoney(value)}‚Ç¨</span>\r\n    </div>\r\n);\r\n\r\nconst SummaryStep: React.FC<SummaryStepProps> = (props) => {\r\n    // Unify props\r\n    const totalIncome = props.totalIncome ?? props.income ?? 0;\r\n    const totalExpenses = props.totalExpenses ?? props.expensesTotal ?? 0;\r\n    const expenses = props.expenses ?? props.data ?? ({} as ExpenseData);\r\n    const { grossProfit, totalHours } = props;\r\n\r\n    // Optimize: Calculate category totals once\r\n    const categoryTotals = React.useMemo(() => {\r\n        const rentingTotal = (expenses.renting?.count ?? 0) * (expenses.renting?.pricePerUnit ?? 0);\r\n        return {\r\n            team: (expenses.payroll ?? 0) + (expenses.quota ?? 0),\r\n            fleet: rentingTotal + (expenses.fuel ?? 0) + (expenses.repairs ?? 0),\r\n            structure: (expenses.insurance ?? 0) + (expenses.agencyFee ?? 0) + (expenses.prlFee ?? 0) + (expenses.accountingFee ?? 0),\r\n            marketing: (expenses.marketing ?? 0) + (expenses.appFlyder ?? 0) + (expenses.incidents ?? 0) + (expenses.other ?? 0) + ((expenses.royaltyPercent || 0) * totalIncome / 100)\r\n        };\r\n    }, [expenses, totalIncome]);\r\n\r\n    // Chart Data Preparation\r\n    const chartData = [\r\n        { name: 'Equipo', value: categoryTotals.team, color: '#10b981' },\r\n        { name: 'Flota/Ops', value: categoryTotals.fleet, color: '#f59e0b' },\r\n        { name: 'Estructura', value: categoryTotals.structure, color: '#6366f1' },\r\n        { name: 'Marketing', value: categoryTotals.marketing, color: '#ec4899' },\r\n    ].filter(item => item.value > 0);\r\n\r\n    const taxes = React.useMemo(() => {\r\n        // Simple approximation for user clarity\r\n        // IRPF is applied on Net Profit (Yield)\r\n        const irpfAmount = grossProfit > 0 ? grossProfit * ((expenses.irpfPercent || 20) / 100) : 0;\r\n        const netClean = grossProfit - irpfAmount;\r\n        return { irpfAmount, netClean, percent: expenses.irpfPercent || 20 };\r\n    }, [grossProfit, expenses.irpfPercent]);\r\n\r\n    return (\r\n        <div className=\"space-y-8 animate-in zoom-in duration-500\">\r\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\r\n                {/* Visual Chart - New \"Widget\" feel */}\r\n                <div className=\"bg-slate-950 border border-slate-800 rounded-2xl p-4 flex flex-col items-center justify-center relative min-h-[220px]\">\r\n                    <h5 className=\"absolute top-4 left-4 text-xs font-bold text-slate-500 uppercase tracking-wider\">Distribuci√≥n</h5>\r\n                    <div className=\"w-full h-[180px]\">\r\n                        <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n                            <PieChart>\r\n                                <Pie\r\n                                    data={chartData}\r\n                                    innerRadius={50}\r\n                                    outerRadius={70}\r\n                                    paddingAngle={5}\r\n                                    dataKey=\"value\"\r\n                                    stroke=\"none\"\r\n                                >\r\n                                    {chartData.map((entry, index) => (\r\n                                        <Cell key={`cell-${index}`} fill={entry.color} />\r\n                                    ))}\r\n                                </Pie>\r\n                                <Tooltip\r\n                                    formatter={(value: number) => formatMoney(value) + '‚Ç¨'}\r\n                                    contentStyle={{ backgroundColor: '#0f172a', borderColor: '#1e293b', borderRadius: '8px', color: '#fff' }}\r\n                                    itemStyle={{ color: '#fff' }}\r\n                                />\r\n                            </PieChart>\r\n                        </ResponsiveContainer>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* KPI Cards */}\r\n                <div className=\"col-span-2 grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n                    <SummaryCard title=\"Ingresos\" value={totalIncome} color=\"emerald\" />\r\n                    <SummaryCard title=\"Gastos\" value={totalExpenses} color=\"rose\" />\r\n                    <SummaryCard title=\"Beneficio Operativo\" value={grossProfit} color={grossProfit >= 0 ? 'indigo' : 'orange'} />\r\n                </div>\r\n            </div>\r\n\r\n            {/* OPERATIONAL EFFICIENCY BLOCK */}\r\n            {totalHours > 0 && (\r\n                <div className=\"bg-slate-900/50 border border-slate-800 rounded-2xl p-5 relative overflow-hidden\">\r\n                    <div className=\"absolute left-0 top-0 bottom-0 w-1 bg-blue-500\"></div>\r\n                    <h4 className=\"text-blue-400 font-bold uppercase text-xs tracking-wider mb-4 flex items-center gap-2\">\r\n                        Eficiencia Operativa\r\n                    </h4>\r\n                    <div className=\"grid grid-cols-2 gap-8\">\r\n                        <div>\r\n                            <p className=\"text-xs text-slate-500 mb-1\">Coste Real / Hora</p>\r\n                            <p className=\"text-2xl font-black text-white font-mono\">{formatMoney(totalExpenses / totalHours)}‚Ç¨/h</p>\r\n                        </div>\r\n                        <div>\r\n                            <p className=\"text-xs text-slate-500 mb-1\">Facturaci√≥n / Hora</p>\r\n                            <p className=\"text-2xl font-black text-emerald-400 font-mono\">{formatMoney(totalIncome / totalHours)}‚Ç¨/h</p>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            <div className=\"bg-slate-950 rounded-2xl border border-slate-800 p-6 overflow-hidden relative\">\r\n                <div className=\"absolute top-0 right-0 p-4 opacity-10\">\r\n                    <TrendingUp className=\"w-32 h-32 text-indigo-500\" />\r\n                </div>\r\n                <h4 className=\"font-bold text-white mb-6 relative z-10\">Cuenta de Resultados (P&L)</h4>\r\n                <div className=\"space-y-3 text-sm relative z-10\">\r\n                    <Row label=\"N√≥minas y Personal\" value={categoryTotals.team} />\r\n                    <Row label=\"Flota y Operaciones\" value={categoryTotals.fleet} />\r\n                    <Row label=\"Estructura y Servicios\" value={categoryTotals.structure} />\r\n                    <Row label=\"Marketing y Royalty\" value={categoryTotals.marketing} />\r\n\r\n                    <div className=\"border-t border-slate-800 my-4\"></div>\r\n\r\n                    <div className=\"flex justify-between items-center\">\r\n                        <span className=\"text-slate-400\">Resultado Operativo (EBITDA)</span>\r\n                        <span className={`font-mono font-bold text-white`}>\r\n                            {formatMoney(grossProfit)}‚Ç¨\r\n                        </span>\r\n                    </div>\r\n\r\n                    {/* TAX BLOCK */}\r\n                    <div className=\"flex justify-between items-center text-xs\">\r\n                        <span className=\"text-amber-500/80\">Estimaci√≥n IRPF ({taxes.percent}%)</span>\r\n                        <span className=\"text-amber-500 font-mono\">\r\n                            -{formatMoney(taxes.irpfAmount)}‚Ç¨\r\n                        </span>\r\n                    </div>\r\n\r\n                    <div className=\"border-t border-slate-700/50 pt-3 flex justify-between items-center mt-2\">\r\n                        <div className=\"flex flex-col\">\r\n                            <span className=\"font-black text-emerald-400 uppercase tracking-wider text-sm\">BENEFICIO NETO (LIMPIO)</span>\r\n                            <span className=\"text-[10px] text-slate-500\">Lo que te queda en el bolsillo</span>\r\n                        </div>\r\n\r\n                        <span className={`font-mono font-black text-2xl ${taxes.netClean >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>\r\n                            {formatMoney(taxes.netClean)}‚Ç¨\r\n                        </span>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default SummaryStep;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\support\\BookingCalendar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\support\\NewTicketForm.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":10,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":10,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[513,516],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[513,516],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":15,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":15,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[690,693],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[690,693],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":254,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":254,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14031,14034],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14031,14034],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { db } from '../../../lib/firebase';\r\nimport { collection, addDoc, serverTimestamp } from 'firebase/firestore';\r\nimport { Send, AlertCircle, HelpCircle, Zap, LucideIcon, Plus } from 'lucide-react';\r\nimport { notificationService } from '../../../services/notificationService';\r\nimport { useAuth } from '../../../context/AuthContext';\r\nimport { suggestSupportSolution } from '../../../lib/gemini';\r\n\r\ninterface NewTicketFormProps {\r\n    onSubmit?: (data: any) => void;\r\n    onSubjectChange?: (subject: string) => void;\r\n    sending?: boolean;\r\n    success?: boolean;\r\n    setSuccess?: (success: boolean) => void;\r\n    suggestions?: any[];\r\n    file?: File | null;\r\n    setFile?: (file: File | null) => void;\r\n    uploading?: boolean;\r\n    onClose?: () => void;\r\n}\r\n\r\ninterface TicketFormData {\r\n    subject: string;\r\n    category: string;\r\n    description: string;\r\n    priority: 'low' | 'medium' | 'high';\r\n}\r\n\r\nconst NewTicketForm: React.FC<NewTicketFormProps> = ({ onClose }) => {\r\n    const { user } = useAuth();\r\n    const [currentPath, setCurrentPath] = useState('');\r\n\r\n    useEffect(() => {\r\n        setCurrentPath(window.location.pathname);\r\n    }, []);\r\n\r\n    const [formData, setFormData] = useState<TicketFormData>({\r\n        subject: '',\r\n        category: 'general',\r\n        description: '',\r\n        priority: 'low'\r\n    });\r\n    const [loading, setLoading] = useState(false);\r\n    const [suggestion, setSuggestion] = useState<{ text: string, confidence: number } | null>(null);\r\n\r\n    // AI AUTO-RESOLUTION\r\n    useEffect(() => {\r\n        const timer = setTimeout(async () => {\r\n            // Updated Logic: Trigger if Subject is meaningful (>4 chars) OR Description is meaningful\r\n            const hasSubject = formData.subject.length > 4;\r\n            const hasDesc = formData.description.length > 4;\r\n\r\n            if (hasSubject || hasDesc) {\r\n                // Determine text to analyze\r\n                const subjectText = hasSubject ? formData.subject : \"Consulta General\";\r\n                const descText = hasDesc ? formData.description : formData.subject; // Fallback to subject if desc is empty\r\n\r\n                console.log(\"ü§ñ Asking Gemini:\", subjectText, descText); // Debug log\r\n\r\n                const result = await suggestSupportSolution(subjectText, descText);\r\n                if (result && result.isSolvable) {\r\n                    setSuggestion({ text: result.suggestion, confidence: result.confidence });\r\n                } else {\r\n                    setSuggestion(null);\r\n                }\r\n            } else {\r\n                setSuggestion(null);\r\n            }\r\n        }, 1000); // Reduced delay to 1.0s for snappier feel\r\n\r\n        return () => clearTimeout(timer);\r\n    }, [formData.description, formData.subject]);\r\n\r\n    const handleSubmit = async (e: React.FormEvent) => {\r\n        e.preventDefault();\r\n        if (!formData.subject || !formData.description) return;\r\n\r\n        setLoading(true);\r\n        try {\r\n            await addDoc(collection(db, \"tickets\"), {\r\n                ...formData,\r\n                status: 'open',\r\n                origin: currentPath,\r\n                createdAt: serverTimestamp(),\r\n                lastUpdated: serverTimestamp(),\r\n                messages: []\r\n            });\r\n\r\n            if (onClose) onClose();\r\n            else alert(\"Ticket creado correctamente!\");\r\n\r\n            // Notify Admin\r\n            await notificationService.notify(\r\n                'SUPPORT_TICKET',\r\n                user?.uid || 'unknown',\r\n                user?.displayName || 'Franquicia',\r\n                {\r\n                    title: `Nuevo Ticket: ${formData.subject}`,\r\n                    message: `Prioridad: ${formData.priority.toUpperCase()}\\nCategor√≠a: ${formData.category}\\n\\n${formData.description.substring(0, 100)}...`,\r\n                    priority: formData.priority === 'high' ? 'high' : 'normal',\r\n                    metadata: {\r\n                        ticketId: 'unknown',\r\n                        category: formData.category\r\n                    }\r\n                }\r\n            );\r\n\r\n        } catch (error) {\r\n            console.error(\"Error creating ticket:\", error);\r\n            alert(\"Error al crear el ticket\");\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    const PriorityCard: React.FC<{\r\n        level: 'low' | 'medium' | 'high';\r\n        label: string;\r\n        icon: LucideIcon;\r\n        colorClass: string;\r\n        activeColor: string;\r\n        borderClass: string;\r\n    }> = ({ level, label, icon: Icon, colorClass, activeColor }) => (\r\n        <div\r\n            onClick={() => setFormData({ ...formData, priority: level })}\r\n            className={`\r\n                cursor-pointer p-3 rounded-xl border flex flex-col items-center justify-center gap-2 transition-all\r\n                ${formData.priority === level\r\n                    ? `${activeColor} shadow-sm`\r\n                    : 'bg-white dark:bg-slate-900 border-slate-200 dark:border-slate-800 text-slate-400 dark:text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-800'\r\n                }\r\n            `}\r\n        >\r\n            <Icon className={`w-5 h-5 ${formData.priority === level ? 'scale-110' : ''} ${formData.priority === level ? '' : colorClass}`} />\r\n            <span className=\"text-[10px] font-bold uppercase tracking-wider\">{label}</span>\r\n        </div>\r\n    );\r\n\r\n    return (\r\n        <div className=\"h-full flex flex-col bg-gradient-to-br from-slate-50 to-indigo-50/20 dark:bg-slate-950 text-slate-900 dark:text-slate-200 transition-colors relative overflow-hidden\">\r\n\r\n            <div className=\"absolute inset-0 opacity-[0.02] pointer-events-none bg-[radial-gradient(#6366f1_1px,transparent_1px)] bg-[length:24px_24px]\" />\r\n\r\n            {/* Header */}\r\n            <div className=\"px-5 py-3 border-b border-white/50 dark:border-slate-800 bg-white/60 dark:bg-slate-900/60 backdrop-blur-xl relative z-10 shrink-0 flex justify-between items-center\">\r\n                <div className=\"flex items-center gap-2.5\">\r\n                    <div className=\"w-7 h-7 rounded-lg bg-slate-200 dark:bg-slate-800 flex items-center justify-center shadow-inner\">\r\n                        <HelpCircle className=\"w-3.5 h-3.5 text-slate-500 dark:text-slate-400\" />\r\n                    </div>\r\n                    <div>\r\n                        <h2 className=\"text-sm font-bold text-slate-700 dark:text-slate-200 uppercase tracking-tight leading-none\">\r\n                            Soporte T√©cnico App\r\n                        </h2>\r\n                        <div className=\"flex items-center gap-1 mt-0.5 text-emerald-600 dark:text-emerald-400 text-[9px] uppercase tracking-wider font-black opacity-90\">\r\n                            <span>(Gratuito)</span>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Critical Disclaimer Banner */}\r\n            <div className=\"bg-amber-50 dark:bg-amber-900/10 border-b border-amber-100 dark:border-amber-800/30 px-5 py-2 flex items-start gap-2 relative z-10 shrink-0\">\r\n                <AlertCircle className=\"w-3 h-3 text-amber-600 dark:text-amber-500 mt-0.5 shrink-0\" />\r\n                <p className=\"text-[10px] text-amber-800 dark:text-amber-200 font-medium leading-tight\">\r\n                    <span className=\"font-bold\">Importante:</span> Este canal es exclusivamente para <u>errores de la plataforma</u>.\r\n                    Para temas operativos, fiscales o de negocio, contrata un <span className=\"underline\">Servicio Premium</span>.\r\n                </p>\r\n            </div>\r\n\r\n            {/* Ultra-Compact Form Content */}\r\n            <form onSubmit={handleSubmit} className=\"flex-1 p-5 relative z-10 overflow-hidden flex flex-col min-h-0\">\r\n                <div className=\"grid grid-cols-1 lg:grid-cols-12 gap-3 h-full content-start\">\r\n\r\n                    {/* AI SUGGESTION BANNER */}\r\n                    {suggestion && (\r\n                        <div className=\"lg:col-span-12 px-1 animate-in fade-in slide-in-from-top-2 duration-500\">\r\n                            <div className=\"bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-100 dark:border-emerald-800/50 rounded-xl p-3 flex gap-3 shadow-sm\">\r\n                                <div className=\"p-2 bg-white dark:bg-emerald-900 rounded-lg shadow-sm shrink-0 h-fit\">\r\n                                    <Zap className=\"w-4 h-4 text-emerald-500 animate-pulse\" />\r\n                                </div>\r\n                                <div className=\"flex-1\">\r\n                                    <div className=\"flex justify-between items-start\">\r\n                                        <h4 className=\"text-xs font-bold text-emerald-800 dark:text-emerald-300 mb-1\">\r\n                                            Soluci√≥n Inteligente Detectada\r\n                                        </h4>\r\n                                        <span className=\"text-[9px] bg-emerald-100 dark:bg-emerald-800 text-emerald-700 dark:text-emerald-200 px-1.5 py-0.5 rounded font-bold\">\r\n                                            {suggestion.confidence}% Confianza\r\n                                        </span>\r\n                                    </div>\r\n                                    <p className=\"text-xs text-emerald-700 dark:text-emerald-400 leading-relaxed font-medium\">\r\n                                        {suggestion.text}\r\n                                    </p>\r\n                                    <div className=\"mt-2 flex gap-2\">\r\n                                        <button\r\n                                            type=\"button\"\r\n                                            onClick={() => onClose ? onClose() : alert(\"Genial! Ticket evitado.\")}\r\n                                            className=\"text-[10px] bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 rounded-md font-bold transition-colors shadow-sm\"\r\n                                        >\r\n                                            ¬°Funcion√≥! (Cerrar)\r\n                                        </button>\r\n                                        <button\r\n                                            type=\"button\"\r\n                                            onClick={() => setSuggestion(null)}\r\n                                            className=\"text-[10px] text-emerald-600 dark:text-emerald-400 hover:bg-emerald-100 dark:hover:bg-emerald-800/50 px-3 py-1 rounded-md font-bold transition-colors\"\r\n                                        >\r\n                                            No ayud√≥\r\n                                        </button>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* Row 1: Asunto (Full) */}\r\n                    <div className=\"lg:col-span-12 space-y-1 shrink-0\">\r\n                        <label className=\"text-[9px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider pl-1 font-mono\">Asunto</label>\r\n                        <input\r\n                            type=\"text\"\r\n                            placeholder=\"Resumen del problema...\"\r\n                            value={formData.subject}\r\n                            onChange={(e) => setFormData({ ...formData, subject: e.target.value })}\r\n                            className=\"w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-800 text-slate-900 dark:text-slate-200 rounded-lg p-2 text-xs font-semibold focus:outline-none focus:ring-2 focus:ring-indigo-500/30 transition-all shadow-sm\"\r\n                            required\r\n                        />\r\n                    </div>\r\n\r\n                    {/* Row 2: Category (4) + Priority (8) */}\r\n                    <div className=\"lg:col-span-4 space-y-1 shrink-0\">\r\n                        <label className=\"text-[9px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider pl-1 font-mono\">Categor√≠a</label>\r\n                        <div className=\"relative group\">\r\n                            <select\r\n                                value={formData.category}\r\n                                onChange={(e) => setFormData({ ...formData, category: e.target.value })}\r\n                                aria-label=\"Categor√≠a del ticket\"\r\n                                className=\"w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-800 text-slate-900 dark:text-slate-200 rounded-lg p-2 text-xs font-semibold appearance-none focus:outline-none focus:ring-2 focus:ring-indigo-500/30 transition-all cursor-pointer hover:bg-white dark:hover:bg-slate-800 shadow-sm\"\r\n                            >\r\n                                <option value=\"general\">General</option>\r\n                                <option value=\"technical\">T√©cnico</option>\r\n                                <option value=\"billing\">Facturaci√≥n</option>\r\n                                <option value=\"feature\">Mejora</option>\r\n                            </select>\r\n                            <div className=\"absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400 group-hover:text-indigo-500 transition-colors\">\r\n                                <HelpCircle className=\"w-3 h-3\" />\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"lg:col-span-8 space-y-1 shrink-0\">\r\n                        <label className=\"text-[9px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider pl-1 font-mono\">Urgencia</label>\r\n                        <div className=\"grid grid-cols-3 gap-2\">\r\n                            {['low', 'medium', 'high'].map((level) => (\r\n                                <PriorityCard\r\n                                    key={level}\r\n                                    level={level as any}\r\n                                    label={level === 'low' ? 'Baja' : level === 'medium' ? 'Media' : 'Alta'}\r\n                                    icon={level === 'low' ? HelpCircle : level === 'medium' ? Zap : AlertCircle}\r\n                                    colorClass={level === 'low' ? 'text-blue-500' : level === 'medium' ? 'text-amber-500' : 'text-rose-500'}\r\n                                    activeColor={\r\n                                        level === 'low' ? 'bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300 border-blue-200 dark:border-blue-700/50' :\r\n                                            level === 'medium' ? 'bg-amber-50 dark:bg-amber-900/20 text-amber-700 dark:text-amber-300 border-amber-200 dark:border-amber-700/50' :\r\n                                                'bg-rose-50 dark:bg-rose-900/20 text-rose-700 dark:text-rose-300 border-rose-200 dark:border-rose-700/50'\r\n                                    }\r\n                                    borderClass=\"border\"\r\n                                />\r\n                            ))}\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Row 3: Description (Left) + File Upload (Right) - Fill Remaining Space */}\r\n                    <div className=\"lg:col-span-7 flex flex-col space-y-1 min-h-0 h-full\">\r\n                        <div className=\"flex justify-between items-center pl-1 pr-1\">\r\n                            <label className=\"text-[9px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider font-mono\">Detalles</label>\r\n                            <span className={`text-[9px] font-bold ${formData.description.length > 450 ? 'text-amber-500' : 'text-slate-400'}`}>\r\n                                {formData.description.length}/500\r\n                            </span>\r\n                        </div>\r\n                        <textarea\r\n                            placeholder=\"Descripci√≥n detallada...\"\r\n                            value={formData.description}\r\n                            onChange={(e) => setFormData({ ...formData, description: e.target.value.slice(0, 500) })}\r\n                            className=\"w-full flex-1 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-800 text-slate-900 dark:text-slate-200 rounded-lg p-3 text-xs font-medium focus:outline-none focus:ring-2 focus:ring-indigo-500/30 resize-none transition-all leading-relaxed shadow-sm\"\r\n                            required\r\n                        />\r\n                    </div>\r\n\r\n                    <div className=\"lg:col-span-5 flex flex-col space-y-1 min-h-0 h-full\">\r\n                        <label className=\"text-[9px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider pl-1 font-mono\">Evidencia</label>\r\n                        <div className=\"flex-1 border-2 border-dashed border-slate-200 dark:border-slate-700 rounded-lg p-2 flex flex-col items-center justify-center text-center hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors cursor-pointer group bg-slate-50/30 dark:bg-slate-900/30\">\r\n                            <div className=\"w-8 h-8 bg-indigo-50 dark:bg-indigo-900/20 text-indigo-500 dark:text-indigo-400 rounded-full flex items-center justify-center mb-1 group-hover:scale-110 transition-transform\">\r\n                                <Plus className=\"w-4 h-4\" />\r\n                            </div>\r\n                            <p className=\"text-[9px] font-medium text-slate-600 dark:text-slate-300 leading-tight\">\r\n                                <span className=\"text-indigo-600 dark:text-indigo-400 font-bold block\">Adjuntar</span>\r\n                                PDF/JPG\r\n                            </p>\r\n                        </div>\r\n                    </div>\r\n\r\n                </div>\r\n            </form>\r\n\r\n            {/* Ultra-Compact Footer */}\r\n            <div className=\"px-5 py-3 border-t border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-900/50 backdrop-blur-md relative z-20 flex justify-between items-center shrink-0\">\r\n                <p className=\"text-[9px] text-slate-400 font-bold uppercase tracking-wider\"> Respuesta &lt; 24h</p>\r\n                <button\r\n                    onClick={handleSubmit}\r\n                    disabled={loading || !formData.subject || formData.description.length < 10}\r\n                    className={`\r\n                        px-5 py-2 rounded-lg font-black text-[9px] uppercase tracking-widest transition-all shadow-sm flex items-center gap-1.5\r\n                        ${loading || !formData.subject || formData.description.length < 10\r\n                            ? 'bg-slate-200 dark:bg-slate-800 text-slate-400 dark:text-slate-600 cursor-not-allowed'\r\n                            : 'bg-indigo-600 hover:bg-indigo-500 text-white shadow-indigo-500/20 hover:shadow-indigo-500/30 hover:-translate-y-0.5'\r\n                        }\r\n                    `}\r\n                >\r\n                    {loading ? (\r\n                        <>\r\n                            <div className=\"w-2.5 h-2.5 border-2 border-white/30 border-t-white rounded-full animate-spin\" />\r\n                            <span>...</span>\r\n                        </>\r\n                    ) : (\r\n                        <>\r\n                            <span>Enviar</span>\r\n                            <Send className=\"w-3 h-3\" />\r\n                        </>\r\n                    )}\r\n                </button>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default NewTicketForm;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\support\\PremiumServicesPanel.tsx","messages":[{"ruleId":"react-hooks/static-components","severity":2,"message":"Error: Cannot create components during render\n\nComponents created during render will reset their state each time they are created. Declare components outside of render.\n\nC:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\support\\PremiumServicesPanel.tsx:451:22\n  449 |                     ${selected ? 'bg-indigo-500 text-white shadow-indigo-500/40' : 'bg-indigo-50 dark:bg-slate-800 text-indigo-600 dark:text-indigo-400 group-hover:bg-indigo-500 group-hover:text-white'}\n  450 |                 `}>\n> 451 |                     <Icon className=\"w-8 h-8\" />\n      |                      ^^^^ This component is created during render\n  452 |                 </div>\n  453 |\n  454 |                 {/* Middle: Info */}\n\nC:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\support\\PremiumServicesPanel.tsx:419:18\n  417 |\n  418 | const ServiceCard: React.FC<{ service: PremiumService, selected: boolean, onClick: () => void, isBundle?: boolean }> = ({ service, selected, onClick, isBundle }) => {\n> 419 |     const Icon = getIconForService(service);\n      |                  ^^^^^^^^^^^^^^^^^^^^^^^^^^ The component is created during render here\n  420 |     const color = getColorForService(service);\n  421 |\n  422 |     if (isBundle) {","line":451,"column":22,"nodeType":null,"endLine":451,"endColumn":26},{"ruleId":"react-hooks/static-components","severity":2,"message":"Error: Cannot create components during render\n\nComponents created during render will reset their state each time they are created. Declare components outside of render.\n\nC:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\support\\PremiumServicesPanel.tsx:512:18\n  510 |                 }\n  511 |             `}>\n> 512 |                 <Icon className=\"w-6 h-6\" />\n      |                  ^^^^ This component is created during render\n  513 |             </div>\n  514 |\n  515 |             <div className=\"mb-4 flex-1 relative z-10 w-full\">\n\nC:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\support\\PremiumServicesPanel.tsx:419:18\n  417 |\n  418 | const ServiceCard: React.FC<{ service: PremiumService, selected: boolean, onClick: () => void, isBundle?: boolean }> = ({ service, selected, onClick, isBundle }) => {\n> 419 |     const Icon = getIconForService(service);\n      |                  ^^^^^^^^^^^^^^^^^^^^^^^^^^ The component is created during render here\n  420 |     const color = getColorForService(service);\n  421 |\n  422 |     if (isBundle) {","line":512,"column":18,"nodeType":null,"endLine":512,"endColumn":22}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { Calendar, Clock, CheckCircle, ArrowRight, FileText, TrendingUp, ShieldCheck, Package, CreditCard, Loader2 } from 'lucide-react';\r\nimport { notificationService } from '../../../services/notificationService';\r\nimport { useAuth } from '../../../context/AuthContext';\r\nimport { db } from '../../../lib/firebase';\r\nimport { collection, addDoc, serverTimestamp } from 'firebase/firestore';\r\nimport BookingCalendar from './BookingCalendar';\r\nimport { format } from 'date-fns';\r\nimport { es } from 'date-fns/locale';\r\nimport { premiumServiceService, PremiumService } from '../../../services/premiumServiceService';\r\n\r\n// Fallback/Default Icons map based on type or title keywords\r\nconst getIconForService = (service: PremiumService) => {\r\n    const lowerTitle = service.title.toLowerCase();\r\n    if (lowerTitle.includes('factur')) return FileText;\r\n    if (lowerTitle.includes('audit')) return ShieldCheck;\r\n    if (lowerTitle.includes('estrat')) return TrendingUp;\r\n    if (lowerTitle.includes('pack')) return Package;\r\n    return Clock; // Default\r\n};\r\n\r\nconst getColorForService = (service: PremiumService) => {\r\n    switch (service.type) {\r\n        case 'audit': return 'amber';\r\n        case 'bundle': return 'rose';\r\n        case 'recurring': return 'emerald';\r\n        default: return 'indigo';\r\n    }\r\n};\r\n\r\nconst PremiumServicesPanel: React.FC = () => {\r\n    const { user } = useAuth();\r\n    const [selectedService, setSelectedService] = useState<PremiumService | null>(null);\r\n    const [viewState, setViewState] = useState<'catalog' | 'booking' | 'payment' | 'subscriptions'>('catalog');\r\n    const [bookingDetails, setBookingDetails] = useState<{ date: Date, time: string } | null>(null);\r\n    const [loading, setLoading] = useState(false);\r\n    const [success, setSuccess] = useState(false);\r\n\r\n    // Data State\r\n    const [services, setServices] = useState<PremiumService[]>([]);\r\n    const [fetching, setFetching] = useState(true);\r\n\r\n    useEffect(() => {\r\n        loadServices();\r\n    }, []);\r\n\r\n    const loadServices = async () => {\r\n        setFetching(true);\r\n        const data = await premiumServiceService.getActiveServices();\r\n        setServices(data);\r\n        setFetching(false);\r\n    };\r\n\r\n    const coreServices = services.filter(s => s.type !== 'bundle');\r\n    const bundleServices = services.filter(s => s.type === 'bundle');\r\n\r\n    const handleServiceClick = (service: PremiumService) => {\r\n        setSelectedService(service);\r\n        // If it needs booking (Consultancy/Audit), go to Calendar first\r\n        // If it's pure recurring or simple bundle without scheduling, go straight to Payment\r\n        // For now, let's assume Bundles might need scheduling too if they contain calls.\r\n        if (service.type === 'consultancy' || service.type === 'audit' || service.type === 'bundle') {\r\n            setViewState('booking');\r\n        } else {\r\n            setViewState('payment');\r\n        }\r\n    };\r\n\r\n    const handleCalendarSelect = (date: Date, time: string) => {\r\n        setBookingDetails({ date, time });\r\n        setViewState('payment'); // Proceed to Payment\r\n    };\r\n\r\n    const processPayment = async () => {\r\n        if (!selectedService || !user) return;\r\n        setLoading(true);\r\n\r\n        // SIMULATE STRIPE PAYMENT\r\n        await new Promise(resolve => setTimeout(resolve, 2000)); // 2s delay\r\n\r\n        await submitOrder(true); // Paid = true\r\n    };\r\n\r\n    const submitOrder = async (paid: boolean) => {\r\n        if (!selectedService || !user) return;\r\n\r\n        // Use 'paid' variable to log or handling future logic if needed\r\n        console.log(\"Processing order, paid status:\", paid);\r\n\r\n        try {\r\n            const dateStr = bookingDetails?.date ? format(bookingDetails.date, 'yyyy-MM-dd') : null;\r\n            const timeStr = bookingDetails?.time || null;\r\n\r\n            const desc = bookingDetails\r\n                ? `Reserva Confirmada (Pagada):\\nFecha: ${format(bookingDetails.date, 'd MMMM yyyy', { locale: es })}\\nHora: ${bookingDetails.time}\\nServicio: ${selectedService.title}\\nPrecio: ${selectedService.price}‚Ç¨`\r\n                : `Suscripci√≥n/Compra Confirmada (Pagada):\\nServicio: ${selectedService.title}\\nPrecio: ${selectedService.price}‚Ç¨`;\r\n\r\n            // Create Ticket\r\n            await addDoc(collection(db, \"tickets\"), {\r\n                subject: `[NUEVO PEDIDO] ${selectedService.title} - ${user.displayName || 'Franquiciado'}`,\r\n                description: `${desc}\\nUsuario: ${user.email}\\nEstado: PAGADO (Stripe Mock)\\n\\nACCI√ìN REQUERIDA:\\n1. Verificar pedido.\\n2. Ejecutar servicio.`,\r\n                category: 'premium',\r\n                priority: 'high',\r\n                status: 'open',\r\n                origin: 'PremiumServicesPanel',\r\n                createdAt: serverTimestamp(),\r\n                lastUpdated: serverTimestamp(),\r\n                messages: [],\r\n                metadata: {\r\n                    serviceId: selectedService.id,\r\n                    price: selectedService.price,\r\n                    type: selectedService.type,\r\n                    bookingDate: dateStr,\r\n                    bookingTime: timeStr,\r\n                    paid: true,\r\n                    transactionId: `mock_${Date.now()}`\r\n                }\r\n            });\r\n\r\n            // Notification\r\n            try {\r\n                await notificationService.notify(\r\n                    'PREMIUM_SERVICE_REQUEST', // Using generic for now\r\n                    user.uid,\r\n                    user.displayName || 'Franquiciado',\r\n                    {\r\n                        title: `Pedido Confirmado: ${selectedService.title}`,\r\n                        message: `Hemos recibido tu pago y tu solicitud. Te contactaremos en breve.`,\r\n                        priority: 'high',\r\n                    }\r\n                );\r\n            } catch (e) {\r\n                console.warn('Notify failed', e);\r\n            }\r\n\r\n            setSuccess(true);\r\n            setViewState('catalog');\r\n\r\n        } catch (error) {\r\n            console.error(\"Error processing order:\", error);\r\n            alert(\"Error al procesar el pedido.\");\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    const handleReset = () => {\r\n        setSuccess(false);\r\n        setSelectedService(null);\r\n        setBookingDetails(null);\r\n        setViewState('catalog');\r\n    };\r\n\r\n    if (fetching) {\r\n        return (\r\n            <div className=\"h-full flex items-center justify-center bg-slate-50 dark:bg-slate-950\">\r\n                <Loader2 className=\"w-8 h-8 text-indigo-500 animate-spin\" />\r\n            </div>\r\n        );\r\n    }\r\n\r\n    if (viewState === 'booking' && selectedService) {\r\n        return (\r\n            <BookingCalendar\r\n                onSelectSlot={handleCalendarSelect}\r\n                onCancel={() => {\r\n                    setViewState('catalog');\r\n                    setSelectedService(null);\r\n                }}\r\n            />\r\n        );\r\n    }\r\n\r\n    if (viewState === 'payment' && selectedService) {\r\n        return (\r\n            <div className=\"h-full flex flex-col items-center justify-center bg-slate-50 dark:bg-slate-950 p-4 animate-in fade-in zoom-in duration-300\">\r\n                <div className=\"bg-white dark:bg-slate-900 rounded-2xl shadow-2xl border border-slate-200 dark:border-slate-800 p-8 max-w-md w-full relative overflow-hidden\">\r\n                    {/* Stripe-like Header */}\r\n                    <div className=\"flex items-center justify-between mb-8\">\r\n                        <div className=\"flex items-center gap-2 text-slate-900 dark:text-white font-bold text-lg\">\r\n                            <div className=\"w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white\">\r\n                                <CreditCard className=\"w-5 h-5\" />\r\n                            </div>\r\n                            Pasarela Segura\r\n                        </div>\r\n                        <div className=\"text-right\">\r\n                            <p className=\"text-xs text-slate-500 uppercase font-bold\">Total a Pagar</p>\r\n                            <p className=\"text-2xl font-black text-slate-900 dark:text-white\">{selectedService.price}‚Ç¨</p>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Order Summary */}\r\n                    <div className=\"bg-slate-50 dark:bg-slate-800 rounded-xl p-4 mb-6 text-sm\">\r\n                        <div className=\"flex justify-between mb-2\">\r\n                            <span className=\"text-slate-500\">Servicio</span>\r\n                            <span className=\"font-bold text-slate-900 dark:text-white\">{selectedService.title}</span>\r\n                        </div>\r\n                        {bookingDetails && (\r\n                            <div className=\"flex justify-between mb-2\">\r\n                                <span className=\"text-slate-500\">Fecha</span>\r\n                                <span className=\"font-bold text-slate-900 dark:text-white\">\r\n                                    {format(bookingDetails.date, 'd MMM', { locale: es })} - {bookingDetails.time}\r\n                                </span>\r\n                            </div>\r\n                        )}\r\n                        <div className=\"flex justify-between border-t border-slate-200 dark:border-slate-700 pt-2 mt-2\">\r\n                            <span className=\"font-bold text-slate-900 dark:text-white\">Total</span>\r\n                            <span className=\"font-bold text-indigo-600\">{selectedService.price} EUR</span>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Mock Card Form */}\r\n                    <div className=\"space-y-4 mb-8 opacity-75 grayscale hover:grayscale-0 transition-all pointer-events-none select-none\">\r\n                        <div className=\"bg-white dark:bg-slate-950 border border-slate-300 dark:border-slate-700 rounded-md px-3 py-2\">\r\n                            <p className=\"text-xs text-slate-400 mb-1\">N√∫mero de tarjeta</p>\r\n                            <p className=\"font-mono text-slate-600 dark:text-slate-300\">4242 4242 4242 4242</p>\r\n                        </div>\r\n                        <div className=\"grid grid-cols-2 gap-4\">\r\n                            <div className=\"bg-white dark:bg-slate-950 border border-slate-300 dark:border-slate-700 rounded-md px-3 py-2\">\r\n                                <p className=\"text-xs text-slate-400 mb-1\">Caducidad</p>\r\n                                <p className=\"font-mono text-slate-600 dark:text-slate-300\">12 / 28</p>\r\n                            </div>\r\n                            <div className=\"bg-white dark:bg-slate-950 border border-slate-300 dark:border-slate-700 rounded-md px-3 py-2\">\r\n                                <p className=\"text-xs text-slate-400 mb-1\">CVC</p>\r\n                                <p className=\"font-mono text-slate-600 dark:text-slate-300\">123</p>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Actions */}\r\n                    <button\r\n                        onClick={processPayment}\r\n                        disabled={loading}\r\n                        className=\"w-full py-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold text-lg shadow-lg shadow-indigo-500/30 transition-all flex items-center justify-center gap-2 group\"\r\n                    >\r\n                        {loading ? (\r\n                            <Loader2 className=\"w-5 h-5 animate-spin\" />\r\n                        ) : (\r\n                            <>\r\n                                Pagar {selectedService.price}‚Ç¨\r\n                                <ArrowRight className=\"w-5 h-5 group-hover:translate-x-1 transition-transform\" />\r\n                            </>\r\n                        )}\r\n                    </button>\r\n\r\n                    <button\r\n                        onClick={() => setViewState('catalog')}\r\n                        className=\"w-full mt-3 text-sm text-slate-400 hover:text-slate-600 font-medium pb-2\"\r\n                    >\r\n                        Cancelar Transacci√≥n\r\n                    </button>\r\n\r\n                    <div className=\"absolute inset-x-0 bottom-0 h-1 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500\" />\r\n                </div>\r\n                <p className=\"mt-4 text-xs text-slate-400 max-w-xs text-center\">\r\n                    <ShieldCheck className=\"w-3 h-3 inline-block mr-1\" />\r\n                    Pagos procesados de forma segura (Simulaci√≥n). No se realizar√° ning√∫n cargo real.\r\n                </p>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    if (success) {\r\n        return (\r\n            <div className=\"h-full flex flex-col items-center justify-center text-center animate-in fade-in zoom-in duration-300 p-8\">\r\n                <div className=\"w-24 h-24 bg-emerald-100 dark:bg-emerald-900/30 rounded-full flex items-center justify-center text-emerald-600 dark:text-emerald-400 mb-6 shadow-xl shadow-emerald-500/20\">\r\n                    <CheckCircle className=\"w-12 h-12\" />\r\n                </div>\r\n                <h3 className=\"text-3xl font-black text-slate-900 dark:text-white mb-2\">¬°Pedido Confirmado!</h3>\r\n                <p className=\"text-slate-500 dark:text-slate-400 max-w-md mx-auto mb-8 text-lg\">\r\n                    {bookingDetails\r\n                        ? <>Tu reserva para <strong>{selectedService?.title}</strong> el <strong>{format(bookingDetails.date, 'd MMMM', { locale: es })}</strong> ha sido confirmada.</>\r\n                        : <>Has adquirido <strong>{selectedService?.title}</strong> con √©xito.</>\r\n                    }\r\n                    <br /><br />\r\n                    <span className=\"text-sm bg-emerald-50 dark:bg-emerald-900/20 text-emerald-700 dark:text-emerald-400 px-3 py-1 rounded-full font-bold uppercase tracking-wide\">\r\n                        Pago Completado\r\n                    </span>\r\n                </p>\r\n                <button\r\n                    onClick={handleReset}\r\n                    className=\"px-8 py-3 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-xl font-black uppercase tracking-widest shadow-lg hover:scale-105 transition-all\"\r\n                >\r\n                    Volver al Cat√°logo\r\n                </button>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"h-full flex flex-col bg-slate-50 dark:bg-slate-950 overflow-hidden relative\">\r\n            {/* Background Pattern */}\r\n            <div className=\"absolute inset-0 opacity-[0.03] pointer-events-none bg-[radial-gradient(#6366f1_1px,transparent_1px)] bg-[length:32px_32px]\" />\r\n\r\n            {/* Hero Header */}\r\n            <div className=\"relative h-48 shrink-0 overflow-hidden\">\r\n                <div className=\"absolute inset-0 bg-gradient-to-r from-indigo-900 via-slate-900 to-indigo-950\">\r\n                    <div className=\"absolute inset-0 opacity-20 bg-[radial-gradient(#6366f1_1px,transparent_1px)] bg-[length:24px_24px]\" />\r\n                    <div className=\"absolute inset-0 bg-gradient-to-t from-slate-950/80 to-transparent\" />\r\n                </div>\r\n\r\n                <div className=\"absolute inset-0 flex flex-col justify-end p-6 z-10\">\r\n                    <div className=\"flex justify-between items-end\">\r\n                        <div>\r\n                            <div className=\"flex items-center gap-2 mb-2\">\r\n                                <span className=\"px-2 py-0.5 rounded-full bg-indigo-500/20 border border-indigo-400/30 text-indigo-300 text-[10px] font-bold uppercase tracking-widest backdrop-blur-md\">\r\n                                    Premium Access\r\n                                </span>\r\n                            </div>\r\n                            <h1 className=\"text-3xl font-black text-white tracking-tight mb-1\">\r\n                                Marketplace <span className=\"text-indigo-400\">Exclusive</span>\r\n                            </h1>\r\n                            <p className=\"text-slate-400 text-sm max-w-md font-medium\">\r\n                                Servicios dise√±ados para escalar tu operaci√≥n al siguiente nivel.\r\n                            </p>\r\n                        </div>\r\n\r\n                        {/* Glass Nav */}\r\n                        <div className=\"flex bg-white/5 backdrop-blur-md border border-white/10 p-1 rounded-xl\">\r\n                            <button\r\n                                onClick={() => setViewState('catalog')}\r\n                                className={`px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wide transition-all ${viewState === 'catalog' ? 'bg-indigo-500 text-white shadow-lg shadow-indigo-500/20' : 'text-slate-400 hover:text-white hover:bg-white/5'}`}\r\n                            >\r\n                                Cat√°logo\r\n                            </button>\r\n                            <button\r\n                                onClick={() => setViewState('subscriptions')}\r\n                                className={`px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wide transition-all ${viewState === 'subscriptions' ? 'bg-indigo-500 text-white shadow-lg shadow-indigo-500/20' : 'text-slate-400 hover:text-white hover:bg-white/5'}`}\r\n                            >\r\n                                Mis Suscripciones\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Content Scroller */}\r\n            <div className=\"flex-1 overflow-y-auto relative z-10 custom-scrollbar\">\r\n\r\n                {viewState === 'subscriptions' ? (\r\n                    <div className=\"p-8 flex flex-col items-center justify-center h-full text-center opacity-60\">\r\n                        <CreditCard className=\"w-16 h-16 text-slate-300 mb-4\" />\r\n                        <h3 className=\"text-lg font-bold text-slate-900 dark:text-white\">No tienes suscripciones activas</h3>\r\n                        <p className=\"text-sm text-slate-500 mt-2 max-w-xs\">Contrata los servicios disponibles en el cat√°logo.</p>\r\n                        <button onClick={() => setViewState('catalog')} className=\"mt-6 text-indigo-600 font-bold text-xs uppercase hover:underline\">Ir al Cat√°logo</button>\r\n                    </div>\r\n                ) : (\r\n                    <div className=\"p-4 space-y-4\">\r\n                        {services.length === 0 && (\r\n                            <div className=\"text-center py-10 opacity-50\">\r\n                                <Package className=\"w-10 h-10 mx-auto mb-2\" />\r\n                                <p className=\"text-sm\">No hay servicios disponibles.</p>\r\n                            </div>\r\n                        )}\r\n\r\n                        {/* Bundles (Horizontal Exclusive) */}\r\n                        {bundleServices.length > 0 && (\r\n                            <section>\r\n                                <h3 className=\"text-[10px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-3 flex items-center gap-2\">\r\n                                    <Package className=\"w-3 h-3\" />\r\n                                    Packs Exclusivos\r\n                                </h3>\r\n                                <div className=\"grid grid-cols-1 gap-3\">\r\n                                    {bundleServices.map(service => (\r\n                                        <ServiceCard\r\n                                            key={service.id}\r\n                                            service={service}\r\n                                            selected={selectedService?.id === service.id}\r\n                                            onClick={() => handleServiceClick(service)}\r\n                                            isBundle\r\n                                        />\r\n                                    ))}\r\n                                </div>\r\n                            </section>\r\n                        )}\r\n\r\n                        {/* Core Services */}\r\n                        {coreServices.length > 0 && (\r\n                            <section>\r\n                                <h3 className=\"text-[10px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-2.5\">Servicios Especializados</h3>\r\n                                <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3\">\r\n                                    {coreServices.map(service => (\r\n                                        <ServiceCard\r\n                                            key={service.id}\r\n                                            service={service}\r\n                                            selected={selectedService?.id === service.id}\r\n                                            onClick={() => handleServiceClick(service)}\r\n                                        />\r\n                                    ))}\r\n                                </div>\r\n                            </section>\r\n                        )}\r\n                    </div>\r\n                )}\r\n            </div>\r\n\r\n            {/* Bottom Interaction Bar */}\r\n            {selectedService && !bookingDetails && viewState === 'catalog' && (\r\n                <div className=\"px-5 py-2.5 border-t border-slate-200 dark:border-slate-800 bg-white/95 dark:bg-slate-900/95 backdrop-blur-xl relative z-20 animate-in slide-in-from-bottom-4 duration-300 flex justify-between items-center shadow-lg shrink-0\">\r\n                    <div>\r\n                        <p className=\"text-[9px] font-bold text-slate-400 uppercase tracking-widest\">Seleccionado</p>\r\n                        <p className=\"text-sm font-black text-slate-900 dark:text-white line-clamp-1\">{selectedService.title}</p>\r\n                    </div>\r\n                    <button\r\n                        onClick={() => handleServiceClick(selectedService)}\r\n                        disabled={loading}\r\n                        className=\"px-5 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-black text-[10px] uppercase tracking-widest shadow-lg shadow-indigo-500/20 hover:shadow-indigo-500/40 hover:-translate-y-0.5 transition-all flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed group whitespace-nowrap\"\r\n                    >\r\n                        {selectedService.type === 'consultancy' || selectedService.type === 'audit' ? <Calendar className=\"w-3.5 h-3.5\" /> : <CreditCard className=\"w-3.5 h-3.5\" />}\r\n                        <span>{selectedService.type === 'consultancy' || selectedService.type === 'audit' ? 'Reservar' : 'Contratar'}</span>\r\n                    </button>\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n};\r\n\r\nconst ServiceCard: React.FC<{ service: PremiumService, selected: boolean, onClick: () => void, isBundle?: boolean }> = ({ service, selected, onClick, isBundle }) => {\r\n    const Icon = getIconForService(service);\r\n    const color = getColorForService(service);\r\n\r\n    if (isBundle) {\r\n        return (\r\n            <button\r\n                onClick={onClick}\r\n                className={`\r\n                    relative group w-full text-left rounded-2xl p-6 border transition-all duration-500 flex items-center gap-6 overflow-hidden\r\n                    ${selected\r\n                        ? `bg-slate-900 border-indigo-500/50 shadow-2xl shadow-indigo-500/20 scale-[1.01] z-10 ring-1 ring-indigo-500/50`\r\n                        : 'bg-white dark:bg-slate-900/40 border-slate-200 dark:border-slate-800 hover:border-indigo-500/30 hover:shadow-xl hover:-translate-y-0.5 backdrop-blur-sm'\r\n                    }\r\n                `}\r\n            >\r\n                {/* Exclusive Sheen/Gradient Background for Selected */}\r\n                {selected && (\r\n                    <div className=\"absolute inset-0 bg-gradient-to-r from-indigo-900/40 via-violet-900/40 to-slate-900/0 pointer-events-none\" />\r\n                )}\r\n                <div className=\"absolute inset-0 bg-gradient-to-tr from-white/0 via-white/5 to-white/0 opacity-0 group-hover:opacity-100 transition-opacity duration-[1500ms] pointer-events-none transform -translate-x-full group-hover:translate-x-full\" />\r\n\r\n                <div className=\"absolute top-0 right-0\">\r\n                    <div className={`${selected ? 'bg-indigo-500 text-white' : 'bg-slate-900 dark:bg-white text-white dark:text-slate-900'} text-[10px] font-black px-4 py-1.5 rounded-bl-2xl uppercase tracking-widest shadow-lg transition-colors duration-300`}>\r\n                        Recomendado\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Left: Icon */}\r\n                <div className={`\r\n                    w-16 h-16 shrink-0 rounded-2xl flex items-center justify-center transition-all duration-300 shadow-lg relative z-10\r\n                    ${selected ? 'bg-indigo-500 text-white shadow-indigo-500/40' : 'bg-indigo-50 dark:bg-slate-800 text-indigo-600 dark:text-indigo-400 group-hover:bg-indigo-500 group-hover:text-white'}\r\n                `}>\r\n                    <Icon className=\"w-8 h-8\" />\r\n                </div>\r\n\r\n                {/* Middle: Info */}\r\n                <div className=\"flex-1 min-w-0 relative z-10\">\r\n                    <h3 className={`text-xl font-black mb-2 transition-colors tracking-tight ${selected ? 'text-white' : 'text-slate-900 dark:text-white'}`}>\r\n                        {service.title}\r\n                    </h3>\r\n                    <p className={`text-sm font-medium leading-relaxed mb-4 line-clamp-2 ${selected ? 'text-indigo-100' : 'text-slate-500 dark:text-slate-400'}`}>\r\n                        {service.description}\r\n                    </p>\r\n                    {/* Features Row */}\r\n                    <div className=\"flex flex-wrap gap-2\">\r\n                        {service.features.slice(0, 3).map((feature, idx) => (\r\n                            <div key={idx} className={`flex items-center gap-1.5 px-3 py-1 rounded-lg border transition-colors ${selected ? 'bg-white/10 border-white/10' : 'bg-slate-50 dark:bg-slate-800/50 border-slate-200 dark:border-slate-700/50'}`}>\r\n                                <div className={`w-1.5 h-1.5 rounded-full ${selected ? 'bg-emerald-400 block' : 'bg-indigo-500'}`} />\r\n                                <span className={`text-[11px] font-bold truncate max-w-[150px] ${selected ? 'text-white' : 'text-slate-600 dark:text-slate-300'}`}>{feature}</span>\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Right: Price & Decor */}\r\n                <div className={`text-right shrink-0 flex flex-col items-end pl-8 border-l ${selected ? 'border-white/10' : 'border-slate-100 dark:border-slate-800'}`}>\r\n                    <div className=\"flex items-baseline gap-1\">\r\n                        <span className={`text-3xl font-black tracking-tight ${selected ? 'text-white' : 'text-slate-900 dark:text-white'}`}>{service.price}‚Ç¨</span>\r\n                    </div>\r\n                    <span className={`text-[10px] font-bold uppercase mb-4 ${selected ? 'text-indigo-200' : 'text-slate-400'}`}>+ IVA</span>\r\n\r\n                    <div className={`\r\n                        w-12 h-12 rounded-full flex items-center justify-center transition-all duration-300\r\n                        ${selected ? 'bg-white text-indigo-600' : 'bg-slate-100 dark:bg-slate-800 text-slate-400 dark:text-slate-500 group-hover:bg-indigo-600 group-hover:text-white'}\r\n                     `}>\r\n                        <ArrowRight className=\"w-5 h-5\" />\r\n                    </div>\r\n                </div>\r\n            </button>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <button\r\n            onClick={onClick}\r\n            className={`\r\n                relative group text-left rounded-2xl p-5 border transition-all duration-300 flex flex-col h-full overflow-hidden\r\n                ${selected\r\n                    ? `bg-white dark:bg-slate-900 border-${color}-500 shadow-xl shadow-${color}-500/10 z-10 ring-1 ring-${color}-500/50 scale-[1.02]`\r\n                    : 'bg-white dark:bg-slate-900/40 border-slate-200 dark:border-slate-800 hover:border-slate-300 dark:hover:border-slate-600 hover:shadow-2xl hover:-translate-y-1 backdrop-blur-sm'\r\n                }\r\n            `}\r\n        >\r\n            {/* Glossy sheen effect on hover */}\r\n            <div className=\"absolute inset-0 bg-gradient-to-tr from-white/0 via-white/5 to-white/0 opacity-0 group-hover:opacity-100 transition-opacity duration-500 pointer-events-none transform -translate-x-full group-hover:translate-x-full duration-1000\" />\r\n\r\n            <div className={`\r\n                w-12 h-12 rounded-xl flex items-center justify-center mb-5 transition-all duration-300 shadow-sm\r\n                ${selected\r\n                    ? `bg-${color}-500 text-white shadow-lg shadow-${color}-500/30 scale-110`\r\n                    : `bg-${color}-50 dark:bg-${color}-900/10 text-${color}-600 dark:text-${color}-400 group-hover:bg-${color}-500 group-hover:text-white group-hover:scale-110`\r\n                }\r\n            `}>\r\n                <Icon className=\"w-6 h-6\" />\r\n            </div>\r\n\r\n            <div className=\"mb-4 flex-1 relative z-10 w-full\">\r\n                <h3 className={`text-lg font-black mb-2 transition-colors leading-tight tracking-tight ${selected ? 'text-slate-900 dark:text-white' : 'text-slate-800 dark:text-slate-100'}`}>\r\n                    {service.title}\r\n                </h3>\r\n                <p className=\"text-sm text-slate-500 dark:text-slate-400 font-medium leading-relaxed tracking-wide line-clamp-3\">\r\n                    {service.description}\r\n                </p>\r\n            </div>\r\n\r\n            <div className=\"space-y-2 mb-6 relative z-10\">\r\n                {service.features.slice(0, 2).map((feature, idx) => (\r\n                    <div key={idx} className=\"flex items-center gap-2 text-xs font-bold text-slate-600 dark:text-slate-300\">\r\n                        <div className={`w-1.5 h-1.5 rounded-full bg-${color}-500 shadow-sm shrink-0`} />\r\n                        <span className=\"truncate\">{feature}</span>\r\n                    </div>\r\n                ))}\r\n            </div>\r\n\r\n            <div className=\"mt-auto pt-4 border-t border-slate-100 dark:border-slate-800 flex items-end justify-between relative z-10\">\r\n                <div>\r\n                    <div className=\"flex items-baseline gap-1\">\r\n                        <span className=\"text-2xl font-black text-slate-900 dark:text-white tracking-tight\">{service.price}‚Ç¨</span>\r\n                        <span className=\"text-[10px] font-bold text-slate-400 uppercase tracking-widest leading-none\">+ IVA</span>\r\n                    </div>\r\n                    <div className=\"text-[10px] font-bold text-slate-400 mt-1 uppercase tracking-wide\">\r\n                        {service.duration}\r\n                    </div>\r\n                </div>\r\n\r\n                <div className={`\r\n                    w-10 h-10 rounded-full flex items-center justify-center transition-all duration-300\r\n                    ${selected\r\n                        ? `bg-${color}-500 text-white shadow-lg shadow-${color}-500/30 rotate-0`\r\n                        : 'bg-slate-50 dark:bg-slate-800 text-slate-300 dark:text-slate-600 group-hover:bg-slate-900 dark:group-hover:bg-white group-hover:text-white dark:group-hover:text-slate-900 -rotate-45 group-hover:rotate-0'\r\n                    }\r\n                `}>\r\n                    <ArrowRight className=\"w-5 h-5\" />\r\n                </div>\r\n            </div>\r\n        </button>\r\n    );\r\n}\r\n\r\nexport default PremiumServicesPanel;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\support\\ResourceLibrary.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":4,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":4,"endColumn":24}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\nimport { BookOpen, Package, DollarSign, Wrench, AlertTriangle, ArrowRight } from 'lucide-react';\r\n\r\nexport const CATEGORIES = [\r\n    { id: 'operativa', label: 'Operativa', icon: Package, color: 'indigo', desc: 'Log√≠stica, riders, rutas' },\r\n    { id: 'finanzas', label: 'Finanzas', icon: DollarSign, color: 'emerald', desc: 'Facturas, pagos, impuestos' },\r\n    { id: 'tecnico', label: 'T√©cnico', icon: Wrench, color: 'slate', desc: 'Motos, mantenimiento, app' },\r\n    { id: 'accidente', label: 'Accidente', icon: AlertTriangle, color: 'rose', desc: 'Siniestros, seguros' },\r\n];\r\n\r\n\r\nconst ResourceLibrary: React.FC = () => {\r\n    return (\r\n        <section className=\"animate-in slide-in-from-bottom-4 duration-500 delay-100\">\r\n            <div className=\"flex items-center space-x-4 mb-8\">\r\n                <div className=\"w-14 h-14 bg-gradient-to-br from-indigo-600 to-blue-600 dark:from-indigo-500 dark:to-blue-500 rounded-2xl flex items-center justify-center shadow-lg shadow-indigo-200 dark:shadow-none transition-all\">\r\n                    <BookOpen className=\"w-7 h-7 text-white\" />\r\n                </div>\r\n                <div>\r\n                    <h2 className=\"text-3xl font-black text-slate-900 dark:text-white tracking-tight transition-colors\">Centro de Recursos</h2>\r\n                    <p className=\"text-slate-500 dark:text-slate-400 font-medium transition-colors\">Documentaci√≥n y manuales para el √©xito</p>\r\n                </div>\r\n            </div>\r\n\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6\">\r\n                {CATEGORIES.map((cat, i) => (\r\n                    <div\r\n                        key={i}\r\n                        className=\"bg-white dark:bg-slate-900/50 backdrop-blur-md rounded-2xl border border-slate-200 dark:border-slate-800 p-6 hover:shadow-xl dark:hover:shadow-indigo-500/10 hover:border-indigo-300 dark:hover:border-indigo-500/30 transition-all cursor-pointer group hover:-translate-y-1 duration-300 relative overflow-hidden shadow-sm dark:shadow-none\"\r\n                    >\r\n                        <div className=\"absolute -right-4 -top-4 w-24 h-24 bg-indigo-500/5 rounded-full blur-2xl group-hover:bg-indigo-500/10 transition-colors\" />\r\n\r\n                        <div className={`w-14 h-14 rounded-xl bg-slate-50 dark:bg-slate-800/50 flex items-center justify-center mb-4 group-hover:scale-110 transition-transform shadow-sm dark:shadow-none`}>\r\n                            <cat.icon className={`w-7 h-7 text-indigo-600 dark:text-indigo-400`} />\r\n                        </div>\r\n                        <h3 className=\"font-black text-slate-900 dark:text-slate-100 mb-2 text-lg transition-colors\">{cat.label}</h3>\r\n                        <p className=\"text-sm text-slate-500 dark:text-slate-400 leading-snug mb-3 transition-colors\">{cat.desc}</p>\r\n                        <div className=\"flex justify-between items-center mt-4 pt-4 border-t border-slate-50 dark:border-slate-800/50\">\r\n                            <span className=\"text-[10px] font-bold text-indigo-600 dark:text-indigo-400 uppercase tracking-widest\">Ver Herramientas</span>\r\n                            <div className=\"w-8 h-8 rounded-full bg-slate-50 dark:bg-slate-800 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all transform translate-x-2 group-hover:translate-x-0\">\r\n                                <ArrowRight className=\"w-4 h-4 text-indigo-600 dark:text-indigo-400\" />\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                ))}\r\n            </div>\r\n        </section>\r\n    );\r\n};\r\n\r\nexport default ResourceLibrary;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\support\\SupportDashboard.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadData'. Either include it or remove the dependency array.","line":46,"column":8,"nodeType":"ArrayExpression","endLine":46,"endColumn":25,"suggestions":[{"desc":"Update the dependencies array to be: [user, activeTab, loadData]","fix":{"range":[1786,1803],"text":"[user, activeTab, loadData]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":53,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":53,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2047,2050],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2047,2050],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":70,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":70,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2595,2598],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2595,2598],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":72,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":72,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2698,2701],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2698,2701],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":79,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":79,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2977,2980],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2977,2980],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":80,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":80,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3027,3030],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3027,3030],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":102,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":102,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3762,3765],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3762,3765],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":103,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":103,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3825,3828],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3825,3828],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react';\r\nimport { useAuth } from '../../../context/AuthContext'; // Verify path\r\nimport { supportService, SupportTicket, PremiumRequest } from '../../support/SupportService'; // Verify Import\r\nimport { notificationService } from '../../../services/notificationService';\r\nimport { MessageSquare, Star, Plus, Clock } from 'lucide-react';\r\n\r\nconst SERVICES_CATALOG = [\r\n    {\r\n        id: 'audit_advanced',\r\n        name: 'Auditor√≠a Avanzada',\r\n        description: 'An√°lisis profundo de tus m√©tricas operativas por un experto.',\r\n        price: 'Consultar',\r\n        icon: 'üìä'\r\n    },\r\n    {\r\n        id: 'finance_consulting',\r\n        name: 'Consultor√≠a Financiera',\r\n        description: 'Optimizaci√≥n de m√°rgenes y costes con nuestro CFO.',\r\n        price: 'Consultar',\r\n        icon: 'üí∞'\r\n    },\r\n    {\r\n        id: 'marketing_boost',\r\n        name: 'Impulso de Marketing',\r\n        description: 'Campa√±a local para aumentar la visibilidad de tu franquicia.',\r\n        price: 'Consultar',\r\n        icon: 'üöÄ'\r\n    }\r\n];\r\n\r\nconst SupportDashboard = () => {\r\n    const { user } = useAuth();\r\n    const [activeTab, setActiveTab] = useState<'tickets' | 'premium'>('tickets');\r\n    const [tickets, setTickets] = useState<SupportTicket[]>([]);\r\n    const [premiumRequests, setPremiumRequests] = useState<PremiumRequest[]>([]);\r\n    const [loading, setLoading] = useState(true);\r\n\r\n    // New Ticket Form State\r\n    const [isTicketModalOpen, setIsTicketModalOpen] = useState(false);\r\n    const [newTicket, setNewTicket] = useState({ subject: '', message: '', category: 'technical', priority: 'normal' });\r\n\r\n    useEffect(() => {\r\n        if (user?.uid) { // Use Franchise ID logic if user.uid is not enough\r\n            loadData();\r\n        }\r\n    }, [user, activeTab]);\r\n\r\n    const loadData = async () => {\r\n        setLoading(true);\r\n        try {\r\n            // Assume user has franchiseId or use user.uid as identifier for now\r\n            // Ideally use user.franchiseId\r\n            const fId = (user as any).franchiseId || user?.uid;\r\n\r\n            if (activeTab === 'tickets') {\r\n                const data = await supportService.getTickets(fId);\r\n                setTickets(data);\r\n            } else {\r\n                const data = await supportService.getPremiumRequests(fId);\r\n                setPremiumRequests(data);\r\n            }\r\n        } catch (error) {\r\n            console.error(error);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    const handleCreateTicket = async () => {\r\n        const fId = (user as any).franchiseId || user?.uid;\r\n        // Need franchise Name ideally\r\n        const fName = (user as any).franchiseName || 'Mi Franquicia';\r\n\r\n        await supportService.createTicket({\r\n            franchiseId: fId,\r\n            franchiseName: fName,\r\n            subject: newTicket.subject,\r\n            message: newTicket.message,\r\n            category: newTicket.category as any,\r\n            priority: newTicket.priority as any\r\n        });\r\n\r\n        // Notify Admin\r\n        await notificationService.notify(\r\n            'SUPPORT_TICKET',\r\n            fId,\r\n            fName,\r\n            {\r\n                title: 'Nuevo Ticket de Soporte',\r\n                message: `${fName} ha creado un ticket: ${newTicket.subject}`,\r\n                priority: newTicket.priority === 'high' ? 'high' : 'normal',\r\n                metadata: { franchiseId: fId }\r\n            }\r\n        );\r\n\r\n        setIsTicketModalOpen(false);\r\n        setNewTicket({ subject: '', message: '', category: 'technical', priority: 'normal' });\r\n        loadData();\r\n    };\r\n\r\n    const handleRequestService = async (service: typeof SERVICES_CATALOG[0]) => {\r\n        const fId = (user as any).franchiseId || user?.uid;\r\n        const fName = (user as any).franchiseName || 'Mi Franquicia';\r\n\r\n        if (confirm(`¬øDeseas solicitar el servicio: ${service.name}?`)) {\r\n            await supportService.requestPremiumService({\r\n                franchiseId: fId,\r\n                franchiseName: fName,\r\n                serviceId: service.id,\r\n                serviceName: service.name,\r\n            });\r\n\r\n            // Notify Admin\r\n            await notificationService.notify(\r\n                'PREMIUM_SERVICE_REQUEST',\r\n                fId,\r\n                fName,\r\n                {\r\n                    title: 'Solicitud Servicio Premium',\r\n                    message: `${fName} solicita: ${service.name}`,\r\n                    priority: 'normal',\r\n                    metadata: { franchiseId: fId, serviceName: service.name }\r\n                }\r\n            );\r\n\r\n            alert(\"Solicitud enviada correctamente.\");\r\n            loadData();\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"p-8 max-w-7xl mx-auto\">\r\n            <div className=\"flex items-center justify-between mb-8\">\r\n                <div>\r\n                    <h1 className=\"text-3xl font-black text-slate-900 tracking-tight\">Ayuda y Servicios</h1>\r\n                    <p className=\"text-slate-500 mt-2\">Gestiona tus consultas y accede a servicios exclusivos.</p>\r\n                </div>\r\n\r\n                <div className=\"flex bg-slate-100 p-1 rounded-xl\">\r\n                    <button\r\n                        onClick={() => setActiveTab('tickets')}\r\n                        className={`px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition-all ${activeTab === 'tickets' ? 'bg-white shadow-sm text-indigo-600' : 'text-slate-500 hover:text-indigo-600'}`}\r\n                    >\r\n                        <MessageSquare className=\"w-4 h-4\" /> Tickets\r\n                    </button>\r\n                    <button\r\n                        onClick={() => setActiveTab('premium')}\r\n                        className={`px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition-all ${activeTab === 'premium' ? 'bg-white shadow-sm text-amber-600' : 'text-slate-500 hover:text-amber-600'}`}\r\n                    >\r\n                        <Star className=\"w-4 h-4\" /> Servicios Premium\r\n                    </button>\r\n                </div>\r\n            </div>\r\n\r\n            {activeTab === 'tickets' && (\r\n                <div className=\"animate-in fade-in duration-300\">\r\n                    <div className=\"flex justify-end mb-4\">\r\n                        <button onClick={() => setIsTicketModalOpen(true)} className=\"bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 transition-colors shadow-lg shadow-indigo-200\">\r\n                            <Plus className=\"w-4 h-4\" /> Nuevo Ticket\r\n                        </button>\r\n                    </div>\r\n\r\n                    <div className=\"space-y-4\">\r\n                        {loading ? <p className=\"text-center text-slate-400\">Cargando...</p> : tickets.length === 0 ? (\r\n                            <div className=\"text-center py-12 bg-slate-50 rounded-2xl border border-slate-100 border-dashed\">\r\n                                <MessageSquare className=\"w-12 h-12 text-slate-300 mx-auto mb-3\" />\r\n                                <p className=\"font-bold text-slate-900\">No tienes tickets abiertos</p>\r\n                                <p className=\"text-sm text-slate-500\">Si tienes dudas, estamos aqu√≠ para ayudarte.</p>\r\n                            </div>\r\n                        ) : tickets.map(ticket => (\r\n                            <div key={ticket.id} className=\"bg-white p-5 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition-shadow relative overflow-hidden\">\r\n                                <div className={`absolute left-0 top-0 bottom-0 w-1 ${ticket.status === 'resolved' ? 'bg-emerald-500' : ticket.priority === 'high' ? 'bg-rose-500' : 'bg-indigo-500'}`} />\r\n                                <div className=\"flex justify-between items-start\">\r\n                                    <div>\r\n                                        <div className=\"flex items-center gap-2 mb-1\">\r\n                                            <span className={`text-[10px] uppercase font-bold px-2 py-0.5 rounded-full ${ticket.status === 'open' ? 'bg-indigo-50 text-indigo-600' : ticket.status === 'resolved' ? 'bg-emerald-50 text-emerald-600' : 'bg-amber-50 text-amber-600'}`}>\r\n                                                {ticket.status === 'open' ? 'Abierto' : ticket.status === 'resolved' ? 'Resuelto' : 'En Progreso'}\r\n                                            </span>\r\n                                            <span className=\"text-xs text-slate-400 font-medium\">#{ticket.id?.slice(0, 6)}</span>\r\n                                        </div>\r\n                                        <h3 className=\"font-bold text-slate-900 text-lg\">{ticket.subject}</h3>\r\n                                        <p className=\"text-slate-600 text-sm mt-1 line-clamp-2\">{ticket.message}</p>\r\n                                    </div>\r\n                                    <div className=\"text-right\">\r\n                                        <span className=\"text-xs text-slate-400 block mb-1\">Actualizado hace X</span>\r\n                                        {/* Status Badge */}\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            {activeTab === 'premium' && (\r\n                <div className=\"animate-in fade-in duration-300 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\r\n                    {/* Active Requests Tracker */}\r\n                    <div className=\"col-span-full mb-4\">\r\n                        <h3 className=\"font-bold text-slate-800 mb-3 flex items-center gap-2\"><Clock className=\"w-4 h-4\" /> Solicitudes en Curso</h3>\r\n                        {loading ? <p className=\"text-slate-400 text-sm\">Cargando...</p> : premiumRequests.length === 0 ? (\r\n                            <p className=\"text-sm text-slate-400 italic\">No tienes solicitudes activas.</p>\r\n                        ) : (\r\n                            <div className=\"grid gap-4 sm:grid-cols-2 lg:grid-cols-4\">\r\n                                {premiumRequests.map(req => (\r\n                                    <div key={req.id} className=\"bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex items-center justify-between\">\r\n                                        <div>\r\n                                            <p className=\"font-bold text-slate-900 text-sm\">{req.serviceName}</p>\r\n                                            <p className=\"text-[10px] text-slate-500 uppercase font-bold tracking-wider mt-0.5\">{req.status}</p>\r\n                                        </div>\r\n                                        <div className=\"w-2 h-2 rounded-full bg-amber-500 animate-pulse\" />\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n\r\n                    {SERVICES_CATALOG.map(service => (\r\n                        <div key={service.id} className=\"bg-white rounded-2xl p-6 shadow-sm border border-slate-100 hover:shadow-xl hover:border-indigo-100 transition-all group relative overflow-hidden\">\r\n                            <div className=\"absolute top-0 right-0 p-4 opacity-10 font-mono text-6xl group-hover:scale-110 transition-transform select-none\">{service.icon}</div>\r\n                            <h3 className=\"text-xl font-bold text-slate-900 mb-2\">{service.name}</h3>\r\n                            <p className=\"text-slate-500 text-sm mb-6 leading-relaxed\">{service.description}</p>\r\n\r\n                            <div className=\"flex items-center justify-between mt-auto\">\r\n                                <span className=\"text-xs font-bold bg-slate-100 text-slate-600 px-2 py-1 rounded-md\">{service.price}</span>\r\n                                <button onClick={() => handleRequestService(service)} className=\"bg-slate-900 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-indigo-600 transition-colors shadow-lg shadow-slate-200\">\r\n                                    Solicitar\r\n                                </button>\r\n                            </div>\r\n                        </div>\r\n                    ))}\r\n                </div>\r\n            )}\r\n\r\n            {/* New Ticket Modal (Simplified for brevity, ideally a separate component) */}\r\n            {isTicketModalOpen && (\r\n                <div className=\"fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4\">\r\n                    <div className=\"bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl animate-in zoom-in-95\">\r\n                        <h2 className=\"text-xl font-bold mb-4\">Nuevo Ticket</h2>\r\n                        <input\r\n                            className=\"w-full p-3 bg-slate-50 border border-slate-200 rounded-xl mb-3 font-bold text-slate-900 focus:ring-2 focus:ring-indigo-500 outline-none\"\r\n                            placeholder=\"Asunto\"\r\n                            value={newTicket.subject}\r\n                            onChange={(e) => setNewTicket({ ...newTicket, subject: e.target.value })}\r\n                        />\r\n                        <textarea\r\n                            className=\"w-full p-3 bg-slate-50 border border-slate-200 rounded-xl mb-4 text-sm min-h-[120px] focus:ring-2 focus:ring-indigo-500 outline-none resize-none\"\r\n                            placeholder=\"Describe tu problema...\"\r\n                            value={newTicket.message}\r\n                            onChange={(e) => setNewTicket({ ...newTicket, message: e.target.value })}\r\n                        />\r\n                        <div className=\"flex justify-end gap-3\">\r\n                            <button onClick={() => setIsTicketModalOpen(false)} className=\"px-4 py-2 text-slate-500 font-bold hover:bg-slate-50 rounded-lg\">Cancelar</button>\r\n                            <button onClick={handleCreateTicket} className=\"px-4 py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700\">Enviar Ticket</button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default SupportDashboard;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\support\\TicketDetailModal.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":10,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":10,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[425,428],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[425,428],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useRef } from 'react';\r\nimport { X, Send, ShieldCheck, Clock, Paperclip, CheckCircle } from 'lucide-react';\r\nimport { db } from '../../../lib/firebase';\r\nimport { doc, updateDoc, arrayUnion, onSnapshot, serverTimestamp, Timestamp } from 'firebase/firestore';\r\n\r\ninterface Message {\r\n    id: string;\r\n    text: string;\r\n    sender: 'user' | 'support' | 'system';\r\n    timestamp?: string | any;\r\n    createdAt?: number;\r\n}\r\n\r\ninterface Ticket {\r\n    id: string;\r\n    subject: string;\r\n    priority: 'low' | 'medium' | 'high';\r\n    status: 'open' | 'resolved' | 'closed' | 'investigating' | 'pending_user';\r\n    description: string;\r\n    createdAt?: Timestamp;\r\n    lastUpdated?: Timestamp;\r\n    messages: Message[];\r\n}\r\n\r\ninterface TicketDetailModalProps {\r\n    isOpen: boolean;\r\n    onClose: () => void;\r\n    ticketId: string | null;\r\n}\r\n\r\nconst TicketDetailModal: React.FC<TicketDetailModalProps> = ({ isOpen, onClose, ticketId }) => {\r\n    const [ticket, setTicket] = useState<Ticket | null>(null);\r\n    const [newMessage, setNewMessage] = useState('');\r\n    const [sending, setSending] = useState(false);\r\n    const messagesEndRef = useRef<HTMLDivElement>(null);\r\n\r\n    // 1. Fetch Ticket\r\n    useEffect(() => {\r\n        if (!isOpen || !ticketId) return;\r\n        const unsubscribe = onSnapshot(doc(db, \"tickets\", ticketId), (docSnap) => {\r\n            if (docSnap.exists()) {\r\n                setTicket({ id: docSnap.id, ...docSnap.data() } as Ticket);\r\n            }\r\n        });\r\n        return () => unsubscribe();\r\n    }, [isOpen, ticketId]);\r\n\r\n    // 2. Auto-scroll\r\n    useEffect(() => {\r\n        messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" });\r\n    }, [ticket?.messages]);\r\n\r\n    const handleSendMessage = async (e: React.FormEvent) => {\r\n        e.preventDefault();\r\n        if (!newMessage.trim() || sending || !ticketId) return;\r\n        setSending(true);\r\n        try {\r\n            const messageData: Message = {\r\n                id: Date.now().toString(),\r\n                text: newMessage,\r\n                sender: 'user',\r\n                timestamp: new Date().toISOString(),\r\n                createdAt: Date.now()\r\n            };\r\n            await updateDoc(doc(db, \"tickets\", ticketId), {\r\n                messages: arrayUnion(messageData),\r\n                lastUpdated: serverTimestamp(),\r\n                status: 'open' // Reabrir si escribe de nuevo\r\n            });\r\n            setNewMessage('');\r\n        } catch (error) {\r\n            console.error(\"Error sending message:\", error);\r\n        } finally {\r\n            setSending(false);\r\n        }\r\n    };\r\n\r\n    // --- MEJORA: Handler para resolver ticket ---\r\n    const handleResolve = async () => {\r\n        if (!ticketId) return;\r\n        if (!confirm(\"¬øEst√°s seguro de que quieres cerrar este ticket?\")) return;\r\n        try {\r\n            await updateDoc(doc(db, \"tickets\", ticketId), {\r\n                status: 'resolved',\r\n                lastUpdated: serverTimestamp()\r\n            });\r\n        } catch (error) {\r\n            console.error(\"Error resolving ticket:\", error);\r\n        }\r\n    };\r\n\r\n    if (!isOpen) return null;\r\n    if (!ticket) return null; // Or loader\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-950/40 dark:bg-black/80 backdrop-blur-md animate-in fade-in duration-300\">\r\n            <div className=\"bg-white dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-2xl shadow-2xl w-full max-w-4xl h-[85vh] flex flex-col overflow-hidden relative transition-colors\">\r\n\r\n                {/* --- HEADER --- */}\r\n                <div className=\"flex items-center justify-between p-5 border-b border-slate-100 dark:border-slate-800 bg-white/80 dark:bg-slate-900/90 backdrop-blur-md z-10\">\r\n                    <div className=\"flex items-center gap-4\">\r\n                        {/* Priority Icon */}\r\n                        <div className={`p - 3 rounded - xl border transition - colors ${ticket.priority === 'high'\r\n                                ? 'bg-rose-50 dark:bg-rose-500/10 text-rose-500 dark:text-rose-400 border-rose-100 dark:border-rose-500/20' :\r\n                                ticket.priority === 'medium'\r\n                                    ? 'bg-amber-50 dark:bg-amber-500/10 text-amber-500 dark:text-amber-400 border-amber-100 dark:border-amber-500/20' :\r\n                                    'bg-indigo-50 dark:bg-indigo-500/10 text-indigo-500 dark:text-indigo-400 border-indigo-100 dark:border-indigo-500/20'\r\n                            } `}>\r\n                            <ShieldCheck className=\"w-6 h-6\" />\r\n                        </div>\r\n\r\n                        {/* Title & Meta */}\r\n                        <div>\r\n                            <h2 className=\"text-xl font-black text-slate-900 dark:text-white flex items-center gap-3\">\r\n                                {ticket.subject}\r\n                                <span className=\"text-[10px] px-2 py-0.5 rounded-lg bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 border border-slate-200 dark:border-slate-700 font-black uppercase tracking-widest\">\r\n                                    #{ticket.id.slice(-6)}\r\n                                </span>\r\n                            </h2>\r\n                            <div className=\"flex items-center gap-4 text-[10px] text-slate-400 dark:text-slate-500 mt-1 font-bold uppercase tracking-widest\">\r\n                                <span className=\"flex items-center gap-1.5\">\r\n                                    <Clock className=\"w-3.5 h-3.5\" />\r\n                                    {ticket.createdAt?.seconds ? new Date(ticket.createdAt.seconds * 1000).toLocaleDateString() : 'Reciente'}\r\n                                </span>\r\n                                {ticket.status === 'resolved' && (\r\n                                    <span className=\"flex items-center gap-1.5 text-emerald-600 dark:text-emerald-400\">\r\n                                        <CheckCircle className=\"w-3.5 h-3.5\" /> RESUELTO\r\n                                    </span>\r\n                                )}\r\n                                <span className=\"text-slate-200 dark:text-slate-800\">‚Ä¢</span>\r\n                                <span className=\"text-indigo-500 dark:text-indigo-400\">Canal: App M√≥vil</span>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"flex items-center gap-3\">\r\n                        {/* MEJORA: Bot√≥n Resolver (Solo si est√° abierto) */}\r\n                        {ticket.status !== 'resolved' && (\r\n                            <button\r\n                                onClick={handleResolve}\r\n                                className=\"hidden sm:flex items-center gap-2 px-4 py-2 bg-emerald-50 dark:bg-emerald-500/10 hover:bg-emerald-100 dark:hover:bg-emerald-500/20 text-emerald-600 dark:text-emerald-400 border border-emerald-200 dark:border-emerald-500/30 rounded-xl transition-all text-[10px] font-black uppercase tracking-widest shadow-sm hover:shadow-md\"\r\n                            >\r\n                                <CheckCircle className=\"w-4 h-4\" />\r\n                                Marcar Resuelto\r\n                            </button>\r\n                        )}\r\n\r\n                        <button\r\n                            onClick={onClose}\r\n                            className=\"p-2.5 bg-slate-50 dark:bg-slate-800 text-slate-400 dark:text-slate-500 hover:text-rose-500 dark:hover:text-rose-400 rounded-xl transition-all group border border-transparent hover:border-rose-100 dark:hover:border-rose-500/20\"\r\n                            title=\"Cerrar modal\"\r\n                        >\r\n                            <X className=\"w-6 h-6 group-hover:rotate-90 transition-transform duration-300\" />\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* --- CHAT BODY --- */}\r\n                <div className=\"flex-1 overflow-y-auto p-8 space-y-8 bg-slate-50/30 dark:bg-slate-950 scroll-smooth\">\r\n                    {/* Mensaje Inicial */}\r\n                    <div className=\"flex justify-start\">\r\n                        <div className=\"max-w-[85%]\">\r\n                            <div className=\"flex items-center gap-2 mb-2 ml-1\">\r\n                                <span className=\"text-[10px] font-black text-slate-400 dark:text-slate-600 uppercase tracking-widest border-l-2 border-indigo-500 pl-2\">Descripci√≥n Inicial del Caso</span>\r\n                            </div>\r\n                            <div className=\"p-5 rounded-2xl rounded-tl-sm bg-white dark:bg-slate-900 border border-slate-100 dark:border-slate-800 text-slate-700 dark:text-slate-300 text-sm leading-relaxed shadow-sm transition-colors\">\r\n                                {ticket.description}\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Mensajes */}\r\n                    {ticket.messages && ticket.messages.map((msg, index) => {\r\n                        const isUser = msg.sender === 'user';\r\n                        const timestamp = msg.createdAt\r\n                            ? new Date(msg.createdAt)\r\n                            : (msg.timestamp ? new Date(msg.timestamp) : new Date());\r\n\r\n                        return (\r\n                            <div key={index} className={`flex ${isUser ? 'justify-end' : 'justify-start'} animate -in fade -in slide -in -from - bottom - 2 duration - 300`}>\r\n                                <div className={`max - w - [85 %] ${isUser ? 'order-1' : 'order-2'} `}>\r\n                                    <div className={`flex items - center gap - 3 mb - 1.5 ${isUser ? 'justify-end mr-1' : 'ml-1'} `}>\r\n                                        <span className={`text - [10px] font - black uppercase tracking - widest ${isUser ? 'text-indigo-500 dark:text-indigo-400' : 'text-slate-400 dark:text-slate-600'} `}>{isUser ? 'T√∫' : 'Soporte HQ'}</span>\r\n                                        <span className=\"text-[10px] font-bold text-slate-400 dark:text-slate-600\">{timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>\r\n                                    </div>\r\n                                    <div className={`p - 4 rounded - 2xl text - sm shadow - md leading - relaxed transition - all ${isUser\r\n                                            ? 'bg-gradient-to-br from-indigo-600 to-indigo-700 dark:from-indigo-600 dark:to-blue-700 text-white rounded-tr-sm border border-indigo-500/20 shadow-indigo-500/10'\r\n                                            : 'bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-200 rounded-tl-sm border border-slate-200 dark:border-slate-700'\r\n                                        } `}>\r\n                                        {msg.text}\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        );\r\n                    })}\r\n                    <div ref={messagesEndRef} />\r\n                </div>\r\n\r\n                {/* --- FOOTER --- */}\r\n                {ticket.status === 'resolved' ? (\r\n                    <div className=\"p-6 bg-white dark:bg-slate-900 border-t border-slate-100 dark:border-slate-800 flex flex-col items-center justify-center gap-4 animate-in slide-in-from-bottom-4 transition-colors\">\r\n                        <div className=\"flex items-center gap-3 px-6 py-2.5 bg-emerald-50 dark:bg-emerald-500/10 rounded-2xl border border-emerald-100 dark:border-emerald-500/20 shadow-sm\">\r\n                            <CheckCircle className=\"w-5 h-5 text-emerald-500\" />\r\n                            <p className=\"text-emerald-800 dark:text-emerald-400 text-sm font-black uppercase tracking-widest\">\r\n                                El equipo ha marcado este caso como resuelto.\r\n                            </p>\r\n                        </div>\r\n                        <button\r\n                            onClick={async () => {\r\n                                if (!ticketId) return;\r\n                                await updateDoc(doc(db, \"tickets\", ticketId), {\r\n                                    status: 'open',\r\n                                    lastUpdated: serverTimestamp()\r\n                                });\r\n                            }}\r\n                            className=\"text-[10px] font-black text-indigo-600 dark:text-indigo-400 hover:text-indigo-500 dark:hover:text-indigo-300 uppercase tracking-[0.2em] border-b-2 border-indigo-100 dark:border-indigo-500/20 hover:border-indigo-500 pb-1 transition-all\"\r\n                        >\r\n                            ¬øNecesitas m√°s ayuda? Reabrir Ticket\r\n                        </button>\r\n                    </div>\r\n                ) : (\r\n                    <div className=\"p-6 bg-white dark:bg-slate-900 border-t border-slate-100 dark:border-slate-800 transition-colors\">\r\n                        <form onSubmit={handleSendMessage} className=\"max-w-4xl mx-auto flex items-end gap-3\">\r\n                            <button\r\n                                type=\"button\"\r\n                                className=\"p-3.5 text-slate-400 dark:text-slate-500 hover:text-indigo-500 dark:hover:text-indigo-400 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-2xl transition-all border border-transparent hover:border-slate-200 dark:hover:border-slate-700\"\r\n                                title=\"Adjuntar archivo\"\r\n                            >\r\n                                <Paperclip className=\"w-5 h-5\" />\r\n                            </button>\r\n                            <div className=\"flex-1 relative group\">\r\n                                <textarea\r\n                                    value={newMessage}\r\n                                    onChange={(e) => setNewMessage(e.target.value)}\r\n                                    onKeyDown={(e) => {\r\n                                        if (e.key === 'Enter' && !e.shiftKey) {\r\n                                            e.preventDefault();\r\n                                            handleSendMessage(e);\r\n                                        }\r\n                                    }}\r\n                                    placeholder=\"Escribe tu mensaje aqu√≠...\"\r\n                                    className=\"w-full bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 text-slate-800 dark:text-slate-200 rounded-2xl py-4 px-5 pr-14 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500/50 resize-none h-[60px] min-h-[60px] max-h-[150px] scrollbar-hide placeholder:text-slate-400 dark:placeholder:text-slate-700 font-medium transition-all\"\r\n                                />\r\n                                <div className=\"absolute right-3 bottom-3 flex items-center gap-2\">\r\n                                    {/* Send Indicator dots if needed */}\r\n                                </div>\r\n                            </div>\r\n                            <button\r\n                                type=\"submit\"\r\n                                disabled={!newMessage.trim() || sending}\r\n                                className={`h - [60px] w - [60px] rounded - 2xl flex items - center justify - center transition - all ${!newMessage.trim() || sending\r\n                                        ? 'bg-slate-100 dark:bg-slate-800 text-slate-300 dark:text-slate-700 cursor-not-allowed'\r\n                                        : 'bg-indigo-600 text-white hover:bg-indigo-500 shadow-xl shadow-indigo-500/20 hover:scale-[1.05] active:scale-95'\r\n                                    } `}\r\n                                title=\"Enviar mensaje\"\r\n                            >\r\n                                <Send className={`w - 6 h - 6 ${sending ? 'animate-pulse' : ''} `} />\r\n                            </button>\r\n                        </form>\r\n                        <p className=\"mt-3 text-center text-[10px] font-bold text-slate-400 dark:text-slate-600 uppercase tracking-widest\">Presiona Enter para enviar</p>\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default TicketDetailModal;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\support\\TicketHistory.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":16,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":16,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[540,543],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[540,543],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { db } from '../../../lib/firebase';\r\nimport { collection, query, orderBy, onSnapshot, limit } from 'firebase/firestore';\r\nimport { Clock, AlertCircle, ChevronRight } from 'lucide-react';\r\nimport { type Ticket } from '../../../types/support';\r\n\r\n\r\n\r\nexport interface TicketHistoryProps {\r\n    onSelectTicket?: (ticketId: string) => void;\r\n\r\n    // Controlled Mode Props (from SupportHub)\r\n    tickets?: Ticket[];\r\n    loading?: boolean;\r\n    filter?: string;\r\n    setFilter?: (f: any) => void;\r\n    allCount?: number;\r\n    filteredCount?: number;\r\n}\r\n\r\nconst SkeletonTicket = () => (\r\n    <div className=\"bg-white/40 dark:bg-slate-900/40 border border-white/20 dark:border-slate-800 rounded-2xl p-5 space-y-3 animate-pulse\">\r\n        <div className=\"flex justify-between items-start\">\r\n            <div className=\"h-5 w-20 bg-slate-200 dark:bg-slate-800 rounded-full\" />\r\n            <div className=\"h-4 w-16 bg-slate-200 dark:bg-slate-800 rounded-lg\" />\r\n        </div>\r\n        <div className=\"space-y-2\">\r\n            <div className=\"h-4 w-3/4 bg-slate-200 dark:bg-slate-800 rounded-md\" />\r\n            <div className=\"h-3 w-1/2 bg-slate-200 dark:bg-slate-800 rounded-md\" />\r\n        </div>\r\n    </div>\r\n);\r\n\r\nconst EmptyState = () => (\r\n    <div className=\"flex flex-col items-center justify-center py-12 text-center opacity-60\">\r\n        <div className=\"w-16 h-16 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center mb-4\">\r\n            <Clock className=\"w-8 h-8 text-slate-300 dark:text-slate-600\" />\r\n        </div>\r\n        <h4 className=\"text-sm font-bold text-slate-900 dark:text-white uppercase tracking-wider mb-1\">\r\n            Sin Tickets Recientes\r\n        </h4>\r\n        <p className=\"text-xs text-slate-400 dark:text-slate-500 max-w-[200px]\">\r\n            No hay historial de consultas abierto en este momento.\r\n        </p>\r\n    </div>\r\n);\r\n\r\nconst TicketHistory: React.FC<TicketHistoryProps> = ({\r\n    onSelectTicket,\r\n    tickets: propTickets,\r\n    loading: propLoading\r\n}) => {\r\n    // Mode Detection: If propTickets provided, it's Controlled (by SupportHub). \r\n    // Otherwise, Self-Managed (fetches own data).\r\n    const isControlled = propTickets !== undefined;\r\n\r\n    const [fetchedTickets, setFetchedTickets] = useState<Ticket[]>([]);\r\n    const [internalLoading, setInternalLoading] = useState(true);\r\n\r\n    useEffect(() => {\r\n        if (isControlled) return;\r\n\r\n        const q = query(\r\n            collection(db, \"tickets\"),\r\n            orderBy(\"lastUpdated\", \"desc\"),\r\n            limit(50)\r\n        );\r\n\r\n        const unsubscribe = onSnapshot(q, (snapshot) => {\r\n            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })) as Ticket[];\r\n            setFetchedTickets(data);\r\n            setInternalLoading(false);\r\n        });\r\n        return () => unsubscribe();\r\n    }, [isControlled]);\r\n\r\n    const displayTickets = isControlled ? propTickets : fetchedTickets;\r\n    const isLoading = isControlled ? propLoading : internalLoading;\r\n\r\n    const getStatusBadge = (status: string) => {\r\n        const styles: Record<string, string> = {\r\n            open: 'bg-blue-50 dark:bg-blue-500/10 text-blue-600 dark:text-blue-400 border-blue-200 dark:border-blue-500/20',\r\n            resolved: 'bg-emerald-50 dark:bg-emerald-500/10 text-emerald-600 dark:text-emerald-400 border-emerald-200 dark:border-emerald-500/20',\r\n            closed: 'bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-700',\r\n            investigating: 'bg-amber-50 dark:bg-amber-500/10 text-amber-600 dark:text-amber-400 border-amber-200 dark:border-amber-500/20',\r\n            pending_user: 'bg-indigo-50 dark:bg-indigo-500/10 text-indigo-600 dark:text-indigo-400 border-indigo-200 dark:border-indigo-500/20',\r\n        };\r\n        const labels: Record<string, string> = {\r\n            open: 'Abierto',\r\n            resolved: 'Resuelto',\r\n            closed: 'Cerrado',\r\n            investigating: 'Revisando',\r\n            pending_user: 'Respondido'\r\n        };\r\n\r\n        return (\r\n            <span className={`px-2.5 py-1 rounded-full text-[10px] uppercase tracking-widest font-black border ${styles[status] || styles.closed}`}>\r\n                {labels[status] || status}\r\n            </span>\r\n        );\r\n    };\r\n\r\n    // --- Loading State ---\r\n    if (isLoading) {\r\n        return (\r\n            <div className=\"space-y-4\">\r\n                <SkeletonTicket />\r\n                <SkeletonTicket />\r\n                <SkeletonTicket />\r\n            </div>\r\n        );\r\n    }\r\n\r\n    // --- Empty State ---\r\n    if (!displayTickets || displayTickets.length === 0) {\r\n        return <EmptyState />;\r\n    }\r\n\r\n    // --- List Render ---\r\n    return (\r\n        <div className=\"flex flex-col space-y-4\">\r\n            {displayTickets.map((ticket) => (\r\n                <div\r\n                    key={ticket.id}\r\n                    onClick={() => onSelectTicket && onSelectTicket(ticket.id)}\r\n                    className={`\r\n                        group relative bg-white/70 dark:bg-slate-900/40 border border-white/50 dark:border-slate-800 backdrop-blur-md\r\n                        ${onSelectTicket ? 'hover:border-indigo-400/50 dark:hover:border-indigo-500/30 hover:shadow-xl hover:shadow-indigo-500/10 hover:-translate-y-1 cursor-pointer' : ''}\r\n                        rounded-2xl p-5 transition-all duration-300 shadow-sm\r\n                    `}\r\n                >\r\n                    <div className=\"flex justify-between items-start mb-3\">\r\n                        <div className=\"flex items-center gap-3\">\r\n                            {getStatusBadge(ticket.status || 'open')}\r\n                            {(ticket.priority === 'high' || ticket.urgency === 'high' || ticket.urgency === 'critical') && (\r\n                                <span className=\"flex items-center gap-1 text-[9px] font-black text-rose-600 dark:text-rose-400 bg-rose-100 dark:bg-rose-900/30 px-2 py-0.5 rounded-full border border-rose-200 dark:border-rose-500/20 uppercase tracking-wider animate-pulse\">\r\n                                    <AlertCircle className=\"w-3 h-3\" /> Cr√≠tico\r\n                                </span>\r\n                            )}\r\n                        </div>\r\n                        <span className=\"text-[10px] text-slate-400/80 dark:text-slate-500 font-bold uppercase tracking-wider flex items-center gap-1.5 bg-slate-50 dark:bg-slate-800/50 px-2 py-1 rounded-lg\">\r\n                            <Clock className=\"w-3 h-3\" />\r\n                            {ticket.lastUpdated?.seconds\r\n                                ? new Date(ticket.lastUpdated.seconds * 1000).toLocaleDateString(undefined, { day: '2-digit', month: 'short' })\r\n                                : (ticket.createdAt?.seconds\r\n                                    ? new Date(ticket.createdAt.seconds * 1000).toLocaleDateString(undefined, { day: '2-digit', month: 'short' })\r\n                                    : 'Reciente')}\r\n                        </span>\r\n                    </div>\r\n\r\n                    <div className=\"flex justify-between items-center mt-2 pl-1\">\r\n                        <div className=\"min-w-0 pr-4\">\r\n                            <h4 className=\"text-sm font-black text-slate-800 dark:text-slate-200 group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors mb-1 truncate uppercase tracking-tight\">\r\n                                {ticket.subject}\r\n                            </h4>\r\n                            <p className=\"text-xs text-slate-500 dark:text-slate-400 truncate opacity-80 font-medium\">\r\n                                {ticket.description || ticket.message || 'Sin descripci√≥n'}\r\n                            </p>\r\n                        </div>\r\n                        {onSelectTicket && (\r\n                            <div className=\"w-9 h-9 rounded-full bg-indigo-50 dark:bg-indigo-900/20 flex items-center justify-center opacity-60 group-hover:opacity-100 group-hover:bg-indigo-100 dark:group-hover:bg-indigo-900/40 group-hover:text-indigo-600 transition-all transform group-hover:scale-110 shadow-sm\">\r\n                                <ChevronRight className=\"w-4 h-4 text-slate-400 dark:text-indigo-400 group-hover:text-indigo-600 dark:group-hover:text-white transition-colors\" />\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n\r\n                    {/* Hover Glow */}\r\n                    <div className=\"absolute inset-0 rounded-2xl border-2 border-indigo-500/0 group-hover:border-indigo-500/5 pointer-events-none transition-all\" />\r\n                </div>\r\n            ))}\r\n        </div>\r\n    );\r\n};\r\nexport default TicketHistory;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\wizard\\AcademyPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\wizard\\steps\\FixedCostsForm.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\wizard\\steps\\MarketingForm.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\wizard\\steps\\ServicesForm.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\wizard\\steps\\SummaryStep.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":15,"column":11,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":15,"endColumn":14,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[463,466],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[463,466],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":58,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":58,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2451,2454],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2451,2454],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\nimport { useFormContext } from 'react-hook-form';\r\n\r\nimport { Info, TrendingUp, Wallet, ReceiptText, Banknote } from 'lucide-react';\r\nimport { formatMoney } from '../../../../lib/finance';\r\n\r\nimport { BarChart, Bar, XAxis, YAxis, Tooltip as RechartsTooltip, ResponsiveContainer, Cell } from 'recharts';\r\n\r\n\r\n\r\ninterface SummaryCardProps {\r\n    title: string;\r\n    amount: number;\r\n    type: 'income' | 'expense' | 'profit';\r\n    icon: any;\r\n    highlight?: boolean;\r\n}\r\n\r\ninterface RowProps {\r\n    label: string;\r\n    value: number;\r\n}\r\n\r\n// Subcomponents\r\nconst SummaryCard = ({ title, amount, type, icon: Icon, highlight }: SummaryCardProps) => {\r\n    const colorClass = type === 'income' ? 'text-emerald-600' : type === 'expense' ? 'text-red-600' : amount >= 0 ? 'text-blue-600' : 'text-red-600';\r\n    const bgClass = type === 'income' ? 'bg-emerald-50' : type === 'expense' ? 'bg-red-50' : amount >= 0 ? 'bg-blue-50' : 'bg-red-50';\r\n    const borderClass = highlight ? (amount >= 0 ? 'border-blue-200 ring-4 ring-blue-500/5' : 'border-red-200 ring-4 ring-red-500/5') : 'border-slate-200';\r\n\r\n    return (\r\n        <div className={`p-4 rounded-xl border ${borderClass} bg-white shadow-sm flex flex-col justify-between h-24`}>\r\n            <div className=\"flex justify-between items-start\">\r\n                <span className=\"text-[10px] font-bold uppercase text-slate-500 tracking-wider\">{title}</span>\r\n                <div className={`p-1.5 rounded-lg ${bgClass}`}>\r\n                    <Icon className={`w-3.5 h-3.5 ${colorClass}`} />\r\n                </div>\r\n            </div>\r\n            <span className={`text-xl font-black font-mono ${colorClass}`}>\r\n                {formatMoney(amount)}‚Ç¨\r\n            </span>\r\n        </div>\r\n    );\r\n};\r\n\r\nconst Row: React.FC<RowProps> = ({ label, value }) => (\r\n    <div className=\"flex justify-between items-center py-2 border-b border-slate-200 last:border-0 hover:bg-slate-50 px-2 rounded-lg transition-colors\">\r\n        <span className=\"text-slate-600\">{label}</span>\r\n        <span className=\"text-slate-800 font-mono font-bold\">{formatMoney(value)}‚Ç¨</span>\r\n    </div>\r\n);\r\n\r\nexport const SummaryStep: React.FC = () => {\r\n    const { watch } = useFormContext();\r\n    const data = watch();\r\n\r\n    const totalIncome = parseFloat(data.totalIncome || '0');\r\n    // Helper to extract numeric values safely from potentially string or number fields\r\n    const safeVal = (val: any) => parseFloat(val || 0);\r\n\r\n    // Calculate expenses based on form data structure\r\n    // We replicate the logic from `categoryTotals` but adapting to the form data format\r\n    const categoryTotals = React.useMemo(() => {\r\n        // Renting\r\n        const rentingCount = safeVal(data.renting?.count);\r\n        const rentingPrice = safeVal(data.renting?.pricePerUnit);\r\n        const rentingTotal = rentingCount * rentingPrice;\r\n\r\n        return {\r\n            team: safeVal(data.payroll) + safeVal(data.quota),\r\n            fleet: rentingTotal + safeVal(data.fuel) + safeVal(data.repairs),\r\n            structure: safeVal(data.insurance) + safeVal(data.agencyFee) + safeVal(data.prlFee) + safeVal(data.accountingFee),\r\n            marketing: safeVal(data.marketing) + safeVal(data.appFlyder) + safeVal(data.incidents) + safeVal(data.other) + ((safeVal(data.royaltyPercent) || 0) * totalIncome / 100)\r\n        };\r\n    }, [data, totalIncome]);\r\n\r\n    const totalExpenses = categoryTotals.team + categoryTotals.fleet + categoryTotals.structure + categoryTotals.marketing;\r\n    const grossProfit = totalIncome - totalExpenses;\r\n    // const margin = totalIncome > 0 ? ((grossProfit / totalIncome) * 100).toFixed(1) : '0';\r\n    const totalHours = safeVal(data.totalHours);\r\n\r\n    const taxes = React.useMemo(() => {\r\n        const irpfPercent = safeVal(data.irpfPercent) || 20;\r\n        const irpfAmount = grossProfit > 0 ? grossProfit * (irpfPercent / 100) : 0;\r\n        const netClean = grossProfit - irpfAmount;\r\n        return { irpfAmount, netClean, percent: irpfPercent };\r\n    }, [grossProfit, data.irpfPercent]);\r\n\r\n    // Recharts Data\r\n    const chartData = [\r\n        { name: 'Ingresos', value: totalIncome, fill: '#10b981' },\r\n        { name: 'Gastos', value: totalExpenses, fill: '#ef4444' },\r\n        { name: 'Beneficio', value: grossProfit, fill: grossProfit >= 0 ? '#3b82f6' : '#ef4444' }\r\n    ];\r\n\r\n    return (\r\n        <div className=\"space-y-6 animate-in fade-in duration-500\">\r\n            <div className=\"flex items-center gap-3 p-4 bg-indigo-50/50 border border-indigo-100 rounded-xl\">\r\n                <div className=\"p-2 bg-indigo-100 rounded-lg\">\r\n                    <Info className=\"w-5 h-5 text-indigo-600\" />\r\n                </div>\r\n                <div>\r\n                    <h3 className=\"font-bold text-indigo-900\">Resumen Financiero</h3>\r\n                    <p className=\"text-sm text-indigo-700\">Revisa los resultados preliminares antes de confirmar.</p>\r\n                </div>\r\n            </div>\r\n\r\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\r\n                {/* Visual Chart - Using Recharts */}\r\n                <div className=\"bg-white border border-slate-200 rounded-2xl p-4 flex flex-col relative min-h-[220px] shadow-sm\">\r\n                    <h5 className=\"text-xs font-bold text-slate-500 uppercase tracking-wider mb-4\">Resumen Financiero</h5>\r\n                    <div className=\"w-full h-[180px]\">\r\n                        <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n                            <BarChart data={chartData} margin={{ top: 5, right: 5, bottom: 5, left: 0 }}>\r\n                                <XAxis dataKey=\"name\" fontSize={10} tickLine={false} axisLine={false} />\r\n                                <YAxis hide />\r\n                                <RechartsTooltip\r\n                                    formatter={(value: number) => [formatMoney(value) + ' ‚Ç¨', 'Valor']}\r\n                                    contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }}\r\n                                />\r\n                                <Bar dataKey=\"value\" radius={[4, 4, 0, 0]}>\r\n                                    {chartData.map((entry, index) => (\r\n                                        <Cell key={`cell-${index}`} fill={entry.fill} />\r\n                                    ))}\r\n                                </Bar>\r\n                            </BarChart>\r\n                        </ResponsiveContainer>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* KPI Cards */}\r\n                <div className=\"col-span-2 grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n                    <SummaryCard title=\"Ingresos\" amount={totalIncome} type=\"income\" icon={Wallet} />\r\n                    <SummaryCard title=\"Gastos\" amount={totalExpenses} type=\"expense\" icon={ReceiptText} />\r\n                    <SummaryCard title=\"Beneficio Neto\" amount={grossProfit} type=\"profit\" icon={Banknote} highlight />\r\n                </div>\r\n            </div>\r\n\r\n            {/* OPERATIONAL EFFICIENCY BLOCK */}\r\n            {totalHours > 0 && (\r\n                <div className=\"bg-slate-900/50 border border-slate-800 rounded-2xl p-5 relative overflow-hidden\">\r\n                    <div className=\"absolute left-0 top-0 bottom-0 w-1 bg-blue-500\"></div>\r\n                    <h4 className=\"text-blue-400 font-bold uppercase text-xs tracking-wider mb-4 flex items-center gap-2\">\r\n                        Eficiencia Operativa\r\n                    </h4>\r\n                    <div className=\"grid grid-cols-2 gap-8\">\r\n                        <div>\r\n                            <p className=\"text-xs text-slate-500 mb-1\">Coste Real / Hora</p>\r\n                            <p className=\"text-2xl font-black text-white font-mono\">{formatMoney(totalExpenses / totalHours)}‚Ç¨/h</p>\r\n                        </div>\r\n                        <div>\r\n                            <p className=\"text-xs text-slate-500 mb-1\">Facturaci√≥n / Hora</p>\r\n                            <p className=\"text-2xl font-black text-emerald-400 font-mono\">{formatMoney(totalIncome / totalHours)}‚Ç¨/h</p>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            <div className=\"bg-slate-950 rounded-2xl border border-slate-800 p-6 overflow-hidden relative\">\r\n                <div className=\"absolute top-0 right-0 p-4 opacity-10\">\r\n                    <TrendingUp className=\"w-32 h-32 text-indigo-500\" />\r\n                </div>\r\n                <h4 className=\"font-bold text-white mb-6 relative z-10\">Cuenta de Resultados (P&L)</h4>\r\n                <div className=\"space-y-3 text-sm relative z-10\">\r\n                    <Row label=\"N√≥minas y Personal\" value={categoryTotals.team} />\r\n                    <Row label=\"Flota y Operaciones\" value={categoryTotals.fleet} />\r\n                    <Row label=\"Estructura y Servicios\" value={categoryTotals.structure} />\r\n                    <Row label=\"Marketing y Royalty\" value={categoryTotals.marketing} />\r\n\r\n                    <div className=\"border-t border-slate-800 my-4\"></div>\r\n\r\n                    <div className=\"flex justify-between items-center\">\r\n                        <span className=\"text-slate-400\">Resultado Operativo (EBITDA)</span>\r\n                        <span className={`font-mono font-bold text-white`}>\r\n                            {formatMoney(grossProfit)}‚Ç¨\r\n                        </span>\r\n                    </div>\r\n\r\n                    {/* TAX BLOCK */}\r\n                    <div className=\"flex justify-between items-center text-xs\">\r\n                        <span className=\"text-amber-500/80\">Estimaci√≥n IRPF ({taxes.percent}%)</span>\r\n                        <span className=\"text-amber-500 font-mono\">\r\n                            -{formatMoney(taxes.irpfAmount)}‚Ç¨\r\n                        </span>\r\n                    </div>\r\n\r\n                    <div className=\"border-t border-slate-700/50 pt-3 flex justify-between items-center mt-2\">\r\n                        <div className=\"flex flex-col\">\r\n                            <span className=\"font-black text-emerald-400 uppercase tracking-wider text-sm\">BENEFICIO NETO (LIMPIO)</span>\r\n                            <span className=\"text-[10px] text-slate-500\">Lo que te queda en el bolsillo</span>\r\n                        </div>\r\n\r\n                        <span className={`font-mono font-black text-2xl ${taxes.netClean >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>\r\n                            {formatMoney(taxes.netClean)}‚Ç¨\r\n                        </span>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default SummaryStep;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\franchise\\wizard\\steps\\VariableCostsForm.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\operations\\ContextMenu.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":9,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":9,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[251,254],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[251,254],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect } from 'react';\r\nimport { Edit2, Copy, Trash2, User, LucideIcon } from 'lucide-react';\r\n\r\ninterface Shift {\r\n    id: string;\r\n    riderName: string;\r\n    startAt: string | Date;\r\n    endAt: string | Date;\r\n    [key: string]: any;\r\n}\r\n\r\ninterface ContextMenuProps {\r\n    visible: boolean;\r\n    position: { x: number; y: number };\r\n    shift: Shift | null;\r\n    onClose: () => void;\r\n    onEdit: (shift: Shift) => void;\r\n    onCopy: (shift: Shift) => void;\r\n    onDelete: (shift: Shift) => void;\r\n    onReassign: (shift: Shift) => void;\r\n}\r\n\r\ninterface MenuItem {\r\n    icon: LucideIcon;\r\n    label: string;\r\n    shortcut: string;\r\n    action: (shift: Shift) => void;\r\n    color: string;\r\n    separator?: boolean;\r\n}\r\n\r\nconst ContextMenu: React.FC<ContextMenuProps> = ({ visible, position, shift, onClose, onEdit, onCopy, onDelete, onReassign }) => {\r\n    useEffect(() => {\r\n        const handleClick = () => onClose();\r\n        const handleEscape = (e: KeyboardEvent) => {\r\n            if (e.key === 'Escape') onClose();\r\n        };\r\n\r\n        if (visible) {\r\n            document.addEventListener('click', handleClick);\r\n            document.addEventListener('keydown', handleEscape);\r\n        }\r\n\r\n        return () => {\r\n            document.removeEventListener('click', handleClick);\r\n            document.removeEventListener('keydown', handleEscape);\r\n        };\r\n    }, [visible, onClose]);\r\n\r\n    if (!visible || !shift) return null;\r\n\r\n    const menuItems: MenuItem[] = [\r\n        {\r\n            icon: Edit2,\r\n            label: 'Editar Turno',\r\n            shortcut: 'Click',\r\n            action: onEdit,\r\n            color: 'hover:bg-blue-500/20 hover:text-blue-400'\r\n        },\r\n        {\r\n            icon: Copy,\r\n            label: 'Duplicar',\r\n            shortcut: 'Ctrl+D',\r\n            action: onCopy,\r\n            color: 'hover:bg-emerald-500/20 hover:text-emerald-400'\r\n        },\r\n        {\r\n            icon: User,\r\n            label: 'Reasignar Rider',\r\n            shortcut: '',\r\n            action: onReassign,\r\n            color: 'hover:bg-purple-500/20 hover:text-purple-400'\r\n        },\r\n        {\r\n            icon: Trash2,\r\n            label: 'Eliminar',\r\n            shortcut: 'Del',\r\n            action: onDelete,\r\n            color: 'hover:bg-red-500/20 hover:text-red-400',\r\n            separator: true\r\n        }\r\n    ];\r\n\r\n    // Adjust position to stay on screen\r\n    const adjustedPosition = {\r\n        x: Math.min(position.x, window.innerWidth - 220),\r\n        y: Math.min(position.y, window.innerHeight - (menuItems.length * 40))\r\n    };\r\n\r\n    return (\r\n        <div\r\n            className=\"fixed z-50 bg-slate-900 border border-slate-700 rounded-lg shadow-2xl overflow-hidden animate-fade-in\"\r\n            style={{\r\n                left: `${adjustedPosition.x}px`,\r\n                top: `${adjustedPosition.y}px`,\r\n                minWidth: '200px'\r\n            }}\r\n            onClick={(e) => e.stopPropagation()}\r\n        >\r\n            {/* Header */}\r\n            <div className=\"px-3 py-2 bg-slate-800/50 border-b border-slate-700\">\r\n                <div className=\"text-xs font-bold text-slate-300\">{shift.riderName}</div>\r\n                <div className=\"text-[10px] text-slate-500\">\r\n                    {new Date(shift.startAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} -\r\n                    {new Date(shift.endAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}\r\n                </div>\r\n            </div>\r\n\r\n            {/* Menu Items */}\r\n            <div className=\"py-1\">\r\n                {menuItems.map((item, idx) => {\r\n                    const Icon = item.icon;\r\n                    return (\r\n                        <React.Fragment key={idx}>\r\n                            {item.separator && <div className=\"border-t border-slate-700 my-1\" />}\r\n                            <button\r\n                                onClick={(e) => {\r\n                                    e.stopPropagation();\r\n                                    item.action(shift);\r\n                                    onClose();\r\n                                }}\r\n                                className={`w-full flex items-center justify-between px-3 py-2 text-sm transition-colors ${item.color}`}\r\n                            >\r\n                                <div className=\"flex items-center gap-2\">\r\n                                    <Icon className=\"w-4 h-4\" />\r\n                                    <span className=\"text-slate-300\">{item.label}</span>\r\n                                </div>\r\n                                {item.shortcut && (\r\n                                    <span className=\"text-[10px] text-slate-500 font-mono\">{item.shortcut}</span>\r\n                                )}\r\n                            </button>\r\n                        </React.Fragment>\r\n                    );\r\n                })}\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default ContextMenu;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\operations\\FleetManager.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\operations\\KeyboardShortcutsOverlay.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\operations\\LogisticsPerformanceCard.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":7,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":7,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[223,226],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[223,226],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":17,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":17,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[579,582],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[579,582],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":18,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":18,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[669,672],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[669,672],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":42,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":42,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1911,1914],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1911,1914],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Truck, MapPin } from 'lucide-react';\r\nimport { calculateLogisticsIntelligence, formatCurrency } from '../../utils/finance';\r\n\r\ninterface FinanceEntry {\r\n    zone?: string;\r\n    amount?: number;\r\n    [key: string]: any;\r\n}\r\n\r\ninterface LogisticsPerformanceCardProps {\r\n    financeEntries: FinanceEntry[];\r\n}\r\n\r\nconst LogisticsPerformanceCard = ({ financeEntries }: LogisticsPerformanceCardProps) => {\r\n    // 1. Calculate Aggregated Stats\r\n    const stats = calculateLogisticsIntelligence(financeEntries || []);\r\n    const totalRevenue = stats.reduce((acc: number, curr: any) => acc + curr.revenue, 0);\r\n    const totalOrders = stats.reduce((acc: number, curr: any) => acc + curr.count, 0);\r\n\r\n    // If no data, render nothing (or a subtle empty state if preferred, but user said \"null\")\r\n    if (totalRevenue === 0) return null;\r\n\r\n    return (\r\n        <div className=\"bg-slate-900/50 p-5 rounded-2xl border border-slate-800 shadow-sm backdrop-blur-sm\">\r\n            {/* Header */}\r\n            <div className=\"flex justify-between items-center mb-6\">\r\n                <div>\r\n                    <h3 className=\"text-slate-200 font-bold text-sm uppercase tracking-wider flex items-center gap-2\">\r\n                        <Truck className=\"h-4 w-4 text-indigo-500\" />\r\n                        Rendimiento Log√≠stico\r\n                    </h3>\r\n                    <p className=\"text-xs text-slate-500 mt-1\">Eficiencia por zona de reparto</p>\r\n                </div>\r\n                <div className=\"text-right\">\r\n                    <div className=\"text-xl font-mono font-bold text-white\">{formatCurrency(totalRevenue)}</div>\r\n                    <div className=\"text-[10px] text-slate-500 font-bold uppercase\">{totalOrders} env√≠os totales</div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* List of Zones */}\r\n            <div className=\"space-y-4\">\r\n                {stats.map((zone: any, index: number) => (\r\n                    <div key={index} className=\"group\">\r\n                        {/* Label Row */}\r\n                        <div className=\"flex justify-between text-xs mb-1.5\">\r\n                            <span className=\"font-bold text-slate-400 flex items-center gap-1.5 group-hover:text-indigo-400 transition-colors\">\r\n                                <MapPin className=\"h-3 w-3 opacity-50\" />\r\n                                {zone.name}\r\n                            </span>\r\n                            <span className=\"text-slate-200 font-mono\">\r\n                                {formatCurrency(zone.revenue)}\r\n                                <span className=\"text-[10px] text-slate-600 ml-1.5\">\r\n                                    ({zone.count})\r\n                                </span>\r\n                            </span>\r\n                        </div>\r\n\r\n                        {/* Progress Bar Container */}\r\n                        <div className=\"w-full bg-slate-800 rounded-full h-1.5 overflow-hidden\">\r\n                            <div\r\n                                className=\"bg-indigo-500 h-full rounded-full transition-all duration-1000 ease-out group-hover:bg-indigo-400 relative\"\r\n                                style={{ width: `${zone.percentage}%` }}\r\n                            >\r\n                                {/* Glow Effect */}\r\n                                <div className=\"absolute right-0 top-0 bottom-0 w-2 bg-white/20 blur-[2px]\" />\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                ))}\r\n            </div>\r\n\r\n            {/* Footer */}\r\n            <div className=\"mt-6 pt-4 border-t border-slate-800/50 text-[10px] text-center text-slate-600 uppercase tracking-widest font-bold\">\r\n                Analizando datos del periodo\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default LogisticsPerformanceCard;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\operations\\MobileAgendaView.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":13,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":13,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[285,288],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[285,288],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":14,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":14,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[326,329],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[326,329],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":15,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":15,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[360,363],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[360,363],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\nimport ShiftCard from './ShiftCard';\r\nimport { cn } from '../../lib/utils';\r\n\r\ninterface DayInfo {\r\n    isoDate: string;\r\n    label: string;\r\n    dateObj: Date;\r\n}\r\n\r\ninterface MobileAgendaViewProps {\r\n    days: DayInfo[];\r\n    visualEvents: Record<string, any[]>;\r\n    intelByDay?: Record<string, any[]>;\r\n    onEditShift: (shift: any) => void;\r\n    onDeleteShift: (shiftId: string) => void;\r\n    onAddShift: (isoDate: string) => void;\r\n    readOnly?: boolean;\r\n    expandedShiftId?: string | null;\r\n    isRiderMode?: boolean;\r\n}\r\n\r\n\r\n\r\n\r\n\r\nconst MobileAgendaView: React.FC<MobileAgendaViewProps> = ({\r\n    days,\r\n    visualEvents,\r\n    intelByDay = {}, // Default value to prevent crashes if undefined\r\n    onEditShift,\r\n    onDeleteShift,\r\n    readOnly = false,\r\n    expandedShiftId,\r\n    isRiderMode = false\r\n}) => {\r\n    return (\r\n        <div className=\"relative pb-32 min-h-screen bg-[#09090b]\">\r\n\r\n\r\n            <div className=\"space-y-4 relative z-10 px-4 pt-4\">\r\n                {days.map((day) => {\r\n                    const isToday = new Date().toISOString().split('T')[0] === day.isoDate;\r\n                    const dayEvents = visualEvents[day.isoDate] || [];\r\n                    const sortedEvents = [...dayEvents].sort((a, b) =>\r\n                        new Date(a.visualStart).getTime() - new Date(b.visualStart).getTime()\r\n                    );\r\n\r\n                    // Preparing Label: \"LUN 12\" or \"LUN 12 ‚Ä¢ HOY\"\r\n                    const baseLabel = `${day.label.split(' ')[0]} ${day.label.split(' ')[1]}`.toUpperCase();\r\n                    const dateLabel = isToday ? `${baseLabel} ‚Ä¢ HOY` : baseLabel;\r\n\r\n                    // Preparing Icons\r\n                    const dayIcons = intelByDay?.[day.isoDate]?.map((intel, idx) => (\r\n                        <div key={idx} className=\"flex items-center gap-2 p-1 rounded-full bg-zinc-800/50 border border-white/5\" title={intel.title}>\r\n                            {intel.type === 'holiday' && <span className=\"text-lg\">üéâ</span>}\r\n                        </div>\r\n                    ));\r\n\r\n                    return (\r\n                        <div key={day.isoDate} className=\"relative\">\r\n\r\n                            {/* SHIFTS or REST? */}\r\n                            {sortedEvents.length === 0 ? (\r\n                                // REST CARD\r\n                                <div className={cn(\r\n                                    \"p-4 rounded-[24px] border transition-all duration-300 relative overflow-hidden group mb-3\",\r\n                                    \"bg-[#09090b] border-white/5 hover:bg-[#121214]\"\r\n                                )}>\r\n                                    <div className=\"flex items-center justify-between mb-2\">\r\n                                        <span className={cn(\r\n                                            \"text-sm font-bold tracking-tight uppercase\",\r\n                                            isToday ? \"text-emerald-500\" : \"text-zinc-600\"\r\n                                        )}>\r\n                                            {dateLabel}\r\n                                        </span>\r\n                                        <div className=\"flex gap-1\">{dayIcons}</div>\r\n                                    </div>\r\n\r\n                                    <div className=\"py-4 flex flex-col items-center justify-center opacity-40 group-hover:opacity-60 transition-opacity\">\r\n                                        <p className=\"text-2xl font-black text-zinc-700 tracking-widest uppercase\">Descanso</p>\r\n                                    </div>\r\n                                </div>\r\n                            ) : (\r\n                                // SHIFT CARDS\r\n                                <div className=\"flex flex-col gap-0\">\r\n                                    {sortedEvents.map((ev, index) => (\r\n                                        <ShiftCard\r\n                                            key={ev.shiftId}\r\n                                            event={ev}\r\n                                            onClick={() => onEditShift(ev)}\r\n                                            onClone={(_ev, _e) => { }}\r\n                                            onDelete={(id) => onDeleteShift(id)}\r\n                                            readOnly={readOnly}\r\n                                            isExpanded={expandedShiftId === ev.shiftId}\r\n                                            isRiderMode={isRiderMode}\r\n                                            style={{ width: '100%' }}\r\n                                            // Pass Date/Icons mainly to the first card to act as header for that day\r\n                                            dateLabel={index === 0 ? dateLabel : undefined}\r\n                                            intelIcons={index === 0 ? dayIcons : undefined}\r\n                                        />\r\n                                    ))}\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    );\r\n                })}\r\n            </div>\r\n\r\n            {/* Bottom Gradient Fade */}\r\n            <div className=\"fixed bottom-0 left-0 right-0 h-24 bg-gradient-to-t from-[#09090b] to-transparent pointer-events-none z-30\" />\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default MobileAgendaView;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\operations\\MotoManagement.tsx","messages":[{"ruleId":"@typescript-eslint/no-empty-object-type","severity":2,"message":"An interface declaring no members is equivalent to its supertype.","line":11,"column":11,"nodeType":"Identifier","messageId":"noEmptyInterfaceWithSuper","endLine":11,"endColumn":23,"suggestions":[{"messageId":"replaceEmptyInterfaceWithSuper","fix":{"range":[401,451],"text":"type MotoFormData = CreateMotoInput"},"desc":"Replace empty interface with a type alias."}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\operations\\MotoManagement.tsx:38:29\n  36 |\n  37 |     useEffect(() => {\n> 38 |         const unsubscribe = loadMotos();\n     |                             ^^^^^^^^^ Avoid calling setState() directly within an effect\n  39 |         return () => {\n  40 |             if (unsubscribe) unsubscribe();\n  41 |         };","line":38,"column":29,"nodeType":null,"endLine":38,"endColumn":38},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":70,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":70,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2522,2525],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2522,2525],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { useForm } from 'react-hook-form';\r\nimport {\r\n    Plus, Edit2, Trash2, Search, Truck,\r\n    Wrench, CheckCircle, Shield, FileText, X\r\n} from 'lucide-react';\r\nimport { FleetService } from '../../services/fleetService';\r\nimport { Moto, CreateMotoInput } from '../../schemas/fleet';\r\nimport { toFranchiseId } from '../../schemas/scheduler';\r\n\r\ninterface MotoFormData extends CreateMotoInput { }\r\n\r\ninterface MotoManagementProps {\r\n    franchiseId: string;\r\n    readOnly?: boolean;\r\n}\r\n\r\nconst MotoManagement: React.FC<MotoManagementProps> = ({ franchiseId, readOnly = false }) => {\r\n    const [motos, setMotos] = useState<Moto[]>([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const [isModalOpen, setIsModalOpen] = useState(false);\r\n    const [editingMoto, setEditingMoto] = useState<Moto | null>(null);\r\n    const [searchTerm, setSearchTerm] = useState('');\r\n\r\n    const { register, handleSubmit, reset, formState: { errors } } = useForm<MotoFormData>();\r\n\r\n    const loadMotos = React.useCallback(() => {\r\n        if (!franchiseId) return;\r\n        setLoading(true);\r\n        // Using Realtime subscription from FleetService\r\n        return FleetService.subscribeToMotos(toFranchiseId(franchiseId), (data) => {\r\n            setMotos(data);\r\n            setLoading(false);\r\n        });\r\n    }, [franchiseId]);\r\n\r\n    useEffect(() => {\r\n        const unsubscribe = loadMotos();\r\n        return () => {\r\n            if (unsubscribe) unsubscribe();\r\n        };\r\n    }, [loadMotos]);\r\n\r\n    const onSubmit = async (data: MotoFormData) => {\r\n        if (!franchiseId) {\r\n            alert(\"Error: No hay ID de franquicia asignado. Recarga la p√°gina.\");\r\n            return;\r\n        }\r\n        try {\r\n            const payload = {\r\n                ...data,\r\n                nextRevisionKm: Number(data.nextRevisionKm),\r\n                currentKm: Number(data.currentKm),\r\n                // franchiseId is injected by Service for creates, optional for updates\r\n            };\r\n\r\n            if (editingMoto) {\r\n                await FleetService.updateMoto(editingMoto.id, payload);\r\n            } else {\r\n                await FleetService.createMoto(toFranchiseId(franchiseId), {\r\n                    ...payload,\r\n                    status: 'active'\r\n                });\r\n            }\r\n            setIsModalOpen(false);\r\n            reset();\r\n            setEditingMoto(null);\r\n            // Auto-refresh via subscription\r\n\r\n        } catch (error: any) {\r\n            console.error(\"Error saving moto:\", error);\r\n            alert(\"Error al guardar: \" + error.message);\r\n        }\r\n    };\r\n\r\n    const handleEdit = (moto: Moto) => {\r\n        setEditingMoto(moto);\r\n        reset({\r\n            plate: moto.plate,\r\n            brand: moto.brand,\r\n            model: moto.model,\r\n            vin: moto.vin || '',\r\n            currentKm: moto.currentKm,\r\n            nextRevisionKm: moto.nextRevisionKm,\r\n            status: moto.status,\r\n            insuranceExpiry: moto.insuranceExpiry || ''\r\n        });\r\n        setIsModalOpen(true);\r\n    };\r\n\r\n    const handleDelete = async (id: string) => {\r\n        if (!confirm('¬øEst√°s seguro de desactivar esta moto?')) return;\r\n        try {\r\n            await FleetService.updateMoto(id, { status: 'deleted' });\r\n        } catch (error) {\r\n            console.error(\"Error deleting moto:\", error);\r\n        }\r\n    };\r\n\r\n    // Quick Action: Toggle Repair/Active\r\n    const toggleStatus = async (moto: Moto, e: React.MouseEvent) => {\r\n        e.stopPropagation();\r\n        const newStatus: Moto['status'] = moto.status === 'maintenance' ? 'active' : 'maintenance';\r\n        try {\r\n            await FleetService.updateMoto(moto.id, { status: newStatus });\r\n        } catch (error) {\r\n            console.error(\"Error toggling status\", error);\r\n        }\r\n    };\r\n\r\n    const filteredMotos = motos.filter(m =>\r\n        m.plate?.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n        m.model?.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n        m.vin?.toLowerCase().includes(searchTerm.toLowerCase())\r\n    );\r\n\r\n    const getStatusConfig = (status: Moto['status']) => {\r\n        switch (status) {\r\n            case 'active': return {\r\n                icon: CheckCircle,\r\n                text: 'OPERATIVA',\r\n                classes: 'bg-emerald-50 text-emerald-700 border-emerald-200'\r\n            };\r\n            case 'maintenance': return {\r\n                icon: Wrench,\r\n                text: 'EN TALLER',\r\n                classes: 'bg-amber-50 text-amber-700 border-amber-200'\r\n            };\r\n            case 'deleted': return {\r\n                icon: Trash2,\r\n                text: 'ELIMINADA',\r\n                classes: 'bg-slate-100 text-slate-500 border-slate-200'\r\n            };\r\n            default: return {\r\n                icon: Truck,\r\n                text: 'DESCONOCIDO',\r\n                classes: 'bg-slate-100 text-slate-500 border-slate-200'\r\n            };\r\n        }\r\n    };\r\n\r\n    const getMaintenanceColor = (current: number, max: number) => {\r\n        const percentage = (current / max) * 100;\r\n        if (percentage > 90) return 'bg-red-500 shadow-[0_0_10px_rgba(239,68,68,0.3)]';\r\n        if (percentage > 75) return 'bg-amber-500';\r\n        return 'bg-emerald-500';\r\n    };\r\n\r\n    return (\r\n        <div className=\"space-y-6 animate-fade-in h-full flex flex-col font-sans\">\r\n            {/* --- HEADER --- */}\r\n            <div className=\"flex flex-col md:flex-row justify-between items-center gap-4 p-1\">\r\n                <div className=\"relative w-full md:w-72 group\">\r\n                    <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 group-focus-within:text-blue-500 transition-colors w-4 h-4\" />\r\n                    <input\r\n                        type=\"text\"\r\n                        placeholder=\"Buscar por matr√≠cula, modelo o VIN...\"\r\n                        className=\"w-full bg-white border border-slate-200 rounded-xl pl-10 pr-4 py-2.5 text-slate-700 focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all placeholder:text-slate-400 shadow-sm\"\r\n                        value={searchTerm}\r\n                        onChange={(e) => setSearchTerm(e.target.value)}\r\n                    />\r\n                </div>\r\n\r\n                {!readOnly && (\r\n                    <button\r\n                        onClick={() => {\r\n                            setEditingMoto(null);\r\n                            reset({\r\n                                plate: '', brand: '', model: '', vin: '',\r\n                                currentKm: 0, nextRevisionKm: 5000, status: 'active'\r\n                            });\r\n                            setIsModalOpen(true);\r\n                        }}\r\n                        className=\"flex items-center gap-2 px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold transition-all shadow-lg shadow-blue-500/20 active:scale-[0.98]\"\r\n                    >\r\n                        <Plus className=\"w-4 h-4\" />\r\n                        <span>Nueva Moto</span>\r\n                    </button>\r\n                )}\r\n            </div>\r\n\r\n            {/* --- GRID DE ACTIVOS --- */}\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 gap-6 pb-20\">\r\n                {loading ? (\r\n                    [1, 2, 3].map(i => <div key={i} className=\"h-64 bg-slate-50 rounded-2xl animate-pulse border border-slate-200\" />)\r\n                ) : filteredMotos.length === 0 ? (\r\n                    <div className=\"col-span-full flex flex-col items-center justify-center py-20 text-slate-400 opacity-80\">\r\n                        <Truck className=\"w-16 h-16 mb-4 text-slate-300\" />\r\n                        <p>No se encontraron motos en la flota.</p>\r\n                    </div>\r\n                ) : (\r\n                    filteredMotos.map(moto => {\r\n                        const statusConfig = getStatusConfig(moto.status);\r\n                        const StatusIcon = statusConfig.icon;\r\n                        const maintenancePct = Math.min((moto.currentKm / moto.nextRevisionKm) * 100, 100);\r\n\r\n                        return (\r\n                            <div key={moto.id} className=\"group bg-white border border-slate-200 hover:border-blue-300 rounded-2xl overflow-hidden transition-all hover:shadow-xl hover:shadow-slate-200/50 flex flex-col\">\r\n                                {/* Card Header */}\r\n                                <div className=\"p-5 border-b border-slate-100 flex justify-between items-start bg-slate-50/50\">\r\n                                    <div>\r\n                                        <div className=\"flex items-center gap-2 mb-1\">\r\n                                            <h3 className=\"font-bold text-slate-800 text-xl font-mono tracking-wider\">\r\n                                                {moto.plate}\r\n                                            </h3>\r\n                                            <span className={`px-2 py-0.5 rounded text-[10px] font-bold border uppercase tracking-wide flex items-center gap-1.5 ${statusConfig.classes}`}>\r\n                                                <StatusIcon className=\"w-3 h-3\" />\r\n                                                {statusConfig.text}\r\n                                            </span>\r\n                                        </div>\r\n                                        <p className=\"text-slate-500 text-xs font-medium uppercase tracking-wide\">\r\n                                            {moto.brand} <span className=\"text-slate-300\">|</span> {moto.model}\r\n                                        </p>\r\n                                    </div>\r\n\r\n                                    {!readOnly && (\r\n                                        <div className=\"flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity\">\r\n                                            <button onClick={() => handleEdit(moto)} aria-label=\"Editar moto\" className=\"p-2 hover:bg-slate-100 rounded-lg text-slate-400 hover:text-blue-600 transition-colors\">\r\n                                                <Edit2 className=\"w-4 h-4\" />\r\n                                            </button>\r\n                                        </div>\r\n                                    )}\r\n                                </div>\r\n\r\n                                {/* Card Body */}\r\n                                <div className=\"p-5 flex-1 space-y-4\">\r\n                                    {/* Mantenimiento */}\r\n                                    <div>\r\n                                        <div className=\"flex justify-between text-xs mb-2\">\r\n                                            <span className=\"text-slate-500 font-semibold flex items-center gap-1.5\">\r\n                                                <Wrench className=\"w-3.5 h-3.5 text-slate-400\" />\r\n                                                Estado de Revisi√≥n\r\n                                            </span>\r\n                                            <span className=\"text-slate-700 font-mono font-bold\">\r\n                                                {moto.currentKm.toLocaleString()} <span className=\"text-slate-300\">/</span> {moto.nextRevisionKm.toLocaleString()} km\r\n                                            </span>\r\n                                        </div>\r\n                                        <div className=\"w-full h-2 bg-slate-100 rounded-full overflow-hidden border border-slate-200\">\r\n                                            <div\r\n                                                className={`h-full rounded-full transition-all duration-500 ${getMaintenanceColor(moto.currentKm, moto.nextRevisionKm)}`}\r\n                                                style={{ width: `${maintenancePct}%` }}\r\n                                            />\r\n                                        </div>\r\n                                    </div>\r\n\r\n                                    {/* Detalles T√©cnicos */}\r\n                                    <div className=\"grid grid-cols-2 gap-3 pt-2\">\r\n                                        <div className=\"bg-slate-50 rounded-lg p-2.5 border border-slate-100\">\r\n                                            <p className=\"text-[10px] text-slate-400 uppercase font-bold mb-1 flex items-center gap-1\">\r\n                                                <FileText className=\"w-3 h-3\" /> VIN\r\n                                            </p>\r\n                                            <p className=\"text-xs text-slate-600 font-mono truncate font-medium\" title={moto.vin || 'N/A'}>\r\n                                                {moto.vin || '---'}\r\n                                            </p>\r\n                                        </div>\r\n                                        <div className=\"bg-slate-50 rounded-lg p-2.5 border border-slate-100\">\r\n                                            <p className=\"text-[10px] text-slate-400 uppercase font-bold mb-1 flex items-center gap-1\">\r\n                                                <Shield className=\"w-3 h-3\" /> Seguro\r\n                                            </p>\r\n                                            <p className={`text-xs font-mono font-medium ${moto.insuranceExpiry && new Date(moto.insuranceExpiry) < new Date() ? 'text-red-500' : 'text-slate-600'\r\n                                                }`}>\r\n                                                {moto.insuranceExpiry ? new Date(moto.insuranceExpiry).toLocaleDateString() : '---'}\r\n                                            </p>\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n\r\n                                {/* Quick Actions Footer */}\r\n                                {!readOnly && (\r\n                                    <div className=\"p-3 bg-slate-50 border-t border-slate-100 flex gap-2\">\r\n                                        {(moto.status === 'maintenance' || moto.status === 'deleted') ? (\r\n                                            <button\r\n                                                onClick={(e) => toggleStatus(moto, e)}\r\n                                                className=\"flex-1 py-2 rounded-lg bg-white hover:bg-emerald-50 text-emerald-600 border border-slate-200 hover:border-emerald-200 text-xs font-bold uppercase tracking-wide transition-all flex items-center justify-center gap-2 shadow-sm\"\r\n                                            >\r\n                                                <CheckCircle className=\"w-3.5 h-3.5\" /> Marcar Operativa\r\n                                            </button>\r\n                                        ) : (\r\n                                            <button\r\n                                                onClick={(e) => toggleStatus(moto, e)}\r\n                                                className=\"flex-1 py-2 rounded-lg bg-white hover:bg-amber-50 text-slate-500 hover:text-amber-600 border border-slate-200 hover:border-amber-200 text-xs font-bold uppercase tracking-wide transition-all flex items-center justify-center gap-2 shadow-sm\"\r\n                                            >\r\n                                                <Wrench className=\"w-3.5 h-3.5\" /> Enviar a Taller\r\n                                            </button>\r\n                                        )}\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n                        );\r\n                    })\r\n                )}\r\n            </div>\r\n\r\n            {/* --- MODAL \"EXECUTIVE\" --- */}\r\n            {isModalOpen && (\r\n                <div className=\"fixed inset-0 bg-slate-900/20 backdrop-blur-sm z-[60] flex items-center justify-center p-4 animate-in fade-in duration-200\">\r\n                    <div className=\"bg-white border border-slate-200 rounded-2xl w-full max-w-lg shadow-2xl flex flex-col max-h-[90vh]\">\r\n                        {/* Modal Header */}\r\n                        <div className=\"p-6 border-b border-slate-100 bg-slate-50/80 rounded-t-2xl flex justify-between items-center cursor-move\">\r\n                            <div>\r\n                                <h2 className=\"text-xl font-bold text-slate-900 flex items-center gap-2\">\r\n                                    {editingMoto ? <Edit2 className=\"w-5 h-5 text-blue-600\" /> : <Plus className=\"w-5 h-5 text-blue-600\" />}\r\n                                    {editingMoto ? 'Editar Activo' : 'Registrar Nueva Moto'}\r\n                                </h2>\r\n                                <p className=\"text-sm text-slate-500 mt-1\">Completa la ficha t√©cnica del veh√≠culo.</p>\r\n                            </div>\r\n                            <button onClick={() => setIsModalOpen(false)} aria-label=\"Cerrar modal\" className=\"text-slate-400 hover:text-slate-600 transition-colors p-1 hover:bg-slate-100 rounded-lg\">\r\n                                <X className=\"w-6 h-6\" />\r\n                            </button>\r\n                        </div>\r\n\r\n                        {/* Modal Body */}\r\n                        <form onSubmit={handleSubmit(onSubmit)} className=\"flex-1 overflow-y-auto p-6 space-y-6\">\r\n\r\n                            {/* Secci√≥n Identificaci√≥n */}\r\n                            <div className=\"space-y-4\">\r\n                                <h3 className=\"text-xs font-bold text-blue-600 uppercase tracking-wider flex items-center gap-2 border-b border-blue-100 pb-2\">\r\n                                    <Truck className=\"w-4 h-4\" /> Identificaci√≥n\r\n                                </h3>\r\n                                <div className=\"grid grid-cols-2 gap-4\">\r\n                                    <div className=\"space-y-1.5\">\r\n                                        <label className=\"text-xs font-bold text-slate-700\">Matr√≠cula</label>\r\n                                        <input\r\n                                            {...register('plate', { required: 'Requerido' })}\r\n                                            className=\"w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 text-slate-900 focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 font-mono uppercase transition-all shadow-sm\"\r\n                                            placeholder=\"0000 XXX\"\r\n                                        />\r\n                                        {errors.plate && <span className=\"text-red-500 text-xs font-semibold\">{errors.plate.message}</span>}\r\n                                    </div>\r\n                                    <div className=\"space-y-1.5\">\r\n                                        <label className=\"text-xs font-bold text-slate-700\">VIN (Bastidor)</label>\r\n                                        <input\r\n                                            {...register('vin')}\r\n                                            className=\"w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 text-slate-900 focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 font-mono uppercase transition-all shadow-sm\"\r\n                                            placeholder=\"XXXXXXXXXXXXXXXXX\"\r\n                                        />\r\n                                    </div>\r\n                                </div>\r\n                                <div className=\"grid grid-cols-2 gap-4\">\r\n                                    <div className=\"space-y-1.5\">\r\n                                        <label className=\"text-xs font-bold text-slate-700\">Marca</label>\r\n                                        <input\r\n                                            {...register('brand', { required: 'Requerido' })}\r\n                                            className=\"w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 text-slate-900 focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all shadow-sm\"\r\n                                            placeholder=\"Honda...\"\r\n                                        />\r\n                                    </div>\r\n                                    <div className=\"space-y-1.5\">\r\n                                        <label className=\"text-xs font-bold text-slate-700\">Modelo</label>\r\n                                        <input\r\n                                            {...register('model', { required: 'Requerido' })}\r\n                                            className=\"w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 text-slate-900 focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all shadow-sm\"\r\n                                            placeholder=\"PCX 125...\"\r\n                                        />\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n\r\n                            {/* Secci√≥n Estado & Seguro */}\r\n                            <div className=\"space-y-4 pt-2\">\r\n                                <h3 className=\"text-xs font-bold text-amber-600 uppercase tracking-wider flex items-center gap-2 border-b border-amber-100 pb-2\">\r\n                                    <Wrench className=\"w-4 h-4\" /> Mantenimiento & Legal\r\n                                </h3>\r\n                                <div className=\"grid grid-cols-2 gap-4\">\r\n                                    <div className=\"space-y-1.5\">\r\n                                        <label className=\"text-xs font-bold text-slate-700\">Km Actuales</label>\r\n                                        <input\r\n                                            {...register('currentKm', { required: true, min: 0 })}\r\n                                            type=\"number\"\r\n                                            className=\"w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 text-slate-900 focus:ring-2 focus:ring-amber-500/20 focus:border-amber-500 font-mono transition-all shadow-sm\"\r\n                                        />\r\n                                    </div>\r\n                                    <div className=\"space-y-1.5\">\r\n                                        <label className=\"text-xs font-bold text-slate-700\">Pr√≥xima Revisi√≥n</label>\r\n                                        <input\r\n                                            {...register('nextRevisionKm', { required: true, min: 0 })}\r\n                                            type=\"number\"\r\n                                            className=\"w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 text-slate-900 focus:ring-2 focus:ring-amber-500/20 focus:border-amber-500 font-mono transition-all shadow-sm\"\r\n                                        />\r\n                                    </div>\r\n                                </div>\r\n                                <div className=\"grid grid-cols-2 gap-4\">\r\n                                    <div className=\"space-y-1.5\">\r\n                                        <label className=\"text-xs font-bold text-slate-700\">Vencimiento Seguro</label>\r\n                                        <input\r\n                                            {...register('insuranceExpiry')}\r\n                                            type=\"date\"\r\n                                            className=\"w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 text-slate-900 focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all shadow-sm\"\r\n                                        />\r\n                                    </div>\r\n                                    <div className=\"space-y-1.5\">\r\n                                        <label className=\"text-xs font-bold text-slate-700\">Estado Actual</label>\r\n                                        <select\r\n                                            {...register('status')}\r\n                                            className=\"w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 text-slate-900 focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all shadow-sm\"\r\n                                        >\r\n                                            <option value=\"active\">Operativa</option>\r\n                                            <option value=\"maintenance\">Revisi√≥n Pendiente / Taller</option>\r\n                                            <option value=\"deleted\">Desactivada</option>\r\n                                        </select>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n\r\n                            {/* Footer Buttons */}\r\n                            <div className=\"flex gap-3 pt-4 border-t border-slate-100\">\r\n                                <button\r\n                                    type=\"button\"\r\n                                    onClick={() => setIsModalOpen(false)}\r\n                                    className=\"flex-1 px-4 py-3 bg-white hover:bg-slate-50 text-slate-600 border border-slate-200 rounded-xl font-medium transition-colors shadow-sm\"\r\n                                >\r\n                                    Cancelar\r\n                                </button>\r\n                                <button\r\n                                    type=\"submit\"\r\n                                    className=\"flex-1 px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg shadow-blue-500/30 transition-all active:scale-[0.98]\"\r\n                                >\r\n                                    {editingMoto ? 'Guardar Cambios' : 'Registrar Moto'}\r\n                                </button>\r\n                            </div>\r\n\r\n                            {editingMoto && (\r\n                                <div className=\"pt-2 flex justify-center\">\r\n                                    <button\r\n                                        type=\"button\"\r\n                                        onClick={() => handleDelete(editingMoto.id)}\r\n                                        className=\"text-xs text-red-500 hover:text-red-700 flex items-center gap-1 opacity-60 hover:opacity-100 transition-opacity font-medium\"\r\n                                    >\r\n                                        <Trash2 className=\"w-3 h-3\" /> Desactivar permanentemente este activo\r\n                                    </button>\r\n                                </div>\r\n                            )}\r\n                        </form>\r\n                    </div>\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default MotoManagement;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\operations\\OperationsDashboard.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":128,"column":74,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":128,"endColumn":77,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6059,6062],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6059,6062],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useCallback, useMemo, Suspense, lazy } from 'react';\r\nimport { addDays, subDays } from 'date-fns';\r\nimport { useAuth } from '../../context/AuthContext';\r\nimport { useWeeklySchedule, Shift } from '../../hooks/useWeeklySchedule';\r\nimport OperationsHeader from './OperationsHeader';\r\nimport OperationsTabs from './components/OperationsTabs';\r\nimport WeeklySummaryView from './views/WeeklySummaryView';\r\nimport ShiftManagerView from './views/ShiftManagerView';\r\nimport OperationsFranchiseSelector from './OperationsFranchiseSelector';\r\nimport OperationsTutorialModal from './OperationsTutorialModal';\r\nimport { ShieldAlert } from 'lucide-react';\r\nimport FranchiseDashboard from '../franchise/FranchiseDashboard';\r\nimport UserManagementPanel from '../admin/users/UserManagementPanel';\r\n\r\n// Lazy load heavy components\r\nconst FleetManager = lazy(() => import('./FleetManager'));\r\n\r\ntype OperationsTab = 'summary' | 'scheduler' | 'finance' | 'riders' | 'motos';\r\ntype TimeFilter = 'all' | 'morning' | 'afternoon' | 'night';\r\n\r\ninterface OperationsDashboardProps {\r\n    readOnly?: boolean;\r\n}\r\n\r\nconst OperationsDashboard: React.FC<OperationsDashboardProps> = () => {\r\n    const { user, isAdmin } = useAuth();\r\n    const userFranchiseId = user?.uid;\r\n    const [selectedFranchiseId, setSelectedFranchiseId] = useState<string | null | undefined>(userFranchiseId);\r\n    const activeFranchiseId = isAdmin ? (selectedFranchiseId || userFranchiseId) : userFranchiseId;\r\n\r\n    const [currentDate, setCurrentDate] = useState<Date>(new Date());\r\n    const [activeTab, setActiveTab] = useState<OperationsTab>('summary');\r\n    const [timeFilter, setTimeFilter] = useState<TimeFilter>('all');\r\n    const [showTutorial, setShowTutorial] = useState<boolean>(false);\r\n\r\n    // LIFTED DATA STATE: Sync across tabs üß†\r\n    const scheduleState = useWeeklySchedule(activeFranchiseId ?? null, isAdmin ? false : true, currentDate);\r\n\r\n    // FILTER LOGIC üîç\r\n    const filteredShifts = useMemo(() => {\r\n        if (!scheduleState.weekData?.shifts) return [];\r\n        if (timeFilter === 'all') return scheduleState.weekData.shifts;\r\n\r\n        return scheduleState.weekData.shifts.filter((shift: Shift) => {\r\n            if (!shift.startAt) return false;\r\n            const shiftDate = new Date(shift.startAt);\r\n            const hour = shiftDate.getHours();\r\n            if (timeFilter === 'morning') return hour >= 6 && hour < 14;\r\n            if (timeFilter === 'afternoon') return hour >= 14 && hour < 20;\r\n            if (timeFilter === 'night') return hour >= 20 || hour < 6;\r\n            return true;\r\n        });\r\n    }, [scheduleState.weekData, timeFilter]);\r\n\r\n    const filteredScheduleState = {\r\n        ...scheduleState,\r\n        weekData: {\r\n            ...scheduleState.weekData,\r\n            shifts: filteredShifts\r\n        }\r\n    };\r\n\r\n    // Handlers\r\n    const handleDateChange = useCallback((newDate: Date) => setCurrentDate(newDate), []);\r\n\r\n    const handleNavigateWeek = (direction: 'next' | 'prev') => {\r\n        setCurrentDate(prev => direction === 'next' ? addDays(prev, 7) : subDays(prev, 7));\r\n    };\r\n\r\n    const handleJumpToToday = () => {\r\n        setCurrentDate(new Date());\r\n    };\r\n\r\n    const handleSlotClick = (date: Date) => {\r\n        setCurrentDate(date);\r\n        setActiveTab('scheduler');\r\n    };\r\n\r\n    if (!activeFranchiseId && !isAdmin) return (\r\n        <div className=\"flex items-center justify-center h-screen bg-slate-50 text-slate-400 animate-pulse\">\r\n            Inicializando Command Center...\r\n        </div>\r\n    );\r\n\r\n    return (\r\n        <div className=\"flex flex-col h-full bg-slate-50 min-h-screen text-slate-900 font-sans\">\r\n\r\n            {/* Header Area */}\r\n            <div className=\"bg-white sticky top-0 z-30 shadow-sm border-b border-slate-200\">\r\n                {isAdmin && (\r\n                    <div className=\"bg-slate-50 px-6 py-1.5 flex justify-between items-center border-b border-slate-200\">\r\n                        <span className=\"text-[10px] font-bold text-indigo-600 uppercase tracking-widest flex items-center gap-1.5\">\r\n                            <ShieldAlert size={12} /> Admin Mode\r\n                        </span>\r\n                        <div className=\"scale-90 origin-right opacity-80 hover:opacity-100 transition-opacity\">\r\n                            <OperationsFranchiseSelector\r\n                                selectedFranchiseId={activeFranchiseId}\r\n                                onSelect={setSelectedFranchiseId}\r\n                            />\r\n                        </div>\r\n                    </div>\r\n                )}\r\n\r\n                {/* GLOBAL FILTERS */}\r\n                <div className=\"px-6 py-2 bg-white flex justify-center border-b border-slate-100\">\r\n                    <div className=\"flex bg-slate-100 p-1 rounded-lg border border-slate-200\">\r\n                        {(['all', 'morning', 'afternoon', 'night'] as TimeFilter[]).map((filter) => (\r\n                            <button\r\n                                key={filter}\r\n                                onClick={() => setTimeFilter(filter)}\r\n                                className={`px-4 py-1.5 rounded-md text-xs font-bold transition-all capitalize ${timeFilter === filter\r\n                                    ? 'bg-white text-blue-700 shadow-sm border border-slate-200'\r\n                                    : 'text-slate-500 hover:text-slate-700 hover:bg-slate-200'\r\n                                    }`}\r\n                            >\r\n                                {filter === 'all' ? 'Todo' : filter === 'morning' ? 'Ma√±ana' : filter === 'afternoon' ? 'Tarde' : 'Noche'}\r\n                            </button>\r\n                        ))}\r\n                    </div>\r\n                </div>\r\n\r\n                <OperationsHeader\r\n                    currentDate={currentDate}\r\n                    onNavigate={handleNavigateWeek}\r\n                    onToday={handleJumpToToday}\r\n                />\r\n\r\n                <OperationsTabs activeTab={activeTab} onTabChange={(tab: any) => setActiveTab(tab)} />\r\n            </div>\r\n\r\n            {/* Content Area */}\r\n            <div className=\"flex-1 px-4 py-4 md:px-6 md:py-6 overflow-hidden flex flex-col\">\r\n                <div className=\"flex-1 bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden flex flex-col relative\">\r\n\r\n                    {activeTab === 'summary' && (\r\n                        <WeeklySummaryView\r\n                            currentDate={currentDate}\r\n                            onSlotClick={handleSlotClick}\r\n                            franchiseId={activeFranchiseId || ''}\r\n                            weekData={filteredScheduleState.weekData}\r\n                            loading={filteredScheduleState.loading}\r\n                        />\r\n                    )}\r\n\r\n                    {activeTab === 'scheduler' && (\r\n                        <div className=\"h-full bg-white\">\r\n                            <ShiftManagerView\r\n                                franchiseId={activeFranchiseId || ''}\r\n                                readOnly={isAdmin}\r\n                                selectedDate={currentDate}\r\n                                onDateChange={handleDateChange}\r\n                            />\r\n                        </div>\r\n                    )}\r\n\r\n                    {activeTab === 'finance' && (\r\n                        <div className=\"h-full bg-white p-6 overflow-y-auto custom-scrollbar\">\r\n                            <FranchiseDashboard />\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* Empty States for future tabs */}\r\n                    {activeTab === 'riders' && (\r\n                        <div className=\"h-full bg-white overflow-hidden\">\r\n                            <UserManagementPanel\r\n                                franchiseId={activeFranchiseId}\r\n                                readOnly={isAdmin} // Admin uses readOnly here too\r\n                            />\r\n                        </div>\r\n                    )}\r\n\r\n                    {activeTab === 'motos' && (\r\n                        <div className=\"h-full bg-white p-6 overflow-y-auto custom-scrollbar\">\r\n                            <Suspense fallback={<div className=\"p-8 text-center text-slate-400\">Cargando flota...</div>}>\r\n                                <FleetManager\r\n                                    franchiseId={activeFranchiseId}\r\n                                    readOnly={isAdmin}\r\n                                />\r\n                            </Suspense>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            <OperationsTutorialModal isOpen={showTutorial} onClose={() => setShowTutorial(false)} />\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default OperationsDashboard;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\operations\\OperationsFranchiseSelector.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\operations\\OperationsHeader.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\operations\\OperationsPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":23,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":23,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1156,1159],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1156,1159],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'selectedFranchiseId'. Either include it or remove the dependency array.","line":53,"column":8,"nodeType":"ArrayExpression","endLine":53,"endColumn":32,"suggestions":[{"desc":"Update the dependencies array to be: [isAdmin, outletContext, selectedFranchiseId]","fix":{"range":[2525,2549],"text":"[isAdmin, outletContext, selectedFranchiseId]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, Suspense, useEffect } from 'react';\r\nimport { Calendar, Users, Bike, Loader2, Store } from 'lucide-react';\r\nimport { useOutletContext } from 'react-router-dom';\r\nimport { collection, query, where, getDocs } from 'firebase/firestore';\r\nimport { db } from '../../lib/firebase';\r\nimport { useAuth } from '../../context/AuthContext';\r\n\r\nimport RidersView from '../fleet/RidersView';\r\nimport { VehiclesView } from '../fleet/vehicles/VehiclesView';\r\nimport ErrorBoundary from '../../ui/feedback/ErrorBoundary';\r\nimport DeliveryScheduler from '../scheduler/DeliveryScheduler';\r\n\r\nconst OperationsPage = () => {\r\n    // console.log('üèóÔ∏è RENDERIZANDO P√ÅGINA DE OPERACIONES');\r\n\r\n    const outletContext = useOutletContext<{ franchiseId?: string }>();\r\n    const { user } = useAuth();\r\n    // Rudimentary admin check. Ideally use a custom claim or role from context if reliable.\r\n    const isAdmin = user?.email?.includes('admin') || false;\r\n\r\n    // Franchise State for Admin Selector\r\n    const [selectedFranchiseId, setSelectedFranchiseId] = useState<string>(outletContext?.franchiseId || '');\r\n    const [franchises, setFranchises] = useState<any[]>([]);\r\n    const [loadingFranchises, setLoadingFranchises] = useState(false);\r\n\r\n    // Use selected ID if Admin, else use context ID (Standard Franchise View)\r\n    const activeFranchiseId = isAdmin ? selectedFranchiseId : (outletContext?.franchiseId || '');\r\n\r\n    // Load Franchises if Admin\r\n    useEffect(() => {\r\n        if (isAdmin && !outletContext?.franchiseId) {\r\n            const loadFranchises = async () => {\r\n                setLoadingFranchises(true);\r\n                try {\r\n                    // Fetch franchises (users with role 'franchise')\r\n                    const q = query(collection(db, 'users'), where('role', '==', 'franchise'));\r\n                    const snap = await getDocs(q);\r\n                    const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));\r\n                    setFranchises(list);\r\n                    if (list.length > 0 && !selectedFranchiseId) {\r\n                        setSelectedFranchiseId(list[0].id);\r\n                    }\r\n                } catch (e) {\r\n                    console.error(\"Error loading franchises\", e);\r\n                } finally {\r\n                    setLoadingFranchises(false);\r\n                }\r\n            };\r\n            loadFranchises();\r\n        } else if (outletContext?.franchiseId) {\r\n            setSelectedFranchiseId(outletContext.franchiseId);\r\n        }\r\n    }, [isAdmin, outletContext]);\r\n\r\n\r\n    const [activeTab, setActiveTab] = useState<'scheduler' | 'riders' | 'motos'>('scheduler');\r\n    const [selectedDate, setSelectedDate] = useState<Date>(new Date());\r\n\r\n    return (\r\n        <div className=\"h-full bg-slate-50 p-6 overflow-hidden flex flex-col space-y-6\">\r\n\r\n            {/* Header & Tabs */}\r\n            <div className=\"flex flex-col xl:flex-row items-start xl:items-center justify-between gap-4 border-b border-slate-200 pb-4 shrink-0\">\r\n                <div className=\"flex flex-col gap-2\">\r\n                    <h1 className=\"text-2xl font-bold text-slate-900 tracking-tight flex items-center gap-2\">\r\n                        {activeTab === 'scheduler' && <Calendar className=\"w-6 h-6 text-indigo-600\" />}\r\n                        {activeTab === 'riders' && <Users className=\"w-6 h-6 text-blue-600\" />}\r\n                        {activeTab === 'motos' && <Bike className=\"w-6 h-6 text-orange-600\" />}\r\n\r\n                        {activeTab === 'scheduler' ? 'Planificador de Horarios' :\r\n                            activeTab === 'riders' ? 'Grid de Talento' : 'Gesti√≥n de Flota'}\r\n                    </h1>\r\n\r\n                    {/* Admin Franchise Context Indicator or Selector */}\r\n                    {isAdmin ? (\r\n                        <div className=\"flex items-center gap-2 bg-indigo-50 border border-indigo-100 rounded-lg p-1.5 self-start\">\r\n                            <div className=\"p-1 bg-white rounded-md shadow-sm\">\r\n                                <Store className=\"w-4 h-4 text-indigo-600\" />\r\n                            </div>\r\n\r\n                            {outletContext?.franchiseId ? (\r\n                                // Locked Context\r\n                                <span className=\"text-sm font-bold text-indigo-900 px-1\">\r\n                                    Viendo Franquicia: <span className=\"opacity-70\">{activeFranchiseId}</span>\r\n                                </span>\r\n                            ) : (\r\n                                // Selector Context\r\n                                <select\r\n                                    className=\"bg-transparent text-sm font-bold text-indigo-900 border-none focus:ring-0 cursor-pointer min-w-[200px]\"\r\n                                    value={selectedFranchiseId}\r\n                                    onChange={(e) => setSelectedFranchiseId(e.target.value)}\r\n                                    disabled={loadingFranchises}\r\n                                    aria-label=\"Seleccionar Franquicia\"\r\n                                >\r\n                                    {loadingFranchises && <option>Cargando franquicias...</option>}\r\n                                    {franchises.map(f => (\r\n                                        <option key={f.id} value={f.id}>\r\n                                            {f.franchiseName || f.name || 'Franquicia sin nombre'}\r\n                                        </option>\r\n                                    ))}\r\n                                </select>\r\n                            )}\r\n                        </div>\r\n                    ) : (\r\n                        <p className=\"text-slate-500 text-sm mt-1\">\r\n                            {activeTab === 'scheduler' ? 'Visualiza y gestiona los turnos semanales.' :\r\n                                activeTab === 'riders' ? 'Control de documentaci√≥n y personal activo.' : 'Control de veh√≠culos, mantenimiento y estados.'}\r\n                        </p>\r\n                    )}\r\n                </div>\r\n\r\n                <div className=\"flex items-center gap-3 self-end xl:self-auto\">\r\n                    <div className=\"bg-slate-100 p-1 rounded-xl flex border border-slate-200\">\r\n                        <button\r\n                            onClick={() => setActiveTab('scheduler')}\r\n                            className={`px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition-all ${activeTab === 'scheduler'\r\n                                ? 'bg-white text-indigo-700 shadow-sm border border-slate-200'\r\n                                : 'text-slate-500 hover:text-indigo-600 hover:bg-slate-200/50'\r\n                                } `}\r\n                        >\r\n                            <Calendar className=\"w-4 h-4\" />\r\n                            <span className=\"hidden md:inline\">Horarios</span>\r\n                        </button>\r\n                        <div className=\"w-px bg-slate-200 mx-1 my-2\" />\r\n                        <button\r\n                            onClick={() => setActiveTab('riders')}\r\n                            className={`px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition-all ${activeTab === 'riders'\r\n                                ? 'bg-white text-blue-700 shadow-sm border border-slate-200'\r\n                                : 'text-slate-500 hover:text-blue-600 hover:bg-slate-200/50'\r\n                                } `}\r\n                        >\r\n                            <Users className=\"w-4 h-4\" />\r\n                            <span className=\"hidden md:inline\">Equipo</span>\r\n                        </button>\r\n                        <div className=\"w-px bg-slate-200 mx-1 my-2\" />\r\n                        <button\r\n                            onClick={() => setActiveTab('motos')}\r\n                            className={`px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition-all ${activeTab === 'motos'\r\n                                ? 'bg-white text-orange-700 shadow-sm border border-slate-200'\r\n                                : 'text-slate-500 hover:text-orange-600 hover:bg-slate-200/50'\r\n                                } `}\r\n                        >\r\n                            <Bike className=\"w-4 h-4\" />\r\n                            <span className=\"hidden md:inline\">Flota</span>\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n            </div >\r\n\r\n            {/* Content Area */}\r\n            < div className=\"flex-1 overflow-hidden relative rounded-2xl bg-white border border-slate-200 shadow-sm\" >\r\n                <ErrorBoundary>\r\n                    <Suspense fallback={\r\n                        <div className=\"absolute inset-0 flex items-center justify-center\">\r\n                            <Loader2 className=\"w-8 h-8 text-indigo-500 animate-spin\" />\r\n                        </div>\r\n                    }>\r\n                        {activeTab === 'scheduler' && (\r\n                            <div className=\"h-full animate-in fade-in slide-in-from-bottom-2 duration-300\">\r\n                                <DeliveryScheduler\r\n                                    franchiseId={activeFranchiseId}\r\n                                    selectedDate={selectedDate}\r\n                                    onDateChange={setSelectedDate}\r\n                                    readOnly={isAdmin}\r\n                                />\r\n                            </div>\r\n                        )}\r\n                        {activeTab === 'riders' && (\r\n                            <div className=\"h-full overflow-y-auto animate-in fade-in slide-in-from-right-4 duration-300 p-4\">\r\n                                <RidersView franchiseId={activeFranchiseId} />\r\n                            </div>\r\n                        )}\r\n                        {activeTab === 'motos' && (\r\n                            <div className=\"h-full overflow-y-auto animate-in fade-in slide-in-from-right-4 duration-300 p-4\">\r\n                                <VehiclesView />\r\n                            </div>\r\n                        )}\r\n                    </Suspense>\r\n                </ErrorBoundary>\r\n            </div >\r\n        </div >\r\n    );\r\n};\r\n\r\nexport default OperationsPage;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\operations\\OperationsTutorialModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\operations\\QuickFillModal.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":34,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":34,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[885,888],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[885,888],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":35,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":35,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[972,975],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[972,975],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":121,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":121,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5007,5010],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5007,5010],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":181,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":181,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7103,7106],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7103,7106],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":181,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":181,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7114,7117],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7114,7117],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":255,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":255,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10164,10167],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10164,10167],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\r\nimport { X, Zap, User, Truck, Sun, Moon, Split, Copy, Loader2 } from 'lucide-react';\r\nimport { toLocalISOString } from '../../utils/dateUtils';\r\nimport { shiftService } from '../../services/shiftService';\r\nimport { subDays, addDays, parseISO, setHours, setMinutes, setSeconds, areIntervalsOverlapping } from 'date-fns';\r\n\r\ninterface Rider {\r\n    id: string;\r\n    name?: string;\r\n    email?: string;\r\n}\r\n\r\ninterface Moto {\r\n    id: string;\r\n    licensePlate: string;\r\n    model: string;\r\n}\r\n\r\ninterface WeekDay {\r\n    isoDate: string;\r\n    shortLabel: string;\r\n}\r\n\r\n// Shift interface removed to avoid unused warning\r\n\r\ninterface QuickFillModalProps {\r\n    isOpen: boolean;\r\n    onClose: () => void;\r\n    onRefresh: () => void;\r\n    franchiseId: string;\r\n    riders: Rider[];\r\n    motos: Moto[];\r\n    weekDays: WeekDay[];\r\n    existingShifts?: any[]; // relaxed type to avoid deep interface mismatch\r\n    onCreateShifts?: (shifts: any[]) => Promise<void>;\r\n}\r\n\r\ntype PresetType = 'custom' | 'comida' | 'cena' | 'partido';\r\n\r\nconst QuickFillModal: React.FC<QuickFillModalProps> = ({\r\n    isOpen, onClose, onRefresh, franchiseId, riders, motos, weekDays, existingShifts = [], onCreateShifts\r\n}) => {\r\n    // Estado local del formulario\r\n    const [selectedRiderId, setSelectedRiderId] = useState('');\r\n    const [selectedMotoId, setSelectedMotoId] = useState('');\r\n    const [selectedDays, setSelectedDays] = useState<string[]>([]);\r\n    const [isProcessing, setIsProcessing] = useState(false);\r\n\r\n    // Preset State\r\n    const [activePreset, setActivePreset] = useState<PresetType>('custom');\r\n\r\n    // Horas (Editable if custom) - Support HH:mm\r\n    const [startHour, setStartHour] = useState('13:30');\r\n    const [endHour, setEndHour] = useState('16:00');\r\n\r\n    if (!isOpen) return null;\r\n\r\n    const toggleDay = (isoDate: string) => {\r\n        setSelectedDays(prev =>\r\n            prev.includes(isoDate) ? prev.filter(d => d !== isoDate) : [...prev, isoDate]\r\n        );\r\n    };\r\n\r\n    const applyPreset = (preset: PresetType) => {\r\n        setActivePreset(preset);\r\n        if (preset === 'comida') {\r\n            setStartHour('13:30');\r\n            setEndHour('16:00');\r\n        } else if (preset === 'cena') {\r\n            setStartHour('20:30');\r\n            setEndHour('23:00');\r\n        } else if (preset === 'partido') {\r\n            // Visualmente mostramos el rango completo o indicamos que es especial\r\n            setStartHour('13:30');\r\n            setEndHour('23:00'); // Indicativo\r\n        }\r\n    };\r\n\r\n    const handleGenerate = async () => {\r\n        if (!selectedRiderId || selectedDays.length === 0) {\r\n            alert(\"Selecciona al menos un rider y un d√≠a.\");\r\n            return;\r\n        }\r\n\r\n        setIsProcessing(true);\r\n        try {\r\n            const rider = riders.find(r => r.id === selectedRiderId);\r\n            if (!rider) return;\r\n\r\n            const moto = motos.find(m => m.id === selectedMotoId);\r\n            if (onCreateShifts) {\r\n                const shiftsToCreate = [];\r\n                for (const dayIso of selectedDays) {\r\n                    if (activePreset === 'partido') {\r\n                        // PARTIDO: 13:30-16:00 y 20:30-23:00\r\n                        shiftsToCreate.push({ ...createSafeShift(dayIso, '13:30', '16:00'), date: dayIso, startTime: '13:30', endTime: '16:00', riderId: selectedRiderId, riderName: rider.name || rider.email || 'Rider', motoId: selectedMotoId });\r\n                        shiftsToCreate.push({ ...createSafeShift(dayIso, '20:30', '23:00'), date: dayIso, startTime: '20:30', endTime: '23:00', riderId: selectedRiderId, riderName: rider.name || rider.email || 'Rider', motoId: selectedMotoId });\r\n                    } else {\r\n                        shiftsToCreate.push({ ...createSafeShift(dayIso, startHour, endHour), date: dayIso, startTime: startHour, endTime: endHour, riderId: selectedRiderId, riderName: rider.name || rider.email || 'Rider', motoId: selectedMotoId });\r\n                    }\r\n                }\r\n                await onCreateShifts(shiftsToCreate);\r\n            } else {\r\n                const promises: Promise<void>[] = [];\r\n                for (const dayIso of selectedDays) {\r\n                    if (activePreset === 'partido') {\r\n                        const s1 = createSafeShift(dayIso, '13:30', '16:00');\r\n                        if (!hasConflict(s1)) promises.push(saveShift(rider, moto, s1));\r\n                        const s2 = createSafeShift(dayIso, '20:30', '23:00');\r\n                        if (!hasConflict(s2)) promises.push(saveShift(rider, moto, s2));\r\n                    } else {\r\n                        const s = createSafeShift(dayIso, startHour, endHour);\r\n                        if (!hasConflict(s)) promises.push(saveShift(rider, moto, s));\r\n                    }\r\n                }\r\n                await Promise.all(promises);\r\n            }\r\n\r\n            onRefresh();\r\n            onClose();\r\n        } catch (error: any) {\r\n            console.error(\"Generaci√≥n fallida:\", error);\r\n            alert(\"Error al generar turnos: \" + error.message);\r\n        } finally {\r\n            setIsProcessing(false);\r\n            setSelectedDays([]);\r\n        }\r\n    };\r\n\r\n    const createSafeShift = (dayIso: string, sTime: string, eTime: string) => {\r\n        // Parse time support for HH:mm or HH\r\n        const parseTime = (t: string) => {\r\n            if (t.includes(':')) {\r\n                const [h, m] = t.split(':').map(Number);\r\n                return { h, m };\r\n            }\r\n            return { h: parseInt(t), m: 0 };\r\n        };\r\n\r\n        const startT = parseTime(sTime);\r\n        const endT = parseTime(eTime);\r\n\r\n        let start = parseISO(dayIso);\r\n        start = setHours(start, startT.h);\r\n        start = setMinutes(start, startT.m);\r\n        start = setSeconds(start, 0);\r\n\r\n        let end = parseISO(dayIso);\r\n        // Handle 24 or 00 as midnight next day\r\n        if (endT.h === 24 || (endT.h === 0 && endT.m === 0 && parseInt(eTime) !== 0)) {\r\n            end = addDays(end, 1);\r\n            end = setHours(end, 0);\r\n            end = setMinutes(end, 0);\r\n        } else {\r\n            end = setHours(end, endT.h);\r\n            end = setMinutes(end, endT.m);\r\n        }\r\n        end = setSeconds(end, 0);\r\n\r\n        return { start, end, startAt: toLocalISOString(start), endAt: toLocalISOString(end) };\r\n    };\r\n\r\n    const hasConflict = (newShift: { start: Date, end: Date, startAt: string }) => {\r\n        return existingShifts.some(es => {\r\n            if (es.riderId !== selectedRiderId) return false;\r\n\r\n            const esStart = new Date(es.startAt);\r\n            const esEnd = new Date(es.endAt);\r\n\r\n            // Exact duplication check (same ISO start)\r\n            if (es.startAt === newShift.startAt) return true;\r\n\r\n            // Overlap check\r\n            return areIntervalsOverlapping(\r\n                { start: newShift.start, end: newShift.end },\r\n                { start: esStart, end: esEnd }\r\n            );\r\n        });\r\n    };\r\n\r\n    const saveShift = async (rider: any, moto: any, safeShift: { startAt: string, endAt: string }) => {\r\n        await shiftService.createShift({\r\n            franchiseId,\r\n            riderId: rider.id,\r\n            riderName: rider.name || rider.email || 'Rider',\r\n            motoId: moto?.id || null,\r\n            motoPlate: moto?.licensePlate || '',\r\n            startAt: safeShift.startAt,\r\n            endAt: safeShift.endAt\r\n        });\r\n    };\r\n\r\n    const handleClonePreviousWeek = async () => {\r\n        if (!franchiseId || weekDays.length === 0) return;\r\n\r\n        const confirmClone = window.confirm(\"¬øImportar la planificaci√≥n completa de la semana pasada?\");\r\n        if (!confirmClone) return;\r\n\r\n        setIsProcessing(true);\r\n        try {\r\n            // 1. Calcular rango de la semana pasada\r\n            const currentStart = parseISO(weekDays[0].isoDate);\r\n            const prevStart = subDays(currentStart, 7);\r\n            const prevEnd = subDays(currentStart, 1);\r\n            prevEnd.setHours(23, 59, 59, 999);\r\n\r\n            // 2. Obtener turnos de la semana pasada\r\n            const oldShifts = await shiftService.getShiftsInRange(franchiseId, prevStart, prevEnd);\r\n\r\n            if (oldShifts.length === 0) {\r\n                alert(\"No hay turnos en la semana pasada para clonar.\");\r\n                return;\r\n            }\r\n\r\n            // 3. Filtrar y Replicar\r\n            const replicatedPromises = oldShifts\r\n                .map(s => {\r\n                    const newStart = addDays(new Date(s.startAt), 7);\r\n                    const newEnd = addDays(new Date(s.endAt), 7);\r\n                    const startAt = toLocalISOString(newStart);\r\n                    const endAt = toLocalISOString(newEnd);\r\n\r\n                    // Check if this replication already exists or overlaps\r\n                    const conflict = existingShifts.some(es =>\r\n                        es.riderId === s.riderId &&\r\n                        (es.startAt === startAt || areIntervalsOverlapping(\r\n                            { start: newStart, end: newEnd },\r\n                            { start: new Date(es.startAt), end: new Date(es.endAt) }\r\n                        ))\r\n                    );\r\n\r\n                    if (conflict) return null;\r\n\r\n                    return shiftService.createShift({\r\n                        franchiseId,\r\n                        riderId: s.riderId,\r\n                        riderName: s.riderName,\r\n                        motoId: s.motoId,\r\n                        motoPlate: s.motoPlate,\r\n                        startAt,\r\n                        endAt\r\n                    });\r\n                })\r\n                .filter(p => p !== null);\r\n\r\n            if (replicatedPromises.length === 0) {\r\n                alert(\"La semana pasada ya est√° replicada o todos los turnos tienen conflictos.\");\r\n                return;\r\n            }\r\n\r\n            await Promise.all(replicatedPromises);\r\n            alert(`‚úÖ Se han importado ${replicatedPromises.length} turnos.`);\r\n            onRefresh();\r\n            onClose();\r\n        } catch (error: any) {\r\n            console.error(\"Clonaci√≥n fallida:\", error);\r\n            alert(\"Error Cr√≠tico al importar: \" + error.message);\r\n        } finally {\r\n            setIsProcessing(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/30 backdrop-blur-sm transition-all animate-in fade-in duration-200\">\r\n            <div className=\"bg-white/95 backdrop-blur-xl border border-white/20 rounded-3xl w-full max-w-lg shadow-2xl flex flex-col max-h-[90vh] overflow-hidden ring-1 ring-black/5\">\r\n\r\n                {/* Header with Glass Effect */}\r\n                <div className=\"p-6 border-b border-slate-100/50 flex justify-between items-center bg-gradient-to-r from-indigo-50/50 to-blue-50/50\">\r\n                    <div>\r\n                        <h3 className=\"text-xl font-black text-slate-800 flex items-center gap-2 tracking-tight\">\r\n                            <div className=\"p-2 bg-indigo-500 text-white rounded-xl shadow-lg shadow-indigo-500/30\">\r\n                                <Zap className=\"w-5 h-5\" />\r\n                            </div>\r\n                            Relleno R√°pido\r\n                        </h3>\r\n                        <p className=\"text-xs text-slate-500 font-medium ml-1 mt-1\">Generaci√≥n inteligente de turnos</p>\r\n                    </div>\r\n                    <button onClick={onClose} title=\"Cerrar modal\" className=\"text-slate-400 hover:text-slate-700 hover:bg-white/50 p-2 rounded-full transition-all\"><X size={20} /></button>\r\n                </div>\r\n\r\n                {/* Body */}\r\n                <div className=\"p-6 overflow-y-auto space-y-8 flex-1 custom-scrollbar\">\r\n\r\n                    {/* 0. PRESETS */}\r\n                    <div className=\"space-y-3\">\r\n                        <label className=\"text-[10px] font-bold text-slate-400 uppercase tracking-widest pl-1\">Tipo de Turno</label>\r\n                        <div className=\"grid grid-cols-3 gap-3\">\r\n                            <button\r\n                                onClick={() => applyPreset('comida')}\r\n                                className={`relative p-3 rounded-2xl border transition-all duration-300 flex flex-col items-center gap-2 group ${activePreset === 'comida'\r\n                                    ? 'bg-amber-100/50 border-amber-200 ring-2 ring-amber-400 ring-offset-2'\r\n                                    : 'bg-slate-50 border-slate-100 hover:bg-amber-50 hover:border-amber-200'\r\n                                    }`}\r\n                            >\r\n                                <Sun className={`w-6 h-6 ${activePreset === 'comida' ? 'text-amber-600' : 'text-slate-400 group-hover:text-amber-500'}`} />\r\n                                <div className=\"text-xs font-bold text-slate-700\">Comida</div>\r\n                                <div className=\"text-[9px] font-mono text-slate-400 bg-white/50 px-2 py-0.5 rounded-full\">13:30 - 16:00</div>\r\n                            </button>\r\n\r\n                            <button\r\n                                onClick={() => applyPreset('cena')}\r\n                                className={`relative p-3 rounded-2xl border transition-all duration-300 flex flex-col items-center gap-2 group ${activePreset === 'cena'\r\n                                    ? 'bg-indigo-100/50 border-indigo-200 ring-2 ring-indigo-400 ring-offset-2'\r\n                                    : 'bg-slate-50 border-slate-100 hover:bg-indigo-50 hover:border-indigo-200'\r\n                                    }`}\r\n                            >\r\n                                <Moon className={`w-6 h-6 ${activePreset === 'cena' ? 'text-indigo-600' : 'text-slate-400 group-hover:text-indigo-500'}`} />\r\n                                <div className=\"text-xs font-bold text-slate-700\">Cena</div>\r\n                                <div className=\"text-[9px] font-mono text-slate-400 bg-white/50 px-2 py-0.5 rounded-full\">20:30 - 23:00</div>\r\n                            </button>\r\n\r\n                            <button\r\n                                onClick={() => applyPreset('partido')}\r\n                                className={`relative p-3 rounded-2xl border transition-all duration-300 flex flex-col items-center gap-2 group ${activePreset === 'partido'\r\n                                    ? 'bg-emerald-100/50 border-emerald-200 ring-2 ring-emerald-400 ring-offset-2'\r\n                                    : 'bg-slate-50 border-slate-100 hover:bg-emerald-50 hover:border-emerald-200'\r\n                                    }`}\r\n                            >\r\n                                <Split className={`w-6 h-6 ${activePreset === 'partido' ? 'text-emerald-600' : 'text-slate-400 group-hover:text-emerald-500'}`} />\r\n                                <div className=\"text-xs font-bold text-slate-700\">Partido</div>\r\n                                <div className=\"text-[9px] font-bold text-emerald-600 bg-emerald-100/50 px-2 py-0.5 rounded-full\">DOBLE (Ext)</div>\r\n                            </button>\r\n\r\n                            <button\r\n                                onClick={handleClonePreviousWeek}\r\n                                disabled={isProcessing}\r\n                                className={`relative p-3 rounded-2xl border transition-all duration-300 flex flex-col items-center gap-2 group bg-indigo-50 border-indigo-100 hover:bg-indigo-100 hover:border-indigo-300 active:scale-95 disabled:opacity-50`}\r\n                                title=\"Importar turnos de la semana anterior\"\r\n                            >\r\n                                <Copy className={`w-6 h-6 text-indigo-500`} />\r\n                                <div className=\"text-[10px] font-black text-indigo-700 uppercase tracking-tighter text-center\">Importar W-1</div>\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"h-px bg-slate-100 w-full\" />\r\n\r\n                    {/* 1. Selecci√≥n de Recursos */}\r\n                    <div className=\"grid grid-cols-2 gap-5\">\r\n                        <div className=\"space-y-2\">\r\n                            <label className=\"text-[10px] font-bold text-slate-400 uppercase tracking-widest pl-1\">Rider</label>\r\n                            <div className=\"relative group\">\r\n                                <select\r\n                                    className=\"w-full bg-slate-50 hover:bg-white border border-slate-200 text-slate-900 text-sm rounded-xl p-3 appearance-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none shadow-sm transition-all font-medium\"\r\n                                    value={selectedRiderId}\r\n                                    onChange={(e) => setSelectedRiderId(e.target.value)}\r\n                                    title=\"Seleccionar Rider\"\r\n                                >\r\n                                    <option value=\"\">Seleccionar Rider...</option>\r\n                                    {riders.map(r => (\r\n                                        <option key={r.id} value={r.id}>{r.name || r.email || r.id}</option>\r\n                                    ))}\r\n                                </select>\r\n                                <User className=\"absolute right-3 top-3 text-slate-400 group-hover:text-indigo-500 transition-colors w-4 h-4 pointer-events-none\" />\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"space-y-2\">\r\n                            <label className=\"text-[10px] font-bold text-slate-400 uppercase tracking-widest pl-1\">Moto (Opcional)</label>\r\n                            <div className=\"relative group\">\r\n                                <select\r\n                                    className=\"w-full bg-slate-50 hover:bg-white border border-slate-200 text-slate-900 text-sm rounded-xl p-3 appearance-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none shadow-sm transition-all font-medium\"\r\n                                    value={selectedMotoId}\r\n                                    onChange={(e) => setSelectedMotoId(e.target.value)}\r\n                                    title=\"Seleccionar Moto\"\r\n                                >\r\n                                    <option value=\"\">Sin veh√≠culo</option>\r\n                                    {motos.map(m => (\r\n                                        <option key={m.id} value={m.id}>{m.licensePlate} - {m.model}</option>\r\n                                    ))}\r\n                                </select>\r\n                                <Truck className=\"absolute right-3 top-3 text-slate-400 group-hover:text-indigo-500 transition-colors w-4 h-4 pointer-events-none\" />\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* 2. D√≠as */}\r\n                    <div className=\"space-y-3\">\r\n                        <div className=\"flex items-center justify-between pl-1\">\r\n                            <label className=\"text-[10px] font-bold text-slate-400 uppercase tracking-widest\">D√≠as a aplicar</label>\r\n                            <button\r\n                                onClick={() => {\r\n                                    if (selectedDays.length === weekDays.length) setSelectedDays([]);\r\n                                    else setSelectedDays(weekDays.map(d => d.isoDate));\r\n                                }}\r\n                                className=\"text-[10px] font-bold text-indigo-500 hover:text-indigo-600 transition-colors uppercase tracking-widest\"\r\n                            >\r\n                                {selectedDays.length === weekDays.length ? 'Desmarcar' : 'Toda la semana'}\r\n                            </button>\r\n                        </div>\r\n                        <div className=\"flex flex-wrap gap-2\">\r\n                            {weekDays.map(day => {\r\n                                const isSelected = selectedDays.includes(day.isoDate);\r\n                                return (\r\n                                    <button\r\n                                        key={day.isoDate}\r\n                                        onClick={() => toggleDay(day.isoDate)}\r\n                                        title={`Alternar ${day.shortLabel}`}\r\n                                        className={`px-4 py-2 rounded-xl text-xs font-bold transition-all border shadow-sm active:scale-95 ${isSelected\r\n                                            ? 'bg-slate-800 border-slate-800 text-white shadow-lg shadow-slate-900/20'\r\n                                            : 'bg-white border-slate-200 text-slate-600 hover:border-indigo-300 hover:text-indigo-600 hover:bg-slate-50'\r\n                                            }`}\r\n                                    >\r\n                                        {day.shortLabel}\r\n                                    </button>\r\n                                );\r\n                            })}\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* 3. Horario Custom */}\r\n                    {activePreset !== 'partido' && (\r\n                        <div className=\"space-y-3 animate-in slide-in-from-top-2 duration-300\">\r\n                            <label className=\"text-[10px] font-bold text-slate-400 uppercase tracking-widest pl-1\">Horario Personalizado</label>\r\n                            <div className=\"flex items-center gap-4 bg-slate-50/50 p-4 rounded-2xl border border-slate-100\">\r\n                                <div className=\"flex-1\">\r\n                                    <span className=\"text-[10px] text-slate-400 mb-1.5 block font-bold uppercase\">Inicio</span>\r\n                                    <input\r\n                                        type=\"time\"\r\n                                        value={startHour}\r\n                                        onChange={(e) => { setStartHour(e.target.value); setActivePreset('custom'); }}\r\n                                        className=\"w-full bg-white border border-slate-200 rounded-xl p-2.5 text-center font-mono text-lg font-bold text-slate-800 focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none shadow-sm transition-all\"\r\n                                        title=\"Hora de Inicio\"\r\n                                    />\r\n                                </div>\r\n                                <span className=\"text-slate-300 font-black text-xl mt-6\">:</span>\r\n                                <div className=\"flex-1\">\r\n                                    <span className=\"text-[10px] text-slate-400 mb-1.5 block font-bold uppercase\">Fin</span>\r\n                                    <input\r\n                                        type=\"time\"\r\n                                        value={endHour}\r\n                                        onChange={(e) => { setEndHour(e.target.value); setActivePreset('custom'); }}\r\n                                        className=\"w-full bg-white border border-slate-200 rounded-xl p-2.5 text-center font-mono text-lg font-bold text-slate-800 focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none shadow-sm transition-all\"\r\n                                        title=\"Hora de Fin\"\r\n                                    />\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n\r\n                {/* Footer */}\r\n                <div className=\"p-6 border-t border-slate-100 bg-slate-50/80 flex justify-between items-center rounded-b-3xl backdrop-blur-md\">\r\n                    <span className=\"text-xs font-semibold text-slate-400\">\r\n                        {activePreset === 'partido' ? (\r\n                            <>Crear√° <span className=\"text-indigo-600 font-bold\">{selectedDays.length * 2}</span> turnos (Doble)</>\r\n                        ) : (\r\n                            <>Crear√° <span className=\"text-indigo-600 font-bold\">{selectedDays.length}</span> turnos</>\r\n                        )}\r\n                        <span className=\"ml-2 text-[10px] opacity-60 italic\">(Riders Externos)</span>\r\n                    </span>\r\n                    <button\r\n                        onClick={handleGenerate}\r\n                        disabled={selectedDays.length === 0 || !selectedRiderId || isProcessing}\r\n                        className=\"px-8 py-3 bg-slate-900 hover:bg-slate-800 text-white font-bold rounded-xl shadow-xl shadow-slate-900/10 transition-all flex items-center gap-2 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed hover:-translate-y-0.5 min-w-[180px] justify-center\"\r\n                        title=\"Generar turnos seleccionados\"\r\n                    >\r\n                        {isProcessing ? (\r\n                            <Loader2 size={18} className=\"animate-spin\" />\r\n                        ) : (\r\n                            <Zap size={18} className={activePreset === 'partido' ? 'fill-yellow-400 text-yellow-400' : 'fill-white'} />\r\n                        )}\r\n                        {isProcessing ? 'Procesando...' : 'Generar Turnos'}\r\n                    </button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default QuickFillModal;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\operations\\RiderManagement.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\operations\\RiderStatsPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\operations\\ShiftCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\operations\\ShiftModal.tsx","messages":[{"ruleId":"react-hooks/incompatible-library","severity":1,"message":"Compilation Skipped: Use of incompatible library\n\nThis API returns functions which cannot be memoized without leading to stale UI. To prevent this, by default React Compiler will skip memoizing this component/hook. However, you may see issues if values from this API are passed to other components/hooks that are memoized.\n\nC:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\operations\\ShiftModal.tsx:103:23\n  101 |     });\n  102 |\n> 103 |     const startDate = watch('startDate');\n      |                       ^^^^^ React Hook Form's `useForm()` API returns a `watch()` function which cannot be memoized safely.\n  104 |\n  105 |     // Sync EndDate when StartDate changes (User Convenience)\n  106 |     useEffect(() => {","line":103,"column":23,"nodeType":null,"endLine":103,"endColumn":28},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":243,"column":33,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[9764,9799],"text":"\r\n                                &quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[9764,9799],"text":"\r\n                                &ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[9764,9799],"text":"\r\n                                &#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[9764,9799],"text":"\r\n                                &rdquo;"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":243,"column":89,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[9854,9885],"text":"&quot;\r\n                            "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[9854,9885],"text":"&ldquo;\r\n                            "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[9854,9885],"text":"&#34;\r\n                            "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[9854,9885],"text":"&rdquo;\r\n                            "},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState } from 'react';\r\nimport { useForm } from 'react-hook-form';\r\nimport { X, User, Truck, Clock, Plus, Trash2, Calendar, AlertCircle, Save, ArrowRight } from 'lucide-react';\r\nimport { toLocalDateString, toLocalISOStringWithOffset } from '../../utils/dateUtils';\r\n\r\ninterface Rider {\r\n    id: string;\r\n    fullName: string;\r\n}\r\n\r\ninterface Moto {\r\n    id: string;\r\n    licensePlate: string;\r\n    model: string;\r\n}\r\n\r\ninterface MotoAssignment {\r\n    motoId: string;\r\n    plate: string;\r\n    startAt: string;\r\n    endAt: string;\r\n}\r\n\r\ninterface ShiftData {\r\n    shiftId?: string;\r\n    riderId: string;\r\n    riderName: string;\r\n    startAt: string;\r\n    endAt: string;\r\n    date: string;\r\n    startTime: string;\r\n    endTime: string;\r\n    day: string;\r\n    motoId: string | null;\r\n    motoPlate: string | null;\r\n    motoAssignments: MotoAssignment[];\r\n}\r\n\r\ninterface ShiftModalProps {\r\n    isOpen: boolean;\r\n    onClose: () => void;\r\n    onSave: (data: ShiftData) => void;\r\n    onDelete?: (shiftId: string) => void;\r\n    initialData?: {\r\n        shiftId: string;\r\n        riderId?: string | null;\r\n        startAt: string;\r\n        endAt: string;\r\n        motoAssignments?: { motoId: string }[];\r\n        changeRequested?: boolean;\r\n        changeReason?: string | null;\r\n    } | null;\r\n    selectedDate?: string;\r\n    prefillHour?: number;\r\n    isSaving?: boolean;\r\n    riders?: Rider[];\r\n    motos?: Moto[];\r\n}\r\n\r\ninterface FormValues {\r\n    riderId: string;\r\n    startDate: string;\r\n    startTime: string;\r\n    endDate: string;\r\n    endTime: string;\r\n    motoId: string;\r\n}\r\n\r\nconst ShiftModal: React.FC<ShiftModalProps> = ({\r\n    isOpen,\r\n    onClose,\r\n    onSave,\r\n    onDelete,\r\n    initialData,\r\n    selectedDate,\r\n    prefillHour,\r\n    isSaving = false,\r\n    riders = [],\r\n    motos = []\r\n}) => {\r\n    const [error, setError] = useState<string | null>(null);\r\n\r\n    // Calculate default times\r\n    const defaultStartTime = prefillHour !== undefined && prefillHour !== null\r\n        ? `${String(prefillHour).padStart(2, '0')}:00`\r\n        : '10:00';\r\n\r\n    const defaultEndTime = prefillHour !== undefined && prefillHour !== null\r\n        ? `${String(prefillHour + 4).padStart(2, '0')}:00`\r\n        : '14:00';\r\n\r\n    const { register, handleSubmit, reset, watch, setValue } = useForm<FormValues>({\r\n        defaultValues: {\r\n            riderId: '',\r\n            startDate: selectedDate || toLocalDateString(new Date()),\r\n            startTime: defaultStartTime,\r\n            endDate: selectedDate || toLocalDateString(new Date()),\r\n            endTime: defaultEndTime,\r\n            motoId: ''\r\n        }\r\n    });\r\n\r\n    const startDate = watch('startDate');\r\n\r\n    // Sync EndDate when StartDate changes (User Convenience)\r\n    useEffect(() => {\r\n        if (startDate) {\r\n            setValue('endDate', startDate);\r\n        }\r\n    }, [startDate, setValue]);\r\n\r\n    // Reset form when opening\r\n    useEffect(() => {\r\n        if (isOpen) {\r\n            setError(null);\r\n            if (initialData) {\r\n                // EDIT MODE\r\n                const startParts = initialData.startAt.split('T');\r\n                const endParts = initialData.endAt.split('T');\r\n                reset({\r\n                    riderId: initialData.riderId || '',\r\n                    startDate: startParts[0],\r\n                    startTime: startParts[1].substring(0, 5),\r\n                    endDate: endParts[0],\r\n                    endTime: endParts[1].substring(0, 5),\r\n                    motoId: initialData.motoAssignments?.[0]?.motoId || ''\r\n                });\r\n            } else {\r\n                // CREATE MODE\r\n                reset({\r\n                    riderId: '',\r\n                    startDate: selectedDate || toLocalDateString(new Date()),\r\n                    startTime: defaultStartTime,\r\n                    endDate: selectedDate || toLocalDateString(new Date()),\r\n                    endTime: defaultEndTime,\r\n                    motoId: ''\r\n                });\r\n            }\r\n        }\r\n    }, [isOpen, initialData, selectedDate, prefillHour, reset, defaultStartTime, defaultEndTime]);\r\n\r\n    const onSubmit = (data: FormValues) => {\r\n        setError(null);\r\n        if (!data.startTime || !data.endTime) {\r\n            setError(\"Por favor completa los horarios.\");\r\n            return;\r\n        }\r\n\r\n        const startTs = new Date(`${data.startDate}T${data.startTime}`).getTime();\r\n        const endTs = new Date(`${data.endDate}T${data.endTime}`).getTime();\r\n\r\n        if (startTs >= endTs) {\r\n            setError(\"La hora de fin debe ser posterior al inicio.\");\r\n            return;\r\n        }\r\n\r\n        const [startYear, startMonth, startDay] = data.startDate.split('-').map(Number);\r\n        const [startHour, startMinute] = data.startTime.split(':').map(Number);\r\n        const [endYear, endMonth, endDay] = data.endDate.split('-').map(Number);\r\n        const [endHour, endMinute] = data.endTime.split(':').map(Number);\r\n\r\n        const startDateObj = new Date(startYear, startMonth - 1, startDay, startHour, startMinute, 0);\r\n        const endDateObj = new Date(endYear, endMonth - 1, endDay, endHour, endMinute, 0);\r\n\r\n        const startAt = toLocalISOStringWithOffset(startDateObj);\r\n        const endAt = toLocalISOStringWithOffset(endDateObj);\r\n\r\n        const selectedRider = riders.find(r => r.id === data.riderId);\r\n        const selectedMoto = motos.find(m => m.id === data.motoId);\r\n\r\n        const DAYS = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];\r\n        const dayIndex = new Date(startAt).getDay();\r\n        const adjustedDayIndex = dayIndex === 0 ? 6 : dayIndex - 1;\r\n\r\n        const payload: ShiftData = {\r\n            shiftId: initialData?.shiftId || crypto.randomUUID(),\r\n            riderId: data.riderId,\r\n            riderName: selectedRider ? selectedRider.fullName : 'Unknown',\r\n            startAt,\r\n            endAt,\r\n            date: data.startDate,\r\n            startTime: data.startTime,\r\n            endTime: data.endTime,\r\n            day: DAYS[adjustedDayIndex] || '',\r\n            motoId: selectedMoto ? selectedMoto.id : null,\r\n            motoPlate: selectedMoto ? selectedMoto.licensePlate : null,\r\n            motoAssignments: selectedMoto ? [{\r\n                motoId: selectedMoto.id,\r\n                plate: selectedMoto.licensePlate,\r\n                startAt,\r\n                endAt\r\n            }] : []\r\n        };\r\n\r\n        onSave(payload);\r\n    };\r\n\r\n    if (!isOpen) return null;\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 bg-slate-900/60 backdrop-blur-md z-[100] flex items-center justify-center p-4 animate-in fade-in duration-200\">\r\n            <div className=\"bg-white dark:bg-slate-900 w-full max-w-lg rounded-2xl shadow-2xl border border-slate-200 dark:border-slate-800 flex flex-col overflow-hidden max-h-[90vh]\">\r\n\r\n                {/* HEADER */}\r\n                <div className=\"flex justify-between items-center p-5 border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-800/50\">\r\n                    <div className=\"flex items-center gap-3\">\r\n                        <div className={`p-2.5 rounded-xl ${initialData ? 'bg-indigo-100 text-indigo-600 dark:bg-indigo-900/30 dark:text-indigo-400' : 'bg-emerald-100 text-emerald-600 dark:bg-emerald-900/30 dark:text-emerald-400'}`}>\r\n                            {initialData ? <Clock className=\"w-5 h-5\" /> : <Plus className=\"w-5 h-5\" />}\r\n                        </div>\r\n                        <div>\r\n                            <h2 className=\"text-lg font-bold text-slate-800 dark:text-white\">\r\n                                {initialData ? 'Editar Turno' : 'Nuevo Turno'}\r\n                            </h2>\r\n                            <p className=\"text-xs text-slate-500 dark:text-slate-400\">\r\n                                {initialData ? 'Modifica los detalles del turno existente' : 'Agenda un nuevo turno para la flota'}\r\n                            </p>\r\n                        </div>\r\n                    </div>\r\n                    <button onClick={onClose} disabled={isSaving} className=\"p-2 rounded-lg text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 transition-all\" title=\"Cerrar modal\" aria-label=\"Cerrar\">\r\n                        <X size={20} />\r\n                    </button>\r\n                </div>\r\n\r\n                {/* BODY */}\r\n                <div className=\"flex-1 overflow-y-auto p-6 space-y-6\">\r\n\r\n                    {/* ERROR ALERT */}\r\n                    {error && (\r\n                        <div className=\"flex items-start gap-3 p-4 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 rounded-xl text-sm border border-red-100 dark:border-red-900/30\">\r\n                            <AlertCircle className=\"w-5 h-5 shrink-0\" />\r\n                            <p>{error}</p>\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* CHANGE REQUEST HIGHLIGHT */}\r\n                    {initialData?.changeRequested && (\r\n                        <div className=\"flex flex-col gap-2 p-4 bg-amber-50 dark:bg-amber-900/20 text-amber-800 dark:text-amber-400 rounded-xl text-sm border-2 border-amber-200 dark:border-amber-900/50 shadow-sm animate-in zoom-in-95 duration-300\">\r\n                            <div className=\"flex items-center gap-2 font-bold uppercase tracking-wider text-[10px]\">\r\n                                <AlertCircle className=\"w-4 h-4\" />\r\n                                Solicitud de Cambio del Rider\r\n                            </div>\r\n                            <p className=\"font-medium italic bg-white/50 dark:bg-slate-800/50 p-2 rounded-lg border border-amber-100 dark:border-amber-900/30\">\r\n                                \"{initialData.changeReason || 'Sin motivo especificado'}\"\r\n                            </p>\r\n                            <p className=\"text-[9px] opacity-70\">\r\n                                * Guardar cambios en este turno marcar√° el conflicto como resuelto.\r\n                            </p>\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* DATES GRID */}\r\n                    <div className=\"grid grid-cols-2 gap-4\">\r\n                        <div className=\"space-y-3\">\r\n                            <label className=\"text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-1\">\r\n                                <Calendar className=\"w-3 h-3\" /> Inicio\r\n                            </label>\r\n                            <div className=\"space-y-2\">\r\n                                <input\r\n                                    {...register('startDate')}\r\n                                    type=\"date\"\r\n                                    className=\"w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all\"\r\n                                />\r\n                                <input\r\n                                    {...register('startTime')}\r\n                                    type=\"time\"\r\n                                    className=\"w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all\"\r\n                                />\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"space-y-3\">\r\n                            <label className=\"text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-1\">\r\n                                <ArrowRight className=\"w-3 h-3\" /> Fin\r\n                            </label>\r\n                            <div className=\"space-y-2\">\r\n                                <input\r\n                                    {...register('endDate')}\r\n                                    type=\"date\"\r\n                                    className=\"w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all\"\r\n                                />\r\n                                <input\r\n                                    {...register('endTime')}\r\n                                    type=\"time\"\r\n                                    className=\"w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all\"\r\n                                />\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"h-px bg-slate-100 dark:bg-slate-800\" />\r\n\r\n                    {/* RIDER SELECT */}\r\n                    <div className=\"space-y-2\">\r\n                        <label className=\"text-sm font-medium text-slate-700 dark:text-slate-300 flex items-center gap-2\">\r\n                            <User size={16} className=\"text-blue-500\" /> Rider Asignado\r\n                        </label>\r\n                        <select\r\n                            {...register('riderId', { required: true })}\r\n                            className=\"w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all\"\r\n                        >\r\n                            <option value=\"\">Seleccionar Rider...</option>\r\n                            {riders.map(r => (\r\n                                <option key={r.id} value={r.id}>{r.fullName}</option>\r\n                            ))}\r\n                        </select>\r\n                    </div>\r\n\r\n                    {/* MOTO SELECT */}\r\n                    <div className=\"space-y-2\">\r\n                        <label className=\"text-sm font-medium text-slate-700 dark:text-slate-300 flex items-center gap-2\">\r\n                            <Truck size={16} className=\"text-orange-500\" /> Veh√≠culo (Opcional)\r\n                        </label>\r\n                        <div className=\"relative\">\r\n                            <select\r\n                                {...register('motoId')}\r\n                                className=\"w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 transition-all appearance-none\"\r\n                            >\r\n                                <option value=\"\">Sin veh√≠culo asignado</option>\r\n                                {motos.map(m => (\r\n                                    <option key={m.id} value={m.id}>{m.licensePlate} - {m.model}</option>\r\n                                ))}\r\n                            </select>\r\n                            <div className=\"absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400\">\r\n                                <Truck size={14} />\r\n                            </div>\r\n                        </div>\r\n                        <p className=\"text-[10px] text-slate-400 dark:text-slate-500 px-1\">\r\n                            El veh√≠culo quedar√° bloqueado para otros turnos durante este horario.\r\n                        </p>\r\n                    </div>\r\n\r\n                </div>\r\n\r\n                {/* FOOTER */}\r\n                <div className=\"p-5 border-t border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-800/50 flex justify-between items-center\">\r\n                    <div>\r\n                        {initialData && onDelete && (\r\n                            <button\r\n                                type=\"button\"\r\n                                onClick={() => {\r\n                                    if (confirm('¬øEliminar este turno permanentemente?')) onDelete(initialData.shiftId);\r\n                                }}\r\n                                disabled={isSaving}\r\n                                className=\"flex items-center gap-2 px-3 py-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg text-sm font-medium transition-colors\"\r\n                            >\r\n                                <Trash2 size={16} />\r\n                                <span className=\"hidden sm:inline\">Eliminar</span>\r\n                            </button>\r\n                        )}\r\n                    </div>\r\n                    <div className=\"flex gap-3\">\r\n                        <button\r\n                            type=\"button\"\r\n                            onClick={onClose}\r\n                            disabled={isSaving}\r\n                            className=\"px-4 py-2 text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 font-medium text-sm transition-colors\"\r\n                        >\r\n                            Cancelar\r\n                        </button>\r\n                        <button\r\n                            onClick={handleSubmit(onSubmit)}\r\n                            disabled={isSaving}\r\n                            className=\"flex items-center gap-2 px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-xl shadow-lg shadow-indigo-500/20 hover:shadow-indigo-500/30 transition-all disabled:opacity-70 disabled:cursor-not-allowed transform active:scale-95\"\r\n                        >\r\n                            {isSaving ? <Clock className=\"animate-spin w-4 h-4\" /> : <Save className=\"w-4 h-4\" />}\r\n                            {isSaving ? 'Guardando...' : 'Guardar Turno'}\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default ShiftModal;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\operations\\ShiftPlanner.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":32,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":32,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1052,1055],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1052,1055],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":70,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":70,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1799,1802],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1799,1802],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react/display-name","severity":2,"message":"Component definition is missing display name","line":113,"column":19,"nodeType":"CallExpression","messageId":"noDisplayName","endLine":136,"endColumn":3},{"ruleId":"react/display-name","severity":2,"message":"Component definition is missing display name","line":138,"column":18,"nodeType":"CallExpression","messageId":"noDisplayName","endLine":180,"endColumn":3},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useState\" is called conditionally. React Hooks must be called in the exact same order in every component render.","line":207,"column":37,"nodeType":"Identifier","endLine":207,"endColumn":45},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useState\" is called conditionally. React Hooks must be called in the exact same order in every component render.","line":208,"column":26,"nodeType":"Identifier","endLine":208,"endColumn":34},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useState\" is called conditionally. React Hooks must be called in the exact same order in every component render.","line":209,"column":51,"nodeType":"Identifier","endLine":209,"endColumn":59},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useState\" is called conditionally. React Hooks must be called in the exact same order in every component render. Did you accidentally call a React Hook after an early return?","line":210,"column":45,"nodeType":"Identifier","endLine":210,"endColumn":53},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useState\" is called conditionally. React Hooks must be called in the exact same order in every component render. Did you accidentally call a React Hook after an early return?","line":211,"column":33,"nodeType":"Identifier","endLine":211,"endColumn":41},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useState\" is called conditionally. React Hooks must be called in the exact same order in every component render. Did you accidentally call a React Hook after an early return?","line":212,"column":45,"nodeType":"Identifier","endLine":212,"endColumn":53},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useState\" is called conditionally. React Hooks must be called in the exact same order in every component render. Did you accidentally call a React Hook after an early return?","line":213,"column":45,"nodeType":"Identifier","endLine":213,"endColumn":53},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useEffect\" is called conditionally. React Hooks must be called in the exact same order in every component render. Did you accidentally call a React Hook after an early return?","line":215,"column":5,"nodeType":"Identifier","endLine":215,"endColumn":14},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useMemo\" is called conditionally. React Hooks must be called in the exact same order in every component render. Did you accidentally call a React Hook after an early return?","line":221,"column":31,"nodeType":"Identifier","endLine":221,"endColumn":38},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":243,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":243,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10493,10496],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10493,10496],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":264,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":264,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11247,11250],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11247,11250],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useMemo\" is called conditionally. React Hooks must be called in the exact same order in every component render. Did you accidentally call a React Hook after an early return?","line":270,"column":22,"nodeType":"Identifier","endLine":270,"endColumn":29},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useMemo\" is called conditionally. React Hooks must be called in the exact same order in every component render. Did you accidentally call a React Hook after an early return?","line":284,"column":23,"nodeType":"Identifier","endLine":284,"endColumn":30}],"suppressedMessages":[],"errorCount":13,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useMemo, memo, Fragment, type FC } from 'react';\r\nimport {\r\n    Calendar, Clock, Filter, Sun, Moon,\r\n    MoreHorizontal, Plus, RefreshCw, Zap, Loader2,\r\n    CheckCircle2, AlertCircle, LucideIcon\r\n} from 'lucide-react';\r\nimport { useAuth } from '../../context/AuthContext';\r\nimport { useWeeklySchedule } from '../../hooks/useWeeklySchedule';\r\nimport { useShiftOperations } from '../../hooks/useShiftOperations';\r\nimport { toLocalDateString } from '../../utils/dateUtils';\r\nimport QuickFillModal from './QuickFillModal';\r\nimport ShiftModal from './ShiftModal';\r\n\r\n// =====================================================\r\n// TYPES & INTERFACES\r\n// =====================================================\r\n\r\ninterface ToastProps {\r\n    message: string | null;\r\n    type: 'success' | 'error';\r\n    onClose: () => void;\r\n}\r\n\r\ninterface Shift {\r\n    shiftId: string;\r\n    startAt: string;\r\n    endAt: string;\r\n    riderName?: string;\r\n    riderId: string;\r\n    motoPlate?: string;\r\n    motoId?: string | null;\r\n    [key: string]: any;\r\n}\r\n\r\ninterface ShiftCardProps {\r\n    shift: Shift;\r\n    onClick: (shift: Shift) => void;\r\n}\r\n\r\ninterface ShiftConfig {\r\n    start: number;\r\n    end: number;\r\n    label: string;\r\n    icon: LucideIcon;\r\n    color: string;\r\n    bg: string;\r\n}\r\n\r\ninterface TimeSlotProps {\r\n    hour: number;\r\n    isCurrentHour: boolean;\r\n    assignments: Shift[];\r\n    canEdit: boolean;\r\n    onAssign: (hour: number) => void;\r\n    onEdit: (shift: Shift) => void;\r\n}\r\n\r\ninterface WeekDay {\r\n    dateObj: Date;\r\n    label: string;\r\n    shortLabel: string;\r\n    isoDate: string;\r\n}\r\n\r\ninterface ShiftPlannerProps {\r\n    franchiseId?: string;\r\n    readOnly?: boolean;\r\n    selectedDate?: Date;\r\n    onDateChange?: (date: Date) => void;\r\n    overrideScheduleState?: any; // Type from useWeeklySchedule if needed\r\n}\r\n\r\ninterface NotificationState {\r\n    message: string;\r\n    type: 'success' | 'error';\r\n}\r\n\r\ninterface ModalsState {\r\n    shift: boolean;\r\n    quick: boolean;\r\n}\r\n\r\n// =====================================================\r\n// UI COMPONENTS\r\n// =====================================================\r\n\r\nconst Toast: FC<ToastProps> = ({ message, type, onClose }) => {\r\n    useEffect(() => {\r\n        const timer = setTimeout(onClose, 3000);\r\n        return () => clearTimeout(timer);\r\n    }, [onClose]);\r\n\r\n    if (!message) return null;\r\n\r\n    const styles = type === 'success'\r\n        ? 'bg-emerald-50 border-emerald-200 text-emerald-700'\r\n        : 'bg-red-50 border-red-200 text-red-700';\r\n    const Icon = type === 'success' ? CheckCircle2 : AlertCircle;\r\n\r\n    return (\r\n        <div className={`fixed bottom-6 right-6 flex items-center gap-3 px-4 py-3 rounded-xl border backdrop-blur-md shadow-2xl animate-in slide-in-from-bottom-5 z-[200] ${styles}`}>\r\n            <Icon size={18} />\r\n            <span className=\"text-sm font-medium\">{message}</span>\r\n        </div>\r\n    );\r\n};\r\n\r\nconst SHIFT_CONFIG: Record<'LUNCH' | 'DINNER', ShiftConfig> = {\r\n    LUNCH: { start: 12, end: 16, label: 'COMIDA', icon: Sun, color: 'text-amber-600', bg: 'bg-amber-50 border-amber-200' },\r\n    DINNER: { start: 20, end: 23, label: 'CENA', icon: Moon, color: 'text-indigo-600', bg: 'bg-indigo-50 border-indigo-200' }\r\n};\r\n\r\nconst ShiftCard = memo<ShiftCardProps>(({ shift, onClick }) => (\r\n    <div\r\n        onClick={(e) => { e.stopPropagation(); onClick(shift); }}\r\n        className=\"group/card relative shrink-0 flex items-center gap-3 bg-white border border-slate-200 px-3 py-2.5 rounded-xl cursor-pointer hover:bg-slate-50 hover:border-indigo-300 hover:shadow-lg hover:shadow-indigo-500/10 transition-all duration-200 min-w-[170px]\"\r\n    >\r\n        <div className=\"w-9 h-9 rounded-full bg-gradient-to-br from-indigo-500 to-violet-500 flex items-center justify-center text-xs font-bold text-white shadow-sm\">\r\n            {shift.riderName ? shift.riderName.substring(0, 2).toUpperCase() : 'ST'}\r\n        </div>\r\n        <div className=\"flex flex-col\">\r\n            <span className=\"text-xs font-bold text-slate-700 group-hover/card:text-indigo-700 truncate max-w-[110px]\">\r\n                {shift.riderName || 'Sin asignar'}\r\n            </span>\r\n            <div className=\"flex items-center gap-1.5 mt-0.5\">\r\n                <div className={`w-1.5 h-1.5 rounded-full ${shift.motoPlate ? 'bg-emerald-500' : 'bg-rose-500'}`} />\r\n                <span className=\"text-[10px] font-mono text-slate-500 group-hover/card:text-indigo-500\">\r\n                    {shift.motoPlate || 'Sin veh√≠culo'}\r\n                </span>\r\n            </div>\r\n        </div>\r\n        <div className=\"absolute right-2 top-1/2 -translate-y-1/2 opacity-0 group-hover/card:opacity-100 transition-opacity transform translate-x-2 group-hover/card:translate-x-0\">\r\n            <MoreHorizontal size={14} className=\"text-slate-400\" />\r\n        </div>\r\n    </div>\r\n));\r\n\r\nconst TimeSlot = memo<TimeSlotProps>(({ hour, isCurrentHour, assignments, canEdit, onAssign, onEdit }) => {\r\n    const isNight = hour >= 20 || hour <= 5;\r\n    const config = hour >= 20 ? SHIFT_CONFIG.DINNER : (hour >= 12 && hour <= 16 ? SHIFT_CONFIG.LUNCH : null);\r\n    const Icon = config?.icon || Clock;\r\n\r\n    return (\r\n        <div className={`group flex relative min-h-[100px] border-b border-slate-100 transition-colors duration-300 ${isNight ? 'bg-slate-50/80' : 'bg-white'} ${isCurrentHour ? 'bg-indigo-50/50' : 'hover:bg-slate-50'}`}>\r\n            {isCurrentHour && <div className=\"absolute left-0 top-0 bottom-0 w-[3px] bg-rose-500 z-10 shadow-[0_0_15px_rgba(244,63,94,0.3)]\" />}\r\n            <div className=\"w-24 border-r border-slate-100 flex flex-col items-center justify-center p-2 relative shrink-0\">\r\n                <span className={`text-lg font-mono font-bold ${isCurrentHour ? 'text-rose-500' : 'text-slate-400'}`}>\r\n                    {String(hour).padStart(2, '0')}:00\r\n                </span>\r\n                {config && (\r\n                    <div className={`mt-1 flex items-center gap-1 px-2 py-0.5 rounded text-[9px] font-bold tracking-wider ${config.color} ${config.bg}`}>\r\n                        <Icon size={10} />\r\n                        {config.label}\r\n                    </div>\r\n                )}\r\n            </div>\r\n            <div className=\"flex-1 p-3 flex items-center overflow-hidden\">\r\n                <div className=\"flex gap-3 overflow-x-auto custom-scrollbar w-full py-1 px-1 items-center\">\r\n                    {assignments?.length > 0 ? (\r\n                        assignments.map((shift) => <ShiftCard key={shift.shiftId} shift={shift} onClick={onEdit} />)\r\n                    ) : (\r\n                        <div className=\"flex items-center gap-2 opacity-0 group-hover:opacity-40 transition-opacity select-none\">\r\n                            <div className=\"w-12 h-[2px] bg-slate-200 rounded-full\" />\r\n                            <span className=\"text-[10px] text-slate-400 font-medium uppercase tracking-widest\">Disponible</span>\r\n                        </div>\r\n                    )}\r\n                    {canEdit && (\r\n                        <button\r\n                            onClick={() => onAssign(hour)}\r\n                            className=\"shrink-0 w-9 h-9 ml-2 rounded-lg border border-dashed border-slate-300 flex items-center justify-center text-slate-400 hover:text-indigo-600 hover:border-indigo-500 hover:bg-indigo-50 transition-all opacity-0 group-hover:opacity-100 transform scale-90 group-hover:scale-100\"\r\n                            title=\"A√±adir turno aqu√≠\"\r\n                        >\r\n                            <Plus size={16} />\r\n                        </button>\r\n                    )}\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n});\r\n\r\n// =====================================================\r\n// MAIN COMPONENT\r\n// =====================================================\r\n\r\nconst ShiftPlanner: FC<ShiftPlannerProps> = ({\r\n    franchiseId: propFranchiseId,\r\n    readOnly = false,\r\n    selectedDate,\r\n    onDateChange,\r\n    overrideScheduleState\r\n}) => {\r\n    const { user } = useAuth();\r\n\r\n    const activeFranchiseId = propFranchiseId || user?.uid;\r\n    const canEdit = !readOnly && (user?.role === 'admin' || user?.role === 'manager' || user?.role === 'franchise');\r\n\r\n    const internalHook = useWeeklySchedule(activeFranchiseId ?? null, !activeFranchiseId, selectedDate);\r\n    const { weekData, loading, riders, motos, updateWeekData, refresh } = overrideScheduleState || internalHook;\r\n\r\n    const { isSaving, addOrUpdateShift, removeShift, quickFillShifts } = useShiftOperations(activeFranchiseId || null, weekData, updateWeekData, motos);\r\n\r\n    if (!activeFranchiseId) {\r\n        return <div className=\"p-8 text-center text-red-500\">Error: No se ha identificado la franquicia operativa.</div>;\r\n    }\r\n\r\n    const [viewMode, setViewMode] = useState<'focus' | 'full'>('focus');\r\n    const [searchTerm] = useState('');\r\n    const [selectedDateObj, setSelectedDateObj] = useState(selectedDate || new Date());\r\n    const [notification, setNotification] = useState<NotificationState | null>(null);\r\n    const [modals, setModals] = useState<ModalsState>({ shift: false, quick: false });\r\n    const [editingShift, setEditingShift] = useState<Shift | null>(null);\r\n    const [newShiftHour, setNewShiftHour] = useState<number | null>(null);\r\n\r\n    useEffect(() => { if (selectedDate) setSelectedDateObj(selectedDate); }, [selectedDate]);\r\n\r\n    const notify = (msg: string, type: 'success' | 'error' = 'success') => setNotification({ message: msg, type });\r\n\r\n    const selectedIsoDate = toLocalDateString(selectedDateObj);\r\n\r\n    const assignmentsByHour = useMemo(() => {\r\n        const map: Record<number, Shift[]> = {};\r\n        if (!weekData?.shifts) return map;\r\n\r\n        weekData.shifts.forEach((shift: Shift) => {\r\n            if (!shift.startAt || !shift.startAt.startsWith(selectedIsoDate)) return;\r\n            if (searchTerm && !shift.riderName?.toLowerCase().includes(searchTerm.toLowerCase())) return;\r\n\r\n            const d = new Date(shift.startAt);\r\n            if (isNaN(d.getTime())) return;\r\n\r\n            const startH = d.getHours();\r\n            const endH = new Date(shift.endAt || shift.startAt).getHours();\r\n\r\n            for (let h = startH; h < endH; h++) {\r\n                if (!map[h]) map[h] = [];\r\n                map[h].push(shift);\r\n            }\r\n        });\r\n        return map;\r\n    }, [weekData, selectedIsoDate, searchTerm]);\r\n\r\n    const onSaveWrapper = async (data: any) => {\r\n        const res = await addOrUpdateShift(data, !!editingShift);\r\n        if (res.success) {\r\n            notify(editingShift ? 'Turno actualizado' : 'Turno creado');\r\n            setModals(prev => ({ ...prev, shift: false }));\r\n        } else {\r\n            notify(res.error || 'Error al guardar', 'error');\r\n        }\r\n    };\r\n\r\n    const onDeleteWrapper = async (id: string) => {\r\n        if (!confirm('¬øEliminar turno?')) return;\r\n        const res = await removeShift(id);\r\n        if (res.success) {\r\n            notify('Turno eliminado');\r\n            setModals(prev => ({ ...prev, shift: false }));\r\n        } else {\r\n            notify('Error al eliminar', 'error');\r\n        }\r\n    };\r\n\r\n    const onQuickFillWrapper = async (data: any) => {\r\n        const res = await quickFillShifts(data);\r\n        if (res.success) notify(`${res.count || 0} turnos generados`);\r\n        else notify(res.error || 'Error en Auto-Fill', 'error');\r\n    };\r\n\r\n    const weekDays = useMemo<WeekDay[]>(() => {\r\n        const start = weekData ? new Date(weekData.startDate) : new Date();\r\n        return Array.from({ length: 7 }, (_, i) => {\r\n            const d = new Date(start);\r\n            d.setDate(d.getDate() + i);\r\n            return {\r\n                dateObj: d,\r\n                label: d.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric' }),\r\n                shortLabel: d.toLocaleDateString('es-ES', { weekday: 'short' }),\r\n                isoDate: toLocalDateString(d)\r\n            };\r\n        });\r\n    }, [weekData]);\r\n\r\n    const timeSlots = useMemo(() => {\r\n        const hours = Array.from({ length: 24 }, (_, i) => i);\r\n        return viewMode === 'focus'\r\n            ? hours.filter(h => (h >= 12 && h <= 16) || (h >= 20 && h <= 23))\r\n            : hours;\r\n    }, [viewMode]);\r\n\r\n    const currentHour = new Date().getHours();\r\n    const isToday = selectedIsoDate === toLocalDateString(new Date());\r\n\r\n    return (\r\n        <div className=\"bg-white rounded-2xl border border-slate-200 h-full flex flex-col shadow-sm overflow-hidden relative\">\r\n            {isSaving && <div className=\"absolute top-0 left-0 w-full h-1 bg-slate-100 z-50\"><div className=\"h-full bg-indigo-500 animate-progress-indeterminate\" /></div>}\r\n\r\n            {/* Header */}\r\n            <div className=\"bg-white p-5 border-b border-slate-200 flex flex-col xl:flex-row justify-between items-start xl:items-center gap-4 shrink-0\">\r\n                <div>\r\n                    <h2 className=\"text-xl font-bold text-slate-900 flex items-center gap-2 tracking-tight\">\r\n                        <div className=\"p-2 bg-indigo-50 rounded-lg border border-indigo-100\"><Calendar className=\"w-5 h-5 text-indigo-600\" /></div>\r\n                        Planificador Operativo\r\n                    </h2>\r\n                    <p className=\"text-sm text-slate-500 mt-1 ml-1\">Gesti√≥n inteligente de recursos y turnos.</p>\r\n                </div>\r\n                <div className=\"flex flex-wrap items-center gap-3 w-full xl:w-auto\">\r\n                    <div className=\"flex bg-slate-100 p-1 rounded-xl border border-slate-200 overflow-x-auto no-scrollbar\">\r\n                        {weekDays.map((day) => {\r\n                            const isSelected = day.isoDate === selectedIsoDate;\r\n                            return (\r\n                                <button\r\n                                    key={day.isoDate}\r\n                                    onClick={() => { setSelectedDateObj(day.dateObj); onDateChange?.(day.dateObj); }}\r\n                                    className={`relative px-4 py-2 rounded-lg text-xs font-bold transition-all flex flex-col items-center min-w-[64px] ${isSelected ? 'bg-indigo-600 text-white shadow-md ring-1 ring-indigo-500' : 'text-slate-500 hover:text-indigo-600 hover:bg-slate-200'}`}\r\n                                >\r\n                                    <span className=\"uppercase text-[9px] opacity-70 mb-0.5\">{day.shortLabel}</span>\r\n                                    <span className=\"text-sm\">{day.dateObj.getDate()}</span>\r\n                                    {day.isoDate === toLocalDateString(new Date()) && !isSelected && <div className=\"absolute bottom-1 w-1 h-1 bg-indigo-500 rounded-full\" />}\r\n                                </button>\r\n                            );\r\n                        })}\r\n                    </div>\r\n                    <div className=\"flex items-center gap-2 ml-auto pl-2 border-l border-slate-200\">\r\n                        <button onClick={() => refresh()} disabled={loading} className=\"p-2.5 rounded-lg bg-white border border-slate-200 text-slate-400 hover:text-indigo-600 hover:border-indigo-200 transition-colors shadow-sm\">\r\n                            {loading ? <Loader2 className=\"w-4 h-4 animate-spin\" /> : <RefreshCw className=\"w-4 h-4\" />}\r\n                        </button>\r\n                        {canEdit && (\r\n                            <button\r\n                                onClick={() => setModals(m => ({ ...m, quick: true }))}\r\n                                className=\"flex items-center gap-2 px-4 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-xs font-bold transition-all shadow-md shadow-indigo-500/20 active:scale-95\"\r\n                            >\r\n                                <Zap className=\"w-4 h-4 text-amber-300\" />\r\n                                Auto-Fill\r\n                            </button>\r\n                        )}\r\n                        <div className=\"bg-slate-100 p-1 rounded-lg border border-slate-200 flex\">\r\n                            <button onClick={() => setViewMode('focus')} className={`px-3 py-1.5 rounded-md text-xs font-bold transition-all flex items-center gap-2 ${viewMode === 'focus' ? 'bg-white text-slate-900 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>\r\n                                <Filter className=\"w-3 h-3\" />Prime\r\n                            </button>\r\n                            <button onClick={() => setViewMode('full')} className={`px-3 py-1.5 rounded-md text-xs font-bold transition-all flex items-center gap-2 ${viewMode === 'full' ? 'bg-white text-slate-900 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>\r\n                                <Clock className=\"w-3 h-3\" />24h\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Grid Area */}\r\n            <div className=\"flex-1 overflow-y-auto custom-scrollbar relative bg-white\">\r\n                {loading && !weekData ? (\r\n                    <div className=\"absolute inset-0 flex flex-col items-center justify-center bg-white/80 backdrop-blur-sm z-10\">\r\n                        <Loader2 className=\"w-10 h-10 text-indigo-500 animate-spin mb-3\" />\r\n                        <p className=\"text-slate-500 text-sm animate-pulse\">Sincronizando operaciones...</p>\r\n                    </div>\r\n                ) : (\r\n                    <div className=\"pb-20\">\r\n                        <div className=\"sticky top-0 z-20 bg-white/95 backdrop-blur border-b border-slate-200 px-4 py-2 flex justify-between items-center shadow-sm\">\r\n                            <span className=\"text-sm font-bold text-slate-700 capitalize flex items-center gap-2\">\r\n                                {selectedDateObj.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' })}\r\n                                {isToday && <span className=\"px-1.5 py-0.5 bg-rose-50 text-rose-600 text-[10px] rounded border border-rose-200 uppercase\">Hoy</span>}\r\n                            </span>\r\n                            <span className=\"text-[10px] text-slate-500 font-mono bg-slate-100 px-2 py-1 rounded\">\r\n                                {(assignmentsByHour[14]?.length || 0) + (assignmentsByHour[21]?.length || 0)} activos est.\r\n                            </span>\r\n                        </div>\r\n                        <div className=\"divide-y divide-slate-100\">\r\n                            {timeSlots.map((hour, index) => {\r\n                                const prevHour = index > 0 ? timeSlots[index - 1] : -1;\r\n                                const showGap = viewMode === 'focus' && prevHour !== -1 && (hour - prevHour > 1);\r\n                                return (\r\n                                    <Fragment key={hour}>\r\n                                        {showGap && <div className=\"h-6 bg-slate-50 flex items-center justify-center border-y border-slate-100\"><MoreHorizontal className=\"w-4 h-4 text-slate-300\" /></div>}\r\n                                        <TimeSlot\r\n                                            hour={hour}\r\n                                            isCurrentHour={isToday && hour === currentHour}\r\n                                            assignments={assignmentsByHour[hour] || []}\r\n                                            canEdit={canEdit}\r\n                                            onAssign={() => { setNewShiftHour(hour); setEditingShift(null); setModals(m => ({ ...m, shift: true })); }}\r\n                                            onEdit={(shift) => { setEditingShift(shift); setNewShiftHour(null); setModals(m => ({ ...m, shift: true })); }}\r\n                                        />\r\n                                    </Fragment>\r\n                                );\r\n                            })}\r\n                        </div>\r\n                    </div>\r\n                )}\r\n            </div>\r\n\r\n            {canEdit && (\r\n                <>\r\n                    <QuickFillModal\r\n                        isOpen={modals.quick}\r\n                        onClose={() => setModals(m => ({ ...m, quick: false }))}\r\n                        onRefresh={refresh}\r\n                        franchiseId={activeFranchiseId}\r\n                        onCreateShifts={onQuickFillWrapper}\r\n                        riders={riders}\r\n                        motos={motos}\r\n                        weekDays={weekDays}\r\n                    />\r\n                    <ShiftModal\r\n                        isOpen={modals.shift}\r\n                        onClose={() => !isSaving && setModals(m => ({ ...m, shift: false }))}\r\n                        onSave={onSaveWrapper}\r\n                        onDelete={onDeleteWrapper}\r\n                        initialData={editingShift}\r\n                        riders={riders}\r\n                        motos={motos}\r\n                        selectedDate={selectedIsoDate}\r\n                        prefillHour={newShiftHour ?? undefined}\r\n                        isSaving={isSaving}\r\n                    />\r\n                </>\r\n            )}\r\n            <Toast message={notification?.message || null} type={notification?.type || 'success'} onClose={() => setNotification(null)} />\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default ShiftPlanner;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\operations\\SmartSuggestionsPanel.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":6,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":6,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[171,174],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[171,174],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":22,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[562,565],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[562,565],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useMemo } from 'react';\r\nimport { Lightbulb, X, AlertTriangle } from 'lucide-react';\r\n\r\ninterface Shift {\r\n    startAt: string | Date;\r\n    [key: string]: any;\r\n}\r\n\r\ninterface WeekData {\r\n    shifts?: Shift[];\r\n}\r\n\r\ninterface SmartSuggestionsPanelProps {\r\n    weekData: WeekData | null;\r\n    onClose: () => void;\r\n}\r\n\r\nconst SmartSuggestionsPanel: React.FC<SmartSuggestionsPanelProps> = ({ weekData, onClose }) => {\r\n    const suggestions = useMemo(() => {\r\n        if (!weekData?.shifts) return [];\r\n\r\n        const items: { type: string; icon: any; title: string; color: string }[] = [];\r\n        const dayGroups: Record<string, number> = {};\r\n\r\n        weekData.shifts.forEach(shift => {\r\n            const day = new Date(shift.startAt as string | Date).toISOString().split('T')[0];\r\n            dayGroups[day] = (dayGroups[day] || 0) + 1;\r\n        });\r\n\r\n        Object.entries(dayGroups).forEach(([day, count]) => {\r\n            if (count < 3) {\r\n                items.push({\r\n                    type: 'warning',\r\n                    icon: AlertTriangle,\r\n                    title: `${new Date(day).toLocaleDateString('es-ES', { weekday: 'short' })}: Solo ${count} turnos`,\r\n                    color: 'text-amber-400'\r\n                });\r\n            }\r\n        });\r\n\r\n        return items.slice(0, 5);\r\n    }, [weekData]);\r\n\r\n    if (suggestions.length === 0) return null;\r\n\r\n    return (\r\n        <div className=\"bg-slate-800/20 border border-slate-600/20 rounded px-2 py-1 mb-1\">\r\n            <div className=\"flex items-center gap-2\">\r\n                <div className=\"flex items-center gap-1 flex-shrink-0\">\r\n                    <Lightbulb className=\"w-3 h-3 text-amber-400\" />\r\n                    <span className=\"text-[9px] font-bold text-slate-400 uppercase\">{suggestions.length} Tips</span>\r\n                </div>\r\n\r\n                <div className=\"flex gap-2 overflow-x-auto custom-scrollbar flex-1\">\r\n                    {suggestions.map((suggestion, idx) => {\r\n                        const Icon = suggestion.icon;\r\n                        return (\r\n                            <div key={idx} className=\"flex items-center gap-1 text-[9px] text-slate-400 whitespace-nowrap bg-slate-900/30 px-2 py-0.5 rounded\">\r\n                                <Icon className={`w-2.5 h-2.5 ${suggestion.color}`} />\r\n                                <span>{suggestion.title}</span>\r\n                            </div>\r\n                        );\r\n                    })}\r\n                </div>\r\n\r\n                <button onClick={onClose} className=\"p-0.5 hover:bg-white/10 rounded transition-colors flex-shrink-0\">\r\n                    <X size={10} className=\"text-slate-400\" />\r\n                </button>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default SmartSuggestionsPanel;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\operations\\WeekMetricsPanel.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":41,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":41,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useMemo } from 'react';\r\nimport { Clock, DollarSign, Users, TrendingUp, AlertTriangle, Trophy } from 'lucide-react';\r\n\r\ninterface Shift {\r\n    riderId: string;\r\n    riderName: string;\r\n    startAt: string;\r\n    endAt: string;\r\n}\r\n\r\ninterface WeekData {\r\n    shifts: Shift[];\r\n}\r\n\r\ninterface WeekMetricsPanelProps {\r\n    weekData: WeekData | null | undefined;\r\n}\r\n\r\ninterface RiderStat {\r\n    name: string;\r\n    totalHours: number;\r\n}\r\n\r\nconst WeekMetricsPanel: React.FC<WeekMetricsPanelProps> = ({ weekData }) => {\r\n    const { totalHours, estimatedCost, activeRiders, healthScore, lowCoverageDays, topRiders } = useMemo(() => {\r\n        if (!weekData?.shifts) return { totalHours: 0, estimatedCost: 0, activeRiders: 0, healthScore: 0, lowCoverageDays: [], topRiders: [] };\r\n\r\n        const uniqueRiders = new Set(weekData.shifts.map(s => s.riderId));\r\n        const totalHours = weekData.shifts.reduce((sum, shift) => {\r\n            const start = new Date(shift.startAt).getTime();\r\n            const end = new Date(shift.endAt).getTime();\r\n            const duration = (end - start) / (1000 * 60 * 60);\r\n            return sum + (isNaN(duration) ? 0 : duration);\r\n        }, 0);\r\n\r\n        const dayGroups: Record<string, number> = {};\r\n        weekData.shifts.forEach(shift => {\r\n            try {\r\n                const day = new Date(shift.startAt).toISOString().split('T')[0];\r\n                dayGroups[day] = (dayGroups[day] || 0) + 1;\r\n            } catch (e) {\r\n                // Ignore invalid dates\r\n            }\r\n        });\r\n\r\n        const lowCoverageDays = Object.entries(dayGroups)\r\n            .filter(([_, count]) => count < 3)\r\n            .map(([day]) => day);\r\n\r\n        const coverageScore = Math.max(0, 100 - (lowCoverageDays.length * 15));\r\n\r\n        // Calculate top riders\r\n        const riderStats: Record<string, RiderStat> = {};\r\n        weekData.shifts.forEach(shift => {\r\n            const riderId = shift.riderId;\r\n            const riderName = shift.riderName;\r\n            if (!riderStats[riderId]) {\r\n                riderStats[riderId] = { name: riderName, totalHours: 0 };\r\n            }\r\n            const start = new Date(shift.startAt).getTime();\r\n            const end = new Date(shift.endAt).getTime();\r\n            const duration = (end - start) / (1000 * 60 * 60);\r\n            riderStats[riderId].totalHours += (isNaN(duration) ? 0 : duration);\r\n        });\r\n\r\n        const topRiders = Object.values(riderStats)\r\n            .sort((a, b) => b.totalHours - a.totalHours)\r\n            .slice(0, 3);\r\n\r\n        return {\r\n            totalHours: Math.round(totalHours),\r\n            estimatedCost: Math.round(totalHours * 12),\r\n            activeRiders: uniqueRiders.size,\r\n            healthScore: coverageScore,\r\n            lowCoverageDays,\r\n            topRiders\r\n        };\r\n    }, [weekData]);\r\n\r\n    const healthColor = healthScore > 70 ? 'text-emerald-400' : healthScore > 40 ? 'text-amber-400' : 'text-red-400';\r\n    const healthBg = healthScore > 70 ? 'bg-emerald-500/10' : healthScore > 40 ? 'bg-amber-500/10' : 'bg-red-500/10';\r\n\r\n    return (\r\n        <div className=\"grid grid-cols-8 gap-1 mb-1\">\r\n            <div className=\"bg-slate-900/50 border border-slate-700/30 rounded p-1.5\">\r\n                <div className=\"flex items-center gap-1 mb-0.5\">\r\n                    <Clock className=\"w-2.5 h-2.5 text-blue-400\" />\r\n                    <div className=\"text-[9px] opacity-80 uppercase tracking-wider\">Horas</div>\r\n                </div>\r\n                <div className=\"text-base font-bold text-white\">{totalHours}h</div>\r\n            </div>\r\n\r\n            <div className=\"bg-slate-900/50 border border-slate-700/30 rounded p-1.5\">\r\n                <div className=\"flex items-center gap-1 mb-0.5\">\r\n                    <DollarSign className=\"w-2.5 h-2.5 text-emerald-400\" />\r\n                    <div className=\"text-[9px] opacity-80 uppercase tracking-wider\">Coste</div>\r\n                </div>\r\n                <div className=\"text-base font-bold text-white\">{estimatedCost}‚Ç¨</div>\r\n            </div>\r\n\r\n            <div className=\"bg-slate-900/50 border border-slate-700/30 rounded p-1.5\">\r\n                <div className=\"flex items-center gap-1 mb-0.5\">\r\n                    <Users className=\"w-2.5 h-2.5 text-purple-400\" />\r\n                    <div className=\"text-[9px] opacity-80 uppercase tracking-wider\">Riders</div>\r\n                </div>\r\n                <div className=\"text-base font-bold text-white\">{activeRiders}</div>\r\n            </div>\r\n\r\n            <div className={`${healthBg} border border-slate-700/30 rounded p-1.5`}>\r\n                <div className=\"flex items-center gap-1 mb-0.5\">\r\n                    <TrendingUp className={`w-2.5 h-2.5 ${healthColor}`} />\r\n                    <div className=\"text-[9px] opacity-80 uppercase tracking-wider\">Salud</div>\r\n                </div>\r\n                <div className={`text-base font-bold ${healthColor}`}>{healthScore}%</div>\r\n            </div>\r\n\r\n            <div className=\"bg-slate-900/50 border border-slate-700/30 rounded p-1.5\">\r\n                <div className=\"flex items-center gap-1 mb-0.5\">\r\n                    <AlertTriangle className=\"w-2.5 h-2.5 text-red-400\" />\r\n                    <div className=\"text-[9px] opacity-80 uppercase tracking-wider\">Alertas</div>\r\n                </div>\r\n                <div className=\"text-base font-bold text-red-400\">{lowCoverageDays.length}</div>\r\n            </div>\r\n\r\n            {/* Top 3 Riders */}\r\n            {topRiders.map((rider, idx) => (\r\n                <div key={idx} className=\"bg-amber-500/10 border border-amber-500/30 rounded p-1.5\">\r\n                    <div className=\"flex items-center gap-1 mb-0.5\">\r\n                        <Trophy className=\"w-2.5 h-2.5 text-amber-400\" />\r\n                        <div className=\"text-[9px] opacity-80 uppercase tracking-wider\">#{idx + 1}</div>\r\n                    </div>\r\n                    <div className=\"text-[10px] font-bold text-white truncate\">{rider.name}</div>\r\n                    <div className=\"text-[9px] text-amber-400\">{Math.round(rider.totalHours)}h</div>\r\n                </div>\r\n            ))}\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default WeekMetricsPanel;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\operations\\WeekMiniMap.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":16,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":16,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[282,285],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[282,285],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\nimport { Eye, Users } from 'lucide-react';\r\n\r\ninterface Shift {\r\n    startAt: string | Date;\r\n    riderId?: string;\r\n}\r\n\r\ninterface WeekData {\r\n    shifts?: Shift[];\r\n}\r\n\r\ninterface DayInfo {\r\n    isoDate: string;\r\n    label: string;\r\n    [key: string]: any;\r\n}\r\n\r\ninterface WeekMiniMapProps {\r\n    weekData: WeekData | null;\r\n    days: DayInfo[] | null;\r\n}\r\n\r\nconst WeekMiniMap: React.FC<WeekMiniMapProps> = ({ weekData, days }) => {\r\n    if (!weekData || !days) return null;\r\n\r\n    // Calculate density and riders for each day\r\n    const dayDensity = days.map(day => {\r\n        const dayShifts = weekData.shifts?.filter(shift => {\r\n            const shiftDate = new Date(shift.startAt as string | Date).toISOString().split('T')[0];\r\n            return shiftDate === day.isoDate;\r\n        }) || [];\r\n\r\n        const uniqueRiders = new Set(dayShifts.map(s => s.riderId)).size;\r\n\r\n        return {\r\n            ...day,\r\n            shiftCount: dayShifts.length,\r\n            riderCount: uniqueRiders\r\n        };\r\n    });\r\n\r\n    const maxShifts = Math.max(...dayDensity.map(d => d.shiftCount), 1);\r\n\r\n    return (\r\n        <div className=\"bg-slate-900/30 border border-slate-700/20 rounded px-2 py-1 mb-1 flex items-center gap-2\">\r\n            <div className=\"flex items-center gap-1 flex-shrink-0\">\r\n                <Eye className=\"w-3 h-3 text-blue-400\" />\r\n                <div className=\"text-[9px] font-bold text-slate-400 uppercase\">Vista</div>\r\n            </div>\r\n\r\n            <div className=\"flex gap-0.5 flex-1\">\r\n                {dayDensity.map((day, idx) => {\r\n                    const intensity = day.shiftCount / maxShifts;\r\n                    const bgOpacity = Math.max(intensity * 40, 10);\r\n\r\n                    return (\r\n                        <div\r\n                            key={idx}\r\n                            className={`group relative flex-1 h-6 rounded transition-all ${day.shiftCount === 0\r\n                                ? 'bg-slate-800/20'\r\n                                : `bg-emerald-500/${Math.round(bgOpacity)}`\r\n                                }`}\r\n                            title={`${day.label}: ${day.shiftCount} turnos, ${day.riderCount} riders`}\r\n                        >\r\n                            <div className=\"absolute inset-0 flex flex-col items-center justify-center\">\r\n                                <div className=\"text-[7px] font-bold text-slate-400\">{day.label.substring(0, 1)}</div>\r\n                                <div className=\"flex items-center gap-0.5\">\r\n                                    <Users className=\"w-2 h-2 text-purple-400\" />\r\n                                    <span className=\"text-[7px] font-bold text-white\">{day.riderCount}</span>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    );\r\n                })}\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default WeekMiniMap;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\operations\\WeeklyCalendarGrid.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\operations\\WeeklyScheduler.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":24,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":24,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1478,1481],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1478,1481],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":52,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":52,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2319,2322],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2319,2322],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":182,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":182,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7563,7566],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7563,7566],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":375,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":375,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15937,15940],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15937,15940],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":377,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":377,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16058,16061],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16058,16061],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":384,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":384,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16333,16336],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16333,16336],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":400,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":400,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[17216,17219],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[17216,17219],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":442,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":442,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18778,18781],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18778,18781],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":455,"column":62,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":455,"endColumn":65,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19506,19509],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19506,19509],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":757,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":757,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[32350,32353],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[32350,32353],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":1141,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1141,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[60063,60066],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[60063,60066],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":1143,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1143,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[60134,60137],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[60134,60137],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":12,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useMemo } from 'react';\r\nimport { ChevronLeft, ChevronRight, Save, Zap, Filter, XCircle } from 'lucide-react';\r\nimport { cn } from '../../lib/utils';\r\nimport { getShiftDuration, getRiderInitials } from '../../utils/colorPalette';\r\nimport ShiftModal from './ShiftModal';\r\nimport QuickFillModal from './QuickFillModal';\r\n\r\nimport { findMotoConflict, findRiderConflict } from '../../utils/schedulerValidation';\r\nimport { toLocalISOStringWithOffset, toLocalDateString, getStartOfWeek } from '../../utils/dateUtils';\r\nimport { useMediaQuery } from '../../hooks/useMediaQuery';\r\nimport MobileAgendaView from './MobileAgendaView';\r\nimport { useWeeklySchedule, getWeekIdFromDate, type Shift, type WeekData } from '../../hooks/useWeeklySchedule';\r\nimport { WeekService } from '../../services/scheduler/weekService';\r\nimport { toFranchiseId, toWeekId } from '../../schemas/scheduler';\r\nimport ConfirmationModal from '../../ui/feedback/ConfirmationModal';\r\nimport { getRiderColorMap } from '../../utils/riderColors';\r\nimport { validateWeeklySchedule, generateScheduleFix, generateFullSchedule } from '../../lib/gemini';\r\nimport { BadgeCheck, AlertTriangle, ShieldCheck, Wand2, Sparkles } from 'lucide-react';\r\nimport { useOperationsIntel, intelService } from '../../services/intelService';\r\n\r\n// üî• FILE LOAD LOG matches user request\r\nconsole.log('üì¶ ARCHIVO WeeklyScheduler.tsx CARGADO EN EL NAVEGADOR');\r\n\r\nconst getDayDemandLevel = (dayDate: string, dayIntel: any[]) => {\r\n    const hasCritical = dayIntel.some(e => e.severity === 'critical');\r\n    const hasWarning = dayIntel.some(e => e.severity === 'warning');\r\n    const dayOfWeek = new Date(dayDate).getDay(); // 0: Sun, 5: Fri, 6: Sat\r\n\r\n    // Friday to Sunday are naturally \"warning\" (Medium) unless \"critical\" exists\r\n    if (hasCritical) return 'critical';\r\n    if (hasWarning || [0, 5, 6].includes(dayOfWeek)) return 'warning';\r\n    return 'normal';\r\n};\r\n\r\n// ... (Existing types and constants)\r\n\r\n\r\n\r\ninterface WeeklySchedulerProps {\r\n    franchiseId: string;\r\n    readOnly?: boolean;\r\n}\r\n\r\ninterface VisualEvent extends Shift {\r\n    visualDate: string;\r\n    visualStart: Date;\r\n    visualEnd: Date;\r\n    isContinuation: boolean;\r\n    isConfirmed?: boolean;\r\n    changeRequested?: boolean;\r\n    changeReason?: string | null;\r\n    layout?: any;\r\n}\r\n\r\ninterface ShiftEvent extends VisualEvent {\r\n    riderId: string;\r\n    riderName: string;\r\n    franchiseId: string;\r\n}\r\n\r\n// --- V13 SUB-COMPONENTS ---\r\n\r\nconst ShiftPill: React.FC<{\r\n    event: ShiftEvent;\r\n    onClick: (e: React.MouseEvent) => void;\r\n    onDelete: (id: string, e: React.MouseEvent) => void;\r\n    riderColor?: { bg: string, border: string, text: string }; // Kept for future optional use\r\n    readOnly?: boolean;\r\n}> = ({ event, onClick, onDelete, readOnly }) => {\r\n    const isConfirmed = event.isConfirmed;\r\n    const changeRequested = event.changeRequested;\r\n    const changeReason = event.changeReason;\r\n    const duration = getShiftDuration(event.startAt, event.endAt);\r\n    const startTime = event.visualStart.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });\r\n    const endTime = event.visualEnd.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });\r\n    const isNight = event.visualStart.getHours() >= 19;\r\n\r\n    // --- NEW VISUAL LOGIC: Status Borders + Neutral Backgrounds ---\r\n    const getBaseStyle = () => {\r\n        // 1. Critical Errors (Conflicts) -> Red Border\r\n        // TODO: Pass 'isConflict' prop if available. For now, assuming standard logic.\r\n\r\n        // 2. Change Requested -> Amber Border\r\n        if (changeRequested) {\r\n            return \"bg-slate-100 border-l-[3px] border-l-amber-400 border-t border-b border-r border-slate-200 text-slate-700\";\r\n        }\r\n\r\n        // 3. Normal / Confirmed -> Neutral Identity\r\n        // Day shifts: Lighter / Night shifts: Darker\r\n        if (isNight) {\r\n            return \"bg-slate-800 border border-slate-700 text-slate-100 shadow-sm\";\r\n        }\r\n\r\n        return \"bg-white border border-slate-200 text-slate-600 shadow-sm\";\r\n    };\r\n\r\n    return (\r\n        <div\r\n            onClick={onClick}\r\n            className={cn(\r\n                \"group/pill relative h-[26px] rounded-md transition-all duration-200 cursor-pointer overflow-hidden flex items-center px-2 select-none\",\r\n                getBaseStyle(),\r\n                \"hover:brightness-95 hover:scale-[1.01] hover:shadow-md hover:z-50 active:scale-95\",\r\n                changeRequested && \"hover:bg-amber-50\"\r\n            )}\r\n            title={`${event.riderName} | ${startTime} - ${endTime} (${duration}h)${changeRequested ? ` | MOTIVO: ${changeReason || 'Sin motivo'}` : ''}`}\r\n        >\r\n            <div className=\"flex items-center gap-1.5 min-w-0 w-full relative z-10\">\r\n                {/* Status Icons */}\r\n                {changeRequested && <AlertTriangle className=\"w-3 h-3 text-amber-500 shrink-0 animate-pulse\" />}\r\n                {isConfirmed && !changeRequested && <div className=\"w-1.5 h-1.5 rounded-full bg-emerald-500 shrink-0\" />}\r\n\r\n                <span className=\"text-[10px] font-bold tracking-tight truncate flex-1\">\r\n                    {startTime} - {endTime}\r\n                </span>\r\n\r\n                <span className=\"text-[9px] font-medium opacity-70 shrink-0\">\r\n                    {duration}h\r\n                </span>\r\n            </div>\r\n\r\n            {/* Delete Action */}\r\n            {!readOnly && (\r\n                <button\r\n                    onClick={(e) => { e.stopPropagation(); onDelete(event.shiftId || '', e); }}\r\n                    className=\"absolute right-0.5 opacity-0 group-hover/pill:opacity-100 transition-opacity p-0.5 hover:bg-slate-200 rounded text-slate-400 hover:text-rose-500\"\r\n                >\r\n                    <XCircle className=\"w-3 h-3\" />\r\n                </button>\r\n            )}\r\n        </div>\r\n    );\r\n};\r\n\r\nconst CurrentTimeIndicator: React.FC<{ startHour: number, endHour: number }> = ({ startHour, endHour }) => {\r\n    const [now, setNow] = React.useState(new Date());\r\n\r\n    React.useEffect(() => {\r\n        const timer = setInterval(() => setNow(new Date()), 60000);\r\n        return () => clearInterval(timer);\r\n    }, []);\r\n\r\n    const hour = now.getHours();\r\n    const minute = now.getMinutes();\r\n\r\n    if (hour < startHour || hour >= endHour) return null;\r\n\r\n    const percent = ((hour - startHour) * 60 + minute) / ((endHour - startHour) * 60) * 100;\r\n\r\n    return (\r\n        <div\r\n            className=\"absolute top-0 bottom-0 w-0.5 bg-rose-500 z-40 pointer-events-none shadow-[0_0_12px_rgba(244,63,94,0.8)]\"\r\n            style={{ left: `${percent}%` }}\r\n        >\r\n            <div className=\"absolute top-0 -left-1.5 w-3.5 h-3.5 bg-rose-500 rounded-full border-[3px] border-white shadow-md animate-pulse\" />\r\n        </div>\r\n    );\r\n};\r\n\r\nconst WeeklyScheduler: React.FC<WeeklySchedulerProps> = ({ franchiseId, readOnly = false }) => {\r\n    // üî• CRITICAL LOG REQUESTED BY USER\r\n    console.log('üöÄ [CR√çTICO] WeeklyScheduler intentando montar. ID Recibido:', franchiseId);\r\n    // üî• CRITICAL LOG: Start of Render\r\n\r\n\r\n    // --- STATE MANAGEMENT (HOOK) ---\r\n    const {\r\n        weekData,\r\n        loading,\r\n        referenceDate,\r\n        currentWeekId,\r\n        riders,\r\n        motos,\r\n        navigateWeek,\r\n        saveWeek,\r\n        updateWeekData,\r\n        refresh\r\n    } = useWeeklySchedule(franchiseId, readOnly);\r\n\r\n    // --- UI Local State ---\r\n    const [isModalOpen, setIsModalOpen] = useState(false);\r\n    const [editingShift, setEditingShift] = useState<any | null>(null); // Ideally narrow down ShiftData\r\n    const [selectedDateForNew, setSelectedDateForNew] = useState<string | null>(null);\r\n    const [isQuickFillOpen, setIsQuickFillOpen] = useState(false);\r\n    const [isProcessing, setIsProcessing] = useState(false);\r\n    const [selectedRiderId, setSelectedRiderId] = useState<string | null>(null); // Filter by rider\r\n\r\n    // PRIME MODE STATE - Horario Prime: 12:00-16:00 (comidas) y 19:00-24:00 (cenas)\r\n\r\n    const [viewMode, setViewMode] = useState<'full' | 'prime'>('full');\r\n    const { events: intelEvents } = useOperationsIntel(referenceDate);\r\n    const intelByDay = useMemo(() => intelService.getEventsByDay(intelEvents), [intelEvents]);\r\n\r\n    const [confirmDialog, setConfirmDialog] = useState({\r\n        isOpen: false,\r\n        title: '',\r\n        message: '',\r\n        onConfirm: () => { },\r\n        isDestructive: false,\r\n        confirmText: 'Confirmar'\r\n    });\r\n\r\n    // SHERIFF STATE\r\n    const [sheriffResult, setSheriffResult] = useState<{\r\n        score: number;\r\n        status: 'optimal' | 'warning' | 'critical';\r\n        feedback: string;\r\n        missingCoverage: string[];\r\n    } | null>(null);\r\n    const [isAuditing, setIsAuditing] = useState(false);\r\n    const [isFixing, setIsFixing] = useState(false); // Auto-Fix State\r\n    const [isGenerating, setIsGenerating] = useState(false);\r\n    const [showGenModal, setShowGenModal] = useState(false);\r\n    const [genPrompt, setGenPrompt] = useState('');\r\n\r\n    // Helpers\r\n    const changeWeek = (dir: number) => navigateWeek(dir);\r\n    const isMobile = useMediaQuery('(max-width: 768px)');\r\n    const isSaving = loading || isProcessing || isFixing;\r\n    const closeConfirm = () => setConfirmDialog(prev => ({ ...prev, isOpen: false }));\r\n\r\n    // --- LOGIC: Shift Operations ---\r\n\r\n    // ... (Existing logic) ...\r\n\r\n    const handleAutoFix = async () => {\r\n        if (!sheriffResult || !weekData) return;\r\n\r\n        setIsFixing(true);\r\n        try {\r\n            const fixResult = await generateScheduleFix(\r\n                weekData.shifts || [],\r\n                riders || [],\r\n                sheriffResult.missingCoverage\r\n            );\r\n\r\n            if (fixResult && fixResult.newShifts.length > 0) {\r\n                // Confirm before applying\r\n                const confirmed = window.confirm(\r\n                    `El Sheriff sugiere ${fixResult.newShifts.length} nuevos turnos:\\n\\n` +\r\n                    fixResult.explanation +\r\n                    `\\n\\n¬øAplicar cambios ahora?`\r\n                );\r\n\r\n                if (confirmed) {\r\n                    const newShiftsObjects: Shift[] = fixResult.newShifts.map(s => {\r\n                        // Parse \"YYYY-MM-DD\" and startHour to ISO\r\n                        const startD = new Date(s.startDay);\r\n                        startD.setHours(s.startHour, 0, 0, 0);\r\n\r\n                        const endD = new Date(startD);\r\n                        endD.setHours(s.startHour + s.duration, 0, 0, 0);\r\n\r\n                        // Find rider name\r\n                        const rider = riders?.find(r => r.id === s.riderId);\r\n\r\n                        return {\r\n                            id: `fix_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`,\r\n                            shiftId: `fix_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`,\r\n                            riderId: s.riderId,\r\n                            riderName: rider ? (rider.fullName || 'Rider') : 'Desconocido',\r\n                            motoId: null,\r\n                            motoPlate: null,\r\n                            startAt: toLocalISOStringWithOffset(startD),\r\n                            endAt: toLocalISOStringWithOffset(endD),\r\n                            notes: `Sheriff Auto-Fix: ${s.reason}`\r\n                        };\r\n                    });\r\n\r\n                    // Merge and Save\r\n                    const currentShifts = weekData.shifts || [];\r\n                    const updatedShifts = [...currentShifts, ...newShiftsObjects];\r\n\r\n                    const updatedWeekData: WeekData = {\r\n                        ...(weekData),\r\n                        shifts: updatedShifts,\r\n                        id: currentWeekId,\r\n                        startDate: toLocalDateString(getStartOfWeek(referenceDate))\r\n                    } as WeekData;\r\n\r\n                    await WeekService.saveWeek(toFranchiseId(franchiseId), toWeekId(currentWeekId), updatedWeekData);\r\n                    updateWeekData(updatedWeekData);\r\n\r\n                    // Re-audit automatically to show improved score\r\n                    setTimeout(() => handleAuditoria(), 1000);\r\n\r\n                }\r\n            } else {\r\n                alert(\"El Sheriff no encontr√≥ una soluci√≥n autom√°tica viable. Intenta mover turnos manualmente.\");\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Auto-Fix Error:\", error);\r\n            alert(\"Error al aplicar la correcci√≥n autom√°tica.\");\r\n        } finally {\r\n            setIsFixing(false);\r\n        }\r\n    };\r\n\r\n    const handleGeneration = async () => {\r\n        if (!genPrompt.trim()) return;\r\n        setIsGenerating(true);\r\n        try {\r\n            const startDate = weekData?.startDate || (referenceDate instanceof Date ? referenceDate.toISOString() : referenceDate).split('T')[0];\r\n            const endDate = new Date(startDate);\r\n            endDate.setDate(endDate.getDate() + 6);\r\n\r\n            const result = await generateFullSchedule(\r\n                genPrompt,\r\n                riders || [],\r\n                startDate,\r\n                endDate.toISOString().split('T')[0]\r\n            );\r\n\r\n            if (result && result.shifts.length > 0) {\r\n                const apply = window.confirm(`He generado ${result.shifts.length} turnos:\\n\\n${result.explanation}\\n\\n¬øAplicar al cuadrante?`);\r\n\r\n                if (apply) {\r\n                    const newShiftsObjects = result.shifts.map(s => {\r\n                        const startD = new Date(s.startDay);\r\n                        startD.setHours(s.startHour, 0, 0, 0);\r\n                        const endD = new Date(startD);\r\n                        endD.setHours(s.startHour + s.duration, 0, 0, 0);\r\n\r\n                        const rider = riders?.find(r => r.id === s.riderId);\r\n\r\n                        return {\r\n                            id: `gen_${Date.now()}_${Math.random()}`,\r\n                            shiftId: `gen_${Date.now()}_${Math.random()}`,\r\n                            riderId: s.riderId,\r\n                            riderName: rider ? rider.fullName : 'Rider IA',\r\n                            motoId: null,\r\n                            motoPlate: null,\r\n                            startAt: toLocalISOStringWithOffset(startD),\r\n                            endAt: toLocalISOStringWithOffset(endD),\r\n                            notes: `IA: ${s.reason}`\r\n                        };\r\n                    });\r\n\r\n                    // Adding to existing\r\n                    const updatedWeek = {\r\n                        ...weekData,\r\n                        shifts: [...(weekData?.shifts || []), ...newShiftsObjects]\r\n                    } as WeekData;\r\n\r\n                    await WeekService.saveWeek(toFranchiseId(franchiseId), toWeekId(currentWeekId), updatedWeek);\r\n                    updateWeekData(updatedWeek);\r\n                    setShowGenModal(false);\r\n                    setGenPrompt('');\r\n                }\r\n            }\r\n        } catch (e) {\r\n            console.error(e);\r\n            alert(\"Error generando horario\");\r\n        } finally {\r\n            setIsGenerating(false);\r\n        }\r\n    };\r\n\r\n    const handleOpenNew = (dateIsoString?: string) => {\r\n        if (readOnly) return;\r\n        setEditingShift(null);\r\n        if (dateIsoString) {\r\n            setSelectedDateForNew(dateIsoString);\r\n        } else {\r\n            const today = toLocalDateString(new Date());\r\n            const isTodayInWeek = weekData && weekData.startDate && weekData.endDate && today >= weekData.startDate && today <= weekData.endDate;\r\n            setSelectedDateForNew(isTodayInWeek ? today : (weekData?.startDate || today));\r\n        }\r\n        setIsModalOpen(true);\r\n    };\r\n\r\n\r\n    // const handleCopyWeek = async () => { ... } // Kept commented as in original if not used\r\n\r\n    const handleSaveShift = async (shiftPayload: any) => {\r\n        // Internal save logic extracted for reuse in callbacks\r\n        const saveInternal = async (payload: any) => {\r\n            try {\r\n                setIsProcessing(true);\r\n                const currentShifts = weekData?.shifts || [];\r\n                let updatedShifts: Shift[];\r\n\r\n                if (editingShift) {\r\n                    updatedShifts = currentShifts.map((s: any) => (s.shiftId === payload.shiftId || s.id === payload.shiftId) ? payload : s);\r\n                } else {\r\n                    updatedShifts = [...currentShifts, payload];\r\n                }\r\n\r\n                const updatedWeekData: WeekData = {\r\n                    ...(weekData || {}),\r\n                    shifts: updatedShifts,\r\n                    id: currentWeekId,\r\n                    startDate: toLocalDateString(getStartOfWeek(referenceDate)),\r\n                    status: weekData?.status || 'draft',\r\n                    metrics: weekData?.metrics || { totalHours: 0, activeRiders: 0, motosInUse: 0 }\r\n                } as WeekData;\r\n                await WeekService.saveWeek(toFranchiseId(franchiseId), toWeekId(currentWeekId), updatedWeekData);\r\n                updateWeekData(updatedWeekData);\r\n                setIsModalOpen(false);\r\n            } catch (error: any) {\r\n                console.error(\"Error saving shift:\", error);\r\n                alert(\"Error al guardar el turno.\");\r\n            } finally {\r\n                setIsProcessing(false);\r\n            }\r\n        };\r\n\r\n        const currentShifts = weekData?.shifts || [];\r\n\r\n        // A. Moto Conflict\r\n        const motoConflict = findMotoConflict(shiftPayload, currentShifts, editingShift?.shiftId);\r\n        if (motoConflict) {\r\n            setConfirmDialog({\r\n                isOpen: true,\r\n                title: 'Conflicto de Moto',\r\n                message: `La moto ya est√° asignada a ${motoConflict.riderName} en este horario. ¬øQuieres asignarla de todas formas?`,\r\n                confirmText: 'Asignar Igualmente',\r\n                isDestructive: true,\r\n                onConfirm: () => saveInternal(shiftPayload)\r\n            });\r\n            return;\r\n        }\r\n\r\n        // B. Rider Conflict\r\n        const riderConflict = findRiderConflict(shiftPayload, currentShifts, editingShift?.shiftId);\r\n        if (riderConflict) {\r\n            setConfirmDialog({\r\n                isOpen: true,\r\n                title: 'Conflicto de Rider',\r\n                message: `${shiftPayload.riderName} ya tiene turno. ¬øCrear igual?`,\r\n                confirmText: 'Crear Igualmente',\r\n                isDestructive: true,\r\n                onConfirm: () => saveInternal(shiftPayload)\r\n            });\r\n            return;\r\n        }\r\n\r\n        // No conflicts\r\n        await saveInternal(shiftPayload);\r\n    };\r\n\r\n    const handleQuickFillCreate = async (shifts: any[]) => {\r\n        if (!weekData) return;\r\n        setIsProcessing(true);\r\n        try {\r\n            const newShifts = shifts.map(shift => {\r\n                const startDate = new Date(`${shift.date}T${shift.startTime}:00`);\r\n                const endDate = new Date(`${shift.date}T${shift.endTime}:00`);\r\n                return {\r\n                    id: `shift_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\r\n                    shiftId: `shift_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\r\n                    riderId: shift.riderId,\r\n                    riderName: shift.riderName,\r\n                    motoId: shift.motoId || null,\r\n                    motoPlate: shift.motoId ? motos.find((m: any) => m.id === shift.motoId)?.licensePlate : null,\r\n                    startAt: toLocalISOStringWithOffset(startDate),\r\n                    endAt: toLocalISOStringWithOffset(endDate),\r\n                    notes: 'Creado con Relleno R√°pido'\r\n                };\r\n            });\r\n\r\n            const updatedShifts: Shift[] = [...(weekData.shifts || []), ...newShifts];\r\n            const updatedWeekData: WeekData = {\r\n                ...weekData,\r\n                shifts: updatedShifts,\r\n                id: currentWeekId,\r\n                startDate: toLocalDateString(getStartOfWeek(referenceDate))\r\n            } as WeekData;\r\n            await WeekService.saveWeek(toFranchiseId(franchiseId), toWeekId(currentWeekId), updatedWeekData);\r\n            updateWeekData(updatedWeekData);\r\n            alert(`‚úÖ ${newShifts.length} turno(s) creado(s)!`);\r\n        } catch (error) {\r\n            console.error(\"Error creating bulk shifts:\", error);\r\n            alert(\"Error al crear los turnos.\");\r\n        } finally {\r\n            setIsProcessing(false);\r\n        }\r\n    };\r\n\r\n    const handleDeleteShift = async (shiftId: string, e?: React.MouseEvent) => {\r\n        if (e) e.stopPropagation();\r\n\r\n        const performDelete = async () => {\r\n            try {\r\n                setIsProcessing(true);\r\n                const currentShifts = weekData?.shifts || [];\r\n                const updatedShifts = currentShifts.filter((s) => (s.shiftId !== shiftId && (s.id as string) !== shiftId));\r\n                if (!weekData) return;\r\n                const updatedWeekData: Partial<WeekData> = { ...weekData, shifts: updatedShifts, id: currentWeekId };\r\n                await WeekService.saveWeek(toFranchiseId(franchiseId), toWeekId(currentWeekId), updatedWeekData);\r\n                updateWeekData(updatedWeekData as WeekData);\r\n                setIsModalOpen(false);\r\n            } catch (error) {\r\n                console.error(\"Error deleting shift:\", error);\r\n                alert(\"Error al eliminar.\");\r\n            } finally {\r\n                setIsProcessing(false);\r\n            }\r\n        };\r\n\r\n        setConfirmDialog({\r\n            isOpen: true,\r\n            title: 'Eliminar Turno',\r\n            message: '¬øSeguro que quieres eliminar este turno? Esta acci√≥n no se puede deshacer.',\r\n            confirmText: 'Eliminar',\r\n            isDestructive: true,\r\n            onConfirm: performDelete\r\n        });\r\n    };\r\n\r\n    // --- HELPERS FOR RENDERING ---\r\n\r\n    const getDays = () => {\r\n        // ALWAYS calculate Monday from referenceDate to ensure strict Weekly View (Mon-Mon)\r\n        const startString = getStartOfWeek(referenceDate);\r\n        const [y, m, d] = startString.split('-').map(Number);\r\n        const start = new Date(y, m - 1, d);\r\n\r\n        const days = [];\r\n        for (let i = 0; i < 7; i++) {\r\n            const dateObj = new Date(start);\r\n            dateObj.setDate(start.getDate() + i);\r\n            days.push({\r\n                dateObj: dateObj,\r\n                label: dateObj.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric' }),\r\n                isoDate: toLocalDateString(dateObj),\r\n                shortLabel: dateObj.toLocaleDateString('es-ES', { weekday: 'short' })\r\n            });\r\n        }\r\n        return days;\r\n    };\r\n\r\n    const days = getDays();\r\n\r\n    // --- OPTIMIZATION: GROUP BY DAY DICTIONARY (O(N)) ---\r\n    const visualEvents = useMemo(() => {\r\n        if (!weekData?.shifts) return {} as Record<string, VisualEvent[]>;\r\n\r\n        const groupedEvents: Record<string, VisualEvent[]> = {}; // Dictionary: { 'YYYY-MM-DD': [events...] }\r\n\r\n        // Helper to push to dictionary safely\r\n        const pushToDay = (dateKey: string, eventObj: VisualEvent) => {\r\n            if (!groupedEvents[dateKey]) groupedEvents[dateKey] = [];\r\n            groupedEvents[dateKey].push(eventObj);\r\n        };\r\n\r\n        weekData.shifts.forEach((shift: Shift) => {\r\n            const startISO = shift.startAt;\r\n            const endISO = shift.endAt;\r\n\r\n            // WARNING: INTENTIONAL TIMEZONE STRIPPING FOR VISUAL CONSISTENCY\r\n            const parseDateManual = (isoStr: string) => {\r\n                if (!isoStr) return new Date();\r\n                const cleanStr = isoStr.replace('Z', '').split('.')[0];\r\n                const [datePart, timePart] = cleanStr.split('T');\r\n                const [y, m, d] = datePart.split('-').map(Number);\r\n                const [h, min] = timePart.split(':').map(Number);\r\n                return new Date(y, m - 1, d, h, min, 0);\r\n            };\r\n\r\n            const start = parseDateManual(startISO);\r\n            const end = parseDateManual(endISO);\r\n            const startDay = startISO.split('T')[0];\r\n            const endDay = endISO.split('T')[0];\r\n\r\n            if (startDay === endDay) {\r\n                pushToDay(startDay, {\r\n                    ...shift,\r\n                    visualDate: startDay,\r\n                    visualStart: start,\r\n                    visualEnd: end,\r\n                    isConfirmed: shift.isConfirmed === true,\r\n                    changeRequested: shift.changeRequested === true,\r\n                    changeReason: shift.changeReason || null,\r\n                    franchiseId: shift.franchiseId,\r\n                    isContinuation: false\r\n                });\r\n            } else {\r\n                // Cross-Midnight Split\r\n                const endOfDay = new Date(start);\r\n                endOfDay.setHours(23, 59, 59, 999);\r\n                pushToDay(startDay, {\r\n                    ...shift,\r\n                    visualDate: startDay,\r\n                    visualStart: start,\r\n                    visualEnd: endOfDay,\r\n                    isConfirmed: shift.isConfirmed === true,\r\n                    changeRequested: shift.changeRequested === true,\r\n                    changeReason: shift.changeReason || null,\r\n                    franchiseId: shift.franchiseId,\r\n                    isContinuation: false\r\n                });\r\n\r\n                const startOfNextDay = new Date(end);\r\n                startOfNextDay.setHours(0, 0, 0, 0);\r\n                pushToDay(endDay, {\r\n                    ...shift,\r\n                    visualDate: endDay,\r\n                    visualStart: startOfNextDay,\r\n                    visualEnd: end,\r\n                    isConfirmed: shift.isConfirmed === true,\r\n                    changeRequested: shift.changeRequested === true,\r\n                    changeReason: shift.changeReason || null,\r\n                    franchiseId: shift.franchiseId,\r\n                    isContinuation: true\r\n                });\r\n            }\r\n        });\r\n\r\n        return groupedEvents;\r\n    }, [weekData?.shifts]);\r\n\r\n    // Color map for riders\r\n    const riderColorMap = useMemo(() => {\r\n        return getRiderColorMap(riders || []);\r\n    }, [riders]);\r\n\r\n    // --- V13 CORE LOGIC: GROUPING BY RIDER ---\r\n    const ridersGrid = useMemo(() => {\r\n        if (!riders) return [];\r\n\r\n        // Sort riders: Active first, then alphabet\r\n        const sortedRiders = [...riders].sort((a, b) => {\r\n            if (a.status === 'active' && b.status !== 'active') return -1;\r\n            if (a.status !== 'active' && b.status === 'active') return 1;\r\n            return a.fullName.localeCompare(b.fullName);\r\n        });\r\n\r\n        // Group shifts by rider\r\n        const riderShiftsMap: Record<string, Record<string, ShiftEvent[]>> = {};\r\n\r\n        // Initialize map\r\n        sortedRiders.forEach(r => {\r\n            riderShiftsMap[r.id] = {};\r\n            days.forEach(d => riderShiftsMap[r.id][d.isoDate] = []);\r\n        });\r\n\r\n        // Fill map with Merging Logic\r\n        Object.keys(visualEvents).forEach(dayKey => {\r\n            visualEvents[dayKey].forEach(ev => {\r\n                if (ev.riderId && riderShiftsMap[ev.riderId]) {\r\n                    const riderDayShifts = riderShiftsMap[ev.riderId][dayKey];\r\n\r\n                    // Visual Merging: If this shift starts exactly when the last one ended\r\n                    const lastShift = riderDayShifts[riderDayShifts.length - 1];\r\n                    if (lastShift && lastShift.endAt === ev.startAt && !ev.isContinuation) {\r\n                        // Merge!\r\n                        lastShift.endAt = ev.endAt;\r\n                        lastShift.visualEnd = ev.visualEnd;\r\n                        // Keep the original id, but update data\r\n                    } else {\r\n                        riderDayShifts.push({ ...ev } as ShiftEvent);\r\n                    }\r\n                }\r\n            });\r\n        });\r\n\r\n        return sortedRiders.map(rider => ({\r\n            ...rider,\r\n            days: days.map(day => ({\r\n                ...day,\r\n                shifts: riderShiftsMap[rider.id][day.isoDate] || []\r\n            }))\r\n        }));\r\n    }, [riders, visualEvents, days]);\r\n\r\n    // Position calc constants\r\n    const START_HOUR = 8;\r\n    const END_HOUR = 24;\r\n    const TOTAL_MINUTES = (END_HOUR - START_HOUR) * 60;\r\n\r\n    const getShiftPosition = (start: Date, end: Date) => {\r\n        const sHour = start.getHours();\r\n        const sMin = start.getMinutes();\r\n        const eHour = end.getHours();\r\n        const eMin = end.getMinutes();\r\n\r\n        // Clamp to grid range\r\n        const safeStart = Math.max(sHour * 60 + sMin, START_HOUR * 60);\r\n        const safeEnd = Math.min(eHour * 60 + eMin, END_HOUR * 60);\r\n\r\n        const leftPercent = ((safeStart - START_HOUR * 60) / TOTAL_MINUTES) * 100;\r\n        const widthPercent = ((safeEnd - safeStart) / TOTAL_MINUTES) * 100;\r\n\r\n        return { left: `${leftPercent}%`, width: `${widthPercent}%` };\r\n    };\r\n\r\n    // Drag & Drop\r\n    const handleDrop = async (e: React.DragEvent, targetDay: { isoDate: string }) => {\r\n        e.preventDefault();\r\n        e.currentTarget.classList.remove('bg-blue-500/10', 'border-blue-400/50');\r\n        if (readOnly) return;\r\n\r\n        try {\r\n            const rawData = e.dataTransfer.getData('application/json');\r\n            if (!rawData) return;\r\n            const shiftData = JSON.parse(rawData);\r\n\r\n            setIsProcessing(true);\r\n\r\n            const originalStart = new Date(shiftData.startAt);\r\n            const originalEnd = new Date(shiftData.endAt);\r\n            const duration = originalEnd.getTime() - originalStart.getTime();\r\n\r\n            const newStart = new Date(targetDay.isoDate);\r\n            const newEnd = new Date(targetDay.isoDate);\r\n            newStart.setHours(originalStart.getHours(), originalStart.getMinutes(), 0, 0);\r\n            newEnd.setHours(originalEnd.getHours(), originalEnd.getMinutes(), 0, 0);\r\n            newEnd.setTime(newStart.getTime() + duration);\r\n\r\n            const updatedShift = {\r\n                ...shiftData,\r\n                startAt: newStart.toISOString(),\r\n                endAt: newEnd.toISOString()\r\n            };\r\n\r\n            // Basic conflict check\r\n            const hasConflict = weekData?.shifts.some((s: Shift) => {\r\n                if (s.shiftId === shiftData.shiftId) return false;\r\n                const sameRider = s.riderId === updatedShift.riderId;\r\n                const sameMoto = s.motoId && updatedShift.motoId && s.motoId === updatedShift.motoId;\r\n                const sStart = new Date(s.startAt);\r\n                const sEnd = new Date(s.endAt);\r\n                const timeOverlap = !(newEnd <= sStart || newStart >= sEnd);\r\n                return timeOverlap && (sameRider || sameMoto);\r\n            });\r\n\r\n            if (hasConflict) {\r\n                alert('‚ö†Ô∏è ¬°Conflicto detectado! El turno no puede moverse a ese horario.');\r\n                setIsProcessing(false);\r\n                return;\r\n            }\r\n\r\n            if (!weekData) return;\r\n            const currentShifts = weekData.shifts || [];\r\n            const updatedShifts = currentShifts.map((s: Shift) =>\r\n                s.shiftId === shiftData.shiftId ? updatedShift : s\r\n            );\r\n            const updatedWeekData: WeekData = {\r\n                ...weekData,\r\n                shifts: updatedShifts,\r\n                id: currentWeekId,\r\n                startDate: weekData.startDate || (referenceDate instanceof Date ? referenceDate.toISOString() : referenceDate).split('T')[0]\r\n            } as WeekData;\r\n            await WeekService.saveWeek(toFranchiseId(franchiseId), toWeekId(currentWeekId), updatedWeekData);\r\n            updateWeekData(updatedWeekData);\r\n\r\n        } catch (error) {\r\n            console.error('Error dropping shift:', error);\r\n        } finally {\r\n            setIsProcessing(false);\r\n        }\r\n    };\r\n\r\n    const handleDragOver = (e: React.DragEvent) => { e.preventDefault(); e.currentTarget.classList.add('bg-blue-500/10', 'border-blue-400/50'); };\r\n    const handleDragLeave = (e: React.DragEvent) => { e.currentTarget.classList.remove('bg-blue-500/10', 'border-blue-400/50'); };\r\n    const handleEditShift = (shift: any) => { setEditingShift(shift); setSelectedDateForNew(null); setIsModalOpen(true); };\r\n    const handleColumnClick = (e: React.MouseEvent, dateIso: string) => { if (e.target === e.currentTarget) handleOpenNew(dateIso); };\r\n\r\n    const onSaveAll = () => saveWeek(franchiseId, currentWeekId, weekData as WeekData);\r\n\r\n    const handleAuditoria = async () => {\r\n        if (!weekData?.shifts || weekData.shifts.length === 0) {\r\n            alert(\"El cuadrante est√° vac√≠o. A√±ade turnos antes de auditar.\");\r\n            return;\r\n        }\r\n        setIsAuditing(true);\r\n        setSheriffResult(null);\r\n        try {\r\n            const result = await validateWeeklySchedule(weekData.shifts);\r\n            if (result) {\r\n                setSheriffResult(result);\r\n            } else {\r\n                alert(\"El Sheriff no ha podido validar el cuadrante. Int√©ntalo de nuevo.\");\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Error en auditor√≠a:\", error);\r\n            alert(\"Error de conexi√≥n con el Sheriff.\");\r\n        } finally {\r\n            setIsAuditing(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"flex flex-col h-full bg-gradient-to-br from-slate-50 to-indigo-50/30 font-sans text-slate-900 overflow-hidden relative selection:bg-indigo-100 selection:text-indigo-900\">\r\n            {/* Background Texture */}\r\n            <div className=\"absolute inset-0 opacity-[0.03] pointer-events-none bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]\" />\r\n\r\n            {/* Inline Intelligence Injection Points are in the Day Headers below */}\r\n\r\n            {/* SHERIFF RESULT OVERLAY */}\r\n            {sheriffResult && (\r\n                <div className=\"absolute top-16 right-4 z-50 w-80 animate-in slide-in-from-right-10 fade-in duration-300\">\r\n                    <div className={`\r\n                        p-4 rounded-xl shadow-2xl border backdrop-blur-md\r\n                        ${sheriffResult.status === 'optimal'\r\n                            ? 'bg-emerald-50/90 border-emerald-200 text-emerald-900'\r\n                            : sheriffResult.status === 'critical'\r\n                                ? 'bg-rose-50/90 border-rose-200 text-rose-900'\r\n                                : 'bg-amber-50/90 border-amber-200 text-amber-900'\r\n                        }\r\n                    `}>\r\n                        <div className=\"flex justify-between items-start mb-2\">\r\n                            <div className=\"flex items-center gap-2\">\r\n                                {sheriffResult.status === 'optimal'\r\n                                    ? <ShieldCheck className=\"w-6 h-6 text-emerald-600\" />\r\n                                    : <AlertTriangle className=\"w-6 h-6\" />\r\n                                }\r\n                                <div>\r\n                                    <h3 className=\"font-black text-sm uppercase tracking-wider\">Reporte del Sheriff</h3>\r\n                                    <span className=\"text-xs font-bold opacity-80\">Puntuaci√≥n: {sheriffResult.score}/100</span>\r\n                                </div>\r\n                            </div>\r\n                            <button onClick={() => setSheriffResult(null)} className=\"opacity-50 hover:opacity-100\" title=\"Cerrar reporte\">\r\n                                <XCircle className=\"w-5 h-5\" />\r\n                            </button>\r\n                        </div>\r\n\r\n                        <p className=\"text-xs font-medium mb-3 leading-relaxed\">\r\n                            &quot;{sheriffResult.feedback}&quot;\r\n                        </p>\r\n\r\n                        {sheriffResult.missingCoverage.length > 0 && (\r\n                            <div className=\"bg-white/50 rounded-lg p-2 text-[10px] font-mono mb-2\">\r\n                                <strong className=\"block mb-1 opacity-70\">ALERTAS DE COBERTURA:</strong>\r\n                                <ul className=\"list-disc pl-4 space-y-0.5\">\r\n                                    {sheriffResult.missingCoverage.map((item, i) => (\r\n                                        <li key={i}>{item}</li>\r\n                                    ))}\r\n                                </ul>\r\n                            </div>\r\n                        )}\r\n\r\n                        {/* AUTO-FIX ACTION */}\r\n                        {sheriffResult.status !== 'optimal' && (\r\n                            <button\r\n                                onClick={handleAutoFix}\r\n                                disabled={isFixing}\r\n                                className=\"w-full mt-2 bg-indigo-600 hover:bg-indigo-700 text-white py-1.5 rounded-lg text-xs font-bold shadow-md active:scale-95 transition-all flex items-center justify-center gap-2\"\r\n                            >\r\n                                {isFixing ? (\r\n                                    <>\r\n                                        <div className=\"animate-spin w-3 h-3 border-2 border-white/30 border-t-white rounded-full\" />\r\n                                        Generando Soluci√≥n...\r\n                                    </>\r\n                                ) : (\r\n                                    <>\r\n                                        <Wand2 className=\"w-3 h-3\" />\r\n                                        Corregir con IA\r\n                                    </>\r\n                                )}\r\n                            </button>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            {/* --- HEADER --- */}\r\n            <div className=\"flex items-center justify-between p-2 border-b border-white/50 bg-white/60 backdrop-blur-xl sticky top-0 z-30 shadow-sm supports-[backdrop-filter]:bg-white/40 h-14\">\r\n                <div className=\"flex items-center gap-3\">\r\n                    <h2 className=\"text-lg font-black text-slate-900 flex items-center tracking-tight\">\r\n                        <span className=\"bg-gradient-to-r from-indigo-900 to-slate-800 bg-clip-text text-transparent mr-2\">\r\n                            {(() => {\r\n                                const d = new Date(referenceDate);\r\n                                const month = d.toLocaleDateString('es-ES', { month: 'long' });\r\n                                const year = d.getFullYear();\r\n                                return <span className=\"capitalize\">{month} <span className=\"text-slate-400 font-light text-base\">{year}</span></span>;\r\n                            })()}\r\n                        </span>\r\n                        <span className=\"px-2 py-0.5 rounded-full bg-white/50 text-slate-500 text-[10px] font-bold border border-slate-200/60 shadow-sm backdrop-blur-sm\">\r\n                            S{getWeekIdFromDate(new Date(referenceDate)).split('_')[1]}\r\n                        </span>\r\n                    </h2>\r\n                    <div className=\"flex gap-1 bg-slate-100/50 p-0.5 rounded-lg border border-slate-200/50\">\r\n                        <button onClick={() => changeWeek(-1)} aria-label=\"Semana anterior\" className=\"p-1 rounded-md hover:bg-white text-slate-400 hover:text-indigo-600 transition-all shadow-sm hover:shadow-md active:scale-95\">\r\n                            <ChevronLeft className=\"w-4 h-4\" />\r\n                        </button>\r\n                        <button onClick={() => changeWeek(1)} aria-label=\"Semana siguiente\" className=\"p-1 rounded-md hover:bg-white text-slate-400 hover:text-indigo-600 transition-all shadow-sm hover:shadow-md active:scale-95\">\r\n                            <ChevronRight className=\"w-4 h-4\" />\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n\r\n                <div className=\"flex items-center gap-1.5\">\r\n                    {/* VIEW MODE TOGGLES */}\r\n                    <div className=\"bg-white p-1 rounded-lg border-2 border-slate-200 dark:border-slate-700 flex gap-0.5 mr-2 shadow-sm scale-90 origin-right\">\r\n                        <button\r\n                            onClick={() => setViewMode('prime')}\r\n                            className={`group relative px-3 py-1.5 rounded-md text-[10px] font-bold transition-all duration-300 flex items-center gap-1.5 overflow-hidden ${viewMode === 'prime'\r\n                                ? 'bg-gradient-to-br from-amber-500 to-orange-600 text-white shadow-lg shadow-amber-500/30'\r\n                                : 'bg-slate-50 dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 hover:shadow-md'\r\n                                }`}\r\n                        >\r\n                            <div className=\"relative z-10 flex items-center gap-1.5\">\r\n                                <Filter className={`w-3 h-3 transition-transform group-hover:scale-110 ${viewMode === 'prime' ? 'text-white' : 'text-amber-500'}`} />\r\n                                <div className=\"flex flex-col items-start leading-none\">\r\n                                    <span className={`tracking-wide font-black ${viewMode === 'prime' ? 'text-white' : 'text-slate-700 dark:text-slate-200'}`}>PRIME</span>\r\n                                </div>\r\n                            </div>\r\n                            {viewMode === 'prime' && (\r\n                                <div className=\"absolute inset-0 bg-gradient-to-r from-white/0 via-white/20 to-white/0 animate-shimmer\" />\r\n                            )}\r\n                        </button>\r\n                        <button\r\n                            onClick={() => setViewMode('full')}\r\n                            className={`px-3 py-1.5 rounded-md text-[10px] font-bold tracking-wider transition-all duration-300 ${viewMode === 'full'\r\n                                ? 'bg-indigo-600 text-white shadow-md shadow-indigo-500/20'\r\n                                : 'bg-slate-50 dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700'\r\n                                }`}\r\n                        >\r\n                            TODO EL D√çA\r\n                        </button>\r\n                    </div>\r\n\r\n                    {!isMobile && (\r\n                        <>\r\n                            {/* Rider Filter Selector */}\r\n                            <div className=\"flex items-center gap-2 mr-2\">\r\n                                <select\r\n                                    value={selectedRiderId || ''}\r\n                                    onChange={(e) => setSelectedRiderId(e.target.value || null)}\r\n                                    className=\"px-2 py-1 bg-white border border-slate-200 rounded-md text-[10px] font-bold text-slate-700 hover:border-slate-300 focus:outline-none focus:ring-1 focus:ring-indigo-500 shadow-sm\"\r\n                                    aria-label=\"Filtrar por rider\"\r\n                                >\r\n                                    <option value=\"\">üèçÔ∏è Riders</option>\r\n                                    {riders?.map((rider) => (\r\n                                        <option key={rider.id} value={rider.id}>\r\n                                            {rider.fullName || rider.id}\r\n                                        </option>\r\n                                    ))}\r\n                                </select>\r\n                                {/* Color Legend - Only show riders that exist */}\r\n                                {selectedRiderId === null && riders && riders.length > 0 && (\r\n                                    <div className=\"flex items-center gap-1 px-2 py-1 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-md shadow-sm\">\r\n                                        <span className=\"text-[9px] text-slate-400 dark:text-slate-400 font-bold uppercase tracking-wider\">Riders:</span>\r\n                                        {riders.map((rider) => {\r\n                                            const color = riderColorMap.get(rider.id);\r\n                                            return (\r\n                                                <div\r\n                                                    key={rider.id}\r\n                                                    className={`w-2 h-2 rounded-full ${color?.bg} border ${color?.border} shadow-sm transition-transform hover:scale-125 cursor-help`}\r\n                                                    title={rider.fullName || rider.id}\r\n                                                />\r\n                                            );\r\n                                        })}\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n                            {!readOnly && (\r\n                                <>\r\n                                    <button onClick={onSaveAll} disabled={isSaving} className=\"flex items-center gap-1.5 px-3 py-1.5 bg-slate-900 hover:bg-slate-800 text-white rounded-md transition-all disabled:opacity-50 text-[10px] font-bold shadow-sm hover:shadow-md active:scale-95 ring-1 ring-white/10\">\r\n                                        <Save className=\"w-3 h-3\" />\r\n                                        {isSaving ? 'Guardando...' : 'Guardar'}\r\n                                    </button>\r\n                                    <button\r\n                                        onClick={handleAuditoria}\r\n                                        disabled={isAuditing || isSaving}\r\n                                        className={`\r\n                                            flex items-center gap-1.5 px-3 py-1.5 rounded-md transition-all text-[10px] font-bold shadow-sm hover:shadow-md active:scale-95 border backdrop-blur-sm\r\n                                            ${sheriffResult ? (sheriffResult.status === 'optimal' ? 'bg-emerald-50/80 text-emerald-700 border-emerald-200' : 'bg-amber-50/80 text-amber-700 border-amber-200') : 'bg-white/80 text-slate-600 border-slate-200 hover:bg-slate-50'}\r\n                                        `}\r\n                                    >\r\n                                        {isAuditing ? <div className=\"animate-spin w-3 h-3 border-2 border-indigo-500 border-t-transparent rounded-full\" /> : <BadgeCheck className=\"w-3 h-3\" />}\r\n                                        {sheriffResult ? `Sheriff: ${sheriffResult.score}/100` : 'Auditar'}\r\n                                    </button>\r\n\r\n                                    {/* Tools Group */}\r\n                                    <div className=\"flex items-center gap-1 p-0.5 bg-slate-100 rounded-lg border border-slate-200\">\r\n                                        <button onClick={() => setIsQuickFillOpen(true)} className=\"flex items-center gap-1.5 px-2 py-1 hover:bg-white text-slate-600 hover:text-indigo-600 rounded-md transition-all disabled:opacity-50 text-[10px] font-bold active:scale-95\">\r\n                                            <Zap className=\"w-3 h-3\" />\r\n                                            <span className=\"hidden xl:inline\">Relleno</span>\r\n                                        </button>\r\n                                        <div className=\"w-px h-3 bg-slate-300 mx-0.5\" />\r\n                                        <button\r\n                                            onClick={() => setShowGenModal(true)}\r\n                                            className=\"flex items-center gap-1.5 px-2 py-1 hover:bg-white text-slate-600 hover:text-violet-600 rounded-md transition-all disabled:opacity-50 text-[10px] font-bold active:scale-95\"\r\n                                        >\r\n                                            <Sparkles className=\"w-3 h-3\" />\r\n                                            <span className=\"hidden xl:inline\">IA M√°gica</span>\r\n                                        </button>\r\n                                    </div>\r\n                                </>\r\n                            )}\r\n                        </>\r\n                    )}\r\n                    {isMobile && !readOnly && (\r\n                        <button onClick={() => setIsQuickFillOpen(true)} aria-label=\"Auto-Rellenar\" className=\"p-2 bg-indigo-600 text-white rounded-lg shadow-md\">\r\n                            <Zap className=\"w-5 h-5\" />\r\n                        </button>\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            {loading || isProcessing ? (\r\n                <div className=\"flex-1 flex items-center justify-center text-slate-400 bg-slate-50\">\r\n                    <div className=\"animate-spin mr-3 h-5 w-5 border-2 border-indigo-500 border-t-transparent rounded-full\" />\r\n                    <span className=\"font-medium text-slate-500\">Cargando semana...</span>\r\n                </div>\r\n            ) : (\r\n                <div className=\"flex-1 overflow-hidden bg-slate-50 relative flex flex-col\">\r\n                    {isMobile ? (\r\n                        <div className=\"flex-1 overflow-auto p-4\">\r\n                            <MobileAgendaView\r\n                                days={days}\r\n                                visualEvents={visualEvents}\r\n                                intelByDay={intelByDay}\r\n                                onEditShift={handleEditShift}\r\n                                onDeleteShift={handleDeleteShift}\r\n                                onAddShift={handleOpenNew}\r\n                            />\r\n                        </div>\r\n                    ) : (\r\n                        <div className=\"flex-1 flex flex-col bg-white overflow-hidden rounded-tl-2xl border-l border-slate-200/50 shadow-xl shadow-slate-200/30\">\r\n                            {/* V13 GANTT HEADER (Days) - Glassmorphic */}\r\n                            <div className=\"flex bg-white/80 border-b border-slate-200/80 sticky top-0 z-40 backdrop-blur-xl supports-[backdrop-filter]:bg-white/60\">\r\n                                <div className=\"w-40 shrink-0 border-r border-slate-200 p-2 flex items-center justify-between\">\r\n                                    <span className=\"text-[10px] font-black text-slate-400 uppercase tracking-widest pl-2\">RIDER</span>\r\n                                    <Filter className=\"w-3 h-3 text-slate-300\" />\r\n                                </div>\r\n                                <div className=\"flex-1 grid grid-cols-7 divide-x divide-slate-200\">\r\n                                    {days.map((day, i) => {\r\n                                        const isToday = new Date().toISOString().split('T')[0] === day.isoDate;\r\n                                        const intel = intelByDay[day.isoDate] || [];\r\n                                        const demand = getDayDemandLevel(day.isoDate, intel);\r\n\r\n                                        return (\r\n                                            <div key={i} className={cn(\r\n                                                \"p-2 flex flex-col gap-1 transition-all\",\r\n                                                isToday ? \"bg-indigo-50/50\" : \"bg-white/80\",\r\n                                                demand === 'critical' ? \"border-b-2 border-b-rose-500\" :\r\n                                                    demand === 'warning' ? \"border-b-2 border-b-amber-500\" : \"\"\r\n                                            )}>\r\n                                                <div className=\"flex items-center justify-between\">\r\n                                                    <span className={cn(\"text-[9px] font-bold uppercase tracking-tighter\", isToday ? \"text-indigo-600\" : \"text-slate-400\")}>\r\n                                                        {day.shortLabel}\r\n                                                    </span>\r\n                                                    <span className={cn(\"text-xs font-black\", isToday ? \"text-indigo-700\" : \"text-slate-800\")}>\r\n                                                        {day.label.split(' ')[1]}\r\n                                                    </span>\r\n                                                </div>\r\n                                                {/* Mini Timeline Grid for Day Header */}\r\n                                                <div className=\"flex justify-between px-0.5 opacity-30\">\r\n                                                    {[8, 12, 16, 20, 24].map(h => (\r\n                                                        <span key={h} className=\"text-[7px] font-black font-mono\">{h}</span>\r\n                                                    ))}\r\n                                                </div>\r\n                                            </div>\r\n                                        );\r\n                                    })}\r\n                                </div>\r\n                            </div>\r\n\r\n                            {/* V13 GANTT ROWS - With improved spacing and separation */}\r\n                            <div className=\"flex-1 overflow-y-auto no-scrollbar bg-slate-50/50\">\r\n                                {ridersGrid.map((row, rIdx) => (\r\n                                    <div key={row.id} className={cn(\r\n                                        \"flex border-b border-slate-100/80 items-center transition-all duration-200 group/row h-[38px]\",\r\n                                        rIdx % 2 === 0 ? \"bg-white\" : \"bg-slate-50/40\"\r\n                                    )}>\r\n                                        {/* Rider Info Side - Sticky Glass */}\r\n                                        <div className=\"w-40 shrink-0 border-r border-slate-100/80 p-2 flex items-center gap-2 sticky left-0 z-30 transition-colors backdrop-blur-md supports-[backdrop-filter]:bg-white/80\">\r\n                                            <div className=\"relative\">\r\n                                                <div className={cn(\r\n                                                    \"w-6 h-6 rounded-full flex items-center justify-center text-[9px] font-black border-2 border-white shadow-sm ring-1 ring-slate-100 transition-transform group-hover/row:scale-105\",\r\n                                                    riderColorMap.get(row.id)?.bg || 'bg-slate-200'\r\n                                                )}>\r\n                                                    {getRiderInitials(row.fullName)}\r\n                                                </div>\r\n                                                {row.status === 'active' && (\r\n                                                    <div className=\"absolute -bottom-0.5 -right-0.5 w-2 h-2 bg-emerald-500 border border-white rounded-full shadow-sm\" />\r\n                                                )}\r\n                                            </div>\r\n                                            <div className=\"min-w-0 flex flex-col\">\r\n                                                <div className=\"text-[10px] font-bold text-slate-700 truncate group-hover/row:text-indigo-600 transition-colors leading-tight\">{row.fullName}</div>\r\n                                                {/* Hidden status text to save space, relies on dot */}\r\n                                            </div>\r\n                                        </div>\r\n\r\n                                        {/* Days Grid - Subtle grid lines */}\r\n                                        <div className=\"flex-1 grid grid-cols-7 divide-x divide-slate-100/80 h-full\">\r\n                                            {row.days.map((day, dIdx) => (\r\n                                                <div\r\n                                                    key={dIdx}\r\n                                                    className=\"h-12 relative flex items-center px-1 overflow-hidden cursor-crosshair group/cell\"\r\n                                                    onClick={(e) => handleColumnClick(e, day.isoDate)}\r\n                                                    onDragOver={handleDragOver}\r\n                                                    onDragLeave={handleDragLeave}\r\n                                                    onDrop={(e) => handleDrop(e, day)}\r\n                                                >\r\n                                                    {/* Background Timeline Ticks (Subtle dashed) */}\r\n                                                    <div className=\"absolute inset-0 flex justify-between px-0.5 opacity-[0.04] pointer-events-none\">\r\n                                                        {Array.from({ length: 9 }).map((_, i) => (\r\n                                                            <div key={i} className=\"w-[1px] h-full border-r border-dashed border-slate-900\" />\r\n                                                        ))}\r\n                                                    </div>\r\n\r\n                                                    {/* Current Time Indicator (Only today, Only in this day cells) */}\r\n                                                    {new Date().toISOString().split('T')[0] === day.isoDate && (\r\n                                                        <CurrentTimeIndicator startHour={START_HOUR} endHour={END_HOUR} />\r\n                                                    )}\r\n\r\n                                                    {/* Shifts Container */}\r\n                                                    <div className=\"relative w-full h-full flex items-center\">\r\n                                                        {day.shifts.map((ev) => (\r\n                                                            <div\r\n                                                                key={ev.shiftId}\r\n                                                                className=\"absolute\"\r\n                                                                style={getShiftPosition(ev.visualStart, ev.visualEnd)}\r\n                                                            >\r\n                                                                <ShiftPill\r\n                                                                    event={ev}\r\n                                                                    onClick={(e) => { e.stopPropagation(); handleEditShift(ev); }}\r\n                                                                    onDelete={handleDeleteShift}\r\n                                                                    riderColor={riderColorMap.get(row.id)}\r\n                                                                    readOnly={readOnly}\r\n                                                                />\r\n                                                            </div>\r\n                                                        ))}\r\n                                                    </div>\r\n\r\n                                                    {/* Add Trigger (Hidden until hover) */}\r\n                                                    {!readOnly && (\r\n                                                        <div className=\"absolute inset-0 bg-indigo-500/0 group-hover/cell:bg-indigo-500/[0.03] transition-colors pointer-events-none\" />\r\n                                                    )}\r\n                                                </div>\r\n                                            ))}\r\n                                        </div>\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            )}\r\n\r\n            <QuickFillModal\r\n                isOpen={isQuickFillOpen}\r\n                onClose={() => setIsQuickFillOpen(false)}\r\n                onRefresh={refresh}\r\n                franchiseId={toFranchiseId(franchiseId)}\r\n                onCreateShifts={handleQuickFillCreate as any}\r\n                riders={riders}\r\n                motos={motos as any}\r\n                weekDays={days}\r\n            />\r\n\r\n            <ShiftModal\r\n                isOpen={isModalOpen}\r\n                onClose={() => setIsModalOpen(false)}\r\n                onSave={handleSaveShift}\r\n                initialData={editingShift}\r\n                riders={riders}\r\n                motos={motos}\r\n                selectedDate={selectedDateForNew || undefined}\r\n                onDelete={handleDeleteShift}\r\n            />\r\n\r\n            <ConfirmationModal\r\n                isOpen={confirmDialog.isOpen}\r\n                onClose={closeConfirm}\r\n                onConfirm={confirmDialog.onConfirm}\r\n                title={confirmDialog.title}\r\n                message={confirmDialog.message}\r\n                isDestructive={confirmDialog.isDestructive}\r\n                confirmText={confirmDialog.confirmText}\r\n            />\r\n\r\n            {/* Generative Scheduling Modal */}\r\n            {showGenModal && (\r\n                <div className=\"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200\">\r\n                    <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden animate-in zoom-in-95 duration-200 border border-indigo-100\">\r\n                        <div className=\"bg-gradient-to-r from-indigo-600 to-violet-600 p-6 text-white relative overflow-hidden\">\r\n                            <div className=\"relative z-10\">\r\n                                <h3 className=\"text-xl font-black flex items-center gap-2\">\r\n                                    <Sparkles className=\"w-6 h-6 text-amber-300\" />\r\n                                    Generador de Horarios IA\r\n                                </h3>\r\n                                <p className=\"text-indigo-100 text-sm mt-1 font-medium\">Describe qu√© necesitas y la IA crear√° el cuadrante.</p>\r\n                            </div>\r\n                            <div className=\"absolute top-0 right-0 p-4 opacity-10\">\r\n                                <Wand2 className=\"w-24 h-24 rotate-12\" />\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"p-6 space-y-4\">\r\n                            <div>\r\n                                <label className=\"block text-xs font-bold uppercase text-slate-500 mb-2\">Instrucci√≥n para la IA</label>\r\n                                <textarea\r\n                                    value={genPrompt}\r\n                                    onChange={(e) => setGenPrompt(e.target.value)}\r\n                                    placeholder=\"Ej: Necesito 4 riders cada noche, y refuerzo el s√°bado. Lunes y Martes solo 2 riders al mediod√≠a...\"\r\n                                    className=\"w-full h-32 p-3 rounded-xl border border-slate-200 text-slate-700 font-medium focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 resize-none bg-slate-50 placeholder:text-slate-400 focus:outline-none\"\r\n                                    autoFocus\r\n                                />\r\n                            </div>\r\n\r\n                            <div className=\"bg-indigo-50 p-3 rounded-lg flex items-start gap-3\">\r\n                                <div className=\"bg-white p-1.5 rounded-full shadow-sm mt-0.5\">\r\n                                    <Wand2 className=\"w-4 h-4 text-indigo-600\" />\r\n                                </div>\r\n                                <p className=\"text-xs text-indigo-800 leading-relaxed font-medium\">\r\n                                    La IA analizar√° tus riders disponibles y crear√° turnos √≥ptimos respetando las reglas de descanso y cobertura.\r\n                                </p>\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"p-4 bg-slate-50 border-t border-slate-100 flex justify-end gap-3\">\r\n                            <button\r\n                                onClick={() => setShowGenModal(false)}\r\n                                className=\"px-4 py-2 text-slate-500 hover:text-slate-700 font-bold text-sm transition-colors\"\r\n                            >\r\n                                Cancelar\r\n                            </button>\r\n                            <button\r\n                                onClick={handleGeneration}\r\n                                disabled={isGenerating || !genPrompt.trim()}\r\n                                className=\"px-5 py-2 bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-500 hover:to-violet-500 text-white rounded-xl font-bold text-sm shadow-lg shadow-indigo-500/30 flex items-center gap-2 transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                            >\r\n                                {isGenerating ? (\r\n                                    <>\r\n                                        <div className=\"animate-spin w-4 h-4 border-2 border-white/30 border-t-white rounded-full\" />\r\n                                        Generando...\r\n                                    </>\r\n                                ) : (\r\n                                    <>\r\n                                        <Sparkles className=\"w-4 h-4\" />\r\n                                        Generar Magia\r\n                                    </>\r\n                                )}\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default WeeklyScheduler;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\operations\\components\\KpiCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\operations\\components\\OperationsTabs.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\operations\\views\\ShiftManagerView.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\operations\\views\\WeeklySummaryView.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":10,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":10,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[507,510],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[507,510],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":11,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":11,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[536,539],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[536,539],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":23,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":23,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1072,1075],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1072,1075],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useMemo, FC } from 'react';\r\nimport { Clock, Users, AlertTriangle, ShieldCheck } from 'lucide-react';\r\nimport WeeklyCalendarGrid from '../WeeklyCalendarGrid'; // Aseg√∫rate de la ruta correcta\r\n// import { useWeeklySchedule } from '../../../hooks/useWeeklySchedule'; // Movido a Dashboard\r\nimport KpiCard from '../components/KpiCard';\r\nimport { calculateWeeklyMetrics } from '../../../utils/operationalMetrics';\r\n\r\ninterface WeeklySummaryViewProps {\r\n    currentDate: Date;\r\n    onSlotClick: (slot: any) => void;\r\n    weekData: any; // Allow full WeekData or partial\r\n    loading?: boolean;\r\n    franchiseId?: string | null;\r\n}\r\n\r\nconst WeeklySummaryView: FC<WeeklySummaryViewProps> = ({ currentDate, onSlotClick, weekData, loading = false }) => {\r\n    // 1. Fetch de Datos (Ahora via Props)\r\n    // const { weekData, loading } = useWeeklySchedule(franchiseId, true, currentDate);\r\n\r\n    // Memoize shifts extraction to stabilize dependencies\r\n    const shifts = useMemo(() => {\r\n        const rawShifts = weekData?.shifts || [];\r\n        return rawShifts.map((s: any) => ({\r\n            ...s,\r\n            id: s.shiftId || s.id,\r\n            riderName: s.riderName || 'Sin asignar',\r\n            day: s.day || (s.startAt ? new Intl.DateTimeFormat('es-ES', { weekday: 'long' }).format(new Date(s.startAt)) : ''),\r\n            startTime: s.startTime || (s.startAt ? new Date(s.startAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : ''),\r\n            endTime: s.endTime || (s.endAt ? new Date(s.endAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '')\r\n        }));\r\n    }, [weekData]);\r\n\r\n    // 2. C√°lculo de M√©tricas en Tiempo Real (Memoizado) üß†\r\n    // Solo se recalcula si 'shifts' cambia.\r\n    const metrics = useMemo(() => calculateWeeklyMetrics(shifts), [shifts]);\r\n\r\n    return (\r\n\r\n        <div className=\"flex flex-col h-full bg-slate-50\">\r\n            {/* PANEL DE CONTROL (KPIs) */}\r\n            <div className=\"grid grid-cols-1 md://grid-cols-2 lg:grid-cols-4 gap-4 p-6 border-b border-slate-200 bg-white sticky top-0 z-10 shadow-sm\">\r\n                <KpiCard\r\n                    title=\"Carga Horaria\"\r\n                    value={`${metrics.totalHours}h`}\r\n                    subtext=\"Volumen total esta semana\"\r\n                    icon={Clock}\r\n                    color=\"indigo\"\r\n                />\r\n                <KpiCard\r\n                    title=\"Fuerza Operativa\"\r\n                    value={metrics.activeRiders}\r\n                    subtext=\"Riders √∫nicos asignados\"\r\n                    icon={Users}\r\n                    color=\"blue\"\r\n                />\r\n                <KpiCard\r\n                    title=\"Turnos Libres\"\r\n                    value={metrics.unassigned}\r\n                    subtext={metrics.unassigned > 0 ? \"‚ö†Ô∏è Requiere asignaci√≥n\" : \"Todo cubierto\"}\r\n                    icon={AlertTriangle}\r\n                    // Sem√°foro visual: Rojo si hay huecos, Gris si est√° limpio\r\n                    color={metrics.unassigned > 0 ? \"rose\" : \"slate\"}\r\n                />\r\n                <KpiCard\r\n                    title=\"Nivel Cobertura\"\r\n                    value={`${metrics.coverage}%`}\r\n                    subtext=\"Eficiencia de planificaci√≥n\"\r\n                    icon={ShieldCheck}\r\n                    // Sem√°foro visual: Verde si > 90%, √Åmbar si > 75%, Rojo si cr√≠tico\r\n                    color={metrics.coverage >= 90 ? \"emerald\" : metrics.coverage >= 75 ? \"amber\" : \"rose\"}\r\n                    // Simulamos una tendencia basada en la cobertura (puedes refinar esto)\r\n                    trend={metrics.coverage >= 95 ? 2.5 : metrics.coverage < 80 ? -5 : 0}\r\n                />\r\n            </div>\r\n\r\n            {/* √ÅREA DE VISUALIZACI√ìN (GRID) */}\r\n            <div className=\"flex-1 p-6 relative flex flex-col min-h-0 overflow-hidden\">\r\n                <div className=\"flex-1 border border-slate-200 rounded-xl overflow-hidden bg-white shadow-sm relative flex flex-col\">\r\n\r\n                    {/* Overlay de Carga */}\r\n                    {loading && (\r\n                        <div className=\"absolute inset-0 bg-white/80 z-20 flex items-center justify-center backdrop-blur-[2px]\">\r\n                            <div className=\"flex flex-col items-center gap-3 animate-in fade-in duration-300\">\r\n                                <div className=\"animate-spin h-8 w-8 border-3 border-indigo-500 rounded-full border-t-transparent shadow-lg shadow-indigo-500/20\" />\r\n                                <span className=\"text-sm font-bold text-slate-500 tracking-wide uppercase\">Analizando operativa...</span>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* Grid Interactivo */}\r\n                    <div className=\"flex-1 overflow-auto custom-scrollbar\">\r\n                        <WeeklyCalendarGrid\r\n                            shifts={shifts}\r\n                            currentDate={currentDate}\r\n                            onSlotClick={onSlotClick}\r\n                            readOnly={true}\r\n                        />\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default WeeklySummaryView;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\rider\\home\\RiderHomeView.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\rider\\home\\components\\SlideToWork.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'handleEnd' and 'handleMove'. Either include them or remove the dependency array.","line":66,"column":8,"nodeType":"ArrayExpression","endLine":66,"endColumn":20,"suggestions":[{"desc":"Update the dependencies array to be: [handleEnd, handleMove, isDragging]","fix":{"range":[2346,2358],"text":"[handleEnd, handleMove, isDragging]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useRef, useEffect } from 'react';\r\nimport { ChevronRight, Zap } from 'lucide-react';\r\n\r\ninterface SlideToWorkProps {\r\n    onComplete: () => void;\r\n    label?: string;\r\n    disabled?: boolean;\r\n}\r\n\r\nexport const SlideToWork: React.FC<SlideToWorkProps> = ({\r\n    onComplete,\r\n    label = \"Desliza para Iniciar\",\r\n    disabled = false\r\n}) => {\r\n    const [isDragging, setIsDragging] = useState(false);\r\n    const [position, setPosition] = useState(0);\r\n    const containerRef = useRef<HTMLDivElement>(null);\r\n    const [completed, setCompleted] = useState(false);\r\n\r\n    const handleStart = (_e: React.MouseEvent | React.TouchEvent) => {\r\n        if (disabled || completed) return;\r\n        setIsDragging(true);\r\n    };\r\n\r\n    const handleMove = (e: MouseEvent | TouchEvent) => {\r\n        if (!isDragging || !containerRef.current || completed) return;\r\n\r\n        const containerRect = containerRef.current.getBoundingClientRect();\r\n        const clientX = 'touches' in e ? e.touches[0].clientX : (e as MouseEvent).clientX;\r\n        const x = clientX - containerRect.left - 30; // 30 is half width of handle\r\n\r\n        const maxPos = containerRect.width - 64; // handle width (60) + padding (4)\r\n        const newPos = Math.max(0, Math.min(x, maxPos));\r\n\r\n        setPosition(newPos);\r\n\r\n        if (newPos >= maxPos * 0.95) {\r\n            setCompleted(true);\r\n            setIsDragging(false);\r\n            setPosition(maxPos);\r\n            onComplete();\r\n        }\r\n    };\r\n\r\n    const handleEnd = () => {\r\n        if (completed) return;\r\n        setIsDragging(false);\r\n        if (position < (containerRef.current?.getBoundingClientRect().width || 0) * 0.9) {\r\n            setPosition(0);\r\n        }\r\n    };\r\n\r\n    useEffect(() => {\r\n        if (isDragging) {\r\n            window.addEventListener('mousemove', handleMove);\r\n            window.addEventListener('mouseup', handleEnd);\r\n            window.addEventListener('touchmove', handleMove);\r\n            window.addEventListener('touchend', handleEnd);\r\n        }\r\n        return () => {\r\n            window.removeEventListener('mousemove', handleMove);\r\n            window.removeEventListener('mouseup', handleEnd);\r\n            window.removeEventListener('touchmove', handleMove);\r\n            window.removeEventListener('touchend', handleEnd);\r\n        };\r\n    }, [isDragging]);\r\n\r\n    return (\r\n        <div\r\n            ref={containerRef}\r\n            className={`\r\n                relative h-20 w-full rounded-full p-1.5 transition-all duration-500 overflow-hidden\r\n                ${completed\r\n                    ? 'bg-emerald-500 neon-glow-emerald'\r\n                    : disabled\r\n                        ? 'bg-slate-900/40 opacity-50 gray-scale'\r\n                        : 'bg-slate-900/60 border border-white/10'}\r\n            `}\r\n        >\r\n            {/* Background Track Text */}\r\n            <div className={`\r\n                absolute inset-0 flex items-center justify-center pointer-events-none transition-opacity duration-300\r\n                ${completed || isDragging ? 'opacity-0' : 'opacity-40'}\r\n            `}>\r\n                <span className=\"text-[11px] font-black uppercase tracking-[0.4em] text-white\">\r\n                    {label}\r\n                </span>\r\n            </div>\r\n\r\n            {/* Glowing Path */}\r\n            <div\r\n                className=\"absolute left-1.5 top-1.5 bottom-1.5 bg-emerald-500/20 rounded-full transition-all duration-100\"\r\n                style={{ width: `${position + 60}px` }}\r\n            />\r\n\r\n            {/* Handle */}\r\n            <div\r\n                onMouseDown={handleStart}\r\n                onTouchStart={handleStart}\r\n                className={`\r\n                    absolute top-1.5 bottom-1.5 w-16 rounded-full flex items-center justify-center transition-transform duration-100 cursor-grab active:cursor-grabbing select-none\r\n                    ${completed\r\n                        ? 'bg-white text-emerald-600'\r\n                        : 'bg-emerald-500 text-white shadow-[0_0_20px_rgba(16,185,129,0.5)]'}\r\n                `}\r\n                style={{ transform: `translateX(${position}px)` }}\r\n            >\r\n                {completed ? (\r\n                    <Zap size={24} className=\"fill-current animate-pulse\" />\r\n                ) : (\r\n                    <ChevronRight size={28} strokeWidth={3} className={isDragging ? 'animate-pulse' : ''} />\r\n                )}\r\n            </div>\r\n\r\n            {/* Completion Success Text */}\r\n            {completed && (\r\n                <div className=\"absolute inset-0 flex items-center justify-center animate-in fade-in zoom-in duration-500\">\r\n                    <span className=\"text-xl font-black text-white uppercase tracking-[0.2em] italic\">\r\n                        SYSTEM CONNECTED\r\n                    </span>\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\rider\\home\\modals\\IncidentReportModal.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":8,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":8,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[312,315],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[312,315],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\r\nimport { X, AlertTriangle, AlertOctagon, Clock, Info, Camera, Send } from 'lucide-react';\r\nimport { cn } from '../../../../lib/utils'; // Adjust path if needed\r\n\r\ninterface IncidentReportModalProps {\r\n    isOpen: boolean;\r\n    onClose: () => void;\r\n    onSubmit: (data: any) => Promise<void>;\r\n}\r\n\r\ntype IncidentType = 'accident' | 'breakdown' | 'traffic' | 'other';\r\n\r\nexport const IncidentReportModal: React.FC<IncidentReportModalProps> = ({ isOpen, onClose, onSubmit }) => {\r\n    const [type, setType] = useState<IncidentType>('breakdown');\r\n    const [isUrgent, setIsUrgent] = useState(false);\r\n    const [description, setDescription] = useState('');\r\n    const [isSubmitting, setIsSubmitting] = useState(false);\r\n\r\n    if (!isOpen) return null;\r\n\r\n    const handleSubmit = async (e: React.FormEvent) => {\r\n        e.preventDefault();\r\n        setIsSubmitting(true);\r\n        try {\r\n            await onSubmit({ type, isUrgent, description });\r\n        } catch (error) {\r\n            console.error(error);\r\n        } finally {\r\n            setIsSubmitting(false);\r\n            onClose();\r\n        }\r\n    };\r\n\r\n    const getTypeIcon = (t: IncidentType) => {\r\n        switch (t) {\r\n            case 'accident': return <AlertOctagon size={24} />;\r\n            case 'breakdown': return <AlertTriangle size={24} />;\r\n            case 'traffic': return <Clock size={24} />;\r\n            case 'other': return <Info size={24} />;\r\n        }\r\n    };\r\n\r\n    const getTypeLabel = (t: IncidentType) => {\r\n        switch (t) {\r\n            case 'accident': return 'Accidente';\r\n            case 'breakdown': return 'Aver√≠a Mec√°nica';\r\n            case 'traffic': return 'Retraso / Tr√°fico';\r\n            case 'other': return 'Otro';\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-in fade-in duration-200\">\r\n            <div className=\"w-full max-w-md bg-white dark:bg-slate-900 rounded-3xl shadow-2xl overflow-hidden border border-slate-100 dark:border-slate-800 animate-in zoom-in-95 duration-200\">\r\n\r\n                {/* HEADER */}\r\n                <div className={cn(\r\n                    \"relative p-6 text-white transition-colors duration-300\",\r\n                    isUrgent ? \"bg-red-600\" : \"bg-slate-800\"\r\n                )}>\r\n                    <button\r\n                        onClick={onClose}\r\n                        className=\"absolute top-4 right-4 p-2 bg-white/10 hover:bg-white/20 rounded-full transition-colors\"\r\n                    >\r\n                        <X size={20} />\r\n                    </button>\r\n                    <div className=\"flex items-center gap-3 mb-1\">\r\n                        <div className=\"p-2 bg-white/20 rounded-xl\">\r\n                            <AlertTriangle size={24} />\r\n                        </div>\r\n                        <h2 className=\"text-xl font-black tracking-tight\">Reportar Incidencia</h2>\r\n                    </div>\r\n                    <p className=\"text-white/80 text-sm ml-1\">Notifica al centro de control inmediatamente.</p>\r\n                </div>\r\n\r\n                {/* BODY */}\r\n                <form onSubmit={handleSubmit} className=\"p-6 space-y-6\">\r\n\r\n                    {/* URGENCY TOGGLE */}\r\n                    <div className=\"flex items-center justify-between bg-slate-50 dark:bg-slate-800/50 p-4 rounded-xl border border-slate-100 dark:border-slate-700\">\r\n                        <div>\r\n                            <span className=\"font-bold text-slate-700 dark:text-slate-200 block\">¬øEs urgente?</span>\r\n                            <span className=\"text-xs text-slate-400\">Marcar si requieres asistencia inmediata.</span>\r\n                        </div>\r\n                        <button\r\n                            type=\"button\"\r\n                            onClick={() => setIsUrgent(!isUrgent)}\r\n                            className={cn(\r\n                                \"w-14 h-8 rounded-full p-1 transition-all duration-300 relative\",\r\n                                isUrgent ? \"bg-red-500\" : \"bg-slate-300 dark:bg-slate-600\"\r\n                            )}\r\n                        >\r\n                            <div className={cn(\r\n                                \"w-6 h-6 bg-white rounded-full shadow-sm transition-all duration-300\",\r\n                                isUrgent ? \"translate-x-6\" : \"translate-x-0\"\r\n                            )} />\r\n                        </button>\r\n                    </div>\r\n\r\n                    {/* TYPE SELECTION */}\r\n                    <div className=\"grid grid-cols-2 gap-3\">\r\n                        {(['breakdown', 'accident', 'traffic', 'other'] as IncidentType[]).map((t) => (\r\n                            <button\r\n                                key={t}\r\n                                type=\"button\"\r\n                                onClick={() => setType(t)}\r\n                                className={cn(\r\n                                    \"flex flex-col items-center gap-2 p-4 rounded-xl border-2 transition-all\",\r\n                                    type === t\r\n                                        ? (isUrgent ? \"border-red-500 bg-red-50 text-red-700\" : \"border-slate-800 bg-slate-50 text-slate-800\")\r\n                                        : \"border-transparent bg-white shadow-sm hover:bg-slate-50 text-slate-400\"\r\n                                )}\r\n                            >\r\n                                {getTypeIcon(t)}\r\n                                <span className=\"text-xs font-bold\">{getTypeLabel(t)}</span>\r\n                            </button>\r\n                        ))}\r\n                    </div>\r\n\r\n                    {/* DESCRIPTION */}\r\n                    <div>\r\n                        <label className=\"block text-xs font-bold uppercase text-slate-400 mb-2\">Descripci√≥n</label>\r\n                        <textarea\r\n                            value={description}\r\n                            onChange={(e) => setDescription(e.target.value)}\r\n                            placeholder=\"Describe brevemente qu√© ha pasado...\"\r\n                            className=\"w-full h-24 rounded-xl border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 p-3 text-sm focus:ring-2 focus:ring-slate-400 outline-none resize-none transition-all\"\r\n                            required\r\n                        />\r\n                    </div>\r\n\r\n                    {/* PHOTO PLACEHOLDER */}\r\n                    <div className=\"border-2 border-dashed border-slate-200 dark:border-slate-700 rounded-xl p-4 flex flex-col items-center justify-center text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors cursor-pointer group\">\r\n                        <Camera size={24} className=\"mb-2 group-hover:scale-110 transition-transform\" />\r\n                        <span className=\"text-xs font-bold\">Adjuntar foto (Opcional)</span>\r\n                    </div>\r\n\r\n                    {/* SUBMIT BUTTON */}\r\n                    <button\r\n                        type=\"submit\"\r\n                        disabled={isSubmitting}\r\n                        className={cn(\r\n                            \"w-full py-4 rounded-xl font-black text-white shadow-lg active:scale-[0.98] transition-all flex items-center justify-center gap-2\",\r\n                            isUrgent\r\n                                ? \"bg-red-600 hover:bg-red-700 shadow-red-500/30\"\r\n                                : \"bg-slate-900 hover:bg-slate-800 shadow-slate-900/30\"\r\n                        )}\r\n                    >\r\n                        {isSubmitting ? (\r\n                            <span className=\"animate-pulse\">Enviando...</span>\r\n                        ) : (\r\n                            <>\r\n                                <Send size={18} />\r\n                                Enviar Reporte\r\n                            </>\r\n                        )}\r\n                    </button>\r\n                </form>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\rider\\home\\modals\\VehicleChecklistModal.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":8,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":8,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[290,293],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[290,293],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\rider\\home\\modals\\VehicleChecklistModal.tsx:28:13\n  26 |     useEffect(() => {\n  27 |         if (isOpen) {\n> 28 |             setCheckedItems([]);\n     |             ^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  29 |             setIsSuccess(false);\n  30 |         }\n  31 |     }, [isOpen]);","line":28,"column":13,"nodeType":null,"endLine":28,"endColumn":28},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":54,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":54,"endColumn":23}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { X, CheckCircle2, Check } from 'lucide-react';\r\nimport { cn } from '../../../../lib/utils'; // Adjust path if needed\r\n\r\ninterface VehicleChecklistModalProps {\r\n    isOpen: boolean;\r\n    onClose: () => void;\r\n    onSubmit: (data: any) => Promise<void>;\r\n}\r\n\r\nconst CHECKLIST_ITEMS = [\r\n    { id: 'lights', label: 'Luces y Se√±alizaci√≥n' },\r\n    { id: 'tires', label: 'Presi√≥n de Neum√°ticos' },\r\n    { id: 'brakes', label: 'Frenos (Delantero/Trasero)' },\r\n    { id: 'fuel', label: 'Nivel de Gasolina / Bater√≠a' },\r\n    { id: 'mirrors', label: 'Espejos Retrovisores' },\r\n    { id: 'helmet', label: 'Casco y Equipamiento' },\r\n    { id: 'docs', label: 'Documentaci√≥n del Veh√≠culo' },\r\n];\r\n\r\nexport const VehicleChecklistModal: React.FC<VehicleChecklistModalProps> = ({ isOpen, onClose, onSubmit }) => {\r\n    const [checkedItems, setCheckedItems] = useState<string[]>([]);\r\n    const [isSuccess, setIsSuccess] = useState(false);\r\n\r\n    // Reset state on open\r\n    useEffect(() => {\r\n        if (isOpen) {\r\n            setCheckedItems([]);\r\n            setIsSuccess(false);\r\n        }\r\n    }, [isOpen]);\r\n\r\n    if (!isOpen) return null;\r\n\r\n    const toggleItem = (id: string) => {\r\n        if (checkedItems.includes(id)) {\r\n            setCheckedItems(prev => prev.filter(i => i !== id));\r\n        } else {\r\n            setCheckedItems(prev => [...prev, id]);\r\n        }\r\n    };\r\n\r\n    const allChecked = CHECKLIST_ITEMS.every(item => checkedItems.includes(item.id));\r\n    const progress = (checkedItems.length / CHECKLIST_ITEMS.length) * 100;\r\n\r\n    const handleConfirm = async () => {\r\n        if (!allChecked) return;\r\n        setIsSuccess(true);\r\n        try {\r\n            await onSubmit({ items: checkedItems, timestamp: new Date() });\r\n            setTimeout(() => {\r\n                onClose();\r\n            }, 1500); // Keep success message visible for a moment\r\n        } catch (error) {\r\n            setIsSuccess(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-in fade-in duration-200\">\r\n            <div className=\"w-full max-w-md bg-white dark:bg-slate-900 rounded-3xl shadow-2xl overflow-hidden border border-slate-100 dark:border-slate-800 animate-in zoom-in-95 duration-200 relative\">\r\n\r\n                {/* SUCCESS OVERLAY */}\r\n                {isSuccess && (\r\n                    <div className=\"absolute inset-0 z-10 bg-emerald-500 flex flex-col items-center justify-center text-white animate-in fade-in duration-300\">\r\n                        <div className=\"bg-white/20 p-6 rounded-full mb-6 animate-bounce\">\r\n                            <CheckCircle2 size={64} />\r\n                        </div>\r\n                        <h2 className=\"text-3xl font-black mb-2\">¬°Todo Listo!</h2>\r\n                        <p className=\"text-emerald-100 font-medium\">Veh√≠culo verificado correctamente.</p>\r\n                    </div>\r\n                )}\r\n\r\n                {/* HEADER */}\r\n                <div className=\"p-6 bg-slate-50 dark:bg-slate-800 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center\">\r\n                    <div>\r\n                        <h2 className=\"text-xl font-black text-slate-800 dark:text-white mb-1\">Verificaci√≥n Pre-Turno</h2>\r\n                        <div className=\"flex items-center gap-2\">\r\n                            <div className=\"w-24 h-1.5 bg-slate-200 rounded-full overflow-hidden\">\r\n                                <div\r\n                                    className=\"h-full bg-blue-500 transition-all duration-300\"\r\n                                    style={{ width: `${progress}%` }}\r\n                                />\r\n                            </div>\r\n                            <span className=\"text-xs font-bold text-slate-400\">{checkedItems.length}/{CHECKLIST_ITEMS.length}</span>\r\n                        </div>\r\n                    </div>\r\n                    <button onClick={onClose} className=\"p-2 bg-slate-200 dark:bg-slate-700 rounded-full text-slate-500 hover:text-slate-800 transition-colors\">\r\n                        <X size={18} />\r\n                    </button>\r\n                </div>\r\n\r\n                {/* LIST */}\r\n                <div className=\"p-4 space-y-2 max-h-[60vh] overflow-y-auto\">\r\n                    {CHECKLIST_ITEMS.map((item) => {\r\n                        const isChecked = checkedItems.includes(item.id);\r\n                        return (\r\n                            <div\r\n                                key={item.id}\r\n                                onClick={() => toggleItem(item.id)}\r\n                                className={cn(\r\n                                    \"p-4 rounded-xl border flex items-center justify-between cursor-pointer transition-all active:scale-[0.99]\",\r\n                                    isChecked\r\n                                        ? \"bg-blue-50 border-blue-200 dark:bg-blue-900/20 dark:border-blue-800\"\r\n                                        : \"bg-white dark:bg-slate-800 border-slate-100 dark:border-slate-700 hover:bg-slate-50\"\r\n                                )}\r\n                            >\r\n                                <span className={cn(\r\n                                    \"font-medium transition-colors\",\r\n                                    isChecked ? \"text-blue-700 dark:text-blue-300\" : \"text-slate-600 dark:text-slate-400\"\r\n                                )}>\r\n                                    {item.label}\r\n                                </span>\r\n                                <div className={cn(\r\n                                    \"w-6 h-6 rounded-full flex items-center justify-center border transition-all\",\r\n                                    isChecked\r\n                                        ? \"bg-blue-500 border-blue-500 text-white\"\r\n                                        : \"bg-transparent border-slate-300 text-transparent\"\r\n                                )}>\r\n                                    <Check size={14} strokeWidth={4} />\r\n                                </div>\r\n                            </div>\r\n                        );\r\n                    })}\r\n                </div>\r\n\r\n                {/* FOOTER */}\r\n                <div className=\"p-6 border-t border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50\">\r\n                    <button\r\n                        onClick={handleConfirm}\r\n                        disabled={!allChecked}\r\n                        className={cn(\r\n                            \"w-full py-4 rounded-xl font-black text-white shadow-lg transition-all flex items-center justify-center gap-2\",\r\n                            allChecked\r\n                                ? \"bg-slate-900 hover:bg-slate-800 shadow-slate-900/20 active:scale-[0.98] cursor-pointer\"\r\n                                : \"bg-slate-300 dark:bg-slate-700 cursor-not-allowed opacity-50\"\r\n                        )}\r\n                    >\r\n                        {allChecked ? \"Confirmar Verificaci√≥n\" : \"Completa la lista para continuar\"}\r\n                    </button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\rider\\profile\\RiderNotificationsView.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\rider\\profile\\RiderPersonalDataView.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":40,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":40,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1583,1586],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1583,1586],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":50,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":50,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1875,1878],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1875,1878],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect } from 'react';\r\nimport { useForm } from 'react-hook-form';\r\nimport { z } from 'zod';\r\nimport { zodResolver } from '@hookform/resolvers/zod';\r\nimport { useAuth } from '../../../context/AuthContext';\r\nimport { doc, updateDoc } from 'firebase/firestore';\r\nimport { db } from '../../../lib/firebase';\r\nimport { storage } from '../../../lib/firebase';\r\nimport { ref, uploadBytes, getDownloadURL } from 'firebase/storage';\r\nimport { User, Phone, Mail, MapPin, Save, ArrowLeft, Loader, Camera } from 'lucide-react';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { useToast } from '../../../hooks/useToast';\r\n\r\n// Schema for personal data\r\nconst personalDataSchema = z.object({\r\n    displayName: z.string().min(2, \"El nombre es muy corto\"),\r\n    phoneNumber: z.string().min(9, \"Tel√©fono inv√°lido\"),\r\n    address: z.string().optional(),\r\n});\r\n\r\ntype PersonalDataInput = z.infer<typeof personalDataSchema>;\r\n\r\nexport const RiderPersonalDataView: React.FC = () => {\r\n    const { user } = useAuth();\r\n    const navigate = useNavigate();\r\n    const { toast } = useToast() || {};\r\n    const [isSaving, setIsSaving] = React.useState(false);\r\n    const [isUploading, setIsUploading] = React.useState(false);\r\n\r\n    const {\r\n        register,\r\n        handleSubmit,\r\n        reset,\r\n        formState: { errors }\r\n    } = useForm<PersonalDataInput>({\r\n        resolver: zodResolver(personalDataSchema),\r\n        defaultValues: {\r\n            displayName: user?.displayName || '',\r\n            phoneNumber: user?.phoneNumber || '',\r\n            address: (user as any)?.address || '',\r\n        }\r\n    });\r\n\r\n    // Update form when user data loads\r\n    useEffect(() => {\r\n        if (user) {\r\n            reset({\r\n                displayName: user.displayName || '',\r\n                phoneNumber: user.phoneNumber || '',\r\n                address: (user as any)?.address || '',\r\n            });\r\n        }\r\n    }, [user, reset]);\r\n\r\n    const handleImageUpload = async (event: React.ChangeEvent<HTMLInputElement>) => {\r\n        const file = event.target.files?.[0];\r\n        if (!file || !user?.uid) return;\r\n\r\n        // Validation: Max 5MB, Image only\r\n        if (file.size > 5 * 1024 * 1024) {\r\n            toast?.error(\"La imagen es demasiado grande (M√°x 5MB)\");\r\n            return;\r\n        }\r\n        if (!file.type.startsWith('image/')) {\r\n            toast?.error(\"Solo se permiten im√°genes\");\r\n            return;\r\n        }\r\n\r\n        setIsUploading(true);\r\n        try {\r\n            const storageRef = ref(storage, `avatars/${user.uid}/${Date.now()}_${file.name}`);\r\n            await uploadBytes(storageRef, file);\r\n            const downloadURL = await getDownloadURL(storageRef);\r\n\r\n            // Update Firestore immediately to reflect change\r\n            await updateDoc(doc(db, 'users', user.uid), {\r\n                photoURL: downloadURL,\r\n                updatedAt: new Date()\r\n            });\r\n\r\n            toast?.success('Foto de perfil actualizada');\r\n            // Allow Firebase Auth to propagate change naturally\r\n        } catch (error) {\r\n            console.error(\"Error uploading image:\", error);\r\n            toast?.error(\"Error al subir la imagen\");\r\n        } finally {\r\n            setIsUploading(false);\r\n        }\r\n    };\r\n\r\n    const onSubmit = async (data: PersonalDataInput) => {\r\n        if (!user?.uid) return;\r\n        setIsSaving(true);\r\n        try {\r\n            await updateDoc(doc(db, 'users', user.uid), {\r\n                displayName: data.displayName,\r\n                phoneNumber: data.phoneNumber,\r\n                address: data.address,\r\n                updatedAt: new Date()\r\n            });\r\n            toast?.success('Datos guardados correctamente');\r\n        } catch (error) {\r\n            console.error(\"Error updating profile:\", error);\r\n            toast?.error('Error al guardar datos');\r\n        } finally {\r\n            setIsSaving(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"flex flex-col min-h-screen bg-slate-50 dark:bg-slate-900 pb-20\">\r\n            {/* Header */}\r\n            <div className=\"bg-white dark:bg-slate-800 p-4 shadow-sm sticky top-0 z-10 flex items-center gap-4\">\r\n                <button onClick={() => navigate(-1)} className=\"p-2 -ml-2 text-slate-600 dark:text-slate-300\">\r\n                    <ArrowLeft size={20} />\r\n                </button>\r\n                <h1 className=\"text-lg font-bold text-slate-800 dark:text-white\">Datos Personales</h1>\r\n            </div>\r\n\r\n            <main className=\"p-6\">\r\n                <div className=\"flex justify-center mb-8\">\r\n                    <div className=\"relative group\">\r\n                        <div className=\"w-24 h-24 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center overflow-hidden border-4 border-white dark:border-slate-800 shadow-lg relative\">\r\n                            {user?.photoURL ? (\r\n                                <img src={user.photoURL} alt=\"Profile\" className=\"w-full h-full object-cover\" />\r\n                            ) : (\r\n                                <User size={40} className=\"text-slate-400\" />\r\n                            )}\r\n                            {isUploading && (\r\n                                <div className=\"absolute inset-0 bg-black/50 flex items-center justify-center\">\r\n                                    <Loader className=\"animate-spin text-white\" size={24} />\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n\r\n                        <label className=\"absolute bottom-0 right-0 bg-blue-600 text-white p-2 rounded-full shadow-md cursor-pointer hover:bg-blue-700 transition-colors active:scale-90\">\r\n                            <Camera size={16} />\r\n                            <input\r\n                                type=\"file\"\r\n                                className=\"hidden\"\r\n                                accept=\"image/*\"\r\n                                onChange={handleImageUpload}\r\n                                disabled={isUploading}\r\n                            />\r\n                        </label>\r\n                    </div>\r\n                </div>\r\n\r\n                <form onSubmit={handleSubmit(onSubmit)} className=\"space-y-6\">\r\n                    {/* Name */}\r\n                    <div className=\"space-y-1.5\">\r\n                        <label className=\"text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2\">\r\n                            <User size={14} /> Nombre Completo\r\n                        </label>\r\n                        <input\r\n                            {...register('displayName')}\r\n                            className=\"w-full p-3 bg-white dark:bg-slate-800 border-none rounded-2xl shadow-sm text-slate-800 dark:text-white focus:ring-2 focus:ring-blue-500\"\r\n                        />\r\n                        {errors.displayName && <p className=\"text-xs text-red-500\">{errors.displayName.message}</p>}\r\n                    </div>\r\n\r\n                    {/* Email (Read Only) */}\r\n                    <div className=\"space-y-1.5 opacity-60\">\r\n                        <label className=\"text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2\">\r\n                            <Mail size={14} /> Email\r\n                        </label>\r\n                        <input\r\n                            value={user?.email || ''}\r\n                            disabled\r\n                            className=\"w-full p-3 bg-slate-100 dark:bg-slate-700/50 border-none rounded-2xl shadow-inner text-slate-600 dark:text-slate-400\"\r\n                        />\r\n                    </div>\r\n\r\n                    {/* Phone */}\r\n                    <div className=\"space-y-1.5\">\r\n                        <label className=\"text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2\">\r\n                            <Phone size={14} /> Tel√©fono\r\n                        </label>\r\n                        <input\r\n                            {...register('phoneNumber')}\r\n                            type=\"tel\"\r\n                            className=\"w-full p-3 bg-white dark:bg-slate-800 border-none rounded-2xl shadow-sm text-slate-800 dark:text-white focus:ring-2 focus:ring-blue-500\"\r\n                        />\r\n                        {errors.phoneNumber && <p className=\"text-xs text-red-500\">{errors.phoneNumber.message}</p>}\r\n                    </div>\r\n\r\n                    {/* Address */}\r\n                    <div className=\"space-y-1.5\">\r\n                        <label className=\"text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2\">\r\n                            <MapPin size={14} /> Direcci√≥n\r\n                        </label>\r\n                        <input\r\n                            {...register('address')}\r\n                            placeholder=\"Tu direcci√≥n principal\"\r\n                            className=\"w-full p-3 bg-white dark:bg-slate-800 border-none rounded-2xl shadow-sm text-slate-800 dark:text-white focus:ring-2 focus:ring-blue-500\"\r\n                        />\r\n                    </div>\r\n\r\n                    <button\r\n                        type=\"submit\"\r\n                        disabled={isSaving}\r\n                        className=\"w-full mt-8 bg-blue-600 text-white p-4 rounded-2xl font-bold shadow-lg shadow-blue-500/30 flex items-center justify-center gap-2 active:scale-95 transition-all disabled:opacity-50\"\r\n                    >\r\n                        {isSaving ? <Loader className=\"animate-spin\" /> : <Save size={20} />}\r\n                        Guardar Cambios\r\n                    </button>\r\n                </form>\r\n            </main>\r\n        </div>\r\n    );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\rider\\profile\\RiderProfileView.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":108,"column":88,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":108,"endColumn":91,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5579,5582],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5579,5582],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useMemo } from 'react';\r\nimport { useAuth } from '../../../context/AuthContext';\r\nimport { useRiderStore } from '../../../store/useRiderStore';\r\nimport { User, LogOut, ChevronRight, Bell, Shield, HelpCircle, Clock, TrendingUp } from 'lucide-react';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { startOfWeek, endOfWeek, isWithinInterval } from 'date-fns';\r\n\r\nexport const RiderProfileView: React.FC = () => {\r\n    const { user, logout } = useAuth();\r\n    const { myShifts, fetchMyShifts } = useRiderStore();\r\n    const navigate = useNavigate();\r\n\r\n    useEffect(() => {\r\n        if (user?.uid) {\r\n            fetchMyShifts(user.uid);\r\n        }\r\n    }, [user, fetchMyShifts]);\r\n\r\n    const stats = useMemo(() => {\r\n        const now = new Date();\r\n        const start = startOfWeek(now, { weekStartsOn: 1 });\r\n        const end = endOfWeek(now, { weekStartsOn: 1 });\r\n\r\n        const currentShifts = myShifts.filter(s =>\r\n            isWithinInterval(new Date(s.startAt), { start, end })\r\n        );\r\n\r\n        const totalHours = currentShifts.reduce((acc, s) => {\r\n            const duration = new Date(s.endAt).getTime() - new Date(s.startAt).getTime();\r\n            return acc + (duration / (1000 * 60 * 60));\r\n        }, 0);\r\n\r\n        return {\r\n            hours: totalHours.toFixed(1),\r\n            target: 40,\r\n            percent: Math.min((totalHours / 40) * 100, 100)\r\n        };\r\n    }, [myShifts]);\r\n\r\n    const handleNavigation = (path: string) => {\r\n        navigate(path);\r\n    };\r\n\r\n    const handleSupport = () => {\r\n        window.open('mailto:soporte@repaart.com', '_blank');\r\n    };\r\n\r\n    const handleLogout = async () => {\r\n        if (confirm('¬øCerrar sesi√≥n?')) {\r\n            await logout();\r\n            navigate('/login');\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"flex flex-col gap-12 py-6\">\r\n            {/* Header Area */}\r\n            <div className=\"text-center py-4\">\r\n                <div className=\"flex flex-col items-center gap-8\">\r\n                    <div className=\"relative\">\r\n                        <div className=\"w-32 h-32 rounded-full bg-slate-900 border border-white/10 flex items-center justify-center shadow-2xl overflow-hidden ring-4 ring-white/5\">\r\n                            {user?.photoURL ? (\r\n                                <img src={user.photoURL || ''} alt={user.displayName || 'Avatar'} className=\"w-full h-full object-cover\" />\r\n                            ) : (\r\n                                <User size={56} className=\"text-slate-800\" />\r\n                            )}\r\n                        </div>\r\n                        <div className=\"absolute bottom-2 right-2 w-7 h-7 bg-emerald-500 border-4 border-slate-950 rounded-full shadow-lg\" />\r\n                    </div>\r\n\r\n                    <div>\r\n                        <h2 className=\"text-apple-h1\">{user?.displayName || 'Rider'}</h2>\r\n                        <span className=\"text-emerald-400 text-[10px] font-black uppercase tracking-[0.2em] bg-emerald-500/10 px-6 py-2 rounded-full mt-4 inline-block border border-emerald-500/20 shadow-lg\">\r\n                            {user?.role === 'rider' ? 'PROFESIONAL LOG√çSTICA' : user?.role || 'Rider'}\r\n                        </span>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* OPERATIONS SUMMARY */}\r\n                <div className=\"px-6 mt-10\">\r\n                    <div className=\"glass-premium rounded-[2rem] p-6 relative overflow-hidden\">\r\n                        <div className=\"absolute top-0 bottom-0 left-0 w-1 bg-gradient-to-b from-emerald-500 to-emerald-400\" />\r\n\r\n                        <div className=\"flex justify-between items-end mb-6\">\r\n                            <div className=\"flex flex-col items-start gap-1\">\r\n                                <span className=\"text-[10px] font-black text-emerald-400 uppercase tracking-widest flex items-center gap-2\">\r\n                                    <Clock size={12} /> Rendimiento Semanal\r\n                                </span>\r\n                                <span className=\"text-4xl font-black text-white tracking-tighter\">\r\n                                    {stats.hours}\r\n                                    <span className=\"text-lg text-slate-500 font-bold ml-1\">/{stats.target}h</span>\r\n                                </span>\r\n                            </div>\r\n                            <div className=\"flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-800/50 border border-white/5\">\r\n                                <TrendingUp size={14} className=\"text-emerald-400\" />\r\n                                <span className=\"text-[10px] font-bold text-slate-300 uppercase tracking-widest\">En Curso</span>\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"space-y-2\">\r\n                            <div className=\"flex justify-between text-[9px] font-bold uppercase tracking-widest text-slate-500\">\r\n                                <span>Progreso</span>\r\n                                <span>{stats.percent.toFixed(0)}%</span>\r\n                            </div>\r\n                            <div className=\"h-2 bg-slate-900 rounded-full overflow-hidden border border-white/5\">\r\n                                <div\r\n                                    className=\"h-full bg-gradient-to-r from-emerald-600 to-emerald-400 shadow-[0_0_12px_rgba(16,185,129,0.4)] transition-all duration-1000\"\r\n                                    style={{ width: `calc(${stats.percent} * 1%)` } as any}\r\n                                />\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Menu Sections */}\r\n            <div className=\"space-y-10\">\r\n                {/* Account Settings */}\r\n                <div className=\"space-y-4\">\r\n                    <h3 className=\"text-apple-sub px-6\">Configuraci√≥n de cuenta</h3>\r\n                    <div className=\"bg-slate-900/40 border border-white/10 rounded-[2.5rem] overflow-hidden backdrop-blur-md shadow-xl\">\r\n                        <MenuItem icon={<User size={20} />} label=\"Datos Personales\" onClick={() => handleNavigation(\"/rider/profile/personal\")} />\r\n                        <MenuItem icon={<Bell size={20} />} label=\"Notificaciones\" onClick={() => handleNavigation(\"/rider/profile/notifications\")} />\r\n                        <MenuItem icon={<Shield size={20} />} label=\"Seguridad y Acceso\" onClick={() => handleNavigation(\"/rider/profile/security\")} />\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Support & Others */}\r\n                <div className=\"space-y-4\">\r\n                    <h3 className=\"text-apple-sub px-6\">Soporte</h3>\r\n                    <div className=\"bg-slate-900/40 border border-white/10 rounded-[2.5rem] overflow-hidden backdrop-blur-md shadow-xl\">\r\n                        <MenuItem icon={<HelpCircle size={20} />} label=\"Centro de Ayuda\" onClick={handleSupport} />\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Logout Button */}\r\n                <button\r\n                    onClick={handleLogout}\r\n                    className=\"w-full flex items-center justify-between p-8 rounded-[2.5rem] bg-rose-500/5 border border-rose-500/10 text-rose-400 font-black uppercase text-xs tracking-[0.2em] transition-all active:scale-[0.98] shadow-lg group\"\r\n                >\r\n                    <div className=\"flex items-center gap-5\">\r\n                        <div className=\"w-12 h-12 rounded-2xl bg-rose-500/10 flex items-center justify-center border border-rose-500/20 text-rose-500\">\r\n                            <LogOut size={24} />\r\n                        </div>\r\n                        <span className=\"group-hover:translate-x-1 transition-transform\">Cerrar Sesi√≥n</span>\r\n                    </div>\r\n                    <ChevronRight size={20} className=\"opacity-30 group-hover:opacity-100 transition-opacity\" />\r\n                </button>\r\n\r\n                <div className=\"flex flex-col items-center py-12 opacity-10\">\r\n                    <p className=\"text-[10px] font-black tracking-[0.4em] uppercase\">Project Cockpit</p>\r\n                    <p className=\"text-[9px] font-bold mt-2\">Sagan Build v3.12.2</p>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\ninterface MenuItemProps {\r\n    icon: React.ReactNode;\r\n    label: string;\r\n    onClick?: () => void;\r\n}\r\n\r\nconst MenuItem: React.FC<MenuItemProps> = ({ icon, label, onClick }) => (\r\n    <button\r\n        onClick={onClick}\r\n        className=\"w-full flex items-center justify-between p-8 px-10 border-b border-white/5 last:border-0 hover:bg-white/5 transition-all group\"\r\n    >\r\n        <div className=\"flex items-center gap-6\">\r\n            <div className=\"w-12 h-12 rounded-2xl bg-slate-950 flex items-center justify-center text-slate-700 group-hover:text-emerald-400 group-hover:bg-emerald-500/10 transition-all border border-white/5 shadow-inner\">\r\n                {icon}\r\n            </div>\r\n            <span className=\"font-black text-slate-400 group-hover:text-white transition-colors uppercase tracking-[0.15em] text-[11px]\">{label}</span>\r\n        </div>\r\n        <ChevronRight size={18} className=\"text-slate-800 group-hover:text-slate-400 transition-all group-hover:translate-x-1\" />\r\n    </button>\r\n);\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\rider\\profile\\RiderSecurityView.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":45,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":45,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1749,1752],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1749,1752],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\r\nimport { useForm } from 'react-hook-form';\r\nimport { z } from 'zod';\r\nimport { zodResolver } from '@hookform/resolvers/zod';\r\nimport { updatePassword, EmailAuthProvider, reauthenticateWithCredential } from 'firebase/auth';\r\nimport { auth } from '../../../lib/firebase';\r\nimport { Lock, Shield, Save, ArrowLeft, Loader } from 'lucide-react';\r\nimport { useNavigate } from 'react-router-dom';\r\n\r\nconst securitySchema = z.object({\r\n    currentPassword: z.string().min(1, \"Requerido\"),\r\n    newPassword: z.string().min(6, \"M√≠nimo 6 caracteres\"),\r\n    confirmPassword: z.string()\r\n}).refine((data) => data.newPassword === data.confirmPassword, {\r\n    message: \"Las contrase√±as no coinciden\",\r\n    path: [\"confirmPassword\"],\r\n});\r\n\r\ntype SecurityFormValues = z.infer<typeof securitySchema>;\r\n\r\nexport const RiderSecurityView: React.FC = () => {\r\n    const navigate = useNavigate();\r\n    const [isSaving, setIsSaving] = useState(false);\r\n\r\n    const { register, handleSubmit, formState: { errors }, reset } = useForm<SecurityFormValues>({\r\n        resolver: zodResolver(securitySchema)\r\n    });\r\n\r\n    const onSubmit = async (data: SecurityFormValues) => {\r\n        const user = auth.currentUser;\r\n        if (!user || !user.email) return;\r\n\r\n        setIsSaving(true);\r\n        try {\r\n            // 1. Re-authenticate\r\n            const credential = EmailAuthProvider.credential(user.email, data.currentPassword);\r\n            await reauthenticateWithCredential(user, credential);\r\n\r\n            // 2. Update Password\r\n            await updatePassword(user, data.newPassword);\r\n\r\n            alert('Contrase√±a actualizada correctamente');\r\n            reset();\r\n            navigate(-1);\r\n        } catch (error: any) {\r\n            console.error(\"Error updating password:\", error);\r\n            if (error.code === 'auth/wrong-password') {\r\n                alert('La contrase√±a actual es incorrecta');\r\n            } else {\r\n                alert('Error al actualizar la contrase√±a: ' + error.message);\r\n            }\r\n        } finally {\r\n            setIsSaving(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"flex flex-col min-h-screen bg-slate-50 dark:bg-slate-900 pb-20\">\r\n            {/* Header */}\r\n            <div className=\"bg-white dark:bg-slate-800 p-4 shadow-sm sticky top-0 z-10 flex items-center gap-4\">\r\n                <button onClick={() => navigate(-1)} className=\"p-2 -ml-2 text-slate-600 dark:text-slate-300\">\r\n                    <ArrowLeft size={20} />\r\n                </button>\r\n                <h1 className=\"text-lg font-bold text-slate-800 dark:text-white\">Seguridad</h1>\r\n            </div>\r\n\r\n            <main className=\"p-6\">\r\n                <div className=\"mb-8 flex flex-col items-center text-center\">\r\n                    <div className=\"w-16 h-16 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center text-blue-600 dark:text-blue-400 mb-4\">\r\n                        <Shield size={32} />\r\n                    </div>\r\n                    <p className=\"text-slate-600 dark:text-slate-400 text-sm max-w-xs\">\r\n                        Mant√©n tu cuenta segura. Te pediremos tu contrase√±a actual para confirmar los cambios.\r\n                    </p>\r\n                </div>\r\n\r\n                <form onSubmit={handleSubmit(onSubmit)} className=\"space-y-5\">\r\n                    <div className=\"space-y-1.5\">\r\n                        <label className=\"text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2\">\r\n                            <Lock size={14} /> Contrase√±a Actual\r\n                        </label>\r\n                        <input\r\n                            {...register('currentPassword')}\r\n                            type=\"password\"\r\n                            placeholder=\"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢\"\r\n                            className=\"w-full p-3 bg-white dark:bg-slate-800 border-none rounded-2xl shadow-sm text-slate-800 dark:text-white focus:ring-2 focus:ring-blue-500\"\r\n                        />\r\n                        {errors.currentPassword && <p className=\"text-xs text-red-500\">{errors.currentPassword.message}</p>}\r\n                    </div>\r\n\r\n                    <div className=\"space-y-1.5 pt-4 border-t border-slate-200 dark:border-slate-700\">\r\n                        <label className=\"text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2\">\r\n                            <Lock size={14} /> Nueva Contrase√±a\r\n                        </label>\r\n                        <input\r\n                            {...register('newPassword')}\r\n                            type=\"password\"\r\n                            placeholder=\"M√≠nimo 6 caracteres\"\r\n                            className=\"w-full p-3 bg-white dark:bg-slate-800 border-none rounded-2xl shadow-sm text-slate-800 dark:text-white focus:ring-2 focus:ring-blue-500\"\r\n                        />\r\n                        {errors.newPassword && <p className=\"text-xs text-red-500\">{errors.newPassword.message}</p>}\r\n                    </div>\r\n\r\n                    <div className=\"space-y-1.5\">\r\n                        <label className=\"text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2\">\r\n                            <Lock size={14} /> Confirmar Nueva Contrase√±a\r\n                        </label>\r\n                        <input\r\n                            {...register('confirmPassword')}\r\n                            type=\"password\"\r\n                            placeholder=\"Repite la nueva contrase√±a\"\r\n                            className=\"w-full p-3 bg-white dark:bg-slate-800 border-none rounded-2xl shadow-sm text-slate-800 dark:text-white focus:ring-2 focus:ring-blue-500\"\r\n                        />\r\n                        {errors.confirmPassword && <p className=\"text-xs text-red-500\">{errors.confirmPassword.message}</p>}\r\n                    </div>\r\n\r\n                    <button\r\n                        type=\"submit\"\r\n                        disabled={isSaving}\r\n                        className=\"w-full mt-8 bg-blue-600 text-white p-4 rounded-2xl font-bold shadow-lg shadow-blue-500/30 flex items-center justify-center gap-2 active:scale-95 transition-all disabled:opacity-50\"\r\n                    >\r\n                        {isSaving ? <Loader className=\"animate-spin\" /> : <Save size={20} />}\r\n                        Actualizar Contrase√±a\r\n                    </button>\r\n                </form>\r\n            </main>\r\n        </div>\r\n    );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\rider\\schedule\\RiderScheduleView.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":76,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":76,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3161,3164],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3161,3164],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as React from 'react';\r\nimport { useState, useEffect } from 'react';\r\nimport { format, startOfWeek, endOfWeek, addDays, addWeeks, subWeeks } from 'date-fns';\r\nimport { es } from 'date-fns/locale';\r\nimport { ChevronLeft, ChevronRight } from 'lucide-react';\r\nimport { useOperationsIntel, intelService } from '../../../services/intelService';\r\nimport MobileAgendaView from '../../operations/MobileAgendaView';\r\nimport { shiftService, Shift } from '../../../services/shiftService';\r\nimport { useAuth, AuthUser } from '../../../context/AuthContext';\r\n\r\n// Helper to generate day columns\r\nconst getWeekDays = (start: Date) => {\r\n    return Array.from({ length: 7 }).map((_, i) => {\r\n        const date = addDays(start, i);\r\n        return {\r\n            isoDate: format(date, 'yyyy-MM-dd'),\r\n            label: format(date, 'EEE d', { locale: es }),\r\n            dateObj: date\r\n        };\r\n    });\r\n};\r\n\r\nconst RiderScheduleView: React.FC = () => {\r\n    const { user } = useAuth() as { user: AuthUser | null };\r\n    const [selectedDate, setSelectedDate] = useState(new Date());\r\n    const [shifts, setShifts] = useState<Shift[]>([]);\r\n    const [expandedShiftId, setExpandedShiftId] = useState<string | null>(null);\r\n\r\n    // Real Data Hooks\r\n    const { events: intelEvents } = useOperationsIntel(selectedDate);\r\n\r\n    // Group events for the view\r\n    const intelByDay = React.useMemo(() => {\r\n        return intelService.getEventsByDay(intelEvents);\r\n    }, [intelEvents]);\r\n\r\n    // Calculate Week Range\r\n    const weekStart = startOfWeek(selectedDate, { weekStartsOn: 1 });\r\n    const weekEnd = endOfWeek(selectedDate, { weekStartsOn: 1 });\r\n    const agendaDays = getWeekDays(weekStart);\r\n\r\n    // Fetch Shifts Real-time\r\n    useEffect(() => {\r\n        if (!user?.uid) return;\r\n        const unsubscribe = shiftService.getMyShifts(user.uid, weekStart, weekEnd, (data) => setShifts(data));\r\n        return () => unsubscribe();\r\n    }, [user?.uid, weekStart, weekEnd]);\r\n\r\n    // Transform Shifts\r\n    const visualEvents = React.useMemo(() => {\r\n        return shifts.reduce((acc, shift) => {\r\n            const dateKey = shift.date;\r\n            if (!acc[dateKey]) acc[dateKey] = [];\r\n            acc[dateKey].push({\r\n                shiftId: shift.shiftId,\r\n                riderId: shift.riderId,\r\n                riderName: shift.riderName,\r\n                startAt: shift.startAt,\r\n                endAt: shift.endAt,\r\n                visualStart: new Date(shift.startAt),\r\n                visualEnd: new Date(shift.endAt),\r\n                isConfirmed: shift.isConfirmed,\r\n                swapRequested: shift.swapRequested,\r\n                changeRequested: shift.changeRequested,\r\n                changeReason: shift.changeReason,\r\n                isDraft: shift.isDraft,\r\n                franchiseId: shift.franchiseId,\r\n                motoAssignments: shift.motoId ? [{\r\n                    motoId: shift.motoId,\r\n                    plate: shift.motoPlate,\r\n                    startAt: shift.startAt,\r\n                    endAt: shift.endAt\r\n                }] : []\r\n            });\r\n            return acc;\r\n        }, {} as Record<string, any[]>);\r\n    }, [shifts]);\r\n\r\n    // Metrics\r\n    const totalHours = React.useMemo(() => {\r\n        return shifts.reduce((acc, s) => {\r\n            const start = new Date(s.startAt).getTime();\r\n            const end = new Date(s.endAt).getTime();\r\n            return acc + (end - start) / (1000 * 60 * 60);\r\n        }, 0);\r\n    }, [shifts]);\r\n\r\n    const handlePrevWeek = () => setSelectedDate(d => subWeeks(d, 1));\r\n    const handleNextWeek = () => setSelectedDate(d => addWeeks(d, 1));\r\n\r\n    // Dynamic Date Range String\r\n    const dateRangeLabel = React.useMemo(() => {\r\n        const startMonth = format(weekStart, 'MMM', { locale: es });\r\n        const endMonth = format(weekEnd, 'MMM', { locale: es });\r\n\r\n        if (startMonth === endMonth) {\r\n            return `${format(weekStart, 'd', { locale: es })} ‚Äî ${format(weekEnd, 'd MMM', { locale: es })}`;\r\n        }\r\n        return `${format(weekStart, 'd MMM', { locale: es })} ‚Äî ${format(weekEnd, 'd MMM', { locale: es })}`;\r\n    }, [weekStart, weekEnd]);\r\n\r\n    return (\r\n        <div className=\"flex flex-col gap-4 pb-20\">\r\n            {/* COMPACT DASHBOARD HEADER */}\r\n            <div className=\"sticky top-0 z-30 pt-4 pb-2 bg-[#09090b]\">\r\n                <div className=\"mx-3 rounded-[24px] bg-[#121214] border border-white/5 shadow-2xl relative overflow-hidden h-[72px] flex items-center px-4\">\r\n\r\n                    {/* CENTERED NAVIGATION GROUP (Absolute Center) */}\r\n                    <div className=\"absolute left-1/2 -translate-x-1/2 flex items-center gap-4 z-20\">\r\n                        <button\r\n                            onClick={handlePrevWeek}\r\n                            className=\"w-10 h-10 flex items-center justify-center text-zinc-500 hover:text-white transition-colors active:scale-90 rounded-full hover:bg-white/5\"\r\n                            aria-label=\"Semana anterior\"\r\n                        >\r\n                            <ChevronLeft size={20} />\r\n                        </button>\r\n\r\n                        <span className=\"text-lg font-bold text-white tracking-tight capitalize min-w-[140px] text-center\">\r\n                            {dateRangeLabel}\r\n                        </span>\r\n\r\n                        <button\r\n                            onClick={handleNextWeek}\r\n                            className=\"w-10 h-10 flex items-center justify-center text-zinc-500 hover:text-white transition-colors active:scale-90 rounded-full hover:bg-white/5\"\r\n                            aria-label=\"Semana siguiente\"\r\n                        >\r\n                            <ChevronRight size={20} />\r\n                        </button>\r\n                    </div>\r\n\r\n                    {/* Hours Metric (Pushed to the far right) */}\r\n                    <div className=\"ml-auto z-20 flex flex-col items-end justify-center\">\r\n                        <span className=\"text-[9px] font-black text-zinc-500 uppercase tracking-[0.2em] leading-none mb-1\">HORAS</span>\r\n                        <span className=\"text-lg font-bold text-white tracking-tighter leading-none\">{totalHours.toFixed(1)}h</span>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            <MobileAgendaView\r\n                days={agendaDays}\r\n                visualEvents={visualEvents}\r\n                intelByDay={intelByDay}\r\n                onEditShift={(s) => setExpandedShiftId(expandedShiftId === (s.shiftId || s.id) ? null : (s.shiftId || s.id))}\r\n                onDeleteShift={() => { }}\r\n                onAddShift={() => { }}\r\n                readOnly={true}\r\n                isRiderMode={true}\r\n                expandedShiftId={expandedShiftId}\r\n            />\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default RiderScheduleView;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\rider\\schedule\\components\\RiderSkeleton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\rider\\schedule\\components\\ShiftCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\rider\\schedule\\components\\SmartStartButton.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":58,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":58,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2669,2672],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2669,2672],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":68,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":68,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3013,3016],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3013,3016],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":129,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":129,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5143,5146],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5143,5146],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\r\nimport { franchiseService } from '../../../../services/franchiseService';\r\nimport { shiftService } from '../../../../services/shiftService';\r\nimport { calculateDistance, getCurrentPosition } from '../../../../utils/geo';\r\nimport { Scanner } from '@yudiel/react-qr-scanner';\r\nimport confetti from 'canvas-confetti';\r\nimport { QrCode, X, Loader2, CheckCircle2 } from 'lucide-react';\r\n\r\ninterface SmartStartButtonProps {\r\n    shiftId: string;\r\n    franchiseId: string;\r\n    onSuccess: () => void;\r\n}\r\n\r\nexport const SmartStartButton: React.FC<SmartStartButtonProps> = ({ shiftId, franchiseId, onSuccess }) => {\r\n    const [status, setStatus] = useState<'idle' | 'locating' | 'scanning' | 'processing' | 'success' | 'error'>('idle');\r\n    const [errorMsg, setErrorMsg] = useState<string | null>(null);\r\n\r\n    // --- STEP 1: GPS CHECK ---\r\n    const handleStart = async () => {\r\n        setStatus('locating');\r\n        setErrorMsg(null);\r\n\r\n        try {\r\n            // 1. Get Rider Location\r\n            const position = await getCurrentPosition();\r\n            const { latitude: riderLat, longitude: riderLng } = position.coords;\r\n\r\n            // 2. Get Franchise Location\r\n            const franchiseResult = await franchiseService.getFranchiseMeta(franchiseId);\r\n\r\n            if (franchiseResult.success) {\r\n                const franchise = franchiseResult.data;\r\n                // Safe check for coordinates, assuming they exist in Firestore user profile\r\n                const franchiseCoords = franchise.coordinates as { lat: number, lng: number } | undefined;\r\n\r\n                if (franchiseCoords) {\r\n                    const distance = calculateDistance(riderLat, riderLng, franchiseCoords.lat, franchiseCoords.lng);\r\n\r\n                    // RULE: 200m or Dev Bypass (Localhost logic could go here)\r\n                    // For now, let's say < 200m is valid.\r\n                    if (distance > 200) {\r\n                        // throw new Error(`üìç Est√°s a ${Math.round(distance)}m de la base. Ac√©rcate a menos de 200m.`);\r\n                        // BYPASS FOR DEMO if coordinates are missing or dev\r\n                        console.warn(`DEV WARNING: Distance is ${distance}m. Proceeding for demo.`);\r\n                    }\r\n                } else {\r\n                    console.warn(\"Franchise has no coordinates. Skipping Geofence check.\");\r\n                }\r\n\r\n                // If GPS OK (or bypassed), move to Scan\r\n                setStatus('scanning');\r\n\r\n            } else {\r\n                throw new Error(\"No se pudo verificar la ubicaci√≥n de la base.\");\r\n            }\r\n\r\n        } catch (error: any) {\r\n            console.error(\"SmartStart Error:\", error);\r\n            setStatus('error');\r\n            setErrorMsg(error.message || \"Error de ubicaci√≥n.\");\r\n            // Reset after delay\r\n            setTimeout(() => setStatus('idle'), 3000);\r\n        }\r\n    };\r\n\r\n    // --- STEP 2: QR SCAN ---\r\n    const handleScan = async (result: any) => {\r\n        // Debounce/Block double scans\r\n        if (status === 'processing' || status === 'success') return;\r\n\r\n        // Scanner usually returns object or string. @yudiel/react-qr-scanner often returns [{ rawValue: '...' }]\r\n        // Let's safe access\r\n        const vehicleId = result?.[0]?.rawValue || result;\r\n\r\n        if (!vehicleId) return;\r\n\r\n        setStatus('processing');\r\n\r\n        try {\r\n            // Update Shift in Firestore\r\n            await shiftService.updateShift(shiftId, {\r\n                motoId: vehicleId\r\n                // In a real app, we'd look up the plate too, asking vehicleService\r\n                // But for now, we just link the ID.\r\n            });\r\n\r\n            // SUCCESS!\r\n            setStatus('success');\r\n            confetti({\r\n                particleCount: 100,\r\n                spread: 70,\r\n                origin: { y: 0.6 }\r\n            });\r\n\r\n            // Wait a moment before closing/callback\r\n            setTimeout(() => {\r\n                onSuccess();\r\n                setStatus('idle'); // Or stay success?\r\n            }, 1500);\r\n\r\n        } catch (error) {\r\n            console.error(\"Update Shift Error:\", error);\r\n            setStatus('error');\r\n            setErrorMsg(\"Error al asignar veh√≠culo. Intenta manual.\");\r\n        }\r\n    };\r\n\r\n    // --- RENDER ---\r\n\r\n    // 1. SCANNER OVERLAY\r\n    if (status === 'scanning' || status === 'processing') {\r\n        return (\r\n            <div className=\"fixed inset-0 z-50 bg-black flex flex-col\">\r\n                <div className=\"absolute top-4 right-4 z-50\">\r\n                    <button\r\n                        onClick={() => setStatus('idle')}\r\n                        className=\"bg-black/50 p-2 rounded-full text-white\"\r\n                    >\r\n                        <X size={24} />\r\n                    </button>\r\n                </div>\r\n\r\n                <div className=\"flex-1 relative\">\r\n                    <Scanner\r\n                        onScan={(result) => {\r\n                            if (result) handleScan(result);\r\n                        }}\r\n                        onError={(error: any) => console.log(error?.message)}\r\n                        // options={{\r\n                        //     delayBetweenScanAttempts: 300,\r\n                        // }}\r\n                        styles={{\r\n                            container: { height: '100%' },\r\n                            video: { height: '100%', objectFit: 'cover' }\r\n                        }}\r\n                    />\r\n\r\n                    {/* Overlay UI */}\r\n                    <div className=\"absolute inset-0 flex flex-col items-center justify-center pointer-events-none\">\r\n                        <div className=\"w-64 h-64 border-2 border-white/50 rounded-3xl relative\">\r\n                            <div className=\"absolute inset-0 border-2 border-blue-500 rounded-3xl animate-pulse\"></div>\r\n                        </div>\r\n                        <p className=\"mt-8 text-white font-medium bg-black/60 px-4 py-2 rounded-full backdrop-blur-md\">\r\n                            Escanea el QR de la moto üèçÔ∏è\r\n                        </p>\r\n                    </div>\r\n\r\n                    {status === 'processing' && (\r\n                        <div className=\"absolute inset-0 bg-black/80 flex flex-col items-center justify-center backdrop-blur-sm z-50\">\r\n                            <Loader2 className=\"animate-spin text-blue-500 mb-4\" size={48} />\r\n                            <h3 className=\"text-white font-bold text-xl\">Asignando Veh√≠culo...</h3>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    // 2. IDLE / ERROR / SUCCESS BUTTON\r\n    if (status === 'success') {\r\n        return (\r\n            <div className=\"w-full bg-green-500 text-white rounded-xl py-4 flex items-center justify-center gap-2 font-bold shadow-lg shadow-green-500/30\">\r\n                <CheckCircle2 size={24} />\r\n                <span>¬°Turno Iniciado!</span>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    const isLocating = status === 'locating';\r\n\r\n    return (\r\n        <div className=\"w-full\">\r\n            {errorMsg && (\r\n                <div className=\"mb-3 p-3 bg-red-50 text-red-600 text-sm rounded-lg flex items-center gap-2\">\r\n                    <X size={16} />\r\n                    {errorMsg}\r\n                </div>\r\n            )}\r\n\r\n            <button\r\n                onClick={handleStart}\r\n                disabled={isLocating}\r\n                className={`\r\n                    w-full py-4 rounded-xl font-bold flex items-center justify-center gap-2 transition-all\r\n                    ${isLocating\r\n                        ? 'bg-slate-100 text-slate-400 cursor-wait'\r\n                        : 'bg-slate-900 dark:bg-white text-white dark:text-slate-900 shadow-lg shadow-slate-900/20 active:scale-95'\r\n                    }\r\n                `}\r\n            >\r\n                {isLocating ? (\r\n                    <>\r\n                        <Loader2 className=\"animate-spin\" size={20} />\r\n                        <span className=\"text-sm\">Verificando GPS...</span>\r\n                    </>\r\n                ) : (\r\n                    <>\r\n                        <QrCode size={20} />\r\n                        <span>Escanear para Iniciar</span>\r\n                    </>\r\n                )}\r\n            </button>\r\n        </div>\r\n    );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\rider\\schedule\\components\\WeekStrip.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\scheduler\\DeliveryScheduler.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":76,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":76,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3205,3208],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3205,3208],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":92,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":92,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3796,3799],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3796,3799],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":180,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":180,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7218,7221],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7218,7221],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":310,"column":69,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":310,"endColumn":72,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12281,12284],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12281,12284],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":343,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":343,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13751,13754],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13751,13754],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":378,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":378,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15136,15139],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15136,15139],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":391,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":391,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15652,15655],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15652,15655],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":391,"column":61,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":391,"endColumn":64,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15660,15663],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15660,15663],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":544,"column":119,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":544,"endColumn":122,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[26433,26436],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[26433,26436],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":571,"column":162,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":571,"endColumn":165,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[29163,29166],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[29163,29166],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":579,"column":79,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":579,"endColumn":82,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[29614,29617],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[29614,29617],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":583,"column":68,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":583,"endColumn":71,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[30268,30271],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[30268,30271],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":620,"column":82,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":620,"endColumn":85,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[34601,34604],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[34601,34604],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":629,"column":68,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":629,"endColumn":71,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[35474,35477],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[35474,35477],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":662,"column":105,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":662,"endColumn":108,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[38929,38932],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[38929,38932],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":15,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useMemo, useEffect } from 'react';\r\nimport { ChevronLeft, ChevronRight, Zap, Save, Loader2, Clock, BadgeCheck, AlertTriangle, ShieldCheck, Wand2, XCircle } from 'lucide-react';\r\nimport { cn } from '../../lib/utils';\r\nimport { getRiderInitials } from '../../utils/colorPalette';\r\nimport { toLocalDateString, toLocalISOString, toLocalISOStringWithOffset } from '../../utils/dateUtils';\r\nimport ShiftModal from '../../features/operations/ShiftModal';\r\nimport QuickFillModal from '../../features/operations/QuickFillModal';\r\nimport MobileAgendaView from '../../features/operations/MobileAgendaView';\r\n\r\nimport { useWeeklySchedule } from '../../hooks/useWeeklySchedule';\r\nimport { useAuth } from '../../context/AuthContext';\r\nimport { getRiderColor } from '../../utils/riderColors';\r\nimport { useMediaQuery } from '../../hooks/useMediaQuery';\r\nimport { format, startOfWeek, addDays, parseISO, setHours, differenceInMinutes, isToday } from 'date-fns';\r\nimport { es } from 'date-fns/locale';\r\nimport { useFleetStore } from '../../store/useFleetStore';\r\nimport { useVehicleStore } from '../../store/useVehicleStore';\r\nimport { shiftService } from '../../services/shiftService';\r\nimport { notificationService } from '../../services/notificationService';\r\nimport { validateWeeklySchedule, generateScheduleFix } from '../../lib/gemini';\r\n\r\nconsole.log('üì¶ ARCHIVO DeliveryScheduler.tsx CARGADO EN EL NAVEGADOR');\r\n\r\nconst DeliveryScheduler: React.FC<{\r\n    franchiseId: string;\r\n    selectedDate: Date;\r\n    onDateChange?: (date: Date) => void;\r\n    readOnly?: boolean;\r\n}> = ({ franchiseId, selectedDate, onDateChange, readOnly }) => {\r\n\r\n\r\n    const { user } = useAuth();\r\n    const safeFranchiseId = franchiseId || user?.uid || '';\r\n    const isMobile = useMediaQuery('(max-width: 768px)');\r\n\r\n    // --- UI STATE ---\r\n    const [viewMode, setViewMode] = useState<'day' | 'week'>('week');\r\n    const [showPrime, setShowPrime] = useState(false);\r\n    const [isPublishing, setIsPublishing] = useState(false);\r\n    const [currentTime, setCurrentTime] = useState(new Date());\r\n\r\n    // --- SHERIFF & MAGIC AI STATE ---\r\n    const [sheriffResult, setSheriffResult] = useState<{\r\n        score: number;\r\n        status: 'optimal' | 'warning' | 'critical';\r\n        feedback: string;\r\n        missingCoverage: string[];\r\n    } | null>(null);\r\n    const [isAuditing, setIsAuditing] = useState(false);\r\n    const [isFixing, setIsFixing] = useState(false);\r\n\r\n    // Update time every minute for the Red Line\r\n    useEffect(() => {\r\n        const timer = setInterval(() => setCurrentTime(new Date()), 60000);\r\n        return () => clearInterval(timer);\r\n    }, []);\r\n\r\n    // --- DATA HOOKS ---\r\n    const {\r\n        weekData,\r\n        loading,\r\n        navigateWeek,\r\n        motos\r\n    } = useWeeklySchedule(safeFranchiseId, readOnly, selectedDate);\r\n\r\n    const changeWeek = (direction: number) => {\r\n        if (onDateChange) {\r\n            const newDate = addDays(selectedDate, direction * 7);\r\n            onDateChange(newDate);\r\n        } else {\r\n            navigateWeek(direction);\r\n        }\r\n    };\r\n\r\n    // --- DRAFT MODE STATE ---\r\n    const [localShifts, setLocalShifts] = useState<any[]>([]);\r\n    const [deletedIds, setDeletedIds] = useState<Set<string>>(new Set());\r\n    const hasUnsavedChanges = localShifts.length > 0 || deletedIds.size > 0;\r\n\r\n    // --- STORES ---\r\n    const { riders: rosterRiders, fetchRiders } = useFleetStore();\r\n    const { vehicles, fetchVehicles } = useVehicleStore();\r\n\r\n    useEffect(() => {\r\n        if (safeFranchiseId) {\r\n            fetchRiders(safeFranchiseId);\r\n            fetchVehicles(safeFranchiseId);\r\n        }\r\n    }, [fetchRiders, fetchVehicles, safeFranchiseId]);\r\n\r\n    // --- ACTIONS ---\r\n    const saveShift = (shiftData: any) => {\r\n        if (readOnly) {\r\n            alert(\"Modo solo lectura: No se pueden guardar cambios.\");\r\n            return;\r\n        }\r\n\r\n        const existingId = shiftData.id || shiftData.shiftId;\r\n        const isNewToken = !existingId || (typeof existingId === 'string' && existingId.startsWith('draft-'));\r\n\r\n        const finalShift = {\r\n            ...shiftData,\r\n            id: existingId || `draft-${crypto.randomUUID()}`,\r\n            isDraft: true,\r\n            isNew: isNewToken\r\n        };\r\n\r\n        setLocalShifts(prev => {\r\n            const filtered = prev.filter(s => String(s.id) !== String(finalShift.id));\r\n            return [...filtered, finalShift];\r\n        });\r\n    };\r\n\r\n    const deleteShift = (shiftId: string) => {\r\n        if (readOnly) {\r\n            alert(\"Modo solo lectura: No se pueden borrar turnos.\");\r\n            return;\r\n        }\r\n        const shiftIdStr = String(shiftId);\r\n        if (shiftIdStr.startsWith('draft-')) {\r\n            setLocalShifts(prev => prev.filter(s => String(s.id) !== shiftIdStr));\r\n        } else {\r\n            setDeletedIds(prev => {\r\n                const newSet = new Set(prev);\r\n                newSet.add(shiftIdStr);\r\n                return newSet;\r\n            });\r\n            setLocalShifts(prev => prev.filter(s => String(s.id) !== shiftIdStr));\r\n        }\r\n    };\r\n\r\n    const handlePublish = async () => {\r\n        if (!safeFranchiseId || isPublishing || readOnly) return;\r\n        setIsPublishing(true);\r\n        try {\r\n            for (const id of deletedIds) {\r\n                await shiftService.deleteShift(id);\r\n            }\r\n            for (const s of localShifts) {\r\n                const inputData = {\r\n                    franchiseId: safeFranchiseId,\r\n                    riderId: s.riderId,\r\n                    riderName: s.riderName || rosterRiders.find(r => r.id === s.riderId)?.fullName || 'Rider',\r\n                    motoId: s.motoId || null,\r\n                    motoPlate: s.motoPlate || '',\r\n                    startAt: s.startAt,\r\n                    endAt: s.endAt\r\n                };\r\n\r\n                const isTrulyNew = (typeof s.id === 'string' && s.id.startsWith('draft-')) || !weekData?.shifts?.some(rs => rs.id === s.id);\r\n\r\n                if (isTrulyNew) {\r\n                    await shiftService.createShift(inputData);\r\n                } else {\r\n                    await shiftService.updateShift(s.id, inputData);\r\n                }\r\n            }\r\n\r\n            // Notify Admin about the published schedule\r\n            try {\r\n                await notificationService.notify(\r\n                    'SCHEDULE_PUBLISHED',\r\n                    safeFranchiseId,\r\n                    'Franquicia', // idealmente obtener el nombre real\r\n                    {\r\n                        title: 'Horario Publicado',\r\n                        message: `La franquicia ha publicado su horario para la semana.`,\r\n                        priority: 'normal',\r\n                        metadata: { franchiseId: safeFranchiseId }\r\n                    }\r\n                );\r\n                console.log(\"NOTIFICACI√ìN DE PUBLICACI√ìN ENVIADA\");\r\n            } catch (err) {\r\n                console.warn(\"Error enviando notificaci√≥n\", err);\r\n            }\r\n\r\n            setLocalShifts([]);\r\n            setDeletedIds(new Set());\r\n            // alert(\"‚úÖ Calendario publicado exitosamente.\");\r\n        } catch (error: any) {\r\n            console.error(error);\r\n            alert(\"Error al publicar.\");\r\n        } finally {\r\n            setIsPublishing(false);\r\n        }\r\n    };\r\n\r\n    // --- SHERIFF & AI LOGIC ---\r\n    const handleAuditoria = async () => {\r\n        // Audit merged shifts (remote + local drafts)\r\n        if (!mergedShifts || mergedShifts.length === 0) {\r\n            alert(\"El cuadrante est√° vac√≠o. A√±ade turnos antes de auditar.\");\r\n            return;\r\n        }\r\n        setIsAuditing(true);\r\n        setSheriffResult(null);\r\n        try {\r\n            const result = await validateWeeklySchedule(mergedShifts);\r\n            if (result) {\r\n                setSheriffResult(result);\r\n            } else {\r\n                alert(\"El Sheriff no ha podido validar el cuadrante. Int√©ntalo de nuevo.\");\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Error en auditor√≠a:\", error);\r\n            alert(\"Error de conexi√≥n con el Sheriff.\");\r\n        } finally {\r\n            setIsAuditing(false);\r\n        }\r\n    };\r\n\r\n    const handleAutoFix = async () => {\r\n        if (!sheriffResult || !weekData) return;\r\n\r\n        setIsFixing(true);\r\n        try {\r\n            const fixResult = await generateScheduleFix(\r\n                mergedShifts || [],\r\n                rosterRiders || [],\r\n                sheriffResult.missingCoverage\r\n            );\r\n\r\n            if (fixResult && fixResult.newShifts.length > 0) {\r\n                const confirmed = window.confirm(\r\n                    `El Sheriff sugiere ${fixResult.newShifts.length} nuevos turnos:\\n\\n` +\r\n                    fixResult.explanation +\r\n                    `\\n\\n¬øAplicar cambios ahora (como borradores)?`\r\n                );\r\n\r\n                if (confirmed) {\r\n                    const newDrafts = fixResult.newShifts.map(s => {\r\n                        const startD = new Date(s.startDay);\r\n                        startD.setHours(s.startHour, 0, 0, 0);\r\n                        const endD = new Date(startD);\r\n                        endD.setHours(s.startHour + s.duration, 0, 0, 0);\r\n\r\n                        return {\r\n                            id: `draft-fix-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`,\r\n                            shiftId: `draft-fix-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`,\r\n                            riderId: s.riderId,\r\n                            riderName: rosterRiders.find(r => r.id === s.riderId)?.fullName || 'Rider',\r\n                            motoId: null,\r\n                            motoPlate: null,\r\n                            startAt: toLocalISOStringWithOffset(startD),\r\n                            endAt: toLocalISOStringWithOffset(endD),\r\n                            isDraft: true,\r\n                            isNew: true\r\n                        };\r\n                    });\r\n\r\n                    setLocalShifts(prev => [...prev, ...newDrafts]);\r\n\r\n                    // Re-audit automatically\r\n                    setTimeout(() => handleAuditoria(), 1000);\r\n                }\r\n            } else {\r\n                alert(\"El Sheriff no encontr√≥ una soluci√≥n autom√°tica viable. Intenta mover turnos manualmente.\");\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Auto-Fix Error:\", error);\r\n            alert(\"Error al aplicar la correcci√≥n autom√°tica.\");\r\n        } finally {\r\n            setIsFixing(false);\r\n        }\r\n    };\r\n\r\n    // --- EVENT SIMULATION ---\r\n    const days = useMemo(() => {\r\n        const start = startOfWeek(selectedDate, { weekStartsOn: 1 });\r\n        return Array.from({ length: 7 }).map((_, i) => {\r\n            const date = addDays(start, i);\r\n            return {\r\n                date,\r\n                dateObj: date,\r\n                isoDate: toLocalDateString(date),\r\n                label: format(date, 'EEEE d', { locale: es }),\r\n                shortLabel: format(date, 'EEE', { locale: es })\r\n            };\r\n        });\r\n    }, [selectedDate]);\r\n\r\n    // --- GRID CALCULATION ---\r\n    const mergedShifts = useMemo(() => {\r\n        const remote = weekData?.shifts || [];\r\n        const liveRemote = remote.filter(s => !deletedIds.has(String(s.id || s.shiftId)));\r\n        return [...liveRemote, ...localShifts];\r\n    }, [weekData?.shifts, localShifts, deletedIds]);\r\n\r\n    const ridersGrid = useMemo(() => {\r\n        const ridersMap = new Map();\r\n        rosterRiders.forEach(r => {\r\n            if (r.status === 'active' || r.status === 'on_route') {\r\n                ridersMap.set(r.id, {\r\n                    id: r.id,\r\n                    fullName: r.fullName,\r\n                    shifts: [],\r\n                    contractHours: r.contractHours || 40\r\n                });\r\n            }\r\n        });\r\n\r\n        mergedShifts.forEach(s => {\r\n            const rid = s.riderId;\r\n            if (ridersMap.has(rid)) {\r\n                ridersMap.get(rid).shifts.push(s);\r\n            }\r\n        });\r\n\r\n        return Array.from(ridersMap.values()).map(rider => {\r\n            const totalHours = rider.shifts.reduce((acc: number, s: any) => {\r\n                return acc + (differenceInMinutes(new Date(s.endAt), new Date(s.startAt))) / 60;\r\n            }, 0);\r\n            return { ...rider, totalWeeklyHours: totalHours };\r\n        }).sort((a, b) => a.fullName.localeCompare(b.fullName));\r\n    }, [mergedShifts, rosterRiders]);\r\n\r\n    const coverage = useMemo(() => {\r\n        const res: Record<string, number[]> = {};\r\n        days.forEach(d => res[d.isoDate] = Array(24).fill(0));\r\n        mergedShifts.forEach(s => {\r\n            const date = toLocalDateString(new Date(s.startAt));\r\n            if (res[date]) {\r\n                const sStart = new Date(s.startAt);\r\n                const sEnd = new Date(s.endAt);\r\n                const start = sStart.getHours();\r\n                const end = sEnd.getHours();\r\n                const endM = sEnd.getMinutes();\r\n                const realEnd = (end === 0 && endM === 0) ? 24 : end;\r\n                for (let h = start; h < realEnd; h++) {\r\n                    if (h >= 0 && h < 24) res[date][h]++;\r\n                }\r\n            }\r\n        });\r\n        return res;\r\n    }, [days, mergedShifts]);\r\n\r\n    // --- TIME INDICATOR CALC ---\r\n    const viewingToday = isToday(selectedDate);\r\n    const redLinePosition = viewingToday ? (currentTime.getHours() * 60 + currentTime.getMinutes()) / 1440 * 100 : null;\r\n\r\n    // --- UI HELPERS ---\r\n    const [isModalOpen, setIsModalOpen] = useState(false);\r\n    const [editingShift, setEditingShift] = useState<any | null>(null);\r\n    const [selectedDateForNew, setSelectedDateForNew] = useState<string | null>(null);\r\n    const [prefillHour, setPrefillHour] = useState<number | undefined>(undefined);\r\n    const [isQuickFillOpen, setIsQuickFillOpen] = useState(false);\r\n\r\n    // PRIME Filter Logic:\r\n    // User requested: 13:00-16:00 and 20:00-24:00\r\n    // This exactly corresponds to blocks starting at: 13, 14, 15 and 20, 21, 22, 23\r\n    const hours = useMemo(() => {\r\n        const fullDay = Array.from({ length: 24 }, (_, i) => i);\r\n        if (!showPrime) return fullDay;\r\n\r\n        return fullDay.filter(h => (h >= 13 && h < 16) || (h >= 20 && h < 24));\r\n    }, [showPrime]);\r\n\r\n    const handleQuickAdd = (dateIso: string, riderId: string, hour?: number) => {\r\n        if (readOnly) return;\r\n        const h = hour ?? 13;\r\n        const baseDate = parseISO(dateIso);\r\n        saveShift({\r\n            riderId,\r\n            startAt: toLocalISOString(setHours(baseDate, h)),\r\n            endAt: toLocalISOString(setHours(baseDate, h + 4)),\r\n            date: dateIso\r\n        });\r\n    };\r\n\r\n    const handleAddShift = (dateIso: string, _riderId?: string, hour?: number) => {\r\n        if (readOnly) return;\r\n        setEditingShift(null);\r\n        setSelectedDateForNew(dateIso);\r\n        setPrefillHour(hour);\r\n        setIsModalOpen(true);\r\n    };\r\n\r\n    const handleEditShift = (shift: any) => {\r\n        if (readOnly) return;\r\n        setEditingShift(shift);\r\n        setIsModalOpen(true);\r\n    };\r\n\r\n    const simpleRiders = useMemo(() => rosterRiders.map(r => ({ id: r.id, fullName: r.fullName, name: r.fullName })), [rosterRiders]);\r\n\r\n    if (loading) return <div className=\"p-8 text-center animate-pulse text-slate-400 font-medium\">Cargando Matrix V3...</div>;\r\n\r\n    if (isMobile) {\r\n        return <MobileAgendaView\r\n            days={days}\r\n            visualEvents={mergedShifts.reduce((acc: any, s: any) => {\r\n                const d = toLocalDateString(new Date(s.startAt));\r\n                if (!acc[d]) acc[d] = [];\r\n                acc[d].push({ ...s, visualStart: s.startAt, visualEnd: s.endAt, shiftId: s.id || s.shiftId });\r\n                return acc;\r\n            }, {})}\r\n            onEditShift={handleEditShift}\r\n            onDeleteShift={deleteShift}\r\n            onAddShift={handleAddShift}\r\n        />;\r\n    }\r\n\r\n    return (\r\n        <div className=\"flex flex-col h-full bg-white relative overflow-hidden font-sans\">\r\n            {/* --- HEADER V3 --- */}\r\n            <div className=\"bg-white/80 backdrop-blur-md border-b border-slate-100 z-30 sticky top-0\">\r\n                <div className=\"px-6 py-4 flex items-center justify-between\">\r\n                    <div className=\"flex items-center gap-6\">\r\n                        <div className=\"flex items-center gap-1\">\r\n                            <button\r\n                                onClick={() => changeWeek(-1)}\r\n                                className=\"p-2 hover:bg-slate-100 rounded-full transition-all text-slate-500\"\r\n                                aria-label=\"Semana anterior\"\r\n                                title=\"Semana anterior\"\r\n                            >\r\n                                <ChevronLeft size={20} />\r\n                            </button>\r\n                            <span className=\"px-2 text-lg font-medium text-slate-900 capitalize\">\r\n                                {format(selectedDate, 'MMMM yyyy', { locale: es })}\r\n                            </span>\r\n                            <button\r\n                                onClick={() => changeWeek(1)}\r\n                                className=\"p-2 hover:bg-slate-100 rounded-full transition-all text-slate-500\"\r\n                                aria-label=\"Semana siguiente\"\r\n                                title=\"Semana siguiente\"\r\n                            >\r\n                                <ChevronRight size={20} />\r\n                            </button>\r\n                        </div>\r\n\r\n                        <div className=\"flex bg-slate-100/50 p-1 rounded-full border border-slate-100\">\r\n                            <button onClick={() => setViewMode('day')} className={cn(\"px-4 py-1.5 text-xs font-medium rounded-full transition-all\", viewMode === 'day' ? \"bg-white text-indigo-600 shadow-sm\" : \"text-slate-500 hover:text-slate-700\")}>D√≠a</button>\r\n                            <button onClick={() => setViewMode('week')} className={cn(\"px-4 py-1.5 text-xs font-medium rounded-full transition-all\", viewMode === 'week' ? \"bg-white text-indigo-600 shadow-sm\" : \"text-slate-500 hover:text-slate-700\")}>Semana</button>\r\n                        </div>\r\n\r\n                        <button onClick={() => setShowPrime(!showPrime)} className={cn(\"px-4 py-1.5 text-xs font-medium rounded-full border transition-all flex items-center gap-2\", showPrime ? \"bg-amber-50 border-amber-200 text-amber-600 shadow-sm\" : \"bg-white border-slate-200 text-slate-500 hover:border-slate-300 shadow-sm\")}>\r\n                            <Zap size={14} className={showPrime ? \"fill-amber-500\" : \"\"} /> PRIME\r\n                        </button>\r\n                    </div>\r\n\r\n                    {!readOnly && (\r\n                        <div className=\"flex items-center gap-3\">\r\n                            <button\r\n                                onClick={handleAuditoria}\r\n                                disabled={isAuditing}\r\n                                className={`\r\n                                flex items-center gap-1.5 px-3 py-1.5 rounded-full transition-all text-xs font-bold shadow-sm hover:shadow-md active:scale-95 border backdrop-blur-sm\r\n                                ${sheriffResult ? (sheriffResult.status === 'optimal' ? 'bg-emerald-50/80 text-emerald-700 border-emerald-200' : 'bg-amber-50/80 text-amber-700 border-amber-200') : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'}\r\n                            `}\r\n                            >\r\n                                {isAuditing ? <div className=\"animate-spin w-3 h-3 border-2 border-indigo-500 border-t-transparent rounded-full\" /> : <BadgeCheck className=\"w-4 h-4\" />}\r\n                                {sheriffResult ? `Sheriff: ${sheriffResult.score}/100` : 'Auditar'}\r\n                            </button>\r\n\r\n                            <div className=\"flex items-center gap-1 p-0.5 bg-slate-100/50 rounded-full border border-slate-200\">\r\n                                <button onClick={() => setIsQuickFillOpen(true)} className=\"px-3 py-1.5 text-slate-600 hover:text-indigo-600 hover:bg-white rounded-full transition-all text-xs font-medium flex items-center gap-2\">\r\n                                    <Zap size={14} className=\"fill-slate-300\" /> Relleno\r\n                                </button>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            {/* SHERIFF VISUAL OVERLAY */}\r\n            {sheriffResult && (\r\n                <div className=\"absolute top-[80px] right-6 z-50 w-80 animate-in slide-in-from-right-10 fade-in duration-300 pointer-events-auto\">\r\n                    <div className={`\r\n                        p-4 rounded-xl shadow-2xl border backdrop-blur-md\r\n                        ${sheriffResult.status === 'optimal'\r\n                            ? 'bg-emerald-50/90 border-emerald-200 text-emerald-900'\r\n                            : sheriffResult.status === 'critical'\r\n                                ? 'bg-rose-50/90 border-rose-200 text-rose-900'\r\n                                : 'bg-amber-50/90 border-amber-200 text-amber-900'\r\n                        }\r\n                    `}>\r\n                        <div className=\"flex justify-between items-start mb-2\">\r\n                            <div className=\"flex items-center gap-2\">\r\n                                {sheriffResult.status === 'optimal'\r\n                                    ? <ShieldCheck className=\"w-6 h-6 text-emerald-600\" />\r\n                                    : <AlertTriangle className=\"w-6 h-6\" />\r\n                                }\r\n                                <div>\r\n                                    <h3 className=\"font-black text-sm uppercase tracking-wider\">Reporte del Sheriff</h3>\r\n                                    <span className=\"text-xs font-bold opacity-80\">Puntuaci√≥n: {sheriffResult.score}/100</span>\r\n                                </div>\r\n                            </div>\r\n                            <button onClick={() => setSheriffResult(null)} className=\"opacity-50 hover:opacity-100\" title=\"Cerrar reporte\">\r\n                                <XCircle className=\"w-5 h-5\" />\r\n                            </button>\r\n                        </div>\r\n\r\n                        <p className=\"text-xs font-medium mb-3 leading-relaxed\">\r\n                            &quot;{sheriffResult.feedback}&quot;\r\n                        </p>\r\n\r\n                        {sheriffResult.missingCoverage.length > 0 && (\r\n                            <div className=\"bg-white/50 rounded-lg p-2 text-[10px] font-mono mb-2\">\r\n                                <strong className=\"block mb-1 opacity-70\">ALERTAS DE COBERTURA:</strong>\r\n                                <ul className=\"list-disc pl-4 space-y-0.5\">\r\n                                    {sheriffResult.missingCoverage.map((item, i) => (\r\n                                        <li key={i}>{item}</li>\r\n                                    ))}\r\n                                </ul>\r\n                            </div>\r\n                        )}\r\n\r\n                        {sheriffResult.status !== 'optimal' && (\r\n                            <button\r\n                                onClick={handleAutoFix}\r\n                                disabled={isFixing}\r\n                                className=\"w-full mt-2 bg-indigo-600 hover:bg-indigo-700 text-white py-1.5 rounded-lg text-xs font-bold shadow-md active:scale-95 transition-all flex items-center justify-center gap-2\"\r\n                            >\r\n                                {isFixing ? 'Corrigiendo...' : (\r\n                                    <>\r\n                                        <Wand2 className=\"w-3 h-3\" />\r\n                                        Corregir con IA\r\n                                    </>\r\n                                )}\r\n                            </button>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            <div className=\"flex-1 overflow-auto bg-white\">\r\n                <table className=\"w-full border-collapse table-fixed\">\r\n                    <thead className=\"sticky top-0 z-20 bg-slate-50/80 backdrop-blur-sm shadow-[0_1px_0_0_rgba(0,0,0,0.05)]\">\r\n                        <tr>\r\n                            <th className=\"w-64 p-4 text-left border-r border-slate-50 bg-white sticky left-0 z-40 text-[10px] uppercase font-bold tracking-widest text-slate-400\">Personal</th>\r\n                            {viewMode === 'week' ? days.map(d => (\r\n                                <th key={d.isoDate} className={cn(\"p-3 text-center transition-colors hover:bg-slate-50/50\", d.isoDate === toLocalDateString(new Date()) && \"bg-indigo-50\")}>\r\n                                    <div className=\"flex flex-col items-center gap-1\">\r\n                                        <span className=\"text-[10px] text-slate-400 font-bold uppercase tracking-tighter\">{d.shortLabel}</span>\r\n                                        <span className={cn(\"text-base font-medium w-8 h-8 flex items-center justify-center rounded-full\", d.isoDate === toLocalDateString(new Date()) ? \"bg-indigo-600 text-white shadow-md shadow-indigo-100\" : \"text-slate-700\")}>{format(d.date, 'd')}</span>\r\n                                    </div>\r\n                                </th>\r\n                            )) : hours.map(h => (\r\n                                <th key={h} className={cn(\"p-0 text-center text-[10px] font-bold tracking-tighter border-r border-dashed border-slate-100 relative h-10 align-middle transition-colors\", showPrime && ((h >= 13 && h <= 15) || (h >= 20 && h <= 23)) ? \"bg-amber-50/80 text-amber-600\" : \"text-slate-400/80\")}>\r\n                                    <span className=\"z-10 relative\">{h}:00</span>\r\n                                    {viewingToday && currentTime.getHours() === h && (\r\n                                        <div\r\n                                            className=\"absolute top-2 w-3 h-3 bg-red-500 rounded-full shadow-sm z-50 -translate-x-1/2\"\r\n                                            style={{ left: `calc(${(currentTime.getMinutes() / 60) * 100} * 1%)` } as any}\r\n                                        />\r\n                                    )}\r\n                                </th>\r\n                            ))}\r\n                        </tr>\r\n                    </thead>\r\n                    <tbody>\r\n                        {ridersGrid.map(rider => (\r\n                            <tr key={rider.id} className=\"border-b border-slate-50 hover:bg-slate-50 transition-colors group\">\r\n                                <td className=\"p-4 border-r border-slate-100 bg-white sticky left-0 z-30 shadow-[4px_0_12px_-4px_rgba(0,0,0,0.03)]\">\r\n                                    <div className=\"flex items-center gap-4\">\r\n                                        <div className={cn(\"w-11 h-11 rounded-2xl flex items-center justify-center text-sm font-bold text-white shadow-lg\", getRiderColor(rider.id).bg)}>\r\n                                            {getRiderInitials(rider.fullName)}\r\n                                        </div>\r\n                                        <div className=\"flex-1 min-w-0\">\r\n                                            <p className=\"text-sm font-semibold text-slate-900 truncate tracking-tight\">{rider.fullName}</p>\r\n                                            <div className=\"mt-1.5\">\r\n                                                <div className=\"flex justify-between text-[9px] font-bold uppercase mb-1\">\r\n                                                    <span className={rider.totalWeeklyHours < (rider.contractHours * 0.5) ? \"text-amber-500\" : rider.totalWeeklyHours <= rider.contractHours ? \"text-emerald-500\" : \"text-rose-500\"}>\r\n                                                        {rider.totalWeeklyHours < (rider.contractHours * 0.5) ? \"Carga Parcial\" : rider.totalWeeklyHours <= rider.contractHours ? \"Optimizado\" : \"Saturaci√≥n\"}\r\n                                                    </span>\r\n                                                    <span className=\"text-slate-400 tabular-nums\">{rider.totalWeeklyHours.toFixed(1)} / {rider.contractHours}h</span>\r\n                                                </div>\r\n                                                <div className=\"h-1.5 bg-slate-100 rounded-full overflow-hidden border border-slate-50\">\r\n                                                    <div\r\n                                                        className={cn(\"h-full transition-all duration-500\", rider.totalWeeklyHours < (rider.contractHours * 0.5) ? \"bg-amber-400\" : rider.totalWeeklyHours <= rider.contractHours ? \"bg-emerald-500\" : \"bg-rose-500\")}\r\n                                                        style={{ width: `calc(${Math.min((rider.totalWeeklyHours / rider.contractHours) * 100, 100)} * 1%)` } as any}\r\n                                                    />\r\n                                                </div>\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n                                </td>\r\n                                {viewMode === 'week' ? days.map(d => {\r\n                                    const dayShifts = rider.shifts.filter((s: any) => toLocalDateString(new Date(s.startAt)) === d.isoDate);\r\n                                    return (\r\n                                        <td key={d.isoDate} className={cn(\"p-2 align-top relative cursor-crosshair group/cell hover:bg-slate-50/30\", coverage[d.isoDate]?.some(c => c < 4) ? \"bg-rose-500/[0.02]\" : \"\", d.isoDate === toLocalDateString(new Date()) && \"bg-indigo-50\")} onClick={() => handleQuickAdd(d.isoDate, rider.id)} onDoubleClick={() => handleAddShift(d.isoDate, rider.id)}>\r\n                                            <div className=\"flex flex-col gap-1.5\">\r\n                                                {dayShifts.map((s: any) => {\r\n                                                    const sStart = new Date(s.startAt);\r\n                                                    const sEnd = new Date(s.endAt);\r\n                                                    const isExpress = (differenceInMinutes(sEnd, sStart) / 60) < 3;\r\n\r\n                                                    if (s.isDraft) {\r\n                                                        return (\r\n                                                            <div key={s.id} onClick={(e) => { e.stopPropagation(); handleEditShift(s); }} className=\"px-2.5 py-2 rounded-xl bg-white/50 border-2 border-dashed border-indigo-200 text-indigo-500 text-[10px] font-medium shadow-sm transition-all hover:scale-[1.02] active:scale-95 cursor-pointer flex items-center justify-between\">\r\n                                                                <span className=\"truncate\">{format(sStart, 'HH:mm')} - {format(sEnd, 'HH:mm')}</span>\r\n                                                                <Clock size={10} className=\"animate-spin-slow opacity-40\" />\r\n                                                            </div>\r\n                                                        );\r\n                                                    }\r\n\r\n                                                    return (\r\n                                                        <div key={s.id} onClick={(e) => { e.stopPropagation(); handleEditShift(s); }} className={cn(\"px-2.5 py-2 rounded-md shadow-sm ring-1 ring-black/5 text-[10px] font-medium text-white transition-all hover:scale-[1.02] hover:shadow-md cursor-pointer flex items-center justify-between gap-1\",\r\n                                                            s.changeRequested ? \"bg-gradient-to-r from-amber-500 to-amber-600 border-amber-400/50 shadow-amber-500/20\" :\r\n                                                                s.isConfirmed ? \"bg-gradient-to-r from-emerald-500 to-emerald-600 border-emerald-400/50 shadow-emerald-500/20\" :\r\n                                                                    sStart.getHours() < 15 ? \"bg-gradient-to-br from-emerald-500 to-teal-400 opacity-90\" : \"bg-gradient-to-br from-indigo-600 to-blue-500 opacity-90\"\r\n                                                        )}>\r\n                                                            <span className=\"whitespace-nowrap tracking-tighter\">{format(sStart, 'HH:mm')} - {format(sEnd, 'HH:mm')}</span>\r\n                                                            <div className=\"flex items-center gap-1\">\r\n                                                                {s.changeRequested && <div title=\"Solicitud de cambio\" className=\"animate-pulse\"><Zap size={10} className=\"fill-white text-white\" /></div>}\r\n                                                                {s.isConfirmed && !s.changeRequested && <div title=\"Confirmado\" className=\"bg-white/20 rounded-full p-0.5\"><Zap size={8} className=\"fill-white text-white\" /></div>}\r\n                                                                {isExpress && <Zap size={10} className=\"fill-white/20 border-none\" />}\r\n                                                            </div>\r\n                                                        </div>\r\n                                                    );\r\n                                                })}\r\n                                            </div>\r\n                                        </td>\r\n                                    );\r\n                                }) : (\r\n                                    <td className=\"p-0 relative h-16 bg-white\" colSpan={hours.length}>\r\n                                        <div className=\"absolute inset-0 flex\">\r\n                                            {hours.map(h => (\r\n                                                <div key={h} className={cn(\"flex-1 border-r border-slate-100/50 relative cursor-crosshair transition-colors\", showPrime && ((h >= 13 && h <= 15) || (h >= 20 && h <= 23)) ? \"bg-amber-100/30\" : \"hover:bg-slate-50/30\")} onClick={() => handleQuickAdd(toLocalDateString(selectedDate), rider.id, h)} onDoubleClick={() => handleAddShift(toLocalDateString(selectedDate), rider.id, h)}>\r\n                                                    {rider.shifts.filter((shift: any) => {\r\n                                                        const sStart = new Date(shift.startAt);\r\n                                                        const sEnd = new Date(shift.endAt);\r\n                                                        if (toLocalDateString(sStart) !== toLocalDateString(selectedDate)) return false;\r\n                                                        const start = sStart.getHours();\r\n                                                        const end = sEnd.getHours();\r\n                                                        const endM = sEnd.getMinutes();\r\n                                                        const realEnd = (end === 0 && endM === 0) ? 24 : end;\r\n                                                        return h >= start && h < realEnd;\r\n                                                    }).map((shift: any) => {\r\n                                                        const sStart = new Date(shift.startAt);\r\n                                                        const isStart = sStart.getHours() === h;\r\n                                                        const isDraft = shift.isDraft;\r\n\r\n                                                        return (\r\n                                                            <div\r\n                                                                key={shift.id}\r\n                                                                onClick={(e) => { e.stopPropagation(); handleEditShift(shift); }}\r\n                                                                className={cn(\r\n                                                                    \"absolute top-0 h-full w-[calc(100%+1px)] -right-[0.5px] z-10 flex items-center select-none transition-all cursor-pointer shadow-sm border-t border-white/20\",\r\n                                                                    isStart ? \"rounded-l-lg pl-2\" : \"rounded-l-none\",\r\n                                                                    (new Date(shift.endAt).getHours() === h + 1 || (new Date(shift.endAt).getHours() === 0 && h === 23)) ? \"rounded-r-lg\" : \"rounded-r-none\",\r\n                                                                    isDraft\r\n                                                                        ? \"bg-white border-2 border-dashed border-indigo-400 text-indigo-600 z-20\"\r\n                                                                        : shift.changeRequested ? \"bg-gradient-to-r from-amber-500 to-amber-600 border-amber-400\" :\r\n                                                                            shift.isConfirmed ? \"bg-gradient-to-r from-emerald-500 to-emerald-600 border-emerald-400 shadow-md ring-1 ring-white/30\" :\r\n                                                                                (sStart.getHours() < 15 ? \"bg-gradient-to-b from-emerald-400 to-emerald-500 text-white\" : \"bg-gradient-to-b from-blue-500 to-blue-600 text-white\")\r\n                                                                )}\r\n                                                            >\r\n                                                                {isStart && (\r\n                                                                    <span className=\"text-[10px] font-medium tracking-tight whitespace-nowrap overflow-visible z-20 text-white/90 drop-shadow-sm\">\r\n                                                                        {format(sStart, 'HH:mm')} - {format(new Date(shift.endAt), 'HH:mm')}\r\n                                                                    </span>\r\n                                                                )}\r\n                                                            </div>\r\n                                                        );\r\n                                                    })}\r\n                                                </div>\r\n                                            ))}\r\n                                            {viewingToday && (\r\n                                                <div\r\n                                                    className=\"absolute top-0 bottom-0 border-l-[2px] border-red-500 z-50 pointer-events-none transition-all\"\r\n                                                    style={{ left: `calc(${redLinePosition} * 1%)` } as any}\r\n                                                />\r\n                                            )}\r\n                                        </div>\r\n                                    </td>\r\n                                )}\r\n                            </tr>\r\n                        ))}\r\n                    </tbody>\r\n                </table>\r\n            </div>\r\n\r\n            <div className=\"bg-white border-t border-slate-100 px-8 py-4 flex items-center gap-8 shadow-[0_-4px_12px_-4px_rgba(0,0,0,0.02)] z-30\">\r\n                <span className=\"text-[10px] font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2\">\r\n                    <div className=\"w-1.5 h-1.5 rounded-full bg-emerald-500\" /> Cobertura M√≠nima\r\n                </span>\r\n                <div className=\"flex-1 flex gap-3\">\r\n                    {days.map(d => {\r\n                        const min = Math.min(...(coverage[d.isoDate] || []));\r\n                        return (\r\n                            <div key={d.isoDate} className=\"flex-1 h-2 rounded-full bg-slate-100 overflow-hidden relative group/foot transition-all hover:h-2.5\">\r\n                                <div className={cn(\"h-full transition-all duration-700\", min < 4 ? \"bg-amber-400 shadow-[0_0_8px_rgba(251,191,36,0.3)]\" : \"bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.3)]\")} style={{ width: `${Math.min((min / 4) * 100, 100)}%` }} />\r\n                                <div className=\"absolute -top-10 left-1/2 -translate-x-1/2 bg-slate-900 text-white text-[10px] px-2 py-1.5 rounded-xl opacity-0 group-hover/foot:opacity-100 pointer-events-none transition-all scale-95 group-hover/foot:scale-100 shadow-xl whitespace-nowrap\">\r\n                                    <span className=\"font-bold\">{min}/4</span> riders activos en {d.shortLabel}\r\n                                </div>\r\n                            </div>\r\n                        );\r\n                    })}\r\n                </div>\r\n            </div>\r\n\r\n            {isModalOpen && (\r\n                <ShiftModal\r\n                    isOpen={isModalOpen}\r\n                    onClose={() => setIsModalOpen(false)}\r\n                    onSave={saveShift}\r\n                    onDelete={deleteShift}\r\n                    initialData={editingShift}\r\n                    selectedDate={selectedDateForNew || toLocalDateString(selectedDate)}\r\n                    prefillHour={prefillHour}\r\n                    riders={simpleRiders}\r\n                    motos={vehicles.map(v => ({ id: (v.id || 'none') as string, licensePlate: (v.matricula || '') as string, model: (v.modelo || '') as string }))}\r\n                />\r\n            )}\r\n\r\n            {isQuickFillOpen && (\r\n                <QuickFillModal\r\n                    isOpen={isQuickFillOpen}\r\n                    onClose={() => setIsQuickFillOpen(false)}\r\n                    onRefresh={() => { }}\r\n                    franchiseId={safeFranchiseId}\r\n                    riders={simpleRiders}\r\n                    motos={motos}\r\n                    weekDays={days}\r\n                    existingShifts={mergedShifts}\r\n                />\r\n            )}\r\n\r\n            {hasUnsavedChanges && (\r\n                <div className=\"fixed bottom-28 right-10 z-[60] animate-in zoom-in-95 slide-in-from-bottom-5\">\r\n                    <button\r\n                        onClick={handlePublish}\r\n                        disabled={isPublishing}\r\n                        className=\"flex items-center gap-4 px-8 py-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full font-medium shadow-[0_20px_40px_-10px_rgba(79,70,229,0.4)] hover:scale-105 active:scale-95 transition-all disabled:opacity-50 ring-8 ring-indigo-50\"\r\n                    >\r\n                        {isPublishing ? <Loader2 size={24} className=\"animate-spin\" /> : <Save size={20} />}\r\n                        <div className=\"flex flex-col items-start leading-tight\">\r\n                            <span className=\"text-sm\">Publicar Horario</span>\r\n                            <span className=\"text-[10px] opacity-70 italic\">{localShifts.length + deletedIds.size} cambios pendientes</span>\r\n                        </div>\r\n                    </button>\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default DeliveryScheduler;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\scheduler\\components\\CoverageFooter.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\scheduler\\components\\OpsIntelligenceBar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\scheduler\\components\\SchedulerEmptyState.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\scheduler\\components\\SchedulerSidebar.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":15,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":15,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[544,547],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[544,547],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\nimport { Bike, Clock } from 'lucide-react';\r\nimport { Rider, Shift } from '../../../hooks/useWeeklySchedule';\r\n\r\ninterface SchedulerSidebarProps {\r\n    riders: Rider[];\r\n    searchQuery: string;\r\n    shifts: Shift[];\r\n}\r\n\r\nexport const SchedulerSidebar: React.FC<SchedulerSidebarProps> = ({ riders, searchQuery, shifts }) => {\r\n    // Mock Zone Grouping for Visual Demo\r\n    // In real app, this would come from rider.zoneId\r\n    const groupedRiders = riders.reduce((acc, rider) => {\r\n        const zone = (rider as any).zone || 'Zona Centro'; // Fallback\r\n        if (!acc[zone]) acc[zone] = [];\r\n        acc[zone].push(rider);\r\n        return acc;\r\n    }, {} as Record<string, Rider[]>);\r\n\r\n    const getRiderMetrics = (rider: Rider) => {\r\n        const riderShifts = shifts.filter(s => s.riderId === rider.id);\r\n        const scheduledHours = riderShifts.reduce((acc, s) => {\r\n            const start = new Date(s.startAt).getTime();\r\n            const end = new Date(s.endAt).getTime();\r\n            return acc + ((end - start) / (1000 * 60 * 60));\r\n        }, 0);\r\n\r\n        const contractHours = rider.contractHours || 40; // Use dynamic contract hours\r\n        const remaining = Math.max(0, contractHours - scheduledHours);\r\n\r\n        return { scheduledHours, contractHours, remaining };\r\n    };\r\n\r\n    const getRiderColor = (id: string, name: string) => {\r\n        let hash = 0;\r\n        const str = id + name;\r\n        for (let i = 0; i < str.length; i++) {\r\n            hash = str.charCodeAt(i) + ((hash << 5) - hash);\r\n        }\r\n        const h = Math.abs(hash) % 360;\r\n        return `hsl(${h}, 70%, 45%)`; // Consistent with Scheduler\r\n    };\r\n\r\n    return (\r\n        <div className=\"w-64 bg-white border-r border-slate-200 flex flex-col shrink-0 z-20 shadow-[4px_0_24px_rgba(0,0,0,0.02)]\">\r\n            {/* Header / Search Mock (Handled in Parent usually, but pure visual here) */}\r\n            <div className=\"h-14 border-b border-slate-100 flex items-center px-4 font-bold text-slate-700 text-sm\">\r\n                Equipo ({riders.length})\r\n            </div>\r\n\r\n            <div className=\"flex-1 overflow-y-auto custom-scrollbar pb-20\"> {/* pb-20 for sticky footer space */}\r\n                {Object.entries(groupedRiders).map(([zone, zoneRiders]) => (\r\n                    <div key={zone}>\r\n                        <div className=\"px-4 py-2 bg-slate-50 text-[10px] font-bold uppercase tracking-wider text-slate-400 border-y border-slate-100 sticky top-0 z-10\">\r\n                            {zone}\r\n                        </div>\r\n                        {zoneRiders\r\n                            .filter(r => r.fullName.toLowerCase().includes(searchQuery.toLowerCase()))\r\n                            .map(rider => {\r\n                                const { remaining, contractHours, scheduledHours } = getRiderMetrics(rider);\r\n                                const isOvertime = scheduledHours > contractHours;\r\n                                const riderColor = getRiderColor(rider.id, rider.fullName);\r\n\r\n                                return (\r\n                                    <div\r\n                                        key={rider.id}\r\n                                        className=\"h-16 border-b border-slate-50 flex items-center px-4 hover:bg-slate-50 transition-colors cursor-pointer group\"\r\n                                    >\r\n                                        <div\r\n                                            className=\"w-9 h-9 rounded-full flex items-center justify-center text-white font-bold text-xs shadow-sm ring-2 ring-white group-hover:ring-indigo-100 transition-all\"\r\n                                            style={{ backgroundColor: riderColor }}\r\n                                        >\r\n                                            {rider.fullName.substring(0, 2).toUpperCase()}\r\n                                        </div>\r\n                                        <div className=\"ml-3 flex-1 min-w-0\">\r\n                                            <div className=\"text-sm font-semibold text-slate-700 truncate\">\r\n                                                {rider.fullName}\r\n                                            </div>\r\n                                            <div className=\"flex items-center gap-2 mt-0.5\">\r\n                                                <span className=\"flex items-center gap-1 text-[10px] text-slate-400 bg-slate-100 px-1.5 py-0.5 rounded\">\r\n                                                    <Bike size={10} />\r\n                                                    <span>Moto Propia</span>\r\n                                                </span>\r\n                                                <span className={`text-[10px] font-medium flex items-center gap-1 ${isOvertime ? 'text-amber-600' : 'text-emerald-600'}`}>\r\n                                                    <Clock size={10} />\r\n                                                    {remaining}h restan\r\n                                                </span>\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n                                )\r\n                            })}\r\n                    </div>\r\n                ))}\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\support\\SupportService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\user\\UserProfile.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":56,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":56,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2359,2362],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2359,2362],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, Suspense, lazy, type FC, useRef } from 'react';\r\nimport { User, Lock, Bell, LogOut, CheckCircle, AlertTriangle, Camera, Mail, Sparkles, LayoutDashboard } from 'lucide-react'; import { useAuth } from '../../context/AuthContext';\r\nimport Button from '../../ui/inputs/Button';\r\nimport { updateProfile } from 'firebase/auth';\r\nimport { ref, uploadBytes, getDownloadURL } from 'firebase/storage';\r\nimport { doc, setDoc } from 'firebase/firestore';\r\nimport { db, storage } from '../../lib/firebase';\r\n\r\n// Sub-components\r\nimport ProfileTab from './components/ProfileTab';\r\nimport SecurityTab from './components/SecurityTab';\r\nimport NotificationsTab from './components/NotificationsTab';\r\nimport AdminTab from './components/AdminTab';\r\n\r\n// Lazy load heavy components\r\nconst FranchiseProfile = lazy(() => import('../admin/settings/FranchiseProfile'));\r\n\r\ninterface UserProfileProps {\r\n    setViewMode?: (mode: string) => void;\r\n}\r\n\r\nconst UserProfile: FC<UserProfileProps> = ({ setViewMode }) => {\r\n    const { user, roleConfig, logout } = useAuth();\r\n    const [activeTab, setActiveTab] = useState('profile');\r\n    const [message, setMessage] = useState({ type: '', text: '' });\r\n    const [isLoadingAvatar, setIsLoadingAvatar] = useState(false);\r\n    const fileInputRef = useRef<HTMLInputElement>(null);\r\n\r\n    const showMessage = (type: string, text: string) => {\r\n        setMessage({ type, text });\r\n        setTimeout(() => setMessage({ type: '', text: '' }), 5000);\r\n    };\r\n\r\n    const isAdmin = roleConfig?.role === 'admin';\r\n\r\n    // --- AVATAR UPLOAD LOGIC ---\r\n    const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {\r\n        const file = e.target.files?.[0];\r\n        if (!file || !user) return;\r\n\r\n        setIsLoadingAvatar(true);\r\n        try {\r\n            const storageRef = ref(storage, `avatars/${user.uid}`);\r\n            await uploadBytes(storageRef, file);\r\n            const downloadURL = await getDownloadURL(storageRef);\r\n\r\n            // 1. Update Auth\r\n            await updateProfile(user, { photoURL: downloadURL });\r\n\r\n            // 2. Update Firestore\r\n            await setDoc(doc(db, \"users\", user.uid), {\r\n                photoURL: downloadURL\r\n            }, { merge: true });\r\n\r\n            showMessage('success', 'Avatar actualizado correctamente');\r\n        } catch (error: any) {\r\n            console.error(\"Error uploading avatar:\", error);\r\n            showMessage('error', 'Error al subir la imagen');\r\n        } finally {\r\n            setIsLoadingAvatar(false);\r\n        }\r\n    };\r\n\r\n    if (!user) {\r\n        return (\r\n            <div className=\"min-h-screen flex items-center justify-center bg-slate-50\">\r\n                <div className=\"animate-pulse flex flex-col items-center gap-4\">\r\n                    <div className=\"h-12 w-12 bg-indigo-100 rounded-full\"></div>\r\n                    <div className=\"text-slate-400 font-medium\">Cargando perfil...</div>\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    const handleLogout = () => {\r\n        if (window.confirm('¬øEst√°s seguro de que deseas cerrar sesi√≥n?')) {\r\n            logout();\r\n        }\r\n    };\r\n\r\n    // --- UNIFIED VIEW FOR FRANCHISE ---\r\n    if (roleConfig?.role === 'franchise') {\r\n        return (\r\n            <div className=\"h-[calc(100vh-64px)] overflow-hidden bg-slate-50\">\r\n                <Suspense fallback={<div className=\"p-10 flex items-center justify-center text-slate-400\">Cargando perfil unificado...</div>}>\r\n                    <FranchiseProfile />\r\n                </Suspense>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    // --- PRO DESIGN: MESH GRADIENT & GLASS STRUCTURE ---\r\n    return (\r\n        <div className=\"relative min-h-[calc(100vh-64px)] overflow-hidden bg-slate-50/50\">\r\n            {/* Dynamic Background Mesh */}\r\n            <div className=\"absolute inset-0 z-0 overflow-hidden pointer-events-none\">\r\n                <div className=\"absolute top-[-10%] right-[-5%] w-[500px] h-[500px] bg-indigo-500/10 rounded-full blur-[100px] animate-pulse\" />\r\n                <div className=\"absolute bottom-[-10%] left-[-10%] w-[600px] h-[600px] bg-blue-500/10 rounded-full blur-[120px] animate-pulse delay-1000\" />\r\n                <div className=\"absolute top-[20%] left-[30%] w-[300px] h-[300px] bg-purple-500/5 rounded-full blur-[80px]\" />\r\n            </div>\r\n\r\n            {/* Feedback Toast */}\r\n            {message.text && (\r\n                <div className={`fixed top-24 right-8 z-50 px-6 py-4 rounded-xl shadow-2xl flex items-center animate-in slide-in-from-right duration-300 backdrop-blur-md border ${message.type === 'error' ? 'bg-rose-500/90 text-white border-rose-400' : 'bg-emerald-500/90 text-white border-emerald-400'}`}>\r\n                    {message.type === 'error' ? <AlertTriangle className=\"w-5 h-5 mr-3\" /> : <CheckCircle className=\"w-5 h-5 mr-3\" />}\r\n                    <span className=\"font-bold\">{message.text}</span>\r\n                </div>\r\n            )}\r\n\r\n            <div className=\"relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 h-full flex flex-col gap-8\">\r\n\r\n                {/* --- HERO SECTION --- */}\r\n                <div className=\"relative isolate\">\r\n                    <div className=\"flex flex-col md:flex-row items-center md:items-end gap-8 pb-8\">\r\n                        {/* Avatar Container with Glow */}\r\n                        <div className=\"relative group perspective-1000\">\r\n                            <div className=\"absolute -inset-1 bg-gradient-to-tr from-indigo-500 to-purple-500 rounded-full blur opacity-25 group-hover:opacity-50 transition duration-500\"></div>\r\n                            <div\r\n                                className=\"relative w-36 h-36 rounded-full border-4 border-white shadow-2xl overflow-hidden bg-white cursor-pointer group-hover:scale-[1.02] transition-all duration-300 ease-out\"\r\n                                onClick={() => fileInputRef.current?.click()}\r\n                            >\r\n                                {user.photoURL ? (\r\n                                    <img src={user.photoURL} alt=\"Avatar\" className=\"w-full h-full object-cover\" />\r\n                                ) : (\r\n                                    <div className=\"w-full h-full flex items-center justify-center bg-slate-100 text-4xl font-black text-slate-300\">\r\n                                        {user.email?.charAt(0).toUpperCase()}\r\n                                    </div>\r\n                                )}\r\n                                <div className=\"absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all duration-300 backdrop-blur-[2px]\">\r\n                                    {isLoadingAvatar ?\r\n                                        <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-white\"></div> :\r\n                                        <Camera className=\"w-8 h-8 text-white drop-shadow-md transform group-hover:scale-110 transition-transform\" />\r\n                                    }\r\n                                </div>\r\n                            </div>\r\n                            <input\r\n                                type=\"file\"\r\n                                ref={fileInputRef}\r\n                                className=\"hidden\"\r\n                                accept=\"image/*\"\r\n                                title=\"Subir avatar\"\r\n                                onChange={handleFileChange}\r\n                            />\r\n                            {/* Status Indicator */}\r\n                            <div className=\"absolute bottom-2 right-2 w-6 h-6 bg-emerald-500 border-4 border-white rounded-full shadow-lg\" title=\"Online\"></div>\r\n                        </div>\r\n\r\n                        {/* User Identity */}\r\n                        <div className=\"flex-1 text-center md:text-left space-y-2\">\r\n                            <div className=\"inline-flex items-center gap-2 px-3 py-1 rounded-full bg-indigo-50 border border-indigo-100/50 backdrop-blur-sm shadow-sm mb-2\">\r\n                                <Sparkles className=\"w-3.5 h-3.5 text-indigo-500\" />\r\n                                <span className=\"text-xs font-bold text-indigo-700 uppercase tracking-widest\">\r\n                                    {roleConfig?.role === 'admin' ? 'Administrador Global' : 'Franquiciado'}\r\n                                </span>\r\n                            </div>\r\n                            <h1 className=\"text-4xl md:text-5xl font-black text-slate-800 tracking-tight\">\r\n                                {user.displayName || 'Usuario'}\r\n                            </h1>\r\n                            <div className=\"flex items-center justify-center md:justify-start gap-4 text-slate-500 font-medium\">\r\n                                <div className=\"flex items-center gap-2 bg-white/50 px-3 py-1 rounded-lg border border-slate-200/50\">\r\n                                    <Mail className=\"w-4 h-4 text-slate-400\" />\r\n                                    <span>{user.email}</span>\r\n                                </div>\r\n                                <span className=\"hidden md:inline text-slate-300\">|</span>\r\n                                <div className=\"text-sm text-slate-400\">\r\n                                    ID: <span className=\"font-mono\">{user.uid.slice(0, 8)}...</span>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Actions */}\r\n                        <div className=\"flex items-center gap-3\">\r\n                            <Button\r\n                                variant=\"secondary\"\r\n                                onClick={handleLogout}\r\n                                icon={LogOut}\r\n                                className=\"bg-white/80 hover:bg-white text-rose-600 border-white shadow-sm hover:shadow-md backdrop-blur-sm transition-all\"\r\n                            >\r\n                                Cerrar Sesi√≥n\r\n                            </Button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* --- FLOATING TAB DOCK --- */}\r\n                <div className=\"sticky top-0 z-30 pt-2 pb-6 -mx-4 px-4 bg-gradient-to-b from-slate-50/50 via-slate-50/80 to-transparent backdrop-blur-[1px]\">\r\n                    <div className=\"bg-white/70 backdrop-blur-xl border border-white/40 shadow-xl shadow-slate-200/40 rounded-2xl p-1.5 flex items-center gap-1 max-w-fit mx-auto md:mx-0\">\r\n                        <TabButton\r\n                            active={activeTab === 'profile'}\r\n                            onClick={() => setActiveTab('profile')}\r\n                            icon={User}\r\n                            label=\"Perfil\"\r\n                        />\r\n                        <TabButton\r\n                            active={activeTab === 'security'}\r\n                            onClick={() => setActiveTab('security')}\r\n                            icon={Lock}\r\n                            label=\"Seguridad\"\r\n                        />\r\n                        <TabButton\r\n                            active={activeTab === 'notifications'}\r\n                            onClick={() => setActiveTab('notifications')}\r\n                            icon={Bell}\r\n                            label=\"Alertas\"\r\n                        />\r\n                        {isAdmin && (\r\n                            <>\r\n                                <div className=\"w-px h-6 bg-slate-200 mx-1\"></div>\r\n                                <TabButton\r\n                                    active={activeTab === 'admin'}\r\n                                    onClick={() => setActiveTab('admin')}\r\n                                    icon={LayoutDashboard}\r\n                                    label=\"GESTI√ìN DE FRANQUICIAS\"\r\n                                />\r\n                            </>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n\r\n                {/* --- CONTENT AREA (Clean Apple Card) --- */}\r\n                <div className=\"relative min-h-[500px]\">\r\n                    <div className=\"bg-white border border-slate-200 rounded-2xl shadow-sm p-6 md:p-10 animate-in fade-in slide-in-from-bottom-8 duration-500 ease-out\">\r\n\r\n                        {activeTab === 'profile' && (\r\n                            <ProfileTab\r\n                                user={user}\r\n                                roleConfig={roleConfig || undefined}\r\n                                isAdmin={isAdmin}\r\n                                showMessage={showMessage}\r\n                            />\r\n                        )}\r\n\r\n                        {activeTab === 'security' && (\r\n                            <SecurityTab\r\n                                user={user}\r\n                                logout={logout}\r\n                                showMessage={showMessage}\r\n                            />\r\n                        )}\r\n\r\n                        {activeTab === 'notifications' && (\r\n                            <NotificationsTab\r\n                                user={user}\r\n                                showMessage={showMessage}\r\n                            />\r\n                        )}\r\n\r\n                        {isAdmin && activeTab === 'admin' && (\r\n                            <AdminTab setViewMode={setViewMode || (() => { })} />\r\n                        )}\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\n// --- HELPER COMPONENTS ---\r\n\r\ninterface TabButtonProps {\r\n    active: boolean;\r\n    onClick: () => void;\r\n    icon: React.ElementType;\r\n    label: string;\r\n}\r\n\r\nconst TabButton = ({ active, onClick, icon: Icon, label }: TabButtonProps) => {\r\n\r\n\r\n    // Clean Apple Style Buttons\r\n    return (\r\n        <button\r\n            onClick={onClick}\r\n            className={`\r\n                relative flex items-center gap-2 px-4 py-2 rounded-lg text-xs font-medium transition-all duration-200\r\n                ${active\r\n                    ? 'bg-slate-900 text-white shadow-sm'\r\n                    : 'text-slate-500 hover:text-slate-900 hover:bg-slate-100'\r\n                }\r\n            `}\r\n        >\r\n            <Icon className={`w-3.5 h-3.5 ${active ? 'text-white' : 'text-slate-400'}`} />\r\n            {label}\r\n        </button>\r\n    );\r\n};\r\n\r\nexport default UserProfile;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\user\\UserProfileModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\user\\components\\AdminTab.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":111,"column":61,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":111,"endColumn":64,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5895,5898],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5895,5898],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\r\nimport UserManagementPanel from '../../admin/users/UserManagementPanel';\r\nimport { Activity, Server, Database } from 'lucide-react';\r\n\r\ninterface AdminTabProps {\r\n    setViewMode: (mode: string) => void;\r\n}\r\n\r\nconst AdminTab: React.FC<AdminTabProps> = () => {\r\n    const [activeSection, setActiveSection] = useState<'users' | 'system' | 'audit'>('users');\r\n\r\n    return (\r\n        <div className=\"flex flex-col h-full bg-slate-50 dark:bg-slate-950 font-sans\">\r\n\r\n            {/* --- TOP HEADER (Apple Style) --- */}\r\n            <div className=\"flex flex-col md:flex-row md:items-center justify-between px-8 py-8 md:py-10 shrink-0\">\r\n                <div>\r\n                    <h1 className=\"text-3xl tracking-tight font-semibold text-slate-900 dark:text-white\">\r\n                        Gesti√≥n de Franquicias\r\n                    </h1>\r\n                    <p className=\"text-sm text-slate-500 dark:text-slate-400 mt-1 font-medium\">\r\n                        Administraci√≥n y control de red\r\n                    </p>\r\n                </div>\r\n\r\n                {/* Segmented Control / Tabs */}\r\n                <div className=\"mt-6 md:mt-0 bg-slate-200/50 dark:bg-white/5 p-1 rounded-lg inline-flex self-start md:self-center backdrop-blur-sm\">\r\n                    <button\r\n                        onClick={() => setActiveSection('users')}\r\n                        className={`px-4 py-1.5 text-sm font-medium rounded-md transition-all ${activeSection === 'users'\r\n                            ? 'bg-white dark:bg-slate-800 text-slate-900 dark:text-white shadow-sm'\r\n                            : 'text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-200'\r\n                            }`}\r\n                    >\r\n                        Red\r\n                    </button>\r\n                    <button\r\n                        onClick={() => setActiveSection('system')}\r\n                        className={`px-4 py-1.5 text-sm font-medium rounded-md transition-all ${activeSection === 'system'\r\n                            ? 'bg-white dark:bg-slate-800 text-slate-900 dark:text-white shadow-sm'\r\n                            : 'text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-200'\r\n                            }`}\r\n                    >\r\n                        Infraestructura\r\n                    </button>\r\n                    <button\r\n                        onClick={() => setActiveSection('audit')}\r\n                        className={`px-4 py-1.5 text-sm font-medium rounded-md transition-all ${activeSection === 'audit'\r\n                            ? 'bg-white dark:bg-slate-800 text-slate-900 dark:text-white shadow-sm'\r\n                            : 'text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-200'\r\n                            }`}\r\n                    >\r\n                        Seguridad\r\n                    </button>\r\n                </div>\r\n            </div>\r\n\r\n            {/* --- MAIN CONTENT AREA --- */}\r\n            <div className=\"flex-1 px-8 pb-8 min-h-0 overflow-hidden\">\r\n                <div className=\"h-full bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl shadow-sm overflow-hidden flex flex-col\">\r\n\r\n                    {/* Content Switcher */}\r\n                    {activeSection === 'users' ? (\r\n                        <div className=\"flex-1 overflow-hidden flex flex-col\">\r\n                            <UserManagementPanel />\r\n                        </div>\r\n                    ) : activeSection === 'system' ? (\r\n                        <div className=\"flex-1 overflow-auto p-8\">\r\n                            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\r\n                                {/* Simple Clean Cards */}\r\n                                <StatusCard\r\n                                    icon={Activity}\r\n                                    title=\"Core Services\"\r\n                                    status=\"Operational\"\r\n                                    details=\"All APIs online (18ms latency)\"\r\n                                />\r\n                                <StatusCard\r\n                                    icon={Database}\r\n                                    title=\"Database\"\r\n                                    status=\"Healthy\"\r\n                                    details=\"Firestore connections active\"\r\n                                />\r\n                                <StatusCard\r\n                                    icon={Server}\r\n                                    title=\"Global CDN\"\r\n                                    status=\"Active\"\r\n                                    details=\"Cache hit rate 99%\"\r\n                                />\r\n                            </div>\r\n                        </div>\r\n                    ) : (\r\n                        <div className=\"flex-1 overflow-auto p-8\">\r\n                            <div className=\"max-w-4xl\">\r\n                                <h3 className=\"text-lg font-semibold text-slate-900 dark:text-white mb-4\">Registro de Seguridad</h3>\r\n                                <div className=\"space-y-0 text-sm font-mono border-l-2 border-slate-200 dark:border-slate-800 pl-4 py-2\">\r\n                                    <LogItem time=\"10:42 PM\" text=\"System verification complete\" />\r\n                                    <LogItem time=\"10:40 PM\" text=\"Admin session authenticated\" />\r\n                                    <LogItem time=\"10:38 PM\" text=\"Database backup successful\" />\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\n// --- Subcomponents for Clean UI ---\r\n\r\nconst StatusCard = ({ icon: Icon, title, status, details }: any) => (\r\n    <div className=\"p-6 rounded-xl border border-slate-200 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-800/50\">\r\n        <div className=\"flex items-center gap-3 mb-3\">\r\n            <div className=\"p-2 rounded-lg bg-white dark:bg-slate-700 shadow-sm border border-slate-100 dark:border-slate-600\">\r\n                <Icon className=\"w-5 h-5 text-slate-700 dark:text-slate-300\" />\r\n            </div>\r\n            <h3 className=\"font-medium text-slate-900 dark:text-white\">{title}</h3>\r\n        </div>\r\n        <div className=\"flex items-center gap-2 mb-1\">\r\n            <div className=\"w-2 h-2 rounded-full bg-emerald-500\" />\r\n            <span className=\"text-sm font-medium text-emerald-600 dark:text-emerald-400\">{status}</span>\r\n        </div>\r\n        <p className=\"text-xs text-slate-500 dark:text-slate-400\">{details}</p>\r\n    </div>\r\n);\r\n\r\nconst LogItem = ({ time, text }: { time: string, text: string }) => (\r\n    <div className=\"flex gap-4 py-1.5 opacity-70\">\r\n        <span className=\"text-slate-400 shrink-0\">{time}</span>\r\n        <span className=\"text-slate-600 dark:text-slate-300\">{text}</span>\r\n    </div>\r\n);\r\n\r\nexport default AdminTab;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\user\\components\\NotificationsTab.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":61,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":61,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2473,2476],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2473,2476],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":61,"column":72,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":61,"endColumn":75,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2515,2518],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2515,2518],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, type FC } from 'react';\r\nimport { Mail, Clock, CheckCircle2, Ticket, DollarSign, AlertTriangle, Lock, ShieldAlert, BookOpen, Bell } from 'lucide-react';\r\nimport { doc, setDoc, getDoc, collection, query, where, orderBy, limit, getDocs, Timestamp } from 'firebase/firestore';\r\nimport { db } from '../../../lib/firebase';\r\nimport { type User } from 'firebase/auth';\r\nimport { formatTimeAgo } from '../../../utils/dateHelpers';\r\n\r\ninterface NotificationsTabProps {\r\n    user: User;\r\n    showMessage: (type: string, text: string) => void;\r\n}\r\n\r\ninterface UserPrefs {\r\n    emailNotifications: boolean;\r\n    [key: string]: boolean;\r\n}\r\n\r\ninterface NotificationHistoryItem {\r\n    id: string;\r\n    title: string;\r\n    message: string;\r\n    type: string;\r\n    createdAt: Timestamp;\r\n    read: boolean;\r\n    priority?: string;\r\n}\r\n\r\nconst NotificationsTab: FC<NotificationsTabProps> = ({ user, showMessage }) => {\r\n    const [prefs, setPrefs] = useState<UserPrefs>({\r\n        emailNotifications: true\r\n    });\r\n    const [history, setHistory] = useState<NotificationHistoryItem[]>([]);\r\n    const [loadingHistory, setLoadingHistory] = useState(true);\r\n\r\n    useEffect(() => {\r\n        const loadPrefs = async () => {\r\n            try {\r\n                const docRef = doc(db, \"users\", user.uid);\r\n                const docSnap = await getDoc(docRef);\r\n                if (docSnap.exists()) {\r\n                    const data = docSnap.data();\r\n                    setPrefs({\r\n                        emailNotifications: data.emailNotifications ?? true\r\n                    });\r\n                }\r\n            } catch (error) {\r\n                console.error(\"Error loading prefs:\", error);\r\n            }\r\n        };\r\n\r\n        const loadHistory = async () => {\r\n            try {\r\n                // Determine collection based on role (simple heuristic: if \"admin_notifications\" exists?)\r\n                // Actually, for now, we assume this is the user's view, so we query 'notifications' or 'admin_notifications'\r\n                // But this component is typically used in Profile, which is for Franchises.\r\n                // Admins have a different notifications view usually.\r\n                // Let's assume Franchise context first: 'notifications' collection.\r\n\r\n                const targetIds = [user.uid];\r\n                // checking if user has franchiseId in a safe way without type assertion failure if needed\r\n                if ((user as any).franchiseId) targetIds.push((user as any).franchiseId);\r\n\r\n                const q = query(\r\n                    collection(db, \"notifications\"),\r\n                    where(\"userId\", \"in\", targetIds),\r\n                    orderBy(\"createdAt\", \"desc\"),\r\n                    limit(50)\r\n                );\r\n\r\n                const snapshot = await getDocs(q);\r\n                const list = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() } as NotificationHistoryItem));\r\n                setHistory(list);\r\n            } catch (error) {\r\n                console.error(\"Error loading history:\", error);\r\n            } finally {\r\n                setLoadingHistory(false);\r\n            }\r\n        };\r\n\r\n        loadPrefs();\r\n        loadHistory();\r\n    }, [user]);\r\n\r\n    const togglePref = async (key: string) => {\r\n        const newVal = !prefs[key];\r\n        setPrefs(prev => ({ ...prev, [key]: newVal }));\r\n\r\n        try {\r\n            await setDoc(doc(db, \"users\", user.uid), {\r\n                [key]: newVal\r\n            }, { merge: true });\r\n        } catch (error) {\r\n            console.error(\"Error saving pref:\", error);\r\n            setPrefs(prev => ({ ...prev, [key]: !newVal }));\r\n            showMessage('error', 'Error al guardar preferencia');\r\n        }\r\n    };\r\n\r\n    const getIcon = (type?: string) => {\r\n        const baseClass = \"w-8 h-8 rounded-full flex items-center justify-center shrink-0 border\";\r\n        switch (type) {\r\n            case 'FINANCE_CLOSING': return <div className={`${baseClass} bg-emerald-50 text-emerald-600 border-emerald-100`}><DollarSign className=\"w-4 h-4\" /></div>;\r\n            case 'RATE_CHANGE': return <div className={`${baseClass} bg-amber-50 text-amber-500 border-amber-100`}><AlertTriangle className=\"w-4 h-4\" /></div>;\r\n            case 'SUPPORT_TICKET': return <div className={`${baseClass} bg-blue-50 text-blue-500 border-blue-100`}><Ticket className=\"w-4 h-4\" /></div>;\r\n            case 'UNLOCK_REQUEST': return <div className={`${baseClass} bg-amber-50 text-amber-600 border-amber-100`}><Lock className=\"w-4 h-4\" /></div>;\r\n            case 'MONTH_UNLOCKED': return <div className={`${baseClass} bg-emerald-50 text-emerald-600 border-emerald-100`}><CheckCircle2 className=\"w-4 h-4\" /></div>;\r\n            case 'UNLOCK_REJECTED': return <div className={`${baseClass} bg-rose-50 text-rose-600 border-rose-100`}><ShieldAlert className=\"w-4 h-4\" /></div>;\r\n            case 'GUIDE_TIP': return <div className={`${baseClass} bg-indigo-50 text-indigo-600 border-indigo-100`}><BookOpen className=\"w-4 h-4\" /></div>;\r\n            case 'shift_change_request': return <div className={`${baseClass} bg-amber-50 text-amber-600 border-amber-100`}><AlertTriangle className=\"w-4 h-4\" /></div>;\r\n            case 'shift_confirmed': return <div className={`${baseClass} bg-emerald-50 text-emerald-600 border-emerald-100`}><CheckCircle2 className=\"w-4 h-4\" /></div>;\r\n            case 'incident': return <div className={`${baseClass} bg-rose-50 text-rose-600 border-rose-100`}><ShieldAlert className=\"w-4 h-4\" /></div>;\r\n            default: return <div className={`${baseClass} bg-slate-50 text-slate-400 border-slate-100`}><Bell className=\"w-4 h-4\" /></div>;\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"space-y-8 animate-in fade-in duration-300\">\r\n            {/* Preferences Section */}\r\n            <section>\r\n                <h2 className=\"text-xl font-black text-slate-800 border-b border-slate-100 pb-4 mb-6\">Preferencias de Contacto</h2>\r\n                <div className=\"grid gap-4 md:grid-cols-2\">\r\n                    <label className=\"flex items-center justify-between p-4 bg-white rounded-xl border border-slate-200 cursor-pointer hover:border-indigo-300 transition-colors shadow-sm group\">\r\n                        <div className=\"flex items-center gap-4\">\r\n                            <div className=\"p-2.5 bg-indigo-50 text-indigo-600 rounded-lg group-hover:scale-110 transition-transform\">\r\n                                <Mail className=\"w-5 h-5\" />\r\n                            </div>\r\n                            <div>\r\n                                <p className=\"font-bold text-slate-800\">Notificaciones por Email</p>\r\n                                <p className=\"text-xs text-slate-500 mt-0.5\">Recibir actualizaciones importantes a tu correo.</p>\r\n                            </div>\r\n                        </div>\r\n                        <div className={`w-11 h-6 rounded-full p-1 transition-colors ${prefs.emailNotifications ? 'bg-indigo-600' : 'bg-slate-200'}`} onClick={() => togglePref('emailNotifications')}>\r\n                            <div className={`w-4 h-4 bg-white rounded-full transition-transform shadow-sm ${prefs.emailNotifications ? 'translate-x-5' : ''}`} />\r\n                        </div>\r\n                    </label>\r\n                </div>\r\n            </section>\r\n\r\n            {/* History Section */}\r\n            <section>\r\n                <div className=\"flex items-center gap-3 border-b border-slate-100 pb-4 mb-6\">\r\n                    <h2 className=\"text-xl font-black text-slate-800\">Historial de Notificaciones</h2>\r\n                    <span className=\"bg-slate-100 text-slate-600 text-[10px] font-bold px-2 py-1 rounded-full uppercase tracking-wider\">√öltimas 50</span>\r\n                </div>\r\n\r\n                <div className=\"bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden\">\r\n                    {loadingHistory ? (\r\n                        <div className=\"p-12 text-center text-slate-400\">\r\n                            Cargando historial...\r\n                        </div>\r\n                    ) : history.length === 0 ? (\r\n                        <div className=\"p-16 text-center flex flex-col items-center\">\r\n                            <div className=\"w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mb-4\">\r\n                                <Clock className=\"w-8 h-8 text-slate-300\" />\r\n                            </div>\r\n                            <p className=\"font-bold text-slate-900\">Historial vac√≠o</p>\r\n                            <p className=\"text-sm text-slate-500 mt-1\">No hay notificaciones registradas recientemente.</p>\r\n                        </div>\r\n                    ) : (\r\n                        <div className=\"divide-y divide-slate-100\">\r\n                            {history.map((item) => (\r\n                                <div key={item.id} className=\"p-4 flex gap-4 hover:bg-slate-50 transition-colors\">\r\n                                    <div className=\"mt-1\">\r\n                                        {getIcon(item.type)}\r\n                                    </div>\r\n                                    <div className=\"flex-1 min-w-0\">\r\n                                        <div className=\"flex justify-between items-start mb-1\">\r\n                                            <h4 className=\"font-bold text-slate-900 text-sm\">{item.title}</h4>\r\n                                            <span className=\"text-[10px] text-slate-400 font-medium whitespace-nowrap\">\r\n                                                {item.createdAt ? formatTimeAgo(item.createdAt.toDate()) : '-'}\r\n                                            </span>\r\n                                        </div>\r\n                                        <p className=\"text-sm text-slate-600 leading-relaxed\">{item.message}</p>\r\n                                    </div>\r\n                                </div>\r\n                            ))}\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </section>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default NotificationsTab;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\user\\components\\ProfileTab.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":64,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":64,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2448,2451],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2448,2451],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":66,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":66,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2581,2584],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2581,2584],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":88,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":88,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3410,3413],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3410,3413],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":100,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":100,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3893,3896],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3893,3896],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { User, Phone, Mail, Loader, Save, Briefcase, MapPin, Globe } from 'lucide-react';\r\nimport { updateProfile, sendEmailVerification } from 'firebase/auth';\r\nimport { doc, setDoc, getDoc } from 'firebase/firestore';\r\nimport { db } from '../../../lib/firebase';\r\nimport Button from '../../../ui/inputs/Button';\r\nimport { AuthUser, RoleConfig } from '../../../context/AuthContext';\r\n\r\nexport interface ProfileTabProps {\r\n    user: AuthUser;\r\n    roleConfig?: RoleConfig;\r\n    isAdmin: boolean;\r\n    showMessage: (type: 'success' | 'error', text: string) => void;\r\n}\r\n\r\ninterface ProfileFormData {\r\n    displayName: string;\r\n    phone: string;\r\n    email: string;\r\n    photoURL: string;\r\n    location?: string;\r\n    role_description?: string;\r\n}\r\n\r\nconst ProfileTab: React.FC<ProfileTabProps> = ({ user, showMessage, roleConfig }) => {\r\n    const [isLoading, setIsLoading] = useState(false);\r\n    const [isVerifying, setIsVerifying] = useState(false);\r\n    const [formData, setFormData] = useState<ProfileFormData>({\r\n        displayName: user?.displayName || '',\r\n        phone: '',\r\n        email: user?.email || '',\r\n        photoURL: user?.photoURL || '',\r\n        location: '',\r\n        role_description: ''\r\n    });\r\n\r\n    useEffect(() => {\r\n        const loadUserConfig = async () => {\r\n            if (!user?.uid) return;\r\n            try {\r\n                const docRef = doc(db, \"users\", user.uid);\r\n                const docSnap = await getDoc(docRef);\r\n                if (docSnap.exists()) {\r\n                    const data = docSnap.data();\r\n                    setFormData(prev => ({\r\n                        ...prev,\r\n                        phone: data.phone || user.phoneNumber || '',\r\n                        photoURL: data.photoURL || user.photoURL || '',\r\n                        location: data.location || 'Madrid, Espa√±a',\r\n                        role_description: data.role_description || (roleConfig?.role === 'admin' ? 'Strategic Operations Director' : 'Franquiciado')\r\n                    }));\r\n                }\r\n            } catch (error) {\r\n                console.error(\"Error loading user config:\", error);\r\n            }\r\n        };\r\n        loadUserConfig();\r\n    }, [user, roleConfig]);\r\n\r\n    const handleVerifyEmail = async () => {\r\n        if (!user) return;\r\n        setIsVerifying(true);\r\n        try {\r\n            await sendEmailVerification(user as any);\r\n            showMessage('success', 'Correo de verificaci√≥n enviado. Revisa tu bandeja de entrada.');\r\n        } catch (error: any) {\r\n            console.error(\"Error sending verification:\", error);\r\n            if (error.code === 'auth/too-many-requests') {\r\n                showMessage('error', 'Demasiados intentos. Espera unos minutos.');\r\n            } else {\r\n                showMessage('error', 'Error al enviar correo: ' + error.message);\r\n            }\r\n        } finally {\r\n            setIsVerifying(false);\r\n        }\r\n    };\r\n\r\n    const handleSave = async () => {\r\n        const phoneRegex = /^\\+?[0-9\\s-]{9,}$/;\r\n        if (formData.phone && !phoneRegex.test(formData.phone)) {\r\n            showMessage('error', 'Formato de tel√©fono inv√°lido');\r\n            return;\r\n        }\r\n\r\n        setIsLoading(true);\r\n        try {\r\n            if (user && formData.displayName !== user.displayName) {\r\n                await updateProfile(user as any, { displayName: formData.displayName });\r\n            }\r\n\r\n            await setDoc(doc(db, \"users\", user.uid), {\r\n                displayName: formData.displayName,\r\n                phone: formData.phone,\r\n                email: user.email,\r\n                location: formData.location,\r\n                role_description: formData.role_description\r\n            }, { merge: true });\r\n\r\n            showMessage('success', 'Perfil actualizado con √©xito');\r\n        } catch (error: any) {\r\n            console.error(\"Error updating profile:\", error);\r\n            showMessage('error', 'Error al actualizar: ' + (error.message || 'Desconocido'));\r\n        } finally {\r\n            setIsLoading(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"animate-in fade-in duration-500\">\r\n            <div className=\"flex flex-col lg:flex-row gap-8\">\r\n\r\n                {/* --- LEFT COLUMN: IDENTITY CARD --- */}\r\n                <div className=\"w-full lg:w-1/3 space-y-6\">\r\n                    <div className=\"bg-slate-50 rounded-2xl p-6 border border-slate-100\">\r\n                        <h3 className=\"text-sm font-bold text-slate-400 uppercase tracking-wider mb-4\">Identidad Corporativa</h3>\r\n                        <div className=\"space-y-4\">\r\n                            <div className=\"group\">\r\n                                <label htmlFor=\"displayName\" className=\"block text-xs font-semibold text-slate-500 mb-1.5 ml-1\">Nombre P√∫blico</label>\r\n                                <div className=\"relative\">\r\n                                    <User className=\"absolute left-3 top-3 w-5 h-5 text-slate-400 group-focus-within:text-indigo-500 transition-colors\" />\r\n                                    <input\r\n                                        type=\"text\"\r\n                                        id=\"displayName\"\r\n                                        title=\"Nombre P√∫blico\"\r\n                                        aria-label=\"Nombre P√∫blico\"\r\n                                        placeholder=\"Tu nombre completo\"\r\n                                        value={formData.displayName}\r\n                                        onChange={(e) => setFormData({ ...formData, displayName: e.target.value })}\r\n                                        className=\"w-full pl-10 pr-4 py-2.5 bg-white border border-slate-200 rounded-xl font-bold text-slate-700 focus:ring-2 focus:ring-indigo-100 focus:border-indigo-500 outline-none transition-all shadow-sm\"\r\n                                    />\r\n                                </div>\r\n                            </div>\r\n\r\n                            <div className=\"group\">\r\n                                <label className=\"block text-xs font-semibold text-slate-500 mb-1.5 ml-1\">Cargo / Rol</label>\r\n                                <div className=\"relative\">\r\n                                    <Briefcase className=\"absolute left-3 top-3 w-5 h-5 text-slate-400 group-focus-within:text-indigo-500 transition-colors\" />\r\n                                    <input\r\n                                        type=\"text\"\r\n                                        title=\"Cargo o Rol\"\r\n                                        aria-label=\"Cargo o Rol\"\r\n                                        value={formData.role_description}\r\n                                        onChange={(e) => setFormData({ ...formData, role_description: e.target.value })}\r\n                                        className=\"w-full pl-10 pr-4 py-2.5 bg-white border border-slate-200 rounded-xl font-medium text-slate-600 focus:ring-2 focus:ring-indigo-100 focus:border-indigo-500 outline-none transition-all shadow-sm\"\r\n                                        placeholder=\"Ej. Operations Manager\"\r\n                                    />\r\n                                </div>\r\n                            </div>\r\n\r\n                            <div className=\"group\">\r\n                                <label className=\"block text-xs font-semibold text-slate-500 mb-1.5 ml-1\">Ubicaci√≥n</label>\r\n                                <div className=\"relative\">\r\n                                    <MapPin className=\"absolute left-3 top-3 w-5 h-5 text-slate-400 group-focus-within:text-indigo-500 transition-colors\" />\r\n                                    <input\r\n                                        type=\"text\"\r\n                                        title=\"Ubicaci√≥n\"\r\n                                        aria-label=\"Ubicaci√≥n\"\r\n                                        value={formData.location}\r\n                                        onChange={(e) => setFormData({ ...formData, location: e.target.value })}\r\n                                        className=\"w-full pl-10 pr-4 py-2.5 bg-white border border-slate-200 rounded-xl font-medium text-slate-600 focus:ring-2 focus:ring-indigo-100 focus:border-indigo-500 outline-none transition-all shadow-sm\"\r\n                                        placeholder=\"Ciudad, Pa√≠s\"\r\n                                    />\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* --- RIGHT COLUMN: CONTACT & SETTINGS --- */}\r\n                <div className=\"flex-1 space-y-6\">\r\n                    <div className=\"bg-slate-50 rounded-2xl p-6 border border-slate-100\">\r\n                        <h3 className=\"text-sm font-bold text-slate-400 uppercase tracking-wider mb-4\">Informaci√≥n de Contacto</h3>\r\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\r\n\r\n                            <div className=\"group md:col-span-2\">\r\n                                <label className=\"block text-xs font-semibold text-slate-500 mb-1.5 ml-1\">Correo Electr√≥nico (Principal)</label>\r\n                                <div className=\"relative\">\r\n                                    <Mail className=\"absolute left-3 top-3 w-5 h-5 text-slate-400\" />\r\n                                    <input\r\n                                        type=\"email\"\r\n                                        value={formData.email}\r\n                                        disabled\r\n                                        title=\"Correo Electr√≥nico\"\r\n                                        aria-label=\"Correo Electr√≥nico\"\r\n                                        placeholder=\"email@ejemplo.com\"\r\n                                        className=\"w-full pl-10 pr-4 py-2.5 bg-slate-100 border border-slate-200 rounded-xl font-bold text-slate-500 cursor-not-allowed shadow-inner\"\r\n                                    />\r\n                                    <div className=\"absolute right-3 top-2.5 flex items-center gap-2\">\r\n                                        {user?.emailVerified ? (\r\n                                            <span className=\"flex items-center text-xs font-bold text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded-full border border-emerald-100\">\r\n                                                Verificado\r\n                                            </span>\r\n                                        ) : (\r\n                                            <div className=\"flex items-center gap-2\">\r\n                                                <span className=\"flex items-center text-xs font-bold text-amber-600 bg-amber-50 px-2 py-0.5 rounded-full border border-amber-100\">\r\n                                                    No Verificado\r\n                                                </span>\r\n                                                <button\r\n                                                    onClick={handleVerifyEmail}\r\n                                                    disabled={isVerifying}\r\n                                                    className=\"text-[10px] font-bold text-indigo-500 hover:text-indigo-700 hover:underline disabled:opacity-50\"\r\n                                                >\r\n                                                    {isVerifying ? 'Enviando...' : 'Verificar ahora'}\r\n                                                </button>\r\n                                            </div>\r\n                                        )}\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n\r\n                            <div className=\"group\">\r\n                                <label htmlFor=\"phone\" className=\"block text-xs font-semibold text-slate-500 mb-1.5 ml-1\">Tel√©fono M√≥vil</label>\r\n                                <div className=\"relative\">\r\n                                    <Phone className=\"absolute left-3 top-3 w-5 h-5 text-slate-400 group-focus-within:text-indigo-500 transition-colors\" />\r\n                                    <input\r\n                                        type=\"tel\"\r\n                                        id=\"phone\"\r\n                                        title=\"Tel√©fono M√≥vil\"\r\n                                        aria-label=\"Tel√©fono M√≥vil\"\r\n                                        value={formData.phone}\r\n                                        onChange={(e) => setFormData({ ...formData, phone: e.target.value })}\r\n                                        className=\"w-full pl-10 pr-4 py-2.5 bg-white border border-slate-200 rounded-xl font-medium text-slate-700 focus:ring-2 focus:ring-indigo-100 focus:border-indigo-500 outline-none transition-all shadow-sm\"\r\n                                        placeholder=\"+34 600 000 000\"\r\n                                    />\r\n                                </div>\r\n                            </div>\r\n\r\n                            <div className=\"group\">\r\n                                <label className=\"block text-xs font-semibold text-slate-500 mb-1.5 ml-1\">Sitio Web / Enlace</label>\r\n                                <div className=\"relative\">\r\n                                    <Globe className=\"absolute left-3 top-3 w-5 h-5 text-slate-400 group-focus-within:text-indigo-500 transition-colors\" />\r\n                                    <input\r\n                                        type=\"text\"\r\n                                        disabled\r\n                                        title=\"Sitio Web\"\r\n                                        aria-label=\"Sitio Web\"\r\n                                        placeholder=\"https://repaartfinanzas.web.app\"\r\n                                        value=\"repaartfinanzas.web.app\"\r\n                                        className=\"w-full pl-10 pr-4 py-2.5 bg-slate-100 border border-slate-200 rounded-xl font-medium text-slate-400 cursor-not-allowed shadow-inner\"\r\n                                    />\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Action Bar */}\r\n                    <div className=\"flex justify-end pt-4\">\r\n                        <Button\r\n                            variant=\"primary\"\r\n                            onClick={handleSave}\r\n                            icon={isLoading ? Loader : Save}\r\n                            className={`px-8 py-3 text-sm shadow-xl shadow-indigo-200 hover:shadow-indigo-300 hover:scale-105 transform transition-all ${isLoading ? 'opacity-70' : ''}`}\r\n                            disabled={isLoading}\r\n                        >\r\n                            {isLoading ? 'Guardando Cambios...' : 'Guardar Perfil'}\r\n                        </Button>\r\n                    </div>\r\n                </div>\r\n\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default ProfileTab;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\features\\user\\components\\SecurityTab.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":38,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":38,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1418,1421],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1418,1421],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, type FC } from 'react';\r\nimport { updatePassword, type User } from 'firebase/auth';\r\nimport { Loader, Save, ShieldCheck, KeyRound, AlertOctagon, Check } from 'lucide-react';\r\nimport Button from '../../../ui/inputs/Button';\r\n\r\ninterface SecurityTabProps {\r\n    user: User;\r\n    logout: () => void;\r\n    showMessage: (type: string, text: string) => void;\r\n}\r\n\r\nconst SecurityTab: FC<SecurityTabProps> = ({ user, logout, showMessage }) => {\r\n    const [isLoading, setIsLoading] = useState(false);\r\n    const [passwords, setPasswords] = useState({\r\n        new: '',\r\n        confirm: ''\r\n    });\r\n\r\n    // Calculate dynamic security score (Visual only for now)\r\n    const securityScore = user.emailVerified ? 100 : 50;\r\n\r\n    const handleSecurityUpdate = async () => {\r\n        if (passwords.new !== passwords.confirm) {\r\n            showMessage('error', 'Las contrase√±as no coinciden');\r\n            return;\r\n        }\r\n        if (passwords.new.length < 6) {\r\n            showMessage('error', 'La contrase√±a debe tener al menos 6 caracteres');\r\n            return;\r\n        }\r\n\r\n        setIsLoading(true);\r\n        try {\r\n            await updatePassword(user, passwords.new);\r\n            setPasswords({ new: '', confirm: '' });\r\n            showMessage('success', 'Contrase√±a actualizada. Por favor inicia sesi√≥n de nuevo.');\r\n            setTimeout(() => logout(), 2000);\r\n        } catch (error: any) {\r\n            console.error(\"Error updating password:\", error);\r\n            showMessage('error', 'Error al cambiar contrase√±a (Requerido login reciente): ' + (error.message || 'Error desconocido'));\r\n        } finally {\r\n            setIsLoading(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"animate-in fade-in duration-500\">\r\n            <div className=\"flex flex-col lg:flex-row gap-8\">\r\n\r\n                {/* --- LEFT COLUMN: SECURITY HEALTH --- */}\r\n                <div className=\"w-full lg:w-1/3\">\r\n                    <div className=\"bg-gradient-to-br from-indigo-900 to-slate-900 rounded-2xl p-6 text-white shadow-xl relative overflow-hidden\">\r\n                        {/* Background Deco */}\r\n                        <div className=\"absolute top-[-20%] right-[-20%] w-40 h-40 bg-white/5 rounded-full blur-2xl\"></div>\r\n\r\n                        <div className=\"relative z-10 flex flex-col items-center text-center\">\r\n                            <div className=\"mb-4 relative\">\r\n                                <svg className=\"w-32 h-32 transform -rotate-90\">\r\n                                    <circle\r\n                                        cx=\"64\"\r\n                                        cy=\"64\"\r\n                                        r=\"56\"\r\n                                        stroke=\"currentColor\"\r\n                                        strokeWidth=\"8\"\r\n                                        fill=\"transparent\"\r\n                                        className=\"text-white/10\"\r\n                                    />\r\n                                    <circle\r\n                                        cx=\"64\"\r\n                                        cy=\"64\"\r\n                                        r=\"56\"\r\n                                        stroke=\"currentColor\"\r\n                                        strokeWidth=\"8\"\r\n                                        fill=\"transparent\"\r\n                                        strokeDasharray={351.86}\r\n                                        strokeDashoffset={351.86 - (351.86 * securityScore) / 100}\r\n                                        className=\"text-emerald-400 transition-all duration-1000 ease-out\"\r\n                                    />\r\n                                </svg>\r\n                                <div className=\"absolute inset-0 flex items-center justify-center flex-col\">\r\n                                    <span className=\"text-3xl font-black tracking-tighter\">{securityScore}%</span>\r\n                                    <span className=\"text-[10px] uppercase font-bold text-white/50 tracking-widest\">Seguro</span>\r\n                                </div>\r\n                            </div>\r\n\r\n                            <h3 className=\"text-lg font-bold mb-1\">Tu cuenta est√° protegida</h3>\r\n                            <p className=\"text-sm text-white/60 mb-6\">\r\n                                {user.emailVerified ? 'Tu identidad ha sido verificada.' : 'Te recomendamos verificar tu email.'}\r\n                            </p>\r\n\r\n                            <div className=\"w-full space-y-3\">\r\n                                <div className=\"flex items-center gap-3 p-3 rounded-xl bg-white/5 border border-white/10\">\r\n                                    <ShieldCheck className=\"w-5 h-5 text-emerald-400\" />\r\n                                    <span className=\"text-sm font-medium\">Autenticaci√≥n Segura</span>\r\n                                    <Check className=\"w-4 h-4 text-emerald-400 ml-auto\" />\r\n                                </div>\r\n                                <div className=\"flex items-center gap-3 p-3 rounded-xl bg-white/5 border border-white/10\">\r\n                                    <AlertOctagon className=\"w-5 h-5 text-indigo-400\" />\r\n                                    <span className=\"text-sm font-medium\">Monitor de Accesos</span>\r\n                                    <Check className=\"w-4 h-4 text-indigo-400 ml-auto\" />\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* --- RIGHT COLUMN: PASSWORD CHANGE --- */}\r\n                <div className=\"flex-1\">\r\n                    <div className=\"bg-slate-50 rounded-2xl p-8 border border-slate-100 h-full\">\r\n                        <div className=\"flex items-center gap-3 mb-6\">\r\n                            <div className=\"p-2 bg-indigo-100 rounded-lg text-indigo-600\">\r\n                                <KeyRound className=\"w-6 h-6\" />\r\n                            </div>\r\n                            <div>\r\n                                <h3 className=\"text-lg font-bold text-slate-800\">Cambiar Contrase√±a</h3>\r\n                                <p className=\"text-sm text-slate-500\">Aseg√∫rate de usar caracteres especiales</p>\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"space-y-6 max-w-lg\">\r\n                            <div className=\"group\">\r\n                                <label className=\"block text-xs font-bold text-slate-400 uppercase mb-2\">Nueva Contrase√±a</label>\r\n                                <div className=\"relative\">\r\n                                    <input\r\n                                        type=\"password\"\r\n                                        value={passwords.new}\r\n                                        onChange={(e) => setPasswords({ ...passwords, new: e.target.value })}\r\n                                        className=\"w-full pl-4 pr-10 py-3 bg-white border border-slate-200 rounded-xl font-medium text-slate-800 focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 outline-none transition-all placeholder:text-slate-300\"\r\n                                        placeholder=\"Min. 6 caracteres\"\r\n                                    />\r\n                                    <div className=\"absolute right-0 top-0 h-full w-2 bg-transparent group-focus-within:bg-indigo-500 rounded-r-xl transition-colors\"></div>\r\n                                </div>\r\n                            </div>\r\n\r\n                            <div className=\"group\">\r\n                                <label className=\"block text-xs font-bold text-slate-400 uppercase mb-2\">Confirmar Contrase√±a</label>\r\n                                <div className=\"relative\">\r\n                                    <input\r\n                                        type=\"password\"\r\n                                        value={passwords.confirm}\r\n                                        onChange={(e) => setPasswords({ ...passwords, confirm: e.target.value })}\r\n                                        className=\"w-full pl-4 pr-10 py-3 bg-white border border-slate-200 rounded-xl font-medium text-slate-800 focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 outline-none transition-all placeholder:text-slate-300\"\r\n                                        placeholder=\"Repite tu contrase√±a\"\r\n                                    />\r\n                                    {passwords.confirm && passwords.new === passwords.confirm && (\r\n                                        <Check className=\"absolute right-4 top-3.5 w-5 h-5 text-emerald-500 animate-in zoom-in\" />\r\n                                    )}\r\n                                </div>\r\n                            </div>\r\n\r\n                            <div className=\"pt-4 flex justify-end\">\r\n                                <Button\r\n                                    variant=\"primary\"\r\n                                    onClick={handleSecurityUpdate}\r\n                                    icon={isLoading ? Loader : Save}\r\n                                    className={`w-full md:w-auto px-8 py-3 shadow-lg shadow-indigo-200 ${isLoading ? 'opacity-70' : ''}`}\r\n                                    disabled={isLoading}\r\n                                >\r\n                                    {isLoading ? 'Actualizando...' : 'Actualizar Credenciales'}\r\n                                </Button>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default SecurityTab;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\hooks\\useAcademy.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":22,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[547,550],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[547,550],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":23,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":23,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[569,572],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[569,572],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":65,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":65,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1586,1589],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1586,1589],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":96,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":96,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2466,2469],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2466,2469],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":105,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":105,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2699,2702],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2699,2702],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":123,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":123,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3191,3194],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3191,3194],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\hooks\\useAcademy.ts:128:13\n  126 |     useEffect(() => {\n  127 |         if (!moduleId) {\n> 128 |             setLoading(false);\n      |             ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  129 |             return;\n  130 |         }\n  131 |","line":128,"column":13,"nodeType":null,"endLine":128,"endColumn":23},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":160,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":160,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4185,4188],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4185,4188],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":170,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":170,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4492,4495],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4492,4495],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":188,"column":61,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":188,"endColumn":64,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5000,5003],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5000,5003],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":204,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":204,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5495,5498],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5495,5498],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":236,"column":79,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":236,"endColumn":82,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6494,6497],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6494,6497],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":252,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":252,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7015,7018],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7015,7018],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\hooks\\useAcademy.ts:255:26\n  253 |     const [loading, setLoading] = useState<boolean>(true);\n  254 |     useEffect(() => {\n> 255 |         if (!moduleId) { setLoading(false); return; }\n      |                          ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  256 |         const q = query(collection(db, COLLECTIONS.QUIZZES), where('moduleId', '==', moduleId));\n  257 |         const unsub = onSnapshot(q, snap => {\n  258 |             if (!snap.empty) setQuiz({ id: snap.docs[0].id, ...snap.docs[0].data() });","line":255,"column":26,"nodeType":null,"endLine":255,"endColumn":36},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":268,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":268,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7667,7670],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7667,7670],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":280,"column":89,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":280,"endColumn":92,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8060,8063],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8060,8063],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":14,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useCallback } from 'react';\r\nimport { db } from '../lib/firebase';\r\nimport {\r\n    collection,\r\n    query,\r\n    orderBy,\r\n    onSnapshot,\r\n    where\r\n} from 'firebase/firestore';\r\nimport { academyService } from '../services/academyService';\r\n\r\n// Import Types from service or define here if not exported\r\n\r\nexport interface AcademyModule {\r\n    id: string;\r\n    title: string;\r\n    description?: string;\r\n    duration?: string;\r\n    order: number;\r\n    lessonCount?: number;\r\n    published?: boolean;\r\n    createdAt?: any;\r\n    updatedAt?: any;\r\n}\r\n\r\nexport interface Lesson {\r\n    id: string;\r\n    moduleId: string;\r\n    title: string;\r\n    content: string;\r\n    order: number;\r\n    resources?: { title: string; url: string }[];\r\n}\r\n\r\nexport interface Question {\r\n    type: 'single-choice' | 'multi-select' | 'true-false';\r\n    question: string;\r\n    options: string[];\r\n    correctAnswer?: number | boolean;\r\n    correctAnswers?: number[];\r\n}\r\n\r\nexport interface Quiz {\r\n    id: string;\r\n    moduleId: string;\r\n    questions: Question[];\r\n    passingScore?: number;\r\n}\r\n\r\n// Ideally we should import from academyService.ts\r\n\r\n// COLLECTION NAMES CONSTANTS (Aligned with Master Schema)\r\nconst COLLECTIONS = {\r\n    COURSES: 'academy_courses',\r\n    LESSONS: 'academy_lessons',\r\n    QUIZZES: 'academy_quizzes',\r\n    PROGRESS: 'academy_progress',\r\n    RESULTS: 'quiz_results'\r\n};\r\n\r\n/**\r\n * Hook para obtener todos los cursos (modules renamed to courses in UI context)\r\n */\r\nexport const useAcademyModules = () => {\r\n    const [modules, setModules] = useState<any[]>([]); // TODO: Define Module Type\r\n    const [loading, setLoading] = useState<boolean>(true);\r\n\r\n    useEffect(() => {\r\n        const q = query(\r\n            collection(db, COLLECTIONS.COURSES),\r\n            orderBy('order', 'asc')\r\n        );\r\n\r\n        const unsubscribe = onSnapshot(q, (snapshot) => {\r\n            const modulesData = snapshot.docs.map(doc => ({\r\n                id: doc.id,\r\n                ...doc.data()\r\n            }));\r\n            setModules(modulesData);\r\n            setLoading(false);\r\n        }, () => {\r\n            // console.warn(\"Error fetching courses:\", error);\r\n            setLoading(false);\r\n        });\r\n\r\n        return () => unsubscribe();\r\n    }, []);\r\n\r\n    return { modules, loading };\r\n};\r\n\r\n/**\r\n * Hook para crear un nuevo m√≥dulo (Curso)\r\n */\r\nexport const useCreateModule = () => {\r\n    return useCallback(async (moduleData: any) => {\r\n        return await academyService.saveCourse(moduleData);\r\n    }, []);\r\n};\r\n\r\n/**\r\n * Hook para actualizar un m√≥dulo\r\n */\r\nexport const useUpdateModule = () => {\r\n    return useCallback(async (moduleId: string, updates: any) => {\r\n        return await academyService.saveCourse({ id: moduleId, ...updates });\r\n    }, []);\r\n};\r\n\r\n/**\r\n * Hook para eliminar un m√≥dulo\r\n */\r\nexport const useDeleteModule = () => {\r\n    return useCallback(async (moduleId: string) => {\r\n        return await academyService.deleteCourse(moduleId);\r\n    }, []);\r\n};\r\n\r\n/**\r\n * Hook para obtener las lecciones de un m√≥dulo\r\n */\r\nexport const useModuleLessons = (moduleId: string | null) => {\r\n    const [lessons, setLessons] = useState<any[]>([]);\r\n    const [loading, setLoading] = useState<boolean>(true);\r\n\r\n    useEffect(() => {\r\n        if (!moduleId) {\r\n            setLoading(false);\r\n            return;\r\n        }\r\n\r\n        const q = query(\r\n            collection(db, COLLECTIONS.LESSONS),\r\n            where('moduleId', '==', moduleId),\r\n            orderBy('order', 'asc')\r\n        );\r\n\r\n        const unsubscribe = onSnapshot(q, (snapshot) => {\r\n            const lessonsData = snapshot.docs.map(doc => ({\r\n                id: doc.id,\r\n                ...doc.data()\r\n            }));\r\n            setLessons(lessonsData);\r\n            setLoading(false);\r\n        }, () => {\r\n            // console.warn(\"Error fetching lessons:\", error);\r\n            setLoading(false);\r\n        });\r\n\r\n        return () => unsubscribe();\r\n    }, [moduleId]);\r\n\r\n    return { lessons, loading };\r\n};\r\n\r\n/**\r\n * Hook para crear una nueva lecci√≥n\r\n */\r\nexport const useCreateLesson = () => {\r\n    return useCallback(async (lessonData: any) => {\r\n        // WARN: I need to update this to use the defined COLLECTIONS.\r\n        return await academyService.saveLesson(lessonData);\r\n    }, []);\r\n};\r\n\r\n/**\r\n * Hook para actualizar una lecci√≥n\r\n */\r\nexport const useUpdateLesson = () => {\r\n    return useCallback(async (lessonId: string, updates: any) => {\r\n        return await academyService.saveLesson({ id: lessonId, ...updates });\r\n    }, []);\r\n};\r\n\r\n/**\r\n * Hook para eliminar una lecci√≥n\r\n */\r\nexport const useDeleteLesson = () => {\r\n    return useCallback(async (lessonId: string) => {\r\n        return await academyService.deleteLesson(lessonId);\r\n    }, []);\r\n};\r\n\r\n/**\r\n * Hook para obtener el progreso del usuario\r\n */\r\nexport const useAcademyProgress = (userId: string | null) => {\r\n    const [progress, setProgress] = useState<Record<string, any>>({});\r\n    const [totalProgress, setTotalProgress] = useState<number>(0);\r\n    const [loading, setLoading] = useState<boolean>(true);\r\n\r\n    useEffect(() => {\r\n        if (!userId) {\r\n            setLoading(false);\r\n            return;\r\n        }\r\n\r\n        const q = query(\r\n            collection(db, COLLECTIONS.PROGRESS),\r\n            where('userId', '==', userId)\r\n        );\r\n\r\n        const unsubscribe = onSnapshot(q, (snapshot) => {\r\n            const progressData: Record<string, any> = {};\r\n            let completedModules = 0;\r\n            let totalModules = 0;\r\n\r\n            snapshot.docs.forEach(doc => {\r\n                const data = doc.data();\r\n                progressData[data.moduleId] = {\r\n                    ...data,\r\n                    id: doc.id\r\n                };\r\n                if (data.completed) completedModules++;\r\n                totalModules++;\r\n            });\r\n\r\n            setProgress(progressData);\r\n            setTotalProgress(totalModules > 0 ? (completedModules / totalModules) * 100 : 0);\r\n            setLoading(false);\r\n        }, () => {\r\n            // console.warn(\"Error fetching academy progress:\", error);\r\n            setLoading(false);\r\n        });\r\n\r\n        return () => unsubscribe();\r\n    }, [userId]);\r\n\r\n    return { progress, totalProgress, loading };\r\n};\r\n\r\n/**\r\n * Hook para actualizar progreso\r\n */\r\nexport const useUpdateProgress = () => {\r\n    return useCallback(async (userId: string, moduleId: string, progressData: any) => {\r\n        return await academyService.updateProgress(userId, moduleId, progressData);\r\n    }, []);\r\n};\r\n\r\n/**\r\n * Hook para marcar lecci√≥n completa\r\n */\r\nexport const useMarkLessonComplete = () => {\r\n    return useCallback(async (userId: string, moduleId: string, lessonId: string) => {\r\n        return await academyService.markLessonComplete(userId, moduleId, lessonId);\r\n    }, []);\r\n};\r\n\r\n// ... Quizzes hooks\r\nexport const useModuleQuiz = (moduleId: string | null) => {\r\n    const [quiz, setQuiz] = useState<any | null>(null);\r\n    const [loading, setLoading] = useState<boolean>(true);\r\n    useEffect(() => {\r\n        if (!moduleId) { setLoading(false); return; }\r\n        const q = query(collection(db, COLLECTIONS.QUIZZES), where('moduleId', '==', moduleId));\r\n        const unsub = onSnapshot(q, snap => {\r\n            if (!snap.empty) setQuiz({ id: snap.docs[0].id, ...snap.docs[0].data() });\r\n            else setQuiz(null);\r\n            setLoading(false);\r\n        });\r\n        return () => unsub();\r\n    }, [moduleId]);\r\n    return { quiz, loading };\r\n};\r\n\r\nexport const useSaveQuiz = () => {\r\n    return useCallback(async (moduleId: string, quizData: any) => {\r\n        return await academyService.saveQuiz(moduleId, quizData);\r\n    }, []);\r\n};\r\n\r\nexport const useDeleteQuiz = () => {\r\n    return useCallback(async (quizId: string) => {\r\n        return await academyService.deleteQuiz(quizId);\r\n    }, []);\r\n};\r\n\r\nexport const useSaveQuizResult = () => {\r\n    return useCallback(async (userId: string, moduleId: string, score: number, answers: any) => {\r\n        return await academyService.saveQuizResult(userId, moduleId, score, answers);\r\n    }, []);\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\hooks\\useAdminAnnouncements.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":15,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":15,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[528,531],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[528,531],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":16,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":16,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[610,613],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[610,613],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react';\r\nimport { db } from '../lib/firebase';\r\nimport { collection, query, orderBy, onSnapshot, addDoc, deleteDoc, doc, serverTimestamp, arrayUnion, updateDoc } from 'firebase/firestore';\r\n\r\ninterface Announcement {\r\n    id: string;\r\n    title: string;\r\n    content: string;\r\n    type: 'news' | 'alert' | 'poll';\r\n    priority: 'normal' | 'high' | 'critical';\r\n    targetAudience: 'all' | 'specific';\r\n    targetFranchises: string[];\r\n    createdAt: Date;\r\n    reads: string[];\r\n    votes: any[]; // Define a stricter type if voting structure is known\r\n    [key: string]: any;\r\n}\r\n\r\nexport const useAdminAnnouncements = () => {\r\n    const [announcements, setAnnouncements] = useState<Announcement[]>([]);\r\n    const [loading, setLoading] = useState<boolean>(true);\r\n\r\n    useEffect(() => {\r\n        const q = query(\r\n            collection(db, 'announcements'),\r\n            orderBy('createdAt', 'desc')\r\n        );\r\n\r\n        const unsubscribe = onSnapshot(q, (snapshot) => {\r\n            const data = snapshot.docs.map(doc => ({\r\n                id: doc.id,\r\n                ...doc.data(),\r\n                createdAt: doc.data().createdAt?.toDate() || new Date()\r\n            })) as Announcement[];\r\n            setAnnouncements(data);\r\n            setLoading(false);\r\n        }, () => {\r\n            // console.warn(\"Error fetching announcements:\", error);\r\n            setLoading(false);\r\n        });\r\n\r\n        return () => unsubscribe();\r\n    }, []);\r\n\r\n    const createAnnouncement = async (\r\n        title: string,\r\n        content: string,\r\n        type: 'news' | 'alert' | 'poll' = 'news',\r\n        priority: 'normal' | 'high' | 'critical' = 'normal',\r\n        targetAudience: 'all' | 'specific' = 'all',\r\n        targetFranchises: string[] = []\r\n    ) => {\r\n        await addDoc(collection(db, 'announcements'), {\r\n            title,\r\n            content,\r\n            type, // 'news', 'alert', 'poll'\r\n            priority, // 'normal', 'high', 'critical'\r\n            targetAudience, // 'all', 'specific'\r\n            targetFranchises, // array of franchise IDs\r\n            createdAt: serverTimestamp(),\r\n            reads: [], // Array of userIDs who read it\r\n            votes: []\r\n        });\r\n    };\r\n\r\n    const markAsRead = async (announcementId: string, userId: string) => {\r\n        if (!userId) return;\r\n        const ref = doc(db, 'announcements', announcementId);\r\n        // We use arrayUnion to add unique userIds only\r\n        await updateDoc(ref, {\r\n            reads: arrayUnion(userId)\r\n        });\r\n    };\r\n\r\n    const deleteAnnouncement = async (id: string) => {\r\n        await deleteDoc(doc(db, 'announcements', id));\r\n    };\r\n\r\n    return {\r\n        announcements,\r\n        loading,\r\n        createAnnouncement,\r\n        deleteAnnouncement,\r\n        markAsRead\r\n    };\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\hooks\\useAdminControl.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":25,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":25,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[815,818],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[815,818],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":34,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":34,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1003,1006],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1003,1006],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":41,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":41,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1235,1238],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1235,1238],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react';\r\nimport { collection, query, where, getDocs } from 'firebase/firestore';\r\nimport { db } from '../lib/firebase';\r\nimport { financeService } from '../services/financeService';\r\nimport { franchiseService } from '../services/franchiseService';\r\nimport { intelService, IntellectualEvent } from '../services/intelService';\r\nimport { format } from 'date-fns';\r\nimport { Ticket } from '../types/support';\r\n\r\nexport interface PendingAction {\r\n    id: string;\r\n    type: 'ticket' | 'premium' | 'record' | 'alert';\r\n    title: string;\r\n    subtitle: string;\r\n    priority: 'critical' | 'low' | 'normal' | 'high';\r\n}\r\n\r\nexport interface Franchise {\r\n    id: string;\r\n    name: string;\r\n    metrics?: {\r\n        margin: number;\r\n        revenue?: number;\r\n    };\r\n    [key: string]: any;\r\n}\r\n\r\nexport interface FinancialSummary {\r\n    id?: string;\r\n    franchiseId?: string;\r\n    month?: string;\r\n    revenue?: number;\r\n    totalIncome?: number;\r\n    expenses?: number | any; // Could be object or number depending on legacy\r\n    totalExpenses?: number;\r\n    breakdown?: {\r\n        consultoria?: number;\r\n        premium?: number;\r\n        [key: string]: number | undefined;\r\n    };\r\n    [key: string]: any;\r\n}\r\n\r\nexport interface AdminControlData {\r\n    network: {\r\n        total: number;\r\n        excellent: number;\r\n        acceptable: number;\r\n        critical: number;\r\n        franchises: Franchise[];\r\n    };\r\n    pending: {\r\n        total: number;\r\n        tickets: number;\r\n        premium: number;\r\n        records: number;\r\n        alerts: number;\r\n        list: PendingAction[];\r\n    };\r\n    events: IntellectualEvent[];\r\n    earnings: {\r\n        royalties: number;\r\n        services: number;\r\n        totalNetworkRevenue: number;\r\n    };\r\n}\r\n\r\nexport const useAdminControl = (monthKey?: string) => {\r\n    const [data, setData] = useState<AdminControlData>({\r\n        network: { total: 0, excellent: 0, acceptable: 0, critical: 0, franchises: [] },\r\n        pending: { total: 0, tickets: 0, premium: 0, records: 0, alerts: 0, list: [] },\r\n        events: [],\r\n        earnings: { royalties: 0, services: 0, totalNetworkRevenue: 0 }\r\n    });\r\n    const [loading, setLoading] = useState(true);\r\n    const [error, setError] = useState<string | null>(null);\r\n\r\n    useEffect(() => {\r\n        let isMounted = true;\r\n\r\n        const loadControlData = async () => {\r\n            try {\r\n                setLoading(true);\r\n\r\n                // 1. Fetch Franchises & Analyze Network\r\n                // Switch to franchiseService to match IDs with Financial Summaries\r\n                const result = await franchiseService.getAllFranchises();\r\n                const franchises: Franchise[] = (result.success) ? result.data : [];\r\n\r\n                const franchiseMap = new Map(franchises.map(f => [f.id, f.name]));\r\n                const networkStats = franchises.reduce((acc, f) => {\r\n                    const margin = f.metrics?.margin || 0;\r\n                    if (margin > 20) acc.excellent++;\r\n                    else if (margin > 10) acc.acceptable++;\r\n                    else acc.critical++;\r\n                    return acc;\r\n                }, { excellent: 0, acceptable: 0, critical: 0 });\r\n\r\n                // 2. Fetch Pending Financial Records\r\n                const pendingRecords = await financeService.getGlobalPendingRecords();\r\n\r\n                // 3. Fetch Pending Tickets (Real-time or simple fetch)\r\n                const ticketsQuery = query(\r\n                    collection(db, \"tickets\"),\r\n                    where(\"status\", \"in\", [\"open\", \"investigating\", \"pending_admin\"])\r\n                );\r\n                const ticketsSnap = await getDocs(ticketsQuery);\r\n                const allTickets = ticketsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() } as Ticket));\r\n\r\n                const premiumTickets = allTickets.filter((t: Ticket) => t.category === 'premium');\r\n                const standardTickets = allTickets.filter((t: Ticket) => t.category !== 'premium');\r\n\r\n                // 4. Fetch Unread System Alerts\r\n                const alertsQuery = query(\r\n                    collection(db, \"admin_notifications\"),\r\n                    where(\"read\", \"==\", false)\r\n                );\r\n                const alertsSnap = await getDocs(alertsQuery);\r\n                const unreadAlerts = alertsSnap.docs.length;\r\n\r\n                // 5. Fetch Events for current week\r\n                const upcomingEvents = await intelService.getIntelForWeek(new Date());\r\n\r\n                // 6. Calculate Earnings (Target Month)\r\n                const activeMonthKey = monthKey || format(new Date(), 'yyyy-MM');\r\n                const summariesQuery = query(\r\n                    collection(db, \"financial_summaries\"),\r\n                    where(\"month\", \"==\", activeMonthKey)\r\n                );\r\n                const summariesSnap = await getDocs(summariesQuery);\r\n                const summaries: FinancialSummary[] = summariesSnap.docs.map(doc => {\r\n                    const d = doc.data();\r\n                    // Robustness: Extract franchiseId from doc.id if missing in body\r\n                    // DocID convention: {franchiseId}_{yyyy-MM}\r\n                    let fid = d.franchiseId;\r\n                    if (!fid && doc.id.includes('_')) {\r\n                        // Attempt to strip the month suffix\r\n                        if (doc.id.endsWith(`_${activeMonthKey}`)) {\r\n                            fid = doc.id.slice(0, -(activeMonthKey.length + 1));\r\n                        } else {\r\n                            // Fallback splitting (risky if ID has underscores, but better than nothing)\r\n                            const parts = doc.id.split('_');\r\n                            parts.pop(); // remove date\r\n                            fid = parts.join('_');\r\n                        }\r\n                    }\r\n                    // Normalize ID\r\n                    return { ...d, franchiseId: fid ? String(fid).trim() : fid, _debugId: doc.id } as FinancialSummary;\r\n                });\r\n\r\n                // --- Calculate Global Financials ---\r\n                const totalNetworkRevenue = summaries.reduce((acc, s) => acc + (s.revenue || s.totalIncome || 0), 0);\r\n                const royalties = totalNetworkRevenue * 0.05;\r\n\r\n                // Services revenue: Aggregate from premium tickets or specific records\r\n                const servicesRevenue = summaries.reduce((acc, s) => {\r\n                    const consultoria = s.breakdown?.consultoria || 0;\r\n                    const premium = s.breakdown?.premium || 0;\r\n                    return acc + consultoria + premium;\r\n                }, 0);\r\n\r\n                const financialMap = new Map<string, FinancialSummary>();\r\n                summaries.forEach(s => {\r\n                    if (s.franchiseId) {\r\n                        financialMap.set(String(s.franchiseId).trim(), s);\r\n                    }\r\n                });\r\n\r\n                if (isMounted) {\r\n                    setData({\r\n                        network: {\r\n                            total: franchises.length,\r\n                            ...networkStats,\r\n                            franchises: franchises.map(f => {\r\n                                const summary = financialMap.get(f.id);\r\n                                let margin = f.metrics?.margin || 0; // Fallback to user-stored metric\r\n\r\n                                if (summary) {\r\n                                    const revenue = summary.revenue || summary.totalIncome || 0;\r\n                                    const expense = (typeof summary.expenses === 'number' ? summary.expenses : summary.totalExpenses) || 0;\r\n                                    const profit = revenue - expense;\r\n\r\n                                    // Calculate real-time margin for the selected month\r\n                                    if (revenue > 0) {\r\n                                        margin = (profit / revenue) * 100;\r\n                                    } else {\r\n                                        margin = 0;\r\n                                    }\r\n                                }\r\n\r\n                                const finalRevenue = summary ? (summary.revenue || summary.totalIncome || 0) : 0;\r\n                                // console.log(`[DEBUG] Franchise ${f.id} Revenue:`, finalRevenue);\r\n\r\n                                return {\r\n                                    ...f,\r\n                                    metrics: {\r\n                                        ...f.metrics,\r\n                                        margin, // Override with calculated margin\r\n                                        revenue: finalRevenue\r\n                                    }\r\n                                };\r\n                            }).sort((a, b) => (a.metrics?.margin || 0) - (b.metrics?.margin || 0))\r\n                        },\r\n                        pending: {\r\n                            total: standardTickets.length + premiumTickets.length + pendingRecords.length + unreadAlerts,\r\n                            tickets: standardTickets.length,\r\n                            premium: premiumTickets.length,\r\n                            records: pendingRecords.length,\r\n                            alerts: unreadAlerts,\r\n                            list: [\r\n                                ...standardTickets.map((t): PendingAction => ({\r\n                                    id: t.id as string,\r\n                                    type: 'ticket' as const,\r\n                                    title: t.subject,\r\n                                    subtitle: t.email || 'Sin email',\r\n                                    priority: (t.urgency === 'medium' ? 'normal' : (t.urgency || 'low')) as 'critical' | 'low' | 'normal' | 'high'\r\n                                })),\r\n                                ...premiumTickets.map((t): PendingAction => ({ id: t.id as string, type: 'premium' as const, title: t.subject, subtitle: 'Solicitud Premium', priority: 'high' as const })),\r\n                                ...pendingRecords.map((r): PendingAction => ({\r\n                                    id: r.id,\r\n                                    type: 'record' as const,\r\n                                    title: 'Cierre Mensual',\r\n                                    subtitle: `Sede: ${franchiseMap.get(r.franchise_id) || r.franchise_id}`,\r\n                                    priority: 'normal' as const\r\n                                }))\r\n                            ].slice(0, 10)\r\n                        },\r\n                        events: upcomingEvents,\r\n                        earnings: {\r\n                            royalties,\r\n                            services: servicesRevenue,\r\n                            totalNetworkRevenue\r\n                        }\r\n                    });\r\n                    setLoading(false);\r\n                }\r\n            } catch (err: unknown) {\r\n                console.error(\"Error loading admin control data:\", err);\r\n                if (isMounted) {\r\n                    setError(err instanceof Error ? err.message : 'Error cargando datos de control');\r\n                    setLoading(false);\r\n                }\r\n            }\r\n        };\r\n\r\n        loadControlData();\r\n\r\n        return () => { isMounted = false; };\r\n    }, [monthKey]);\r\n\r\n    return { data, loading, error };\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\hooks\\useAdminDashboardData.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":16,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":16,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[594,597],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[594,597],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":17,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":17,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[656,659],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[656,659],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":124,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":124,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5110,5113],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5110,5113],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useCallback } from 'react';\r\nimport { financeService } from '../services/financeService';\r\n// userService import removed as unused\r\nimport { franchiseService } from '../services/franchiseService';\r\nimport { isOk } from '../types/result';\r\n\r\n// --- MOCK REMOVED: generateTrend se va a la basura ---\r\n\r\nexport const useAdminDashboardData = (selectedMonth: string) => {\r\n    const [stats, setStats] = useState({\r\n        totalRevenue: 0,\r\n        totalProfit: 0,\r\n        margin: 0,\r\n        franchiseCount: 0\r\n    });\r\n    const [trendData, setTrendData] = useState<any[]>([]);\r\n    const [franchises, setFranchises] = useState<any[]>([]);\r\n\r\n    const [loading, setLoading] = useState(true);\r\n    const [isFetching, setIsFetching] = useState(false); // Para revalidaciones silenciosas\r\n    const [error, setError] = useState<string | null>(null);\r\n\r\n    const loadDashboardData = useCallback(async () => {\r\n        try {\r\n            setIsFetching(true);\r\n            setError(null);\r\n\r\n            // 1. Cargar Franquicias (Entidades reales, no users)\r\n            const franchiseResult = await franchiseService.getAllFranchises();\r\n\r\n            if (!franchiseResult.success) {\r\n                console.error('‚ùå Error cargando franquicias:', franchiseResult.error);\r\n            }\r\n\r\n            // 2. Cargar Res√∫menes Financieros del Mes (Para obtener revenue real)\r\n            // Use dynamic import or assume db is available if imported. \r\n            // Better to use the service pattern if possible, but for now inlining for fix consistency.\r\n            const { collection, query, where, getDocs } = await import('firebase/firestore');\r\n            const { db } = await import('../lib/firebase');\r\n\r\n            // Ensure selectedMonth is valid YYYY-MM\r\n            const targetMonth = selectedMonth || new Date().toISOString().slice(0, 7);\r\n\r\n            const q = query(\r\n                collection(db, 'financial_summaries'),\r\n                where('month', '==', targetMonth)\r\n            );\r\n\r\n            const summariesSnap = await getDocs(q);\r\n            const financialMap = new Map();\r\n\r\n            summariesSnap.forEach(doc => {\r\n                const data = doc.data();\r\n                if (data.franchiseId) {\r\n                    financialMap.set(String(data.franchiseId).trim(), data);\r\n                }\r\n            });\r\n\r\n            const franchiseList = isOk(franchiseResult) ? franchiseResult.data.map(f => {\r\n                const cleanId = String(f.id).trim();\r\n                const summary = financialMap.get(cleanId);\r\n                return {\r\n                    ...f,\r\n                    uid: f.id,\r\n                    active: f.status === 'active' || f.status === 'warning',\r\n                    revenue: summary ? (summary.revenue || summary.totalIncome || 0) : 0 // Populate revenue\r\n                };\r\n            }) : [];\r\n\r\n            setFranchises(franchiseList);\r\n\r\n            // 3. Cargar Tendencia REAL (√öltimos 6 meses)\r\n            const realTrend = await financeService.getFinancialTrend(null, 6);\r\n            // Map income to revenue for Chart compatibility\r\n            const mappedTrend = realTrend.map(item => ({\r\n                ...item,\r\n                revenue: item.income\r\n            }));\r\n            setTrendData(mappedTrend);\r\n\r\n            // 4. Calcular KPIs del MES SELECCIONADO (no acumulado)\r\n            // Buscar datos espec√≠ficos del mes seleccionado con matching robusto\r\n            let selectedMonthData = realTrend.find(item => {\r\n                try {\r\n                    if (!item.month && !item.date) return false;\r\n                    const dateValue = item.month || item.date;\r\n\r\n                    // Si ya es formato YYYY-MM, comparar directamente\r\n                    if (typeof dateValue === 'string' && dateValue.match(/^\\d{4}-\\d{2}$/)) {\r\n                        return dateValue === selectedMonth;\r\n                    }\r\n\r\n                    // Sino, convertir a Date\r\n                    const itemMonth = new Date(dateValue).toISOString().slice(0, 7);\r\n                    return itemMonth === selectedMonth;\r\n                } catch {\r\n                    return false;\r\n                }\r\n            });\r\n\r\n            // FALLBACK: Si no encontramos el mes exacto, usar el mes m√°s reciente\r\n            if (!selectedMonthData && realTrend.length > 0) {\r\n                selectedMonthData = realTrend[realTrend.length - 1];\r\n            }\r\n\r\n            let totalRevenue = 0;\r\n            let totalExpenses = 0;\r\n\r\n            if (selectedMonthData) {\r\n                totalRevenue = selectedMonthData.income || 0;\r\n                totalExpenses = selectedMonthData.expenses || 0;\r\n            }\r\n\r\n            const totalProfit = totalRevenue - totalExpenses;\r\n            const margin = totalRevenue > 0 ? (totalProfit / totalRevenue) * 100 : 0;\r\n\r\n            setStats({\r\n                totalRevenue,\r\n                totalProfit,\r\n                margin,\r\n                franchiseCount: franchiseList.filter(f => f.active).length\r\n            });\r\n\r\n        } catch (err: any) {\r\n            console.error(\"Dashboard Data Error:\", err);\r\n            setError(err.message || \"Error cargando datos del dashboard\");\r\n        } finally {\r\n            setLoading(false);\r\n            setIsFetching(false);\r\n        }\r\n    }, [selectedMonth]); // Recargar si cambia el mes\r\n\r\n    // Initial Load\r\n    useEffect(() => {\r\n        loadDashboardData();\r\n    }, [loadDashboardData]);\r\n\r\n    return {\r\n        stats,\r\n        trendData,\r\n        franchises,\r\n        loading,\r\n        isFetching,\r\n        error,\r\n        refresh: loadDashboardData\r\n    };\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\hooks\\useAppNavigation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\hooks\\useExport.ts","messages":[{"ruleId":"prefer-const","severity":2,"message":"'csvContent' is never reassigned. Use 'const' instead.","line":42,"column":13,"nodeType":"Identifier","messageId":"useConst","endLine":42,"endColumn":23,"fix":{"range":[1376,1464],"text":"const csvContent = \"data:text/csv;charset=utf-8,\" + rows.map(e => e.join(\",\")).join(\"\\n\");"}}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":1,"fixableWarningCount":0,"source":"import { useCallback } from 'react';\r\nimport { formatMoney } from '../lib/finance';\r\n\r\ninterface ReportItem {\r\n    name: string;\r\n    type: string;\r\n    value: number;\r\n}\r\n\r\ninterface ReportData {\r\n    revenue: number;\r\n    taxes?: {\r\n        netProfitPostTax?: number;\r\n    };\r\n    metrics?: {\r\n        costPerKm?: number;\r\n        dropDensity?: number;\r\n    };\r\n    breakdown?: ReportItem[];\r\n}\r\n\r\nexport const useExport = () => {\r\n    const exportCSV = useCallback((report: ReportData, selectedMonth: string, titlePrefix: string = 'REPORTE FINANCIERO') => {\r\n        if (!report) return;\r\n\r\n        const rows: (string | number)[][] = [\r\n            [`${titlePrefix} [${selectedMonth}]`, new Date().toLocaleDateString()],\r\n            [],\r\n            [\"METRICAS PRINCIPALES\"],\r\n            [\"Ingresos Totales\", formatMoney(report.revenue)],\r\n            [\"Beneficio Neto Real\", formatMoney(report.taxes?.netProfitPostTax || 0)],\r\n            [],\r\n            [\"LOGISTICA AVANZADA\"],\r\n            [\"Coste / Km\", (report.metrics?.costPerKm || 0).toFixed(3)],\r\n            [\"Drop Density\", (report.metrics?.dropDensity || 0).toFixed(2)],\r\n            [],\r\n            [\"DESGLOSE DE COSTES\"],\r\n            [\"Concepto\", \"Tipo\", \"Valor\"],\r\n            ...(report.breakdown || []).map((item: ReportItem) => [item.name, item.type, formatMoney(item.value)])\r\n        ];\r\n\r\n        let csvContent = \"data:text/csv;charset=utf-8,\" + rows.map(e => e.join(\",\")).join(\"\\n\");\r\n        const encodedUri = encodeURI(csvContent);\r\n\r\n        // Create temporal link element\r\n        const link = document.createElement(\"a\");\r\n        link.setAttribute(\"href\", encodedUri);\r\n        link.setAttribute(\"download\", `reporte_${selectedMonth}.csv`);\r\n        document.body.appendChild(link);\r\n        link.click();\r\n        document.body.removeChild(link);\r\n    }, []);\r\n\r\n    return { exportCSV };\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\hooks\\useFeatureAccess.ts","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\hooks\\useFeatureAccess.ts:72:13\n  70 |\n  71 |         if (!user) {\n> 72 |             setLoading(false);\n     |             ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  73 |             return;\n  74 |         }\n  75 |","line":72,"column":13,"nodeType":null,"endLine":72,"endColumn":23}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react';\r\nimport { db } from '../lib/firebase';\r\nimport { doc, getDoc } from 'firebase/firestore';\r\nimport { useAuth } from '../context/AuthContext';\r\n\r\n// =====================================================\r\n// TYPES & INTERFACES\r\n// =====================================================\r\n\r\nexport type PackType = 'basic' | 'premium' | 'admin';\r\n\r\nexport interface Features {\r\n    downloads: boolean;\r\n    ai_coach: boolean;\r\n    simulations: boolean;\r\n    [key: string]: boolean; // Allow additional feature flags\r\n}\r\n\r\nexport interface UseFeatureAccessReturn {\r\n    hasAccess: (featureName: string) => boolean;\r\n    features: Features | null;\r\n    pack: PackType | null;\r\n    loading: boolean;\r\n}\r\n\r\n// =====================================================\r\n// HELPER FUNCTIONS\r\n// =====================================================\r\n\r\n/**\r\n * Features por defecto seg√∫n tipo de pack\r\n */\r\nconst getDefaultFeaturesByPack = (packType: PackType): Features => {\r\n    const packs: Record<PackType, Features> = {\r\n        basic: {\r\n            downloads: false,\r\n            ai_coach: false,\r\n            simulations: false\r\n        },\r\n        premium: {\r\n            downloads: true,\r\n            ai_coach: true,\r\n            simulations: true\r\n        },\r\n        admin: {\r\n            downloads: true,\r\n            ai_coach: true,\r\n            simulations: true\r\n        }\r\n    };\r\n\r\n    return packs[packType] || packs.basic;\r\n};\r\n\r\n// =====================================================\r\n// HOOK\r\n// =====================================================\r\n\r\n/**\r\n * Hook para verificar acceso a features seg√∫n permisos de franquicia\r\n */\r\nexport const useFeatureAccess = (): UseFeatureAccessReturn => {\r\n    const { user, isAdmin, loading: authLoading } = useAuth();\r\n    const [features, setFeatures] = useState<Features | null>(null);\r\n    const [pack, setPack] = useState<PackType | null>(null);\r\n    const [loading, setLoading] = useState(true);\r\n\r\n    useEffect(() => {\r\n        if (authLoading) return;\r\n\r\n        if (!user) {\r\n            setLoading(false);\r\n            return;\r\n        }\r\n\r\n        const fetchUserFeatures = async () => {\r\n            try {\r\n                // ‚úÖ Usar el check real de Admin del contexto (basado en Custom Claims/Config)\r\n                if (isAdmin) {\r\n                    setFeatures({\r\n                        downloads: true,\r\n                        ai_coach: true,\r\n                        simulations: true\r\n                    });\r\n                    setPack('admin');\r\n                    setLoading(false);\r\n                    return;\r\n                }\r\n\r\n                // Buscar datos de franquicia\r\n                // Use user.uid as primary franchise identifier\r\n                const franchiseIdToFetch = user.uid;\r\n                const franchiseDoc = await getDoc(doc(db, 'franchises', franchiseIdToFetch));\r\n\r\n                if (franchiseDoc.exists()) {\r\n                    const data = franchiseDoc.data();\r\n\r\n                    // Si tiene features definidas, usarlas\r\n                    if (data.features) {\r\n                        setFeatures(data.features as Features);\r\n                    } else {\r\n                        // Crear features por defecto seg√∫n pack\r\n                        const packType = (data.pack as PackType) || 'basic';\r\n                        const defaultFeatures = getDefaultFeaturesByPack(packType);\r\n                        setFeatures(defaultFeatures);\r\n                    }\r\n\r\n                    setPack((data.pack as PackType) || 'basic');\r\n                } else {\r\n                    // Usuario sin franquicia registrada - asignar b√°sico\r\n                    const defaultFeatures = getDefaultFeaturesByPack('basic');\r\n                    setFeatures(defaultFeatures);\r\n                    setPack('basic');\r\n                }\r\n\r\n                setLoading(false);\r\n            } catch (error) {\r\n                console.error('Error fetching user features:', error);\r\n                // En caso de error, dar acceso b√°sico\r\n                setFeatures(getDefaultFeaturesByPack('basic'));\r\n                setPack('basic');\r\n                setLoading(false);\r\n            }\r\n        };\r\n\r\n        fetchUserFeatures();\r\n    }, [user, isAdmin, authLoading]);\r\n\r\n    /**\r\n     * Verifica si el usuario tiene acceso a una feature espec√≠fica\r\n     */\r\n    const hasAccess = (featureName: string): boolean => {\r\n        if (loading) return false;\r\n        if (!features) return false;\r\n        return features[featureName] === true;\r\n    };\r\n\r\n    return {\r\n        hasAccess,\r\n        features,\r\n        pack,\r\n        loading\r\n    };\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\hooks\\useFinancialPulse.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":9,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":9,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[327,330],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[327,330],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'currentMonthId'. Either include it or remove the dependency array.","line":107,"column":8,"nodeType":"ArrayExpression","endLine":107,"endColumn":28,"suggestions":[{"desc":"Update the dependencies array to be: [franchiseId, docId, currentMonthId]","fix":{"range":[4319,4339],"text":"[franchiseId, docId, currentMonthId]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport { useState, useEffect } from 'react';\r\nimport { onSnapshot, collection, query, where, getDocs } from 'firebase/firestore';\r\nimport { db } from '../lib/firebase'; // Correct path for this project\r\n\r\nexport interface FinancialData {\r\n    totalOperationalHours: number;\r\n    totalShiftsCount: number;\r\n    [key: string]: any;\r\n}\r\n\r\nexport interface FinancialTrendData extends FinancialData {\r\n    monthLabel: string;\r\n    month?: string;\r\n}\r\n\r\nexport interface UseFinancialPulseReturn {\r\n    currentMonthData: FinancialData | null;\r\n    yearlyTrend: FinancialTrendData[];\r\n    loading: boolean;\r\n}\r\n\r\nexport const useFinancialPulse = (franchiseId: string | null): UseFinancialPulseReturn => {\r\n    const [currentMonthData, setCurrentMonthData] = useState<FinancialData | null>(null);\r\n    const [yearlyTrend, setYearlyTrend] = useState<FinancialTrendData[]>([]);\r\n    const [loading, setLoading] = useState<boolean>(true);\r\n\r\n    const date = new Date();\r\n    const currentMonthId = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;\r\n    const docId = franchiseId ? `${franchiseId}_${currentMonthId}` : null;\r\n\r\n    useEffect(() => {\r\n        if (!franchiseId || !docId) {\r\n            // If no franchise selected, maybe we shouldn't be loading? \r\n            // Or just return empty\r\n            return;\r\n        }\r\n        // Loading state initialized in useState, no need to set here\r\n\r\n        // 1. ESCUCHA EN VIVO DEL MES ACTUAL (Real-time Socket) üî¥\r\n        // Strategy change: Fetch ALL summaries for the month and find OURS in memory.\r\n        // This bypasses Firestore's strict exact-string and case-sensitive filtering failures\r\n        // when valid data exists but has casing/whitespace mismatches.\r\n        const q = query(\r\n            collection(db, 'financial_summaries'),\r\n            where('month', '==', currentMonthId)\r\n        );\r\n\r\n        const unsubscribe = onSnapshot(q, (snapshot) => {\r\n            if (!snapshot.empty) {\r\n                const targetId = franchiseId.trim().toLowerCase();\r\n\r\n                // Find the doc that matches our franchise ID (normalized)\r\n                const docSnap = snapshot.docs.find(d => {\r\n                    const data = d.data();\r\n                    const dataId = data.franchiseId ? String(data.franchiseId).trim().toLowerCase() : '';\r\n                    return dataId === targetId;\r\n                });\r\n\r\n                if (docSnap) {\r\n                    setCurrentMonthData(docSnap.data() as FinancialData);\r\n                } else {\r\n                    // Try fallback: Check if doc.id CONTAINS the franchise ID (normalized)\r\n                    const fallbackSnap = snapshot.docs.find(d => d.id.toLowerCase().includes(targetId));\r\n                    if (fallbackSnap) {\r\n                        setCurrentMonthData(fallbackSnap.data() as FinancialData);\r\n                    } else {\r\n                        setCurrentMonthData({ totalOperationalHours: 0, totalShiftsCount: 0 });\r\n                    }\r\n                }\r\n            } else {\r\n                // Mes nuevo o sin datos a√∫n\r\n                setCurrentMonthData({ totalOperationalHours: 0, totalShiftsCount: 0 });\r\n            }\r\n            setLoading(false);\r\n        }, (_error) => {\r\n            setLoading(false);\r\n        });\r\n\r\n        // 2. CARGA DEL HISTORIAL ANUAL (Para la Gr√°fica) üìä\r\n        const fetchTrend = async () => {\r\n            try {\r\n                const q = query(\r\n                    collection(db, 'financial_summaries'), // FIXED\r\n                    where('franchiseId', '==', franchiseId)\r\n                );\r\n                const snap = await getDocs(q);\r\n\r\n                const trend = snap.docs.map(d => {\r\n                    const data = d.data();\r\n                    const monthLabel = data.month ? (data.month as string).split('-')[1] : '??';\r\n                    return {\r\n                        ...data,\r\n                        monthLabel\r\n                    } as FinancialTrendData;\r\n                }).sort((a, b) => (a.month || '').localeCompare(b.month || ''));\r\n\r\n                setYearlyTrend(trend);\r\n            } catch {\r\n                // Historical data not critical - fail silently\r\n            }\r\n        };\r\n\r\n        fetchTrend();\r\n\r\n        return () => unsubscribe();\r\n    }, [franchiseId, docId]);\r\n\r\n    return { currentMonthData, yearlyTrend, loading };\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\hooks\\useFleet.ts","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\hooks\\useFleet.ts:43:13\n  41 |     useEffect(() => {\n  42 |         if (!franchiseId) {\n> 43 |             setLoading(false);\n     |             ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  44 |             return;\n  45 |         }\n  46 |","line":43,"column":13,"nodeType":null,"endLine":43,"endColumn":23}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useCallback } from 'react';\r\nimport { fleetService } from '../services/fleetService';\r\nimport { useToast } from './useToast';\r\n\r\n// =====================================================\r\n// TYPES & INTERFACES\r\n// =====================================================\r\n\r\nimport { Moto, MotoStatus } from '../schemas/fleet';\r\n\r\nexport interface Vehicle extends Omit<Moto, 'id'> {\r\n    id: string; // useFleet expects id to be string, Moto has branded MotoId\r\n    alias?: string;\r\n    [key: string]: unknown;\r\n}\r\n\r\nexport type VehicleInput = Omit<Vehicle, 'id' | 'createdAt' | 'updatedAt' | 'franchiseId' | 'status'> & {\r\n    status?: MotoStatus;\r\n};\r\n\r\nexport interface UseFleetReturn {\r\n    vehicles: Vehicle[];\r\n    loading: boolean;\r\n    error: Error | null;\r\n    addVehicle: (data: VehicleInput) => Promise<boolean>;\r\n    updateVehicle: (id: string, data: Partial<VehicleInput>) => Promise<boolean>;\r\n    deleteVehicle: (id: string) => Promise<boolean>;\r\n}\r\n\r\n// =====================================================\r\n// HOOK\r\n// =====================================================\r\n\r\nexport const useFleet = (franchiseId: string | null | undefined): UseFleetReturn => {\r\n    const [vehicles, setVehicles] = useState<Vehicle[]>([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const [error, setError] = useState<Error | null>(null);\r\n    const { toast } = useToast() || {}; // Fallback seguro si no hay contexto\r\n\r\n    // Efecto de Suscripci√≥n\r\n    useEffect(() => {\r\n        if (!franchiseId) {\r\n            setLoading(false);\r\n            return;\r\n        }\r\n\r\n        setLoading(true);\r\n\r\n        // Iniciamos la escucha\r\n        const unsubscribe = fleetService.subscribeToFleet(franchiseId, (data: Moto[]) => {\r\n            setVehicles(data as unknown as Vehicle[]);\r\n            setLoading(false);\r\n            setError(null);\r\n        });\r\n\r\n        // Cleanup al desmontar o cambiar de franquicia\r\n        return () => unsubscribe();\r\n    }, [franchiseId]);\r\n\r\n    // Wrappers de Acciones (para manejo de errores UI)\r\n\r\n    const addVehicle = useCallback(async (data: VehicleInput): Promise<boolean> => {\r\n        if (!franchiseId) return false;\r\n\r\n        try {\r\n            await fleetService.createVehicle(franchiseId, data);\r\n            toast?.success('Veh√≠culo a√±adido correctamente');\r\n            return true;\r\n        } catch (err) {\r\n            console.error(err);\r\n            setError(err as Error);\r\n            toast?.error('Error al a√±adir veh√≠culo');\r\n            return false;\r\n        }\r\n    }, [franchiseId, toast]);\r\n\r\n    const updateVehicle = useCallback(async (id: string, data: Partial<VehicleInput>): Promise<boolean> => {\r\n        try {\r\n            await fleetService.updateVehicle(id, data);\r\n            toast?.success('Veh√≠culo actualizado');\r\n            return true;\r\n        } catch (err) {\r\n            console.error(err);\r\n            setError(err as Error);\r\n            toast?.error('Error al actualizar');\r\n            return false;\r\n        }\r\n    }, [toast]);\r\n\r\n    const deleteVehicle = useCallback(async (id: string): Promise<boolean> => {\r\n        try {\r\n            await fleetService.deleteVehicle(id);\r\n            toast?.success('Veh√≠culo eliminado');\r\n            return true;\r\n        } catch (err) {\r\n            console.error(err);\r\n            setError(err as Error);\r\n            toast?.error('Error al eliminar');\r\n            return false;\r\n        }\r\n    }, [toast]);\r\n\r\n    return {\r\n        vehicles,\r\n        loading,\r\n        error,\r\n        addVehicle,\r\n        updateVehicle,\r\n        deleteVehicle\r\n    };\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\hooks\\useFranchiseFinance.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":10,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":10,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[548,551],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[548,551],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":15,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":15,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[642,645],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[642,645],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":103,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":103,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4084,4087],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4084,4087],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\r\nimport { financeService } from '../services/financeService';\r\nimport { calculateMonthlyRevenue, calculateExpenses, analyzeFinancialHealth, DEFAULT_MONTH_DATA, type MonthlyData, type FinancialReport, type FinancialAnalysis } from '../lib/finance';\r\nimport { useAuth } from '../context/AuthContext';\r\nimport { logAction, AUDIT_ACTIONS } from '../lib/audit';\r\n\r\ninterface FranchiseFinanceParams {\r\n    franchiseId?: string;\r\n    month?: string; // YYYY-MM\r\n    tariffs?: any;\r\n}\r\n\r\nexport interface FranchiseFinanceHook {\r\n    rawData: MonthlyData;\r\n    trendData: any[]; // Specific Trend type could be added later\r\n    operations: {\r\n        totalOperationalHours: number;\r\n        totalShiftsCount: number;\r\n    };\r\n    accounting: {\r\n        revenue: number;\r\n        orders: number;\r\n        report: FinancialReport;\r\n    };\r\n    analysis: FinancialAnalysis;\r\n    loading: boolean;\r\n    isFetching: boolean;\r\n    error: Error | null;\r\n    updateFinance: (data: Partial<MonthlyData>) => Promise<void>;\r\n    isSaving: boolean;\r\n    refetch: () => void;\r\n}\r\n\r\nexport const useFranchiseFinance = ({ franchiseId, month, tariffs }: FranchiseFinanceParams): FranchiseFinanceHook => {\r\n    const { user } = useAuth();\r\n    const queryClient = useQueryClient();\r\n    const queryKey = ['franchise-finance', franchiseId, month];\r\n\r\n    // 1. FETCH DATA\r\n    const { data: rawData, isLoading, isFetching, error, refetch } = useQuery({\r\n        queryKey,\r\n        queryFn: async () => {\r\n            if (!franchiseId || !month) return DEFAULT_MONTH_DATA;\r\n            const data = await financeService.getFinancialData(franchiseId, month);\r\n\r\n            // Filter out deleted records (Consistency enhancement)\r\n            if (data?.status === 'deleted') {\r\n                return DEFAULT_MONTH_DATA;\r\n            }\r\n\r\n            return data || DEFAULT_MONTH_DATA;\r\n        },\r\n        enabled: !!user && !!franchiseId && !!month,\r\n        staleTime: 1000 * 60 * 5, // 5 Minutes Stale Time (Reduces flickering)\r\n        refetchOnWindowFocus: true,\r\n    });\r\n\r\n    // 2. CALCULATE DERIVED STATE\r\n    // Combine Accounting & Operational logic\r\n    const currentData = (rawData || DEFAULT_MONTH_DATA) as MonthlyData;\r\n\r\n    // A. Operational Data (From useFinancialPulse)\r\n    const operations = {\r\n        totalOperationalHours: Number(currentData.totalOperationalHours || 0),\r\n        totalShiftsCount: Number(currentData.totalShiftsCount || 0),\r\n        // Add other operational fields here as needed\r\n    };\r\n\r\n    // B. Accounting Data (From useDashboardData)\r\n    const revenue = calculateMonthlyRevenue(currentData, tariffs);\r\n    const orders = Number(currentData.orders || 0);\r\n\r\n    // Calculate expenses breakdown and taxes\r\n    const report = calculateExpenses(revenue, orders, currentData);\r\n\r\n    // AI/Algo Analysis\r\n    const analysis = analyzeFinancialHealth(report.breakdown, revenue);\r\n\r\n    // 3. FETCH TREND DATA (New)\r\n    const { data: trendData } = useQuery({\r\n        queryKey: ['franchise-trend', franchiseId],\r\n        queryFn: async () => {\r\n            if (!franchiseId) return [];\r\n            // Fetch last 6 months\r\n            return financeService.getFinancialTrend(franchiseId, 6);\r\n        },\r\n        enabled: !!franchiseId,\r\n        staleTime: 1000 * 60 * 10 // 10 minutes\r\n    });\r\n\r\n    // 4. MUTATIONS (Save/Update)\r\n    const saveMutation = useMutation({\r\n        mutationFn: async (newData: Partial<MonthlyData>) => {\r\n            if (!franchiseId || !month) throw new Error(\"Missing Context\");\r\n            await financeService.updateFinancialData(franchiseId, month, newData);\r\n            if (user) {\r\n                await logAction(user, AUDIT_ACTIONS.MONTHLY_DATA_EDITED, { month, context: 'useFranchiseFinance' });\r\n            }\r\n        },\r\n        onMutate: async (newData) => {\r\n            await queryClient.cancelQueries({ queryKey });\r\n            const previousData = queryClient.getQueryData(queryKey);\r\n            queryClient.setQueryData(queryKey, (old: any) => ({ ...old, ...newData }));\r\n            return { previousData };\r\n        },\r\n        onError: (_err, _newData, context) => {\r\n            if (context?.previousData) {\r\n                queryClient.setQueryData(queryKey, context.previousData);\r\n            }\r\n        },\r\n        onSettled: () => {\r\n            queryClient.invalidateQueries({ queryKey });\r\n            queryClient.invalidateQueries({ queryKey: ['franchise-trend', franchiseId] });\r\n        },\r\n    });\r\n\r\n    return {\r\n        // Raw Data\r\n        rawData: currentData,\r\n        trendData: trendData || [],\r\n\r\n        // derived Domains\r\n        operations,\r\n        accounting: {\r\n            revenue,\r\n            orders,\r\n            report, // Contains breakdown, taxes, ROI\r\n        },\r\n\r\n        // Insights\r\n        analysis,\r\n\r\n        // Meta\r\n        loading: isLoading,\r\n        isFetching,\r\n        error,\r\n\r\n        // Actions\r\n        updateFinance: saveMutation.mutateAsync,\r\n        isSaving: saveMutation.isPending,\r\n        refetch // Expose refetch\r\n    };\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\hooks\\useFranchiseHistory.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":60,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":60,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2234,2237],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2234,2237],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useCallback } from 'react';\r\nimport { collection, query, where, getDocs, orderBy } from 'firebase/firestore';\r\nimport { db } from '../lib/firebase';\r\n\r\nexport interface MonthlyRecord {\r\n    id: string;\r\n    month: string;\r\n    revenue: number;\r\n    totalExpenses: number;\r\n    profit: number;\r\n    updated_at?: Date | string;\r\n    status: 'draft' | 'pending' | 'approved' | 'rejected' | 'locked' | 'unlock_requested';\r\n    is_locked?: boolean;\r\n    unlockReason?: string;\r\n    rejectionReason?: string;\r\n}\r\n\r\nexport const useFranchiseHistory = (franchiseId?: string) => {\r\n    const [records, setRecords] = useState<MonthlyRecord[]>([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const [error, setError] = useState<string | null>(null);\r\n\r\n    const loadRecords = useCallback(async () => {\r\n        if (!franchiseId) {\r\n            setLoading(false);\r\n            return;\r\n        }\r\n\r\n        setLoading(true);\r\n        setError(null);\r\n        try {\r\n            const q = query(\r\n                collection(db, 'financial_summaries'),\r\n                where('franchiseId', '==', franchiseId),\r\n                orderBy('month', 'desc')\r\n            );\r\n\r\n            const snapshot = await getDocs(q);\r\n            const data = snapshot.docs\r\n                .map(doc => {\r\n                    const d = doc.data();\r\n                    const revenue = d.revenue || d.totalIncome || d.grossIncome || 0;\r\n                    const expenses = d.totalExpenses || d.expenses || 0;\r\n\r\n                    return {\r\n                        id: doc.id,\r\n                        month: d.month,\r\n                        revenue,\r\n                        totalExpenses: expenses,\r\n                        profit: revenue - expenses,\r\n                        updated_at: d.updatedAt?.toDate?.() || d.updated_at || new Date(),\r\n                        status: d.status || (d.is_locked ? 'locked' : 'draft'),\r\n                        is_locked: d.is_locked || false,\r\n                        unlockReason: d.unlockReason,\r\n                        rejectionReason: d.rejectionReason\r\n                    } as MonthlyRecord;\r\n                });\r\n\r\n            setRecords(data);\r\n        } catch (err: any) {\r\n            console.error('Error loading monthly records:', err);\r\n            setError(err.message || 'Error desconocido');\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    }, [franchiseId]);\r\n\r\n    useEffect(() => {\r\n        loadRecords();\r\n    }, [loadRecords]);\r\n\r\n    return { records, loading, error, refresh: loadRecords };\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\hooks\\useIntelligence.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":13,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":13,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[313,316],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[313,316],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":14,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":14,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[333,336],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[333,336],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":15,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":15,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[361,364],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[361,364],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useMemo } from 'react';\r\nimport {\r\n    checkSupportHealth,\r\n    detectUserAnomaly,\r\n    generatePredictiveAlerts,\r\n    calculateHealthScore,\r\n    type SupportAnalysis,\r\n    type UserAnomalyAnalysis,\r\n    type Alert\r\n} from '../utils/analyticsHelpers';\r\n\r\ninterface UseIntelligenceParams {\r\n    tickets?: any[];\r\n    users?: any[];\r\n    dashboardData?: any;\r\n}\r\n\r\nexport const useIntelligence = ({ tickets = [], users = [], dashboardData = {} }: UseIntelligenceParams) => {\r\n\r\n    // 1. Analyze Support Vector\r\n    const supportAnalysis: SupportAnalysis = useMemo(() => {\r\n        return checkSupportHealth(tickets);\r\n    }, [tickets]);\r\n\r\n    // 2. Analyze User/Growth Vector\r\n    const userAnalysis: UserAnomalyAnalysis = useMemo(() => {\r\n        return detectUserAnomaly(users, dashboardData);\r\n    }, [users, dashboardData]);\r\n\r\n    // 3. Aggregate Alerts\r\n    const alerts: Alert[] = useMemo(() => {\r\n        return generatePredictiveAlerts(supportAnalysis, userAnalysis);\r\n    }, [supportAnalysis, userAnalysis]);\r\n\r\n    // 4. Calculate Global Health Score\r\n    const healthScore: number = useMemo(() => {\r\n        return calculateHealthScore(alerts);\r\n    }, [alerts]);\r\n\r\n    // 5. Predictive Trends (Placeholder for ML expansion)\r\n    const predictions = useMemo(() => {\r\n        return {\r\n            supportLoad: supportAnalysis.status === 'bottleneck' ? 'increasing' : 'stable',\r\n            growth: userAnalysis.detected ? 'feature_spike' : 'organic',\r\n            nextAction: alerts.length > 0 ? 'immediate_attention' : 'monitor'\r\n        };\r\n    }, [supportAnalysis, userAnalysis, alerts]);\r\n\r\n    return {\r\n        // High Level\r\n        healthScore,\r\n        status: healthScore > 80 ? 'optimal' : healthScore > 50 ? 'warning' : 'critical',\r\n\r\n        // Actionable\r\n        alerts,\r\n        predictions,\r\n\r\n        // Raw Analysis (for drilling down)\r\n        raw: {\r\n            support: supportAnalysis,\r\n            users: userAnalysis\r\n        }\r\n    };\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\hooks\\useKanban.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\hooks\\useKeyboardShortcuts.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\hooks\\useMediaQuery.ts","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\hooks\\useMediaQuery.ts:8:9\n   6 |     useEffect(() => {\n   7 |         const media = window.matchMedia(query);\n>  8 |         setMatches(media.matches);\n     |         ^^^^^^^^^^ Avoid calling setState() directly within an effect\n   9 |\n  10 |         const listener = () => setMatches(media.matches);\n  11 |         media.addEventListener('change', listener);","line":8,"column":9,"nodeType":null,"endLine":8,"endColumn":19}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react';\r\n\r\nexport const useMediaQuery = (query: string): boolean => {\r\n    const [matches, setMatches] = useState<boolean>(false);\r\n\r\n    useEffect(() => {\r\n        const media = window.matchMedia(query);\r\n        setMatches(media.matches);\r\n\r\n        const listener = () => setMatches(media.matches);\r\n        media.addEventListener('change', listener);\r\n\r\n        return () => media.removeEventListener('change', listener);\r\n    }, [query]); // Removed 'matches' from dependency array as it causes unnecessary re-renders\r\n\r\n    return matches;\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\hooks\\useNetworkFinance.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\hooks\\useRBAC.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\hooks\\useShiftOperations.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":15,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":15,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[483,486],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[483,486],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":28,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":28,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[749,752],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[749,752],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":34,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":34,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[951,954],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[951,954],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":35,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":35,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[979,982],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[979,982],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":63,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":63,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2141,2144],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2141,2144],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":75,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":75,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2616,2619],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2616,2619],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":80,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":80,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2784,2787],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2784,2787],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":127,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":127,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4962,4965],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4962,4965],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useCallback } from 'react';\r\nimport { shiftService } from '../services/shiftService';\r\n\r\nexport interface ShiftData {\r\n    shiftId?: string;\r\n    motoId?: string | null;\r\n    motoPlate?: string;\r\n    userId?: string | null;\r\n    riderId?: string | null;\r\n    riderName?: string;\r\n    start?: string; // ISO string \r\n    end?: string; // ISO string\r\n    startAt?: string; // Mapping compatibility\r\n    endAt?: string;   // Mapping compatibility\r\n    [key: string]: any;\r\n}\r\n\r\nexport interface ShiftOperationResult {\r\n    success: boolean;\r\n    count?: number;\r\n    error?: string;\r\n}\r\n\r\n// Minimal interface for Moto to avoid deep dependency if not needed\r\ninterface Moto {\r\n    id: string;\r\n    plate: string;\r\n    [key: string]: any;\r\n}\r\n\r\nexport const useShiftOperations = (\r\n    franchiseId: string | null,\r\n    // weekData and updateWeekData might be used in future or internally, keeping signatures compatible\r\n    _weekData?: any,\r\n    _updateWeekData?: any,\r\n    motos: Moto[] = []\r\n) => {\r\n    const [isSaving, setIsSaving] = useState(false);\r\n\r\n    const addOrUpdateShift = useCallback(async (shiftData: ShiftData, isEdit: boolean): Promise<ShiftOperationResult> => {\r\n        setIsSaving(true);\r\n        try {\r\n            // Validaciones b√°sicas\r\n            if (!franchiseId) throw new Error(\"No franchise ID\");\r\n\r\n            const payload = {\r\n                franchiseId,\r\n                riderId: shiftData.riderId || shiftData.userId || null,\r\n                riderName: shiftData.riderName || 'Sin asignar',\r\n                motoId: shiftData.motoId || null,\r\n                motoPlate: shiftData.motoPlate || motos.find(m => m.id === shiftData.motoId)?.plate || '',\r\n                startAt: shiftData.startAt || shiftData.start || '',\r\n                endAt: shiftData.endAt || shiftData.end || ''\r\n            };\r\n\r\n            if (isEdit && shiftData.shiftId) {\r\n                await shiftService.updateShift(shiftData.shiftId, payload);\r\n            } else {\r\n                await shiftService.createShift(payload);\r\n            }\r\n\r\n            return { success: true };\r\n        } catch (error: any) {\r\n            console.error(\"Shift Operation Error:\", error);\r\n            return { success: false, error: error.message || String(error) };\r\n        } finally {\r\n            setIsSaving(false);\r\n        }\r\n    }, [franchiseId, motos]);\r\n\r\n    const removeShift = useCallback(async (shiftId: string): Promise<ShiftOperationResult> => {\r\n        try {\r\n            await shiftService.deleteShift(shiftId);\r\n            return { success: true };\r\n        } catch (error: any) {\r\n            return { success: false, error: error.message || String(error) };\r\n        }\r\n    }, []);\r\n\r\n    const quickFillShifts = useCallback(async (params: any): Promise<ShiftOperationResult> => {\r\n        const { date, riders } = params; // Expect riders to be passed\r\n        if (!date || !riders || !Array.isArray(riders)) {\r\n            return { success: false, error: \"Missing date or riders for smart fill\" };\r\n        }\r\n\r\n        setIsSaving(true);\r\n        let count = 0;\r\n        const primeHours = [13, 14, 20, 21, 22]; // Standard Prime Time\r\n\r\n        try {\r\n            const promises: Promise<void>[] = [];\r\n\r\n            for (const rider of riders) {\r\n                // Skip if rider is not active or eligible? Assuming all passed riders are eligible.\r\n\r\n                for (const h of primeHours) {\r\n                    // Check logic could be here if we had synchronous access to all shifts, \r\n                    // but for \"Quick Fill\" blind fire is often acceptable if the user asked for it.\r\n                    // However, avoiding duplicates is better.\r\n                    // Let's assume the user wants to fill these specific slots.\r\n\r\n                    // better to construct safely if possible, but params.date comes from format(..., 'yyyy-MM-dd') in Scheduler.\r\n                    // Actually, 'yyyy-MM-dd' + 'T' + HH:mm... is safer.\r\n\r\n                    const startIso = `${date}T${h.toString().padStart(2, '0')}:00:00`;\r\n                    const endIso = `${date}T${(h + 1).toString().padStart(2, '0')}:00:00`;\r\n\r\n                    // Simple logic: Create 1h shift\r\n                    const payload = {\r\n                        franchiseId: franchiseId!, // Checked at start of hook usually, but let's trust\r\n                        riderId: rider.id,\r\n                        riderName: rider.fullName,\r\n                        motoId: null,\r\n                        motoPlate: '',\r\n                        startAt: new Date(startIso).toISOString(),\r\n                        endAt: new Date(endIso).toISOString()\r\n                    };\r\n\r\n                    promises.push(shiftService.createShift(payload));\r\n                    count++;\r\n                }\r\n            }\r\n\r\n            await Promise.all(promises);\r\n            return { success: true, count };\r\n\r\n        } catch (error: any) {\r\n            console.error(\"Smart Fill Error:\", error);\r\n            return { success: false, error: error.message };\r\n        } finally {\r\n            setIsSaving(false);\r\n        }\r\n    }, [franchiseId]);\r\n\r\n    return { isSaving, addOrUpdateShift, removeShift, quickFillShifts };\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\hooks\\useSupport.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":9,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":9,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[312,315],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[312,315],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useContext } from 'react';\r\nimport { SupportContext } from '../context/SupportContext';\r\n\r\nexport const useSupport = () => {\r\n    const context = useContext(SupportContext);\r\n    if (!context) {\r\n        throw new Error('useSupport must be used within a SupportProvider');\r\n    }\r\n    return context as any; // Cast to any until SupportContext is typed\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\hooks\\useSupportHub.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":18,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":18,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[738,741],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[738,741],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":33,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":33,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1343,1346],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1343,1346],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useCallback, useMemo } from 'react';\r\nimport { db, storage } from '../lib/firebase';\r\nimport { collection, addDoc, serverTimestamp, query, where, orderBy, onSnapshot, updateDoc, doc } from 'firebase/firestore';\r\nimport { ref, uploadBytes, getDownloadURL } from 'firebase/storage';\r\nimport { sendTicketCreatedEmail } from '../lib/email';\r\nimport { logAction, AUDIT_ACTIONS } from '../lib/audit';\r\nimport { getSuggestions } from '../lib/knowledgeBase';\r\nimport { type Ticket } from '../types/support';\r\nexport type { Ticket };\r\n\r\nexport interface CreateTicketParams {\r\n    subject: string;\r\n    message: string;\r\n    urgency: Ticket['urgency'];\r\n    category: string;\r\n}\r\n\r\nexport const useSupportHub = (user: any) => {\r\n    // --- STATE ---\r\n    const [myTickets, setMyTickets] = useState<Ticket[]>([]);\r\n    const [loadingTickets, setLoadingTickets] = useState(true);\r\n    const [sending, setSending] = useState(false);\r\n    const [success, setSuccess] = useState(false);\r\n\r\n    // Upload State (Atomic)\r\n    const [file, setFile] = useState<File | null>(null);\r\n    const [uploading, setUploading] = useState(false);\r\n\r\n    // Filters & Search\r\n    const [ticketFilter, setTicketFilter] = useState<'all' | 'open' | 'resolved'>('all');\r\n\r\n    // Form Assistant\r\n    const [suggestions, setSuggestions] = useState<any[]>([]);\r\n\r\n    // --- REAL-TIME DATA ---\r\n    useEffect(() => {\r\n        if (!user) return;\r\n\r\n        const q = query(\r\n            collection(db, \"tickets\"),\r\n            where(\"uid\", \"==\", user.uid),\r\n            orderBy(\"createdAt\", \"desc\")\r\n        );\r\n\r\n        const unsubscribe = onSnapshot(q, (snapshot) => {\r\n            const tickets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() } as Ticket));\r\n            setMyTickets(tickets);\r\n            setLoadingTickets(false);\r\n        }, (error) => {\r\n            console.warn(\"Error fetching my tickets:\", error);\r\n            setLoadingTickets(false);\r\n        });\r\n\r\n        return () => unsubscribe();\r\n    }, [user]);\r\n\r\n    // --- ACTIONS ---\r\n\r\n    const handleSubjectChange = useCallback((text: string) => {\r\n        if (text.length > 2) {\r\n            setSuggestions(getSuggestions(text));\r\n        } else {\r\n            setSuggestions([]);\r\n        }\r\n    }, []);\r\n\r\n    const createTicket = useCallback(async ({ subject, message, urgency, category }: CreateTicketParams) => {\r\n        if (!user || !subject || !message) return;\r\n\r\n        setSending(true);\r\n        try {\r\n            // 1. Initial Firestore Doc\r\n            const ticketData = {\r\n                uid: user.uid,\r\n                email: user.email,\r\n                subject,\r\n                message,\r\n                urgency,\r\n                category,\r\n                status: 'open',\r\n                createdAt: serverTimestamp(),\r\n                read: false,\r\n                hasAttachment: !!file\r\n            };\r\n\r\n            const docRef = await addDoc(collection(db, \"tickets\"), ticketData);\r\n\r\n            // 2. Upload File (if exists)\r\n            let attachmentUrl: string | null = null;\r\n            if (file) {\r\n                setUploading(true);\r\n                try {\r\n                    const storageRef = ref(storage, `tickets/${docRef.id}/${file.name}`);\r\n                    await uploadBytes(storageRef, file);\r\n                    attachmentUrl = await getDownloadURL(storageRef);\r\n\r\n                    // Update ticket with URL\r\n                    await updateDoc(doc(db, \"tickets\", docRef.id), { attachmentUrl });\r\n                } catch (uploadErr) {\r\n                    console.error(\"Upload failed but ticket created:\", uploadErr);\r\n                    // We don't fail the whole process if upload fails, but we might warn\r\n                } finally {\r\n                    setUploading(false);\r\n                }\r\n            }\r\n\r\n            // 3. Post-Processing\r\n            logAction(user, AUDIT_ACTIONS.TICKET_CREATED, {\r\n                ticketId: docRef.id,\r\n                subject,\r\n                category,\r\n                urgency,\r\n                hasAttachment: !!file\r\n            });\r\n\r\n            sendTicketCreatedEmail({\r\n                id: docRef.id,\r\n                email: user.email,\r\n                subject,\r\n                message: message + (attachmentUrl && file ? `\\n\\n[Adjunto: ${file.name}]` : ''),\r\n                urgency,\r\n                category\r\n            }).catch(err => console.warn(\"Email send failed\", err));\r\n\r\n            setSuccess(true);\r\n            setFile(null); // Reset file\r\n            setSuggestions([]);\r\n\r\n            // Auto-hide success message\r\n            setTimeout(() => setSuccess(false), 5000);\r\n\r\n            return true;\r\n        } catch (error) {\r\n            console.error(\"Error creating ticket:\", error);\r\n            throw error;\r\n        } finally {\r\n            setSending(false);\r\n        }\r\n    }, [user, file]);\r\n\r\n    // --- DERIVED STATE ---\r\n    const filteredTickets = useMemo(() => {\r\n        if (ticketFilter === 'all') return myTickets;\r\n        if (ticketFilter === 'open') return myTickets.filter(t => t.status !== 'resolved');\r\n        return myTickets.filter(t => t.status === 'resolved');\r\n    }, [myTickets, ticketFilter]);\r\n\r\n    return {\r\n        // Data\r\n        tickets: filteredTickets,\r\n        allTicketsCount: myTickets.length,\r\n        loading: loadingTickets,\r\n\r\n        // Form State\r\n        sending,\r\n        success,\r\n        suggestions,\r\n        setSuggestions, // In case we need manual clear\r\n\r\n        // Upload State\r\n        file,\r\n        setFile,\r\n        uploading,\r\n\r\n        // Actions\r\n        handleSubjectChange,\r\n        createTicket,\r\n        setTicketFilter,\r\n        ticketFilter,\r\n\r\n        // Helper\r\n        setSuccess\r\n    };\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\hooks\\useSupportManager.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":27,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":27,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[889,892],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[889,892],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":29,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":29,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[940,943],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[940,943],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":50,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":50,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1382,1385],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1382,1385],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useMemo, useCallback, useRef } from 'react';\r\nimport { collection, query, orderBy, onSnapshot, doc, updateDoc, serverTimestamp, addDoc } from 'firebase/firestore';\r\nimport { db } from '../lib/firebase';\r\nimport { logAction, AUDIT_ACTIONS } from '../lib/audit';\r\nimport { sendTicketReplyEmail } from '../lib/email';\r\nimport { createNotification } from '../lib/notifications';\r\nimport { Ticket } from './useSupportHub';\r\nexport type { Ticket };\r\n\r\nexport interface Vehicle {\r\n    id: string;\r\n    plate: string;\r\n    model: string;\r\n    alias?: string;\r\n    status: 'active' | 'maintenance' | 'stopped' | 'sold';\r\n    currentKm: number;\r\n    nextRevisionKm: number;\r\n    franchise_id: string;\r\n    [key: string]: unknown;\r\n}\r\n\r\nexport interface TicketMessage {\r\n    id: string;\r\n    text: string;\r\n    senderId: string;\r\n    senderRole: string;\r\n    createdAt: any;\r\n    isInternal: boolean;\r\n    [key: string]: any;\r\n}\r\n\r\nexport interface SupportMetrics {\r\n    total: number;\r\n    open: number;\r\n    pending: number;\r\n    investigating: number;\r\n    resolved: number;\r\n    unread: number;\r\n    critical: number;\r\n    high: number;\r\n    avgResponseMinutes: number;\r\n    byCategory: {\r\n        operativa: number;\r\n        finanzas: number;\r\n        tecnico: number;\r\n        accidente: number;\r\n    };\r\n}\r\n\r\nexport const useSupportManager = (currentUser: any) => {\r\n    // --- STATE ---\r\n    const [tickets, setTickets] = useState<Ticket[]>([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const [selectedTicketId, setSelectedTicketId] = useState<string | null>(null);\r\n    const [messages, setMessages] = useState<TicketMessage[]>([]);\r\n    const [reply, setReply] = useState('');\r\n    const [isInternal, setIsInternal] = useState(false);\r\n    const [isSendingReply, setIsSendingReply] = useState(false);\r\n\r\n    // Filters\r\n    const [searchQuery, setSearchQuery] = useState('');\r\n    const [filterTab, setFilterTab] = useState<'all' | 'open' | 'resolved' | 'high' | 'unread'>('all');\r\n    const [categoryFilter] = useState('all');\r\n    const messagesEndRef = useRef<HTMLDivElement>(null);\r\n\r\n    // --- REAL-TIME TICKETS ---\r\n    useEffect(() => {\r\n        const q = query(collection(db, \"tickets\"), orderBy(\"createdAt\", \"desc\"));\r\n        const unsubscribe = onSnapshot(q, (snapshot) => {\r\n            const t = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() } as Ticket));\r\n            setTickets(t);\r\n            setLoading(false);\r\n        }, (error) => {\r\n            console.error(\"Error fetching tickets:\", error);\r\n            setLoading(false);\r\n        });\r\n        return () => unsubscribe();\r\n    }, []);\r\n\r\n    // --- DERIVED SELECTED TICKET ---\r\n    const selectedTicket = useMemo(() =>\r\n        tickets.find(t => t.id === selectedTicketId),\r\n        [tickets, selectedTicketId]);\r\n\r\n    // --- REAL-TIME MESSAGES (For Selected) ---\r\n    useEffect(() => {\r\n        if (!selectedTicketId) {\r\n            setMessages([]);\r\n            return;\r\n        }\r\n        const q = query(\r\n            collection(db, \"tickets\", selectedTicketId, \"messages\"),\r\n            orderBy(\"createdAt\", \"asc\")\r\n        );\r\n        const unsubscribe = onSnapshot(q, (snapshot) => {\r\n            const msgs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() } as TicketMessage));\r\n            setMessages(msgs);\r\n        }, (error) => {\r\n            console.error(\"Error fetching messages:\", error);\r\n        });\r\n        return () => unsubscribe();\r\n    }, [selectedTicketId]);\r\n\r\n    // --- ACTIONS ---\r\n\r\n    const handleSelectTicket = useCallback((id: string) => {\r\n        setSelectedTicketId(id);\r\n    }, []);\r\n\r\n    const handleToggleRead = useCallback(async (e: React.MouseEvent | undefined, id: string, currentReadStatus: boolean) => {\r\n        if (e) e.stopPropagation();\r\n\r\n        // Optimistic UI Update\r\n        setTickets(prev => prev.map(t => t.id === id ? { ...t, read: !currentReadStatus } : t));\r\n\r\n        try {\r\n            await updateDoc(doc(db, \"tickets\", id), { read: !currentReadStatus });\r\n        } catch (error) {\r\n            console.error(\"Error toggling read:\", error);\r\n            // Revert on error (could be handled better but ok for now)\r\n            setTickets(prev => prev.map(t => t.id === id ? { ...t, read: currentReadStatus } : t));\r\n        }\r\n    }, []);\r\n\r\n    const handleStatusChange = useCallback(async (id: string, newStatus: string) => {\r\n        try {\r\n            await updateDoc(doc(db, \"tickets\", id), {\r\n                status: newStatus,\r\n                ...(newStatus === 'resolved' ? { resolvedAt: serverTimestamp() } : {})\r\n            });\r\n            if (currentUser) {\r\n                logAction(currentUser, AUDIT_ACTIONS.TICKET_UPDATE, { ticketId: id, status: newStatus });\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Error updating status:\", error);\r\n            throw new Error(\"No se pudo actualizar el estado.\");\r\n        }\r\n    }, [currentUser]);\r\n\r\n    const handleReply = useCallback(async (e?: React.FormEvent) => {\r\n        if (e) e.preventDefault();\r\n        if (!reply || !selectedTicket) return;\r\n\r\n        setIsSendingReply(true);\r\n        try {\r\n            // 1. Send Email (only if public)\r\n            if (!isInternal && selectedTicket.email) {\r\n                await sendTicketReplyEmail(\r\n                    selectedTicket.email,\r\n                    selectedTicket.subject,\r\n                    reply,\r\n                    selectedTicket.message || '',\r\n                    selectedTicket.id\r\n                );\r\n            }\r\n\r\n            // 2. Add to Messages Subcollection\r\n            await addDoc(collection(db, \"tickets\", selectedTicket.id, \"messages\"), {\r\n                text: reply,\r\n                senderId: currentUser.uid,\r\n                senderRole: 'admin',\r\n                createdAt: serverTimestamp(),\r\n                isInternal: isInternal\r\n            });\r\n\r\n            // 3. Update Parent Ticket\r\n            const newStatus = isInternal ? selectedTicket.status : 'pending_user';\r\n\r\n            // Safe cast if selectTicket is not strictly typed to include 'response' yet, \r\n            // but we added [key: string]: any to Ticket interface so it should be fine.\r\n            await updateDoc(doc(db, \"tickets\", selectedTicket.id), {\r\n                status: newStatus,\r\n                response: isInternal ? selectedTicket.response : reply,\r\n                respondedAt: serverTimestamp(),\r\n                read: true,\r\n                lastMessageAt: serverTimestamp()\r\n            });\r\n\r\n            if (currentUser) {\r\n                logAction(currentUser, isInternal ? AUDIT_ACTIONS.TICKET_NOTE : AUDIT_ACTIONS.TICKET_REPLIED, { ticketId: selectedTicket.id });\r\n            }\r\n\r\n            // Notification\r\n            if (!isInternal && selectedTicket.uid) {\r\n                createNotification(\r\n                    selectedTicket.uid,\r\n                    'Nueva respuesta de Soporte',\r\n                    `Han respondido a tu ticket: ${selectedTicket.subject}`,\r\n                    'info',\r\n                    `/support`\r\n                );\r\n            }\r\n\r\n            setReply('');\r\n            setIsInternal(false);\r\n        } catch (error) {\r\n            console.error(\"Reply error:\", error);\r\n            throw error;\r\n        } finally {\r\n            setIsSendingReply(false);\r\n        }\r\n    }, [reply, selectedTicket, currentUser, isInternal]);\r\n\r\n    const handleDeleteTicket = useCallback(async (id: string) => {\r\n        try {\r\n            await updateDoc(doc(db, \"tickets\", id), { deleted: true }); // Soft delete first? \r\n            // The user said \"elimina todos los tickets\", usually they mean hard delete in these types of apps.\r\n            // I'll do a hard delete as it's cleaner for \"starting over\".\r\n            await import('firebase/firestore').then(async ({ deleteDoc, writeBatch, getDocs }) => {\r\n                // Delete messages first\r\n                const msgsSnap = await getDocs(collection(db, \"tickets\", id, \"messages\"));\r\n                const batch = writeBatch(db);\r\n                msgsSnap.forEach(mDoc => batch.delete(mDoc.ref));\r\n                await batch.commit();\r\n\r\n                // Delete ticket\r\n                await deleteDoc(doc(db, \"tickets\", id));\r\n            });\r\n\r\n            if (currentUser) {\r\n                logAction(currentUser, AUDIT_ACTIONS.TICKET_UPDATE, { ticketId: id, action: 'deleted' });\r\n            }\r\n            if (selectedTicketId === id) setSelectedTicketId(null);\r\n        } catch (error) {\r\n            console.error(\"Delete error:\", error);\r\n            throw new Error(\"No se pudo eliminar el ticket.\");\r\n        }\r\n    }, [currentUser, selectedTicketId]);\r\n\r\n    const handleClearAllTickets = useCallback(async () => {\r\n        try {\r\n            const { getDocs, writeBatch } = await import('firebase/firestore');\r\n            const snapshot = await getDocs(collection(db, \"tickets\"));\r\n            const batch = writeBatch(db);\r\n\r\n            for (const tDoc of snapshot.docs) {\r\n                // Delete messages subcollection for each ticket\r\n                const msgsSnap = await getDocs(collection(db, \"tickets\", tDoc.id, \"messages\"));\r\n                msgsSnap.forEach(mDoc => batch.delete(mDoc.ref));\r\n                batch.delete(tDoc.ref);\r\n            }\r\n\r\n            await batch.commit();\r\n            setSelectedTicketId(null);\r\n\r\n            if (currentUser) {\r\n                logAction(currentUser, AUDIT_ACTIONS.TICKET_UPDATE, { action: 'clear_all' });\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Clear all error:\", error);\r\n            throw new Error(\"No se pudo reiniciar el centro de soporte.\");\r\n        }\r\n    }, [currentUser]);\r\n\r\n    // --- FILTER & METRICS LOGIC ---\r\n\r\n    const filteredTickets = useMemo(() => {\r\n        let result = tickets;\r\n\r\n        if (filterTab === 'open') result = result.filter(t => t.status !== 'resolved');\r\n        else if (filterTab === 'resolved') result = result.filter(t => t.status === 'resolved');\r\n        else if (filterTab === 'high') result = result.filter(t => t.urgency === 'high' || t.urgency === 'critical');\r\n        else if (filterTab === 'unread') result = result.filter(t => !t.read);\r\n\r\n        if (categoryFilter !== 'all') result = result.filter(t => t.category === categoryFilter);\r\n\r\n        if (searchQuery) {\r\n            const q = searchQuery.toLowerCase();\r\n            result = result.filter(t =>\r\n                t.subject?.toLowerCase().includes(q) ||\r\n                t.email?.toLowerCase().includes(q) ||\r\n                t.message?.toLowerCase().includes(q)\r\n            );\r\n        }\r\n        return result;\r\n    }, [tickets, filterTab, categoryFilter, searchQuery]);\r\n\r\n    const metrics = useMemo((): SupportMetrics => {\r\n        // Calculation logic extracted precisely from original\r\n        const total = tickets.length;\r\n        const open = tickets.filter(t => t.status === 'open' || !t.status).length;\r\n        const pending = tickets.filter(t => t.status === 'pending_user').length;\r\n        const investigating = tickets.filter(t => t.status === 'investigating').length;\r\n        const resolved = tickets.filter(t => t.status === 'resolved').length;\r\n        const unread = tickets.filter(t => !t.read).length;\r\n        const critical = tickets.filter(t => t.urgency === 'critical').length;\r\n        const high = tickets.filter(t => t.urgency === 'high').length;\r\n\r\n        const resolvedWithTime = tickets.filter(t => t.respondedAt && t.createdAt);\r\n        const avgResponseMinutes = resolvedWithTime.length > 0\r\n            ? resolvedWithTime.reduce((acc, t) => {\r\n                const created = t.createdAt?.toDate ? t.createdAt.toDate() : new Date();\r\n                const responded = t.respondedAt?.toDate ? t.respondedAt.toDate() : new Date();\r\n                return acc + (responded.getTime() - created.getTime()) / (1000 * 60);\r\n            }, 0) / resolvedWithTime.length\r\n            : 0;\r\n\r\n        const byCategory = {\r\n            operativa: tickets.filter(t => t.category === 'operativa').length,\r\n            finanzas: tickets.filter(t => t.category === 'finanzas').length,\r\n            tecnico: tickets.filter(t => t.category === 'tecnico').length,\r\n            accidente: tickets.filter(t => t.category === 'accidente').length,\r\n        };\r\n\r\n        return { total, open, pending, investigating, resolved, unread, critical, high, avgResponseMinutes, byCategory };\r\n    }, [tickets]);\r\n\r\n    // CSV Export\r\n    const exportToCSV = useCallback(() => {\r\n        const headers = ['ID', 'Email', 'Asunto', 'Categor√≠a', 'Urgencia', 'Estado', 'Fecha Creaci√≥n', 'Respuesta'];\r\n        const rows = filteredTickets.map(t => [\r\n            t.id,\r\n            t.email,\r\n            t.subject,\r\n            t.category || 'N/A',\r\n            t.urgency,\r\n            t.status,\r\n            t.createdAt?.toDate ? t.createdAt.toDate().toLocaleDateString() : 'Pendiente',\r\n            t.response || 'Sin respuesta'\r\n        ]);\r\n\r\n        const csvContent = [headers, ...rows].map(row => row.map(cell => `\"${cell}\"`).join(',')).join('\\n');\r\n        const blob = new Blob([csvContent], { type: 'text/csv' });\r\n        const url = window.URL.createObjectURL(blob);\r\n        const a = document.createElement('a');\r\n        a.href = url;\r\n        a.download = `tickets_export_${new Date().toISOString().slice(0, 10)}.csv`;\r\n        a.click();\r\n    }, [filteredTickets]);\r\n\r\n    return {\r\n        // State\r\n        tickets,\r\n        filteredTickets,\r\n        loading,\r\n        selectedTicketId,\r\n        selectedTicket,\r\n        messages,\r\n        metrics,\r\n\r\n        // Filter State\r\n        searchQuery, setSearchQuery,\r\n        filterTab, setFilterTab,\r\n\r\n        // Input State\r\n        reply, setReply,\r\n        isInternal, setIsInternal,\r\n        isSendingReply,\r\n\r\n        // Actions\r\n        handleSelectTicket,\r\n        handleToggleRead,\r\n        handleStatusChange,\r\n        handleReply,\r\n        handleDeleteTicket,\r\n        handleClearAllTickets,\r\n        exportToCSV,\r\n        messagesEndRef\r\n    };\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\hooks\\useTableLogic.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":36,"column":82,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":36,"endColumn":85,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1117,1120],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1117,1120],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useMemo, useCallback } from 'react';\r\nimport { useSearchParams } from 'react-router-dom';\r\n\r\nexport interface SortConfig<T> {\r\n    key: keyof T | string;\r\n    direction: 'asc' | 'desc';\r\n}\r\n\r\nexport interface TableLogicOptions<T> {\r\n    itemsPerPage?: number;\r\n    initialSort?: SortConfig<T>;\r\n    searchableFields?: (keyof T)[];\r\n}\r\n\r\nexport interface UseTableLogicReturn<T> {\r\n    searchTerm: string;\r\n    setSearchTerm: (term: string) => void;\r\n    currentPage: number;\r\n    setCurrentPage: (page: number) => void;\r\n    sortConfig: SortConfig<T>;\r\n    handleSort: (key: keyof T | string) => void;\r\n    selectedIds: Set<string>;\r\n    setSelectedIds: React.Dispatch<React.SetStateAction<Set<string>>>;\r\n    toggleSelection: (id: string) => void;\r\n    toggleAll: () => void;\r\n    processedData: T[];\r\n    paginatedData: T[];\r\n    totalItems: number;\r\n}\r\n\r\n/**\r\n * Enterprise Table Logic Hook\r\n * - Synchronizes state with URL Query Params (Deep Linking)\r\n * - Implements Targeted Search (specific fields only)\r\n */\r\nexport const useTableLogic = <T extends { id: string | number } & Record<string, any>>(\r\n    data: T[],\r\n    {\r\n        itemsPerPage = 8,\r\n        initialSort = { key: 'month', direction: 'desc' },\r\n        searchableFields = ['month'] // Default safe search\r\n    }: TableLogicOptions<T> = {}\r\n): UseTableLogicReturn<T> => {\r\n\r\n    // 1. URL State Manager\r\n    const [searchParams, setSearchParams] = useSearchParams();\r\n\r\n    // 2. Read State from URL (Source of Truth)\r\n    const searchTerm = searchParams.get('q') || '';\r\n    const currentPage = parseInt(searchParams.get('page') || '1', 10);\r\n    const sortKey = searchParams.get('sortKey') || initialSort.key as string;\r\n    const sortDir = (searchParams.get('sortDir') as 'asc' | 'desc') || initialSort.direction;\r\n\r\n    // Local state for ephemeral UI (Selection doesn't belong in URL usually)\r\n    const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set());\r\n\r\n    // 3. Smart Processors\r\n    const processedData = useMemo(() => {\r\n        let processed = [...data];\r\n\r\n        // Surgical Search üß†\r\n        if (searchTerm) {\r\n            const lowerTerm = searchTerm.toLowerCase();\r\n            processed = processed.filter(item =>\r\n                searchableFields.some(field => {\r\n                    const value = item[field];\r\n                    // Safety check + String conversion\r\n                    return value != null && String(value).toLowerCase().includes(lowerTerm);\r\n                })\r\n            );\r\n        }\r\n\r\n        // Sort\r\n        if (sortKey) {\r\n            processed.sort((a, b) => {\r\n                const aVal = a[sortKey];\r\n                const bVal = b[sortKey];\r\n\r\n                if (aVal < bVal) return sortDir === 'asc' ? -1 : 1;\r\n                if (aVal > bVal) return sortDir === 'asc' ? 1 : -1;\r\n                return 0;\r\n            });\r\n        }\r\n        return processed;\r\n    }, [data, searchTerm, sortKey, sortDir, searchableFields]);\r\n\r\n    // Pagination\r\n    const paginatedData = useMemo(() => {\r\n        const startIndex = (currentPage - 1) * itemsPerPage;\r\n        return processedData.slice(startIndex, startIndex + itemsPerPage);\r\n    }, [processedData, currentPage, itemsPerPage]);\r\n\r\n    // 4. URL Updaters (Handlers)\r\n    const updateSearchTerm = (term: string) => {\r\n        setSearchParams(prev => {\r\n            if (term) prev.set('q', term);\r\n            else prev.delete('q');\r\n            prev.set('page', '1'); // Reset pagination on search\r\n            // Preserve sort\r\n            return prev;\r\n        });\r\n    };\r\n\r\n    const updateCurrentPage = (page: number) => {\r\n        setSearchParams(prev => {\r\n            prev.set('page', page.toString());\r\n            return prev;\r\n        });\r\n    };\r\n\r\n    const handleSort = useCallback((key: keyof T | string) => {\r\n        setSearchParams(prev => {\r\n            const currentKey = prev.get('sortKey') || initialSort.key as string;\r\n            const currentDir = prev.get('sortDir') || initialSort.direction;\r\n\r\n            let newDir = 'asc';\r\n            if (currentKey === (key as string) && currentDir === 'asc') newDir = 'desc';\r\n\r\n            prev.set('sortKey', key as string);\r\n            prev.set('sortDir', newDir);\r\n            return prev;\r\n        });\r\n    }, [initialSort, setSearchParams]);\r\n\r\n    // Selection Handlers (Same as before)\r\n    const toggleSelection = useCallback((id: string) => {\r\n        setSelectedIds(prev => {\r\n            const next = new Set(prev);\r\n            if (next.has(id)) next.delete(id);\r\n            else next.add(id);\r\n            return next;\r\n        });\r\n    }, []);\r\n\r\n    const toggleAll = useCallback(() => {\r\n        // Safe to use string template for id if it's number\r\n        const pageIds = paginatedData.map(d => `${d.id}`);\r\n        const allSelected = pageIds.every(id => selectedIds.has(id));\r\n        setSelectedIds(prev => {\r\n            const next = new Set(prev);\r\n            if (allSelected) pageIds.forEach(id => next.delete(id));\r\n            else pageIds.forEach(id => next.add(id));\r\n            return next;\r\n        });\r\n    }, [paginatedData, selectedIds]);\r\n\r\n    return {\r\n        searchTerm, setSearchTerm: updateSearchTerm,\r\n        currentPage, setCurrentPage: updateCurrentPage,\r\n        sortConfig: { key: sortKey, direction: sortDir },\r\n        handleSort,\r\n        selectedIds, setSelectedIds, toggleSelection, toggleAll,\r\n        processedData, paginatedData,\r\n        totalItems: processedData.length\r\n    };\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\hooks\\useTheme.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\hooks\\useToast.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\hooks\\useUserManager.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":193,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":193,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8700,8703],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8700,8703],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useCallback, useMemo } from 'react';\r\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\r\nimport { userService, UserProfile } from '../services/userService';\r\nimport { sendPasswordResetEmail } from 'firebase/auth';\r\nimport { getApp } from 'firebase/app';\r\nimport { auth } from '../lib/firebase';\r\nimport { logAction, AUDIT_ACTIONS } from '../lib/audit';\r\nimport { CreateUserInput, UpdateUserInput } from '../features/admin/users/CreateUserModal';\r\n\r\n// Helper for Cloud Functions\r\nimport { getFunctions, httpsCallable } from 'firebase/functions';\r\n\r\nclass SecurityError extends Error {\r\n    constructor(message: string) {\r\n        super(message);\r\n        this.name = \"SecurityError\";\r\n    }\r\n}\r\n\r\ninterface UserManagerReturn {\r\n    users: UserProfile[];\r\n    loading: boolean;\r\n    error: string | null;\r\n    searchQuery: string;\r\n    setSearchQuery: (q: string) => void;\r\n    roleFilter: string;\r\n    setRoleFilter: (role: string) => void;\r\n    statusFilter: string;\r\n    setStatusFilter: (status: string) => void;\r\n    createUser: (userData: CreateUserInput, password?: string) => Promise<string>;\r\n    updateUser: (uid: string, updates: Partial<UpdateUserInput>) => Promise<void>;\r\n    deleteUser: (uid: string) => Promise<void>;\r\n    sendPasswordReset: (email: string) => Promise<void>;\r\n    toggleUserStatus: (uid: string, currentStatus: string) => Promise<void>;\r\n    isCreating: boolean;\r\n    isUpdating: boolean;\r\n    refetch: () => void;\r\n}\r\n\r\nexport const useUserManager = (currentUser: { uid: string; role?: string; email?: string | null } | null, franchiseId: string | null = null): UserManagerReturn => {\r\n    const queryClient = useQueryClient();\r\n    const isAdmin = currentUser?.role === 'admin';\r\n    const isFranchise = currentUser?.role === 'franchise';\r\n\r\n    // Filters State\r\n    const [searchQuery, setSearchQuery] = useState('');\r\n    const [roleFilter, setRoleFilter] = useState('all');\r\n    const [statusFilter, setStatusFilter] = useState('all');\r\n\r\n    // Admin permission check (strict - only for admin-only operations)\r\n    const checkAdminPermission = useCallback(() => {\r\n        if (!isAdmin) throw new SecurityError(\"Acceso Denegado.\");\r\n    }, [isAdmin]);\r\n\r\n    const checkSelfAction = useCallback((targetUid: string) => {\r\n        if (currentUser?.uid === targetUid) throw new SecurityError(\"No puedes eliminar tu propia cuenta.\");\r\n    }, [currentUser]);\r\n\r\n    // QUERY: Fetch Users\r\n    const {\r\n        data: users = [],\r\n        isLoading: loading,\r\n        error,\r\n        refetch\r\n    } = useQuery({\r\n        queryKey: ['users', roleFilter, franchiseId],\r\n        queryFn: async () => {\r\n            if (!isAdmin && !isFranchise) throw new SecurityError(\"Acceso Denegado\"); // Allow Franchise read\r\n\r\n            // If franchiseId is provided (God Mode limit), we might need a specific fetch\r\n            const allUsers = await userService.fetchUsers(roleFilter !== 'all' ? roleFilter : null);\r\n\r\n            // Filter by franchise if in \"God Mode\" context or Franchise User\r\n            const effectiveFranchiseId = franchiseId || (isFranchise ? currentUser?.uid : null);\r\n\r\n            if (effectiveFranchiseId) {\r\n                // Franchise can only see their own riders? Or userService handles it?\r\n                // Assuming client side filter for now as per previous logic\r\n                return allUsers.filter(u => u.franchiseId === effectiveFranchiseId);\r\n            }\r\n\r\n            return allUsers;\r\n        },\r\n        enabled: !!(isAdmin || isFranchise), // Enable for Franchise too\r\n        staleTime: 2 * 60 * 1000\r\n    });\r\n\r\n    // MUTATION: Create User (Server-Side)\r\n    const createUserMutation = useMutation({\r\n        mutationFn: async ({ userData, password }: { userData: CreateUserInput; password?: string }) => {\r\n            if (!password && !['driver', 'staff', 'rider'].includes(userData.role)) {\r\n                throw new Error(\"Password required for new user\");\r\n            }\r\n\r\n            const functions = getFunctions(getApp());\r\n            const createUserManaged = httpsCallable(functions, 'createUserManaged');\r\n\r\n            // Preparar payload para la Cloud Function\r\n            const payload = {\r\n                email: userData.email,\r\n                password: password,\r\n                role: userData.role,\r\n                franchiseId: franchiseId || userData.franchiseId, // Inject context franchiseId\r\n                displayName: userData.displayName,\r\n                phoneNumber: userData.phoneNumber ? (userData.phoneNumber.startsWith('+') ? userData.phoneNumber : `+34${userData.phoneNumber}`) : undefined,\r\n                status: userData.status || 'active',\r\n                pack: userData.pack,\r\n                name: userData.name,\r\n                legalName: userData.legalName,\r\n                cif: userData.cif,\r\n                address: userData.address\r\n            };\r\n\r\n            // Llamada segura al Backend\r\n            const result = await createUserManaged(payload);\r\n            const data = result.data as { uid: string, message: string };\r\n\r\n            await logAction(currentUser, AUDIT_ACTIONS.CREATE_USER, { email: userData.email, uid: data.uid });\r\n            return data.uid;\r\n        },\r\n        onSuccess: () => {\r\n            queryClient.invalidateQueries({ queryKey: ['users'] });\r\n        }\r\n    });\r\n\r\n    // MUTATION: Update User\r\n    const updateUserMutation = useMutation({\r\n        mutationFn: async ({ uid, updates }: { uid: string; updates: Partial<UpdateUserInput> }) => {\r\n            // Permission check: Admin or Franchise updating own rider\r\n            // We assume userService/Firestore rules handle the enforcement, or we add local check here\r\n            if (isFranchise) {\r\n                // Basic client-side check, robust check is in Rules\r\n                // Franchise can only update riders in their franchise.\r\n            } else {\r\n                checkAdminPermission();\r\n            }\r\n\r\n            await userService.updateUser(uid, updates);\r\n            await logAction(currentUser, AUDIT_ACTIONS.UPDATE_USER, { uid });\r\n        },\r\n        onSuccess: () => {\r\n            queryClient.invalidateQueries({ queryKey: ['users'] });\r\n        }\r\n    });\r\n\r\n    // MUTATION: Delete User\r\n    const deleteUserMutation = useMutation({\r\n        mutationFn: async (uid: string) => {\r\n            checkAdminPermission();\r\n            checkSelfAction(uid);\r\n            await userService.deleteUser(uid);\r\n            await logAction(currentUser, AUDIT_ACTIONS.DELETE_USER, { uid });\r\n        },\r\n        onSuccess: () => {\r\n            queryClient.invalidateQueries({ queryKey: ['users'] });\r\n        }\r\n    });\r\n\r\n    // MUTATION: Reset Password\r\n    const resetPasswordMutation = useMutation({\r\n        mutationFn: async (email: string) => {\r\n            checkAdminPermission();\r\n            await sendPasswordResetEmail(auth, email);\r\n            await logAction(currentUser, AUDIT_ACTIONS.SYSTEM_EVENT, { action: 'PASSWORD_RESET_REQ', email });\r\n        }\r\n    });\r\n\r\n    // --- Computed Filter Logic ---\r\n    const filteredUsers = useMemo(() => {\r\n        if (!users) return [];\r\n        return users.filter(user => {\r\n            const matchesSearch =\r\n                user.displayName?.toLowerCase().includes(searchQuery.toLowerCase()) ||\r\n                user.email?.toLowerCase().includes(searchQuery.toLowerCase()) ||\r\n                (user.franchiseId && user.franchiseId?.toLowerCase().includes(searchQuery.toLowerCase())); // Fixed optional chaining for franchiseId string method\r\n\r\n            const matchesRole = roleFilter === 'all' || user.role === roleFilter;\r\n            const matchesStatus = statusFilter === 'all' || user.status === statusFilter;\r\n            const isNotDeleted = user.status !== 'deleted'; // Hide soft-deleted users\r\n\r\n            return matchesSearch && matchesRole && matchesStatus && isNotDeleted;\r\n        });\r\n    }, [users, searchQuery, roleFilter, statusFilter]);\r\n\r\n    // Public API\r\n    const createUser = async (userData: CreateUserInput, password?: string) => createUserMutation.mutateAsync({ userData, password });\r\n    const updateUser = async (uid: string, updates: Partial<UpdateUserInput>) => updateUserMutation.mutateAsync({ uid, updates });\r\n    const deleteUser = async (uid: string) => deleteUserMutation.mutateAsync(uid);\r\n    const sendPasswordReset = async (email: string) => resetPasswordMutation.mutateAsync(email);\r\n\r\n    const toggleUserStatus = async (uid: string, currentStatus: string) => {\r\n        const newStatus = currentStatus === 'active' ? 'banned' : 'active';\r\n        return updateUser(uid, { status: newStatus as any });\r\n    };\r\n\r\n    return {\r\n        users: filteredUsers,\r\n        loading,\r\n        error: error ? (error as Error).message : null,\r\n        searchQuery, setSearchQuery,\r\n        roleFilter, setRoleFilter,\r\n        statusFilter, setStatusFilter,\r\n        createUser,\r\n        updateUser,\r\n        deleteUser,\r\n        sendPasswordReset,\r\n        toggleUserStatus,\r\n        isCreating: createUserMutation.isPending,\r\n        isUpdating: updateUserMutation.isPending,\r\n        refetch // Expose refetch\r\n    };\r\n};\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\hooks\\useVersionCheck.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\hooks\\useWeeklySchedule.ts","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\hooks\\useWeeklySchedule.ts:80:13\n  78 |         if (docData && liveShifts) {\n  79 |             // If we have both, Prefer Live Shifts\n> 80 |             setWeekData({\n     |             ^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  81 |                 ...docData,\n  82 |                 shifts: liveShifts\n  83 |             });","line":80,"column":13,"nodeType":null,"endLine":80,"endColumn":24},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\hooks\\useWeeklySchedule.ts:107:13\n  105 |\n  106 |         if (!weekData || weekData.id !== currentWeekIdString) {\n> 107 |             setLoading(true);\n      |             ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  108 |         }\n  109 |\n  110 |         // Reset local state on week change","line":107,"column":13,"nodeType":null,"endLine":107,"endColumn":23},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'weekData'. Either include it or remove the dependency array.","line":189,"column":8,"nodeType":"ArrayExpression","endLine":189,"endColumn":61,"suggestions":[{"desc":"Update the dependencies array to be: [franchiseIdString, currentWeekIdString, currentDate, weekData]","fix":{"range":[7213,7266],"text":"[franchiseIdString, currentWeekIdString, currentDate, weekData]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":192,"column":67,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":192,"endColumn":70,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7354,7357],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7354,7357],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useCallback } from 'react';\r\nimport { WeekService } from '../services/scheduler/weekService';\r\nimport { FleetService } from '../services/fleetService';\r\nimport { shiftService } from '../services/shiftService';\r\nimport {\r\n    WeekData,\r\n    Shift,\r\n    toFranchiseId,\r\n    toWeekId\r\n} from '../schemas/scheduler';\r\nimport { toLocalDateString, getStartOfWeek } from '../utils/dateUtils';\r\n\r\n// Helper exported for WeeklyScheduler (and now uses strict types if possible, or string for compat)\r\nexport const getWeekIdFromDate = (date: Date): string => {\r\n    return WeekService.getWeekId(date); // Reuse logic from service to allow string return for UI compat\r\n};\r\n\r\nexport type { Shift, WeekData }; // Re-export for components that consumed it from here\r\n\r\nexport interface Rider {\r\n    id: string;\r\n    fullName: string;\r\n    role: string;\r\n    status: string;\r\n    contractHours?: number;\r\n}\r\n\r\nexport interface Moto {\r\n    id: string;\r\n    licensePlate: string;\r\n    model: string;\r\n}\r\n\r\nexport const useWeeklySchedule = (franchiseIdString: string | null, _readOnly: boolean = false, externalDate?: Date) => {\r\n    // üî• PROBE: TOP LEVEL HOOK FIRE üî•\r\n    console.log('üî• EJECUTANDO HOOK useWeeklySchedule PARA:', franchiseIdString);\r\n\r\n    // STATE\r\n    // Initialize strictly to the Monday of the current week to ensure alignment\r\n    const [internalDate, setInternalDate] = useState<Date>(() => {\r\n        const d = new Date();\r\n        const day = d.getDay();\r\n        const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is Sunday\r\n        return new Date(d.setDate(diff));\r\n    });\r\n    const currentDate = externalDate || internalDate;\r\n\r\n    // üî• DUAL STATE PATTERN: Metadata from WeekService vs Shifts from ShiftService üî•\r\n    const [docData, setDocData] = useState<WeekData | null>(null);\r\n    const [liveShifts, setLiveShifts] = useState<Shift[] | null>(null);\r\n\r\n    // Combined State\r\n    const [weekData, setWeekData] = useState<WeekData | null>(null);\r\n\r\n    const [riders, setRiders] = useState<Rider[]>([]);\r\n    const [motos, setMotos] = useState<Moto[]>([]);\r\n    const [loading, setLoading] = useState(true);\r\n\r\n    // Derived properties\r\n    // Ensure we always get the ISO Week ID for the MONDAY of the week\r\n    const currentWeekIdString = getWeekIdFromDate(new Date(getStartOfWeek(currentDate)));\r\n\r\n    // NAVIGATION\r\n    const navigateWeek = useCallback((direction: number) => {\r\n        if (externalDate) {\r\n            console.warn(\"Attempting to navigate internally controlled week while externalDate is provided.\");\r\n        }\r\n        setInternalDate(prev => {\r\n            const newDate = new Date(prev);\r\n            newDate.setDate(prev.getDate() + (direction * 7));\r\n            return newDate;\r\n        });\r\n    }, [externalDate]);\r\n\r\n\r\n    // üî• MERGE STRATEGY: Combine docData and liveShifts whenever they change\r\n    useEffect(() => {\r\n        if (docData && liveShifts) {\r\n            // If we have both, Prefer Live Shifts\r\n            setWeekData({\r\n                ...docData,\r\n                shifts: liveShifts\r\n            });\r\n        } else if (docData) {\r\n            // Only Doc Data (initial load phase 1)\r\n            setWeekData(docData);\r\n        } else {\r\n            // Waiting...\r\n            setWeekData(null);\r\n        }\r\n    }, [docData, liveShifts]);\r\n\r\n\r\n    // FETCH / SUBSCRIPTION\r\n    useEffect(() => {\r\n        // üî• FORCE EXECUTION LOG\r\n        console.log('üî• useWeeklySchedule EFFECT TRIGGERED. FranchiseID:', franchiseIdString);\r\n\r\n        if (!franchiseIdString) {\r\n            console.warn('‚ö†Ô∏è FranchiseID faltante en hook, pero intentando continuar...');\r\n            // setLoading(false);\r\n            // return; // üî• REMOVED EARLY RETURN TO FORCE ATTEMPT (Though query might fail empty)\r\n        }\r\n\r\n\r\n        if (!weekData || weekData.id !== currentWeekIdString) {\r\n            setLoading(true);\r\n        }\r\n\r\n        // Reset local state on week change\r\n        setDocData(null);\r\n        setLiveShifts(null);\r\n\r\n        // Convert to Branded Types for Service\r\n        const fid = toFranchiseId(franchiseIdString || '');\r\n        const wid = toWeekId(currentWeekIdString);\r\n\r\n        // 1. Subscribe using WeekService (Metadata & Legacy)\r\n        const unsubscribeWeek = WeekService.subscribeToWeek(franchiseIdString || '', currentWeekIdString, (data) => {\r\n            if (data) {\r\n                setDocData(data);\r\n            } else {\r\n                // Initialize if not exists\r\n                const startDate = toLocalDateString(getStartOfWeek(currentDate));\r\n                if (fid) {\r\n                    WeekService.initWeek(fid, wid, startDate).then((initial) => {\r\n                        if (initial) setDocData(initial);\r\n                    });\r\n                }\r\n            }\r\n            if (data) setLoading(false);\r\n        });\r\n\r\n        // 1.5 Subsrcibe to Real Shifts (Source of Truth: work_shifts collection)\r\n        // üî• SIMPLIFIED DIRECT SUBSCRIPTION üî•\r\n\r\n        const startOfWeekString = getStartOfWeek(currentDate);\r\n        const [y, m, d] = startOfWeekString.split('-').map(Number);\r\n        const startOfWeekDate = new Date(y, m - 1, d, 0, 0, 0, 0);\r\n        const endOfWeekDate = new Date(startOfWeekDate);\r\n        endOfWeekDate.setDate(endOfWeekDate.getDate() + 6);\r\n        endOfWeekDate.setHours(23, 59, 59, 999);\r\n\r\n        // Expand for timezone safety\r\n        const searchStart = new Date(startOfWeekDate);\r\n        searchStart.setDate(searchStart.getDate() - 1);\r\n        const searchEnd = new Date(startOfWeekDate);\r\n        searchEnd.setDate(searchEnd.getDate() + 8);\r\n\r\n        const unsubscribeShifts = shiftService.subscribeToWeekShifts(\r\n            franchiseIdString || '',\r\n            searchStart,\r\n            searchEnd,\r\n            (shifts) => {\r\n                setLiveShifts(shifts || []);\r\n            }\r\n        );\r\n\r\n        // 2. Riders (via FleetService - Source of Truth for Riders)\r\n        const unsubscribeRiders = FleetService.subscribeToRiders(franchiseIdString || '', (fleetRiders) => {\r\n            const schedulerRiders = fleetRiders\r\n                .filter(r => r.status === 'active')\r\n                .map(r => ({\r\n                    id: r.id,\r\n                    fullName: r.fullName,\r\n                    role: 'rider', // Fleet service riders are always riders\r\n                    status: r.status,\r\n                    contractHours: r.contractHours || 40 // Default to 40 if missing\r\n                }));\r\n            setRiders(schedulerRiders);\r\n        });\r\n\r\n        // 3. Motos (via FleetService)\r\n        const unsubscribeMotos = FleetService.subscribeToMotos(toFranchiseId(franchiseIdString || ''), (domainMotos) => {\r\n            // Adapt Domain Moto (plate) to UI Moto (licensePlate)\r\n            const uiMotos = domainMotos.map(dm => ({\r\n                ...dm,\r\n                licensePlate: dm.plate // UI compatibility\r\n            }));\r\n            setMotos(uiMotos as unknown as Moto[]);\r\n        });\r\n\r\n        return () => {\r\n            unsubscribeWeek();\r\n            unsubscribeShifts();\r\n            unsubscribeRiders();\r\n            unsubscribeMotos();\r\n        };\r\n    }, [franchiseIdString, currentWeekIdString, currentDate]);\r\n\r\n    // ACTIONS\r\n    const saveWeek = async (fidStr: string, widStr: string, data: any) => {\r\n        // Validation boundary: input is primitive string, internal is Branded\r\n        const fid = toFranchiseId(fidStr);\r\n        const wid = toWeekId(widStr);\r\n        return await WeekService.saveWeek(fid, wid, data);\r\n    };\r\n\r\n    const updateWeekData = (newData: WeekData) => setWeekData(newData);\r\n\r\n    return {\r\n        weekData,\r\n        riders,\r\n        motos,\r\n        loading,\r\n        currentDate,\r\n        referenceDate: currentDate,\r\n        navigateWeek,\r\n        saveWeek,\r\n        updateWeekData,\r\n        refresh: () => { },\r\n        currentWeekId: currentWeekIdString\r\n    };\r\n};\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\layouts\\DashboardLayout.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":32,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":32,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1166,1169],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1166,1169],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":34,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":34,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1201,1204],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1201,1204],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":38,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":38,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1282,1285],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1282,1285],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":39,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":39,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1310,1313],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1310,1313],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\r\nimport { Outlet } from 'react-router-dom';\r\nimport Header from './components/Header';\r\nimport InputSidebar from './components/InputSidebar';\r\nimport BottomTabBar from './components/BottomTabBar';\r\nimport ChatAssistant from './components/ChatAssistant';\r\nimport PageHelpModal from '../ui/modals/PageHelpModal';\r\nimport { pageHelpData, PageHelpContent } from '../constants/pageHelpData';\r\n\r\n// Define explicit types for props\r\nimport { useAppStore } from '../store/useAppStore';\r\n\r\n// Define explicit types for props\r\ninterface DashboardLayoutProps {\r\n    children?: React.ReactNode;\r\n    isAdmin: boolean;\r\n    isFranchise: boolean;\r\n    viewMode?: string;\r\n    setViewMode?: (mode: string) => void;\r\n    franchiseView?: string;\r\n    setFranchiseView?: (view: string) => void;\r\n    targetFranchiseName?: string | null;\r\n\r\n    // Data Control Props\r\n    // selectedMonth & onMonthChange REMOVED (Handled by Store)\r\n    // viewPeriod?: string; -> REMOVED\r\n    // setViewPeriod?: (period: string) => void; -> REMOVED\r\n\r\n    onLogout: () => void;\r\n    onExport: () => void;\r\n    onPrint?: () => void;\r\n    onCalculate?: (values: any) => void;\r\n\r\n    sidebarData?: any;\r\n    readOnly?: boolean;\r\n    saving?: boolean;\r\n\r\n    chatData?: { report: any };\r\n    outletContext?: any;\r\n}\r\n\r\nimport ImpersonationBanner from '../components/ImpersonationBanner';\r\n\r\n/**\r\n *  DashboardLayout\r\n * Wrapper for the main dashboard shell (Sidebar + Header + Bottom Tab Bar).\r\n * Handles persistent layout state like isSidebarOpen.\r\n */\r\nconst DashboardLayout: React.FC<DashboardLayoutProps> = ({\r\n    children,\r\n    // Navigation / View Props\r\n    isAdmin,\r\n    isFranchise,\r\n    viewMode,\r\n    setViewMode,\r\n    franchiseView,\r\n    setFranchiseView,\r\n    targetFranchiseName,\r\n\r\n    // Data Control Props\r\n    // selectedMonth, -> REMOVED\r\n    // onMonthChange, -> REMOVED\r\n    // viewPeriod, -> REMOVED\r\n    // setViewPeriod, -> REMOVED\r\n\r\n    // Actions\r\n    onLogout,\r\n    onExport,\r\n    onPrint,\r\n    onCalculate,\r\n\r\n    // Sidebar Data\r\n    sidebarData,\r\n    readOnly = false,\r\n    saving = false,\r\n\r\n    // Chat Props\r\n    // isChatOpen, -> REMOVED\r\n    // setIsChatOpen, -> REMOVED\r\n    chatData,\r\n    outletContext\r\n}) => {\r\n    const {\r\n        isSidebarOpen,\r\n        toggleSidebar: setIsSidebarOpen,\r\n        isChatOpen,\r\n        toggleChat: setIsChatOpen\r\n    } = useAppStore();\r\n\r\n    // const [isSidebarOpen, setIsSidebarOpen] = useState(false); -> REMOVED\r\n    const [helpContent, setHelpContent] = useState<PageHelpContent | null>(null);\r\n\r\n    // Mobile Chat Toggle\r\n    // const handleToggleChat = () => setIsChatOpen(!isChatOpen); -> REMOVED\r\n\r\n    const openHelp = (id: string) => {\r\n        const content = pageHelpData[id] || null;\r\n        setHelpContent(content);\r\n    };\r\n\r\n    // Header Props Bundle\r\n    const headerProps = {\r\n        isAdmin, isFranchise, viewMode, setViewMode, franchiseView, setFranchiseView,\r\n        // isSidebarOpen, setIsSidebarOpen, selectedMonth, -> REMOVED\r\n        // viewPeriod, setViewPeriod, -> REMOVED\r\n        targetFranchiseName: targetFranchiseName || undefined,\r\n        saving, onLogout,\r\n        onExport, onPrint,\r\n        // onMonthChange, -> REMOVED\r\n        onOpenHelp: openHelp\r\n    };\r\n\r\n    return (\r\n        <div className=\"print:hidden min-h-screen bg-slate-50 dark:bg-slate-950 flex overflow-hidden font-sans relative transition-colors duration-300\">\r\n            {/* Mobile Overlay */}\r\n            {isSidebarOpen && (\r\n                <div\r\n                    className=\"fixed inset-0 bg-slate-900/20 z-40 md:hidden backdrop-blur-sm transition-opacity duration-300\"\r\n                    onClick={() => setIsSidebarOpen(false)}\r\n                />\r\n            )}\r\n\r\n            {/* Sidebar (Input Panel) */}\r\n            <InputSidebar\r\n                // isOpen={isSidebarOpen} -> REMOVED\r\n                // onClose={() => setIsSidebarOpen(false)} -> REMOVED\r\n                initialData={sidebarData}\r\n                // selectedMonth={selectedMonth} -> REMOVED\r\n                // onMonthChange={onMonthChange} -> REMOVED\r\n                onCalculate={onCalculate || (() => { })}\r\n                readOnly={readOnly}\r\n                // onToggleChat={handleToggleChat} -> REMOVED\r\n                onOpenHelp={openHelp}\r\n            />\r\n\r\n            {/* Main Content Area */}\r\n            <div className={`flex-1 flex flex-col transition-all duration-300 w-full ${isSidebarOpen ? 'md:ml-96' : 'ml-0'}`}>\r\n                <ImpersonationBanner />\r\n                <Header {...headerProps} />\r\n\r\n                {/* Content Injection with correct mobile padding */}\r\n                <main className=\"flex-1 overflow-y-auto w-full relative z-0\" style={{ paddingBottom: 'calc(4rem + env(safe-area-inset-bottom))' }}>\r\n                    <div className=\"mx-auto w-full max-w-7xl px-4 sm:px-6 lg:px-8 py-4 md:py-8\">\r\n                        {/* Pass context to Outlet */}\r\n                        {outletContext ? <Outlet context={{ ...outletContext }} /> : children}\r\n                    </div>\r\n                </main>\r\n            </div>\r\n\r\n            {/* Bottom Tab Bar (Mobile Only) */}\r\n            <BottomTabBar\r\n                isAdmin={isAdmin}\r\n                isFranchise={isFranchise}\r\n            // Legacy view props might be ignored by new BottomTabBar with NavLinks, \r\n            // but kept for interface compatibility if needed transiently\r\n            />\r\n\r\n            {/* Controlled Chat Assistant */}\r\n            <ChatAssistant\r\n                contextData={chatData?.report}\r\n                isOpen={isChatOpen || false}\r\n                onClose={() => setIsChatOpen(false)}\r\n            />\r\n\r\n            <PageHelpModal\r\n                isOpen={!!helpContent}\r\n                content={helpContent}\r\n                onClose={() => setHelpContent(null)}\r\n            />\r\n        </div >\r\n    );\r\n};\r\n\r\nexport default React.memo(DashboardLayout);\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\layouts\\RequireActiveStatus.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\layouts\\RequireRole.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":46,"column":76,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":46,"endColumn":79,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1701,1704],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1701,1704],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":51,"column":66,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":51,"endColumn":69,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1938,1941],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1938,1941],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\nimport { Navigate, useLocation } from 'react-router-dom';\r\nimport { useAuth } from '../context/AuthContext';\r\n\r\ninterface RequireRoleProps {\r\n    children: React.ReactNode;\r\n    allowedRoles: string[];\r\n}\r\n\r\n/**\r\n * RequireRole Component (The Bouncer)\r\n * Protects routes based on user role and handles smart redirection\r\n * to avoid infinite loops and \"dead ends\" for specific roles like Riders.\r\n */\r\nexport const RequireRole: React.FC<RequireRoleProps> = ({ children, allowedRoles }) => {\r\n    const { user, loading } = useAuth();\r\n    const location = useLocation();\r\n\r\n    if (loading) {\r\n        return (\r\n            <div className=\"min-h-screen bg-slate-950 flex items-center justify-center\">\r\n                <div className=\"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-500\" />\r\n            </div>\r\n        );\r\n    }\r\n\r\n    // 1. If not authenticated, go to login\r\n    if (!user) {\r\n        return <Navigate to=\"/login\" state={{ from: location }} replace />;\r\n    }\r\n\r\n    // 2. Check Role Authorization\r\n    const userRole = user.role || 'undefined';\r\n    const hasRequiredRole = allowedRoles.includes(userRole);\r\n\r\n    if (!hasRequiredRole) {\r\n        console.warn(`[Security] Access Denied! \r\n            Path: ${location.pathname}\r\n            User: ${user.email}\r\n            Role: [${userRole}] \r\n            Required: ${allowedRoles.join(', ')}`);\r\n\r\n        // üõ°Ô∏è Smart Redirect to avoid infinite loops\r\n        if (['rider'].includes(userRole)) {\r\n            // If already at rider app, don't redirect (let 404/Not Found handle if specific path bad)\r\n            if (location.pathname.startsWith('/rider')) return children as any;\r\n            return <Navigate to=\"/rider/schedule\" replace />;\r\n        }\r\n\r\n        // If role is missing or unauthorized for dashboard, send to profile (Safe Zone)\r\n        if (location.pathname === '/profile') return children as any;\r\n        return <Navigate to=\"/profile\" replace />;\r\n    }\r\n\r\n    // 3. Authorized\r\n    return <>{children}</>;\r\n};\r\n\r\nexport default RequireRole;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\layouts\\RiderLayout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\layouts\\components\\BottomTabBar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\layouts\\components\\ChatAssistant.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":12,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":12,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[374,377],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[374,377],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":36,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":36,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1203,1206],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1203,1206],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":70,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":70,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2468,2471],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2468,2471],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'handleMouseMove'. Either include it or remove the dependency array.","line":125,"column":8,"nodeType":"ArrayExpression","endLine":125,"endColumn":20,"suggestions":[{"desc":"Update the dependencies array to be: [handleMouseMove, isDragging]","fix":{"range":[4507,4519],"text":"[handleMouseMove, isDragging]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useRef, useEffect } from 'react';\r\nimport { X, Send, Bot, Sparkles, Maximize2, Minimize2 } from 'lucide-react';\r\nimport { useLocation } from 'react-router-dom';\r\nimport { sendMessageToGemini } from '../../lib/gemini';\r\n\r\ninterface ChatMessage {\r\n    role: 'user' | 'model';\r\n    text: string;\r\n}\r\n\r\ninterface ChatAssistantProps {\r\n    contextData: any;\r\n    isOpen?: boolean;\r\n    onClose?: () => void;\r\n}\r\n\r\nconst ChatAssistant: React.FC<ChatAssistantProps> = ({ contextData, isOpen, onClose }) => {\r\n    const location = useLocation();\r\n    const [isExpanded, setIsExpanded] = useState(false);\r\n    const [messages, setMessages] = useState<ChatMessage[]>([\r\n        { role: 'model', text: '¬°Hola! Soy REPAART AI. Conozco toda la app y el manual operativo. ¬øEn qu√© te ayudo?' }\r\n    ]);\r\n    const [input, setInput] = useState('');\r\n    const [loading, setLoading] = useState(false);\r\n\r\n    const messagesEndRef = useRef<HTMLDivElement>(null);\r\n\r\n    const scrollToBottom = () => {\r\n        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });\r\n    };\r\n\r\n    useEffect(() => {\r\n        scrollToBottom();\r\n    }, [messages]);\r\n\r\n    const formatContextData = (data: any) => {\r\n        if (!data) return \"Sin datos financieros cargados.\";\r\n        // Simplified metric summary\r\n        return `Ingresos: ${data.revenue || 0}‚Ç¨, Pedidos: ${data.orders || 0}`;\r\n    };\r\n\r\n    const handleSend = async (e: React.FormEvent) => {\r\n        e.preventDefault();\r\n        if (!input.trim() || loading) return;\r\n\r\n        const userMsg = input.trim();\r\n        setInput('');\r\n        setMessages(prev => [...prev, { role: 'user', text: userMsg }]);\r\n        setLoading(true);\r\n\r\n        try {\r\n            // Context Injection\r\n            const currentRoute = location.pathname;\r\n            const financialContext = formatContextData(contextData);\r\n\r\n            // We prepend context to the message so the AI knows where the user is\r\n            // but we don't show this technical prefix to the user in the UI\r\n            const promptWithContext = `\r\n            [CONTEXTO ACTUAL]\r\n            - Ruta: ${currentRoute}\r\n            - Datos Rapidos: ${financialContext}\r\n            \r\n            [MENSAJE USUARIO]\r\n            ${userMsg}\r\n            `;\r\n\r\n            const response = await sendMessageToGemini(promptWithContext);\r\n            setMessages(prev => [...prev, { role: 'model', text: response }]);\r\n\r\n        } catch (error: any) {\r\n            console.error(\"Chat Error:\", error);\r\n            setMessages(prev => [...prev, { role: 'model', text: 'Lo siento, he tenido un problema de conexi√≥n.' }]);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    // Auto-open greeting once\r\n    useEffect(() => {\r\n        const timer = setTimeout(() => {\r\n            // Optional: Auto open specific logic\r\n        }, 1000);\r\n        return () => clearTimeout(timer);\r\n    }, []);\r\n\r\n    // Draggable Logic (Desktop only)\r\n    const [position, setPosition] = useState({ bottom: 24, right: 24 });\r\n    const [isDragging, setIsDragging] = useState(false);\r\n    const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 });\r\n\r\n    const handleMouseDown = (e: React.MouseEvent) => {\r\n        if (window.innerWidth < 768) return; // Disable drag on mobile (sheet mode)\r\n        setIsDragging(true);\r\n        const rect = e.currentTarget.getBoundingClientRect();\r\n        setDragOffset({\r\n            x: e.clientX - rect.left,\r\n            y: e.clientY - rect.top\r\n        });\r\n    };\r\n\r\n    const handleMouseMove = (e: MouseEvent) => {\r\n        if (!isDragging) return;\r\n        const newRight = window.innerWidth - e.clientX - dragOffset.x;\r\n        const newBottom = window.innerHeight - e.clientY - dragOffset.y;\r\n        setPosition({\r\n            right: Math.max(10, Math.min(window.innerWidth - 60, newRight)),\r\n            bottom: Math.max(10, Math.min(window.innerHeight - 60, newBottom))\r\n        });\r\n    };\r\n\r\n    const handleMouseUp = () => {\r\n        setIsDragging(false);\r\n    };\r\n\r\n    useEffect(() => {\r\n        if (isDragging) {\r\n            window.addEventListener('mousemove', handleMouseMove);\r\n            window.addEventListener('mouseup', handleMouseUp);\r\n            return () => {\r\n                window.removeEventListener('mousemove', handleMouseMove);\r\n                window.removeEventListener('mouseup', handleMouseUp);\r\n            };\r\n        }\r\n        // eslint-disable-next-line react-hooks/exhaustive-deps\r\n    }, [isDragging]);\r\n\r\n    // If closed, render nothing (controlled by parent)\r\n    if (!isOpen) return null;\r\n\r\n    return (\r\n        <>\r\n            {/* Mobile Backdrop */}\r\n            <div className=\"fixed inset-0 bg-black/50 z-[60] md:hidden backdrop-blur-sm animate-fade-in\" onClick={() => onClose && onClose()} />\r\n\r\n            {/* Chat Window */}\r\n            <div\r\n                style={{\r\n                    bottom: window.innerWidth >= 768 ? `${position.bottom}px` : '0',\r\n                    right: window.innerWidth >= 768 ? `${position.right}px` : '0',\r\n                    left: window.innerWidth >= 768 ? 'auto' : '0'\r\n                }}\r\n                className={`fixed bg-white z-[70] flex flex-col overflow-hidden transition-all duration-300 shadow-2xl border-blue-100\r\n                    md:rounded-2xl md:border\r\n                    ${window.innerWidth < 768\r\n                        ? 'min-h-[85vh] max-h-[85vh] rounded-t-[32px] animate-slide-up-mobile safe-bottom'\r\n                        : `animate-fade-in-up ${isExpanded ? 'w-[600px] h-[70vh]' : 'w-80 h-96'}`\r\n                    }\r\n                `}\r\n            >\r\n                {/* Header with Drag Handler */}\r\n                <div\r\n                    onMouseDown={handleMouseDown}\r\n                    className={`bg-gradient-to-r from-slate-800 to-slate-900 p-4 md:p-3 flex justify-between items-center text-white shrink-0 ${window.innerWidth >= 768 ? 'cursor-move' : ''}`}\r\n                >\r\n                    <div className=\"flex items-center gap-2\">\r\n                        <div className=\"w-7 h-7 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center shadow-inner\">\r\n                            <Bot className=\"w-4 h-4 text-white\" />\r\n                        </div>\r\n                        <div>\r\n                            <h3 className=\"font-bold text-xs tracking-wide\">SOLF AI</h3>\r\n                            <p className=\"text-[9px] text-blue-300 flex items-center gap-1\">\r\n                                <span className=\"w-1.5 h-1.5 bg-green-400 rounded-full animate-pulse\" />\r\n                                Online\r\n                            </p>\r\n                        </div>\r\n                    </div>\r\n                    <div className=\"flex items-center gap-1\">\r\n                        <button\r\n                            onClick={() => setIsExpanded(!isExpanded)}\r\n                            className=\"p-1 hover:bg-white/10 rounded transition\"\r\n                            title={isExpanded ? \"Minimizar\" : \"Maximizar\"}\r\n                            aria-label={isExpanded ? \"Minimizar chat\" : \"Maximizar chat\"}\r\n                        >\r\n                            {isExpanded ? <Minimize2 className=\"w-3.5 h-3.5\" /> : <Maximize2 className=\"w-3.5 h-3.5\" />}\r\n                        </button>\r\n                        <button\r\n                            onClick={() => onClose && onClose()}\r\n                            className=\"p-1 hover:bg-red-500/80 rounded transition\"\r\n                            title=\"Cerrar chat\"\r\n                            aria-label=\"Cerrar chat\"\r\n                        >\r\n                            <X className=\"w-3.5 h-3.5\" />\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Messages */}\r\n                <div className=\"flex-1 overflow-y-auto p-3 space-y-3 bg-slate-50/50\">\r\n                    {messages.map((m, idx) => (\r\n                        <div key={idx} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>\r\n                            <div className={`max-w-[85%] rounded-xl p-2.5 text-xs shadow-sm ${m.role === 'user'\r\n                                ? 'bg-blue-600 text-white rounded-br-none'\r\n                                : 'bg-white border border-slate-200 text-slate-700 rounded-bl-none'\r\n                                }`}>\r\n                                {m.role === 'model' && (\r\n                                    <p className=\"text-[9px] font-bold text-blue-500 mb-1 flex items-center gap-1\">\r\n                                        <Sparkles className=\"w-3 h-3\" /> AI\r\n                                    </p>\r\n                                )}\r\n                                <div className=\"whitespace-pre-wrap leading-relaxed\">\r\n                                    {m.text}\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    ))}\r\n                    {loading && (\r\n                        <div className=\"flex justify-start\">\r\n                            <div className=\"bg-white border border-slate-200 rounded-xl rounded-bl-none p-3 shadow-sm\">\r\n                                <div className=\"flex gap-1\">\r\n                                    <span className=\"w-1.5 h-1.5 bg-blue-400 rounded-full animate-bounce\" />\r\n                                    <span className=\"w-1.5 h-1.5 bg-blue-400 rounded-full animate-bounce delay-75\" />\r\n                                    <span className=\"w-1.5 h-1.5 bg-blue-400 rounded-full animate-bounce delay-150\" />\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                    <div ref={messagesEndRef} />\r\n                </div>\r\n\r\n                {/* Input */}\r\n                <form onSubmit={handleSend} className=\"p-2.5 bg-white border-t border-slate-100 flex gap-2 shrink-0\">\r\n                    <input\r\n                        type=\"text\"\r\n                        value={input}\r\n                        onChange={(e) => setInput(e.target.value)}\r\n                        placeholder=\"Pregunta algo...\"\r\n                        className=\"flex-1 bg-slate-100 border-none rounded-lg px-3 py-2 text-xs focus:ring-2 focus:ring-blue-500 outline-none transition-all placeholder-slate-400\"\r\n                    />\r\n                    <button\r\n                        type=\"submit\"\r\n                        disabled={!input.trim() || loading}\r\n                        className={`p-2 rounded-lg bg-blue-600 text-white shadow-sm transition-all ${(!input.trim() || loading) ? 'opacity-50 cursor-not-allowed' : 'hover:bg-blue-700 active:scale-95'\r\n                            }`}\r\n                        title=\"Enviar mensaje\"\r\n                        aria-label=\"Enviar mensaje\"\r\n                    >\r\n                        <Send className=\"w-4 h-4\" />\r\n                    </button>\r\n                </form>\r\n            </div>\r\n        </>\r\n    );\r\n};\r\n\r\nexport default ChatAssistant;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\layouts\\components\\DashboardSwitcher.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\layouts\\components\\Header.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\layouts\\components\\InputSidebar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\layouts\\components\\MobileMoreMenu.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\layouts\\components\\NetworkStatus.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\layouts\\components\\Notifications.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":25,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":25,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1034,1037],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1034,1037],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":135,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":135,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5578,5581],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5578,5581],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":136,"column":67,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":136,"endColumn":70,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5665,5668],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5665,5668],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/immutability","severity":2,"message":"Error: This value cannot be modified\n\nModifying a variable defined outside a component or hook is not allowed. Consider using an effect.\n\nC:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\layouts\\components\\Notifications.tsx:146:17\n  144 |                 navigate('/operations'); // Or a more specific path if available\n  145 |             } else if (notification.link) {\n> 146 |                 window.location.href = notification.link;\n      |                 ^^^^^^^^^^^^^^^ value cannot be modified\n  147 |             }\n  148 |         }\n  149 |     };","line":146,"column":17,"nodeType":null,"endLine":146,"endColumn":32}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useRef } from 'react';\r\nimport { db } from '../../lib/firebase';\r\nimport { collection, query, where, orderBy, onSnapshot, limit, Timestamp } from 'firebase/firestore';\r\nimport { Bell, Ticket, DollarSign, AlertTriangle, ArrowRight, Lock, Check } from 'lucide-react';\r\nimport { useAuth } from '../../context/AuthContext';\r\nimport { markNotificationAsRead } from '../../lib/notifications';\r\nimport { notificationService, NotificationPayload } from '../../services/notificationService';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { formatTimeAgo } from '../../utils/dateHelpers';\r\nimport { ShieldAlert, BookOpen } from 'lucide-react';\r\n\r\n// Unified UI Notification Interface\r\ninterface UINotification {\r\n    id: string;\r\n    title: string;\r\n    message: string;\r\n    read: boolean;\r\n    createdAt: Timestamp;\r\n    link?: string;\r\n    type?: string;\r\n    // Admin specific\r\n    franchiseName?: string;\r\n    franchiseId?: string;\r\n    priority?: 'low' | 'normal' | 'high';\r\n    metadata?: any;\r\n    // Legacy specific\r\n    userId?: string;\r\n}\r\n\r\ninterface NotificationsProps {\r\n    isAdmin?: boolean;\r\n}\r\n\r\nconst Notifications: React.FC<NotificationsProps> = ({ isAdmin = false }) => {\r\n    const { user } = useAuth();\r\n    const navigate = useNavigate();\r\n    const [notifications, setNotifications] = useState<UINotification[]>([]);\r\n    const [unreadCount, setUnreadCount] = useState(0);\r\n    const [isOpen, setIsOpen] = useState(false);\r\n    const [activeTab, setActiveTab] = useState<'all' | 'unread' | 'high'>('all');\r\n    const wrapperRef = useRef<HTMLDivElement>(null);\r\n\r\n    // Close on click outside\r\n    useEffect(() => {\r\n        function handleClickOutside(event: MouseEvent) {\r\n            if (wrapperRef.current && !wrapperRef.current.contains(event.target as Node)) {\r\n                setIsOpen(false);\r\n            }\r\n        }\r\n        document.addEventListener(\"mousedown\", handleClickOutside);\r\n        return () => document.removeEventListener(\"mousedown\", handleClickOutside);\r\n    }, [wrapperRef]);\r\n\r\n    useEffect(() => {\r\n        if (!user) return;\r\n\r\n        let unsubscribe: () => void;\r\n\r\n        try {\r\n            if (isAdmin) {\r\n                // --- ADMIN STREAM (admin_notifications) ---\r\n                const q = query(\r\n                    collection(db, \"admin_notifications\"),\r\n                    orderBy(\"createdAt\", \"desc\"),\r\n                    limit(50)\r\n                );\r\n\r\n                unsubscribe = onSnapshot(q, (snapshot) => {\r\n                    const list = snapshot.docs.map(doc => {\r\n                        const data = doc.data() as NotificationPayload;\r\n                        return {\r\n                            id: doc.id,\r\n                            title: data.title, // In admin_notifications, title is the event title\r\n                            message: data.message,\r\n                            read: data.read,\r\n                            createdAt: data.createdAt,\r\n                            type: data.type,\r\n                            franchiseName: data.franchiseName,\r\n                            franchiseId: data.franchiseId, // Crucial for navigation\r\n                            priority: data.priority,\r\n                            metadata: data.metadata\r\n                        } as UINotification;\r\n                    });\r\n                    setNotifications(list);\r\n                    setUnreadCount(list.filter(n => !n.read).length);\r\n                }, (error) => {\r\n                    console.warn(\"Admin Notification listener error:\", error);\r\n                });\r\n\r\n            } else {\r\n                // --- FRANCHISE STREAM (legacy notifications) ---\r\n                const targetIds = [user.uid];\r\n                if (user.franchiseId) targetIds.push(user.franchiseId);\r\n\r\n                const q = query(\r\n                    collection(db, \"notifications\"),\r\n                    where(\"userId\", \"in\", targetIds),\r\n                    orderBy(\"createdAt\", \"desc\"),\r\n                    limit(20)\r\n                );\r\n\r\n                unsubscribe = onSnapshot(q, (snapshot) => {\r\n                    const list = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() } as UINotification));\r\n                    setNotifications(list);\r\n                    setUnreadCount(list.filter(n => !n.read).length);\r\n                }, (error) => {\r\n                    console.warn(\"Franchise Notification listener error:\", error);\r\n                });\r\n            }\r\n        } catch (err) {\r\n            console.error(\"Error setting up listener\", err);\r\n        }\r\n\r\n        return () => {\r\n            if (unsubscribe) unsubscribe();\r\n        };\r\n    }, [user, isAdmin]);\r\n\r\n\r\n    const handleNotificationClick = (notification: UINotification) => {\r\n        // 1. Mark as read\r\n        if (!notification.read) {\r\n            if (isAdmin) notificationService.markAsRead(notification.id);\r\n            else markNotificationAsRead(notification.id);\r\n        }\r\n\r\n        // 2. Navigate based on type/metadata\r\n        setIsOpen(false);\r\n\r\n        if (isAdmin) {\r\n            if (notification.type === 'FINANCE_CLOSING' || notification.type === 'RATE_CHANGE' || notification.type === 'UNLOCK_REQUEST' || notification.type === 'MONTH_UNLOCKED' || notification.type === 'UNLOCK_REJECTED') {\r\n                // Navigate to franchise detail\r\n                if (notification.metadata?.franchiseId) {\r\n                    navigate(`/admin/franchise/${notification.metadata.franchiseId}`);\r\n                } else if ((notification as any).franchiseId) {\r\n                    navigate(`/admin/franchise/${(notification as any).franchiseId}`);\r\n                }\r\n            } else if (notification.type === 'SUPPORT_TICKET') {\r\n                navigate('/admin/support');\r\n            }\r\n        } else {\r\n            if (notification.type === 'shift_change_request' || notification.type === 'incident') {\r\n                // Navigate to scheduler\r\n                navigate('/operations'); // Or a more specific path if available\r\n            } else if (notification.link) {\r\n                window.location.href = notification.link;\r\n            }\r\n        }\r\n    };\r\n\r\n    const markAllAsRead = async () => {\r\n        const unreadToUpdate = notifications.filter(n => !n.read);\r\n        for (const notification of unreadToUpdate) {\r\n            if (isAdmin) await notificationService.markAsRead(notification.id);\r\n            else await markNotificationAsRead(notification.id);\r\n        }\r\n    };\r\n\r\n    const getFilteredNotifications = () => {\r\n        switch (activeTab) {\r\n            case 'unread': return notifications.filter(n => !n.read);\r\n            case 'high': return notifications.filter(n => n.priority === 'high');\r\n            default: return notifications;\r\n        }\r\n    };\r\n\r\n    const getIcon = (type?: string, read?: boolean) => {\r\n        const baseClass = \"w-9 h-9 rounded-2xl flex items-center justify-center shrink-0 border shadow-sm transition-all duration-300\";\r\n        switch (type) {\r\n            case 'FINANCE_CLOSING': return <div className={`${baseClass} bg-emerald-500/10 text-emerald-600 border-emerald-500/20`}><DollarSign className=\"w-4 h-4\" /></div>;\r\n            case 'RATE_CHANGE': return <div className={`${baseClass} bg-amber-500/10 text-amber-500 border-amber-500/20`}><AlertTriangle className=\"w-4 h-4\" /></div>;\r\n            case 'SUPPORT_TICKET': return <div className={`${baseClass} bg-blue-500/10 text-blue-500 border-blue-500/20`}><Ticket className=\"w-4 h-4\" /></div>;\r\n            case 'UNLOCK_REQUEST': return <div className={`${baseClass} bg-violet-500/10 text-violet-600 border-violet-500/20 animate-pulse`}><Lock className=\"w-4 h-4\" /></div>;\r\n            case 'MONTH_UNLOCKED': return <div className={`${baseClass} bg-emerald-500/10 text-emerald-600 border-emerald-500/20`}><Check className=\"w-4 h-4\" /></div>;\r\n            case 'UNLOCK_REJECTED': return <div className={`${baseClass} bg-rose-500/10 text-rose-600 border-rose-500/20`}><ShieldAlert className=\"w-4 h-4\" /></div>;\r\n            case 'GUIDE_TIP': return <div className={`${baseClass} bg-indigo-500/10 text-indigo-600 border-indigo-500/20`}><BookOpen className=\"w-4 h-4\" /></div>;\r\n            case 'shift_change_request': return <div className={`${baseClass} bg-amber-500/10 text-amber-600 border-amber-500/20`}><AlertTriangle className=\"w-4 h-4\" /></div>;\r\n            case 'shift_confirmed': return <div className={`${baseClass} bg-emerald-500/10 text-emerald-600 border-emerald-500/20`}><Check className=\"w-4 h-4\" /></div>;\r\n            case 'incident': return <div className={`${baseClass} bg-rose-500/10 text-rose-600 border-rose-500/20 animate-pulse`}><ShieldAlert className=\"w-4 h-4\" /></div>;\r\n            default: return <div className={`${baseClass} ${read ? 'bg-slate-100 text-slate-400 border-slate-200' : 'bg-indigo-500/10 text-indigo-500 border-indigo-500/20'}`}><Bell className=\"w-4 h-4\" /></div>;\r\n        }\r\n    };\r\n\r\n    const filteredNotifications = getFilteredNotifications();\r\n\r\n    return (\r\n        <div className=\"relative mr-2\" ref={wrapperRef}>\r\n            <button\r\n                onClick={() => setIsOpen(!isOpen)}\r\n                className={`\r\n                    p-2.5 rounded-full transition-all duration-300 relative group\r\n                    ${isOpen\r\n                        ? 'bg-indigo-50 text-indigo-600 ring-2 ring-indigo-500/20'\r\n                        : 'text-slate-500 hover:text-indigo-600 hover:bg-slate-50'\r\n                    }\r\n                `}\r\n                title=\"Notificaciones\"\r\n            >\r\n                <Bell className={`w-5 h-5 transition-transform duration-300 ${isOpen ? 'rotate-12 scale-110' : 'group-hover:scale-110'}`} />\r\n                {unreadCount > 0 && (\r\n                    <span className=\"absolute top-2 right-2.5 w-2 h-2 bg-rose-500 rounded-full border border-white ring-2 ring-rose-500/20 animate-pulse\" />\r\n                )}\r\n            </button>\r\n\r\n            {isOpen && (\r\n                <div className=\"absolute right-0 mt-4 w-[420px] bg-white/80 backdrop-blur-2xl rounded-3xl shadow-2xl border border-white/50 z-50 overflow-hidden animate-in fade-in slide-in-from-top-2 duration-300 ring-1 ring-black/5 origin-top-right\">\r\n\r\n                    {/* Header */}\r\n                    <div className=\"p-5 border-b border-slate-100/50 bg-white/50\">\r\n                        <div className=\"flex justify-between items-center mb-4\">\r\n                            <div className=\"flex items-center gap-2\">\r\n                                <h4 className=\"font-exhibit font-black text-slate-900 text-lg tracking-tight\">Notificaciones</h4>\r\n                                {unreadCount > 0 && (\r\n                                    <span className=\"text-[10px] font-bold text-white bg-indigo-500 px-2 py-0.5 rounded-full shadow-sm shadow-indigo-500/30\">\r\n                                        {unreadCount} nuevas\r\n                                    </span>\r\n                                )}\r\n                            </div>\r\n                            <button\r\n                                onClick={markAllAsRead}\r\n                                className=\"text-xs font-bold text-indigo-600 hover:text-indigo-700 hover:bg-indigo-50 px-2 py-1 rounded-lg transition-colors\"\r\n                            >\r\n                                Marcar le√≠das\r\n                            </button>\r\n                        </div>\r\n\r\n                        {/* Tabs */}\r\n                        <div className=\"flex p-1 bg-slate-100/50 rounded-xl backdrop-blur-sm\">\r\n                            {(['all', 'unread', 'high'] as const).map((tab) => (\r\n                                <button\r\n                                    key={tab}\r\n                                    onClick={() => setActiveTab(tab)}\r\n                                    className={`\r\n                                        flex-1 py-1.5 text-xs font-bold rounded-lg transition-all duration-200 capitalise\r\n                                        ${activeTab === tab\r\n                                            ? 'bg-white text-indigo-600 shadow-sm ring-1 ring-black/5'\r\n                                            : 'text-slate-500 hover:text-slate-700 hover:bg-white/50'\r\n                                        }\r\n                                    `}\r\n                                >\r\n                                    {tab === 'all' && 'Todas'}\r\n                                    {tab === 'unread' && 'No le√≠das'}\r\n                                    {tab === 'high' && 'Importantes'}\r\n                                </button>\r\n                            ))}\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* List */}\r\n                    <div className=\"max-h-[450px] overflow-y-auto custom-scrollbar bg-slate-50/30\">\r\n                        {filteredNotifications.length === 0 ? (\r\n                            <div className=\"p-16 text-center flex flex-col items-center justify-center min-h-[300px]\">\r\n                                <div className=\"w-16 h-16 bg-gradient-to-br from-slate-50 to-slate-100 rounded-full flex items-center justify-center mb-4 shadow-inner ring-1 ring-white\">\r\n                                    <Bell className=\"w-6 h-6 text-slate-300\" />\r\n                                </div>\r\n                                <p className=\"text-sm text-slate-900 font-bold mb-1\">Todo al d√≠a</p>\r\n                                <p className=\"text-xs text-slate-400 font-medium max-w-[200px] leading-relaxed\">\r\n                                    {activeTab === 'all'\r\n                                        ? 'No tienes notificaciones pendientes en este momento.'\r\n                                        : 'No hay notificaciones que coincidan con este filtro.'}\r\n                                </p>\r\n                            </div>\r\n                        ) : (\r\n                            <div className=\"divide-y divide-slate-100\">\r\n                                {filteredNotifications.map(item => (\r\n                                    <div\r\n                                        key={item.id}\r\n                                        onClick={() => handleNotificationClick(item)}\r\n                                        className={`\r\n                                            p-4 transition-all hover:bg-white relative group cursor-pointer flex gap-4\r\n                                            ${!item.read ? 'bg-indigo-50/30' : 'bg-transparent opacity-75 hover:opacity-100'}\r\n                                        `}\r\n                                    >\r\n                                        {/* Unread Dot */}\r\n                                        {!item.read && (\r\n                                            <div className=\"absolute left-0 top-1/2 -translate-y-1/2 w-0.5 h-12 bg-indigo-500 rounded-r-full\" />\r\n                                        )}\r\n\r\n                                        {/* Icon */}\r\n                                        <div className=\"mt-1\">\r\n                                            {getIcon(item.type, item.read)}\r\n                                        </div>\r\n\r\n                                        {/* Content */}\r\n                                        <div className=\"flex-1 min-w-0\">\r\n                                            <div className=\"flex justify-between items-start mb-1 gap-2\">\r\n                                                <h5 className={`text-sm font-bold truncate ${!item.read ? 'text-slate-900' : 'text-slate-600'}`}>\r\n                                                    {item.title}\r\n                                                </h5>\r\n                                                {/* Date */}\r\n                                                <span className=\"text-[10px] text-slate-400 shrink-0 whitespace-nowrap pt-0.5 font-medium\">\r\n                                                    {item.createdAt ? formatTimeAgo(item.createdAt.toDate()) : 'Reciente'}\r\n                                                </span>\r\n                                            </div>\r\n\r\n                                            <p className={`text-xs leading-relaxed mb-2.5 line-clamp-2 ${!item.read ? 'text-slate-600 font-medium' : 'text-slate-400'}`}>\r\n                                                {item.message}\r\n                                            </p>\r\n\r\n                                            {/* Action Hints */}\r\n                                            {item.type === 'UNLOCK_REQUEST' && (\r\n                                                <div className=\"inline-flex items-center gap-1.5 text-[10px] font-bold text-amber-700 bg-amber-50 px-2.5 py-1 rounded-lg border border-amber-100/50 shadow-sm transition-transform group-hover:translate-x-1\">\r\n                                                    <span>Revisar Solicitud</span>\r\n                                                    <ArrowRight className=\"w-3 h-3\" />\r\n                                                </div>\r\n                                            )}\r\n                                            {item.type === 'MONTH_UNLOCKED' && (\r\n                                                <div className=\"inline-flex items-center gap-1.5 text-[10px] font-bold text-emerald-700 bg-emerald-50 px-2.5 py-1 rounded-lg border border-emerald-100/50 shadow-sm transition-transform group-hover:translate-x-1\">\r\n                                                    <span>Ir al Hist√≥rico</span>\r\n                                                    <ArrowRight className=\"w-3 h-3\" />\r\n                                                </div>\r\n                                            )}\r\n                                        </div>\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n\r\n                    {/* Footer */}\r\n                    <div className=\"p-3 bg-white/80 border-t border-slate-100 backdrop-blur-sm text-center\">\r\n                        <button className=\"text-[10px] font-bold text-slate-400 hover:text-indigo-600 transition-colors uppercase tracking-wider\">\r\n                            Ver todo el historial\r\n                        </button>\r\n                    </div>\r\n                </div >\r\n            )}\r\n        </div >\r\n    );\r\n};\r\n\r\nexport default Notifications;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\layouts\\components\\ThemeToggle.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\layouts\\components\\UserMenu.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\layouts\\components\\dev\\ConsoleViewer.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":61,"column":79,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":61,"endColumn":82,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2429,2432],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2429,2432],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { X, Trash2, Download } from 'lucide-react';\r\nimport { ConsoleLog, LogLevel, clearLogs, subscribeToLogs, exportLogs, formatLogTime, startConsoleCapture } from '../../../scripts/consoleCapture';\r\n\r\ninterface ConsoleViewerProps {\r\n    isOpen: boolean;\r\n    onClose: () => void;\r\n}\r\n\r\nconst ConsoleViewer: React.FC<ConsoleViewerProps> = ({ isOpen, onClose }) => {\r\n    const [logs, setLogs] = useState<ConsoleLog[]>([]);\r\n    const [filterLevel, setFilterLevel] = useState<LogLevel | 'all'>('all');\r\n\r\n    useEffect(() => {\r\n        // Start capturing console on mount\r\n        startConsoleCapture();\r\n\r\n        // Subscribe to log updates\r\n        const unsubscribe = subscribeToLogs(setLogs);\r\n\r\n        return unsubscribe;\r\n    }, []);\r\n\r\n    if (!isOpen) return null;\r\n\r\n    const filteredLogs = filterLevel === 'all'\r\n        ? logs\r\n        : logs.filter(log => log.level === filterLevel);\r\n\r\n    const levelColors = {\r\n        log: 'text-slate-300 bg-slate-800/30',\r\n        info: 'text-blue-300 bg-blue-900/20',\r\n        warn: 'text-amber-300 bg-amber-900/20',\r\n        error: 'text-red-300 bg-red-900/20'\r\n    };\r\n\r\n    const levelIcons = {\r\n        log: 'üìù',\r\n        info: '‚ÑπÔ∏è',\r\n        warn: '‚ö†Ô∏è',\r\n        error: '‚ùå'\r\n    };\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] flex items-center justify-center p-4\">\r\n            <div className=\"bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl w-full max-w-4xl max-h-[80vh] overflow-hidden flex flex-col\">\r\n                {/* Header */}\r\n                <div className=\"flex items-center justify-between p-4 border-b border-slate-800 bg-gradient-to-r from-slate-800 to-slate-900\">\r\n                    <div className=\"flex items-center gap-3\">\r\n                        <div className=\"text-2xl\">üñ•Ô∏è</div>\r\n                        <div>\r\n                            <h3 className=\"text-lg font-bold text-white\">Console Live</h3>\r\n                            <p className=\"text-xs text-slate-400\">{filteredLogs.length} mensajes</p>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"flex items-center gap-2\">\r\n                        {/* Filter */}\r\n                        <select\r\n                            value={filterLevel}\r\n                            onChange={(e) => setFilterLevel(e.target.value as any)}\r\n                            className=\"bg-slate-800 border border-slate-700 text-white text-xs rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-purple-500/50\"\r\n                            title=\"Filtrar por nivel\"\r\n                        >\r\n                            <option value=\"all\">Todos</option>\r\n                            <option value=\"log\">Log</option>\r\n                            <option value=\"info\">Info</option>\r\n                            <option value=\"warn\">Warning</option>\r\n                            <option value=\"error\">Error</option>\r\n                        </select>\r\n\r\n                        {/* Clear */}\r\n                        <button\r\n                            onClick={clearLogs}\r\n                            className=\"p-2 hover:bg-slate-800 rounded-lg transition-colors text-slate-400 hover:text-white\"\r\n                            title=\"Limpiar logs\"\r\n                        >\r\n                            <Trash2 className=\"w-4 h-4\" />\r\n                        </button>\r\n\r\n                        {/* Export */}\r\n                        <button\r\n                            onClick={exportLogs}\r\n                            className=\"p-2 hover:bg-slate-800 rounded-lg transition-colors text-slate-400 hover:text-white\"\r\n                            title=\"Exportar logs\"\r\n                        >\r\n                            <Download className=\"w-4 h-4\" />\r\n                        </button>\r\n\r\n                        {/* Close */}\r\n                        <button\r\n                            onClick={onClose}\r\n                            className=\"p-2 hover:bg-slate-800 rounded-lg transition-colors text-slate-400 hover:text-white\"\r\n                            title=\"Cerrar\"\r\n                        >\r\n                            <X className=\"w-4 h-4\" />\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Logs */}\r\n                <div className=\"flex-1 overflow-y-auto p-4 space-y-1 font-mono text-xs\">\r\n                    {filteredLogs.length === 0 ? (\r\n                        <div className=\"text-center text-slate-500 py-12\">\r\n                            <p className=\"text-4xl mb-2\">üì≠</p>\r\n                            <p>No hay logs capturados</p>\r\n                            <p className=\"text-xs mt-1\">Los nuevos logs aparecer√°n aqu√≠ en tiempo real</p>\r\n                        </div>\r\n                    ) : (\r\n                        filteredLogs.map(log => (\r\n                            <div\r\n                                key={log.id}\r\n                                className={`p-2 rounded border-l-2 ${log.level === 'error' ? 'border-red-500' :\r\n                                    log.level === 'warn' ? 'border-amber-500' :\r\n                                        log.level === 'info' ? 'border-blue-500' :\r\n                                            'border-slate-600'\r\n                                    } ${levelColors[log.level]}`}\r\n                            >\r\n                                <div className=\"flex items-start gap-2\">\r\n                                    <span>{levelIcons[log.level]}</span>\r\n                                    <span className=\"text-slate-500 text-[10px] mt-0.5 flex-shrink-0\">\r\n                                        {formatLogTime(log.timestamp)}\r\n                                    </span>\r\n                                    <pre className=\"flex-1 whitespace-pre-wrap break-all\">\r\n                                        {log.message}\r\n                                    </pre>\r\n                                </div>\r\n                            </div>\r\n                        ))\r\n                    )}\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default ConsoleViewer;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\layouts\\components\\dev\\DevToolsPanel.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'healthResult'. Either include it or remove the dependency array.","line":154,"column":8,"nodeType":"ArrayExpression","endLine":154,"endColumn":16,"suggestions":[{"desc":"Update the dependencies array to be: [healthResult, isOpen]","fix":{"range":[6710,6718],"text":"[healthResult, isOpen]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":170,"column":76,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":170,"endColumn":79,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7159,7162],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7159,7162],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":170,"column":91,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":170,"endColumn":94,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7174,7177],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7174,7177],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":521,"column":71,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":521,"endColumn":74,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[30278,30281],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[30278,30281],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport {\r\n    Wrench,\r\n    Database,\r\n    Trash2,\r\n    Search,\r\n    CheckCircle,\r\n    AlertTriangle,\r\n    Download,\r\n    RefreshCw,\r\n    Bug,\r\n    ChevronDown,\r\n    ChevronRight,\r\n    FileText,\r\n    Zap,\r\n    Shield,\r\n    Package,\r\n    Info,\r\n    Activity,\r\n    XCircle,\r\n    Star,\r\n    Calendar as CalendarIcon\r\n} from 'lucide-react';\r\nimport { investigateAllFranchises } from '../../../scripts/cleanupFranchises';\r\nimport { executeCleanup } from '../../../scripts/executeCleanup';\r\nimport { investigateFinancialData } from '../../../scripts/investigateFinancialData';\r\nimport { verifyDataIntegrity, captureAppState, financialAudit } from '../../../scripts/devUtils';\r\nimport { runHealthCheck, HealthCheckResult } from '../../../scripts/healthCheck';\r\nimport ToastContainer, { useToast } from './ToastContainer';\r\nimport { getHistory, addToHistory, updateHistoryAction, formatDuration, HistoryAction } from '../../../scripts/actionHistory';\r\nimport ConsoleViewer from './ConsoleViewer';\r\nimport NetworkMonitor from './NetworkMonitor';\r\nimport PerformanceDashboard from './PerformanceDashboard';\r\nimport SchedulerInspector from './SchedulerInspector';\r\ninterface DevToolsPanelProps {\r\n    isOpen: boolean;\r\n    onClose: () => void;\r\n    onOpenReset?: () => void;\r\n}\r\n\r\ninterface ToolButtonProps {\r\n    icon: React.ReactNode;\r\n    title: string;\r\n    description: string;\r\n    usage: string;\r\n    onClick: () => void;\r\n    variant: 'purple' | 'indigo' | 'red' | 'amber' | 'green' | 'blue' | 'emerald';\r\n    disabled?: boolean;\r\n    isFavorite?: boolean;\r\n    onToggleFavorite?: () => void;\r\n}\r\n\r\nconst ToolButton: React.FC<ToolButtonProps> = ({ icon, title, description, usage, onClick, variant, disabled, isFavorite, onToggleFavorite }) => {\r\n    const [showInfo, setShowInfo] = useState(false);\r\n\r\n    const colorMap = {\r\n        purple: 'bg-purple-600/20 hover:bg-purple-600/30 border-purple-500/30 text-purple-400',\r\n        indigo: 'bg-indigo-600/20 hover:bg-indigo-600/30 border-indigo-500/30 text-indigo-400',\r\n        red: 'bg-red-600/20 hover:bg-red-600/30 border-red-500/30 text-red-400',\r\n        amber: 'bg-amber-600/20 hover:bg-amber-600/30 border-amber-500/30 text-amber-400',\r\n        green: 'bg-green-600/20 hover:bg-green-600/30 border-green-500/30 text-green-400',\r\n        blue: 'bg-blue-600/20 hover:bg-blue-600/30 border-blue-500/30 text-blue-400',\r\n        emerald: 'bg-emerald-600/20 hover:bg-emerald-600/30 border-emerald-500/30 text-emerald-400'\r\n    };\r\n\r\n    return (\r\n        <div className=\"relative\">\r\n            <div className=\"relative\">\r\n                <div\r\n                    role=\"button\"\r\n                    tabIndex={disabled ? -1 : 0}\r\n                    onClick={!disabled ? onClick : undefined}\r\n                    onKeyDown={(e) => {\r\n                        if (!disabled && (e.key === 'Enter' || e.key === ' ')) {\r\n                            e.preventDefault();\r\n                            onClick();\r\n                        }\r\n                    }}\r\n                    className={`w-full flex items-start gap-3 p-3 border rounded-lg transition-all text-white group cursor-pointer ${disabled ? 'opacity-50 cursor-not-allowed' : ''} ${colorMap[variant]}`}\r\n                >\r\n                    <div className=\"flex-shrink-0 mt-0.5\">{icon}</div>\r\n                    <div className=\"text-left flex-1\">\r\n                        <div className=\"flex items-center justify-between\">\r\n                            <p className=\"text-sm font-semibold\">{title}</p>\r\n                            <div className=\"flex items-center gap-1\">\r\n                                {onToggleFavorite && (\r\n                                    <button\r\n                                        onClick={(e) => {\r\n                                            e.stopPropagation();\r\n                                            onToggleFavorite();\r\n                                        }}\r\n                                        className=\"p-1 hover:bg-white/10 rounded transition-colors\"\r\n                                        title={isFavorite ? 'Quitar de favoritos' : 'A√±adir a favoritos'}\r\n                                    >\r\n                                        <Star className={`w-3 h-3 ${isFavorite ? 'fill-yellow-400 text-yellow-400' : 'text-slate-500'}`} />\r\n                                    </button>\r\n                                )}\r\n                                <button\r\n                                    onClick={(e) => {\r\n                                        e.stopPropagation();\r\n                                        setShowInfo(!showInfo);\r\n                                    }}\r\n                                    className=\"p-1 hover:bg-white/10 rounded transition-colors\"\r\n                                    title=\"Ver informaci√≥n\"\r\n                                >\r\n                                    <Info className=\"w-3 h-3\" />\r\n                                </button>\r\n                            </div>\r\n                        </div>\r\n                        <p className=\"text-xs text-slate-400 mt-0.5\">{description}</p>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {showInfo && (\r\n                <div className=\"mt-2 p-3 bg-slate-800/80 border border-slate-700 rounded-lg text-xs\">\r\n                    <p className=\"text-slate-300 font-semibold mb-1\">üìñ C√≥mo usar:</p>\r\n                    <p className=\"text-slate-400\">{usage}</p>\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n};\r\n\r\nconst DevToolsPanel: React.FC<DevToolsPanelProps> = ({\r\n    isOpen,\r\n    onClose,\r\n    onOpenReset\r\n}) => {\r\n    const [activeSection, setActiveSection] = useState<string | null>('health');\r\n    const [isExecuting, setIsExecuting] = useState(false);\r\n    const [healthResult, setHealthResult] = useState<HealthCheckResult | null>(null);\r\n    const [isCheckingHealth, setIsCheckingHealth] = useState(false);\r\n    const [, setHistory] = useState<HistoryAction[]>([]);\r\n    const [searchQuery, setSearchQuery] = useState('');\r\n    const [isConsoleOpen, setIsConsoleOpen] = useState(false);\r\n    const [isNetworkOpen, setIsNetworkOpen] = useState(false);\r\n    const [isPerformanceOpen, setIsPerformanceOpen] = useState(false);\r\n    const [isSchedulerOpen, setIsSchedulerOpen] = useState(false);\r\n\r\n    // Toast notifications\r\n    const toast = useToast();\r\n\r\n    // Load history on mount\r\n    useEffect(() => {\r\n        setHistory(getHistory());\r\n    }, []);\r\n\r\n    // Auto-run health check when panel opens\r\n    useEffect(() => {\r\n        if (isOpen && !healthResult) {\r\n            performHealthCheck();\r\n        }\r\n    }, [isOpen]);\r\n\r\n    const performHealthCheck = async () => {\r\n        setIsCheckingHealth(true);\r\n        try {\r\n            const result = await runHealthCheck();\r\n            setHealthResult(result);\r\n        } catch (error) {\r\n            console.error('Health check failed:', error);\r\n        } finally {\r\n            setIsCheckingHealth(false);\r\n        }\r\n    };\r\n\r\n\r\n\r\n    const executeAction = async (actionName: string, action: () => Promise<any>): Promise<any> => {\r\n        setIsExecuting(true);\r\n        const startTime = Date.now();\r\n\r\n        // Add to history as 'running'\r\n        const historyEntry = addToHistory({\r\n            name: actionName,\r\n            status: 'running'\r\n        });\r\n        setHistory(getHistory());\r\n\r\n        try {\r\n            const result = await action();\r\n            const duration = Date.now() - startTime;\r\n\r\n            // Update history as success\r\n            updateHistoryAction(historyEntry.id, {\r\n                status: 'success',\r\n                result,\r\n                duration\r\n            });\r\n            setHistory(getHistory());\r\n\r\n            // Show success toast\r\n            toast.success(actionName, `Completado en ${formatDuration(duration)}`);\r\n\r\n            console.log(`‚úÖ ${actionName}`, result);\r\n            return result;\r\n        } catch (error) {\r\n            const duration = Date.now() - startTime;\r\n            const errorMessage = error instanceof Error ? error.message : String(error);\r\n\r\n            // Update history as error\r\n            updateHistoryAction(historyEntry.id, {\r\n                status: 'error',\r\n                error: errorMessage,\r\n                duration\r\n            });\r\n            setHistory(getHistory());\r\n\r\n            // Show error toast\r\n            toast.error(actionName, errorMessage);\r\n\r\n            console.error('‚ùå Error:', error);\r\n            throw error;\r\n        } finally {\r\n            setIsExecuting(false);\r\n        }\r\n    };\r\n\r\n    if (!isOpen) return null;\r\n\r\n    return (\r\n        <>\r\n            {/* Toast Container */}\r\n            <ToastContainer toasts={toast.toasts} onDismiss={toast.dismissToast} />\r\n\r\n            <div className=\"fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4\">\r\n                <div className=\"bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl max-w-3xl w-full max-h-[85vh] overflow-hidden\">\r\n                    {/* Header */}\r\n                    <div className=\"flex items-center justify-between p-6 border-b border-slate-800 bg-gradient-to-r from-purple-900/20 to-blue-900/20\">\r\n                        <div className=\"flex items-center gap-3\">\r\n                            <div className=\"p-2 bg-purple-500/20 rounded-lg\">\r\n                                <Wrench className=\"w-6 h-6 text-purple-400\" />\r\n                            </div>\r\n                            <div>\r\n                                <h2 className=\"text-xl font-bold text-white\">Developer Tools</h2>\r\n                                <p className=\"text-xs text-slate-400\">Herramientas de diagn√≥stico y control de c√≥digo</p>\r\n                            </div>\r\n                        </div>\r\n                        <button\r\n                            onClick={onClose}\r\n                            className=\"p-2 hover:bg-slate-800 rounded-lg transition-colors text-slate-400 hover:text-white\"\r\n                        >\r\n                            ‚úï\r\n                        </button>\r\n                    </div>\r\n\r\n                    {/* Search Bar */}\r\n                    <div className=\"px-6 py-4 border-b border-slate-800\">\r\n                        <input\r\n                            type=\"text\"\r\n                            placeholder=\"üîç Buscar herramientas...\"\r\n                            value={searchQuery}\r\n                            onChange={(e) => setSearchQuery(e.target.value)}\r\n                            className=\"w-full bg-slate-800/50 border border-slate-700/50 text-white placeholder-slate-400 rounded-lg px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500/50\"\r\n                        />\r\n                    </div>\r\n\r\n                    {/* Content */}\r\n                    <div className=\"p-6 space-y-4 overflow-y-auto max-h-[calc(85vh-180px)]\">\r\n                        {/* Health Check Section - Always First */}\r\n                        <div className=\"space-y-2\">\r\n                            <button\r\n                                onClick={() => setActiveSection(activeSection === 'health' ? null : 'health')}\r\n                                className=\"w-full flex items-center justify-between p-3 bg-slate-800/50 hover:bg-slate-800 rounded-lg transition-colors text-white\"\r\n                            >\r\n                                <div className=\"flex items-center gap-3\">\r\n                                    <Activity className=\"w-5 h-5 text-emerald-400\" />\r\n                                    <span className=\"font-semibold\">Health Check</span>\r\n                                    {healthResult && (\r\n                                        <span className=\"text-2xl\">\r\n                                            {healthResult.status === 'healthy' && 'üü¢'}\r\n                                            {healthResult.status === 'warning' && 'üü°'}\r\n                                            {healthResult.status === 'critical' && 'üî¥'}\r\n                                        </span>\r\n                                    )}\r\n                                </div>\r\n                                {activeSection === 'health' ? <ChevronDown className=\"w-5 h-5\" /> : <ChevronRight className=\"w-5 h-5\" />}\r\n                            </button>\r\n\r\n                            {activeSection === 'health' && (\r\n                                <div className=\"ml-8 space-y-3\">\r\n                                    {/* Status Banner */}\r\n                                    <div className={`p-4 rounded-lg border ${healthResult?.status === 'healthy' ? 'bg-emerald-500/10 border-emerald-500/30' :\r\n                                        healthResult?.status === 'warning' ? 'bg-amber-500/10 border-amber-500/30' :\r\n                                            'bg-red-500/10 border-red-500/30'\r\n                                        }`}>\r\n                                        <div className=\"flex items-center justify-between mb-3\">\r\n                                            <div className=\"flex items-center gap-2\">\r\n                                                <span className=\"text-3xl\">\r\n                                                    {healthResult?.status === 'healthy' && 'üü¢'}\r\n                                                    {healthResult?.status === 'warning' && 'üü°'}\r\n                                                    {healthResult?.status === 'critical' && 'üî¥'}\r\n                                                </span>\r\n                                                <div>\r\n                                                    <p className=\"text-sm font-bold text-white\">\r\n                                                        {healthResult?.status === 'healthy' && 'Sistema Saludable'}\r\n                                                        {healthResult?.status === 'warning' && 'Advertencias Detectadas'}\r\n                                                        {healthResult?.status === 'critical' && 'Errores Cr√≠ticos'}\r\n                                                    </p>\r\n                                                    <p className=\"text-xs text-slate-400\">\r\n                                                        {healthResult?.timestamp.toLocaleString()}\r\n                                                    </p>\r\n                                                </div>\r\n                                            </div>\r\n                                            <button\r\n                                                onClick={performHealthCheck}\r\n                                                disabled={isCheckingHealth}\r\n                                                className=\"px-3 py-1.5 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-xs font-medium transition-all disabled:opacity-50\"\r\n                                            >\r\n                                                {isCheckingHealth ? 'Escaneando...' : 'Re-scan'}\r\n                                            </button>\r\n                                        </div>\r\n\r\n                                        {/* Check Results */}\r\n                                        <div className=\"space-y-2\">\r\n                                            {healthResult?.checks.map((check, idx) => (\r\n                                                <div key={idx} className=\"flex items-start gap-2 bg-slate-900/50 p-2 rounded\">\r\n                                                    {check.status === 'pass' && <CheckCircle className=\"w-4 h-4 text-green-400 flex-shrink-0 mt-0.5\" />}\r\n                                                    {check.status === 'warning' && <AlertTriangle className=\"w-4 h-4 text-amber-400 flex-shrink-0 mt-0.5\" />}\r\n                                                    {check.status === 'fail' && <XCircle className=\"w-4 h-4 text-red-400 flex-shrink-0 mt-0.5\" />}\r\n                                                    <div className=\"flex-1\">\r\n                                                        <p className=\"text-xs font-semibold text-white\">{check.name}</p>\r\n                                                        <p className=\"text-xs text-slate-400\">{check.message}</p>\r\n                                                        {check.details && (\r\n                                                            <p className=\"text-xs text-slate-500 mt-0.5\">{check.details}</p>\r\n                                                        )}\r\n                                                    </div>\r\n                                                </div>\r\n                                            ))}\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n\r\n                        {/* Data Section */}\r\n                        <div className=\"space-y-2\">\r\n                            <button\r\n                                onClick={() => setActiveSection(activeSection === 'data' ? null : 'data')}\r\n                                className=\"w-full flex items-center justify-between p-3 bg-slate-800/50 hover:bg-slate-800 rounded-lg transition-colors text-white\"\r\n                            >\r\n                                <div className=\"flex items-center gap-3\">\r\n                                    <Database className=\"w-5 h-5 text-blue-400\" />\r\n                                    <span className=\"font-semibold\">Gesti√≥n de Datos</span>\r\n                                </div>\r\n                                {activeSection === 'data' ? <ChevronDown className=\"w-5 h-5\" /> : <ChevronRight className=\"w-5 h-5\" />}\r\n                            </button>\r\n\r\n                            {activeSection === 'data' && (\r\n                                <div className=\"ml-8 space-y-2\">\r\n                                    <ToolButton\r\n                                        icon={<Search className=\"w-4 h-4\" />}\r\n                                        title=\"Investigar Franquicias\"\r\n                                        description=\"Ver todas las franquicias y sus datos asociados\"\r\n                                        usage=\"Haz clic y revisa la consola. Mostrar√°: lista de franquicias, sus UIDs, emails, status, y cu√°ntos documentos financieros tiene cada una.\"\r\n                                        onClick={() => executeAction('Investigar Franquicias', investigateAllFranchises)}\r\n                                        variant=\"purple\"\r\n                                        disabled={isExecuting}\r\n                                    />\r\n\r\n                                    <ToolButton\r\n                                        icon={<Database className=\"w-4 h-4\" />}\r\n                                        title=\"Investigar Datos Financieros\"\r\n                                        description=\"Analizar todos los registros en financial_summaries\"\r\n                                        usage=\"Muestra todos los documentos agrupados por mes, con totales de ingresos. √ötil para ver el panorama completo de datos financieros.\"\r\n                                        onClick={() => executeAction('Investigar Datos Financieros', investigateFinancialData)}\r\n                                        variant=\"indigo\"\r\n                                        disabled={isExecuting}\r\n                                    />\r\n\r\n                                    {/* Scheduler Inspector (New) */}\r\n                                    <ToolButton\r\n                                        icon={<CalendarIcon className=\"w-4 h-4\" />}\r\n                                        title=\"Scheduler Inspector\"\r\n                                        description=\"Verificar y gestionar tareas programadas\"\r\n                                        usage=\"Muestra el estado de los cron jobs, pr√≥ximas ejecuciones y logs. √ötil para debugging de automatizaciones.\"\r\n                                        onClick={() => setIsSchedulerOpen(true)}\r\n                                        variant=\"emerald\"\r\n                                        disabled={isExecuting}\r\n                                    />\r\n\r\n                                    <ToolButton\r\n                                        icon={<Shield className=\"w-4 h-4\" />}\r\n                                        title=\"Verificar Integridad de Datos\"\r\n                                        description=\"Detectar registros hu√©rfanos y datos corruptos\"\r\n                                        usage=\"Ejecuta checks de integridad. Busca registros sin franquicia asociada, datos inv√°lidos, o inconsistencias. Recomendado ejecutar mensualmente.\"\r\n                                        onClick={() => executeAction('Verificar Integridad', verifyDataIntegrity)}\r\n                                        variant=\"green\"\r\n                                        disabled={isExecuting}\r\n                                    />\r\n\r\n                                    <ToolButton\r\n                                        icon={<Package className=\"w-4 h-4\" />}\r\n                                        title=\"Auditor√≠a Financiera\"\r\n                                        description=\"Validar que todos los c√°lculos sean correctos\"\r\n                                        usage=\"Genera un reporte completo por mes con totales, m√°rgenes y profit. √ötil antes de cerrar un periodo fiscal o si los n√∫meros 'no cuadran'.\"\r\n                                        onClick={() => executeAction('Auditor√≠a Financiera', financialAudit)}\r\n                                        variant=\"emerald\"\r\n                                        disabled={isExecuting}\r\n                                    />\r\n\r\n                                    <ToolButton\r\n                                        icon={<Trash2 className=\"w-4 h-4\" />}\r\n                                        title=\"Limpiar Datos Hu√©rfanos\"\r\n                                        description=\"Eliminar registros de franquicias obsoletas\"\r\n                                        usage=\"‚ö†Ô∏è PERMANENTE. Elimina documentos de franquicias que ya no existen. Confirma antes de ejecutar. Hace backup autom√°tico.\"\r\n                                        onClick={async () => {\r\n                                            const confirmed = confirm('‚ö†Ô∏è Esto eliminar√° datos de forma PERMANENTE. ¬øContinuar?');\r\n                                            if (confirmed) {\r\n                                                const result = await executeAction('Limpiar Datos Hu√©rfanos', executeCleanup);\r\n                                                alert(`‚úÖ Eliminados: ${result.deleted} docs\\nMantenidos: ${result.kept} docs`);\r\n                                            }\r\n                                        }}\r\n                                        variant=\"red\"\r\n                                        disabled={isExecuting}\r\n                                    />\r\n\r\n                                    <ToolButton\r\n                                        icon={<RefreshCw className=\"w-4 h-4\" />}\r\n                                        title=\"Limpiar Cache Local\"\r\n                                        description=\"Borrar localStorage y sessionStorage\"\r\n                                        usage=\"Limpia toda la cache del navegador. √ötil si ves datos antiguos o comportamientos extra√±os. Perder√°s sesi√≥n actual.\"\r\n                                        onClick={() => {\r\n                                            const count = localStorage.length + sessionStorage.length;\r\n                                            localStorage.clear();\r\n                                            sessionStorage.clear();\r\n                                            alert(`‚úÖ Cache limpiado (${count} items). Recarga la p√°gina.`);\r\n                                        }}\r\n                                        variant=\"amber\"\r\n                                    />\r\n\r\n                                    {onOpenReset && (\r\n                                        <ToolButton\r\n                                            icon={<Trash2 className=\"w-4 h-4\" />}\r\n                                            title=\"System Reset\"\r\n                                            description=\"Ir al panel de reinicio del sistema\"\r\n                                            usage=\"Te redirige a la pesta√±a de Reset para realizar operaciones de limpieza profunda o reinicio de base de datos.\"\r\n                                            onClick={() => {\r\n                                                onOpenReset();\r\n                                                onClose();\r\n                                            }}\r\n                                            variant=\"red\"\r\n                                        />\r\n                                    )}\r\n\r\n\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n\r\n                        {/* System Section */}\r\n                        <div className=\"space-y-2\">\r\n                            <button\r\n                                onClick={() => setActiveSection(activeSection === 'system' ? null : 'system')}\r\n                                className=\"w-full flex items-center justify-between p-3 bg-slate-800/50 hover:bg-slate-800 rounded-lg transition-colors text-white\"\r\n                            >\r\n                                <div className=\"flex items-center gap-3\">\r\n                                    <Bug className=\"w-5 h-5 text-green-400\" />\r\n                                    <span className=\"font-semibold\">Sistema y Diagn√≥stico</span>\r\n                                </div>\r\n                                {activeSection === 'system' ? <ChevronDown className=\"w-5 h-5\" /> : <ChevronRight className=\"w-5 h-5\" />}\r\n                            </button>\r\n\r\n                            {activeSection === 'system' && (\r\n                                <div className=\"ml-8 space-y-2\">\r\n                                    <ToolButton\r\n                                        icon={<CheckCircle className=\"w-4 h-4\" />}\r\n                                        title=\"Info del Sistema\"\r\n                                        description=\"Ver detalles del navegador y entorno\"\r\n                                        usage=\"Muestra: User Agent, idioma, estado de conexi√≥n, capacidades del navegador, versi√≥n del navegador. √ötil para debugging de compatibilidad.\"\r\n                                        onClick={() => {\r\n                                            console.log('üîç Informaci√≥n del Sistema:');\r\n                                            console.log('- User Agent:', navigator.userAgent);\r\n                                            console.log('- Idioma:', navigator.language);\r\n                                            console.log('- Online:', navigator.onLine);\r\n                                            console.log('- LocalStorage:', !!window.localStorage);\r\n                                            console.log('- ServiceWorker:', 'serviceWorker' in navigator);\r\n                                            console.log('- Cookies habilitadas:', navigator.cookieEnabled);\r\n                                            alert('‚úÖ Revisa la consola para detalles del sistema');\r\n                                        }}\r\n                                        variant=\"green\"\r\n                                    />\r\n\r\n                                    <ToolButton\r\n                                        icon={<Zap className=\"w-4 h-4\" />}\r\n                                        title=\"Performance Dashboard\"\r\n                                        description=\"Monitor de memoria y carga\"\r\n                                        usage=\"Analiza memoria JS, tiempos de carga de p√°gina y los recursos m√°s pesados/lentos en tiempo real.\"\r\n                                        onClick={() => setIsPerformanceOpen(true)}\r\n                                        variant=\"blue\"\r\n                                    />\r\n\r\n                                    <ToolButton\r\n                                        icon={<FileText className=\"w-4 h-4\" />}\r\n                                        title=\"Console Live\"\r\n                                        description=\"Ver console.log en tiempo real\"\r\n                                        usage=\"Abre un panel que captura todos los console.log/warn/error en tiempo real. Puedes filtrar por nivel y exportar los logs.\"\r\n                                        onClick={() => setIsConsoleOpen(true)}\r\n                                        variant=\"purple\"\r\n                                    />\r\n\r\n                                    <ToolButton\r\n                                        icon={<Download className=\"w-4 h-4\" />}\r\n                                        title=\"Exportar Estado de App\"\r\n                                        description=\"Capturar snapshot para debugging\"\r\n                                        usage=\"Descarga un JSON con todo el estado actual: URL, localStorage, errores, performance. Comp√°rtelo para reportar bugs o an√°lisis.\"\r\n                                        onClick={() => {\r\n                                            captureAppState();\r\n                                            alert('‚úÖ Estado exportado. Revisa tu carpeta de descargas.');\r\n                                        }}\r\n                                        variant=\"indigo\"\r\n                                    />\r\n\r\n                                    <ToolButton\r\n                                        icon={<AlertTriangle className=\"w-4 h-4\" />}\r\n                                        title=\"Ver Errores de Runtime\"\r\n                                        description=\"Mostrar errores capturados por la app\"\r\n                                        usage=\"Lista todos los errores JavaScript capturados. Si no hay un error handler global, mostrar√°cu√°ntos errores tiene almacenados.\"\r\n                                        onClick={() => {\r\n                                            const errors = (window as any).__RUNTIME_ERRORS__ || [];\r\n                                            console.log('‚ö†Ô∏è Errores capturados:', errors);\r\n                                            if (errors.length === 0) {\r\n                                                alert('‚úÖ No hay errores registrados.');\r\n                                            } else {\r\n                                                alert(`‚ö†Ô∏è Se encontraron ${errors.length} errores. Revisa la consola.`);\r\n                                            }\r\n                                        }}\r\n                                        variant=\"amber\"\r\n                                    />\r\n\r\n                                    <ToolButton\r\n                                        icon={<RefreshCw className=\"w-4 h-4\" />}\r\n                                        title=\"Recargar Aplicaci√≥n\"\r\n                                        description=\"Hard reload sin cache (Ctrl+Shift+R)\"\r\n                                        usage=\"Recarga la p√°gina forzando descarga de todos los recursos. Equivale a F5 o Ctrl+Shift+R. Limpia cache de navegador.\"\r\n                                        onClick={() => window.location.reload()}\r\n                                        variant=\"blue\"\r\n                                    />\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n\r\n                        {/* Debug Section */}\r\n                        <div className=\"space-y-2\">\r\n                            <button\r\n                                onClick={() => setActiveSection(activeSection === 'debug' ? null : 'debug')}\r\n                                className=\"w-full flex items-center justify-between p-3 bg-slate-800/50 hover:bg-slate-800 rounded-lg transition-colors text-white\"\r\n                            >\r\n                                <div className=\"flex items-center gap-3\">\r\n                                    <FileText className=\"w-5 h-5 text-purple-400\" />\r\n                                    <span className=\"font-semibold\">Debug Avanzado</span>\r\n                                </div>\r\n                                {activeSection === 'debug' ? <ChevronDown className=\"w-5 h-5\" /> : <ChevronRight className=\"w-5 h-5\" />}\r\n                            </button>\r\n\r\n                            {activeSection === 'debug' && (\r\n                                <div className=\"ml-8 space-y-2\">\r\n                                    <ToolButton\r\n                                        icon={<FileText className=\"w-4 h-4\" />}\r\n                                        title=\"Ver Variables de Entorno\"\r\n                                        description=\"Mostrar configuraci√≥n y variables de entorno\"\r\n                                        usage=\"Lista todas las variables de entorno disponibles (import.meta.env). √ötil para verificar configuraci√≥n de producci√≥n vs desarrollo.\"\r\n                                        onClick={() => {\r\n                                            console.log('üîß Variables de Entorno:', import.meta.env);\r\n                                            alert('‚úÖ Variables mostradas en consola');\r\n                                        }}\r\n                                        variant=\"purple\"\r\n                                    />\r\n\r\n                                    <ToolButton\r\n                                        icon={<Activity className=\"w-4 h-4\" />}\r\n                                        title=\"Network Monitor\"\r\n                                        description=\"Ver tr√°fico de Firestore en tiempo real\"\r\n                                        usage=\"Monitor de red espec√≠fico para Firestore. Analiza tiempos de respuesta, queries lentas y errores. Exportable a JSON.\"\r\n                                        onClick={() => setIsNetworkOpen(true)}\r\n                                        variant=\"emerald\"\r\n                                    />\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Footer */}\r\n                    <div className=\"p-4 border-t border-slate-800 bg-slate-900/50\">\r\n                        <div className=\"flex items-center justify-between\">\r\n                            <p className=\"text-xs text-slate-500\">\r\n                                ‚ö†Ô∏è Herramientas de desarrollo - Uso exclusivo para debugging\r\n                            </p>\r\n                            <p className=\"text-xs text-slate-600 font-mono\">\r\n                                v1.0.0\r\n                            </p>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Modals */}\r\n            <ConsoleViewer isOpen={isConsoleOpen} onClose={() => setIsConsoleOpen(false)} />\r\n            <NetworkMonitor isOpen={isNetworkOpen} onClose={() => setIsNetworkOpen(false)} />\r\n            <PerformanceDashboard isOpen={isPerformanceOpen} onClose={() => setIsPerformanceOpen(false)} />\r\n            <SchedulerInspector isOpen={isSchedulerOpen} onClose={() => setIsSchedulerOpen(false)} />\r\n        </>\r\n    );\r\n};\r\n\r\nexport default DevToolsPanel;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\layouts\\components\\dev\\NetworkMonitor.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\layouts\\components\\dev\\PerformanceDashboard.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\layouts\\components\\dev\\PerformanceDashboard.tsx:19:13\n  17 |     useEffect(() => {\n  18 |         if (isOpen) {\n> 19 |             refreshMetrics();\n     |             ^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  20 |             // Auto-refresh every 2 seconds\n  21 |             const interval = setInterval(refreshMetrics, 2000);\n  22 |             return () => clearInterval(interval);","line":19,"column":13,"nodeType":null,"endLine":19,"endColumn":27}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { X, RefreshCw, Monitor, Database, Activity } from 'lucide-react';\r\nimport { getPerformanceSnapshot, PerformanceMetrics } from '../../../scripts/performanceTracker';\r\n\r\ninterface PerformanceDashboardProps {\r\n    isOpen: boolean;\r\n    onClose: () => void;\r\n}\r\n\r\nconst PerformanceDashboard: React.FC<PerformanceDashboardProps> = ({ isOpen, onClose }) => {\r\n    const [metrics, setMetrics] = useState<PerformanceMetrics | null>(null);\r\n\r\n    const refreshMetrics = () => {\r\n        setMetrics(getPerformanceSnapshot());\r\n    };\r\n\r\n    useEffect(() => {\r\n        if (isOpen) {\r\n            refreshMetrics();\r\n            // Auto-refresh every 2 seconds\r\n            const interval = setInterval(refreshMetrics, 2000);\r\n            return () => clearInterval(interval);\r\n        }\r\n    }, [isOpen]);\r\n\r\n    if (!isOpen || !metrics) return null;\r\n\r\n    const getScoreColor = (val: number, good: number, bad: number) => {\r\n        if (val <= good) return 'text-green-400';\r\n        if (val <= bad) return 'text-yellow-400';\r\n        return 'text-red-400';\r\n    };\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] flex items-center justify-center p-4\">\r\n            <div className=\"bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl w-full max-w-4xl max-h-[85vh] overflow-hidden flex flex-col\">\r\n                {/* Header */}\r\n                <div className=\"flex items-center justify-between p-4 border-b border-slate-800 bg-gradient-to-r from-emerald-900/20 to-teal-900/20\">\r\n                    <div className=\"flex items-center gap-3\">\r\n                        <div className=\"text-2xl\">‚ö°</div>\r\n                        <div>\r\n                            <h3 className=\"text-lg font-bold text-white\">Performance Dashboard</h3>\r\n                            <p className=\"text-xs text-slate-400\">Monitor de recursos y memoria</p>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"flex items-center gap-2\">\r\n                        <button\r\n                            onClick={refreshMetrics}\r\n                            className=\"p-2 hover:bg-slate-800 rounded-lg transition-colors text-slate-400 hover:text-white\"\r\n                            title=\"Actualizar\"\r\n                        >\r\n                            <RefreshCw className=\"w-4 h-4\" />\r\n                        </button>\r\n                        <button\r\n                            onClick={onClose}\r\n                            className=\"p-2 hover:bg-slate-800 rounded-lg transition-colors text-slate-400 hover:text-white\"\r\n                            title=\"Cerrar\"\r\n                        >\r\n                            <X className=\"w-4 h-4\" />\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Content */}\r\n                <div className=\"flex-1 overflow-y-auto p-6 space-y-6\">\r\n                    {/* Key Metrics Grid */}\r\n                    <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n                        {/* Memory */}\r\n                        <div className=\"bg-slate-800/50 p-4 rounded-xl border border-slate-700\">\r\n                            <h4 className=\"flex items-center gap-2 text-slate-400 text-sm mb-2\">\r\n                                <Database className=\"w-4 h-4\" /> Memoria JS (Heap)\r\n                            </h4>\r\n                            {metrics.memory ? (\r\n                                <div>\r\n                                    <div className=\"flex items-baseline gap-2\">\r\n                                        <span className=\"text-2xl font-bold text-white\">{metrics.memory.usedJSHeapSize}</span>\r\n                                        <span className=\"text-sm text-slate-500\">MB usados</span>\r\n                                    </div>\r\n                                    <div className=\"w-full bg-slate-700 h-1.5 rounded-full mt-2 overflow-hidden\">\r\n                                        <div\r\n                                            className=\"bg-purple-500 h-full transition-all duration-500\"\r\n                                            style={{ width: `${(metrics.memory.usedJSHeapSize / metrics.memory.totalJSHeapSize) * 100}%` }}\r\n                                        />\r\n                                    </div>\r\n                                    <p className=\"text-xs text-slate-500 mt-2\">\r\n                                        Total: {metrics.memory.totalJSHeapSize} MB (L√≠mite: {metrics.memory.jsHeapSizeLimit} MB)\r\n                                    </p>\r\n                                </div>\r\n                            ) : (\r\n                                <p className=\"text-sm text-slate-500 italic\">No disponible en este navegador</p>\r\n                            )}\r\n                        </div>\r\n\r\n                        {/* Load Time */}\r\n                        <div className=\"bg-slate-800/50 p-4 rounded-xl border border-slate-700\">\r\n                            <h4 className=\"flex items-center gap-2 text-slate-400 text-sm mb-2\">\r\n                                <Activity className=\"w-4 h-4\" /> Carga Inicial (Load)\r\n                            </h4>\r\n                            <div>\r\n                                <div className=\"flex items-baseline gap-2\">\r\n                                    <span className={`text-2xl font-bold ${getScoreColor(metrics.navigation.windowLoad, 1000, 2500)}`}>\r\n                                        {metrics.navigation.windowLoad}\r\n                                    </span>\r\n                                    <span className=\"text-sm text-slate-500\">ms</span>\r\n                                </div>\r\n                                <div className=\"flex justify-between text-xs mt-3\">\r\n                                    <div className=\"text-center\">\r\n                                        <span className=\"block text-slate-500\">TTFB</span>\r\n                                        <span className={`font-bold ${getScoreColor(metrics.navigation.ttfb, 200, 600)}`}>\r\n                                            {metrics.navigation.ttfb}ms\r\n                                        </span>\r\n                                    </div>\r\n                                    <div className=\"text-center\">\r\n                                        <span className=\"block text-slate-500\">DOM</span>\r\n                                        <span className={`font-bold ${getScoreColor(metrics.navigation.domLoad, 800, 2000)}`}>\r\n                                            {metrics.navigation.domLoad}ms\r\n                                        </span>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Assets Count */}\r\n                        <div className=\"bg-slate-800/50 p-4 rounded-xl border border-slate-700\">\r\n                            <h4 className=\"flex items-center gap-2 text-slate-400 text-sm mb-2\">\r\n                                <Monitor className=\"w-4 h-4\" /> Recursos Lentos\r\n                            </h4>\r\n                            <div>\r\n                                <div className=\"flex items-baseline gap-2\">\r\n                                    <span className=\"text-2xl font-bold text-white\">\r\n                                        {metrics.resources.filter(r => r.duration > 100).length}\r\n                                    </span>\r\n                                    <span className=\"text-sm text-slate-500\">requests {'>'} 100ms</span>\r\n                                </div>\r\n                                <p className=\"text-xs text-slate-500 mt-2\">\r\n                                    Top 20 recursos m√°s pesados analizados\r\n                                </p>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Slowest Resources Table */}\r\n                    <div className=\"bg-slate-800/30 rounded-xl border border-slate-700 overflow-hidden\">\r\n                        <div className=\"p-4 border-b border-slate-700 bg-slate-800/50\">\r\n                            <h4 className=\"font-bold text-white text-sm\">Recursos m√°s lentos (Top 10)</h4>\r\n                        </div>\r\n                        <div className=\"overflow-x-auto\">\r\n                            <table className=\"w-full text-left text-sm\">\r\n                                <thead className=\"text-xs text-slate-500 uppercase bg-slate-900/50\">\r\n                                    <tr>\r\n                                        <th className=\"px-4 py-3\">Nombre</th>\r\n                                        <th className=\"px-4 py-3\">Tipo</th>\r\n                                        <th className=\"px-4 py-3 text-right\">Tama√±o</th>\r\n                                        <th className=\"px-4 py-3 text-right\">Duraci√≥n</th>\r\n                                    </tr>\r\n                                </thead>\r\n                                <tbody className=\"divide-y divide-slate-800\">\r\n                                    {metrics.resources.slice(0, 10).map((resource, idx) => (\r\n                                        <tr key={idx} className=\"hover:bg-slate-800/50 transition-colors\">\r\n                                            <td className=\"px-4 py-2 font-mono text-xs text-slate-300 truncate max-w-[200px]\" title={resource.name}>\r\n                                                {resource.name}\r\n                                            </td>\r\n                                            <td className=\"px-4 py-2 text-slate-500 text-xs\">\r\n                                                {resource.type}\r\n                                            </td>\r\n                                            <td className=\"px-4 py-2 text-right text-slate-400 font-mono text-xs\">\r\n                                                {resource.size ? `${resource.size} KB` : '-'}\r\n                                            </td>\r\n                                            <td className={`px-4 py-2 text-right font-mono text-xs font-bold ${getScoreColor(resource.duration, 100, 500)}`}>\r\n                                                {resource.duration}ms\r\n                                            </td>\r\n                                        </tr>\r\n                                    ))}\r\n                                </tbody>\r\n                            </table>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default PerformanceDashboard;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\layouts\\components\\dev\\SchedulerInspector.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\layouts\\components\\dev\\SeedWeeks.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":59,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":59,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2165,2168],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2165,2168],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\r\nimport { useAuth } from '../../../context/AuthContext';\r\nimport { WeekService } from '../../../services/scheduler/weekService';\r\nimport { WeekData, toFranchiseId, toWeekId } from '../../../schemas/scheduler';\r\n\r\nconst SeedWeeks: React.FC = () => {\r\n    const { user } = useAuth();\r\n    const [status, setStatus] = useState('idle');\r\n\r\n    const handleSeed = async () => {\r\n        const franchiseId = user?.uid;\r\n        if (!franchiseId) {\r\n            setStatus('Error: No franchise ID');\r\n            return;\r\n        }\r\n\r\n        setStatus('Seeding...');\r\n\r\n        // 1. Define the 2025_42 sample data\r\n        const weekIdStr = \"2025_42\";\r\n        const sampleData: WeekData = {\r\n            id: weekIdStr,\r\n            startDate: \"2025-10-13\",\r\n            endDate: \"2025-10-19\",\r\n            status: \"published\",\r\n            metrics: {\r\n                totalHours: 140,\r\n                activeRiders: 12,\r\n                motosInUse: 8\r\n            },\r\n            shifts: [\r\n                {\r\n                    shiftId: \"uuid_generado_1\",\r\n                    id: \"uuid_generado_1\",\r\n                    riderId: \"rider_abc123\",\r\n                    riderName: \"Carlos Ruiz\",\r\n                    // Use ISO Strings strict format\r\n                    startAt: \"2025-10-13T19:00:00.000Z\",\r\n                    endAt: \"2025-10-13T23:00:00.000Z\",\r\n                    motoId: \"moto_zx99\",\r\n                    motoPlate: \"1234-XYZ\",\r\n                    notes: \"Turno seeding\"\r\n                },\r\n                {\r\n                    shiftId: \"uuid_generado_2\",\r\n                    id: \"uuid_generado_2\",\r\n                    riderId: \"rider_xyz789\",\r\n                    riderName: \"Ana G√≥mez\",\r\n                    startAt: \"2025-10-13T22:00:00.000Z\",\r\n                    endAt: \"2025-10-14T02:00:00.000Z\",\r\n                    notes: \"Turno cross-midnight\"\r\n                }\r\n            ]\r\n        };\r\n\r\n        try {\r\n            await WeekService.saveWeek(toFranchiseId(franchiseId), toWeekId(weekIdStr), sampleData);\r\n            setStatus(`Success! Week ${weekIdStr} seeded.`);\r\n        } catch (e: any) {\r\n            console.error(e);\r\n            setStatus('Error: ' + e.message);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"p-4 bg-slate-800 rounded-xl border border-slate-700 my-4\">\r\n            <h3 className=\"text-white font-bold mb-2\">Dev Tools: Seeder</h3>\r\n            <button\r\n                onClick={handleSeed}\r\n                className=\"px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-500 transition-colors\"\r\n            >\r\n                Inyectar Semana 2025_42\r\n            </button>\r\n            <p className=\"text-slate-400 mt-2 text-sm\">{status}</p>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default SeedWeeks;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\layouts\\components\\dev\\ToastContainer.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":102,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":102,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState } from 'react';\r\nimport { CheckCircle, XCircle, AlertTriangle, Info, X } from 'lucide-react';\r\n\r\nexport type ToastType = 'success' | 'error' | 'warning' | 'info';\r\n\r\nexport interface Toast {\r\n    id: string;\r\n    type: ToastType;\r\n    title: string;\r\n    message?: string;\r\n    duration?: number;\r\n}\r\n\r\ninterface ToastContainerProps {\r\n    toasts: Toast[];\r\n    onDismiss: (id: string) => void;\r\n}\r\n\r\nconst ToastContainer: React.FC<ToastContainerProps> = ({ toasts, onDismiss }) => {\r\n    return (\r\n        <div className=\"fixed bottom-4 right-4 z-[9999] space-y-2 pointer-events-none\">\r\n            {toasts.map(toast => (\r\n                <ToastItem key={toast.id} toast={toast} onDismiss={onDismiss} />\r\n            ))}\r\n        </div>\r\n    );\r\n};\r\n\r\ninterface ToastItemProps {\r\n    toast: Toast;\r\n    onDismiss: (id: string) => void;\r\n}\r\n\r\nconst ToastItem: React.FC<ToastItemProps> = ({ toast, onDismiss }) => {\r\n    const [isExiting, setIsExiting] = useState(false);\r\n\r\n    useEffect(() => {\r\n        const duration = toast.duration || 4000;\r\n\r\n        const exitTimer = setTimeout(() => {\r\n            setIsExiting(true);\r\n        }, duration - 300);\r\n\r\n        const dismissTimer = setTimeout(() => {\r\n            onDismiss(toast.id);\r\n        }, duration);\r\n\r\n        return () => {\r\n            clearTimeout(exitTimer);\r\n            clearTimeout(dismissTimer);\r\n        };\r\n    }, [toast, onDismiss]);\r\n\r\n    const iconMap = {\r\n        success: <CheckCircle className=\"w-5 h-5 text-green-400\" />,\r\n        error: <XCircle className=\"w-5 h-5 text-red-400\" />,\r\n        warning: <AlertTriangle className=\"w-5 h-5 text-amber-400\" />,\r\n        info: <Info className=\"w-5 h-5 text-blue-400\" />\r\n    };\r\n\r\n    const colorMap = {\r\n        success: 'bg-green-500/10 border-green-500/30',\r\n        error: 'bg-red-500/10 border-red-500/30',\r\n        warning: 'bg-amber-500/10 border-amber-500/30',\r\n        info: 'bg-blue-500/10 border-blue-500/30'\r\n    };\r\n\r\n    return (\r\n        <div\r\n            className={`\r\n                pointer-events-auto\r\n                bg-slate-900 border rounded-lg shadow-2xl p-4 min-w-[300px] max-w-md\r\n                transition-all duration-300 transform\r\n                ${isExiting ? 'opacity-0 translate-x-full' : 'opacity-100 translate-x-0'}\r\n                ${colorMap[toast.type]}\r\n            `}\r\n        >\r\n            <div className=\"flex items-start gap-3\">\r\n                <div className=\"flex-shrink-0 mt-0.5\">\r\n                    {iconMap[toast.type]}\r\n                </div>\r\n                <div className=\"flex-1 min-w-0\">\r\n                    <p className=\"text-sm font-semibold text-white\">{toast.title}</p>\r\n                    {toast.message && (\r\n                        <p className=\"text-xs text-slate-400 mt-1\">{toast.message}</p>\r\n                    )}\r\n                </div>\r\n                <button\r\n                    onClick={() => onDismiss(toast.id)}\r\n                    className=\"flex-shrink-0 p-1 hover:bg-white/10 rounded transition-colors\"\r\n                >\r\n                    <X className=\"w-4 h-4 text-slate-400\" />\r\n                </button>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default ToastContainer;\r\n\r\n// Hook para usar el sistema de toasts\r\nexport function useToast() {\r\n    const [toasts, setToasts] = useState<Toast[]>([]);\r\n\r\n    const showToast = (toast: Omit<Toast, 'id'>) => {\r\n        const id = Math.random().toString(36).substr(2, 9);\r\n        setToasts(prev => [...prev, { ...toast, id }]);\r\n    };\r\n\r\n    const dismissToast = (id: string) => {\r\n        setToasts(prev => prev.filter(t => t.id !== id));\r\n    };\r\n\r\n    return {\r\n        toasts,\r\n        showToast,\r\n        dismissToast,\r\n        success: (title: string, message?: string) =>\r\n            showToast({ type: 'success', title, message }),\r\n        error: (title: string, message?: string) =>\r\n            showToast({ type: 'error', title, message }),\r\n        warning: (title: string, message?: string) =>\r\n            showToast({ type: 'warning', title, message }),\r\n        info: (title: string, message?: string) =>\r\n            showToast({ type: 'info', title, message })\r\n    };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\layouts\\pages\\NotFound.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\lib\\aggregator.ts","messages":[{"ruleId":"prefer-const","severity":2,"message":"'totalVariable' is never reassigned. Use 'const' instead.","line":118,"column":9,"nodeType":"Identifier","messageId":"useConst","endLine":118,"endColumn":22,"fix":{"range":[3833,3889],"text":"const totalVariable = totalExpenses - totalFixedLineItems;"}},{"ruleId":"prefer-const","severity":2,"message":"'variableCostPerOrder' is never reassigned. Use 'const' instead.","line":119,"column":9,"nodeType":"Identifier","messageId":"useConst","endLine":119,"endColumn":29,"fix":{"range":[3895,3972],"text":"const variableCostPerOrder = totalOrders > 0 ? totalVariable / totalOrders : 0;"}},{"ruleId":"prefer-const","severity":2,"message":"'contributionMargin' is never reassigned. Use 'const' instead.","line":120,"column":9,"nodeType":"Identifier","messageId":"useConst","endLine":120,"endColumn":27,"fix":{"range":[3978,4036],"text":"const contributionMargin = avgTicket - variableCostPerOrder;"}}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":3,"fixableWarningCount":0,"source":"// Basic interfaces for Aggregation\r\n// These usually should be imported from types/finance.ts but defining here/compatible logic for now\r\n\r\ninterface BreakdownItem {\r\n    name: string;\r\n    value: number;\r\n    type?: string;\r\n    // ...\r\n}\r\n\r\ninterface FinancialReport {\r\n    revenue: number;\r\n    orders: number;\r\n    profit: number;\r\n    expenses: number;\r\n    taxes: {\r\n        ivaRepercutido: number;\r\n        ivaSoportado: number;\r\n        ivaAPagar: number;\r\n        irpfPago: number;\r\n        netProfitPostTax: number;\r\n        irpfPercent?: number;\r\n    };\r\n    metrics: {\r\n        totalKm: number;\r\n        revenuePerHour: number;\r\n        productivity: number;\r\n        marketingSpend: number;\r\n        incidentCost: number;\r\n        [key: string]: number;\r\n    };\r\n    breakdown: BreakdownItem[];\r\n}\r\n\r\nexport const aggregateReports = (reports: FinancialReport[]) => {\r\n    if (!reports || reports.length === 0) return null;\r\n\r\n    let totalRevenue = 0;\r\n    let totalOrders = 0;\r\n    let totalNetProfit = 0;\r\n    let totalExpenses = 0;\r\n\r\n    // Taxes\r\n    let totalIvaRepercutido = 0;\r\n    let totalIvaSoportado = 0;\r\n    let totalIvaAPagar = 0;\r\n    let totalIrpfPago = 0;\r\n    let totalNetProfitPostTax = 0;\r\n\r\n    // Power Metrics / Logistics Sums help\r\n    let totalKm = 0;\r\n    let totalHours = 0;\r\n\r\n    let totalMarketing = 0;\r\n    let totalIncidents = 0;\r\n\r\n    // Breakdown map\r\n    const breakdownMap: Record<string, BreakdownItem> = {};\r\n\r\n    reports.forEach(r => {\r\n        if (!r) return;\r\n        totalRevenue += r.revenue || 0;\r\n        totalOrders += r.orders || 0;\r\n        totalNetProfit += r.profit || 0;\r\n        totalExpenses += r.expenses || 0;\r\n\r\n        totalIvaRepercutido += r.taxes.ivaRepercutido || 0;\r\n        totalIvaSoportado += r.taxes.ivaSoportado || 0;\r\n        totalIvaAPagar += r.taxes.ivaAPagar || 0;\r\n        totalIrpfPago += r.taxes.irpfPago || 0;\r\n        totalNetProfitPostTax += r.taxes.netProfitPostTax || 0;\r\n\r\n        // Metrics sums\r\n        totalKm += r.metrics.totalKm || 0;\r\n        // Approximation of hours if not present explicitly\r\n        if (r.metrics.revenuePerHour > 0) {\r\n            totalHours += (r.revenue / r.metrics.revenuePerHour);\r\n        } else if (r.metrics.productivity > 0 && r.orders > 0) {\r\n            totalHours += (r.orders / r.metrics.productivity);\r\n        }\r\n\r\n        totalMarketing += r.metrics.marketingSpend || 0;\r\n        totalIncidents += r.metrics.incidentCost || 0;\r\n\r\n        // Sum Breakdown\r\n        r.breakdown.forEach(item => {\r\n            if (!breakdownMap[item.name]) {\r\n                breakdownMap[item.name] = { ...item, value: 0 };\r\n            }\r\n            breakdownMap[item.name].value += item.value;\r\n        });\r\n    });\r\n\r\n    // Recalculate Average Metrics\r\n    const avgTicket = totalOrders > 0 ? totalRevenue / totalOrders : 0;\r\n    const costPerOrder = totalOrders > 0 ? totalExpenses / totalOrders : 0;\r\n    const profitMargin = totalRevenue > 0 ? (totalNetProfit / totalRevenue) * 100 : 0;\r\n\r\n    // Logistics\r\n    const revenuePerKm = totalKm > 0 ? totalRevenue / totalKm : 0;\r\n    const costPerKm = totalKm > 0 ? totalExpenses / totalKm : 0;\r\n    const dropDensity = totalKm > 0 ? (totalOrders / totalKm) * 100 : 0;\r\n\r\n    // Power\r\n    const laborRatio = totalRevenue > 0 ? ((breakdownMap['Salarios']?.value || 0) / totalRevenue) * 100 : 0;\r\n    const incidentRatio = totalRevenue > 0 ? (totalIncidents / totalRevenue) * 100 : 0;\r\n\r\n    // Safety Margin (Re-calc based on aggregated Fixed Costs)\r\n    let totalFixedLineItems = 0;\r\n    Object.values(breakdownMap).forEach(item => {\r\n        if (item.type === 'fixed') totalFixedLineItems += item.value;\r\n    });\r\n\r\n    // Break-even orders\r\n    let breakEvenOrders: number | \"N/A\" = \"N/A\";\r\n    let safetyMargin = 0;\r\n    // Variable Cost per Order\r\n    let totalVariable = totalExpenses - totalFixedLineItems;\r\n    let variableCostPerOrder = totalOrders > 0 ? totalVariable / totalOrders : 0;\r\n    let contributionMargin = avgTicket - variableCostPerOrder;\r\n\r\n    if (contributionMargin > 0) {\r\n        breakEvenOrders = Math.ceil(totalFixedLineItems / contributionMargin);\r\n        if (typeof breakEvenOrders === 'number' && totalOrders > 0) {\r\n            safetyMargin = ((totalOrders - breakEvenOrders) / totalOrders) * 100;\r\n        }\r\n    }\r\n\r\n    return {\r\n        revenue: totalRevenue,\r\n        orders: totalOrders,\r\n        profit: totalNetProfit,\r\n        expenses: totalExpenses,\r\n        taxes: {\r\n            ivaRepercutido: totalIvaRepercutido,\r\n            ivaSoportado: totalIvaSoportado,\r\n            ivaAPagar: totalIvaAPagar,\r\n            irpfPago: totalIrpfPago,\r\n            netProfitPostTax: totalNetProfitPostTax,\r\n            irpfPercent: 20 // Dummy for aggregate\r\n        },\r\n        metrics: {\r\n            avgTicket,\r\n            costPerOrder,\r\n            breakEvenOrders,\r\n            profitMargin,\r\n            activeRiders: 0, // Not easily aggregatable without fetching inputs\r\n            productivity: totalHours > 0 ? totalOrders / totalHours : 0,\r\n            revenuePerHour: totalHours > 0 ? totalRevenue / totalHours : 0,\r\n            costPerHour: totalHours > 0 ? totalExpenses / totalHours : 0,\r\n            totalKm,\r\n            revenuePerKm,\r\n            costPerKm,\r\n            dropDensity,\r\n            safetyMargin,\r\n            laborRatio,\r\n            incidentRatio,\r\n            marketingSpend: totalMarketing,\r\n            incidentCost: totalIncidents\r\n        },\r\n        breakdown: Object.values(breakdownMap).sort((a, b) => b.value - a.value)\r\n    };\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\lib\\appCapabilities.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\lib\\audit.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":71,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":71,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2254,2257],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2254,2257],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":89,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":89,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2965,2968],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2965,2968],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { db } from './firebase';\r\nimport { collection, addDoc, serverTimestamp } from 'firebase/firestore';\r\n\r\nexport const AUDIT_ACTIONS = {\r\n    // Auth\r\n    LOGIN_SUCCESS: 'LOGIN_SUCCESS',\r\n    LOGOUT: 'LOGOUT',\r\n    PASSWORD_CHANGED: 'PASSWORD_CHANGED', // üîê Cambio de contrase√±a\r\n    PASSWORD_RESET_REQ: 'PASSWORD_RESET_REQ', // üì© Solicitud de mail recuperaci√≥n\r\n\r\n    // User Mgmt\r\n    USER_APPROVED: 'USER_APPROVED',\r\n    USER_REVOKED: 'USER_REVOKED',\r\n    USER_ROLE_UPDATED: 'USER_ROLE_UPDATED',\r\n    CREATE_USER: 'CREATE_USER',\r\n    UPDATE_USER: 'UPDATE_USER',\r\n    DELETE_USER: 'DELETE_USER',\r\n\r\n    // Support\r\n    TICKET_CREATED: 'TICKET_CREATED',\r\n    TICKET_REPLIED: 'TICKET_REPLIED',\r\n    TICKET_RESOLVED: 'TICKET_RESOLVED',\r\n    TICKET_UPDATE: 'TICKET_UPDATE',\r\n    TICKET_NOTE: 'TICKET_NOTE',\r\n\r\n    // Financials\r\n    MONTHLY_DATA_EDITED: 'MONTHLY_DATA_EDITED',\r\n\r\n    // System\r\n    SYSTEM_EVENT: 'SYSTEM_EVENT',\r\n    SYSTEM_ERROR: 'SYSTEM_ERROR',\r\n    CLIENT_CRASH: 'CLIENT_CRASH'\r\n} as const;\r\n\r\nexport type AuditActionType = keyof typeof AUDIT_ACTIONS | string;\r\n\r\nexport interface LogDetails {\r\n    [key: string]: unknown;\r\n}\r\n\r\ninterface AuditUser {\r\n    uid?: string;\r\n    email?: string | null;\r\n    role?: string;\r\n}\r\n\r\n/**\r\n * Logs a critical action to the 'audit_logs' collection.\r\n * \r\n * @param {object} user - The user performing the action (should have uid, email, role).\r\n * @param {string} action - CONSTANT_CASE action name (e.g., 'USER_LOGIN', 'TICKET_RESOLVED').\r\n * @param {object} details - Additional context (e.g., targetUserId, ticketId, changes).\r\n */\r\nexport const logAction = async (user: AuditUser | null, action: AuditActionType, details: LogDetails = {}): Promise<void> => {\r\n    try {\r\n        if (!user || !user.uid) {\r\n            console.warn(\"Audit: No user provided for action\", action);\r\n            return;\r\n        }\r\n\r\n        await addDoc(collection(db, \"audit_logs\"), {\r\n            timestamp: serverTimestamp(),\r\n            actorId: user.uid,\r\n            actorEmail: user.email || 'unknown',\r\n            actorRole: user.role || 'unknown',\r\n            action: action,\r\n            details: details,\r\n            userAgent: navigator.userAgent\r\n        });\r\n\r\n        if ((import.meta as any).env?.DEV) {\r\n            console.log(`Audit: [${action}] logged successfully.`);\r\n        }\r\n    } catch (error) {\r\n        console.error(\"Audit Critical Error: Failed to log action\", action, error);\r\n\r\n        // SECURITY HARDENING: Block critical actions if audit fails\r\n        const CRITICAL_ACTIONS = [\r\n            AUDIT_ACTIONS.LOGIN_SUCCESS,\r\n            AUDIT_ACTIONS.USER_APPROVED,\r\n            AUDIT_ACTIONS.USER_REVOKED,\r\n            AUDIT_ACTIONS.USER_ROLE_UPDATED,\r\n            AUDIT_ACTIONS.CREATE_USER,\r\n            AUDIT_ACTIONS.UPDATE_USER,\r\n            AUDIT_ACTIONS.DELETE_USER,\r\n            AUDIT_ACTIONS.PASSWORD_CHANGED\r\n        ];\r\n\r\n        if (CRITICAL_ACTIONS.includes(action as any)) {\r\n            throw new Error(`CRITICAL SECURITY: Action ${action} blocked because audit log failed.`);\r\n        }\r\n    }\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\lib\\certificate.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\lib\\companyKnowledge.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\lib\\constants.d.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\lib\\constants.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\lib\\email.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":24,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":24,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[845,848],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[845,848],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import emailjs from '@emailjs/browser';\r\n\r\n// CONFIGURATION\r\nconst EMAILJS_SERVICE_ID = import.meta.env.VITE_EMAILJS_SERVICE_ID;\r\nconst EMAILJS_TEMPLATE_NEW_TICKET = import.meta.env.VITE_EMAILJS_TEMPLATE_NEW_TICKET;\r\nconst EMAILJS_TEMPLATE_REPLY = import.meta.env.VITE_EMAILJS_TEMPLATE_REPLY;\r\nconst EMAILJS_PUBLIC_KEY = import.meta.env.VITE_EMAILJS_PUBLIC_KEY;\r\n\r\nexport const initEmailSystem = (): void => {\r\n    try {\r\n        if (EMAILJS_PUBLIC_KEY) {\r\n            emailjs.init(EMAILJS_PUBLIC_KEY);\r\n        } else {\r\n            console.warn(\"EmailJS Public Key not found in env vars\");\r\n        }\r\n    } catch (error) {\r\n        console.warn(\"Simluated email error (ignored):\", error);\r\n    }\r\n};\r\n\r\n/**\r\n * Sends an email to Admin (hola@repaart.es) when a new ticket is created.\r\n */\r\nexport const sendTicketCreatedEmail = async (ticket: any): Promise<boolean> => {\r\n    // In a real scenario, you map these params to your EmailJS Template variables\r\n    const templateParams = {\r\n        to_email: 'hola@repaart.es',\r\n        from_name: ticket.email, // Franchisee Name/Email\r\n        subject: ticket.subject,\r\n        message: ticket.message,\r\n        urgency: ticket.urgency,\r\n        ticket_id: ticket.id || 'N/A',\r\n        ticket_link: `${window.location.origin}/admin?ticketId=${ticket.id}` // Link to admin panel\r\n    };\r\n\r\n    try {\r\n        // NOTE: We only attempt to send if key is not the placeholder to avoid errors in dev\r\n        if (EMAILJS_PUBLIC_KEY === 'YOUR_PUBLIC_KEY') {\r\n            if (import.meta.env.DEV) {\r\n                console.log(\"Mocking Email Send (Keys not set):\", templateParams);\r\n            }\r\n            return true;\r\n        }\r\n        const response = await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_NEW_TICKET, templateParams);\r\n        if (import.meta.env.DEV) {\r\n            console.log(\"Email enviado con √©xito!\", response.status, response.text);\r\n        }\r\n        return true;\r\n    } catch (error) {\r\n        console.error(\"Failed to send email:\", error);\r\n        return false;\r\n    }\r\n};\r\n\r\n/**\r\n * Sends an email to the Franchisee when Admin replies.\r\n */\r\nexport const sendTicketReplyEmail = async (toEmail: string, _subject: string, replyMessage: string, originalMessage: string, ticketId: string): Promise<boolean> => {\r\n    const templateParams = {\r\n        to_email: toEmail,\r\n        reply_message: replyMessage,\r\n        original_message: originalMessage,\r\n        ticket_id: ticketId,\r\n        ticket_link: `${window.location.origin}/support?ticketId=${ticketId}` // Link to user portal\r\n    };\r\n\r\n    try {\r\n        if (EMAILJS_PUBLIC_KEY === 'YOUR_PUBLIC_KEY') {\r\n            if (import.meta.env.DEV) {\r\n                console.log(\"Mocking Reply Send (Keys not set):\", templateParams);\r\n            }\r\n            return true;\r\n        }\r\n        await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_REPLY, templateParams);\r\n        return true;\r\n    } catch (error) {\r\n        console.error(\"Failed to send reply:\", error);\r\n        return false;\r\n    }\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\lib\\finance.test.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":87,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":87,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3332,3335],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3332,3335],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { describe, it, expect } from 'vitest';\r\nimport {\r\n    calculateExpenses,\r\n    formatMoney,\r\n    calculateRevenue,\r\n    DEFAULT_MONTH_DATA\r\n} from './finance';\r\n\r\ndescribe('Financial Core Audit (Blinding Logic)', () => {\r\n\r\n    describe('Case A: Absolute Zero (Inactivity)', () => {\r\n        it('should yield zero profit and zero expenses when everything is zero', () => {\r\n            const report = calculateExpenses(0, 0, DEFAULT_MONTH_DATA);\r\n\r\n            expect(report.totalExpenses).toBe(0);\r\n            expect(report.netProfit).toBe(0);\r\n            expect(report.taxes.irpfPago).toBe(0);\r\n            expect(report.taxes.ivaAPagar).toBe(0);\r\n            expect(report.taxes.netProfitPostTax).toBe(0);\r\n        });\r\n    });\r\n\r\n    describe('Case B: Real-World Scenario (10k Revenue)', () => {\r\n        /**\r\n         * Manual Calculation:\r\n         * Revenue: 10,000\r\n         * Expenses (Salaries): 5,000\r\n         * Royalty (5% of 10,000): 500\r\n         * Total Expenses: 5,500\r\n         * Net Profit (Pre-tax): 4,500\r\n         * IRPF (20% of 4,500): 900\r\n         * Net Profit (Post-Tax): 3,600\r\n         */\r\n        it('should calculate net profit accurately for a 10k revenue / 5k salary case (with royalties)', () => {\r\n            const inputs = {\r\n                ...DEFAULT_MONTH_DATA,\r\n                salaries: 5000,\r\n                irpfPercent: 20\r\n            };\r\n\r\n            const report = calculateExpenses(10000, 0, inputs);\r\n\r\n            expect(report.totalExpenses).toBe(5500);\r\n            expect(report.netProfit).toBe(4500);\r\n            expect(report.taxes.irpfPago).toBe(900);\r\n            expect(report.taxes.netProfitPostTax).toBe(3600);\r\n        });\r\n    });\r\n\r\n    describe('Case C: Decimal Precision (Floating Point Safety)', () => {\r\n        it('should handle typical floating point issues (0.1 + 0.2) correctly', () => {\r\n            const inputs = {\r\n                ...DEFAULT_MONTH_DATA,\r\n                salaries: 10.1,\r\n                marketing: 20.2,\r\n                royaltyPercent: 0\r\n            };\r\n\r\n            const report = calculateExpenses(100, 0, inputs);\r\n\r\n            // 10.1 (salaries) + 20.2 (marketing) = 30.3\r\n            // Net Profit: 100 - 30.3 = 69.7\r\n            expect(report.totalExpenses).toBeCloseTo(30.3, 5);\r\n            expect(report.netProfit).toBeCloseTo(69.7, 5);\r\n        });\r\n    });\r\n\r\n    describe('Case D: Formatting (es-ES Compliance)', () => {\r\n        const normalize = (s: string) => s.replace(/\\u00a0/g, ' ').replace(/\\u2212/g, '-');\r\n\r\n        it('should format thousands and decimals correctly according to Spanish standards', () => {\r\n            expect(normalize(formatMoney(1000.5))).toBe('1.000,50');\r\n            expect(normalize(formatMoney(1234567.89))).toBe('1.234.567,89');\r\n            expect(normalize(formatMoney(0))).toBe('0,00');\r\n        });\r\n\r\n        it('should handle negative numbers in Spanish format', () => {\r\n            expect(normalize(formatMoney(-500))).toBe('-500,00');\r\n        });\r\n    });\r\n\r\n    describe('Edge Cases: Reliability', () => {\r\n        it('should handle null or undefined inputs gracefully by returning 0', () => {\r\n            expect(formatMoney(null)).toBe('0,00');\r\n            expect(formatMoney(undefined)).toBe('0,00');\r\n\r\n            const revenue = calculateRevenue('invalid' as any);\r\n            expect(revenue).toBe(0);\r\n        });\r\n\r\n        it('should cap productivity calculation to avoid Infinity when hours are zero', () => {\r\n            const report = calculateExpenses(100, 10, { ...DEFAULT_MONTH_DATA, totalHours: 0 });\r\n            expect(report.metrics.productivity).toBe(0);\r\n            expect(isFinite(report.metrics.revenuePerHour)).toBe(true);\r\n        });\r\n    });\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\lib\\finance.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":304,"column":90,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":304,"endColumn":93,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7847,7850],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7847,7850],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":358,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":358,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9744,9747],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9744,9747],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":395,"column":97,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":395,"endColumn":100,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11552,11555],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11552,11555],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// =====================================================\r\n// TYPES & INTERFACES\r\n// =====================================================\r\n\r\nexport type TariffType = 'NEW' | 'OLD';\r\n\r\nexport interface TariffConfig {\r\n    NEW: {\r\n        '0-4': number;\r\n        '4-5': number;\r\n        '5-6': number;\r\n        '6-7': number;\r\n        '>7': number;\r\n    };\r\n    OLD: {\r\n        '0-3.5': number;\r\n        '>3.5': number;\r\n    };\r\n}\r\n\r\nexport interface MonthlyData {\r\n    revenue?: number;\r\n    orders?: number;\r\n    ordersNew0To4?: number;\r\n    ordersNew4To5?: number;\r\n    ordersNew5To6?: number;\r\n    ordersNew6To7?: number;\r\n    ordersNewGt7?: number;\r\n    ordersOld0To35?: number;\r\n    ordersOldGt35?: number;\r\n    contractedRiders?: number;\r\n    totalHours?: number;\r\n    totalKm?: number;\r\n    motoCount?: number;\r\n    salaries?: number;\r\n    insurance?: number;\r\n    services?: number;\r\n    agencyFee?: number;\r\n    prlFee?: number;\r\n    accountingFee?: number;\r\n    gasoline?: number;\r\n    gasolinePrice?: number;\r\n    repairs?: number;\r\n    marketing?: number;\r\n    incidents?: number;\r\n    otherExpenses?: number;\r\n    appFlyder?: number; // Manual override for franchise fee\r\n    quota?: number;\r\n    royaltyPercent?: number;\r\n    irpfPercent?: number;\r\n    // Operational Metrics\r\n    totalOperationalHours?: number;\r\n    totalShiftsCount?: number;\r\n    // Explicit Aggregates\r\n    totalIncome?: number;\r\n    totalExpenses?: number;\r\n    expenses?: number;\r\n    grossIncome?: number;\r\n    profit?: number;\r\n    // Status Fields\r\n    status?: 'pending' | 'draft' | 'submitted' | 'approved' | 'locked' | 'unlock_requested';\r\n    is_locked?: boolean;\r\n    breakdown?: Record<string, number>;\r\n}\r\n\r\nexport interface BreakdownItem {\r\n    name: string;\r\n    value: number;\r\n    type: 'fixed' | 'variable';\r\n}\r\n\r\nexport interface TaxInfo {\r\n    ivaRepercutido: number;\r\n    ivaSoportado: number;\r\n    ivaAPagar: number;\r\n    irpfPercent?: number;  // Made optional to match ExpenseData\r\n    irpfPago: number;\r\n    netProfitPostTax: number;\r\n    // UI Helpers (Legacy compatibility)\r\n    netProfit: number;\r\n    margin: number;\r\n    totalReserve: number;\r\n    vat: {\r\n        toPay: number;\r\n    };\r\n}\r\n\r\nexport interface Metrics {\r\n    avgTicket: number;\r\n    costPerOrder: number;\r\n    breakEvenOrders: number | 'N/A';\r\n    profitMargin: number;\r\n    activeRiders: number;\r\n    productivity: number;\r\n    revenuePerHour: number;\r\n    costPerHour: number;\r\n    profitPerRider: number;\r\n    totalKm: number;\r\n    revenuePerKm: number;\r\n    costPerKm: number;\r\n    dropDensity: number;\r\n    safetyMargin: number;\r\n    laborRatio: number;\r\n    incidentRatio: number;\r\n    marketingSpend: number;\r\n    incidentCost: number;\r\n}\r\n\r\nexport interface FinancialReport {\r\n    fixed: {\r\n        salaries: number;\r\n        renting: number;\r\n        insurance: number;\r\n        services: number;\r\n        quota: number;\r\n        other: number;\r\n        total: number;\r\n    };\r\n    variable: {\r\n        gasoline: number;\r\n        repairs: number;\r\n        flyderFee: number;\r\n        royalty: number;\r\n        total: number;\r\n    };\r\n    totalExpenses: number;\r\n    netProfit: number;\r\n    taxes: TaxInfo;\r\n    metrics: Metrics;\r\n    breakdown: BreakdownItem[];\r\n    // Legacy support fields (for ViewSwitcher)\r\n    revenue?: number;\r\n    orders?: number;\r\n}\r\n\r\nexport interface FinancialAlert {\r\n    id: string;\r\n    type: 'PROFIT' | 'COSTS';\r\n    severity: 'critical' | 'warning';\r\n    title: string;\r\n    value: string;\r\n    target: string;\r\n    gapValue?: number;\r\n    expenseName?: string;\r\n    description: string;\r\n    details: {\r\n        diagnosis: string;\r\n        impact: string;\r\n        breakdown?: Array<{\r\n            label: string;\r\n            value: number;\r\n            percentage: number;\r\n        }>;\r\n        actions: Array<{\r\n            title: string;\r\n            desc: string;\r\n        }>;\r\n    };\r\n}\r\n\r\nexport interface FinancialAnalysis {\r\n    kpi: {\r\n        revenue: number;\r\n        expenses: number;\r\n        margin: number;\r\n        status: 'healthy' | 'warning' | 'critical';\r\n    };\r\n    alerts: FinancialAlert[];\r\n}\r\n\r\n// Normalized expense for analysis\r\ninterface NormalizedExpense {\r\n    amount: number;\r\n    category: string;\r\n}\r\n\r\n// Input expense (flexible format)\r\nexport interface ExpenseInput {\r\n    amount?: number;\r\n    value?: number;\r\n    cost?: number;\r\n    category?: string;\r\n    name?: string;\r\n}\r\n\r\n// =====================================================\r\n// CONSTANTS\r\n// =====================================================\r\n\r\nexport const TARIFFS: TariffConfig = {\r\n    NEW: {\r\n        '0-4': 5.50,\r\n        '4-5': 6.50,\r\n        '5-6': 7.50,\r\n        '6-7': 8.50,\r\n        '>7': 8.50\r\n    },\r\n    OLD: {\r\n        '0-3.5': 5.50,\r\n        '>3.5': 7.50\r\n    }\r\n};\r\n\r\nexport const DEFAULT_MONTH_DATA: MonthlyData = {\r\n    revenue: 0,\r\n    orders: 0,\r\n    ordersNew0To4: 0,\r\n    ordersNew4To5: 0,\r\n    ordersNew5To6: 0,\r\n    ordersNew6To7: 0,\r\n    ordersNewGt7: 0,\r\n    ordersOld0To35: 0,\r\n    ordersOldGt35: 0,\r\n    contractedRiders: 0,\r\n    totalHours: 0,\r\n    motoCount: 0,\r\n    salaries: 0,\r\n    insurance: 0,\r\n    services: 0,\r\n    agencyFee: 0,\r\n    prlFee: 0,\r\n    accountingFee: 0,\r\n    gasoline: 0,\r\n    gasolinePrice: 0,\r\n    repairs: 0,\r\n    marketing: 0,\r\n    incidents: 0,\r\n    otherExpenses: 0,\r\n    quota: 0,\r\n    royaltyPercent: 5,\r\n    irpfPercent: 20\r\n};\r\n\r\nconst THRESHOLDS = {\r\n    MARGIN_WARNING: 15.0, // %\r\n    MARGIN_CRITICAL: 5.0, // %\r\n    COST_CONCENTRATION_RISK: 0.35, // 35%\r\n} as const;\r\n\r\n// =====================================================\r\n// UTILITY FUNCTIONS\r\n// =====================================================\r\n\r\n/**\r\n * Safely parses a value to float, handling nulls, undefined, and Spanish comma decimals.\r\n */\r\nconst safeFloat = (val: string | number | null | undefined): number => {\r\n    if (val === null || val === undefined) return 0;\r\n    if (typeof val === 'number') return val;\r\n\r\n    // Handle Spanish format (1.234,56 -> 1234.56 or 12,56 -> 12.56)\r\n    let strVal = String(val).trim();\r\n    if (strVal === '') return 0;\r\n\r\n    // Replace comma with dot after removing possible thousand dots\r\n    strVal = strVal.replace(/\\./g, '').replace(',', '.');\r\n\r\n    const parsed = parseFloat(strVal);\r\n    if (isNaN(parsed)) return 0;\r\n    return parsed;\r\n};\r\n\r\n// =====================================================\r\n// EXPORTED FUNCTIONS\r\n// =====================================================\r\n\r\n/**\r\n * Calculates raw revenue based on distance and tariff rules.\r\n */\r\nexport const calculateRevenue = (\r\n    distance: number | string,\r\n    tariffType: TariffType = 'NEW',\r\n    tariffs: TariffConfig = TARIFFS\r\n): number => {\r\n    const dist = parseFloat(String(distance));\r\n    if (isNaN(dist) || dist < 0) return 0;\r\n\r\n    const RULES = tariffs || TARIFFS;\r\n\r\n    if (tariffType === 'NEW') {\r\n        if (dist <= 4) return RULES.NEW?.['0-4'] || 0;\r\n        if (dist <= 5) return RULES.NEW?.['4-5'] || 0;\r\n        if (dist <= 6) return RULES.NEW?.['5-6'] || 0;\r\n        if (dist <= 7) return RULES.NEW?.['6-7'] || 0;\r\n        return RULES.NEW?.['>7'] || 0;\r\n    } else if (tariffType === 'OLD') {\r\n        if (dist <= 3.5) return RULES.OLD?.['0-3.5'] || 0;\r\n        return RULES.OLD?.['>3.5'] || 0;\r\n    }\r\n    return 0;\r\n};\r\n\r\n/**\r\n * Helper to calculate total revenue from a monthly data object (Firestore)\r\n */\r\nexport const calculateMonthlyRevenue = (\r\n    data: MonthlyData | null | undefined,\r\n    tariffs: TariffConfig = TARIFFS\r\n): number => {\r\n    if (!data) return 0;\r\n\r\n    // 1. Prefer explicit stored revenue (Source of Truth from Manual Entry)\r\n    // SUPPORT LEGACY/NESTED DATA: Check data.revenue, data.totalIncome, OR data.summary.grossIncome\r\n    const storedRevenue = parseFloat(String(data.revenue || data.totalIncome || (data as any).summary?.grossIncome || 0));\r\n    if (storedRevenue > 0) return storedRevenue;\r\n\r\n    // 2. Fallback to calculation from orders (Legacy / Logistics only)\r\n    const r = (d: number | undefined) => parseFloat(String(d)) || 0;\r\n\r\n    const RULES = tariffs || TARIFFS;\r\n\r\n    // New Tariff\r\n    const revNew =\r\n        r(data.ordersNew0To4) * (RULES.NEW?.['0-4'] || 0) +\r\n        r(data.ordersNew4To5) * (RULES.NEW?.['4-5'] || 0) +\r\n        r(data.ordersNew5To6) * (RULES.NEW?.['5-6'] || 0) +\r\n        r(data.ordersNew6To7) * (RULES.NEW?.['6-7'] || 0) +\r\n        r(data.ordersNewGt7) * (RULES.NEW?.['>7'] || 0);\r\n\r\n    // Old Tariff\r\n    const revOld =\r\n        r(data.ordersOld0To35) * (RULES.OLD?.['0-3.5'] || 0) +\r\n        r(data.ordersOldGt35) * (RULES.OLD?.['>3.5'] || 0);\r\n\r\n    return revNew + revOld;\r\n};\r\n\r\n/**\r\n * Standard Spanish Money Format (1.234,56)\r\n */\r\nexport const formatMoney = (amount: number | string | null | undefined, decimals = 2): string => {\r\n    const val = safeFloat(amount);\r\n    return new Intl.NumberFormat('es-ES', {\r\n        minimumFractionDigits: decimals,\r\n        maximumFractionDigits: decimals,\r\n        useGrouping: true\r\n    }).format(val);\r\n};\r\n\r\n/**\r\n * Calculates complete financial report including profit, taxes, and metrics.\r\n */\r\nexport const calculateExpenses = (\r\n    revenue: number,\r\n    orderCount: number,\r\n    inputs: Partial<MonthlyData> = {}\r\n): FinancialReport => {\r\n    // 1. Costs WITHOUT IVA\r\n    const salaries = safeFloat(inputs.salaries);\r\n    const insurance = safeFloat(inputs.insurance);\r\n    const quota = safeFloat(inputs.quota);\r\n\r\n    // 2. Costs WITH IVA (Base)\r\n    const motoCount = safeFloat(inputs.motoCount);\r\n\r\n    // FIXED: Use stored rentingCost if available, otherwise calculate with standard rate\r\n    // This allows SimpleFinanceWizard to save custom renting prices\r\n    const rentingBase = safeFloat((inputs as any).rentingCost) || (motoCount * 154);\r\n\r\n    // Detailed Professional Services\r\n    const agencyFeeBase = safeFloat(inputs.agencyFee);\r\n    const prlFeeBase = safeFloat(inputs.prlFee);\r\n    const accountingFeeBase = safeFloat(inputs.accountingFee);\r\n\r\n    const totalProfServicesBase = agencyFeeBase + prlFeeBase + accountingFeeBase;\r\n\r\n    const gasolineBase = safeFloat(inputs.gasoline);\r\n    const gasolinePrice = safeFloat(inputs.gasolinePrice);\r\n\r\n    const otherExpensesBase = safeFloat(inputs.otherExpenses) + safeFloat(inputs.marketing) + safeFloat(inputs.incidents);\r\n    const repairsBase = safeFloat(inputs.repairs);\r\n\r\n    // Specific tracking\r\n    const marketing = safeFloat(inputs.marketing);\r\n    const incidents = safeFloat(inputs.incidents);\r\n\r\n    // Variable Costs\r\n    // Use manual input if available, otherwise fallback to 0.35 * orders\r\n    const flyderFeeBase = inputs.appFlyder !== undefined\r\n        ? safeFloat(inputs.appFlyder)\r\n        : orderCount * 0.35;\r\n\r\n    const royaltyPercent = safeFloat(inputs.royaltyPercent);\r\n    const royaltyBase = revenue * (royaltyPercent / 100);\r\n\r\n    // Total Base Expenses (P&L View)\r\n    const totalFixedCostsBase = salaries + rentingBase + insurance + totalProfServicesBase + quota + otherExpensesBase;\r\n    const totalVariableCostsBase = flyderFeeBase + royaltyBase + gasolineBase + repairsBase;\r\n\r\n    const calculatedTotalExpenses = totalFixedCostsBase + totalVariableCostsBase;\r\n\r\n    // Explicit Total Override (if manual entry > calculated sum)\r\n    // This allows manual \"Total Expenses\" entry without breakdown to work\r\n    // SUPPORT LEGACY/NESTED DATA: Check inputs.totalExpenses, inputs.expenses, OR inputs.summary.totalExpenses\r\n    const storedTotalExpenses = safeFloat(inputs.totalExpenses || inputs.expenses || (inputs as any).summary?.totalExpenses);\r\n    const totalExpensesBase = Math.max(calculatedTotalExpenses, storedTotalExpenses);\r\n\r\n    const netProfitPreTax = revenue - totalExpensesBase;\r\n\r\n    // --- TAX ESTIMATION ---\r\n    const ivaPercent = 0.21;\r\n    const taxableExpensesBase = rentingBase + totalProfServicesBase + gasolineBase + repairsBase + flyderFeeBase + royaltyBase + otherExpensesBase;\r\n    const ivaSoportado = taxableExpensesBase * ivaPercent;\r\n    const ivaRepercutido = revenue * ivaPercent;\r\n    const ivaAPagar = ivaRepercutido - ivaSoportado;\r\n\r\n    const irpfPercent = safeFloat(inputs.irpfPercent) || 20;\r\n    const irpfPago = netProfitPreTax > 0 ? netProfitPreTax * (irpfPercent / 100) : 0;\r\n\r\n    const netProfitPostTax = netProfitPreTax - irpfPago;\r\n\r\n    // --- METRICS ---\r\n    const activeRiders = safeFloat(inputs.contractedRiders) + 1; // +1 Manager\r\n\r\n    const totalHours = safeFloat(inputs.totalHours);\r\n\r\n    // Logistics Metrics (Automated Calculation)\r\n    let totalKm = 0;\r\n    if (gasolinePrice > 0) {\r\n        const litersConsumed = gasolineBase / gasolinePrice;\r\n        totalKm = litersConsumed * 35; // Yamaha Liberty 125 factor\r\n    } else {\r\n        totalKm = safeFloat(inputs.totalKm);\r\n    }\r\n    totalKm = Math.round(Math.max(0, totalKm));\r\n\r\n    let breakEvenOrders: number | 'N/A' = 'N/A';\r\n    const avgTicket = orderCount > 0 ? revenue / orderCount : 0;\r\n    const variableCostPerOrder = orderCount > 0 ? totalVariableCostsBase / orderCount : 0;\r\n    const contributionMargin = avgTicket - variableCostPerOrder;\r\n\r\n    if (contributionMargin > 0) {\r\n        breakEvenOrders = Math.ceil(totalFixedCostsBase / contributionMargin);\r\n    }\r\n\r\n    let safetyMargin = 0;\r\n    if (typeof breakEvenOrders === 'number' && orderCount > 0) {\r\n        safetyMargin = ((orderCount - breakEvenOrders) / orderCount) * 100;\r\n    }\r\n\r\n    // --- POWER METRICS ---\r\n    const laborRatio = revenue > 0 ? (salaries / revenue) * 100 : 0;\r\n    const incidentRatio = revenue > 0 ? (incidents / revenue) * 100 : 0;\r\n\r\n    return {\r\n        fixed: {\r\n            salaries,\r\n            renting: rentingBase,\r\n            insurance,\r\n            services: totalProfServicesBase,\r\n            quota,\r\n            other: otherExpensesBase,\r\n            total: totalFixedCostsBase\r\n        },\r\n        variable: {\r\n            gasoline: gasolineBase,\r\n            repairs: repairsBase,\r\n            flyderFee: flyderFeeBase,\r\n            royalty: royaltyBase,\r\n            total: totalVariableCostsBase\r\n        },\r\n        totalExpenses: totalExpensesBase,\r\n        netProfit: netProfitPreTax,\r\n        taxes: {\r\n            ivaRepercutido,\r\n            ivaSoportado,\r\n            ivaAPagar,\r\n            irpfPercent,\r\n            irpfPago,\r\n            netProfitPostTax,\r\n            // UI Helper Population\r\n            netProfit: netProfitPreTax,\r\n            margin: revenue > 0 ? (netProfitPreTax / revenue) * 100 : 0,\r\n            totalReserve: ivaAPagar + irpfPago,\r\n            vat: {\r\n                toPay: ivaAPagar\r\n            }\r\n        },\r\n        metrics: {\r\n            avgTicket,\r\n            costPerOrder: orderCount > 0 ? totalExpensesBase / orderCount : 0,\r\n            breakEvenOrders,\r\n            profitMargin: revenue > 0 ? (netProfitPreTax / revenue) * 100 : 0,\r\n            activeRiders,\r\n            productivity: totalHours > 0 ? orderCount / totalHours : 0,\r\n            revenuePerHour: totalHours > 0 ? revenue / totalHours : 0,\r\n            costPerHour: totalHours > 0 ? totalExpensesBase / totalHours : 0,\r\n            profitPerRider: activeRiders > 0 ? netProfitPreTax / activeRiders : 0,\r\n            totalKm,\r\n            revenuePerKm: totalKm > 0 ? revenue / totalKm : 0,\r\n            costPerKm: totalKm > 0 ? totalExpensesBase / totalKm : 0,\r\n            dropDensity: totalKm > 0 ? (orderCount / totalKm) * 100 : 0,\r\n            safetyMargin,\r\n            laborRatio,\r\n            incidentRatio,\r\n            marketingSpend: marketing,\r\n            incidentCost: incidents\r\n        },\r\n        breakdown: [\r\n            { name: 'Salarios', value: salaries, type: 'fixed' },\r\n            { name: 'Renting Motos', value: rentingBase, type: 'fixed' },\r\n            { name: 'Seguros', value: insurance, type: 'fixed' },\r\n\r\n            { name: 'Gestor√≠a', value: agencyFeeBase, type: 'fixed' },\r\n            { name: 'PRL', value: prlFeeBase, type: 'fixed' },\r\n            { name: 'App Flyder', value: accountingFeeBase, type: 'fixed' },\r\n            { name: 'Cuota Aut√≥nomo', value: quota, type: 'fixed' },\r\n            { name: 'Marketing', value: marketing, type: 'fixed' },\r\n            { name: 'Mermas', value: incidents, type: 'fixed' },\r\n            { name: 'Otros Costes', value: safeFloat(inputs.otherExpenses), type: 'fixed' },\r\n            { name: 'Gasolina', value: gasolineBase, type: 'variable' },\r\n            { name: 'Reparaciones', value: repairsBase, type: 'variable' },\r\n            { name: 'Servicios Financieros Repaart', value: flyderFeeBase, type: 'variable' },\r\n            { name: 'Royalty', value: royaltyBase, type: 'variable' },\r\n        ]\r\n    };\r\n};\r\n\r\n// --- FORECASTING UTILS ---\r\n\r\n/**\r\n * Simple Linear Regression: y = mx + b\r\n */\r\nexport const calculateTrend = (\r\n    data: Array<Record<string, number | undefined>>,\r\n    key: string,\r\n    periodsToForecast = 3\r\n): number[] => {\r\n    const n = data.length;\r\n    if (n < 2) return [];\r\n\r\n    let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;\r\n    data.forEach((d, i) => {\r\n        sumX += i;\r\n        sumY += (d[key] || 0);\r\n        sumXY += i * (d[key] || 0);\r\n        sumXX += i * i;\r\n    });\r\n\r\n    const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);\r\n    const intercept = (sumY - slope * sumX) / n;\r\n\r\n    return Array.from({ length: periodsToForecast }, (_, i) => {\r\n        const nextIndex = n + i;\r\n        const val = slope * nextIndex + intercept;\r\n        return Math.max(0, val);\r\n    });\r\n};\r\n\r\n/**\r\n * Project current month's metric to end of month (e.g. Day 15 -> Day 30)\r\n */\r\nexport const projectMonthEnd = (currentValue: number): number => {\r\n    const now = new Date();\r\n    const currentDay = now.getDate();\r\n    const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();\r\n\r\n    if (currentDay === 0) return currentValue;\r\n\r\n    // Formula: (Current / Day) * TotalDays\r\n    // Conservative factor (0.95) to avoid over-optimism\r\n    const projection = (currentValue / currentDay) * lastDay * 0.95;\r\n\r\n    return Math.max(currentValue, projection);\r\n};\r\n\r\n// --- ENTERPRISE FINANCIAL ANALYSIS ---\r\n\r\nconst currencyFormatter = new Intl.NumberFormat('es-MX', {\r\n    style: 'currency',\r\n    currency: 'EUR',\r\n    minimumFractionDigits: 0,\r\n    maximumFractionDigits: 0\r\n});\r\n\r\nexport const formatCurrency = (amount: number | null | undefined): string => {\r\n    return currencyFormatter.format(amount || 0);\r\n};\r\n\r\n/**\r\n * Financial Analysis Engine\r\n * Transforms raw data into actionable intelligence.\r\n */\r\nexport const analyzeFinancialHealth = (\r\n    expenses: ExpenseInput[] = [],\r\n    revenue = 0\r\n): FinancialAnalysis => {\r\n    const safeExpenses = Array.isArray(expenses) ? expenses : [];\r\n    const safeRevenue = Number(revenue) || 0;\r\n\r\n    // Normalize expenses\r\n    const normalizedExpenses: NormalizedExpense[] = safeExpenses.map(e => ({\r\n        amount: Number(e.amount ?? e.value ?? e.cost ?? 0),\r\n        category: e.category ?? e.name ?? 'General'\r\n    }));\r\n\r\n    const totalExpenses = normalizedExpenses.reduce((acc, curr) => acc + curr.amount, 0);\r\n    const netProfit = safeRevenue - totalExpenses;\r\n    const profitMargin = safeRevenue > 0 ? (netProfit / safeRevenue) * 100 : 0;\r\n\r\n    const alerts: FinancialAlert[] = [];\r\n\r\n    // ANALYSIS 1: Margin Health\r\n    if (safeRevenue > 0 && profitMargin < THRESHOLDS.MARGIN_WARNING) {\r\n        const isCritical = profitMargin < THRESHOLDS.MARGIN_CRITICAL;\r\n        const targetProfit = safeRevenue * (THRESHOLDS.MARGIN_WARNING / 100);\r\n        const gap = targetProfit - netProfit;\r\n\r\n        alerts.push({\r\n            id: 'margin_risk',\r\n            type: 'PROFIT',\r\n            severity: isCritical ? 'critical' : 'warning',\r\n            title: 'Margen Operativo Bajo',\r\n            value: `${profitMargin.toFixed(1)}%`,\r\n            target: `${THRESHOLDS.MARGIN_WARNING}%`,\r\n            gapValue: gap,\r\n            description: isCritical\r\n                ? 'El negocio est√° en zona de supervivencia.'\r\n                : 'Rentabilidad por debajo del est√°ndar de la franquicia.',\r\n            details: {\r\n                diagnosis: 'Tus costos fijos absorben demasiada liquidez. El volumen de ventas actual no justifica la estructura de gastos.',\r\n                impact: `Est√°s dejando de ganar ${formatCurrency(gap)} mensuales comparado con una operaci√≥n saludable.`,\r\n                actions: [\r\n                    { title: 'Revisi√≥n de Precios', desc: 'Ajustar precios un 5% cubre el 60% de este hueco.' },\r\n                    { title: 'Corte de Grasa', desc: 'Auditar servicios recurrentes (SaaS, Mantenimiento).' }\r\n                ]\r\n            }\r\n        });\r\n    }\r\n\r\n    // ANALYSIS 2: Cost Concentration Risk (Pareto)\r\n    const sortedExpenses = [...normalizedExpenses].sort((a, b) => b.amount - a.amount);\r\n\r\n    if (sortedExpenses.length > 0) {\r\n        const topExpense = sortedExpenses[0];\r\n        const concentration = totalExpenses > 0 ? (topExpense.amount / totalExpenses) : 0;\r\n\r\n        if (concentration > THRESHOLDS.COST_CONCENTRATION_RISK) {\r\n            alerts.push({\r\n                id: 'concentration_risk',\r\n                type: 'COSTS',\r\n                severity: 'warning',\r\n                title: 'Dependencia de Proveedor',\r\n                value: `${(concentration * 100).toFixed(0)}%`,\r\n                target: '< 30%',\r\n                expenseName: topExpense.category,\r\n                description: `El rubro \"${topExpense.category}\" representa un riesgo estructural.`,\r\n                details: {\r\n                    diagnosis: `Tu operaci√≥n es fr√°gil ante cambios de precio en ${topExpense.category}. No tienes poder de negociaci√≥n.`,\r\n                    impact: `Una subida del 10% en este rubro reducir√≠a tu utilidad en ${formatCurrency(topExpense.amount * 0.10)}.`,\r\n                    breakdown: sortedExpenses.slice(0, 3).map(e => ({\r\n                        label: e.category,\r\n                        value: e.amount,\r\n                        percentage: totalExpenses > 0 ? (e.amount / totalExpenses) * 100 : 0\r\n                    })),\r\n                    actions: [\r\n                        { title: 'Diversificaci√≥n', desc: 'Homologar un segundo proveedor antes de fin de mes.' },\r\n                        { title: 'Compra por Volumen', desc: 'Negociar descuento por pago anticipado semestral.' }\r\n                    ]\r\n                }\r\n            });\r\n        }\r\n    }\r\n\r\n    return {\r\n        kpi: {\r\n            revenue: safeRevenue,\r\n            expenses: totalExpenses,\r\n            margin: profitMargin,\r\n            status: alerts.length === 0 ? 'healthy' : (alerts.some(a => a.severity === 'critical') ? 'critical' : 'warning')\r\n        },\r\n        alerts\r\n    };\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\lib\\firebase.d.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\lib\\firebase.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\lib\\fraudDetection.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\lib\\gemini.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":181,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":181,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7270,7273],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7270,7273],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":188,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":188,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7728,7731],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7728,7731],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":203,"column":68,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":203,"endColumn":71,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8350,8353],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8350,8353],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":254,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":254,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10362,10365],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10362,10365],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":328,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":328,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13127,13130],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13127,13130],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":373,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":373,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14601,14604],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14601,14604],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":373,"column":73,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":373,"endColumn":76,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14616,14619],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14616,14619],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":437,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":437,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16507,16510],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16507,16510],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { GoogleGenerativeAI, GenerativeModel, ChatSession } from \"@google/generative-ai\";\r\nimport { FRANCHISE_KNOWLEDGE } from './companyKnowledge';\r\nimport { APP_CAPABILITIES } from './appCapabilities';\r\n\r\n// Initialize the API with the key (will be set in .env)\r\nconst API_KEY = import.meta.env.VITE_GOOGLE_AI_KEY || '';\r\n\r\nlet chatSession: ChatSession | null = null;\r\n\r\nconst SYSTEM_INSTRUCTION = `\r\nEres REPAART AI, el asistente virtual experto de la franquicia Repaart.\r\nTu objetivo es ayudar a los franquiciados a resolver dudas operativas, financieras y DE USO DE LA PLATAFORMA.\r\n\r\nCEREBRO 1: CONOCIMIENTO DE LA APP (D√ìNDE EST√Å TODO):\r\n${APP_CAPABILITIES}\r\n\r\nCEREBRO 2: MANUAL OPERATIVO (C√ìMO FUNCIONA EL NEGOCIO):\r\n${FRANCHISE_KNOWLEDGE}\r\n\r\nTUS SUPERPODERES:\r\n1. NAVEGADOR: Si preguntan \"¬øD√≥nde veo mis facturas?\", diles EXACTAMENTE la ruta (Ej: \"Ve a Finanzas > Gastos\").\r\n2. SOPORTE T√âCNICO: Si tienen un problema t√©cnico con la app, sugiere limpiar cach√© o abrir ticket en /support.\r\n3. OPERACIONES: Resuelve dudas sobre riders, motos y turnos usando el Manual Operativo.\r\n4. FINANZAS: Explica conceptos financieros bas√°ndote en la secci√≥n 3 y 4 del manual.\r\n\r\nTONO Y ESTILO:\r\n- Profesional pero cercano (\"Compa√±ero\").\r\n- Ve al grano. No des discursos vac√≠os.\r\n- Si es una duda de APP, usa CEREBRO 1.\r\n- Si es una duda de NEGOCIO, usa CEREBRO 2.\r\n\r\nSi no sabes una respuesta espec√≠fica, sugiere contactar a soporte@repaart.es o abrir un ticket.\r\n`;\r\n\r\nexport const initGeminiChat = async (): Promise<boolean> => {\r\n    if (!API_KEY) {\r\n        console.warn(\"Gemini API Key missing\");\r\n        return false;\r\n    }\r\n\r\n    try {\r\n        const genAI = new GoogleGenerativeAI(API_KEY);\r\n        const model: GenerativeModel = genAI.getGenerativeModel({\r\n            model: \"gemini-pro\"\r\n        });\r\n\r\n        chatSession = model.startChat({\r\n            history: [],\r\n            generationConfig: {\r\n                maxOutputTokens: 2000, // Increased for Pro\r\n                temperature: 0.5, // Reduced for more consistent formatting\r\n            },\r\n        });\r\n\r\n        if (import.meta.env.DEV) {\r\n            console.log(\"Gemini Chat Session Initialized ‚úÖ (Pro Model)\");\r\n        }\r\n        return true;\r\n    } catch (error) {\r\n        console.error(\"Error initializing Gemini:\", error);\r\n        return false;\r\n    }\r\n};\r\n\r\nexport const sendMessageToGemini = async (message: string): Promise<string> => {\r\n    if (!chatSession) {\r\n        // Try to init if not ready\r\n        const success = await initGeminiChat();\r\n        // If still failed (e.g. no key), return mock fallback\r\n        if (!success) {\r\n            return \"‚ö†Ô∏è No veo mi 'llave maestra' (API Key). Por favor configura la VITE_GOOGLE_AI_KEY en el sistema.\";\r\n        }\r\n    }\r\n\r\n    try {\r\n        if (!chatSession) throw new Error(\"Chat session not initialized\");\r\n        const result = await chatSession.sendMessage(message);\r\n        const response = await result.response;\r\n        return response.text();\r\n    } catch (error) {\r\n        console.error(\"Gemini Error:\", error);\r\n        return \"Lo siento, tuve un problema de conexi√≥n. ¬øPodr√≠as intentar de nuevo?\";\r\n    }\r\n};\r\n\r\n/**\r\n * Generates a structured Guide from raw text using Gemini\r\n */\r\n/**\r\n * Generates a structured Guide from raw text using Gemini (REST API Fallback)\r\n * bypasses SDK issues by using direct HTTP fetch\r\n */\r\nexport const generateGuideContent = async (rawText: string): Promise<{\r\n    title: string;\r\n    description: string;\r\n    category: 'operativa' | 'tecnico' | 'accidente' | 'rrhh';\r\n    theme: string;\r\n    icon: string;\r\n    isCritical: boolean;\r\n    confidence: number;\r\n} | null> => {\r\n    const API_KEY = import.meta.env.VITE_GOOGLE_AI_KEY || '';\r\n    if (!API_KEY) {\r\n        throw new Error(\"Falta la API Key de Gemini (VITE_GOOGLE_AI_KEY).\");\r\n    }\r\n\r\n    const prompt = `\r\n    ${SYSTEM_INSTRUCTION}\r\n\r\n    ACTUA COMO: Director de Operaciones de una Franquicia de Reparto (Repaart).\r\n    TAREA: Analiza el siguiente \"Texto Crudo\" y transf√≥rmalo en una Gu√≠a Operativa Profesional.\r\n    \r\n    TEXTO CRUDO:\r\n    \"${rawText}\"\r\n\r\n    REGLAS DE SALIDA (JSON ESTRICTO):\r\n    1. \"title\": T√≠tulo profesional, corto y directo (Ej: \"Protocolo de...\", \"Normativa de...\").\r\n    2. \"description\": Resumen ejecutivo de m√°ximo 2 frases. Tono corporativo y claro. Sintetiza la informaci√≥n clave.\r\n    3. \"category\": Elige UNA de estas: \"operativa\", \"tecnico\", \"accidente\", \"rrhh\".\r\n    4. \"theme\": Elige UNO basado en la urgencia/tipo:\r\n       - \"rose\" (Cr√≠tico/Peligro)\r\n       - \"amber\" (Advertencia/Mantenimiento)\r\n       - \"emerald\" (Positivo/Formaci√≥n)\r\n       - \"indigo\" (Protocolo Est√°ndar)\r\n       - \"blue\" (Informativo)\r\n    5. \"icon\": Elige el nombre del icono de Lucide que mejor encaje (SOLO ESTOS: ShieldAlert, Wrench, Users, PlayCircle, BookOpen, FileText, Zap, Heart, Star, Award, Info, AlertTriangle, CheckCircle, HelpCircle, Lightbulb, Target).\r\n    6. \"isCritical\": true si es un tema de seguridad, accidentes o normativa legal imperativa. false si es informativo.\r\n\r\n    IMPORTANTE: \r\n    - EL RESULTADO DEBE SER UN JSON V√ÅLIDO.\r\n    - NO uses Markdown (\\`\\`\\`json). Devuelve SOLO el texto JSON plano.\r\n    - ESCAPA todas las comillas dobles (\") dentro de los valores de texto con backslash (\\\\\").\r\n    - ESCAPA todos los saltos de l√≠nea dentro de los valores de texto con \\\\n.\r\n\r\n    Responde SOLO con el JSON v√°lido.\r\n    `;\r\n\r\n    // List of models to try via REST (Based on authenticated user availability)\r\n    const models = [\"gemini-2.5-flash\", \"gemini-2.5-pro\", \"gemini-2.0-flash\", \"gemini-flash-latest\", \"gemini-pro-latest\"];\r\n\r\n    for (const model of models) {\r\n        try {\r\n            console.log(`ü§ñ REST Attempt: ${model}...`);\r\n            const response = await fetch(\r\n                `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${API_KEY}`,\r\n                {\r\n                    method: 'POST',\r\n                    headers: { 'Content-Type': 'application/json' },\r\n                    body: JSON.stringify({\r\n                        contents: [{ parts: [{ text: prompt }] }]\r\n                    })\r\n                }\r\n            );\r\n\r\n            if (response.ok) {\r\n                const data = await response.json();\r\n                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;\r\n                if (!text) throw new Error(\"Empty response\");\r\n\r\n                const jsonMatch = text.match(/\\{[\\s\\S]*\\}/);\r\n                if (!jsonMatch) throw new Error(\"No JSON found\");\r\n\r\n                console.log(`‚úÖ Success with ${model}`);\r\n                return JSON.parse(jsonMatch[0]);\r\n            } else {\r\n                console.warn(`‚ùå ${model} failed: ${response.status}`);\r\n            }\r\n        } catch (e) {\r\n            console.warn(`‚ùå ${model} error:`, e);\r\n        }\r\n    }\r\n\r\n    // DIAGNOSTIC MODE: If all failed, list available models\r\n    let diagMessage = \"\";\r\n    try {\r\n        console.log(\"üîç Diagnosing available models...\");\r\n        const listResp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${API_KEY}`);\r\n\r\n        if (listResp.ok) {\r\n            const data = await listResp.json();\r\n            const availableModels = data.models?.map((m: any) => m.name) || [];\r\n            console.error(\"üìã Available Models:\", availableModels);\r\n            throw new Error(`Tus modelos disponibles son: ${availableModels.join(\", \")}. Por favor, contacta al desarrollador con esta lista.`);\r\n        } else {\r\n            const err = await listResp.json();\r\n            diagMessage = `Error de Diagn√≥stico (${listResp.status}): ${err.error?.message || listResp.statusText}`;\r\n        }\r\n    } catch (diagError: any) {\r\n        console.error(\"Diagnostic failed:\", diagError);\r\n        // If we manually threw the list of models, allow it to bubble up\r\n        if (diagError.message.includes(\"Tus modelos disponibles\")) {\r\n            throw diagError;\r\n        }\r\n        if (!diagMessage) diagMessage = diagError.message;\r\n    }\r\n\r\n    throw new Error(`Fallo Total de Conexi√≥n. Diagn√≥stico: ${diagMessage || \"Imposible contactar con Google API\"}. Verifica tu API KEY.`);\r\n};\r\n\r\n/**\r\n * Analyzes monthly financial data and provides a strategic executive summary\r\n */\r\nexport const analyzeFinancialMonthlyReport = async (financialData: any): Promise<{\r\n    summary: string;\r\n    strengths: string[];\r\n    weaknesses: string[];\r\n    recommendation: string;\r\n    sentiment: 'positive' | 'neutral' | 'negative' | 'critical';\r\n} | null> => {\r\n\r\n    // 1. Prepare Data for AI (Sanitize)\r\n    const contextData = {\r\n        month: financialData.month,\r\n        revenue: financialData.totalIncome,\r\n        profit: financialData.profit,\r\n        margin: financialData.revenue > 0 ? (financialData.profit / financialData.revenue * 100).toFixed(1) + '%' : '0%',\r\n        orders: financialData.orders,\r\n        costs: {\r\n            personnel: financialData.expenses?.payroll + financialData.expenses?.insurance,\r\n            fuel: financialData.expenses?.fuel,\r\n            repairs: financialData.expenses?.repairs,\r\n            marketing: financialData.expenses?.marketing\r\n        }\r\n    };\r\n\r\n    const prompt = `\r\n    ACTUA COMO: Auditor Financiero Senior de \"Repaart\" (Franquicia de Log√≠stica).\r\n    \r\n    TAREA: Analiza este cierre mensual y genera un reporte ejecutivo MUY BREVE y DIRECTO.\r\n    \r\n    DATOS DEL MES:\r\n    ${JSON.stringify(contextData, null, 2)}\r\n\r\n    REGLAS DE AN√ÅLISIS:\r\n    1. Si el margen es >15%, felicita (buen trabajo).\r\n    2. Si el gasto en combustible es alto (vs pedidos), alerta de posible fraude o ineficiencia.\r\n    3. Si hay muchas reparaciones, sugiere renovar flota.\r\n    4. S√© duro pero constructivo. Habla de dinero, no de sensaciones.\r\n\r\n    SALIDA JSON OBLIGATORIA (Sin Markdown):\r\n    {\r\n        \"summary\": \"1 frase resumen del estado general del mes.\",\r\n        \"strengths\": [\"Punto fuerte 1\", \"Punto fuerte 2\"],\r\n        \"weaknesses\": [\"Punto d√©bil 1\", \"Punto d√©bil 2\"],\r\n        \"recommendation\": \"Tu mejor consejo accionable para el mes que viene.\",\r\n        \"sentiment\": \"positive\" | \"neutral\" | \"negative\" | \"critical\"\r\n    }\r\n    `;\r\n\r\n    return await generateJson(prompt);\r\n};\r\n\r\n// Internal Helper for JSON Generation (Reuses the robust logic)\r\nconst generateJson = async (promptText: string): Promise<any> => {\r\n    const API_KEY = import.meta.env.VITE_GOOGLE_AI_KEY || '';\r\n    if (!API_KEY) return null;\r\n\r\n    // Use best available model from diagnosis knowledge\r\n    const modelName = \"gemini-2.5-flash\";\r\n\r\n    try {\r\n        const response = await fetch(\r\n            `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${API_KEY}`,\r\n            {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }] })\r\n            }\r\n        );\r\n\r\n        if (!response.ok) throw new Error(\"API Error\");\r\n        const data = await response.json();\r\n        const text = data.candidates?.[0]?.content?.parts?.[0]?.text;\r\n\r\n        if (!text) return null;\r\n        const jsonMatch = text.match(/\\{[\\s\\S]*\\}/);\r\n        return jsonMatch ? JSON.parse(jsonMatch[0]) : null;\r\n\r\n    } catch (e) {\r\n        console.error(\"AI Analysis Failed\", e);\r\n        return null; // Silent fail in UI is better than crash for this feature\r\n    }\r\n};\r\n\r\n/**\r\n * Analyzes a ticket draft and suggests immediate solutions from the Knowledge Base\r\n */\r\nexport const suggestSupportSolution = async (subject: string, description: string): Promise<{\r\n    suggestion: string;\r\n    confidence: number;\r\n    isSolvable: boolean;\r\n} | null> => {\r\n\r\n    const prompt = `\r\n    ACTUA COMO: Soporte T√©cnico Nivel 1 de \"Repaart\".\r\n    TAREA: Analiza este borrador de ticket y sugiere una soluci√≥n inmediata si existe en el manual b√°sico.\r\n\r\n    TICKET:\r\n    Asunto: \"${subject}\"\r\n    Descripci√≥n: \"${description}\"\r\n\r\n    BASE DE CONOCIMIENTO (Resumida):\r\n    - TPV/Dat√°fono no conecta -> Reiniciar pulsando bot√≥n rojo 10s. Comprobar Wifi \"Repaart_Devices\".\r\n    - Moto no arranca -> Comprobar bot√≥n rojo de manillar (Run/Stop). Comprobar patilla lateral.\r\n    - App Rider bloqueada -> Borrar cach√© en Ajustes > Aplicaciones > Repaart Rider.\r\n    - Falta dinero en cierre -> Revisar tickets de dat√°fono no liquidados o propinas en efectivo mal anotadas.\r\n    - Impresora t√©rmica falla -> Comprobar papel y luz parpadeante. Abrir y cerrar tapa fuerte.\r\n\r\n    REGLAS:\r\n    - Si el problema parece coincidir CLARAMENTE con la base de conocimiento, dalo como \"isSolvable\": true.\r\n    - La sugerencia debe ser CORTA (max 15 palabras) y DIRECTA.\r\n    - Si no te suena de nada o es ambiguo, devuelve null o \"isSolvable\": false.\r\n\r\n    SALIDA JSON:\r\n    {\r\n        \"suggestion\": \"Texto de la soluci√≥n...\",\r\n        \"confidence\": 0-100,\r\n        \"isSolvable\": boolean\r\n    }\r\n    `;\r\n\r\n    return await generateJson(prompt);\r\n};\r\n\r\n/**\r\n * Validates a weekly schedule for operational risks\r\n */\r\nexport const validateWeeklySchedule = async (shifts: any[]): Promise<{\r\n    score: number;\r\n    status: 'optimal' | 'warning' | 'critical';\r\n    feedback: string;\r\n    missingCoverage: string[];\r\n} | null> => {\r\n\r\n    // Condensed Shift Representation for Token Efficiency\r\n    const scheduleSummary = shifts.map(s => {\r\n        const start = new Date(s.startAt);\r\n        const day = start.toLocaleDateString('es-ES', { weekday: 'short' });\r\n        const hour = start.getHours();\r\n        return `${day} ${hour}h-${new Date(s.endAt).getHours()}h (${s.riderName})`;\r\n    }).join('\\n');\r\n\r\n    const prompt = `\r\n    ACTUA COMO: \"Sheriff de Operaciones\" de Repaart.\r\n    TAREA: Audita este cuadrante semanal y busca huecos peligrosos.\r\n\r\n    CUADRANTE:\r\n    ${scheduleSummary}\r\n\r\n    REGLAS DE ORO (PRIME TIME):\r\n    1. VIERNES NOCHE (20:00-23:00): M√≠nimo 2 riders.\r\n    2. S√ÅBADO NOCHE (20:00-23:00): M√≠nimo 3 riders.\r\n    3. DOMINGO NOCHE (20:00-23:00): M√≠nimo 2 riders.\r\n    4. DIARIO (13:00-15:00): M√≠nimo 1 rider.\r\n\r\n    SI EL CUADRANTE EST√Å VAC√çO, ES CR√çTICO.\r\n\r\n    SALIDA JSON:\r\n    {\r\n        \"score\": 0-100,\r\n        \"status\": \"optimal\" (>80), \"warning\" (50-80), \"critical\" (<50),\r\n        \"feedback\": \"Comentario corto con tono de Sheriff (duro pero justo).\",\r\n        \"missingCoverage\": [\"Viernes Noche (Falta 1)\", \"S√°bado Noche (Vac√≠o)\"]\r\n    }\r\n    `;\r\n\r\n    return await generateJson(prompt);\r\n};\r\n\r\n/**\r\n * Generates NEW shifts to fix coverage gaps\r\n */\r\nexport const generateScheduleFix = async (currentShifts: any[], riders: any[], missingCoverage: string[]): Promise<{\r\n    newShifts: {\r\n        riderId: string;\r\n        startDay: string; // \"YYYY-MM-DD\"\r\n        startHour: number;\r\n        duration: number;\r\n        reason: string;\r\n    }[];\r\n    explanation: string;\r\n} | null> => {\r\n\r\n    const ridersList = riders.map(r => `${r.id} (${r.fullName})`).join(', ');\r\n    const issues = missingCoverage.join('\\n- ');\r\n\r\n    // Simplify shifts to reduce tokens\r\n    const scheduleSummary = currentShifts.map(s => {\r\n        const start = new Date(s.startAt);\r\n        const day = start.toLocaleDateString('es-ES', { weekday: 'short' });\r\n        const date = s.startAt.split('T')[0];\r\n        return `${date} (${day}) ${start.getHours()}h-${new Date(s.endAt).getHours()}h: ${s.riderName}`;\r\n    }).join('\\n');\r\n\r\n    const prompt = `\r\n    ACTUA COMO: Jefe de Operaciones de Repaart.\r\n    TAREA: Genera NUEVOS turnos para solucionar estos problemas de cobertura.\r\n\r\n    PROBLEMAS DETECTADOS:\r\n    - ${issues}\r\n\r\n    RIDERS DISPONIBLES:\r\n    ${ridersList}\r\n\r\n    CUADRANTE ACTUAL (Para evitar solapes):\r\n    ${scheduleSummary}\r\n\r\n    REGLAS:\r\n    1. Crea turnos l√≥gicos (min 3h, max 5h).\r\n    2. Prioriza huecos de Viernes/S√°bado Noche (20:00-23:00).\r\n    3. NO solapes turnos para el mismo rider.\r\n    4. Usa solo los riders de la lista.\r\n\r\n    SALIDA JSON:\r\n    {\r\n        \"newShifts\": [\r\n            {\r\n                \"riderId\": \"ID_DEL_RIDER\",\r\n                \"startDay\": \"YYYY-MM-DD\",\r\n                \"startHour\": 20,\r\n                \"duration\": 4,\r\n                \"reason\": \"Refuerzo Viernes Noche\"\r\n            }\r\n        ],\r\n        \"explanation\": \"Breve explicaci√≥n de los cambios.\"\r\n    }\r\n    `;\r\n\r\n    return await generateJson(prompt);\r\n};\r\n\r\n/**\r\n * Generates a FULL schedule based on natural language prompt\r\n */\r\nexport const generateFullSchedule = async (\r\n    userPrompt: string,\r\n    riders: any[],\r\n    weekStart: string, // YYYY-MM-DD\r\n    weekEnd: string // YYYY-MM-DD\r\n): Promise<{\r\n    shifts: {\r\n        riderId: string;\r\n        startDay: string; // YYYY-MM-DD\r\n        startHour: number;\r\n        duration: number;\r\n        reason: string;\r\n    }[];\r\n    explanation: string;\r\n} | null> => {\r\n\r\n    const ridersList = riders.map(r => `${r.id} (${r.fullName})`).join(', ');\r\n\r\n    const prompt = `\r\n    ACTUA COMO: Planificador Experto de Log√≠stica \"Repaart\".\r\n    TAREA: Crea un cuadrante de turnos COMPLETO para la semana del ${weekStart} al ${weekEnd}.\r\n    \r\n    INSTRUCCI√ìN DEL USUARIO:\r\n    \"${userPrompt}\"\r\n\r\n    RECURSOS (RIDERS):\r\n    ${ridersList}\r\n\r\n    REGLAS DE NEGOCIO:\r\n    1. Turnos est√°ndar: Almuerzos (13:00-16:00 aprox) y Cenas (20:00-24:00 aprox).\r\n    2. Evita turnos de m√°s de 5 horas seguidas sin descanso.\r\n    3. Distribuye equitativamente si no se dice lo contrario.\r\n    4. Cubre SIEMPRE los picos (Viernes/S√°bado Noche) con m√°s fuerza.\r\n\r\n    SALIDA JSON:\r\n    {\r\n        \"shifts\": [\r\n            { \"riderId\": \"...\", \"startDay\": \"YYYY-MM-DD\", \"startHour\": 13, \"duration\": 3, \"reason\": \"Almuerzo Lunes\" }\r\n        ],\r\n        \"explanation\": \"He creado una planificaci√≥n centrada en...\"\r\n    }\r\n    `;\r\n\r\n    return await generateJson(prompt);\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\lib\\knowledgeBase.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\lib\\notifications.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\lib\\pdfGenerator.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":110,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":110,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4046,4049],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4046,4049],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":130,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":130,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4857,4860],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4857,4860],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":139,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":139,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5137,5140],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5137,5140],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":182,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":182,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6786,6789],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6786,6789],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { formatMoney } from './finance';\r\n// import { jsPDF } from 'jspdf';\r\n// import autoTable from 'jspdf-autotable';\r\n// Dynamic imports used in function for performance\r\n\r\ninterface ReportData {\r\n    revenue: number;\r\n    expenses: number;\r\n    profit: number;\r\n    taxes: {\r\n        netProfitPostTax: number;\r\n        ivaRepercutido: number;\r\n        ivaSoportado: number;\r\n        ivaAPagar: number;\r\n        // ... other tax fields\r\n    };\r\n    metrics: {\r\n        productivity: number;\r\n        costPerKm: number;\r\n        totalKm: number;\r\n        profitPerRider: number;\r\n        dropDensity: number;\r\n        profitMargin: number;\r\n    };\r\n    breakdown: Array<{\r\n        name: string;\r\n        value: number;\r\n    }>;\r\n}\r\n\r\nexport const generatePDFReport = async (report: ReportData | null, franchiseName: string = 'Franchise Partner', month: string = 'Current'): Promise<void> => {\r\n    try {\r\n        if (!report) {\r\n            console.error(\"PDF Generation failed: Report data is missing.\");\r\n            alert(\"No hay datos para generar el informe.\");\r\n            return;\r\n        }\r\n\r\n        // Dynamic imports for performance (lazy load ~600kB)\r\n        const { jsPDF } = await import('jspdf');\r\n        const autoTable = (await import('jspdf-autotable')).default;\r\n\r\n        const doc = new jsPDF();\r\n        const pageWidth = doc.internal.pageSize.width;\r\n\r\n        // --- HEADER ---\r\n        doc.setFontSize(22);\r\n        doc.setTextColor(30, 41, 59); // Slate 800\r\n        doc.text(\"REPAART\", 15, 20);\r\n\r\n        doc.setFontSize(10);\r\n        doc.setTextColor(100, 116, 139); // Slate 500\r\n        doc.text(\"FRANCHISE FINANCIAL SYSTEM\", 15, 25);\r\n\r\n        // Date & Info\r\n        doc.setFontSize(10);\r\n        doc.setTextColor(0, 0, 0);\r\n        doc.text(`FRANQUICIA: ${franchiseName.toUpperCase()}`, 15, 40);\r\n        doc.text(`PERIODO: ${month.toUpperCase()}`, 15, 45);\r\n        doc.text(`FECHA EMISI√ìN: ${new Date().toLocaleDateString()}`, pageWidth - 15, 20, { align: 'right' });\r\n\r\n        // --- EXECUTIVE SUMMARY ---\r\n        let yPos = 60;\r\n        doc.setFillColor(248, 250, 252); // Slate 50\r\n        doc.rect(15, yPos, pageWidth - 30, 25, 'F');\r\n\r\n        doc.setFontSize(14);\r\n        doc.text(\"RESUMEN EJECUTIVO\", 20, yPos + 10);\r\n\r\n        doc.setFontSize(10);\r\n        doc.text(\"INGRESOS\", 20, yPos + 20);\r\n        doc.text(\"GASTOS\", 70, yPos + 20);\r\n        doc.text(\"BENEFICIO NETO\", 120, yPos + 20);\r\n\r\n        doc.setFontSize(12);\r\n        doc.setFont('helvetica', 'bold');\r\n        doc.text(`${formatMoney(report.revenue)}‚Ç¨`, 20, yPos + 17);\r\n        doc.text(`${formatMoney(report.expenses)}‚Ç¨`, 70, yPos + 17);\r\n\r\n        const profitColor = report.taxes.netProfitPostTax >= 0 ? [22, 163, 74] : [220, 38, 38]; // Green/Red\r\n        doc.setTextColor(profitColor[0], profitColor[1], profitColor[2]);\r\n        doc.text(`${formatMoney(report.taxes.netProfitPostTax)}‚Ç¨`, 120, yPos + 17);\r\n        doc.setTextColor(0, 0, 0); // Reset\r\n        doc.setFont('helvetica', 'normal');\r\n\r\n        // --- METRICS GRID ---\r\n        yPos += 35;\r\n        doc.setFontSize(12);\r\n        doc.text(\"INDICADORES CLAVE\", 15, yPos);\r\n\r\n        const metricsData = [\r\n            ['Productividad', `${report.metrics.productivity.toFixed(2)} ped/h`, 'Coste/Km', `${report.metrics.costPerKm.toFixed(3)}‚Ç¨`],\r\n            ['Km Totales', `${report.metrics.totalKm} km`, 'Beneficio/Rider', `${report.metrics.profitPerRider.toFixed(2)}‚Ç¨`],\r\n            ['Drop Density', `${report.metrics.dropDensity.toFixed(2)}%`, 'Margen', `${report.metrics.profitMargin.toFixed(1)}%`]\r\n        ];\r\n\r\n        autoTable(doc, {\r\n            startY: yPos + 5,\r\n            head: [],\r\n            body: metricsData,\r\n            theme: 'plain',\r\n            styles: { fontSize: 9, cellPadding: 2 },\r\n            columnStyles: {\r\n                0: { fontStyle: 'bold', textColor: [100, 116, 139] },\r\n                2: { fontStyle: 'bold', textColor: [100, 116, 139] }\r\n            }\r\n        });\r\n\r\n        // --- TAXES ---\r\n        yPos = (doc as any).lastAutoTable.finalY + 15;\r\n        doc.setFontSize(12);\r\n        doc.text(\"LIQUIDACI√ìN IVA ESTIMADA\", 15, yPos);\r\n\r\n        const taxData = [\r\n            ['IVA Repercutido (21%)', `+${formatMoney(report.taxes.ivaRepercutido)}‚Ç¨`],\r\n            ['IVA Soportado (Deducible)', `-${formatMoney(report.taxes.ivaSoportado)}‚Ç¨`],\r\n            ['A PAGAR', `${formatMoney(report.taxes.ivaAPagar)}‚Ç¨`]\r\n        ];\r\n\r\n        autoTable(doc, {\r\n            startY: yPos + 5,\r\n            head: [['Concept', 'Importe']],\r\n            body: taxData,\r\n            theme: 'striped',\r\n            headStyles: { fillColor: [30, 41, 59] },\r\n            styles: { fontSize: 10 },\r\n            columnStyles: {\r\n                1: { halign: 'right', fontStyle: 'bold' }\r\n            },\r\n            didParseCell: function (data: any) {\r\n                if (data.row.index === 2) {\r\n                    data.cell.styles.fontStyle = 'bold';\r\n                    data.cell.styles.fillColor = [241, 245, 249];\r\n                }\r\n            }\r\n        });\r\n\r\n        // --- BREAKDOWN ---\r\n        yPos = (doc as any).lastAutoTable.finalY + 15;\r\n        doc.setFontSize(12);\r\n        doc.text(\"DESGLOSE DE COSTES\", 15, yPos);\r\n\r\n        // Prepare breakdown data with VAT calculation\r\n        const breakdownRows = report.breakdown.map(item => {\r\n            const hasIva = [\r\n                'Renting Motos', 'Royalty', 'Gasolina', 'Reparaciones',\r\n                'Servicios Prof.', 'Gestor√≠a', 'PRL', 'Serv. Financieros',\r\n                'Otros Costes', 'App Flyder'\r\n            ].includes(item.name);\r\n            const ivaVal = hasIva ? item.value * 0.21 : 0;\r\n            const total = item.value + ivaVal;\r\n\r\n            return [\r\n                item.name,\r\n                `${formatMoney(item.value)}‚Ç¨`,\r\n                `${formatMoney(ivaVal)}‚Ç¨`,\r\n                `${formatMoney(total)}‚Ç¨`\r\n            ];\r\n        });\r\n\r\n        autoTable(doc, {\r\n            startY: yPos + 5,\r\n            head: [['Concepto', 'Base', 'IVA (Est.)', 'Total']],\r\n            body: breakdownRows,\r\n            theme: 'grid',\r\n            headStyles: { fillColor: [71, 85, 105] },\r\n            styles: { fontSize: 9 },\r\n            columnStyles: {\r\n                1: { halign: 'right' },\r\n                2: { halign: 'right' },\r\n                3: { halign: 'right', fontStyle: 'bold' }\r\n            }\r\n        });\r\n\r\n        // Footer\r\n        const pageHeight = doc.internal.pageSize.height;\r\n        doc.setFontSize(8);\r\n        doc.setTextColor(150);\r\n        doc.text(\"Documento generado autom√°ticamente por REPAART System.\", 15, pageHeight - 10);\r\n\r\n        doc.save(`REPAART_Informe_${month}_${new Date().toISOString().split('T')[0]}.pdf`);\r\n    } catch (error: any) {\r\n        console.error(\"Critical PDF Error:\", error);\r\n        alert(`Error generando el PDF: ${error.message}`);\r\n    }\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\lib\\schemas.d.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":4,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":4,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[93,96],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[93,96],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":5,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":5,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[141,144],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[141,144],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":6,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":6,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[186,189],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[186,189],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { z } from 'zod';\r\n\r\n// Re-export zod types\r\nexport const createUserSchema: z.ZodType<any>;\r\nexport const updateUserSchema: z.ZodType<any>;\r\nexport const financeSchema: z.ZodType<any>;\r\n\r\n// User roles\r\nexport type UserRole = 'admin' | 'franchise' | 'user' | 'driver' | 'staff';\r\n\r\n// Zod type inference helpers\r\nexport type CreateUserInput = z.infer<typeof createUserSchema>;\r\nexport type UpdateUserInput = z.infer<typeof updateUserSchema>;\r\nexport type FinanceInput = z.infer<typeof financeSchema>;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\lib\\schemas.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\lib\\utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\main.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\pages\\DevSandbox.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":7,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":7,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[238,241],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[238,241],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[{"ruleId":"react-hooks/incompatible-library","severity":1,"message":"Compilation Skipped: Use of incompatible library\n\nThis API returns functions which cannot be memoized without leading to stale UI. To prevent this, by default React Compiler will skip memoizing this component/hook. However, you may see issues if values from this API are passed to other components/hooks that are memoized.\n\nC:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\pages\\DevSandbox.tsx:70:50\n  68 |                             <p className=\"mb-2 text-slate-500 uppercase font-bold\">Estado del Formulario (Live):</p>\n  69 |                             {/* eslint-disable-next-line react-hooks/incompatible-library */}\n> 70 |                             <pre>{JSON.stringify(methods.watch(), null, 2)}</pre>\n     |                                                  ^^^^^^^ React Hook Form's `useForm()` API returns a `watch()` function which cannot be memoized safely.\n  71 |                         </div>\n  72 |\n  73 |                     </form>","line":70,"column":50,"nodeType":null,"endLine":70,"endColumn":57,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useForm, FormProvider } from 'react-hook-form';\r\nimport SmartFinanceInput from '../ui/inputs/smart-input/SmartFinanceInput';\r\n\r\ninterface FormValues {\r\n    amount_happy?: number;\r\n    amount_nolabel?: number;\r\n    [key: string]: any;\r\n}\r\n\r\nexport default function DevSandbox() {\r\n    const methods = useForm<FormValues>({\r\n        mode: 'onChange'\r\n    });\r\n\r\n    const onSubmit = (data: FormValues) => {\r\n        console.log(\"Form Data:\", data);\r\n        alert(JSON.stringify(data, null, 2));\r\n    };\r\n\r\n    return (\r\n        <div className=\"min-h-screen bg-slate-50 p-10 font-sans text-slate-900\">\r\n            <div className=\"max-w-2xl mx-auto bg-white rounded-xl shadow-xl border border-slate-200 p-8\">\r\n                <h1 className=\"text-2xl font-bold mb-6 text-slate-800 border-b pb-4\">\r\n                    ‚ò£Ô∏è Zona de Pruebas Nuclear (DevSandbox)\r\n                </h1>\r\n\r\n                <p className=\"mb-6 text-slate-600 text-sm\">\r\n                    Este entorno est√° aislado para probar componentes sin arriesgar el Dashboard.\r\n                    Si el Linter funciona, no deber√≠amos poder romper esto f√°cilmente.\r\n                </p>\r\n\r\n                <FormProvider {...methods}>\r\n                    <form onSubmit={methods.handleSubmit(onSubmit)} className=\"space-y-6\">\r\n\r\n                        {/* TEST CASE 1: Happy Path */}\r\n                        <div className=\"p-4 bg-blue-50 rounded-lg border border-blue-100\">\r\n                            <h3 className=\"text-xs font-bold text-blue-800 mb-3 uppercase tracking-wider\">Test 1: Uso Correcto</h3>\r\n                            <SmartFinanceInput\r\n                                name=\"amount_happy\"\r\n                                label=\"Ingresos (Monto Correcto)\"\r\n                                placeholder=\"0.00\"\r\n                                rules={{\r\n                                    required: \"Este campo es requerido\",\r\n                                    min: { value: 0, message: \"No puede ser negativo\" }\r\n                                }}\r\n                            />\r\n                        </div>\r\n\r\n                        {/* TEST CASE 2: No Label */}\r\n                        <div className=\"p-4 bg-slate-50 rounded-lg border border-slate-100\">\r\n                            <h3 className=\"text-xs font-bold text-slate-800 mb-3 uppercase tracking-wider\">Test 2: Sin Label (Props Opcionales)</h3>\r\n                            <SmartFinanceInput\r\n                                name=\"amount_nolabel\"\r\n                                placeholder=\"Sin label visible\"\r\n                            />\r\n                        </div>\r\n\r\n                        <div className=\"pt-4 border-t flex justify-end\">\r\n                            <button\r\n                                type=\"submit\"\r\n                                className=\"bg-slate-900 hover:bg-slate-800 text-white px-6 py-2 rounded-lg font-medium transition-colors shadow-lg\"\r\n                            >\r\n                                Probar Submit\r\n                            </button>\r\n                        </div>\r\n\r\n                        <div className=\"mt-8 p-4 bg-slate-900 rounded-lg font-mono text-xs text-green-400\">\r\n                            <p className=\"mb-2 text-slate-500 uppercase font-bold\">Estado del Formulario (Live):</p>\r\n                            {/* eslint-disable-next-line react-hooks/incompatible-library */}\r\n                            <pre>{JSON.stringify(methods.watch(), null, 2)}</pre>\r\n                        </div>\r\n\r\n                    </form>\r\n                </FormProvider>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\schemas\\fleet.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\schemas\\scheduler.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\schemas\\users.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\scripts\\actionHistory.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":6,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":6,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[151,154],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[151,154],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":46,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":46,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1222,1225],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1222,1225],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export interface HistoryAction {\r\n    id: string;\r\n    name: string;\r\n    timestamp: Date;\r\n    status: 'success' | 'error' | 'running';\r\n    result?: any;\r\n    error?: string;\r\n    duration?: number;\r\n}\r\n\r\nconst HISTORY_KEY = 'dev_tools_history';\r\nconst MAX_HISTORY_SIZE = 10;\r\n\r\n/**\r\n * A√±ade una acci√≥n al historial\r\n */\r\nexport function addToHistory(action: Omit<HistoryAction, 'id' | 'timestamp'>): HistoryAction {\r\n    const newAction: HistoryAction = {\r\n        ...action,\r\n        id: Math.random().toString(36).substr(2, 9),\r\n        timestamp: new Date()\r\n    };\r\n\r\n    const history = getHistory();\r\n    const updatedHistory = [newAction, ...history].slice(0, MAX_HISTORY_SIZE);\r\n\r\n    try {\r\n        localStorage.setItem(HISTORY_KEY, JSON.stringify(updatedHistory));\r\n    } catch (error) {\r\n        console.warn('Failed to save history:', error);\r\n    }\r\n\r\n    return newAction;\r\n}\r\n\r\n/**\r\n * Obtiene el historial completo\r\n */\r\nexport function getHistory(): HistoryAction[] {\r\n    try {\r\n        const stored = localStorage.getItem(HISTORY_KEY);\r\n        if (!stored) return [];\r\n\r\n        const parsed = JSON.parse(stored);\r\n        // Convertir timestamps de string a Date\r\n        return parsed.map((item: any) => ({\r\n            ...item,\r\n            timestamp: new Date(item.timestamp)\r\n        }));\r\n    } catch (error) {\r\n        console.warn('Failed to load history:', error);\r\n        return [];\r\n    }\r\n}\r\n\r\n/**\r\n * Limpia todo el historial\r\n */\r\nexport function clearHistory(): void {\r\n    try {\r\n        localStorage.removeItem(HISTORY_KEY);\r\n    } catch (error) {\r\n        console.warn('Failed to clear history:', error);\r\n    }\r\n}\r\n\r\n/**\r\n * Actualiza una acci√≥n existente en el historial\r\n */\r\nexport function updateHistoryAction(id: string, updates: Partial<HistoryAction>): void {\r\n    const history = getHistory();\r\n    const updatedHistory = history.map(item =>\r\n        item.id === id ? { ...item, ...updates } : item\r\n    );\r\n\r\n    try {\r\n        localStorage.setItem(HISTORY_KEY, JSON.stringify(updatedHistory));\r\n    } catch (error) {\r\n        console.warn('Failed to update history:', error);\r\n    }\r\n}\r\n\r\n/**\r\n * Formatea la duraci√≥n en un formato legible\r\n */\r\nexport function formatDuration(ms: number): string {\r\n    if (ms < 1000) return `${ms}ms`;\r\n    return `${(ms / 1000).toFixed(2)}s`;\r\n}\r\n\r\n/**\r\n * Formatea el timestamp relativo (ej: \"hace 5 minutos\")\r\n */\r\nexport function formatRelativeTime(date: Date): string {\r\n    const now = new Date();\r\n    const diffMs = now.getTime() - date.getTime();\r\n    const diffSec = Math.floor(diffMs / 1000);\r\n    const diffMin = Math.floor(diffSec / 60);\r\n    const diffHour = Math.floor(diffMin / 60);\r\n    const diffDay = Math.floor(diffHour / 24);\r\n\r\n    if (diffSec < 60) return 'Hace un momento';\r\n    if (diffMin < 60) return `Hace ${diffMin}min`;\r\n    if (diffHour < 24) return `Hace ${diffHour}h`;\r\n    return `Hace ${diffDay}d`;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\scripts\\cleanupFranchises.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\scripts\\consoleCapture.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":8,"column":11,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":8,"endColumn":14,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[185,188],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[185,188],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":23,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":23,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[517,520],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[517,520],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":51,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":51,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1291,1294],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1291,1294],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":56,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":56,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1423,1426],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1423,1426],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":61,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":61,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1558,1561],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1558,1561],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":66,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":66,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1694,1697],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1694,1697],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export type LogLevel = 'log' | 'warn' | 'error' | 'info';\r\n\r\nexport interface ConsoleLog {\r\n    id: string;\r\n    level: LogLevel;\r\n    message: string;\r\n    timestamp: Date;\r\n    args: any[];\r\n}\r\n\r\nlet logs: ConsoleLog[] = [];\r\nlet listeners: ((logs: ConsoleLog[]) => void)[] = [];\r\nconst MAX_LOGS = 100;\r\n\r\n// Store original console methods\r\nconst originalConsole = {\r\n    log: console.log,\r\n    warn: console.warn,\r\n    error: console.error,\r\n    info: console.info\r\n};\r\n\r\nfunction createLog(level: LogLevel, args: any[]): ConsoleLog {\r\n    return {\r\n        id: Math.random().toString(36).substr(2, 9),\r\n        level,\r\n        message: args.map(arg => {\r\n            if (typeof arg === 'object') {\r\n                try {\r\n                    return JSON.stringify(arg, null, 2);\r\n                } catch {\r\n                    return String(arg);\r\n                }\r\n            }\r\n            return String(arg);\r\n        }).join(' '),\r\n        timestamp: new Date(),\r\n        args\r\n    };\r\n}\r\n\r\nfunction addLog(log: ConsoleLog) {\r\n    logs = [log, ...logs].slice(0, MAX_LOGS);\r\n    listeners.forEach(listener => listener([...logs]));\r\n}\r\n\r\n/**\r\n * Intercepta console.log/warn/error/info y captura los mensajes\r\n */\r\nexport function startConsoleCapture() {\r\n    console.log = (...args: any[]) => {\r\n        originalConsole.log(...args);\r\n        addLog(createLog('log', args));\r\n    };\r\n\r\n    console.warn = (...args: any[]) => {\r\n        originalConsole.warn(...args);\r\n        addLog(createLog('warn', args));\r\n    };\r\n\r\n    console.error = (...args: any[]) => {\r\n        originalConsole.error(...args);\r\n        addLog(createLog('error', args));\r\n    };\r\n\r\n    console.info = (...args: any[]) => {\r\n        originalConsole.info(...args);\r\n        addLog(createLog('info', args));\r\n    };\r\n}\r\n\r\n/**\r\n * Restaura los m√©todos originales de console\r\n */\r\nexport function stopConsoleCapture() {\r\n    console.log = originalConsole.log;\r\n    console.warn = originalConsole.warn;\r\n    console.error = originalConsole.error;\r\n    console.info = originalConsole.info;\r\n}\r\n\r\n/**\r\n * Obtiene todos los logs capturados\r\n */\r\nexport function getLogs(): ConsoleLog[] {\r\n    return [...logs];\r\n}\r\n\r\n/**\r\n * Limpia todos los logs\r\n */\r\nexport function clearLogs() {\r\n    logs = [];\r\n    listeners.forEach(listener => listener([]));\r\n}\r\n\r\n/**\r\n * Suscribe un listener para recibir actualizaciones de logs\r\n */\r\nexport function subscribeToLogs(listener: (logs: ConsoleLog[]) => void) {\r\n    listeners.push(listener);\r\n    listener([...logs]); // Enviar logs actuales inmediatamente\r\n\r\n    return () => {\r\n        listeners = listeners.filter(l => l !== listener);\r\n    };\r\n}\r\n\r\n/**\r\n * Exporta los logs a un archivo JSON\r\n */\r\nexport function exportLogs() {\r\n    const data = JSON.stringify(logs, null, 2);\r\n    const blob = new Blob([data], { type: 'application/json' });\r\n    const url = URL.createObjectURL(blob);\r\n    const link = document.createElement('a');\r\n    link.href = url;\r\n    link.download = `console-logs-${new Date().toISOString().slice(0, 10)}.json`;\r\n    link.click();\r\n    URL.revokeObjectURL(url);\r\n}\r\n\r\n/**\r\n * Formatea la hora de un log\r\n */\r\nexport function formatLogTime(date: Date): string {\r\n    return date.toLocaleTimeString('es-ES', {\r\n        hour: '2-digit',\r\n        minute: '2-digit',\r\n        second: '2-digit'\r\n    });\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\scripts\\devUtils.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":34,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":34,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1156,1159],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1156,1159],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":35,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":35,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1199,1202],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1199,1202],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":116,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":116,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4039,4042],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4039,4042],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":118,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":118,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4131,4134],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4131,4134],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":155,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":155,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5294,5297],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5294,5297],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":171,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":171,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5759,5762],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5759,5762],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":235,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":235,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7733,7736],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7733,7736],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":236,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":236,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7785,7788],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7785,7788],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":237,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":237,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7880,7883],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7880,7883],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":238,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":238,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7976,7979],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7976,7979],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":243,"column":73,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":243,"endColumn":76,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8171,8174],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8171,8174],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":11,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { db } from '../lib/firebase';\r\nimport { collection, getDocs } from 'firebase/firestore';\r\n\r\n/**\r\n * Herramienta: Verificar Integridad de Datos\r\n * \r\n * Qu√© hace:\r\n * - Verifica que todos los registros en financial_summaries tengan un usuario v√°lido\r\n * - Detecta datos hu√©rfanos (sin franquicia asociada)\r\n * - Identifica inconsistencias en los datos\r\n * \r\n * Cu√°ndo usar:\r\n * - Despu√©s de migraciones de datos\r\n * - Si sospechas que hay datos corruptos\r\n * - Como auditor√≠a mensual\r\n */\r\nexport async function verifyDataIntegrity() {\r\n    console.log('üîç Verificando integridad de datos...\\n');\r\n\r\n    const issues: string[] = [];\r\n\r\n    // 1. Obtener todas las franquicias v√°lidas\r\n    const usersSnapshot = await getDocs(collection(db, 'users'));\r\n    const validFranchiseIds = new Set(\r\n        usersSnapshot.docs\r\n            .filter(doc => doc.data().role === 'franchise')\r\n            .map(doc => doc.id)\r\n    );\r\n\r\n    console.log(`‚úÖ Franquicias v√°lidas: ${validFranchiseIds.size}`);\r\n\r\n    // 2. Verificar financial_summaries\r\n    const summariesSnapshot = await getDocs(collection(db, 'financial_summaries'));\r\n    const orphanedRecords: any[] = [];\r\n    const invalidDataRecords: any[] = [];\r\n\r\n    summariesSnapshot.docs.forEach(doc => {\r\n        const data = doc.data();\r\n        const franchiseId = data.franchiseId;\r\n\r\n        // Check 1: Franquicia existe?\r\n        if (!validFranchiseIds.has(franchiseId) && franchiseId !== 'Madrid Centro' && franchiseId !== 'Sevilla') {\r\n            orphanedRecords.push({\r\n                id: doc.id,\r\n                franchiseId,\r\n                month: data.month\r\n            });\r\n        }\r\n\r\n        // Check 2: Datos v√°lidos?\r\n        if (!data.month || (!data.totalIncome && !data.revenue)) {\r\n            invalidDataRecords.push({\r\n                id: doc.id,\r\n                reason: !data.month ? 'Sin mes' : 'Sin ingresos',\r\n                data\r\n            });\r\n        }\r\n    });\r\n\r\n    // 3. Reportar issues\r\n    if (orphanedRecords.length > 0) {\r\n        issues.push(`‚ùå ${orphanedRecords.length} registros hu√©rfanos encontrados`);\r\n        console.log('\\n‚ùå Registros hu√©rfanos:');\r\n        orphanedRecords.forEach(r => console.log(`   - ${r.id} (${r.franchiseId})`));\r\n    }\r\n\r\n    if (invalidDataRecords.length > 0) {\r\n        issues.push(`‚ö†Ô∏è  ${invalidDataRecords.length} registros con datos inv√°lidos`);\r\n        console.log('\\n‚ö†Ô∏è  Registros con datos inv√°lidos:');\r\n        invalidDataRecords.forEach(r => console.log(`   - ${r.id}: ${r.reason}`));\r\n    }\r\n\r\n    if (issues.length === 0) {\r\n        console.log('\\n‚úÖ ¬°Integridad de datos verificada! No se encontraron problemas.');\r\n    } else {\r\n        console.log('\\nüìã Resumen de problemas:');\r\n        issues.forEach(issue => console.log(`   ${issue}`));\r\n    }\r\n\r\n    return {\r\n        valid: issues.length === 0,\r\n        issues,\r\n        orphanedCount: orphanedRecords.length,\r\n        invalidCount: invalidDataRecords.length,\r\n        totalRecords: summariesSnapshot.docs.length\r\n    };\r\n}\r\n\r\n/**\r\n * Herramienta: Exportar Estado de la Aplicaci√≥n\r\n * \r\n * Qu√© hace:\r\n * - Captura el estado completo de la aplicaci√≥n\r\n * - Incluye datos de usuario, queries activas, errores\r\n * - Genera un snapshot para debugging\r\n * \r\n * Cu√°ndo usar:\r\n * - Para reportar bugs\r\n * - Cuando algo \"no funciona\" sin error claro\r\n * - Para compartir con soporte t√©cnico\r\n */\r\nexport function captureAppState() {\r\n    const state = {\r\n        timestamp: new Date().toISOString(),\r\n        url: window.location.href,\r\n        userAgent: navigator.userAgent,\r\n        online: navigator.onLine,\r\n        localStorage: Object.keys(localStorage).reduce((acc, key) => {\r\n            acc[key] = localStorage.getItem(key);\r\n            return acc;\r\n        }, {} as Record<string, string | null>),\r\n        sessionStorage: Object.keys(sessionStorage).reduce((acc, key) => {\r\n            acc[key] = sessionStorage.getItem(key);\r\n            return acc;\r\n        }, {} as Record<string, string | null>),\r\n        errors: (window as any).__RUNTIME_ERRORS__ || [],\r\n        performance: {\r\n            memory: (performance as any).memory,\r\n            navigation: performance.getEntriesByType('navigation')[0],\r\n            timing: performance.timing\r\n        }\r\n    };\r\n\r\n    console.log('üì∏ Estado de la aplicaci√≥n capturado:', state);\r\n\r\n    // Crear archivo descargable\r\n    const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });\r\n    const url = URL.createObjectURL(blob);\r\n    const a = document.createElement('a');\r\n    a.href = url;\r\n    a.download = `app-state-${Date.now()}.json`;\r\n    a.click();\r\n    URL.revokeObjectURL(url);\r\n\r\n    return state;\r\n}\r\n\r\n/**\r\n * Herramienta: Auditor√≠a Financiera\r\n * \r\n * Qu√© hace:\r\n * - Verifica que los totales calculados coincidan con los datos guardados\r\n * - Detecta discrepancias en las sumas\r\n * - Valida que todos los meses tengan datos coherentes\r\n * \r\n * Cu√°ndo usar:\r\n * - Si los n√∫meros \"no cuadran\"\r\n * - Antes de cerrar un periodo fiscal\r\n * - Como validaci√≥n mensual\r\n */\r\nexport async function financialAudit() {\r\n    console.log('üí∞ Iniciando auditor√≠a financiera...\\n');\r\n\r\n    const summariesSnapshot = await getDocs(collection(db, 'financial_summaries'));\r\n    const byMonth = new Map<string, any[]>();\r\n\r\n    summariesSnapshot.docs.forEach(doc => {\r\n        const data = doc.data();\r\n        const month = data.month;\r\n        if (!byMonth.has(month)) {\r\n            byMonth.set(month, []);\r\n        }\r\n        byMonth.get(month)!.push({\r\n            id: doc.id,\r\n            franchiseId: data.franchiseId,\r\n            income: data.totalIncome || data.revenue || 0,\r\n            expenses: data.totalExpenses || 0\r\n        });\r\n    });\r\n\r\n    const report: any[] = [];\r\n\r\n    byMonth.forEach((records, month) => {\r\n        const totalIncome = records.reduce((sum, r) => sum + r.income, 0);\r\n        const totalExpenses = records.reduce((sum, r) => sum + r.expenses, 0);\r\n        const profit = totalIncome - totalExpenses;\r\n        const margin = totalIncome > 0 ? (profit / totalIncome) * 100 : 0;\r\n\r\n        report.push({\r\n            month,\r\n            franchises: records.length,\r\n            totalIncome,\r\n            totalExpenses,\r\n            profit,\r\n            margin: margin.toFixed(2) + '%',\r\n            franchiseDetails: records\r\n        });\r\n    });\r\n\r\n    // Ordenar por mes (m√°s reciente primero)\r\n    report.sort((a, b) => b.month.localeCompare(a.month));\r\n\r\n    console.log('üìä Reporte de auditor√≠a:');\r\n    report.forEach(r => {\r\n        console.log(`\\n${r.month}:`);\r\n        console.log(`  Franquicias: ${r.franchises}`);\r\n        console.log(`  Ingresos: ${r.totalIncome.toLocaleString()}‚Ç¨`);\r\n        console.log(`  Gastos: ${r.totalExpenses.toLocaleString()}‚Ç¨`);\r\n        console.log(`  Beneficio: ${r.profit.toLocaleString()}‚Ç¨`);\r\n        console.log(`  Margen: ${r.margin}`);\r\n    });\r\n\r\n    return report;\r\n}\r\n\r\n/**\r\n * Herramienta: Monitor de Performance\r\n * \r\n * Qu√© hace:\r\n * - Mide tiempo de carga de componentes clave\r\n * - Detecta queries lentas de Firestore\r\n * - Identifica cuellos de botella\r\n * \r\n * Cu√°ndo usar:\r\n * - Si la aplicaci√≥n se siente lenta\r\n * - Para optimizar rendimiento\r\n * - Como benchmark antes/despu√©s de cambios\r\n */\r\nexport function runPerformanceCheck() {\r\n    console.log('‚ö° Ejecutando check de performance...\\n');\r\n\r\n    const metrics = {\r\n        pageLoad: {\r\n            domContentLoaded: 0,\r\n            loadComplete: 0,\r\n            firstPaint: 0,\r\n            firstContentfulPaint: 0\r\n        },\r\n        resources: {\r\n            scripts: 0,\r\n            stylesheets: 0,\r\n            images: 0,\r\n            total: 0\r\n        },\r\n        memory: (performance as any).memory ? {\r\n            used: ((performance as any).memory.usedJSHeapSize / 1048576).toFixed(2) + ' MB',\r\n            total: ((performance as any).memory.totalJSHeapSize / 1048576).toFixed(2) + ' MB',\r\n            limit: ((performance as any).memory.jsHeapSizeLimit / 1048576).toFixed(2) + ' MB'\r\n        } : 'No disponible'\r\n    };\r\n\r\n    // Page load timing\r\n    const navigation = performance.getEntriesByType('navigation')[0] as any;\r\n    if (navigation) {\r\n        metrics.pageLoad.domContentLoaded = navigation.domContentLoadedEventEnd - navigation.fetchStart;\r\n        metrics.pageLoad.loadComplete = navigation.loadEventEnd - navigation.fetchStart;\r\n    }\r\n\r\n    // Paint timing\r\n    const paintEntries = performance.getEntriesByType('paint');\r\n    paintEntries.forEach(entry => {\r\n        if (entry.name === 'first-paint') {\r\n            metrics.pageLoad.firstPaint = entry.startTime;\r\n        } else if (entry.name === 'first-contentful-paint') {\r\n            metrics.pageLoad.firstContentfulPaint = entry.startTime;\r\n        }\r\n    });\r\n\r\n    // Resource counts\r\n    const resources = performance.getEntriesByType('resource');\r\n    metrics.resources.total = resources.length;\r\n    metrics.resources.scripts = resources.filter(r => r.name.endsWith('.js')).length;\r\n    metrics.resources.stylesheets = resources.filter(r => r.name.endsWith('.css')).length;\r\n    metrics.resources.images = resources.filter(r => /\\.(jpg|jpeg|png|gif|svg|webp)/.test(r.name)).length;\r\n\r\n    console.log('üìä M√©tricas de Performance:');\r\n    console.log('\\n‚è±Ô∏è  Tiempos de Carga:');\r\n    console.log(`  DOM Ready: ${metrics.pageLoad.domContentLoaded.toFixed(0)}ms`);\r\n    console.log(`  Load Complete: ${metrics.pageLoad.loadComplete.toFixed(0)}ms`);\r\n    console.log(`  First Paint: ${metrics.pageLoad.firstPaint.toFixed(0)}ms`);\r\n    console.log(`  FCP: ${metrics.pageLoad.firstContentfulPaint.toFixed(0)}ms`);\r\n\r\n    console.log('\\nüì¶ Recursos Cargados:');\r\n    console.log(`  Scripts: ${metrics.resources.scripts}`);\r\n    console.log(`  Hojas de estilo: ${metrics.resources.stylesheets}`);\r\n    console.log(`  Im√°genes: ${metrics.resources.images}`);\r\n    console.log(`  Total: ${metrics.resources.total}`);\r\n\r\n    console.log('\\nüíæ Uso de Memoria:');\r\n    console.log(metrics.memory);\r\n\r\n    // Recomendaciones\r\n    console.log('\\nüí° Recomendaciones:');\r\n    if (metrics.pageLoad.loadComplete > 3000) {\r\n        console.log('  ‚ö†Ô∏è  Tiempo de carga elevado (>3s). Considera optimizar.');\r\n    }\r\n    if (metrics.resources.total > 100) {\r\n        console.log('  ‚ö†Ô∏è  Muchos recursos cargados. Considera code-splitting.');\r\n    }\r\n\r\n    return metrics;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\scripts\\executeCleanup.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":28,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":28,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[919,922],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[919,922],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":29,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":29,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[950,953],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[950,953],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { db } from '../lib/firebase';\r\nimport { collection, getDocs, writeBatch } from 'firebase/firestore';\r\n\r\n/**\r\n * Script para eliminar datos hu√©rfanos de financial_summaries\r\n * \r\n * DATOS A ELIMINAR:\r\n * - Madrid Centro (sin usuario asociado)\r\n * - Sevilla (sin usuario asociado)\r\n * \r\n * DATOS A MANTENER:\r\n * - IAvDv9ZdFzWgF0osu986OCYWu0A3 (franquicia3@repaart.es)\r\n * - S5DLjXdrAyfQxDGbLsARIp1sufD3 (franquicia4@repaart.es)\r\n */\r\n\r\nexport async function cleanupOrphanedFinancialData() {\r\n    console.log('üßπ Iniciando limpieza de datos hu√©rfanos...\\n');\r\n\r\n    const ORPHANED_IDS = ['Madrid Centro', 'Sevilla'];\r\n    const VALID_IDS = [\r\n        'IAvDv9ZdFzWgF0osu986OCYWu0A3',  // franquicia3\r\n        'S5DLjXdrAyfQxDGbLsARIp1sufD3'   // franquicia4\r\n    ];\r\n\r\n    // 1. Buscar documentos a eliminar\r\n    const summariesSnapshot = await getDocs(collection(db, 'financial_summaries'));\r\n\r\n    const toDelete: any[] = [];\r\n    const toKeep: any[] = [];\r\n\r\n    summariesSnapshot.docs.forEach(doc => {\r\n        const franchiseId = doc.data().franchiseId;\r\n        const docData = {\r\n            id: doc.id,\r\n            franchiseId,\r\n            month: doc.data().month,\r\n            totalIncome: doc.data().totalIncome || doc.data().revenue\r\n        };\r\n\r\n        if (ORPHANED_IDS.includes(franchiseId)) {\r\n            toDelete.push({ ref: doc.ref, ...docData });\r\n        } else if (VALID_IDS.includes(franchiseId)) {\r\n            toKeep.push(docData);\r\n        } else {\r\n            console.warn(`‚ö†Ô∏è  Documento con franchiseId desconocido: ${franchiseId}`);\r\n        }\r\n    });\r\n\r\n    console.log(`üìä Resumen de limpieza:`);\r\n    console.log(`   ‚úÖ A mantener: ${toKeep.length} documentos`);\r\n    console.log(`   ‚ùå A eliminar: ${toDelete.length} documentos\\n`);\r\n\r\n    console.log('üìã Documentos a eliminar:');\r\n    toDelete.forEach(d => {\r\n        console.log(`   - ${d.id} (${d.franchiseId}, ${d.month})`);\r\n    });\r\n\r\n    console.log('\\nüìã Documentos a mantener:');\r\n    toKeep.forEach(d => {\r\n        console.log(`   - ${d.id} (${d.franchiseId}, ${d.month})`);\r\n    });\r\n\r\n    // 2. Ejecutar eliminaci√≥n\r\n    if (toDelete.length === 0) {\r\n        console.log('\\n‚úÖ No hay datos hu√©rfanos para eliminar');\r\n        return { deleted: 0, kept: toKeep.length };\r\n    }\r\n\r\n    console.log('\\n‚ö†Ô∏è  ¬øProceder con la eliminaci√≥n?');\r\n    console.log('   Los datos se eliminar√°n PERMANENTEMENTE');\r\n\r\n    return {\r\n        toDelete,\r\n        toKeep,\r\n        summary: {\r\n            willDelete: toDelete.length,\r\n            willKeep: toKeep.length\r\n        },\r\n        execute: async () => {\r\n            console.log('\\nüóëÔ∏è  Ejecutando eliminaci√≥n...');\r\n\r\n            const batch = writeBatch(db);\r\n\r\n            toDelete.forEach(item => {\r\n                batch.delete(item.ref);\r\n            });\r\n\r\n            await batch.commit();\r\n\r\n            console.log(`\\n‚úÖ Eliminados ${toDelete.length} documentos hu√©rfanos`);\r\n            console.log(`‚úÖ Mantenidos ${toKeep.length} documentos v√°lidos`);\r\n\r\n            // Verificaci√≥n\r\n            const afterSnapshot = await getDocs(collection(db, 'financial_summaries'));\r\n            console.log(`\\nüìä Total documentos despu√©s de limpieza: ${afterSnapshot.docs.length}`);\r\n\r\n            return {\r\n                deleted: toDelete.length,\r\n                kept: toKeep.length,\r\n                totalAfter: afterSnapshot.docs.length\r\n            };\r\n        }\r\n    };\r\n}\r\n\r\n// Wrapper para usar desde bot√≥n\r\nexport async function executeCleanup() {\r\n    const result = await cleanupOrphanedFinancialData();\r\n\r\n    if (result.execute) {\r\n        console.log('\\nüöÄ Ejecutando limpieza autom√°tica...');\r\n        return await result.execute();\r\n    }\r\n\r\n    return result;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\scripts\\favorites.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\scripts\\firestoreMonitor.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\scripts\\healthCheck.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":121,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":121,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { db, auth } from '../lib/firebase';\r\nimport { collection, getDocs, limit, query } from 'firebase/firestore';\r\n\r\nexport interface HealthCheckResult {\r\n    status: 'healthy' | 'warning' | 'critical';\r\n    checks: HealthCheck[];\r\n    timestamp: Date;\r\n}\r\n\r\nexport interface HealthCheck {\r\n    name: string;\r\n    status: 'pass' | 'warning' | 'fail';\r\n    message: string;\r\n    details?: string;\r\n}\r\n\r\n/**\r\n * Ejecuta verificaciones de salud del sistema\r\n */\r\nexport async function runHealthCheck(): Promise<HealthCheckResult> {\r\n    const checks: HealthCheck[] = [];\r\n\r\n    // 1. Firestore Connection\r\n    try {\r\n        await getDocs(query(collection(db, 'users'), limit(1)));\r\n        checks.push({\r\n            name: 'Firestore Connection',\r\n            status: 'pass',\r\n            message: 'Conectado correctamente'\r\n        });\r\n    } catch (error) {\r\n        checks.push({\r\n            name: 'Firestore Connection',\r\n            status: 'fail',\r\n            message: 'Error de conexi√≥n',\r\n            details: error instanceof Error ? error.message : String(error)\r\n        });\r\n    }\r\n\r\n    // 2. Authentication\r\n    if (auth.currentUser) {\r\n        checks.push({\r\n            name: 'Authentication',\r\n            status: 'pass',\r\n            message: `Usuario: ${auth.currentUser.email}`\r\n        });\r\n    } else {\r\n        checks.push({\r\n            name: 'Authentication',\r\n            status: 'fail',\r\n            message: 'No hay usuario autenticado'\r\n        });\r\n    }\r\n\r\n    // 3. Franchises Data\r\n    try {\r\n        const franchisesQuery = query(collection(db, 'users'));\r\n        const snapshot = await getDocs(franchisesQuery);\r\n        const franchiseCount = snapshot.docs.filter(doc => doc.data().role === 'franchise').length;\r\n\r\n        if (franchiseCount > 0) {\r\n            checks.push({\r\n                name: 'Franchises Data',\r\n                status: 'pass',\r\n                message: `${franchiseCount} franquicia(s) encontrada(s)`\r\n            });\r\n        } else {\r\n            checks.push({\r\n                name: 'Franchises Data',\r\n                status: 'warning',\r\n                message: 'No se encontraron franquicias',\r\n                details: 'Verifica que existan usuarios con role=\"franchise\"'\r\n            });\r\n        }\r\n    } catch (error) {\r\n        checks.push({\r\n            name: 'Franchises Data',\r\n            status: 'fail',\r\n            message: 'Error al cargar franquicias',\r\n            details: error instanceof Error ? error.message : String(error)\r\n        });\r\n    }\r\n\r\n    // 4. Financial Summaries\r\n    try {\r\n        const summariesSnapshot = await getDocs(collection(db, 'financial_summaries'));\r\n        const count = summariesSnapshot.docs.length;\r\n\r\n        if (count > 0) {\r\n            checks.push({\r\n                name: 'Financial Data',\r\n                status: 'pass',\r\n                message: `${count} registros financieros`\r\n            });\r\n        } else {\r\n            checks.push({\r\n                name: 'Financial Data',\r\n                status: 'warning',\r\n                message: 'No hay datos financieros'\r\n            });\r\n        }\r\n    } catch (error) {\r\n        checks.push({\r\n            name: 'Financial Data',\r\n            status: 'fail',\r\n            message: 'Error al cargar datos financieros',\r\n            details: error instanceof Error ? error.message : String(error)\r\n        });\r\n    }\r\n\r\n    // 5. LocalStorage\r\n    try {\r\n        const testKey = '__health_check_test__';\r\n        localStorage.setItem(testKey, 'test');\r\n        localStorage.removeItem(testKey);\r\n        checks.push({\r\n            name: 'LocalStorage',\r\n            status: 'pass',\r\n            message: 'Funcionando correctamente'\r\n        });\r\n    } catch (error) {\r\n        checks.push({\r\n            name: 'LocalStorage',\r\n            status: 'warning',\r\n            message: 'No disponible',\r\n            details: 'Modo inc√≥gnito o bloqueado'\r\n        });\r\n    }\r\n\r\n    // 6. Network Status\r\n    if (navigator.onLine) {\r\n        checks.push({\r\n            name: 'Network',\r\n            status: 'pass',\r\n            message: 'Conectado'\r\n        });\r\n    } else {\r\n        checks.push({\r\n            name: 'Network',\r\n            status: 'fail',\r\n            message: 'Sin conexi√≥n a Internet'\r\n        });\r\n    }\r\n\r\n    // Determinar estado general\r\n    const hasFailures = checks.some(c => c.status === 'fail');\r\n    const hasWarnings = checks.some(c => c.status === 'warning');\r\n\r\n    let overallStatus: 'healthy' | 'warning' | 'critical';\r\n    if (hasFailures) {\r\n        overallStatus = 'critical';\r\n    } else if (hasWarnings) {\r\n        overallStatus = 'warning';\r\n    } else {\r\n        overallStatus = 'healthy';\r\n    }\r\n\r\n    return {\r\n        status: overallStatus,\r\n        checks,\r\n        timestamp: new Date()\r\n    };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\scripts\\investigateFinancialData.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":40,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":40,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1389,1392],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1389,1392],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":41,"column":65,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":41,"endColumn":68,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1467,1470],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1467,1470],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":42,"column":60,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":42,"endColumn":63,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1567,1570],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1567,1570],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { db } from '../lib/firebase';\r\nimport { collection, getDocs, query, where } from 'firebase/firestore';\r\n\r\n/**\r\n * Script para investigar los datos en financial_summaries\r\n * Ejecutar desde consola del navegador o mediante un bot√≥n temporal\r\n */\r\nexport async function investigateFinancialData() {\r\n    console.log('üîç Investigando financial_summaries...');\r\n\r\n    // 1. Obtener TODOS los documentos de financial_summaries\r\n    const allQuery = query(collection(db, 'financial_summaries'));\r\n    const allSnapshot = await getDocs(allQuery);\r\n\r\n    console.log(`üìä Total documentos en financial_summaries: ${allSnapshot.docs.length}`);\r\n\r\n    // 2. Agrupar por mes\r\n    const byMonth = new Map();\r\n\r\n    allSnapshot.docs.forEach(doc => {\r\n        const data = doc.data();\r\n        const month = data.month || 'sin-mes';\r\n\r\n        if (!byMonth.has(month)) {\r\n            byMonth.set(month, []);\r\n        }\r\n\r\n        byMonth.get(month).push({\r\n            id: doc.id,\r\n            franchiseId: data.franchiseId,\r\n            totalIncome: data.totalIncome || data.revenue || 0,\r\n            totalExpenses: data.totalExpenses || 0\r\n        });\r\n    });\r\n\r\n    // 3. Mostrar resumen por mes\r\n    console.log('\\nüìÖ Datos por mes:');\r\n    Array.from(byMonth.entries())\r\n        .sort(([a], [b]) => b.localeCompare(a)) // M√°s reciente primero\r\n        .forEach(([month, records]: [string, any[]]) => {\r\n            const totalIncome = records.reduce((sum: number, r: any) => sum + (r.totalIncome || 0), 0);\r\n            const franchises = [...new Set(records.map((r: any) => r.franchiseId))];\r\n\r\n            console.log(`\\n${month}:`);\r\n            console.log(`  - Registros: ${records.length}`);\r\n            console.log(`  - Franquicias √∫nicas: ${franchises.length}`);\r\n            console.log(`  - Total ingresos: ${totalIncome.toLocaleString()}‚Ç¨`);\r\n            console.log(`  - Detalles:`, records);\r\n        });\r\n\r\n    // 4. Buscar espec√≠ficamente 2026-01\r\n    console.log('\\nüéØ Buscando espec√≠ficamente mes 2026-01:');\r\n    const jan2026Query = query(\r\n        collection(db, 'financial_summaries'),\r\n        where('month', '==', '2026-01')\r\n    );\r\n    const jan2026Snapshot = await getDocs(jan2026Query);\r\n\r\n    console.log(`Encontrados ${jan2026Snapshot.docs.length} registros para 2026-01:`);\r\n    jan2026Snapshot.docs.forEach(doc => {\r\n        const data = doc.data();\r\n        console.log({\r\n            id: doc.id,\r\n            franchiseId: data.franchiseId,\r\n            totalIncome: data.totalIncome || data.revenue,\r\n            totalExpenses: data.totalExpenses,\r\n            allData: data\r\n        });\r\n    });\r\n\r\n    return {\r\n        totalDocs: allSnapshot.docs.length,\r\n        byMonth: Object.fromEntries(byMonth),\r\n        jan2026Count: jan2026Snapshot.docs.length\r\n    };\r\n}\r\n\r\n// Para ejecutar desde consola:\r\n// import { investigateFinancialData } from './scripts/investigateFinancialData';\r\n// investigateFinancialData();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\scripts\\migrateFranchiseIds.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":178,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":178,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6362,6365],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6362,6365],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":248,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":248,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8401,8404],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8401,8404],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":288,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":288,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9844,9847],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9844,9847],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":289,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":289,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9908,9911],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9908,9911],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\n/**\r\n * MIGRATION SCRIPT: FranchiseId Custom ‚Üí UID\r\n * \r\n * Purpose: Update all Firestore collections to use user UIDs as franchise identifiers\r\n * instead of custom franchiseId strings like 'SEVILLA'\r\n * \r\n * Collections affected:\r\n * - financial_records (franchise_id field)\r\n * - shifts (franchiseId field)\r\n * - motos (franchise_id field)\r\n * - riders (franchise_id field)\r\n * \r\n * HOW TO RUN:\r\n * 1. Open browser console on https://repaartfinanzas.web.app\r\n * 2. Copy-paste this entire script\r\n * 3. Run: await migrateFranchiseIds()\r\n * 4. Confirm when prompted\r\n * \r\n * SAFETY FEATURES:\r\n * - Dry-run mode to preview changes\r\n * - Detailed logging\r\n * - Backup recommendations\r\n * - Can be run multiple times safely (idempotent)\r\n */\r\n\r\nimport { db } from '../lib/firebase';\r\nimport { collection, getDocs, doc, query, where, writeBatch } from 'firebase/firestore';\r\n\r\ninterface MigrationMapping {\r\n    uid: string;\r\n    franchiseId: string;\r\n    displayName: string;\r\n    email: string;\r\n}\r\n\r\ninterface MigrationResult {\r\n    success: boolean;\r\n    mappings: MigrationMapping[];\r\n    updated: {\r\n        financial_records: number;\r\n        shifts: number;\r\n        motos: number;\r\n        riders: number;\r\n    };\r\n    errors: string[];\r\n}\r\n\r\n/**\r\n * Main migration function\r\n */\r\nexport async function migrateFranchiseIds(dryRun: boolean = true): Promise<MigrationResult> {\r\n    console.log('üöÄ Starting FranchiseId Migration Script...');\r\n    console.log(`Mode: ${dryRun ? 'DRY RUN (no changes)' : 'LIVE (will update data)'}`);\r\n\r\n    const result: MigrationResult = {\r\n        success: false,\r\n        mappings: [],\r\n        updated: {\r\n            financial_records: 0,\r\n            shifts: 0,\r\n            motos: 0,\r\n            riders: 0\r\n        },\r\n        errors: []\r\n    };\r\n\r\n    try {\r\n        // =====================================================\r\n        // STEP 1: Build UID ‚Üî franchiseId mapping\r\n        // =====================================================\r\n        console.log('\\nüìã Step 1: Building UID mapping from users collection...');\r\n\r\n        const usersSnapshot = await getDocs(collection(db, 'users'));\r\n        const franchiseUsers = usersSnapshot.docs.filter(doc => {\r\n            const data = doc.data();\r\n            return data.role === 'franchise' && data.franchiseId;\r\n        });\r\n\r\n        console.log(`Found ${franchiseUsers.length} franchise users with custom franchiseId`);\r\n\r\n        franchiseUsers.forEach(userDoc => {\r\n            const data = userDoc.data();\r\n            const mapping: MigrationMapping = {\r\n                uid: userDoc.id,\r\n                franchiseId: data.franchiseId,\r\n                displayName: data.displayName || data.name || 'Unknown',\r\n                email: data.email || 'Unknown'\r\n            };\r\n            result.mappings.push(mapping);\r\n            console.log(`  ‚úì ${mapping.franchiseId} ‚Üí ${mapping.uid} (${mapping.email})`);\r\n        });\r\n\r\n        if (result.mappings.length === 0) {\r\n            console.log('‚ö†Ô∏è  No franchise users with custom franchiseId found. Nothing to migrate.');\r\n            result.success = true;\r\n            return result;\r\n        }\r\n\r\n        // =====================================================\r\n        // STEP 2: Migrate financial_records collection\r\n        // =====================================================\r\n        console.log('\\nüí∞ Step 2: Migrating financial_records...');\r\n        for (const mapping of result.mappings) {\r\n            const count = await migrateCollection(\r\n                'financial_records',\r\n                'franchise_id',\r\n                mapping.franchiseId,\r\n                mapping.uid,\r\n                dryRun\r\n            );\r\n            result.updated.financial_records += count;\r\n        }\r\n\r\n        // =====================================================\r\n        // STEP 3: Migrate shifts collection\r\n        // =====================================================\r\n        console.log('\\nüìÖ Step 3: Migrating shifts...');\r\n        for (const mapping of result.mappings) {\r\n            const count = await migrateCollection(\r\n                'shifts',\r\n                'franchiseId',\r\n                mapping.franchiseId,\r\n                mapping.uid,\r\n                dryRun\r\n            );\r\n            result.updated.shifts += count;\r\n        }\r\n\r\n        // =====================================================\r\n        // STEP 4: Migrate motos collection\r\n        // =====================================================\r\n        console.log('\\nüèçÔ∏è  Step 4: Migrating motos...');\r\n        for (const mapping of result.mappings) {\r\n            const count = await migrateCollection(\r\n                'motos',\r\n                'franchise_id',\r\n                mapping.franchiseId,\r\n                mapping.uid,\r\n                dryRun\r\n            );\r\n            result.updated.motos += count;\r\n        }\r\n\r\n        // =====================================================\r\n        // STEP 5: Migrate riders collection\r\n        // =====================================================\r\n        console.log('\\nüë§ Step 5: Migrating riders...');\r\n        for (const mapping of result.mappings) {\r\n            const count = await migrateCollection(\r\n                'riders',\r\n                'franchise_id',\r\n                mapping.franchiseId,\r\n                mapping.uid,\r\n                dryRun\r\n            );\r\n            result.updated.riders += count;\r\n        }\r\n\r\n        // =====================================================\r\n        // FINAL SUMMARY\r\n        // =====================================================\r\n        console.log('\\n‚úÖ Migration completed successfully!');\r\n        console.log('\\nüìä Summary:');\r\n        console.log(`  Financial Records: ${result.updated.financial_records}`);\r\n        console.log(`  Shifts: ${result.updated.shifts}`);\r\n        console.log(`  Motos: ${result.updated.motos}`);\r\n        console.log(`  Riders: ${result.updated.riders}`);\r\n        console.log(`  Total: ${Object.values(result.updated).reduce((a, b) => a + b, 0)} documents updated`);\r\n\r\n        if (dryRun) {\r\n            console.log('\\n‚ö†Ô∏è  This was a DRY RUN. No data was actually changed.');\r\n            console.log('To execute the migration, run: await migrateFranchiseIds(false)');\r\n        }\r\n\r\n        result.success = true;\r\n\r\n    } catch (error: any) {\r\n        console.error('‚ùå Migration failed:', error);\r\n        result.errors.push(error.message);\r\n        result.success = false;\r\n    }\r\n\r\n    return result;\r\n}\r\n\r\n/**\r\n * Helper function to migrate a specific collection\r\n */\r\nasync function migrateCollection(\r\n    collectionName: string,\r\n    fieldName: string,\r\n    oldValue: string,\r\n    newValue: string,\r\n    dryRun: boolean\r\n): Promise<number> {\r\n    try {\r\n        const q = query(\r\n            collection(db, collectionName),\r\n            where(fieldName, '==', oldValue)\r\n        );\r\n\r\n        const snapshot = await getDocs(q);\r\n        const docsToUpdate = snapshot.docs;\r\n\r\n        console.log(`  Found ${docsToUpdate.length} documents in ${collectionName} with ${fieldName}=\"${oldValue}\"`);\r\n\r\n        if (docsToUpdate.length === 0) {\r\n            return 0;\r\n        }\r\n\r\n        if (dryRun) {\r\n            console.log(`  [DRY RUN] Would update ${docsToUpdate.length} documents`);\r\n            return docsToUpdate.length;\r\n        }\r\n\r\n        // Batch update for efficiency (max 500 per batch)\r\n        const batches = [];\r\n        let currentBatch = writeBatch(db);\r\n        let operationCount = 0;\r\n\r\n        for (const document of docsToUpdate) {\r\n            currentBatch.update(doc(db, collectionName, document.id), {\r\n                [fieldName]: newValue\r\n            });\r\n            operationCount++;\r\n\r\n            if (operationCount === 500) {\r\n                batches.push(currentBatch);\r\n                currentBatch = writeBatch(db);\r\n                operationCount = 0;\r\n            }\r\n        }\r\n\r\n        if (operationCount > 0) {\r\n            batches.push(currentBatch);\r\n        }\r\n\r\n        // Commit all batches\r\n        for (let i = 0; i < batches.length; i++) {\r\n            await batches[i].commit();\r\n            console.log(`  ‚úì Batch ${i + 1}/${batches.length} committed`);\r\n        }\r\n\r\n        console.log(`  ‚úÖ Updated ${docsToUpdate.length} documents in ${collectionName}`);\r\n        return docsToUpdate.length;\r\n\r\n    } catch (error: any) {\r\n        console.error(`  ‚ùå Error migrating ${collectionName}:`, error);\r\n        throw error;\r\n    }\r\n}\r\n\r\n/**\r\n * Verification function to check migration status\r\n */\r\nexport async function verifyMigration(): Promise<void> {\r\n    console.log('üîç Verifying migration status...\\n');\r\n\r\n    const collections = [\r\n        { name: 'financial_records', field: 'franchise_id' },\r\n        { name: 'shifts', field: 'franchiseId' },\r\n        { name: 'motos', field: 'franchise_id' },\r\n        { name: 'riders', field: 'franchise_id' }\r\n    ];\r\n\r\n    for (const col of collections) {\r\n        const snapshot = await getDocs(collection(db, col.name));\r\n        const oldFormat = snapshot.docs.filter(doc => {\r\n            const value = doc.data()[col.field];\r\n            return value && typeof value === 'string' && value.length < 20; // Custom IDs are short\r\n        });\r\n\r\n        const newFormat = snapshot.docs.filter(doc => {\r\n            const value = doc.data()[col.field];\r\n            return value && typeof value === 'string' && value.length > 20; // UIDs are long\r\n        });\r\n\r\n        console.log(`${col.name}:`);\r\n        console.log(`  Old format (custom ID): ${oldFormat.length}`);\r\n        console.log(`  New format (UID): ${newFormat.length}`);\r\n        console.log(`  Total: ${snapshot.docs.length}\\n`);\r\n    }\r\n}\r\n\r\n// Make functions available globally for console use\r\nif (typeof window !== 'undefined') {\r\n    (window as any).migrateFranchiseIds = migrateFranchiseIds;\r\n    (window as any).verifyMigration = verifyMigration;\r\n    console.log('‚úÖ Migration script loaded. Available functions:');\r\n    console.log('  - migrateFranchiseIds(dryRun = true)');\r\n    console.log('  - verifyMigration()');\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\scripts\\networkInterceptor.ts","messages":[{"ruleId":"prefer-const","severity":2,"message":"'method' is never reassigned. Use 'const' instead.","line":12,"column":17,"nodeType":"Identifier","messageId":"useConst","endLine":12,"endColumn":23,"fix":{"range":[487,522],"text":"const method = init?.method || 'GET';"}},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":18,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":18,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[785,788],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[785,788],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":1,"fixableWarningCount":0,"source":"import { logFirestoreQuery } from './firestoreMonitor';\r\n\r\nconst originalFetch = window.fetch;\r\n\r\nexport function startNetworkCapture() {\r\n    window.fetch = async (input: RequestInfo | URL, init?: RequestInit) => {\r\n        const url = typeof input === 'string' ? input : input instanceof URL ? input.toString() : input.url;\r\n\r\n        // Solo interceptar Firestore\r\n        if (url.includes('firestore.googleapis.com')) {\r\n            const startTime = performance.now();\r\n            let method = init?.method || 'GET';\r\n\r\n            // Intentar deducir la operaci√≥n y colecci√≥n de la URL\r\n            // Format: .../databases/(default)/documents/users/UID...\r\n            const pathParts = url.split('/documents/');\r\n            let collection = 'unknown';\r\n            let type: any = 'getDocs';\r\n\r\n            if (pathParts.length > 1) {\r\n                const path = pathParts[1];\r\n                const cleanPath = path.split('?')[0]; // Remove query params\r\n                collection = cleanPath;\r\n\r\n                // Simple heuristic for type\r\n                if (method === 'GET') {\r\n                    type = cleanPath.includes('/') ? 'getDoc' : 'getDocs';\r\n                } else if (method === 'POST') {\r\n                    type = 'addDoc'; // or specific queries\r\n                    // Check if it's a query (runQuery)\r\n                    if (url.includes(':runQuery')) {\r\n                        type = 'getDocs'; // complex query\r\n                    }\r\n                } else if (method === 'PATCH') {\r\n                    type = 'updateDoc';\r\n                } else if (method === 'DELETE') {\r\n                    type = 'deleteDoc';\r\n                }\r\n            }\r\n\r\n            try {\r\n                const response = await originalFetch(input, init);\r\n                const duration = performance.now() - startTime;\r\n\r\n                // Clonar respuesta para contar resultados si es posible\r\n                // Nota: Esto puede ser costoso, as√≠ que lo hacemos con cuidado o solo headers\r\n                // Por ahora solo logueamos status\r\n\r\n                logFirestoreQuery(\r\n                    type,\r\n                    collection,\r\n                    duration,\r\n                    response.ok ? 'success' : 'error',\r\n                    undefined, // resultCount difficult to get without consuming body\r\n                    response.ok ? undefined : `${response.status} ${response.statusText}`\r\n                );\r\n\r\n                return response;\r\n            } catch (error) {\r\n                const duration = performance.now() - startTime;\r\n                logFirestoreQuery(\r\n                    type,\r\n                    collection,\r\n                    duration,\r\n                    'error',\r\n                    0,\r\n                    String(error)\r\n                );\r\n                throw error;\r\n            }\r\n        }\r\n\r\n        return originalFetch(input, init);\r\n    };\r\n}\r\n\r\nexport function stopNetworkCapture() {\r\n    window.fetch = originalFetch;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\scripts\\performanceTracker.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":27,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":27,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[691,694],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[691,694],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":28,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":28,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[743,746],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[743,746],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export interface PerformanceMetrics {\r\n    memory?: {\r\n        usedJSHeapSize: number;\r\n        totalJSHeapSize: number;\r\n        jsHeapSizeLimit: number;\r\n    };\r\n    navigation: {\r\n        ttfb: number; // Time to First Byte\r\n        domLoad: number; // DOM Content Loaded\r\n        windowLoad: number; // Full Page Load\r\n        lcp?: number; // Largest Contentful Paint (estimated)\r\n    };\r\n    resources: ResourceMetric[];\r\n}\r\n\r\nexport interface ResourceMetric {\r\n    name: string;\r\n    type: string;\r\n    duration: number;\r\n    size?: number;\r\n}\r\n\r\n/**\r\n * Obtiene m√©tricas de memoria (si est√°n disponibles en Chrome)\r\n */\r\nexport function getMemoryMetrics() {\r\n    if ((performance as any).memory) {\r\n        const mem = (performance as any).memory;\r\n        return {\r\n            usedJSHeapSize: Math.round(mem.usedJSHeapSize / 1024 / 1024),\r\n            totalJSHeapSize: Math.round(mem.totalJSHeapSize / 1024 / 1024),\r\n            jsHeapSizeLimit: Math.round(mem.jsHeapSizeLimit / 1024 / 1024),\r\n        };\r\n    }\r\n    return undefined;\r\n}\r\n\r\n/**\r\n * Obtiene m√©tricas de navegaci√≥n (Page Load)\r\n */\r\nexport function getNavigationMetrics() {\r\n    const navEntry = performance.getEntriesByType('navigation')[0] as PerformanceNavigationTiming;\r\n\r\n    if (!navEntry) return {\r\n        ttfb: 0,\r\n        domLoad: 0,\r\n        windowLoad: 0\r\n    };\r\n\r\n    return {\r\n        ttfb: Math.round(navEntry.responseStart - navEntry.requestStart),\r\n        domLoad: Math.round(navEntry.domContentLoadedEventEnd),\r\n        windowLoad: Math.round(navEntry.loadEventEnd),\r\n    };\r\n}\r\n\r\n/**\r\n * Obtiene los recursos m√°s lentos cargados\r\n */\r\nexport function getSlowestResources(limit = 10): ResourceMetric[] {\r\n    const resources = performance.getEntriesByType('resource') as PerformanceResourceTiming[];\r\n\r\n    return resources\r\n        .sort((a, b) => b.duration - a.duration)\r\n        .slice(0, limit)\r\n        .map(r => ({\r\n            name: r.name.substring(r.name.lastIndexOf('/') + 1) || r.name, // Solo nombre de archivo si es posible\r\n            type: r.initiatorType,\r\n            duration: Math.round(r.duration),\r\n            size: r.transferSize ? Math.round(r.transferSize / 1024) : undefined // KB\r\n        }));\r\n}\r\n\r\n/**\r\n * Obtiene un resumen completo del rendimiento actual\r\n */\r\nexport function getPerformanceSnapshot(): PerformanceMetrics {\r\n    return {\r\n        memory: getMemoryMetrics(),\r\n        navigation: getNavigationMetrics(),\r\n        resources: getSlowestResources(20)\r\n    };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\services\\academyService.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'id' is assigned a value but never used.","line":97,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":97,"endColumn":27},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'id' is assigned a value but never used.","line":131,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":131,"endColumn":27},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":184,"column":86,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":184,"endColumn":89,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5805,5808],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5805,5808],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { db } from '../lib/firebase';\r\nimport {\r\n    collection, getDocs, query, where, addDoc, doc, updateDoc,\r\n    serverTimestamp, deleteDoc, Timestamp, FieldValue\r\n} from 'firebase/firestore';\r\n\r\nconst COLLECTIONS = {\r\n    COURSES: 'academy_courses',\r\n    LESSONS: 'academy_lessons',\r\n    QUIZZES: 'academy_quizzes',\r\n    PROGRESS: 'academy_progress',\r\n    RESULTS: 'quiz_results'\r\n};\r\n\r\n// --- TYPES ---\r\n\r\nexport interface AcademyCourse {\r\n    id?: string;\r\n    title: string;\r\n    description: string;\r\n    icon?: string;\r\n    category: string;\r\n    duration?: string;\r\n    level?: 'beginner' | 'intermediate' | 'advanced';\r\n    status: 'active' | 'draft' | 'archived';\r\n    order?: number;\r\n    created_at?: Timestamp | FieldValue;\r\n    updated_at?: Timestamp | FieldValue;\r\n}\r\n\r\nexport interface Lesson {\r\n    id?: string;\r\n    moduleId: string; // Links to Course.id\r\n    title: string;\r\n    content: string; // HTML/Markdown\r\n    videoUrl?: string;\r\n    order: number;\r\n    createdAt?: Timestamp | FieldValue;\r\n    updatedAt?: Timestamp | FieldValue;\r\n}\r\n\r\nexport interface QuizQuestion {\r\n    id: string;\r\n    text: string;\r\n    options: string[];\r\n    correctAnswer: number; // Index\r\n}\r\n\r\nexport interface Quiz {\r\n    id?: string;\r\n    moduleId: string;\r\n    questions: QuizQuestion[];\r\n    passingScore: number;\r\n    createdAt?: Timestamp | FieldValue;\r\n    updatedAt?: Timestamp | FieldValue;\r\n}\r\n\r\nexport interface UserProgress {\r\n    id?: string;\r\n    userId: string;\r\n    moduleId: string;\r\n    completedLessons?: string[]; // Lesson IDs\r\n    quizScore?: number;\r\n    status: 'not_started' | 'in_progress' | 'completed';\r\n    lastAccessed?: Timestamp | FieldValue;\r\n    createdAt?: Timestamp | FieldValue;\r\n    updatedAt?: Timestamp | FieldValue;\r\n}\r\n\r\n// --- SERVICE ---\r\n\r\nexport const academyService = {\r\n    // --- COURSES (Admin Managed) ---\r\n\r\n    /**\r\n     * Fetch all available courses (Admin/Public)\r\n     */\r\n    getAllCourses: async (): Promise<AcademyCourse[]> => {\r\n        try {\r\n            const q = query(collection(db, COLLECTIONS.COURSES), where('status', '==', 'active'));\r\n            const snapshot = await getDocs(q);\r\n            return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() } as AcademyCourse));\r\n        } catch (error) {\r\n            console.error(\"Error fetching courses:\", error);\r\n            throw error;\r\n        }\r\n    },\r\n\r\n    /**\r\n     * Create/Update Course (Admin Only)\r\n     */\r\n    saveCourse: async (courseData: AcademyCourse): Promise<string> => {\r\n        try {\r\n            if (courseData.id) {\r\n                const docRef = doc(db, COLLECTIONS.COURSES, courseData.id);\r\n                // Remove id from spread to clean up data\r\n                const { id, ...data } = courseData;\r\n                await updateDoc(docRef, {\r\n                    ...data,\r\n                    updated_at: serverTimestamp()\r\n                });\r\n                return courseData.id;\r\n            } else {\r\n                const docRef = await addDoc(collection(db, COLLECTIONS.COURSES), {\r\n                    ...courseData,\r\n                    status: 'active',\r\n                    created_at: serverTimestamp(),\r\n                    updated_at: serverTimestamp()\r\n                });\r\n                return docRef.id;\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Error saving course:\", error);\r\n            throw error;\r\n        }\r\n    },\r\n\r\n    /**\r\n     * Delete Course (Admin Only)\r\n     */\r\n    deleteCourse: async (courseId: string): Promise<void> => {\r\n        await deleteDoc(doc(db, COLLECTIONS.COURSES, courseId));\r\n    },\r\n\r\n    // --- LESSONS (New) ---\r\n\r\n    saveLesson: async (lessonData: Lesson): Promise<string> => {\r\n        try {\r\n            if (lessonData.id) {\r\n                const docRef = doc(db, COLLECTIONS.LESSONS, lessonData.id);\r\n                const { id, ...data } = lessonData;\r\n                await updateDoc(docRef, {\r\n                    ...data,\r\n                    updatedAt: serverTimestamp()\r\n                });\r\n                return lessonData.id;\r\n            } else {\r\n                const docRef = await addDoc(collection(db, COLLECTIONS.LESSONS), {\r\n                    ...lessonData,\r\n                    createdAt: serverTimestamp()\r\n                });\r\n                return docRef.id;\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Error saving lesson:\", error);\r\n            throw error;\r\n        }\r\n    },\r\n\r\n    deleteLesson: async (lessonId: string): Promise<void> => {\r\n        await deleteDoc(doc(db, COLLECTIONS.LESSONS, lessonId));\r\n    },\r\n\r\n    // --- QUIZZES ---\r\n\r\n    saveQuiz: async (moduleId: string, quizData: Partial<Quiz>): Promise<string> => {\r\n        try {\r\n            // Check if quiz exists for module\r\n            const q = query(collection(db, COLLECTIONS.QUIZZES), where('moduleId', '==', moduleId));\r\n            const snap = await getDocs(q);\r\n\r\n            if (!snap.empty) {\r\n                const id = snap.docs[0].id;\r\n                await updateDoc(doc(db, COLLECTIONS.QUIZZES, id), { ...quizData, updatedAt: serverTimestamp() });\r\n                return id;\r\n            } else {\r\n                const ref = await addDoc(collection(db, COLLECTIONS.QUIZZES), {\r\n                    moduleId,\r\n                    ...quizData,\r\n                    createdAt: serverTimestamp()\r\n                });\r\n                return ref.id;\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Error saving quiz:\", error);\r\n            throw error;\r\n        }\r\n    },\r\n\r\n    deleteQuiz: async (quizId: string): Promise<void> => {\r\n        await deleteDoc(doc(db, COLLECTIONS.QUIZZES, quizId));\r\n    },\r\n\r\n    saveQuizResult: async (userId: string, moduleId: string, score: number, answers: any): Promise<void> => {\r\n        try {\r\n            await addDoc(collection(db, COLLECTIONS.RESULTS), {\r\n                userId, moduleId, score, answers, completedAt: serverTimestamp()\r\n            });\r\n        } catch (error) {\r\n            console.error(\"Error saving result:\", error);\r\n            throw error;\r\n        }\r\n    },\r\n\r\n    // --- PROGRESS (User/Franchise Scope) ---\r\n\r\n    /**\r\n     * Fetch user's progress for all courses\r\n     * @param {string} userId - The user ID to fetch progress for\r\n     */\r\n    getUserProgress: async (userId: string): Promise<Record<string, UserProgress>> => {\r\n        try {\r\n            const q = query(collection(db, COLLECTIONS.PROGRESS), where('userId', '==', userId));\r\n            const snapshot = await getDocs(q);\r\n            // Return map: { courseId: { progress... } }\r\n            const progressMap: Record<string, UserProgress> = {};\r\n            snapshot.docs.forEach(doc => {\r\n                const data = doc.data() as Omit<UserProgress, 'id'>;\r\n                // moduleId maps to courseId in this context\r\n                if (data.moduleId) {\r\n                    progressMap[data.moduleId] = { id: doc.id, ...data };\r\n                }\r\n            });\r\n            return progressMap;\r\n        } catch (error) {\r\n            console.error(\"Error fetching progress:\", error);\r\n            throw error;\r\n        }\r\n    },\r\n\r\n    /**\r\n     * Update progress for a specific course\r\n     */\r\n    updateProgress: async (userId: string, moduleId: string, progressData: Partial<UserProgress>): Promise<void> => {\r\n        try {\r\n            const q = query(\r\n                collection(db, COLLECTIONS.PROGRESS),\r\n                where('userId', '==', userId),\r\n                where('moduleId', '==', moduleId)\r\n            );\r\n            const snapshot = await getDocs(q);\r\n\r\n            if (!snapshot.empty) {\r\n                const docId = snapshot.docs[0].id;\r\n                await updateDoc(doc(db, COLLECTIONS.PROGRESS, docId), {\r\n                    ...progressData,\r\n                    updatedAt: serverTimestamp()\r\n                });\r\n            } else {\r\n                await addDoc(collection(db, COLLECTIONS.PROGRESS), {\r\n                    userId,\r\n                    moduleId,\r\n                    ...progressData,\r\n                    createdAt: serverTimestamp(),\r\n                    updatedAt: serverTimestamp()\r\n                });\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Error updating progress:\", error);\r\n            throw error;\r\n        }\r\n    },\r\n\r\n    /**\r\n     * Mark a specific lesson as completed for a user\r\n     */\r\n    markLessonComplete: async (userId: string, moduleId: string, lessonId: string): Promise<void> => {\r\n        try {\r\n            const q = query(\r\n                collection(db, COLLECTIONS.PROGRESS),\r\n                where('userId', '==', userId),\r\n                where('moduleId', '==', moduleId)\r\n            );\r\n            const snapshot = await getDocs(q);\r\n\r\n            if (!snapshot.empty) {\r\n                const docId = snapshot.docs[0].id;\r\n                const data = snapshot.docs[0].data() as UserProgress;\r\n                const completedLessons = data.completedLessons || [];\r\n\r\n                if (!completedLessons.includes(lessonId)) {\r\n                    await updateDoc(doc(db, COLLECTIONS.PROGRESS, docId), {\r\n                        completedLessons: [...completedLessons, lessonId],\r\n                        updatedAt: serverTimestamp()\r\n                    });\r\n                }\r\n            } else {\r\n                // Create new progress record\r\n                await addDoc(collection(db, COLLECTIONS.PROGRESS), {\r\n                    userId,\r\n                    moduleId,\r\n                    completedLessons: [lessonId],\r\n                    status: 'in_progress',\r\n                    createdAt: serverTimestamp(),\r\n                    updatedAt: serverTimestamp()\r\n                });\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Error marking lesson complete:\", error);\r\n            throw error;\r\n        }\r\n    }\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\services\\financeService.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":152,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":152,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4611,4614],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4611,4614],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":206,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":206,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7006,7009],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7006,7009],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":216,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":216,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7615,7618],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7615,7618],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":392,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":392,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14210,14213],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14210,14213],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":429,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":429,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15533,15536],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15533,15536],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":530,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":530,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19546,19549],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19546,19549],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":544,"column":92,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":544,"endColumn":95,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[20096,20099],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[20096,20099],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":548,"column":147,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":548,"endColumn":150,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[20439,20442],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[20439,20442],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":565,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":565,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[21385,21388],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[21385,21388],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":598,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":598,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[22874,22877],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[22874,22877],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":693,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":693,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[27222,27225],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[27222,27225],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":705,"column":60,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":705,"endColumn":63,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[27621,27624],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[27621,27624],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":726,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":726,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[28461,28464],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[28461,28464],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":848,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":848,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[33241,33244],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[33241,33244],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":14,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { db } from '../lib/firebase';\r\nimport type { Result } from '../types/result';\r\nimport type { FinanceError } from '../types/finance';\r\nimport { ok, err } from '../types/result';\r\nimport {\r\n    collection,\r\n    query,\r\n    where,\r\n    addDoc,\r\n    updateDoc,\r\n    deleteDoc,\r\n    doc,\r\n    serverTimestamp,\r\n    onSnapshot,\r\n    orderBy,\r\n    getDoc,\r\n    setDoc,\r\n    getDocs,\r\n    Unsubscribe,\r\n    DocumentData,\r\n    FieldValue,\r\n    writeBatch,\r\n    increment,\r\n    arrayUnion,\r\n    Timestamp\r\n} from 'firebase/firestore';\r\nimport { startOfMonth, endOfMonth, parseISO } from 'date-fns';\r\n\r\n// =====================================================\r\n// TYPES & INTERFACES\r\n// =====================================================\r\n\r\nexport interface FinancialRecord {\r\n    id: string;\r\n    franchise_id: string;\r\n    amount: number;\r\n    date: Date;\r\n    status: 'draft' | 'submitted' | 'approved' | 'rejected' | 'locked';\r\n    type: 'income' | 'expense';\r\n    category?: string;\r\n    description?: string;\r\n    admin_notes?: string;\r\n\r\n    // --- AUDIT TRAIL ---\r\n    created_at?: Date | FieldValue;\r\n    updated_at?: Date | FieldValue;\r\n    submitted_at?: Date | FieldValue;\r\n    approved_at?: Date | FieldValue;\r\n    approved_by?: string; // Admin UID\r\n    rejection_reason?: string;\r\n\r\n    // --- CONTROLS ---\r\n    is_locked?: boolean;\r\n}\r\n\r\nexport interface RecordInput {\r\n    amount: number | string;\r\n    date?: Date | string;\r\n    status?: 'pending' | 'approved' | 'rejected';\r\n    type?: 'income' | 'expense';\r\n    category?: string;\r\n    description?: string;\r\n}\r\n\r\nexport interface MonthlyData {\r\n    totalIncome?: number;\r\n    totalExpenses?: number;\r\n    revenue?: number;\r\n    expenses?: number;\r\n    profit?: number;\r\n    netProfit?: number;\r\n    status?: string;\r\n    recordCount?: number;\r\n    franchiseId?: string;\r\n    month?: string;\r\n    totalHours?: number;\r\n    updatedAt?: FieldValue;\r\n    [key: string]: unknown; // Allow additional properties\r\n}\r\n\r\n// =====================================================\r\n// SERVICE\r\n// =====================================================\r\n\r\nconst COLLECTION = 'financial_records';\r\n\r\nexport const financeService = {\r\n    /**\r\n     * Suscripci√≥n a los registros financieros de una franquicia\r\n     */\r\n    subscribeToRecords: (\r\n        franchiseId: string,\r\n        callback: (records: FinancialRecord[]) => void\r\n    ): Unsubscribe => {\r\n        if (!franchiseId) return () => { };\r\n\r\n        const q = query(\r\n            collection(db, COLLECTION),\r\n            where('franchise_id', '==', franchiseId),\r\n            orderBy('date', 'desc') // Ordenar por fecha, m√°s reciente primero\r\n        );\r\n\r\n        return onSnapshot(q, (snapshot) => {\r\n            const records: FinancialRecord[] = snapshot.docs.map(doc => {\r\n                const data = doc.data() as DocumentData;\r\n                return {\r\n                    id: doc.id,\r\n                    ...data,\r\n                    // Normalizamos la fecha para evitar errores en UI\r\n                    date: data.date?.toDate ? data.date.toDate() : new Date(data.date)\r\n                } as FinancialRecord;\r\n            });\r\n            callback(records);\r\n        });\r\n    },\r\n\r\n    /**\r\n     * A√±adir transacci√≥n (Gasto o Ingreso)\r\n     */\r\n    addRecord: async (franchiseId: string, recordData: RecordInput, isDraft: boolean = false): Promise<void> => {\r\n        if (!franchiseId) throw new Error(\"Franchise ID required\");\r\n\r\n        await addDoc(collection(db, COLLECTION), {\r\n            ...recordData,\r\n            franchise_id: franchiseId,\r\n            amount: Number(recordData.amount),\r\n            date: recordData.date ? new Date(recordData.date) : new Date(),\r\n            status: isDraft ? 'draft' : 'approved', // FIXED: Auto-approve for franchise inputs\r\n            is_locked: false,\r\n\r\n            // Timestamps\r\n            created_at: serverTimestamp(),\r\n            updated_at: serverTimestamp(),\r\n            submitted_at: isDraft ? null : serverTimestamp()\r\n        });\r\n\r\n        // FIXED: Atomic aggregation to keep widgets in sync\r\n\r\n        // Only aggregate if NOT a draft (but now we force approved, so always aggregate)\r\n        if (!isDraft) {\r\n            await financeService._aggregateToSummary(franchiseId, recordData);\r\n        }\r\n    },\r\n\r\n    /**\r\n     * Update Record Status (Admin Approval/Rejection)\r\n     */\r\n    updateStatus: async (id: string, newStatus: 'approved' | 'rejected', adminUid?: string, reason?: string): Promise<void> => {\r\n        try {\r\n            const docRef = doc(db, COLLECTION, id);\r\n\r\n            const updates: any = {\r\n                status: newStatus,\r\n                updated_at: serverTimestamp()\r\n            };\r\n\r\n            if (newStatus === 'approved') {\r\n                updates.approved_at = serverTimestamp();\r\n                if (adminUid) updates.approved_by = adminUid;\r\n            }\r\n\r\n            if (newStatus === 'rejected' && reason) {\r\n                updates.rejection_reason = reason;\r\n            }\r\n\r\n            await updateDoc(docRef, updates);\r\n        } catch (error) {\r\n            console.error(\"Error updating status:\", error);\r\n            throw error;\r\n        }\r\n    },\r\n\r\n    deleteRecord: async (recordId: string): Promise<void> => {\r\n        const docRef = doc(db, COLLECTION, recordId);\r\n        const docSnap = await getDoc(docRef);\r\n\r\n        if (docSnap.exists()) {\r\n            const data = docSnap.data();\r\n            // Decrement stats from summary (Reverse operation)\r\n            // We pass negative numbers to increment() effectively decrementing\r\n            // We need to fetch the record data first to know which month and amounts to subtract.\r\n\r\n            // To reuse _aggregateToSummary, we can construct a \"negative\" data object?\r\n            // Or better, let _aggregateToSummary handle a 'multiplier' arg?\r\n            // Let's manually do it here to be explicit and safe.\r\n\r\n            // const date = data.date?.toDate ? data.date.toDate() : new Date(data.date); // UNUSED\r\n            // const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`; // UNUSED - Shadowed below\r\n            const franchiseId = data.franchise_id;\r\n\r\n            if (franchiseId) {\r\n                // Use month field if available (trusted from UI), else derived from date\r\n                let monthKey = data.month;\r\n                if (!monthKey && data.date) {\r\n                    const d = data.date.toDate ? data.date.toDate() : new Date(data.date);\r\n                    if (!isNaN(d.getTime())) {\r\n                        monthKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;\r\n                    }\r\n                }\r\n\r\n                if (monthKey) {\r\n                    const summaryId = `${franchiseId}_${monthKey}`;\r\n                    const summaryRef = doc(db, 'financial_summaries', summaryId);\r\n\r\n                    // Helper to safely get number\r\n                    const getNum = (val: any) => Number(val) || 0;\r\n\r\n                    // Determine values to subtract (Reverse of aggregation)\r\n                    // Check specific fields first (revenue/expenses), then fall back to amount/type\r\n                    const revenue = getNum(data.revenue) || (data.type === 'income' ? getNum(data.amount) : 0);\r\n                    const expenses = getNum(data.expenses) || (data.type === 'expense' ? getNum(data.amount) : 0);\r\n\r\n                    const profit = getNum(data.profit);\r\n                    const logisticsIncome = getNum(data.logisticsIncome);\r\n\r\n                    const updates: any = {\r\n                        totalIncome: increment(-revenue),\r\n                        totalExpenses: increment(-expenses),\r\n                        grossIncome: increment(-revenue), // Legacy\r\n\r\n                        // EXPLICIT FIELDS (Fix for Zombie Data)\r\n                        revenue: increment(-revenue),\r\n                        expenses: increment(-expenses),\r\n                        profit: increment(-profit),\r\n                        logisticsIncome: increment(-logisticsIncome),\r\n\r\n                        updatedAt: serverTimestamp()\r\n                    };\r\n\r\n                    if (data.breakdown) {\r\n                        // Update flat breakdown keys\r\n                        Object.keys(data.breakdown).forEach(key => {\r\n                            const val = getNum(data.breakdown[key]);\r\n                            if (val > 0) {\r\n                                updates[`breakdown.${key}`] = increment(-val);\r\n                            }\r\n                        });\r\n\r\n                        // Legacy support: if labor/cogs were top level in some versions?\r\n                        // Assuming breakdown object is the source of truth now.\r\n                    }\r\n\r\n\r\n                    await setDoc(summaryRef, updates, { merge: true });\r\n                } else {\r\n                    console.warn(\"[Finance] Could not determine monthKey for deletion\", data);\r\n                }\r\n            }\r\n        }\r\n\r\n        await deleteDoc(docRef);\r\n    },\r\n\r\n    // --- ADMIN TOOLS ---\r\n\r\n    /**\r\n     * Get ALL pending records across ALL franchises (Global Inbox)\r\n     * REQUIRES INDEX: status (Asc) + date (Asc)\r\n     */\r\n    getGlobalPendingRecords: async (): Promise<FinancialRecord[]> => {\r\n        try {\r\n            const q = query(\r\n                collection(db, COLLECTION),\r\n                where('status', '==', 'submitted'),\r\n                orderBy('date', 'asc') // FIFO (First In, First Out)\r\n            );\r\n\r\n            const snapshot = await getDocs(q);\r\n            return snapshot.docs.map(doc => ({\r\n                id: doc.id,\r\n                ...doc.data()\r\n            } as FinancialRecord));\r\n        } catch (error) {\r\n            console.error(\"Error fetching global pending records:\", error);\r\n            return [];\r\n        }\r\n    },\r\n\r\n    /**\r\n     * FISCAL LOCK: Close a month preventing further edits\r\n     */\r\n    lockMonth: async (franchiseId: string, startDate: Date, endDate: Date): Promise<void> => {\r\n        try {\r\n            const q = query(\r\n                collection(db, COLLECTION),\r\n                where('franchise_id', '==', franchiseId),\r\n                where('date', '>=', startDate),\r\n                where('date', '<=', endDate),\r\n                where('status', '==', 'approved') // Only lock approved records\r\n            );\r\n\r\n            const snapshot = await getDocs(q);\r\n            const batch = writeBatch(db);\r\n\r\n            snapshot.docs.forEach(doc => {\r\n                batch.update(doc.ref, {\r\n                    is_locked: true,\r\n                    status: 'locked'\r\n                });\r\n            });\r\n\r\n            await batch.commit();\r\n        } catch (error) {\r\n            console.error(\"Error locking month:\", error);\r\n            throw error;\r\n        }\r\n    },\r\n\r\n    /**\r\n     * Obtener resumen financiero mensual (Snapshot)\r\n     * Collection: financial_summaries -> DocID: {franchiseId}_{month}\r\n     */\r\n    getFinancialData: async (franchiseId: string, month: string): Promise<MonthlyData | null> => {\r\n        if (!franchiseId || !month) return null;\r\n        const docId = `${franchiseId}_${month}`;\r\n        const docRef = doc(db, 'financial_summaries', docId);\r\n        const docSnap = await getDoc(docRef);\r\n\r\n        if (docSnap.exists()) {\r\n            return docSnap.data() as MonthlyData;\r\n        }\r\n        return null;\r\n    },\r\n\r\n    /**\r\n     * Guardar/Actualizar resumen mensual\r\n     * @returns Result with void on success or specific error\r\n     */\r\n    updateFinancialData: async (\r\n        franchiseId: string,\r\n        month: string,\r\n        data: MonthlyData\r\n    ): Promise<Result<void, FinanceError>> => {\r\n        try {\r\n            // Validation\r\n            if (!franchiseId) {\r\n                return err({ type: 'PERMISSION_DENIED', franchiseId: franchiseId || 'unknown' });\r\n            }\r\n\r\n            if (!month) {\r\n                return err({\r\n                    type: 'VALIDATION_ERROR',\r\n                    field: 'month',\r\n                    message: 'Month is required'\r\n                });\r\n            }\r\n\r\n            // Validate month format (YYYY-MM)\r\n            if (!month.match(/^\\d{4}-\\d{2}$/)) {\r\n                return err({\r\n                    type: 'INVALID_FORMAT',\r\n                    field: 'month',\r\n                    expected: 'YYYY-MM',\r\n                    received: month\r\n                });\r\n            }\r\n\r\n            const docId = `${franchiseId}_${month}`;\r\n            const docRef = doc(db, 'financial_summaries', docId);\r\n\r\n            // Sanitize Data: Ensure numbers are numbers and keys are consistent\r\n            const validRevenue = Number(data.totalIncome || data.revenue || 0);\r\n            const validExpenses = Number(data.totalExpenses || data.expenses || 0);\r\n            const validProfit = validRevenue - validExpenses;\r\n\r\n            const sanitizedData = {\r\n                ...data, // Keep original fields\r\n                totalIncome: validRevenue,\r\n                totalExpenses: validExpenses,\r\n                grossIncome: validRevenue, // Legacy sync\r\n                revenue: validRevenue, // Ensure these exist for UI\r\n                expenses: validExpenses,\r\n                profit: validProfit,\r\n                // Ensure breakdown values are numbers if they exist\r\n                breakdown: data.breakdown ? Object.fromEntries(\r\n                    Object.entries(data.breakdown).map(([k, v]) => [k, Number(v) || 0])\r\n                ) : {}\r\n            };\r\n\r\n            // Usamos setDoc con merge para no borrar campos si actualizamos parcial\r\n            await setDoc(docRef, {\r\n                ...sanitizedData,\r\n                franchiseId,\r\n                month,\r\n                status: data.status || 'approved', // Respect input status (e.g. 'submitted' from franchise)\r\n                is_locked: data.is_locked || (data.status === 'submitted' || data.status === 'locked'), // Auto-lock if submitted/locked\r\n                updatedAt: serverTimestamp()\r\n            }, { merge: true });\r\n\r\n            return ok(undefined);\r\n\r\n        } catch (error: any) {\r\n            // Firebase permission errors\r\n            if (error.code === 'permission-denied') {\r\n                return err({ type: 'PERMISSION_DENIED', franchiseId });\r\n            }\r\n\r\n            // Network or unknown errors\r\n            return err({\r\n                type: 'NETWORK_ERROR',\r\n                cause: error instanceof Error ? error : new Error(String(error))\r\n            });\r\n        }\r\n    },\r\n\r\n    /**\r\n     * UNLOCK MONTH: Allow franchise to edit closed month.\r\n     * Admin Action.\r\n     */\r\n    unlockMonth: async (franchiseId: string, month: string): Promise<Result<void, FinanceError>> => {\r\n        try {\r\n            if (!franchiseId || !month) return err({ type: 'VALIDATION_ERROR', field: 'month', message: 'Missing args' });\r\n\r\n            const docId = `${franchiseId}_${month}`;\r\n            const docRef = doc(db, 'financial_summaries', docId);\r\n\r\n            await updateDoc(docRef, {\r\n                status: 'open',\r\n                is_locked: false,\r\n                updatedAt: serverTimestamp(),\r\n                statusHistory: arrayUnion({\r\n                    status: 'open',\r\n                    timestamp: Timestamp.now(),\r\n                    action: 'unlocked_by_admin'\r\n                })\r\n            });\r\n\r\n            return ok(undefined);\r\n        } catch (error: any) {\r\n            console.error(\"Error unlocking month:\", error);\r\n            return err({ type: 'NETWORK_ERROR', cause: error });\r\n        }\r\n    },\r\n\r\n    /**\r\n     * REQUEST UNLOCK: Franchise requests to edit a locked month.\r\n     */\r\n    requestUnlock: async (franchiseId: string, month: string, reason: string): Promise<Result<void, FinanceError>> => {\r\n        try {\r\n            const docId = `${franchiseId}_${month}`;\r\n            const docRef = doc(db, 'financial_summaries', docId);\r\n\r\n            await updateDoc(docRef, {\r\n                status: 'unlock_requested',\r\n                unlockReason: reason,\r\n                updatedAt: serverTimestamp(),\r\n                statusHistory: arrayUnion({\r\n                    status: 'unlock_requested',\r\n                    timestamp: Timestamp.now(),\r\n                    reason: reason,\r\n                    action: 'requested_by_franchise'\r\n                })\r\n            });\r\n\r\n            return ok(undefined);\r\n        } catch (error) {\r\n            console.error(\"Error requesting unlock:\", error);\r\n            return err({ type: 'NETWORK_ERROR', cause: error instanceof Error ? error : new Error(String(error)) });\r\n        }\r\n    },\r\n\r\n    /**\r\n     * REJECT UNLOCK: Admin denies request.\r\n     */\r\n    rejectUnlock: async (franchiseId: string, month: string, reason?: string): Promise<Result<void, FinanceError>> => {\r\n        try {\r\n            const docId = `${franchiseId}_${month}`;\r\n            const docRef = doc(db, 'financial_summaries', docId);\r\n\r\n            await updateDoc(docRef, {\r\n                status: 'locked', // Revert to locked\r\n                is_locked: true, // Re-lock\r\n                unlockReason: null, // Clear request reason\r\n                rejectionReason: reason || null, // Store rejection reason\r\n                updatedAt: serverTimestamp(),\r\n                statusHistory: arrayUnion({\r\n                    status: 'locked',\r\n                    timestamp: Timestamp.now(),\r\n                    reason: reason || 'No reason provided',\r\n                    action: 'rejected_by_admin'\r\n                })\r\n            });\r\n\r\n            return ok(undefined);\r\n        } catch (error) {\r\n            console.error(\"Error rejecting unlock:\", error);\r\n            return err({ type: 'NETWORK_ERROR', cause: error instanceof Error ? error : new Error(String(error)) });\r\n        }\r\n    },\r\n\r\n    /**\r\n     * Obtener historial de cierres (Res√∫menes Financieros)\r\n     * @returns Result with MonthlyData array or specific error\r\n     */\r\n    fetchClosures: async (franchiseId: string): Promise<Result<MonthlyData[], FinanceError>> => {\r\n        try {\r\n            // Validation\r\n            if (!franchiseId) {\r\n                return err({ type: 'PERMISSION_DENIED', franchiseId: 'unknown' });\r\n            }\r\n\r\n            const q = query(\r\n                collection(db, 'financial_summaries'),\r\n                where('franchiseId', '==', franchiseId)\r\n            );\r\n            const snapshot = await getDocs(q);\r\n\r\n            const data = snapshot.docs\r\n                .map(doc => {\r\n                    const d = doc.data();\r\n                    // Normalize Data for UI: Ensure revenue/expenses/profit exist\r\n                    const revenue = Number(d.totalIncome || d.revenue || 0);\r\n                    const expenses = Number(d.totalExpenses || d.expenses || 0);\r\n                    const profit = revenue - expenses;\r\n\r\n                    return {\r\n                        ...d,\r\n                        id: doc.id,\r\n                        revenue,\r\n                        expenses,\r\n                        profit,\r\n                        // Ensure totals match if checks rely on them\r\n                        totalIncome: revenue,\r\n                        totalExpenses: expenses\r\n                    } as MonthlyData;\r\n                })\r\n                .filter(item => item.status !== 'deleted'); // Filter soft-deleted items\r\n\r\n            return ok(data);\r\n        } catch (error: any) {\r\n            console.error(\"Error fetching closures:\", error);\r\n            // Return appropriate FinanceError\r\n            return err({\r\n                type: 'NETWORK_ERROR',\r\n                cause: error instanceof Error ? error : new Error(String(error))\r\n            });\r\n        }\r\n    },\r\n\r\n    /**\r\n     * DASHBOARD: Obtener tendencia financiera de los √∫ltimos X meses\r\n     * Agrega los datos en el cliente (Client-Side Aggregation)\r\n     */\r\n    getFinancialTrend: async (franchiseId: string | null, monthsBack: number = 6): Promise<any[]> => {\r\n        try {\r\n            // 1. Calcular fecha (meses atr√°s) - pero las summaries usan string \"YYYY-MM\"\r\n            // Necesitamos generar las keys \"YYYY-MM\" de los √∫ltimos X meses\r\n            const monthlyStats = new Map<string, { income: number, expense: number, date: Date, orders?: number, totalHours?: number, breakdown?: any, logisticsIncome?: number }>();\r\n            const today = new Date();\r\n            const summaryKeys: string[] = [];\r\n\r\n            for (let i = monthsBack; i >= 0; i--) {\r\n                const d = new Date(today.getFullYear(), today.getMonth() - i, 1);\r\n                const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;\r\n                monthlyStats.set(key, { income: 0, expense: 0, date: d, totalHours: 0 });\r\n                summaryKeys.push(key);\r\n            }\r\n\r\n            // 2. Query 'financial_summaries'\r\n            // LIMITATION: 'in' query supports max 10 values. If monthsBack > 9, we might need multiple queries or just fetch range.\r\n            // Since docId is \"franchiseId_YYYY-MM\", we can't easily range-query without a separate simple \"month\" field.\r\n            // But we added \"month\" field to the doc! It is \"YYYY-MM\".\r\n\r\n            // Construct query\r\n            const constraints: any[] = [\r\n                where('month', 'in', summaryKeys) // Only valid if <= 10 keys\r\n            ];\r\n\r\n            if (monthsBack > 9) {\r\n                // Fallback: Query all summaries for franchise (usually small enough dataset per franchise)\r\n                // or Query by date range if we had a date field. We have 'updatedAt' but strictly 'month' is the key.\r\n                // Let's stick to <= 10 for now or just fetch all for franchise if specific.\r\n                constraints.length = 0; // Clear\r\n                // Use simply order by month string? \"2023-01\" < \"2023-02\". Yes.\r\n                const startKey = summaryKeys[0];\r\n                constraints.push(where('month', '>=', startKey));\r\n            }\r\n\r\n            if (franchiseId) {\r\n                constraints.push(where('franchiseId', '==', franchiseId));\r\n            }\r\n\r\n            const q = query(\r\n                collection(db, 'financial_summaries'),\r\n                ...constraints\r\n            );\r\n\r\n            const snapshot = await getDocs(q);\r\n\r\n            snapshot.docs.forEach(doc => {\r\n                const data = doc.data() as MonthlyData;\r\n                if (!data.month) return;\r\n\r\n                if (monthlyStats.has(data.month)) {\r\n                    const current = monthlyStats.get(data.month)!;\r\n                    // Mapeo de campos nuevos + compatibilidad\r\n                    // Cast to any to access dynamic/legacy properties\r\n                    const anyData = data as any;\r\n                    const income = data.totalIncome || data.revenue || anyData.summary?.grossIncome || 0;\r\n                    const expense = data.totalExpenses || (typeof anyData.expenses === 'number' ? anyData.expenses : anyData.expenses?.total) || anyData.summary?.totalExpenses || 0;\r\n                    const orders = Number(anyData.orders || 0);\r\n                    const totalHours = Number(anyData.totalHours || 0);\r\n\r\n                    // CRITICAL FIX: Use += to SUM multiple franchises, not = to overwrite\r\n                    current.income += Number(income);\r\n                    current.expense += Number(expense);\r\n\r\n                    // Aggregate extra metadata\r\n                    if (!current.breakdown) current.breakdown = {};\r\n                    if (!current.orders) current.orders = 0;\r\n                    if (!current.totalHours) current.totalHours = 0;\r\n\r\n                    current.orders += orders;\r\n                    current.totalHours += totalHours;\r\n\r\n                    // Aggregate detailed breakdown if present (taxes, labor, etc)\r\n                    if (anyData.breakdown) {\r\n                        Object.entries(anyData.breakdown).forEach(([key, val]) => {\r\n                            current.breakdown![key] = (current.breakdown![key] || 0) + Number(val || 0);\r\n                        });\r\n                    }\r\n\r\n                    // Aggregate Logistics Income specifically (Fee)\r\n                    if (anyData.logisticsIncome) {\r\n                        current.logisticsIncome = (current.logisticsIncome || 0) + Number(anyData.logisticsIncome);\r\n                    }\r\n                }\r\n            });\r\n\r\n            // 4. Formatear para Recharts\r\n            const result = Array.from(monthlyStats.values()).map(stat => {\r\n                const profit = stat.income - stat.expense;\r\n                const monthName = stat.date.toLocaleDateString('es-ES', { month: 'short' });\r\n\r\n                return {\r\n                    name: monthName.charAt(0).toUpperCase() + monthName.slice(1), // \"Ene\"\r\n                    income: stat.income,\r\n                    revenue: stat.income, // Dual support\r\n                    expenses: stat.expense,\r\n                    profit: profit,\r\n                    orders: stat.orders || 0,\r\n                    totalHours: stat.totalHours || 0,\r\n                    logisticsIncome: stat.logisticsIncome || 0,\r\n                    breakdown: stat.breakdown || {},\r\n                    fullDate: stat.date.toISOString(),\r\n                };\r\n            });\r\n\r\n            return result;\r\n\r\n        } catch (error) {\r\n            console.error(\"Error calculating financial trend:\", error);\r\n            return []; // Fail gracefully\r\n        }\r\n    },\r\n\r\n    /**\r\n     * DANGER: Elimina TODOS los registros financieros de una franquicia.\r\n     * Uso exclusivo para resetear datos de prueba o limpieza solicitada por usuario.\r\n     */\r\n    clearFinancialData: async (franchiseId: string): Promise<Result<void, FinanceError>> => {\r\n        try {\r\n            if (!franchiseId) return err({ type: 'VALIDATION_ERROR', field: 'franchiseId', message: 'Franchise ID requerido' });\r\n\r\n            const batch = writeBatch(db);\r\n            let operationCount = 0;\r\n\r\n            // 1. Get all records (financial_records)\r\n            const recordsQuery = query(collection(db, COLLECTION), where('franchise_id', '==', franchiseId));\r\n            const recordsSnapshot = await getDocs(recordsQuery);\r\n\r\n            recordsSnapshot.docs.forEach((doc) => {\r\n                batch.delete(doc.ref);\r\n                operationCount++;\r\n            });\r\n\r\n            // 2. Get all summaries (financial_summaries)\r\n            const summariesQuery = query(collection(db, 'financial_summaries'), where('franchiseId', '==', franchiseId));\r\n            const summariesSnapshot = await getDocs(summariesQuery);\r\n\r\n            summariesSnapshot.docs.forEach((doc) => {\r\n                batch.delete(doc.ref);\r\n                operationCount++;\r\n            });\r\n\r\n            // 3. Commit\r\n            if (operationCount > 0) {\r\n                await batch.commit();\r\n            }\r\n            console.log(`[Cleaner] Eliminados ${operationCount} documentos (registros y res√∫menes) de ${franchiseId}`);\r\n\r\n            return ok(undefined);\r\n        } catch (error: any) {\r\n            console.error(\"Error limpiando datos:\", error);\r\n            return err({\r\n                type: 'NETWORK_ERROR',\r\n                cause: error instanceof Error ? error : new Error(String(error))\r\n            });\r\n        }\r\n    },\r\n\r\n    /**\r\n     * INTERNAL: Aggregate Record into Monthly Summary atomically\r\n     */\r\n    _aggregateToSummary: async (franchiseId: string, data: any): Promise<void> => {\r\n        try {\r\n            // Priority: Explicit month field > Derived from Date > Current Month\r\n            let monthKey = data.month;\r\n\r\n            if (!monthKey) {\r\n                const date = data.date ? new Date(data.date) : new Date();\r\n                monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;\r\n            }\r\n\r\n            const docId = `${franchiseId}_${monthKey}`;\r\n\r\n            const docRef = doc(db, 'financial_summaries', docId);\r\n\r\n            // Determine values (Safe Fallbacks)\r\n            const revenue = Number(data.revenue || (data.type === 'income' ? data.amount : 0) || 0);\r\n            const expenses = Number(data.expenses || (data.type === 'expense' ? data.amount : 0) || 0);\r\n\r\n\r\n\r\n            // Prepare Updates\r\n            const updates: any = {\r\n                franchiseId,\r\n                month: monthKey,\r\n                status: 'approved', // FIXED: Resurrect document if it was deleted\r\n                updatedAt: serverTimestamp(),\r\n                totalIncome: increment(revenue),\r\n                totalExpenses: increment(expenses),\r\n                // Legacy support\r\n                grossIncome: increment(revenue),\r\n            };\r\n\r\n            // Aggregate Breakdown if present\r\n            if (data.breakdown) {\r\n                if (data.breakdown.labor) updates['summary.totalExpenses'] = increment(expenses); // Ensure total matches\r\n                Object.keys(data.breakdown).forEach(key => {\r\n                    updates[`breakdown.${key}`] = increment(Number(data.breakdown[key]) || 0);\r\n                });\r\n\r\n                // Also update legacy fields if needed, or just rely on 'breakdown' object structure\r\n                // 'expenses' field in summary might be an object in some versions?\r\n                // Let's stick to flat 'breakdown.x' which is cleaner.\r\n            }\r\n\r\n            // Use setDoc with merge to ensure document exists\r\n            await setDoc(docRef, updates, { merge: true });\r\n\r\n        } catch (error) {\r\n            console.error(\"Error aggregating summary:\", error);\r\n            // Don't throw, so we don't break the record creation flow if aggregation fails\r\n        }\r\n    },\r\n\r\n    /**\r\n     * DELETE SUMMARY BY ID: Explicitly delete a summary document\r\n     */\r\n    /**\r\n     * SOFT DELETE SUMMARY: Update status to 'deleted' instead of actual deletion (permissions workaround)\r\n     */\r\n    deleteSummaryDocument: async (docId: string): Promise<void> => {\r\n        try {\r\n\r\n            // HARD DELETE to prevent zombie data\r\n            const docRef = doc(db, 'financial_summaries', docId);\r\n            await deleteDoc(docRef);\r\n        } catch (error) {\r\n            console.error(\"Error deleting summary:\", error);\r\n            throw error;\r\n        }\r\n    },\r\n\r\n    resetMonthSummary: async (franchiseId: string, monthKey: string): Promise<void> => {\r\n        try {\r\n\r\n            const batch = writeBatch(db);\r\n\r\n            // 1. Calculate Date Range\r\n            const [year, month] = monthKey.split('-').map(Number);\r\n            const startDate = new Date(year, month - 1, 1);\r\n            const endDate = endOfMonth(startOfMonth(parseISO(monthKey)));\r\n\r\n            // 2. Queue Deletion of ALL compatible Records\r\n            const recordsQuery = query(\r\n                collection(db, COLLECTION),\r\n                where('franchise_id', '==', franchiseId),\r\n                where('date', '>=', startDate),\r\n                where('date', '<=', endDate)\r\n            );\r\n\r\n            const recordsSnap = await getDocs(recordsQuery);\r\n            recordsSnap.docs.forEach(doc => {\r\n                batch.delete(doc.ref);\r\n            });\r\n\r\n\r\n            // 3. Queue Deletion of Summary\r\n            const docId = `${franchiseId}_${monthKey}`;\r\n            const summaryRef = doc(db, 'financial_summaries', docId);\r\n            batch.delete(summaryRef);\r\n\r\n            // 4. Execute atomic batch\r\n            await batch.commit();\r\n            console.log(`[Finance] Month data destroyed successfully.`);\r\n        } catch (error) {\r\n            console.error(\"Error resetting month summary:\", error);\r\n            throw error;\r\n        }\r\n    },\r\n\r\n    /**\r\n     * FORCE SYNC: Recalculates the summary for a specific month by reading ALL records.\r\n     * Use this to fix drift/sync issues.\r\n     */\r\n    recalculateMonthSummary: async (franchiseId: string, monthKey: string): Promise<void> => {\r\n        try {\r\n            console.log(`[Finance] Force Syncing for ${franchiseId} - ${monthKey}`);\r\n\r\n            // 1. Calculate Date Range for the Month\r\n            const [year, month] = monthKey.split('-').map(Number);\r\n            const startDate = new Date(year, month - 1, 1);\r\n            const endDate = endOfMonth(startOfMonth(parseISO(monthKey)));\r\n\r\n            console.log(`[Finance] Recalculating for ${franchiseId} range: ${startDate} to ${endDate}`);\r\n\r\n            // 2. Fetch ALL records for this range\r\n            const recordsRef = collection(db, 'financial_records');\r\n            const q = query(\r\n                recordsRef,\r\n                where('franchise_id', '==', franchiseId),\r\n                where('date', '>=', startDate),\r\n                where('date', '<=', endDate)\r\n            );\r\n\r\n            const snap = await getDocs(q);\r\n\r\n            let totalIncome = 0;\r\n            let totalExpenses = 0;\r\n            // Explicit Accumulators\r\n            let accRevenue = 0;\r\n            let accExpenses = 0;\r\n            let accProfit = 0;\r\n            let accLogisticsOnly = 0;\r\n\r\n            const breakdown: any = {};\r\n\r\n            snap.docs.forEach(doc => {\r\n                const d = doc.data();\r\n                if (d.status === 'draft' || d.status === 'rejected') return;\r\n\r\n                const rev = Number(d.revenue || (d.type === 'income' ? d.amount : 0) || 0);\r\n                const exp = Number(d.expenses || (d.type === 'expense' ? d.amount : 0) || 0);\r\n                const prof = Number(d.profit || (rev - exp) || 0);\r\n\r\n                // Track explicitly\r\n                accRevenue += rev;\r\n                accExpenses += exp;\r\n                accProfit += prof;\r\n                if (d.logisticsIncome) accLogisticsOnly += Number(d.logisticsIncome);\r\n\r\n                totalIncome += rev;\r\n                totalExpenses += exp;\r\n\r\n                if (d.breakdown) {\r\n                    Object.keys(d.breakdown).forEach(k => {\r\n                        breakdown[k] = (breakdown[k] || 0) + (Number(d.breakdown[k]) || 0);\r\n                    });\r\n                }\r\n            });\r\n\r\n            console.log(`[Finance] Recalculated: Income=${totalIncome}, Expenses=${totalExpenses}, Profit=${accProfit}. Docs found: ${snap.size}`);\r\n\r\n            // 3. Overwrite the Summary\r\n            const summaryId = `${franchiseId}_${monthKey}`;\r\n            const summaryRef = doc(db, 'financial_summaries', summaryId);\r\n\r\n            await setDoc(summaryRef, {\r\n                franchiseId,\r\n                month: monthKey,\r\n                status: 'approved', // FIXED: Resurrect if it was deleted\r\n                totalIncome,\r\n                totalExpenses,\r\n                grossIncome: totalIncome, // Legacy\r\n\r\n                // EXPLICIT FIELDS (Normalized)\r\n                revenue: accRevenue,\r\n                expenses: accExpenses,\r\n                profit: accProfit,\r\n                logisticsIncome: accLogisticsOnly,\r\n\r\n                breakdown,\r\n                updatedAt: serverTimestamp(),\r\n                lastForceSync: serverTimestamp()\r\n            }, { merge: true });\r\n\r\n        } catch (error) {\r\n            console.error(\"Error recalculating summary:\", error);\r\n            throw error;\r\n        }\r\n    }\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\services\\fleetService.d.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":8,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":8,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[209,212],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[209,212],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":12,"column":66,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":12,"endColumn":69,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[315,318],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[315,318],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":13,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":13,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[391,394],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[391,394],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":14,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":14,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[453,456],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[453,456],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Type declarations for fleetService\r\n\r\nexport interface FleetVehicle {\r\n    id: string;\r\n    plate: string;\r\n    type: 'moto' | 'bike';\r\n    status: 'active' | 'maintenance' | 'retired';\r\n    [key: string]: any;\r\n}\r\n\r\nexport const fleetService: {\r\n    subscribeToFleet: (franchiseId: string, callback: (vehicles: any[]) => void) => () => void;\r\n    addVehicle: (franchiseId: string, data: any) => Promise<void>;\r\n    updateVehicle: (id: string, data: any) => Promise<void>;\r\n    deleteVehicle: (id: string) => Promise<void>;\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\services\\fleetService.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":30,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":30,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[715,718],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[715,718],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":50,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":50,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1515,1518],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1515,1518],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":165,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":165,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6119,6122],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6119,6122],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":283,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":283,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10262,10265],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10262,10265],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":288,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":288,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10518,10521],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10518,10521],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":288,"column":66,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":288,"endColumn":69,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10532,10535],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10532,10535],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":296,"column":142,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":296,"endColumn":145,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11091,11094],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11091,11094],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getFunctions, httpsCallable } from 'firebase/functions';\r\nimport {\r\n    collection,\r\n    updateDoc,\r\n    doc,\r\n    getDocs,\r\n    getDoc,\r\n    serverTimestamp,\r\n    query,\r\n    where,\r\n    onSnapshot,\r\n    deleteDoc,\r\n    setDoc\r\n} from 'firebase/firestore';\r\nimport { db } from '../lib/firebase';\r\nimport { Rider } from '../store/useFleetStore';\r\nimport { notificationService } from './notificationService';\r\nimport {\r\n    Moto,\r\n    CreateMotoInput,\r\n    toMotoId\r\n} from '../schemas/fleet';\r\n\r\nconst RIDERS_COLLECTION = 'users'; // UNIFIED DATA SOURCE\r\nconst ASSETS_COLLECTION = 'fleet_assets';\r\n\r\n/**\r\n * Mappers to ensure data consistency between Firestore and UI\r\n */\r\nconst mapDocToRider = (docSnap: any): Rider => {\r\n    const data = docSnap.data();\r\n    return {\r\n        id: docSnap.id,\r\n        fullName: data.displayName || data.fullName || 'Rider sin nombre',\r\n        email: data.email,\r\n        phone: data.phoneNumber || data.phone || '',\r\n        status: data.status || 'active',\r\n        contractHours: data.contractHours,\r\n        metrics: {\r\n            totalDeliveries: data.metrics?.totalDeliveries || 0,\r\n            rating: data.metrics?.rating || 0,\r\n            efficiency: data.metrics?.efficiency || 0,\r\n            joinedAt: data.metrics?.joinedAt?.toDate?.().toISOString() || data.createdAt?.toDate?.().toISOString() || new Date().toISOString()\r\n        },\r\n        franchiseId: data.franchiseId,\r\n        avatarUrl: data.photoURL\r\n    };\r\n};\r\n\r\nconst mapDocToMoto = (docSnap: any): Moto => {\r\n    const data = docSnap.data();\r\n    return {\r\n        id: toMotoId(docSnap.id),\r\n        franchiseId: data.franchiseId,\r\n        plate: data.plate || data.matricula || '', // Support legacy matricula field\r\n        brand: data.brand || '',\r\n        model: data.model || data.modelo || '', // Support legacy modelo field\r\n        currentKm: data.currentKm || data.km_actuales || 0,\r\n        nextRevisionKm: data.nextRevisionKm || data.proxima_revision_km || 5000,\r\n        status: data.status || data.estado || 'active',\r\n        createdAt: data.createdAt?.toDate?.().toISOString() || new Date().toISOString(),\r\n        updatedAt: data.updatedAt?.toDate?.().toISOString() || new Date().toISOString()\r\n    } as Moto;\r\n};\r\n\r\nexport const fleetService = {\r\n    // =====================================================\r\n    // üë§ RIDER MANAGEMENT\r\n    // =====================================================\r\n\r\n    /**\r\n     * Get all active riders for a specific franchise\r\n     */\r\n    getRiders: async (franchiseId?: string): Promise<Rider[]> => {\r\n        try {\r\n            let q;\r\n            if (franchiseId && franchiseId.trim() !== '') {\r\n                q = query(\r\n                    collection(db, RIDERS_COLLECTION),\r\n                    where('franchiseId', '==', franchiseId),\r\n                    where('role', '==', 'rider') // Filter by role\r\n                );\r\n            } else {\r\n                // Admin view: all riders\r\n                q = query(\r\n                    collection(db, RIDERS_COLLECTION),\r\n                    where('role', '==', 'rider')\r\n                );\r\n            }\r\n\r\n            const querySnapshot = await getDocs(q);\r\n            const riders = querySnapshot.docs.map(mapDocToRider);\r\n\r\n            // Filter status in memory if needed, but 'users' might have non-riders if query fails\r\n            return riders.filter(r => r.status !== 'deleted');\r\n        } catch (error) {\r\n            console.error('[FleetService] Error fetching riders:', error);\r\n            throw error;\r\n        }\r\n    },\r\n\r\n    /**\r\n     * Subscribe to riders by franchise\r\n     */\r\n    subscribeToRiders: (franchiseId: string, callback: (riders: Rider[]) => void) => {\r\n        const q = query(\r\n            collection(db, RIDERS_COLLECTION),\r\n            where('franchiseId', '==', franchiseId)\r\n        );\r\n\r\n        return onSnapshot(q, (snapshot) => {\r\n            const riders = snapshot.docs.map(mapDocToRider);\r\n            callback(riders);\r\n        }, (error) => {\r\n            console.error('[FleetService] Error in riders subscription:', error);\r\n        });\r\n    },\r\n\r\n    /**\r\n     * Create a new rider (Auth + Firestore)\r\n     */\r\n    /**\r\n     * Create a new rider (Auth + Firestore) via Secure Backend\r\n     */\r\n    createRider: async (riderData: Omit<Rider, 'id' | 'metrics'> & { password?: string }): Promise<Rider> => {\r\n        try {\r\n            if (!riderData.password) throw new Error(\"Contrase√±a requerida para nuevos riders\");\r\n\r\n            const functions = getFunctions();\r\n            const createUserManaged = httpsCallable(functions, 'createUserManaged');\r\n\r\n            // Payload must match what useUserManager sends and what Cloud Function expects\r\n            const payload = {\r\n                email: riderData.email,\r\n                password: riderData.password,\r\n                role: 'rider',\r\n                franchiseId: riderData.franchiseId,\r\n                displayName: riderData.fullName,\r\n                phoneNumber: riderData.phone ? (riderData.phone.startsWith('+') ? riderData.phone : `+34${riderData.phone}`) : undefined,\r\n                contractHours: riderData.contractHours,\r\n                status: 'active',\r\n                metrics: {\r\n                    totalDeliveries: 0,\r\n                    rating: 5.0,\r\n                    efficiency: 100\r\n                }\r\n            };\r\n\r\n            const result = await createUserManaged(payload);\r\n            const response = result.data as { uid: string, message: string };\r\n            const uid = response.uid;\r\n\r\n            // Return optimistic rider object for UI\r\n            return {\r\n                id: uid,\r\n                fullName: riderData.fullName,\r\n                email: riderData.email,\r\n                phone: riderData.phone,\r\n                franchiseId: riderData.franchiseId,\r\n                status: 'active',\r\n                contractHours: riderData.contractHours,\r\n                metrics: { totalDeliveries: 0, rating: 5, efficiency: 100, joinedAt: new Date().toISOString() }\r\n            };\r\n\r\n        } catch (error: any) {\r\n            console.error('[FleetService] Error creating rider:', error);\r\n\r\n            // Map Cloud Function errors to friendlier UI messages\r\n            if (error.message?.includes('already-exists') || error.code === 'already-exists') {\r\n                throw new Error('Este email ya est√° registrado en el sistema.');\r\n            }\r\n            if (error.message?.includes('permission-denied') || error.code === 'permission-denied') {\r\n                throw new Error('No tienes permisos para crear este tipo de usuario o para esta franquicia.');\r\n            }\r\n\r\n            throw error;\r\n        }\r\n    },\r\n\r\n    updateRider: async (id: string, data: Partial<Rider>): Promise<void> => {\r\n        await updateDoc(doc(db, RIDERS_COLLECTION, id), {\r\n            ...data,\r\n            updatedAt: serverTimestamp()\r\n        });\r\n    },\r\n\r\n    deleteRider: async (id: string): Promise<void> => {\r\n        await updateDoc(doc(db, RIDERS_COLLECTION, id), {\r\n            status: 'inactive',\r\n            updatedAt: serverTimestamp()\r\n        });\r\n    },\r\n\r\n    // =====================================================\r\n    // üèçÔ∏è ASSET MANAGEMENT (MOTOS / VEHICLES)\r\n    // =====================================================\r\n\r\n    /**\r\n     * Subscribe to all assets for a franchise\r\n     */\r\n    subscribeToFleet: (franchiseId: string, callback: (assets: Moto[]) => void) => {\r\n        const q = query(\r\n            collection(db, ASSETS_COLLECTION),\r\n            where('franchiseId', '==', franchiseId)\r\n        );\r\n\r\n        return onSnapshot(q, (snap) => {\r\n            const assets = snap.docs.map(mapDocToMoto);\r\n            callback(assets);\r\n        });\r\n    },\r\n\r\n    /**\r\n     * Create a new Moto with validation\r\n     */\r\n    createMoto: async (franchiseId: string, data: CreateMotoInput): Promise<Moto> => {\r\n        const newRef = doc(collection(db, ASSETS_COLLECTION));\r\n\r\n        const payload = {\r\n            ...data,\r\n            franchiseId,\r\n            status: 'active',\r\n            createdAt: serverTimestamp(),\r\n            updatedAt: serverTimestamp()\r\n        };\r\n\r\n        await setDoc(newRef, payload);\r\n\r\n        return {\r\n            id: toMotoId(newRef.id),\r\n            ...data,\r\n            franchiseId,\r\n            status: 'active',\r\n            createdAt: new Date().toISOString(),\r\n            updatedAt: new Date().toISOString()\r\n        } as Moto;\r\n    },\r\n\r\n    /**\r\n     * Update Moto details with Predictive Maintenance Logic\r\n     */\r\n    updateVehicle: async (id: string, data: Partial<Moto>): Promise<void> => {\r\n        const ref = doc(db, ASSETS_COLLECTION, id);\r\n        const snap = await getDoc(ref);\r\n        if (!snap.exists()) throw new Error(\"Moto not found\");\r\n\r\n        const current = snap.data();\r\n        const newKm = data.currentKm ?? current.currentKm ?? 0;\r\n        const limitKm = data.nextRevisionKm ?? current.nextRevisionKm ?? 5000;\r\n        let newStatus = data.status ?? current.status;\r\n\r\n        // Predictive Maintenance Logic\r\n        if (newKm >= limitKm && newStatus !== 'maintenance') {\r\n            newStatus = 'maintenance';\r\n            await notificationService.notifyFranchise(current.franchiseId, {\r\n                title: 'üö® MANTENIMIENTO OBLIGATORIO',\r\n                message: `Veh√≠culo ${current.plate || current.matricula} alcanz√≥ ${limitKm}km. Bloqueado.`,\r\n                type: 'ALERT',\r\n                priority: 'high'\r\n            });\r\n        }\r\n\r\n        await updateDoc(ref, {\r\n            ...data,\r\n            status: newStatus,\r\n            updatedAt: serverTimestamp()\r\n        });\r\n    },\r\n\r\n    deleteVehicle: async (id: string): Promise<void> => {\r\n        await deleteDoc(doc(db, ASSETS_COLLECTION, id));\r\n    },\r\n\r\n    // Aliases for backward compatibility\r\n    subscribeToMotos(franchiseId: string, callback: (assets: Moto[]) => void) {\r\n        return this.subscribeToFleet(franchiseId, callback);\r\n    },\r\n    async updateMoto(id: string, data: Partial<Moto>): Promise<void> {\r\n        return this.updateVehicle(id, data);\r\n    },\r\n\r\n    // Vehicle store compatibility\r\n    async getVehicles(franchiseId: string): Promise<any[]> {\r\n        const q = query(collection(db, ASSETS_COLLECTION), where('franchiseId', '==', franchiseId));\r\n        const snap = await getDocs(q);\r\n        return snap.docs.map(mapDocToMoto);\r\n    },\r\n    async createVehicle(franchiseId: string, data: any): Promise<any> {\r\n        // Standardize input if it uses snake_case (Legacy Vehicle store)\r\n        const standardized: CreateMotoInput = {\r\n            plate: data.matricula || data.plate,\r\n            brand: data.brand || '',\r\n            model: data.modelo || data.model,\r\n            currentKm: data.km_actuales || data.currentKm || 0,\r\n            nextRevisionKm: data.proxima_revision_km || data.nextRevisionKm || 5000,\r\n            status: (data.estado === 'activo' ? 'active' : (data.estado === 'mantenimiento' ? 'maintenance' : (data.estado || 'active'))) as any\r\n        };\r\n        return this.createMoto(franchiseId, standardized);\r\n    }\r\n};\r\n\r\n// Aliases for backward compatibility during migration\r\nexport const FleetService = fleetService;\r\nexport const vehicleService = fleetService;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\services\\fleet\\fleetService.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\services\\franchiseService.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":86,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":86,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3076,3079],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3076,3079],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":111,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":111,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4067,4070],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4067,4070],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":123,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":123,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4683,4686],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4683,4686],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { doc, getDoc, collection, getDocs, query, where } from 'firebase/firestore';\r\nimport { db } from '../lib/firebase';\r\nimport type { Result } from '../types/result';\r\nimport type { FranchiseMetadata, FranchiseError } from '../types/franchise';\r\nimport { ok, err, isOk } from '../types/result';\r\n\r\n/**\r\n * Fetch franchise data from Firestore\r\n * franchiseId should be the UID of the user document\r\n */\r\nconst fetchFromFirestore = async (franchiseId: string): Promise<FranchiseMetadata | null> => {\r\n    try {\r\n        // Use franchiseId as UID to lookup user document directly\r\n        const docRef = doc(db, 'users', franchiseId);\r\n        const snapshot = await getDoc(docRef);\r\n\r\n        if (!snapshot.exists()) return null;\r\n\r\n        const data = snapshot.data();\r\n\r\n        // Verify this is a franchise user\r\n        if (data.role !== 'franchise') return null;\r\n\r\n        return {\r\n            id: data.franchiseId || snapshot.id,\r\n            name: data.name || data.displayName || 'Franquicia Sin Nombre',\r\n            location: data.address || 'Sin direcci√≥n',\r\n            ...data\r\n        } as FranchiseMetadata;\r\n    } catch (error) {\r\n        console.error('Error fetching franchise:', error);\r\n        return null;\r\n    }\r\n};\r\n\r\n/**\r\n * FranchiseService - Clean production code\r\n * NO dev/mock logic here - use MSW or repository pattern for testing\r\n */\r\nexport const franchiseService = {\r\n    /**\r\n     * Get franchise metadata by ID\r\n     * @param franchiseId - Unique franchise identifier (should be user UID)\r\n     * @returns Result with FranchiseMetadata or specific error type\r\n     * \r\n     * @example\r\n     * ```ts\r\n     * const result = await franchiseService.getFranchiseMeta('f-123');\r\n     * if (isOk(result)) {\r\n     *   console.log(result.data.name);\r\n     * } else {\r\n     *   // Handle result.error.type\r\n     * }\r\n     * ```\r\n     */\r\n    getFranchiseMeta: async (\r\n        franchiseId: string\r\n    ): Promise<Result<FranchiseMetadata, FranchiseError>> => {\r\n        try {\r\n            let data = await fetchFromFirestore(franchiseId);\r\n\r\n            // FALLBACK: Try finding by NAME if ID lookup failed (Case Insensitive)\r\n            if (!data) {\r\n                console.warn(`Franchise ID '${franchiseId}' not found. Trying lookup by name...`);\r\n                // Fetch all and find (small collection, safe for client-side filtering)\r\n                const allResult = await franchiseService.getAllFranchises();\r\n\r\n                if (isOk(allResult)) {\r\n                    const match = allResult.data.find((f: FranchiseMetadata) =>\r\n                        f.name.toLowerCase().trim() === franchiseId.toLowerCase().trim()\r\n                    );\r\n\r\n                    if (match) {\r\n                        data = match;\r\n                        console.log(`Resolved '${franchiseId}' to ID '${data.id}'`);\r\n                    }\r\n                }\r\n            }\r\n\r\n            if (!data) {\r\n                return err({ type: 'NOT_FOUND', franchiseId });\r\n            }\r\n\r\n            return ok(data);\r\n\r\n        } catch (error: any) {\r\n            // Firebase permission errors\r\n            if (error.code === 'permission-denied') {\r\n                return err({ type: 'PERMISSION_DENIED', franchiseId });\r\n            }\r\n\r\n            // Network or unknown errors\r\n            return err({\r\n                type: 'NETWORK_ERROR',\r\n                cause: error instanceof Error ? error : new Error(String(error))\r\n            });\r\n        }\r\n    },\r\n\r\n    /**\r\n     * Get ALL franchises (from users collection where role='franchise')\r\n     */\r\n    getAllFranchises: async (): Promise<Result<FranchiseMetadata[], FranchiseError>> => {\r\n        try {\r\n            // Query users with role='franchise' instead of separate franchises collection\r\n            const colRef = collection(db, 'users');\r\n            const q = query(colRef, where('role', '==', 'franchise'));\r\n            const snapshot = await getDocs(q);\r\n\r\n            const franchises = snapshot.docs.map(doc => {\r\n                const data = doc.data() as any; // Type assertion for Firestore data\r\n                return {\r\n                    id: data.franchiseId || doc.id, // Use franchiseId field or doc ID as fallback\r\n                    name: data.name || data.displayName || data.email || 'Franquicia Sin Nombre',\r\n                    location: data.address || data.location || 'Sin direcci√≥n',\r\n                    status: data.status || 'active',\r\n                    uid: doc.id, // User UID for compatibility\r\n                    ...data\r\n                } as FranchiseMetadata;\r\n            });\r\n\r\n            return ok(franchises);\r\n        } catch (error: any) {\r\n            console.error('Error fetching franchises from users:', error);\r\n            return err({\r\n                type: 'NETWORK_ERROR',\r\n                cause: error instanceof Error ? error : new Error(String(error))\r\n            });\r\n        }\r\n    }\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\services\\intelService.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":13,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":13,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[418,421],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[418,421],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react';\r\nimport { startOfWeek, endOfWeek, isWithinInterval } from 'date-fns';\r\nimport { toLocalDateString } from '../utils/dateUtils';\r\n\r\nexport interface IntellectualEvent {\r\n    id: string;\r\n    type: 'holiday' | 'match' | 'custom';\r\n    title: string;\r\n    subtitle?: string;\r\n    date: Date;\r\n    severity: 'info' | 'warning' | 'critical';\r\n    impact: string;\r\n    metadata?: any;\r\n}\r\n\r\n// 2026 Spanish National Holidays (Simplified)\r\nconst HOLIDAYS_2026 = [\r\n    { date: new Date(2026, 0, 1), title: 'A√±o Nuevo' },\r\n    { date: new Date(2026, 0, 6), title: 'Epifan√≠a del Se√±or' },\r\n    { date: new Date(2026, 3, 2), title: 'Jueves Santo' },\r\n    { date: new Date(2026, 3, 3), title: 'Viernes Santo' },\r\n    { date: new Date(2026, 4, 1), title: 'Fiesta del Trabajo' },\r\n    { date: new Date(2026, 7, 15), title: 'Asunci√≥n de la Virgen' },\r\n    { date: new Date(2026, 9, 12), title: 'Fiesta Nacional de Espa√±a' },\r\n    { date: new Date(2026, 10, 1), title: 'Todos los Santos' },\r\n    { date: new Date(2026, 11, 6), title: 'D√≠a de la Constituci√≥n' },\r\n    { date: new Date(2026, 11, 8), title: 'Inmaculada Concepci√≥n' },\r\n    { date: new Date(2026, 11, 25), title: 'Natividad del Se√±or' },\r\n];\r\n\r\n\r\nexport const intelService = {\r\n    getIntelForWeek: async (dateInRange: Date): Promise<IntellectualEvent[]> => {\r\n        const start = startOfWeek(dateInRange, { weekStartsOn: 1 });\r\n        const end = endOfWeek(dateInRange, { weekStartsOn: 1 });\r\n        const events: IntellectualEvent[] = [];\r\n\r\n        // 1. Process Holidays\r\n        HOLIDAYS_2026.forEach(h => {\r\n            if (isWithinInterval(h.date, { start, end })) {\r\n                events.push({\r\n                    id: `holiday-${h.date.getTime()}`,\r\n                    type: 'holiday',\r\n                    title: `Festivo: ${h.title}`,\r\n                    subtitle: 'Aumento de demanda esperado',\r\n                    date: h.date,\r\n                    severity: 'warning',\r\n                    impact: 'increase_fleet'\r\n                });\r\n            }\r\n        });\r\n\r\n        // Mock sports removed by user request (non-real data)\r\n        return events;\r\n    },\r\n\r\n    getEventsByDay: (events: IntellectualEvent[]): Record<string, IntellectualEvent[]> => {\r\n        const grouped: Record<string, IntellectualEvent[]> = {};\r\n        events.forEach(event => {\r\n            const dateKey = toLocalDateString(event.date);\r\n            if (!grouped[dateKey]) grouped[dateKey] = [];\r\n            grouped[dateKey].push(event);\r\n        });\r\n        return grouped;\r\n    }\r\n};\r\n\r\nexport const useOperationsIntel = (referenceDate: Date) => {\r\n    const [events, setEvents] = useState<IntellectualEvent[]>([]);\r\n    const [loading, setLoading] = useState(true);\r\n\r\n    useEffect(() => {\r\n        const loadIntel = async () => {\r\n            setLoading(true);\r\n            const data = await intelService.getIntelForWeek(referenceDate);\r\n            setEvents(data);\r\n            setLoading(false);\r\n        };\r\n        loadIntel();\r\n    }, [referenceDate]);\r\n\r\n    return {\r\n        events,\r\n        loading\r\n    };\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\services\\migrationService.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":128,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":128,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5395,5398],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5395,5398],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":222,"column":70,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":222,"endColumn":73,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10459,10462],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10459,10462],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":252,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":252,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11916,11919],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11916,11919],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":305,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":305,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14170,14173],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14170,14173],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { db } from '../lib/firebase';\r\nimport { collection, getDocs, writeBatch, doc, query, where, updateDoc, serverTimestamp } from 'firebase/firestore';\r\n\r\nexport const migrationService = {\r\n    /**\r\n     * Misi√≥n: Encontrar registros antiguos sin 'status' y curarlos.\r\n     * Acci√≥n: status -> 'approved', is_locked -> true.\r\n     */\r\n    fixZombieData: async () => {\r\n        console.log(\"üßü Iniciando b√∫squeda de datos zombis...\");\r\n\r\n        try {\r\n            // 1. Obtener TODO (Para una app peque√±a/mediana esto est√° bien. \r\n            // Para miles de registros se necesitar√≠a paginaci√≥n).\r\n            const snapshot = await getDocs(collection(db, 'financial_records'));\r\n\r\n            // Firestore Batch solo permite 500 operaciones por lote.\r\n            // Aqu√≠ hacemos una implementaci√≥n simple. Si tienes >500 registros antiguos,\r\n            // av√≠same para darte la versi√≥n paginada.\r\n            const batch = writeBatch(db);\r\n            let count = 0;\r\n\r\n            snapshot.docs.forEach(d => {\r\n                const data = d.data();\r\n\r\n                // DETECTOR DE ZOMBIS: ¬øLe falta el status?\r\n                if (!data.status) {\r\n                    const ref = doc(db, 'financial_records', d.id);\r\n                    batch.update(ref, {\r\n                        status: 'approved', // Asumimos que lo viejo es v√°lido\r\n                        is_locked: true,    // Lo cerramos para protegerlo\r\n                        updated_at: new Date(),\r\n                        _migrated: true     // Marca de agua para saber que fuimos nosotros\r\n                    });\r\n                    count++;\r\n                }\r\n            });\r\n\r\n            // 2. Ejecutar la cura\r\n            if (count > 0) {\r\n                await batch.commit();\r\n                console.log(`‚úÖ √âXITO: Se han curado ${count} registros zombis.`);\r\n                return { success: true, count };\r\n            } else {\r\n                console.log(\"‚ú® LIMPIO: No se encontraron registros antiguos.\");\r\n                return { success: true, count: 0 };\r\n            }\r\n\r\n        } catch (error) {\r\n            console.error(\"‚ùå ERROR en Migraci√≥n:\", error);\r\n            return { success: false, error };\r\n        }\r\n    },\r\n\r\n    /**\r\n     * Misi√≥n: Migrar colecciones mal nombradas a la estructura correcta V12.\r\n     * 1. financial_data -> financial_records\r\n     * 2. academy_modules -> academy_courses\r\n     */\r\n    migrateCollections: async () => {\r\n        console.log(\"üöö Iniciando migraci√≥n de colecciones...\");\r\n        try {\r\n            const batch = writeBatch(db);\r\n            let count = 0;\r\n\r\n            // --- 1. Finance Migration ---\r\n            const financeSnap = await getDocs(collection(db, 'financial_data'));\r\n            if (!financeSnap.empty) {\r\n                console.log(`Found ${financeSnap.size} financial_data records. Moving...`);\r\n                financeSnap.forEach(d => {\r\n                    const data = d.data();\r\n                    const newRef = doc(db, 'financial_records', d.id);\r\n                    batch.set(newRef, { ...data, _migratedFrom: 'financial_data' });\r\n                    // Optional: Delete old doc? Keeping it safer for manual deletion later\r\n                    // batch.delete(d.ref); \r\n                    count++;\r\n                });\r\n            }\r\n\r\n            // --- 2. Academy Migration ---\r\n            const academySnap = await getDocs(collection(db, 'academy_modules'));\r\n            if (!academySnap.empty) {\r\n                console.log(`Found ${academySnap.size} academy_modules records. Moving...`);\r\n                academySnap.forEach(d => {\r\n                    const data = d.data();\r\n                    const newRef = doc(db, 'academy_courses', d.id);\r\n                    batch.set(newRef, { ...data, _migratedFrom: 'academy_modules' });\r\n                    count++;\r\n                });\r\n            }\r\n\r\n            if (count > 0) {\r\n                await batch.commit();\r\n                console.log(`‚úÖ MIGRACI√ìN EXITOSA: ${count} documentos movidos.`);\r\n                return { success: true, count };\r\n            } else {\r\n                console.log(\"‚ú® Nada que migrar.\");\r\n                return { success: true, count: 0 };\r\n            }\r\n\r\n        } catch (error) {\r\n            console.error(\"‚ùå ERROR en Migraci√≥n de Colecciones:\", error);\r\n            return { success: false, error };\r\n        }\r\n    },\r\n\r\n    /**\r\n     * Misi√≥n: Eliminar turnos de riders que ya no existen en la colecci√≥n 'users'.\r\n     * Problema: El planificador muestra \"Fantasmas\" porque encuentra turnos hu√©rfanos.\r\n     */\r\n    cleanOrphanedShifts: async (franchiseId?: string, _weekId?: string) => {\r\n        console.log(\"üëª Buscando turnos fantasmas (GOD MODE)...\");\r\n        let report = \"\";\r\n        const log = (msg: string) => { console.log(msg); report += msg + \"\\n\"; };\r\n\r\n        try {\r\n            // --- PREPARACI√ìN ---\r\n            const batch = writeBatch(db);\r\n            let deletedCount = 0;\r\n\r\n            // 1. OBTENER RIDERS ACTIVOS E INACTIVOS (De ambas colecciones posibles)\r\n            const ridersSnap = await getDocs(collection(db, 'riders'));\r\n            const usersSnap = await getDocs(collection(db, 'users'));\r\n\r\n            const activeRiderFranchiseMap = new Map<string, string>();\r\n            const inactiveRiderIds = new Set<string>();\r\n\r\n            const processRiderDoc = (d: any, collectionName: string) => {\r\n                const data = d.data();\r\n                const name = (data.fullName || data.displayName || \"\").toLowerCase();\r\n                const email = (data.email || \"\").toLowerCase();\r\n                const isValentino = name.includes('valentino') || email.includes('valentino') || d.id === 'valentino';\r\n\r\n                if (isValentino) {\r\n                    log(`üéØ DETECTADO VALENTINO en ${collectionName}: ID=${d.id}, Status=${data.status}`);\r\n                    // Si est√° activo, lo marcamos para borrar/desactivar\r\n                    if (data.status !== 'inactive' && data.status !== 'deleted') {\r\n                        inactiveRiderIds.add(d.id);\r\n                        // No lo borramos del tir√≥n para dejar rastro pero lo desactivamos\r\n                        log(`   ‚öîÔ∏è Desactivando Valentino en ${collectionName}...`);\r\n                        batch.update(d.ref, { status: 'inactive', _ghostBusted: serverTimestamp() });\r\n                        deletedCount++;\r\n                    } else {\r\n                        inactiveRiderIds.add(d.id);\r\n                    }\r\n                } else if (data.status === 'inactive' || data.status === 'deleted') {\r\n                    inactiveRiderIds.add(d.id);\r\n                } else {\r\n                    activeRiderFranchiseMap.set(d.id, data.franchiseId);\r\n                }\r\n            };\r\n\r\n            ridersSnap.forEach(d => processRiderDoc(d, 'riders'));\r\n            usersSnap.forEach(d => processRiderDoc(d, 'users'));\r\n\r\n            log(`üìä Riders Activos: ${activeRiderFranchiseMap.size}`);\r\n            log(`‚ùå Riders Inactivos/Borrados: ${inactiveRiderIds.size}`);\r\n\r\n            // 2. LIMPIEZA DE TURNOS EN COLECCIONES PLANAS\r\n            const collectionsToScan = ['shifts', 'work_shifts', 'franchise_shifts'];\r\n\r\n            for (const collName of collectionsToScan) {\r\n                log(`üßπ Escaneando colecci√≥n: ${collName}...`);\r\n                const snap = await getDocs(collection(db, collName));\r\n\r\n                snap.forEach(d => {\r\n                    const data = d.data();\r\n                    const riderId = data.riderId || data.rider_id;\r\n                    const riderName = (data.riderName || data.rider_name || \"\").toLowerCase();\r\n                    const shiftFranchiseId = data.franchiseId || data.franchise_id;\r\n\r\n                    let shouldDelete = false;\r\n\r\n                    // Criterio 1: Nombre contiene Valentino\r\n                    if (riderName.includes('valentino')) {\r\n                        log(`   üëª Eliminando turno por NOMBRE en ${collName}: ${riderName} (ID: ${d.id})`);\r\n                        shouldDelete = true;\r\n                    }\r\n                    // Criterio 2: Rider ID inactivo o desconocido\r\n                    else if (riderId) {\r\n                        if (inactiveRiderIds.has(riderId)) {\r\n                            log(`   üóëÔ∏è Eliminando turno en ${collName} de rider inactivo: ${riderId}`);\r\n                            shouldDelete = true;\r\n                        } else if (!activeRiderFranchiseMap.has(riderId)) {\r\n                            log(`   üóëÔ∏è Eliminando turno en ${collName} de rider inexistente: ${riderId}`);\r\n                            shouldDelete = true;\r\n                        } else {\r\n                            // Criterio 3: Mismatch de franquicia\r\n                            const riderFranchiseId = activeRiderFranchiseMap.get(riderId);\r\n                            if (shiftFranchiseId && riderFranchiseId && shiftFranchiseId !== riderFranchiseId) {\r\n                                log(`   üëª Eliminando turno GHOST (Mismatch) en ${collName}: shift in ${shiftFranchiseId}, rider in ${riderFranchiseId}`);\r\n                                shouldDelete = true;\r\n                            }\r\n                        }\r\n                    }\r\n\r\n                    if (shouldDelete) {\r\n                        batch.delete(d.ref);\r\n                        deletedCount++;\r\n                    }\r\n                });\r\n            }\r\n\r\n            // 3. LEGACY CLEANUP (SCAN ALL WEEKS)\r\n            // Esto toca los arrays internos de los documentos de la colecci√≥n 'weeks'\r\n            if (franchiseId) {\r\n                log(`üßπ Escaneando TODAS las semanas en: franchises/${franchiseId}/weeks`);\r\n                const weeksRef = collection(db, 'franchises', franchiseId, 'weeks');\r\n                const weeksSnap = await getDocs(weeksRef);\r\n\r\n                for (const weekDoc of weeksSnap.docs) {\r\n                    const weekData = weekDoc.data();\r\n                    const weekId = weekDoc.id;\r\n                    const fullJson = JSON.stringify(weekData).toLowerCase();\r\n\r\n                    if (fullJson.includes('valentino')) {\r\n                        log(`üö® MATCH FOUND in week [${weekId}]! Analyzing shifts array...`);\r\n\r\n                        const currentShifts = weekData.shifts || [];\r\n                        let legacyDeleted = 0;\r\n\r\n                        const cleanShifts = currentShifts.filter((s: any) => {\r\n                            const json = JSON.stringify(s).toLowerCase();\r\n                            if (json.includes('valentino')) {\r\n                                log(`   üëª Eliminando turno Valentino en array de [${weekId}]: ${json.substring(0, 100)}...`);\r\n                                legacyDeleted++;\r\n                                return false;\r\n                            }\r\n                            return true;\r\n                        });\r\n\r\n                        await updateDoc(weekDoc.ref, { shifts: cleanShifts, _ghostBusted: serverTimestamp() });\r\n                        deletedCount += legacyDeleted;\r\n                        log(`‚úÖ Limpiados ${legacyDeleted} turnos en array de semana ${weekId}`);\r\n                    } else {\r\n                        // FORCE CACHE REFRESH anyway to be sure\r\n                        await updateDoc(weekDoc.ref, { _ghostBusted: serverTimestamp() });\r\n                    }\r\n                }\r\n            }\r\n\r\n            // --- TRABAJO FINAL ---\r\n            if (deletedCount > 0) {\r\n                await batch.commit();\r\n                log(`‚úÖ LIMPIEZA COMPLETADA: ${deletedCount} operaciones realizadas.`);\r\n                return { success: true, count: deletedCount, report };\r\n            } else {\r\n                log(\"‚ú® Nada que limpiar. Todo parece en orden.\");\r\n                return { success: true, count: 0, report };\r\n            }\r\n\r\n        } catch (error: any) {\r\n            console.error(\"‚ùå ERROR en Limpieza de Fantasmas:\", error);\r\n            return { success: false, error, report: report + `\\nERROR: ${error.message}` };\r\n        }\r\n    },\r\n\r\n    /**\r\n     * Misi√≥n: Eliminar turnos duplicados (mismo rider, misma hora de inicio).\r\n     */\r\n    cleanDuplicateShifts: async (franchiseId: string) => {\r\n        console.log(\"üëØ Buscando duplicados para la franquicia:\", franchiseId);\r\n        let report = `DEDUP REPORT - ${new Date().toISOString()}\\n`;\r\n        const log = (msg: string) => { console.log(msg); report += msg + \"\\n\"; };\r\n\r\n        try {\r\n            const batch = writeBatch(db);\r\n            let deletedCount = 0;\r\n\r\n            // 1. OBTENER TODOS LOS TURNOS DE LA FRANQUICIA\r\n            const q = query(collection(db, 'work_shifts'), where('franchise_id', '==', franchiseId));\r\n            const snap = await getDocs(q);\r\n\r\n            log(`üìä Analizando ${snap.size} turnos...`);\r\n\r\n            // Agrupar por rider y tiempo de inicio\r\n            const seen = new Map<string, string>(); // key: riderId_startTime, value: firstFoundDocId\r\n\r\n            snap.docs.forEach(d => {\r\n                const data = d.data();\r\n                const riderId = data.rider_id;\r\n                const startTime = data.start_time?.toDate().getTime();\r\n\r\n                if (riderId && startTime) {\r\n                    const key = `${riderId}_${startTime}`;\r\n                    if (seen.has(key)) {\r\n                        log(`   üëØ DUPLICADO DETECTADO: Rider=${riderId}, Inicio=${new Date(startTime).toLocaleString()}. Borrando doc ${d.id}`);\r\n                        batch.delete(d.ref);\r\n                        deletedCount++;\r\n                    } else {\r\n                        seen.set(key, d.id);\r\n                    }\r\n                }\r\n            });\r\n\r\n            if (deletedCount > 0) {\r\n                await batch.commit();\r\n                log(`‚úÖ DEDUPLICACI√ìN COMPLETADA: ${deletedCount} turnos eliminados.`);\r\n                return { success: true, count: deletedCount, report };\r\n            } else {\r\n                log(\"‚ú® No se encontraron duplicados exactos.\");\r\n                return { success: true, count: 0, report };\r\n            }\r\n\r\n        } catch (error: any) {\r\n            console.error(\"‚ùå ERROR en Deduplicaci√≥n:\", error);\r\n            return { success: false, error, report: report + `\\nERROR: ${error.message}` };\r\n        }\r\n    }\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\services\\mocks\\financeMocks.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":22,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[555,558],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[555,558],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Mock data generator for financial closures.\r\n * Used for development and testing purposes when backend is unavailable or for prototyping.\r\n */\r\n\r\nexport const CLOSURE_STATUS = {\r\n    VERIFIED: 'verified',\r\n    CLOSED: 'closed',\r\n    DRAFT: 'draft'\r\n} as const;\r\n\r\nexport interface MockClosure {\r\n    id: string;\r\n    month: string;\r\n    revenue: number;\r\n    expenses: number;\r\n    profit: number;\r\n    margin: number;\r\n    status: typeof CLOSURE_STATUS[keyof typeof CLOSURE_STATUS];\r\n    editor: string;\r\n    submittedAt: string;\r\n    documents: any[];\r\n    breakdown: {\r\n        labor: number;\r\n        marketing: number;\r\n        cogs: number;\r\n    };\r\n}\r\n\r\nexport const generateMockData = (count: number): MockClosure[] => Array.from({ length: count }).map((_, i) => {\r\n    // Generate valid revenue and expenses first\r\n    const revenue = Math.floor(15000 + Math.random() * 8000);\r\n    const expenses = Math.floor(10000 + Math.random() * 4000);\r\n\r\n    // Calculate derived values for consistency\r\n    const profit = revenue - expenses;\r\n    const margin = revenue > 0 ? (profit / revenue) * 100 : 0;\r\n\r\n    return {\r\n        id: `closure-${i}`,\r\n        month: `202${3 - Math.floor(i / 12)}-${String(12 - (i % 12)).padStart(2, '0')}`,\r\n        revenue,\r\n        expenses,\r\n        profit,\r\n        margin,\r\n        status: i > 2 ? CLOSURE_STATUS.VERIFIED : (i === 0 ? CLOSURE_STATUS.DRAFT : CLOSURE_STATUS.CLOSED),\r\n        editor: 'Admin',\r\n        submittedAt: new Date().toISOString(),\r\n        documents: [],\r\n        breakdown: { labor: Math.floor(expenses * 0.4), marketing: Math.floor(expenses * 0.2), cogs: Math.floor(expenses * 0.4) }\r\n    };\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\services\\notificationService.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":17,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":17,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[870,873],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[870,873],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":15,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":15,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[827,830],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[827,830],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":35,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":35,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1387,1390],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1387,1390],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { db } from '../lib/firebase';\r\nimport { collection, addDoc, serverTimestamp, doc, updateDoc } from 'firebase/firestore';\r\n\r\nexport type NotificationType = 'FINANCE_CLOSING' | 'RATE_CHANGE' | 'SUPPORT_TICKET' | 'UNLOCK_REQUEST' | 'MONTH_UNLOCKED' | 'UNLOCK_REJECTED' | 'ALERT' | 'PREMIUM_SERVICE_REQUEST' | 'shift_confirmed' | 'shift_change_request' | 'incident' | 'SCHEDULE_PUBLISHED' | 'SYSTEM' | 'DOCUMENT_REQUEST';\r\nexport type NotificationPriority = 'low' | 'normal' | 'high';\r\n\r\nexport interface NotificationPayload {\r\n    type: NotificationType;\r\n    franchiseId: string;\r\n    franchiseName: string; // Denormalized for easier display\r\n    priority: NotificationPriority;\r\n    title: string;\r\n    message: string;\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    metadata?: Record<string, any>;\r\n    read: boolean;\r\n    createdAt?: any;\r\n    riderId?: string;\r\n    relatedShiftId?: string;\r\n}\r\n\r\nexport const notificationService = {\r\n    /**\r\n     * Creates a new notification for Admins\r\n     */\r\n    notify: async (\r\n        type: NotificationType,\r\n        franchiseId: string,\r\n        franchiseName: string,\r\n        data: {\r\n            title: string;\r\n            message: string;\r\n            priority?: NotificationPriority;\r\n            // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n            metadata?: Record<string, any>;\r\n        }\r\n    ) => {\r\n        try {\r\n            const payload: NotificationPayload = {\r\n                type,\r\n                franchiseId,\r\n                franchiseName,\r\n                title: data.title,\r\n                message: data.message,\r\n                priority: data.priority || 'normal',\r\n                metadata: data.metadata || {},\r\n                read: false,\r\n                createdAt: serverTimestamp()\r\n            };\r\n\r\n            await addDoc(collection(db, 'admin_notifications'), payload);\r\n            console.log(`[NotificationService] Sent ${type}:`, payload);\r\n        } catch (error) {\r\n            console.error('[NotificationService] Failed to send notification:', error);\r\n            // We don't throw here to avoid blocking the main user action if notification fails\r\n        }\r\n    },\r\n\r\n\r\n\r\n    /**\r\n     * Marks an admin notification as read\r\n     */\r\n    markAsRead: async (notificationId: string) => {\r\n        try {\r\n            const docRef = doc(db, 'admin_notifications', notificationId);\r\n            await updateDoc(docRef, { read: true });\r\n        } catch (error) {\r\n            console.error('[NotificationService] Failed to mark as read:', error);\r\n        }\r\n    },\r\n\r\n    /**\r\n     * Notify a specific Franchise (User)\r\n     */\r\n    notifyFranchise: async (\r\n        userId: string,\r\n        data: {\r\n            title: string;\r\n            message: string;\r\n            type?: NotificationType;\r\n            priority?: NotificationPriority;\r\n            link?: string;\r\n        }\r\n    ) => {\r\n        try {\r\n            const payload = {\r\n                userId,\r\n                title: data.title,\r\n                message: data.message,\r\n                type: data.type || 'SYSTEM',\r\n                priority: data.priority || 'normal',\r\n                link: data.link || '',\r\n                read: false,\r\n                createdAt: serverTimestamp()\r\n            };\r\n            await addDoc(collection(db, 'notifications'), payload);\r\n        } catch (error) {\r\n            console.error('[NotificationService] Failed to notify franchise:', error);\r\n        }\r\n    },\r\n\r\n    /**\r\n     * Notify about Rider Actions (Shift changes/incidents)\r\n     */\r\n    notifyRiderAction: async (\r\n        franchiseId: string,\r\n        riderId: string,\r\n        data: {\r\n            type: 'shift_confirmed' | 'shift_change_request' | 'incident';\r\n            title: string;\r\n            message: string;\r\n            relatedShiftId?: string;\r\n        }\r\n    ) => {\r\n        try {\r\n            const payload = {\r\n                userId: franchiseId, // Mapping franchiseId to userId for UI visibility\r\n                franchiseId,\r\n                riderId,\r\n                type: data.type,\r\n                title: data.title,\r\n                message: data.message,\r\n                relatedShiftId: data.relatedShiftId || null,\r\n                read: false,\r\n                createdAt: serverTimestamp()\r\n            };\r\n            // According to schema, this goes to 'notifications' collection\r\n            await addDoc(collection(db, 'notifications'), payload);\r\n        } catch (error) {\r\n            console.error('[NotificationService] Failed to notify rider action:', error);\r\n        }\r\n    }\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\services\\operationsService.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":35,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":35,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[902,905],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[902,905],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":46,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":46,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1190,1193],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1190,1193],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":59,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":59,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1542,1545],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1542,1545],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":117,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":117,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3770,3773],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3770,3773],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":196,"column":89,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":196,"endColumn":92,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6658,6661],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6658,6661],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { db } from '../lib/firebase';\r\nimport {\r\n    collection,\r\n    query,\r\n    where,\r\n    getDocs,\r\n    addDoc,\r\n    updateDoc,\r\n    deleteDoc,\r\n    doc,\r\n    serverTimestamp,\r\n    writeBatch,\r\n    Timestamp,\r\n    DocumentData\r\n} from 'firebase/firestore';\r\n\r\n// ==========================================\r\n// TYPES\r\n// ==========================================\r\n\r\nexport interface Rider {\r\n    id: string;\r\n    fullName: string;\r\n    phone: string;\r\n    role: 'rider' | 'staff' | 'admin' | 'franchise' | 'developer';\r\n    franchiseId?: string;\r\n    status: 'active' | 'inactive' | 'deleted';\r\n    drivingLicenseExpiry?: string | null; // YYYY-MM-DD\r\n    punctualityScore?: number;\r\n    completedShifts?: number;\r\n    displayName?: string; // Legacy/Auth sync\r\n    phoneNumber?: string; // Legacy/Auth sync\r\n    createdAt?: Timestamp | Date;\r\n    updatedAt?: Timestamp | Date;\r\n    [key: string]: any; // Flexibilidad para campos extra\r\n}\r\n\r\nexport interface Moto {\r\n    id: string;\r\n    plate: string;\r\n    model: string;\r\n    franchiseId: string;\r\n    status: 'active' | 'maintenance' | 'deleted';\r\n    year?: number;\r\n    lastMaintenance?: string; // YYYY-MM-DD\r\n    [key: string]: any;\r\n}\r\n\r\nexport interface Shift {\r\n    id: string;\r\n    franchiseId: string;\r\n    riderId: string;\r\n    motoId?: string;\r\n    date: string; // YYYY-MM-DD\r\n    startTime: string; // HH:mm\r\n    endTime: string; // HH:mm\r\n    type: 'morning' | 'afternoon' | 'night' | 'custom';\r\n    status?: 'scheduled' | 'completed' | 'cancelled';\r\n    [key: string]: any;\r\n}\r\n\r\n// ==========================================\r\n// SERVICE\r\n// ==========================================\r\n\r\nconst COLLECTIONS = {\r\n    RIDERS: 'users', // Unificado con colecci√≥n principal de usuarios\r\n    MOTOS: 'franchise_motos',\r\n    SHIFTS: 'franchise_shifts'\r\n} as const;\r\n\r\nexport const operationsService = {\r\n    // --- RIDERS (Drivers & Staff) ---\r\n    fetchRiders: async (franchiseId: string): Promise<Rider[]> => {\r\n        if (!franchiseId) return [];\r\n\r\n        // QUERY SIMPLIFICADA: Evitar √≠ndices compuestos faltantes.\r\n        const q = query(\r\n            collection(db, COLLECTIONS.RIDERS),\r\n            where('franchiseId', '==', franchiseId)\r\n        );\r\n\r\n        const snapshot = await getDocs(q);\r\n        const allFranchiseUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() } as Rider));\r\n\r\n        // Filtrado en memoria (Infalible)\r\n        return allFranchiseUsers.map(data => ({\r\n            ...data,\r\n            fullName: data.displayName || data.name || data.fullName || 'Sin Nombre',\r\n            phone: data.phoneNumber || data.phone || '',\r\n            drivingLicenseExpiry: data.drivingLicenseExpiry || null,\r\n            punctualityScore: data.punctualityScore || 10.0,\r\n            completedShifts: data.completedShifts || 0\r\n        })).filter(user =>\r\n            // 1. Debe ser driver o staff\r\n            ['rider', 'staff'].includes(user.role) &&\r\n            // 2. No debe estar borrado\r\n            user.status !== 'deleted'\r\n        );\r\n    },\r\n\r\n    createRider: async (riderData: Partial<Rider>): Promise<DocumentData> => {\r\n        // NOTA: Esto crea el documento en Firestore pero NO la cuenta de Auth.\r\n        return await addDoc(collection(db, COLLECTIONS.RIDERS), {\r\n            ...riderData,\r\n            displayName: riderData.fullName, // Estandarizar\r\n            phoneNumber: riderData.phone,    // Estandarizar\r\n            role: 'rider',\r\n            status: 'active',\r\n            createdAt: serverTimestamp(),\r\n            updatedAt: serverTimestamp()\r\n        });\r\n    },\r\n\r\n    updateRider: async (riderId: string, updates: Partial<Rider>): Promise<void> => {\r\n        const ref = doc(db, COLLECTIONS.RIDERS, riderId);\r\n        const payload: any = { ...updates };\r\n\r\n        // Mapeo inverso para guardar estandarizado\r\n        if (payload.fullName) payload.displayName = payload.fullName;\r\n        if (payload.phone) payload.phoneNumber = payload.phone;\r\n\r\n        await updateDoc(ref, {\r\n            ...payload,\r\n            updatedAt: serverTimestamp()\r\n        });\r\n    },\r\n\r\n    deleteRider: async (riderId: string): Promise<void> => {\r\n        const ref = doc(db, COLLECTIONS.RIDERS, riderId);\r\n        await updateDoc(ref, { status: 'deleted' });\r\n    },\r\n\r\n    // --- MOTOS ---\r\n    fetchMotos: async (franchiseId: string): Promise<Moto[]> => {\r\n        if (!franchiseId) return [];\r\n        const q = query(\r\n            collection(db, COLLECTIONS.MOTOS),\r\n            where('franchiseId', '==', franchiseId),\r\n            where('status', '!=', 'deleted')\r\n        );\r\n        const snapshot = await getDocs(q);\r\n        return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() } as Moto));\r\n    },\r\n\r\n    createMoto: async (motoData: Partial<Moto>): Promise<DocumentData> => {\r\n        return await addDoc(collection(db, COLLECTIONS.MOTOS), {\r\n            ...motoData,\r\n            createdAt: serverTimestamp(),\r\n            updatedAt: serverTimestamp()\r\n        });\r\n    },\r\n\r\n    updateMoto: async (motoId: string, updates: Partial<Moto>): Promise<void> => {\r\n        const ref = doc(db, COLLECTIONS.MOTOS, motoId);\r\n        await updateDoc(ref, {\r\n            ...updates,\r\n            updatedAt: serverTimestamp()\r\n        });\r\n    },\r\n\r\n    deleteMoto: async (motoId: string): Promise<void> => {\r\n        const ref = doc(db, COLLECTIONS.MOTOS, motoId);\r\n        await updateDoc(ref, { status: 'deleted' });\r\n    },\r\n\r\n    // --- SHIFTS (SCHEDULER) ---\r\n    fetchWeekShifts: async (franchiseId: string, _startOfWeekStub?: string): Promise<Shift[]> => {\r\n        if (!franchiseId) return [];\r\n        const q = query(\r\n            collection(db, COLLECTIONS.SHIFTS),\r\n            where('franchiseId', '==', franchiseId)\r\n        );\r\n        const snapshot = await getDocs(q);\r\n        return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() } as Shift));\r\n    },\r\n\r\n    createShift: async (shiftData: Partial<Shift>): Promise<DocumentData> => {\r\n        return await addDoc(collection(db, COLLECTIONS.SHIFTS), {\r\n            ...shiftData,\r\n            createdAt: serverTimestamp()\r\n        });\r\n    },\r\n\r\n    updateShift: async (shiftId: string, updates: Partial<Shift>): Promise<void> => {\r\n        const ref = doc(db, COLLECTIONS.SHIFTS, shiftId);\r\n        await updateDoc(ref, { ...updates });\r\n    },\r\n\r\n    deleteShift: async (shiftId: string): Promise<void> => {\r\n        await deleteDoc(doc(db, COLLECTIONS.SHIFTS, shiftId));\r\n    },\r\n\r\n    // --- BULK OPERATIONS ---\r\n    // Stub typed for future implementation\r\n    copyWeek: async (_franchiseId: string, _sourceWeekShifts: Shift[], _targetDatesMap: any): Promise<void> => {\r\n        const batch = writeBatch(db);\r\n        // Implement logic here\r\n        await batch.commit();\r\n    }\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\services\\premiumServiceService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\services\\resourceRequestService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\services\\riderService.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":19,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":19,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[512,515],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[512,515],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":27,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":27,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[719,722],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[719,722],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { db } from '../lib/firebase';\r\nimport {\r\n    collection,\r\n    addDoc,\r\n    serverTimestamp,\r\n    DocumentData\r\n} from 'firebase/firestore';\r\n\r\nexport type IncidentType = 'accident' | 'breakdown' | 'traffic' | 'other';\r\n\r\nexport interface IncidentReport {\r\n    riderId: string;\r\n    franchiseId?: string;\r\n    type: IncidentType;\r\n    description: string;\r\n    isUrgent: boolean;\r\n    photoUrl?: string; // Placeholder for future upload\r\n    status: 'open' | 'investigating' | 'resolved';\r\n    createdAt: any;\r\n}\r\n\r\nexport interface VehicleChecklist {\r\n    riderId: string;\r\n    vehicleId?: string; // Optional if not assigned\r\n    items: string[]; // List of checked IDs\r\n    allClear: boolean;\r\n    createdAt: any;\r\n}\r\n\r\nconst COLLECTIONS = {\r\n    INCIDENTS: 'incidents',\r\n    CHECKS: 'vehicle_checks'\r\n};\r\n\r\nexport const riderService = {\r\n    /**\r\n     * Report a new incident\r\n     */\r\n    reportIncident: async (\r\n        riderId: string,\r\n        data: {\r\n            type: IncidentType;\r\n            description: string;\r\n            isUrgent: boolean;\r\n            franchiseId?: string\r\n        }\r\n    ): Promise<DocumentData> => {\r\n        const payload: IncidentReport = {\r\n            riderId,\r\n            franchiseId: data.franchiseId,\r\n            type: data.type,\r\n            description: data.description,\r\n            isUrgent: data.isUrgent,\r\n            status: 'open',\r\n            createdAt: serverTimestamp()\r\n        };\r\n        return await addDoc(collection(db, COLLECTIONS.INCIDENTS), payload);\r\n    },\r\n\r\n    /**\r\n     * Submit a vehicle pre-shift checklist\r\n     */\r\n    submitChecklist: async (\r\n        riderId: string,\r\n        data: {\r\n            items: string[];\r\n            vehicleId?: string;\r\n        }\r\n    ): Promise<DocumentData> => {\r\n        const payload: VehicleChecklist = {\r\n            riderId,\r\n            vehicleId: data.vehicleId,\r\n            items: data.items,\r\n            allClear: true, // If they submitted, it's because they checked everything (UI enforced)\r\n            createdAt: serverTimestamp()\r\n        };\r\n        return await addDoc(collection(db, COLLECTIONS.CHECKS), payload);\r\n    }\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\services\\scheduler\\weekService.test.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":108,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":108,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3963,3966],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3963,3966],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":119,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":119,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4482,4485],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4482,4485],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":133,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":133,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5030,5033],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5030,5033],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":146,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":146,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5500,5503],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5500,5503],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":166,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":166,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6262,6265],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6262,6265],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { describe, it, expect, vi, beforeEach } from 'vitest';\r\nimport { WeekService } from './weekService';\r\nimport { WeekDataSchema, toFranchiseId, toWeekId } from '../../schemas/scheduler';\r\nimport { doc, getDoc, setDoc } from 'firebase/firestore'; // Mocked below\r\n\r\n// --- Mocks ---\r\nvi.mock('firebase/firestore', () => ({\r\n    getFirestore: vi.fn(),\r\n    doc: vi.fn().mockReturnValue('mock-ref'),\r\n    getDoc: vi.fn(),\r\n    setDoc: vi.fn(),\r\n    onSnapshot: vi.fn(),\r\n    collection: vi.fn(),\r\n    query: vi.fn(),\r\n    where: vi.fn(),\r\n}));\r\n\r\nvi.mock('../../lib/firebase', () => ({\r\n    db: {}\r\n}));\r\n\r\nvi.spyOn(console, 'error').mockImplementation(() => { });\r\n\r\ndescribe('Scheduler Module', () => {\r\n\r\n    beforeEach(() => {\r\n        vi.clearAllMocks();\r\n    });\r\n\r\n    // 1. Zod Schema Validation Tests\r\n    describe('Zod Schemas', () => {\r\n        it('should validate a correct WeekData object', () => {\r\n            const validData = {\r\n                id: '2025_01',\r\n                startDate: '2025-01-01',\r\n                status: 'draft',\r\n                metrics: { totalHours: 0, activeRiders: 0, motosInUse: 0 },\r\n                shifts: []\r\n            };\r\n            const result = WeekDataSchema.safeParse(validData);\r\n            expect(result.success).toBe(true);\r\n        });\r\n\r\n        it('should fail with invalid date format', () => {\r\n            const invalidData = {\r\n                id: '2025_01',\r\n                startDate: '01-01-2025', // Wrong format\r\n                status: 'draft',\r\n                metrics: { totalHours: 0, activeRiders: 0, motosInUse: 0 },\r\n                shifts: []\r\n            };\r\n            const result = WeekDataSchema.safeParse(invalidData);\r\n            expect(result.success).toBe(false);\r\n            if (!result.success) {\r\n                expect(result.error.issues[0].message).toContain('Invalid date format');\r\n            }\r\n        });\r\n\r\n        it('should enforce default values', () => {\r\n            const minimalData = {\r\n                id: '2025_01',\r\n                startDate: '2025-01-01',\r\n                metrics: {} // Missing properties should get defaults\r\n            };\r\n            const result = WeekDataSchema.safeParse(minimalData);\r\n            expect(result.success).toBe(true);\r\n            if (result.success) {\r\n                expect(result.data.status).toBe('draft');\r\n                expect(result.data.shifts).toEqual([]);\r\n                expect(result.data.metrics.totalHours).toBe(0);\r\n            }\r\n        });\r\n    });\r\n\r\n    // 2. WeekService Logic Tests\r\n    describe('WeekService', () => {\r\n\r\n        describe('getWeekId', () => {\r\n            it('should correctly calculate ISO week for regular date', () => {\r\n                const date = new Date('2025-01-08T12:00:00Z');\r\n                // 8 Jan 2025 is in Week 2\r\n                expect(WeekService.getWeekId(date)).toBe('2025_02');\r\n            });\r\n\r\n            it('should handle year boundary correctly (late Dec)', () => {\r\n                const date = new Date('2025-12-31T12:00:00Z');\r\n                // Dec 31 2025 is Wednesday -> Week 53 of 2025\r\n                expect(WeekService.getWeekId(date)).toBe('2026_01');\r\n            });\r\n\r\n            it('should handle year boundary correctly (early Jan)', () => {\r\n                const date = new Date('2026-01-01T12:00:00Z');\r\n                // Jan 1 2026 is Thursday -> Week 1 of 2026\r\n                expect(WeekService.getWeekId(date)).toBe('2026_01');\r\n            });\r\n        });\r\n\r\n        describe('getWeek', () => {\r\n            it('should return validated data when document exists', async () => {\r\n                const mockData = {\r\n                    id: '2025_40',\r\n                    startDate: '2025-10-01',\r\n                    status: 'draft',\r\n                    metrics: { totalHours: 10, activeRiders: 1, motosInUse: 1 },\r\n                    shifts: []\r\n                };\r\n\r\n                (getDoc as any).mockResolvedValue({\r\n                    exists: () => true,\r\n                    data: () => mockData\r\n                });\r\n\r\n                const result = await WeekService.getWeek(toFranchiseId('f1'), toWeekId('2025_40'));\r\n                expect(result).toEqual(mockData);\r\n                expect(doc).toHaveBeenCalledWith(expect.anything(), 'franchises', 'f1', 'weeks', '2025_40');\r\n            });\r\n\r\n            it('should return null if document does not exist', async () => {\r\n                (getDoc as any).mockResolvedValue({\r\n                    exists: () => false\r\n                });\r\n\r\n                const result = await WeekService.getWeek(toFranchiseId('f1'), toWeekId('2025_99'));\r\n                expect(result).toBeNull();\r\n            });\r\n\r\n            it('should throw if data is invalid (Zod validation)', async () => {\r\n                const corruptData = {\r\n                    id: '2025_40',\r\n                    // Missing startDate\r\n                    metrics: { totalHours: 0 }\r\n                };\r\n                (getDoc as any).mockResolvedValue({\r\n                    exists: () => true,\r\n                    data: () => corruptData\r\n                });\r\n\r\n                await expect(WeekService.getWeek(toFranchiseId('f1'), toWeekId('2025_40')))\r\n                    .rejects\r\n                    .toThrow(); // ZodError\r\n            });\r\n        });\r\n\r\n        describe('initWeek', () => {\r\n            it('should create new week if not exists', async () => {\r\n                (getDoc as any).mockResolvedValue({ exists: () => false });\r\n\r\n                const fid = toFranchiseId('f1');\r\n                const wid = toWeekId('2025_42');\r\n                const start = '2025-10-13';\r\n\r\n                const result = await WeekService.initWeek(fid, wid, start);\r\n\r\n                expect(setDoc).toHaveBeenCalledWith(\r\n                    expect.anything(),\r\n                    expect.objectContaining({\r\n                        id: wid,\r\n                        startDate: start,\r\n                        status: 'draft'\r\n                    })\r\n                );\r\n                expect(result?.id).toBe(wid);\r\n            });\r\n\r\n            it('should validation fail if trying to init with bad date', async () => {\r\n                (getDoc as any).mockResolvedValue({ exists: () => false });\r\n\r\n                // Zod schema expects YYYY-MM-DD\r\n                const badDate = 'bad-date';\r\n\r\n                await expect(WeekService.initWeek(toFranchiseId('f1'), toWeekId('2025_42'), badDate))\r\n                    .rejects\r\n                    .toThrow(); // ZodError inside initWeek before save\r\n            });\r\n        });\r\n    });\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\services\\scheduler\\weekService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\services\\shiftService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\services\\userService.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":36,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":36,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[821,824],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[821,824],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":37,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":37,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[849,852],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[849,852],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { db } from '../lib/firebase';\r\nimport {\r\n    collection,\r\n    addDoc,\r\n    doc,\r\n    serverTimestamp,\r\n    getDoc,\r\n    setDoc,\r\n    getDocs,\r\n    query,\r\n    where,\r\n    FieldValue\r\n} from 'firebase/firestore';\r\n\r\n// =====================================================\r\n// TYPES & INTERFACES\r\n// =====================================================\r\n\r\nexport interface UserProfile {\r\n    uid: string;\r\n    id?: string;\r\n    email?: string;\r\n    displayName?: string;\r\n    phoneNumber?: string;\r\n    phone?: string;\r\n    role?: string;\r\n    franchiseId?: string;\r\n    pack?: 'basic' | 'premium';\r\n    status?: 'active' | 'pending' | 'banned' | 'deleted';\r\n    name?: string;\r\n    legalName?: string;\r\n    cif?: string;\r\n    city?: string;\r\n    address?: string;\r\n    zipCodes?: string[];\r\n    logisticsRates?: any[];\r\n    notifications?: any;\r\n    photoURL?: string;\r\n    createdAt?: Date | FieldValue | string | { seconds: number, nanoseconds: number };\r\n    updatedAt?: Date | FieldValue | string | { seconds: number, nanoseconds: number };\r\n    updated_at?: Date | FieldValue; // Legacy support\r\n    [key: string]: unknown; // Allow additional properties\r\n}\r\n\r\nexport interface FranchiseLocation {\r\n    zipCodes: string[];\r\n}\r\n\r\nexport interface FranchiseSettings {\r\n    isActive: boolean;\r\n}\r\n\r\nexport interface FranchiseData {\r\n    name: string;\r\n    location: FranchiseLocation;\r\n    settings: FranchiseSettings;\r\n}\r\n\r\nexport interface FranchiseEntity {\r\n    id: string;\r\n    uid: string;\r\n    name?: string;\r\n    email?: string;\r\n    role?: string;\r\n    active?: boolean;\r\n    status?: string;\r\n    location?: FranchiseLocation | string;\r\n    settings?: FranchiseSettings;\r\n    displayName?: string;\r\n    metrics?: {\r\n        revenue?: number;\r\n        orders?: number;\r\n        profit?: number;\r\n        margin?: number;\r\n    };\r\n    createdAt?: Date | FieldValue;\r\n    updatedAt?: Date | FieldValue;\r\n    [key: string]: unknown;\r\n}\r\n\r\nexport interface CreateFranchiseResult {\r\n    success: boolean;\r\n    data: {\r\n        id: string;\r\n        [key: string]: unknown;\r\n    };\r\n}\r\n\r\n// =====================================================\r\n// SERVICE\r\n// =====================================================\r\n\r\nconst COLLECTIONS = {\r\n    USERS: 'users',\r\n    FRANCHISES: 'franchises'\r\n};\r\n\r\nexport const userService = {\r\n    // --- IDENTITY (Users) ---\r\n\r\n    /**\r\n     * Get user profile by UID\r\n     */\r\n    getUserProfile: async (uid: string): Promise<UserProfile | null> => {\r\n        try {\r\n            if (!uid) return null;\r\n            const docRef = doc(db, COLLECTIONS.USERS, uid);\r\n            const snap = await getDoc(docRef);\r\n            if (snap.exists()) {\r\n                return { uid: snap.id, ...snap.data() } as UserProfile;\r\n            }\r\n            return null;\r\n        } catch (error) {\r\n            console.error(\"Error fetching user profile:\", error);\r\n            throw error;\r\n        }\r\n    },\r\n\r\n    /**\r\n     * Get user profile by custom Franchise ID\r\n     */\r\n    getUserByFranchiseId: async (franchiseId: string): Promise<UserProfile | null> => {\r\n        try {\r\n            if (!franchiseId) return null;\r\n            const q = query(collection(db, COLLECTIONS.USERS), where('franchiseId', '==', franchiseId));\r\n            const snap = await getDocs(q);\r\n            if (!snap.empty) {\r\n                const doc = snap.docs[0];\r\n                return { uid: doc.id, ...doc.data() } as UserProfile;\r\n            }\r\n            return null;\r\n        } catch (error) {\r\n            console.error(\"Error fetching user by franchiseId:\", error);\r\n            throw error;\r\n        }\r\n    },\r\n\r\n    /**\r\n     * Create or Update User Profile\r\n     */\r\n    updateUser: async (uid: string, data: Partial<UserProfile>): Promise<void> => {\r\n        try {\r\n            const docRef = doc(db, COLLECTIONS.USERS, uid);\r\n            // Use setDoc with merge to ensure document exists\r\n            await setDoc(docRef, {\r\n                ...data,\r\n                updated_at: serverTimestamp()\r\n            }, { merge: true });\r\n        } catch (error) {\r\n            console.error(\"Error updating user:\", error);\r\n            throw error;\r\n        }\r\n    },\r\n\r\n    /**\r\n     * Set user profile data (Create/Overwrite)\r\n     */\r\n    setUserProfile: async (uid: string, data: Partial<UserProfile>): Promise<void> => {\r\n        try {\r\n            await setDoc(doc(db, COLLECTIONS.USERS, uid), {\r\n                ...data,\r\n                updated_at: serverTimestamp()\r\n            }, { merge: true });\r\n        } catch (error) {\r\n            console.error(\"Error setting user profile:\", error);\r\n            throw error;\r\n        }\r\n    },\r\n\r\n    /**\r\n     * Get all users, optionally filtered by role\r\n     */\r\n    fetchUsers: async (roleFilter: string | null = null): Promise<UserProfile[]> => {\r\n        try {\r\n            const usersRef = collection(db, COLLECTIONS.USERS);\r\n            let q = query(usersRef);\r\n\r\n            if (roleFilter) {\r\n                q = query(usersRef, where('role', '==', roleFilter));\r\n            }\r\n\r\n            const snapshot = await getDocs(q);\r\n            return snapshot.docs.map(doc => ({\r\n                id: doc.id,\r\n                uid: doc.id,\r\n                ...doc.data()\r\n            } as UserProfile));\r\n        } catch (error) {\r\n            console.error(\"Error fetching users:\", error);\r\n            return []; // Return empty array on error to prevent crash\r\n        }\r\n    },\r\n\r\n    // --- BUSINESS ENTITIES (Franchises) ---\r\n\r\n    /**\r\n     * Create a new Franchise Entity + Admin User link\r\n     */\r\n    createFranchise: async (franchiseData: FranchiseData): Promise<CreateFranchiseResult> => {\r\n        try {\r\n\r\n            // Validacion defensiva pre-flight (Cintur√≥n de seguridad)\r\n            if (!franchiseData.name || franchiseData.location.zipCodes.length === 0) {\r\n                throw new Error(\"Datos incompletos: Nombre y al menos un CP son obligatorios.\");\r\n            }\r\n\r\n            // Real Firestore Write\r\n            const docRef = await addDoc(collection(db, COLLECTIONS.FRANCHISES), {\r\n                ...franchiseData,\r\n                role: 'franchise', // Mandatory for fetchUsers('franchise') to find it\r\n                createdAt: serverTimestamp(),\r\n                updatedAt: serverTimestamp(),\r\n                // Ensure default values are consistent with fetchUsers expectations\r\n                active: franchiseData.settings.isActive\r\n            });\r\n\r\n            return {\r\n                success: true,\r\n                data: {\r\n                    id: docRef.id,\r\n                    ...franchiseData\r\n                }\r\n            };\r\n        } catch (error) {\r\n            console.error(\"Error creating franchise:\", error);\r\n            throw error;\r\n        }\r\n    },\r\n\r\n    /**\r\n     * Delete user profile\r\n     */\r\n    deleteUser: async (uid: string): Promise<void> => {\r\n        try {\r\n            const docRef = doc(db, COLLECTIONS.USERS, uid);\r\n            // Note: This only deletes the Firestore profile\r\n            // Firebase Auth user deletion requires admin SDK or secondary auth instance\r\n            await setDoc(docRef, { status: 'deleted', updated_at: serverTimestamp() }, { merge: true });\r\n        } catch (error) {\r\n            console.error(\"Error deleting user:\", error);\r\n            throw error;\r\n        }\r\n    },\r\n    /**\r\n     * Get all franchises (users with role='franchise')\r\n     */\r\n    fetchFranchises: async (): Promise<FranchiseEntity[]> => {\r\n        try {\r\n            // Fetch users with role 'franchise' from the users collection\r\n            const q = query(collection(db, COLLECTIONS.USERS), where('role', '==', 'franchise'));\r\n            const snapshot = await getDocs(q);\r\n\r\n            return snapshot.docs.map(doc => {\r\n                const data = doc.data();\r\n                return {\r\n                    id: doc.id,\r\n                    uid: doc.id,\r\n                    name: data.displayName || data.email || 'Franquicia',\r\n                    active: data.status === 'active' || data.status !== 'deleted',\r\n                    role: data.role,\r\n                    email: data.email,\r\n                    ...data\r\n                } as FranchiseEntity;\r\n            });\r\n        } catch (error) {\r\n            console.error(\"Error fetching franchises:\", error);\r\n            return [];\r\n        }\r\n    }\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\services\\users\\userService.test.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":94,"column":72,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":94,"endColumn":75,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3564,3567],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3564,3567],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { describe, it, expect, vi, beforeEach } from 'vitest';\r\nimport { UserService } from './userService';\r\nimport { UserSchema, toUserId } from '../../schemas/users';\r\nimport { toFranchiseId } from '../../schemas/scheduler';\r\nimport { getDocs, setDoc } from 'firebase/firestore';\r\n\r\n// --- Mocks ---\r\nvi.mock('firebase/firestore', () => ({\r\n    getFirestore: vi.fn(),\r\n    collection: vi.fn(),\r\n    doc: vi.fn().mockReturnValue({ id: 'test_uid' }),\r\n    setDoc: vi.fn(),\r\n    updateDoc: vi.fn(),\r\n    query: vi.fn(),\r\n    where: vi.fn(),\r\n    onSnapshot: vi.fn(),\r\n    getDocs: vi.fn(),\r\n}));\r\n\r\ndescribe('UserService', () => {\r\n    beforeEach(() => {\r\n        vi.clearAllMocks();\r\n    });\r\n\r\n    describe('Schema Validation', () => {\r\n        it('should validate a correct user object', () => {\r\n            const validUser = {\r\n                uid: 'user123',\r\n                email: 'test@example.com',\r\n                displayName: 'Test User',\r\n                role: 'driver',\r\n                status: 'active',\r\n                franchiseId: 'franchise1'\r\n            };\r\n            const result = UserSchema.safeParse(validUser);\r\n            expect(result.success).toBe(true);\r\n            if (result.success) {\r\n                expect(result.data.role).toBe('driver');\r\n                expect(result.data.franchiseId).toBe('franchise1');\r\n            }\r\n        });\r\n\r\n        it('should fail if required fields are missing', () => {\r\n            const invalidUser = {\r\n                uid: 'user123',\r\n                // missing email and name\r\n                role: 'driver'\r\n            };\r\n            const result = UserSchema.safeParse(invalidUser);\r\n            expect(result.success).toBe(false);\r\n        });\r\n\r\n        it('should enforce enum values for role and status', () => {\r\n            const invalidRole = {\r\n                uid: 'user123',\r\n                email: 'test@example.com',\r\n                displayName: 'Test User',\r\n                role: 'super_admin', // Invalid\r\n                status: 'sleeping' // Invalid\r\n            };\r\n            const result = UserSchema.safeParse(invalidRole);\r\n            expect(result.success).toBe(false);\r\n        });\r\n    });\r\n\r\n    describe('Service Methods', () => {\r\n        it('createUser should validate and write to Firestore', async () => {\r\n            const input = {\r\n                email: 'new@example.com',\r\n                displayName: 'New User',\r\n                role: 'staff' as const,\r\n                status: 'active' as const,\r\n                franchiseId: toFranchiseId('f1')\r\n            };\r\n            const uid = toUserId('user_new');\r\n\r\n            await UserService.createUser(uid, input);\r\n\r\n            expect(setDoc).toHaveBeenCalled();\r\n            // Verify the payload passed to setDoc contained the correct data\r\n            const callArgs = vi.mocked(setDoc).mock.calls[0];\r\n            expect(callArgs[1]).toMatchObject({\r\n                uid: 'user_new',\r\n                email: 'new@example.com',\r\n                status: 'active'\r\n            });\r\n        });\r\n\r\n        it('getAvailableRiders should query correctly', async () => {\r\n            const mockDocs = [\r\n                { id: 'u1', data: () => ({ email: 'r1@test.com', displayName: 'Rider 1', role: 'driver', status: 'active', franchiseId: 'f1' }) },\r\n                { id: 'u2', data: () => ({ email: 'r2@test.com', displayName: 'Rider 2', role: 'driver', status: 'active', franchiseId: 'f1' }) }\r\n            ];\r\n            vi.mocked(getDocs).mockResolvedValue({ docs: mockDocs } as any);\r\n\r\n            const riders = await UserService.getAvailableRiders(toFranchiseId('f1'));\r\n\r\n            expect(riders).toHaveLength(2);\r\n            expect(riders[0].role).toBe('driver');\r\n            expect(riders[0].uid).toBe('u1');\r\n        });\r\n    });\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\services\\users\\userService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\store\\useAppStore.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\store\\useFleetStore.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\store\\useFleetStore.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\store\\useRiderStore.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\store\\useSchedulerStore.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\store\\useVehicleStore.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":27,"column":61,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":27,"endColumn":64,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1021,1024],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1021,1024],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":33,"column":122,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":33,"endColumn":125,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1482,1485],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1482,1485],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":55,"column":122,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":55,"endColumn":125,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2606,2609],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2606,2609],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":74,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":74,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3283,3286],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3283,3286],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { create } from 'zustand';\r\nimport { Vehicle } from '../features/fleet/vehicles/schemas/VehicleSchema';\r\nimport { vehicleService } from '../services/fleetService';\r\n\r\ninterface VehicleState {\r\n    vehicles: Vehicle[];\r\n    isLoading: boolean;\r\n    error: string | null;\r\n\r\n    // Actions\r\n    fetchVehicles: (franchiseId: string) => Promise<void>;\r\n    addVehicle: (franchiseId: string, vehicle: Partial<Vehicle>) => Promise<void>;\r\n    updateVehicle: (id: string, updates: Partial<Vehicle>) => Promise<void>;\r\n    deleteVehicle: (id: string) => Promise<void>;\r\n}\r\n\r\nexport const useVehicleStore = create<VehicleState>((set) => ({\r\n    vehicles: [],\r\n    isLoading: false,\r\n    error: null,\r\n\r\n    fetchVehicles: async (franchiseId: string) => {\r\n        set({ isLoading: true, error: null });\r\n        try {\r\n            const rawVehicles = await vehicleService.getVehicles(franchiseId);\r\n            // ADAPTER: Moto (Camel) -> Vehicle (Snake/Legacy)\r\n            const vehicles: Vehicle[] = rawVehicles.map((m: any) => ({\r\n                id: m.id,\r\n                matricula: m.plate || m.matricula,\r\n                modelo: m.brand && m.model ? `${m.brand} ${m.model}` : (m.model || m.modelo),\r\n                km_actuales: m.currentKm ?? m.km_actuales ?? 0,\r\n                proxima_revision_km: m.nextRevisionKm ?? m.proxima_revision_km ?? 5000,\r\n                estado: (m.status === 'active' ? 'active' : (m.status === 'maintenance' ? 'maintenance' : 'deleted')) as any,\r\n                type: 'vehicle',\r\n                franchise_id: franchiseId\r\n            }));\r\n            set({ vehicles, isLoading: false });\r\n        } catch (error) {\r\n            console.error('Failed to fetch vehicles:', error);\r\n            set({ isLoading: false, error: 'Error al cargar veh√≠culos' });\r\n        }\r\n    },\r\n\r\n    addVehicle: async (franchiseId: string, vehicleData: Partial<Vehicle>) => {\r\n        set({ isLoading: true, error: null });\r\n        try {\r\n            const m = await vehicleService.createVehicle(franchiseId, vehicleData);\r\n            // ADAPTER: Moto (Camel) -> Vehicle (Snake/Legacy)\r\n            const newVehicle: Vehicle = {\r\n                id: m.id,\r\n                matricula: m.plate || m.matricula,\r\n                modelo: m.brand && m.model ? `${m.brand} ${m.model}` : (m.model || m.modelo),\r\n                km_actuales: m.currentKm ?? m.km_actuales ?? 0,\r\n                proxima_revision_km: m.nextRevisionKm ?? m.proxima_revision_km ?? 5000,\r\n                estado: (m.status === 'active' ? 'active' : (m.status === 'maintenance' ? 'maintenance' : 'deleted')) as any,\r\n                type: 'vehicle',\r\n                franchise_id: franchiseId\r\n            };\r\n            set(state => ({\r\n                vehicles: [newVehicle, ...state.vehicles],\r\n                isLoading: false\r\n            }));\r\n        } catch (error) {\r\n            console.error('Failed to add vehicle:', error);\r\n            set({ isLoading: false, error: 'Error al crear veh√≠culo' });\r\n            throw error;\r\n        }\r\n    },\r\n\r\n    updateVehicle: async (id: string, updates: Partial<Vehicle>) => {\r\n        set({ isLoading: true, error: null });\r\n        try {\r\n            // ADAPTER: Vehicle (Legacy) -> Moto (Service)\r\n            const serviceUpdates: any = {};\r\n            if (updates.matricula) serviceUpdates.plate = updates.matricula;\r\n            if (updates.modelo) serviceUpdates.model = updates.modelo;\r\n            if (updates.km_actuales !== undefined) serviceUpdates.currentKm = updates.km_actuales;\r\n            if (updates.proxima_revision_km !== undefined) serviceUpdates.nextRevisionKm = updates.proxima_revision_km;\r\n            if (updates.estado) {\r\n                serviceUpdates.status = updates.estado === 'active' ? 'active' :\r\n                    (updates.estado === 'maintenance' ? 'maintenance' : 'deleted');\r\n            }\r\n\r\n            await vehicleService.updateVehicle(id, serviceUpdates);\r\n\r\n            set(state => ({\r\n                vehicles: state.vehicles.map(v => v.id === id ? { ...v, ...updates } : v),\r\n                isLoading: false\r\n            }));\r\n        } catch (error) {\r\n            console.error('Failed to update vehicle:', error);\r\n            set({ isLoading: false, error: 'Error al actualizar veh√≠culo' });\r\n            throw error;\r\n        }\r\n    },\r\n\r\n    deleteVehicle: async (id: string) => {\r\n        set({ isLoading: true, error: null });\r\n        try {\r\n            await vehicleService.deleteVehicle(id);\r\n            set(state => ({\r\n                vehicles: state.vehicles.filter(v => v.id !== id),\r\n                isLoading: false\r\n            }));\r\n        } catch (error) {\r\n            console.error('Failed to delete vehicle:', error);\r\n            set({ isLoading: false, error: 'Error al eliminar veh√≠culo' });\r\n            throw error;\r\n        }\r\n    }\r\n}));\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\types\\finance.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":19,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":19,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[424,427],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[424,427],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Finance Domain Types\r\n */\r\n\r\nimport type { FieldValue } from 'firebase/firestore';\r\n\r\nexport interface MonthlyData {\r\n    id?: string;\r\n    franchiseId: string;\r\n    month: string;  // YYYY-MM format\r\n    totalIncome?: number;\r\n    totalExpenses?: number;\r\n    netProfit?: number;\r\n    recordCount?: number;\r\n    revenue?: number;\r\n    expenses?: number;\r\n    profit?: number;\r\n    margin?: number;\r\n    breakdown?: any[];\r\n    status?: string;\r\n    updatedAt?: FieldValue | Date;\r\n    [key: string]: unknown; // Allow additional properties for flexibility\r\n}\r\n\r\n/**\r\n * Discriminated union of all possible finance errors\r\n * Each error type carries specific context for debugging and UX\r\n */\r\nexport type FinanceError =\r\n    | { type: 'PERMISSION_DENIED'; franchiseId: string }\r\n    | { type: 'VALIDATION_ERROR'; field: string; message: string }\r\n    | { type: 'NOT_FOUND'; franchiseId: string; month?: string }\r\n    | { type: 'NETWORK_ERROR'; cause: Error }\r\n    | { type: 'INVALID_FORMAT'; field: string; expected: string; received: string };\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\types\\franchise.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":12,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":12,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[221,224],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[221,224],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Franchise Domain Types\r\n */\r\n\r\nexport interface FranchiseMetadata {\r\n    id: string;\r\n    name: string;\r\n    code?: string;\r\n    manager?: string;\r\n    location?: string;\r\n    status?: string;\r\n    [key: string]: any;\r\n}\r\n\r\n/**\r\n * Discriminated union of all possible franchise errors\r\n * Each error type carries specific context for debugging and UX\r\n */\r\nexport type FranchiseError =\r\n    | { type: 'NOT_FOUND'; franchiseId: string }\r\n    | { type: 'PERMISSION_DENIED'; franchiseId: string }\r\n    | { type: 'NETWORK_ERROR'; cause: Error };\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\types\\json.d.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":2,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[44,47],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[44,47],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"declare module \"*.json\" {\r\n    const value: any;\r\n    export default value;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\types\\result.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\types\\support.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":14,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":14,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[592,595],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[592,595],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":15,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":15,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[628,631],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[628,631],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":18,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":18,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[704,707],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[704,707],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Timestamp } from 'firebase/firestore';\r\n\r\nexport interface Ticket {\r\n    id: string;\r\n    uid?: string;\r\n    email?: string;\r\n    subject: string;\r\n    description?: string;\r\n    message?: string; // Some uses have message, others description. Let's keep both optional or unify.\r\n    status: 'open' | 'investigating' | 'resolved' | 'closed' | 'pending_user' | string;\r\n    priority?: 'low' | 'medium' | 'high' | 'critical';\r\n    urgency?: 'low' | 'medium' | 'high' | 'critical'; // Seems urgency/priority are used interchangeably\r\n    category?: string;\r\n    createdAt?: Timestamp | any;\r\n    lastUpdated?: Timestamp | any;\r\n    read?: boolean;\r\n    hasAttachment?: boolean;\r\n    [key: string]: any;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\buttons\\ThemeToggle.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\data-display\\BentoCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\data-display\\CustomChartTooltip.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\data-display\\SparkLine.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\data-display\\Table.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\data-display\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\feedback\\ConfirmationModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\feedback\\EmptyState.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\feedback\\ErrorBoundary.d.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":3,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":3,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[75,78],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[75,78],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\n\r\ndeclare const Component: React.ComponentType<any>;\r\nexport default Component;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\feedback\\ErrorBoundary.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\feedback\\InfoTooltip.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\feedback\\InstallPrompt.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":6,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":6,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[250,253],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[250,253],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":10,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":10,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[372,375],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[372,375],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState } from 'react';\r\nimport { Download } from 'lucide-react';\r\nimport { Button } from '../primitives/Button';\r\n\r\nexport const InstallPrompt: React.FC = () => {\r\n    const [deferredPrompt, setDeferredPrompt] = useState<any>(null);\r\n    const [isVisible, setIsVisible] = useState(false);\r\n\r\n    useEffect(() => {\r\n        const handler = (e: any) => {\r\n            // Prevent the mini-infobar from appearing on mobile\r\n            e.preventDefault();\r\n            // Stash the event so it can be triggered later.\r\n            setDeferredPrompt(e);\r\n            // Update UI notify the user they can install the PWA\r\n            setIsVisible(true);\r\n        };\r\n\r\n        window.addEventListener('beforeinstallprompt', handler);\r\n\r\n        return () => {\r\n            window.removeEventListener('beforeinstallprompt', handler);\r\n        };\r\n    }, []);\r\n\r\n    const handleInstallClick = async () => {\r\n        if (!deferredPrompt) return;\r\n\r\n        // Show the install prompt\r\n        deferredPrompt.prompt();\r\n\r\n        // Wait for the user to respond to the prompt\r\n        const { outcome } = await deferredPrompt.userChoice;\r\n        console.log(`User response to the install prompt: ${outcome}`);\r\n\r\n        // We've used the prompt, and can't use it again, throw it away\r\n        setDeferredPrompt(null);\r\n        setIsVisible(false);\r\n    };\r\n\r\n    if (!isVisible) return null;\r\n\r\n    return (\r\n        <div className=\"fixed bottom-4 left-4 right-4 md:left-auto md:right-8 z-50 animate-in slide-in-from-bottom-5 fade-in duration-500\">\r\n            <div className=\"bg-slate-900 dark:bg-slate-800 text-white p-4 rounded-xl shadow-xl flex items-center justify-between gap-4 border border-slate-700/50\">\r\n                <div className=\"flex-1\">\r\n                    <h4 className=\"font-semibold text-sm\">Instalar App</h4>\r\n                    <p className=\"text-xs text-slate-400\">Acceso r√°pido y sin conexi√≥n</p>\r\n                </div>\r\n                <Button\r\n                    size=\"sm\"\r\n                    onClick={handleInstallClick}\r\n                    className=\"bg-blue-600 hover:bg-blue-500 text-white border-none\"\r\n                    icon={<Download className=\"w-4 h-4\" />}\r\n                >\r\n                    Instalar\r\n                </Button>\r\n                <button\r\n                    onClick={() => setIsVisible(false)}\r\n                    className=\"p-1 hover:bg-slate-800 rounded-full text-slate-400\"\r\n                >\r\n                    ‚úï\r\n                </button>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\feedback\\Toast.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\feedback\\ToastContainer.d.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":3,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":3,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[75,78],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[75,78],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\n\r\ndeclare const Component: React.ComponentType<any>;\r\nexport default Component;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\feedback\\ToastContainer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\inputs\\Button.d.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":3,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":3,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[75,78],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[75,78],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\n\r\ndeclare const Component: React.ComponentType<any>;\r\nexport default Component;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\inputs\\Button.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\inputs\\FileUploader.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\inputs\\GlassDropdown.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\inputs\\InputCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\inputs\\InputForm.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\inputs\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\inputs\\smart-input\\SmartFinanceInput.test.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\inputs\\smart-input\\SmartFinanceInput.tsx","messages":[{"ruleId":"prefer-const","severity":2,"message":"'rawValue' is never reassigned. Use 'const' instead.","line":28,"column":13,"nodeType":"Identifier","messageId":"useConst","endLine":28,"endColumn":21,"fix":{"range":[763,793],"text":"const rawValue = e.target.value;"}}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":1,"fixableWarningCount":0,"source":"import { type FC, type FocusEvent } from 'react';\r\nimport { useFormContext, type RegisterOptions } from 'react-hook-form';\r\nimport { evaluateFormula } from '../../../utils/finance';\r\n\r\ninterface SmartFinanceInputProps {\r\n    name: string;\r\n    label?: string;\r\n    placeholder?: string;\r\n    disabled?: boolean;\r\n    rules?: RegisterOptions;\r\n}\r\n\r\nconst SmartFinanceInput: FC<SmartFinanceInputProps> = ({\r\n    name,\r\n    label,\r\n    placeholder,\r\n    disabled = false,\r\n    rules\r\n}) => {\r\n    // 1. Hook Form Context\r\n    const { register, formState: { errors }, setValue } = useFormContext();\r\n\r\n    // 2. Safe Error Extraction\r\n    const error = errors[name];\r\n\r\n    // 3. Smart Handlers\r\n    const handleBlur = (e: FocusEvent<HTMLInputElement>) => {\r\n        let rawValue = e.target.value;\r\n        if (!rawValue) return;\r\n\r\n        // Formula Evaluation (starts with '=')\r\n        if (rawValue.startsWith('=')) {\r\n            try {\r\n                const result = evaluateFormula(rawValue);\r\n                // Sync with RHF immediate value update\r\n                setValue(name, result, { shouldValidate: true, shouldDirty: true });\r\n                // Also update the DOM input directly ensuring visual sync if RHF lags\r\n                e.target.value = String(result);\r\n            } catch {\r\n                // console.warn(\"Formula error handled internally\");\r\n                // We leave the bad formula in place so user can fix it\r\n            }\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"flex flex-col gap-1 w-full\">\r\n            {/* Label: Strict String */}\r\n            {label && (\r\n                <label htmlFor={name} className=\"text-sm font-medium text-gray-700\">\r\n                    {label}\r\n                </label>\r\n            )}\r\n\r\n            <input\r\n                id={name}\r\n                type=\"text\" // CHANGED to TEXT to allow \"=\" formulas\r\n                inputMode=\"decimal\" // Mobile numeric keyboard hints\r\n                disabled={disabled}\r\n                placeholder={placeholder}\r\n                className={`\r\n          border p-2 rounded-md transition-colors focus:outline-none focus:ring-2\r\n          ${error ? 'border-red-500 focus:ring-red-200' : 'border-gray-300 focus:ring-blue-200'}\r\n          ${disabled ? 'bg-gray-100 cursor-not-allowed' : 'bg-white text-slate-900'}\r\n        `}\r\n                {...register(name, {\r\n                    // Custom Parser: Handle Formula on Submit or internal flows\r\n                    setValueAs: (v: string | number) => {\r\n                        if (typeof v === 'string' && v.startsWith('=')) {\r\n                            try {\r\n                                return evaluateFormula(v);\r\n                            } catch {\r\n                                return 0; // Fallback or NaN? Safe fallback to 0.\r\n                            }\r\n                        }\r\n                        return v === \"\" ? null : typeof v === 'string' ? parseFloat(v) : v;\r\n                    },\r\n                    ...rules\r\n                })}\r\n                // Handler Interception\r\n                onBlur={(e) => {\r\n                    handleBlur(e);\r\n                    register(name).onBlur(e);\r\n                }}\r\n            />\r\n\r\n            {/* Safe Error Rendering */}\r\n            {error && (\r\n                <span className=\"text-xs text-red-500 animate-pulse\">\r\n                    {error.message?.toString() || \"Error inv√°lido\"}\r\n                </span>\r\n            )}\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default SmartFinanceInput;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\layout\\DashboardSkeleton.d.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":3,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":3,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[75,78],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[75,78],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\n\r\ndeclare const Component: React.ComponentType<any>;\r\nexport default Component;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\layout\\DashboardSkeleton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\layout\\Skeleton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\layout\\TableSkeleton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\layout\\tabs.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\modals\\PageHelpModal.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":54,"column":29,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[3567,3598],"text":"\r\n                            &quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[3567,3598],"text":"\r\n                            &ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[3567,3598],"text":"\r\n                            &#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[3567,3598],"text":"\r\n                            &rdquo;"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":54,"column":45,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[3613,3640],"text":"&quot;\r\n                        "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[3613,3640],"text":"&ldquo;\r\n                        "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[3613,3640],"text":"&#34;\r\n                        "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[3613,3640],"text":"&rdquo;\r\n                        "},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\nimport { X, ChevronRight } from 'lucide-react';\r\nimport { PageHelpContent } from '../../constants/pageHelpData';\r\n\r\ninterface PageHelpModalProps {\r\n    isOpen: boolean;\r\n    onClose: () => void;\r\n    content: PageHelpContent | null;\r\n}\r\n\r\nconst PageHelpModal: React.FC<PageHelpModalProps> = ({ isOpen, onClose, content }) => {\r\n    if (!isOpen || !content) return null;\r\n\r\n    const colorMap: Record<string, { bg: string, text: string, border: string }> = {\r\n        indigo: { bg: 'bg-indigo-50 dark:bg-indigo-950/20', text: 'text-indigo-600 dark:text-indigo-400', border: 'border-indigo-200 dark:border-indigo-900' },\r\n        blue: { bg: 'bg-blue-50 dark:bg-blue-950/20', text: 'text-blue-600 dark:text-blue-400', border: 'border-blue-200 dark:border-blue-900' },\r\n        emerald: { bg: 'bg-emerald-50 dark:bg-emerald-950/20', text: 'text-emerald-600 dark:text-emerald-400', border: 'border-emerald-200 dark:border-emerald-900' },\r\n        purple: { bg: 'bg-purple-50 dark:bg-purple-950/20', text: 'text-purple-600 dark:text-purple-400', border: 'border-purple-200 dark:border-purple-900' },\r\n        amber: { bg: 'bg-amber-50 dark:bg-amber-950/20', text: 'text-amber-600 dark:text-amber-400', border: 'border-amber-200 dark:border-amber-900' },\r\n        rose: { bg: 'bg-rose-50 dark:bg-rose-950/20', text: 'text-rose-600 dark:text-rose-400', border: 'border-rose-200 dark:border-rose-900' }\r\n    };\r\n\r\n    const theme = colorMap[content.color] || colorMap.indigo;\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-md p-4 animate-in fade-in duration-300\">\r\n            <div className=\"bg-white dark:bg-slate-900 rounded-3xl shadow-2xl max-w-2xl w-full max-h-[85vh] overflow-hidden border border-slate-200 dark:border-slate-800 flex flex-col animate-in zoom-in-95 duration-300\">\r\n                {/* Header */}\r\n                <div className=\"flex items-center justify-between p-6 border-b border-slate-100 dark:border-slate-800\">\r\n                    <div className=\"flex items-center gap-4\">\r\n                        <div className={`w-12 h-12 rounded-2xl ${theme.bg} ${theme.text} flex items-center justify-center shadow-inner`}>\r\n                            {content.icon}\r\n                        </div>\r\n                        <div>\r\n                            <h2 className=\"text-2xl font-black text-slate-900 dark:text-white leading-none\">{content.title}</h2>\r\n                            <p className=\"text-sm text-slate-500 mt-1.5 font-medium\">Gu√≠a de usuario e Inteligencia de Negocio</p>\r\n                        </div>\r\n                    </div>\r\n                    <button\r\n                        onClick={onClose}\r\n                        title=\"Cerrar Gu√≠a\"\r\n                        aria-label=\"Cerrar Gu√≠a\"\r\n                        className=\"w-10 h-10 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 flex items-center justify-center transition-all active:scale-90\"\r\n                    >\r\n                        <X className=\"w-5 h-5 text-slate-400\" />\r\n                    </button>\r\n                </div>\r\n\r\n                {/* Content */}\r\n                <div className=\"p-6 overflow-y-auto flex-1 space-y-8 scrollbar-thin scrollbar-thumb-slate-200 dark:scrollbar-thumb-slate-800\">\r\n                    {/* Intro */}\r\n                    <div className={`p-4 rounded-2xl border-2 ${theme.border} ${theme.bg}`}>\r\n                        <p className=\"text-sm font-bold text-slate-800 dark:text-slate-200 leading-relaxed italic\">\r\n                            \"{content.intro}\"\r\n                        </p>\r\n                    </div>\r\n\r\n                    {/* Sections */}\r\n                    {content.sections.map((section, sIdx) => (\r\n                        <div key={sIdx} className=\"space-y-4\">\r\n                            <h3 className=\"text-xs font-black text-slate-400 uppercase tracking-[0.2em] pl-1 flex items-center gap-2\">\r\n                                <span className=\"w-8 h-[1px] bg-slate-200 dark:bg-slate-800\"></span>\r\n                                {section.title}\r\n                            </h3>\r\n                            <div className=\"grid gap-3\">\r\n                                {section.items.map((item, iIdx) => (\r\n                                    <div key={iIdx} className=\"group p-4 rounded-2xl bg-slate-50 dark:bg-slate-800/40 border border-slate-100 dark:border-slate-700/50 hover:border-indigo-200 dark:hover:border-indigo-800 transition-all duration-300\">\r\n                                        <div className=\"flex items-start gap-3\">\r\n                                            <div className=\"mt-1\">\r\n                                                <ChevronRight className={`w-4 h-4 ${theme.text} group-hover:translate-x-1 transition-transform`} />\r\n                                            </div>\r\n                                            <div className=\"flex-1\">\r\n                                                <h4 className=\"text-sm font-black text-slate-900 dark:text-white mb-1.5 uppercase tracking-tight\">{item.term}</h4>\r\n                                                <p className=\"text-xs text-slate-600 dark:text-slate-400 leading-relaxed mb-3\">\r\n                                                    {item.definition}\r\n                                                </p>\r\n\r\n                                                {item.example && (\r\n                                                    <div className=\"flex items-center gap-2 text-xs font-mono font-bold text-blue-600 dark:text-blue-400 bg-blue-50/50 dark:bg-blue-900/20 px-2 py-1 rounded-md w-fit mb-2\">\r\n                                                        <span>üìä</span> {item.example}\r\n                                                    </div>\r\n                                                )}\r\n\r\n                                                {item.tip && (\r\n                                                    <div className=\"p-3 rounded-xl bg-green-50/50 dark:bg-green-900/10 border border-green-100/50 dark:border-green-800/30\">\r\n                                                        <p className=\"text-[11px] text-green-700 dark:text-green-300 font-medium leading-relaxed\">\r\n                                                            {item.tip}\r\n                                                        </p>\r\n                                                    </div>\r\n                                                )}\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n                        </div>\r\n                    ))}\r\n                </div>\r\n\r\n                {/* Footer Footer */}\r\n                <div className=\"p-6 border-t border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-900/50\">\r\n                    <button\r\n                        onClick={onClose}\r\n                        className=\"w-full py-4 bg-slate-900 dark:bg-indigo-600 hover:bg-slate-800 dark:hover:bg-indigo-500 text-white font-black rounded-2xl transition-all shadow-lg shadow-indigo-500/10 active:scale-[0.98] uppercase tracking-widest text-xs\"\r\n                    >\r\n                        Entendido, ¬°A por ello!\r\n                    </button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default PageHelpModal;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\navigation\\CommandPalette.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\overlays\\CriticalActionModal.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\overlays\\CriticalActionModal.tsx:32:13\n  30 |     useEffect(() => {\n  31 |         if (isOpen) {\n> 32 |             setInput('');\n     |             ^^^^^^^^ Avoid calling setState() directly within an effect\n  33 |             setError(false);\n  34 |         }\n  35 |     }, [isOpen]);","line":32,"column":13,"nodeType":null,"endLine":32,"endColumn":21}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react';\r\nimport { AlertTriangle, X, Loader2 } from 'lucide-react';\r\n\r\nexport interface CriticalActionModalProps {\r\n    isOpen: boolean;\r\n    onClose: () => void;\r\n    onConfirm: () => void;\r\n    title: string;\r\n    description: string;\r\n    confirmKeyword: string;\r\n    isLoading?: boolean;\r\n    confirmButtonText?: string;\r\n    variant?: 'danger' | 'warning';\r\n}\r\n\r\nconst CriticalActionModal: React.FC<CriticalActionModalProps> = ({\r\n    isOpen,\r\n    onClose,\r\n    onConfirm,\r\n    title,\r\n    description,\r\n    confirmKeyword,\r\n    isLoading = false,\r\n    confirmButtonText = 'Confirmar',\r\n    variant = 'danger' // 'danger' | 'warning'\r\n}) => {\r\n    const [input, setInput] = useState('');\r\n    const [error, setError] = useState(false);\r\n\r\n    useEffect(() => {\r\n        if (isOpen) {\r\n            setInput('');\r\n            setError(false);\r\n        }\r\n    }, [isOpen]);\r\n\r\n    if (!isOpen) return null;\r\n\r\n    const handleConfirm = () => {\r\n        if (input !== confirmKeyword) {\r\n            setError(true);\r\n            return;\r\n        }\r\n        onConfirm();\r\n    };\r\n\r\n    const isMatch = input === confirmKeyword;\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm animate-in fade-in duration-200\">\r\n            <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden border border-slate-200 scale-100 animate-in zoom-in-95 duration-200\">\r\n\r\n                {/* Header */}\r\n                <div className={`p-6 border-b ${variant === 'danger' ? 'bg-rose-50 border-rose-100' : 'bg-amber-50 border-amber-100'} flex items-start gap-4`}>\r\n                    <div className={`p-3 rounded-full shrink-0 ${variant === 'danger' ? 'bg-rose-100 text-rose-600' : 'bg-amber-100 text-amber-600'}`}>\r\n                        <AlertTriangle className=\"w-6 h-6\" />\r\n                    </div>\r\n                    <div>\r\n                        <h3 className={`text-lg font-black ${variant === 'danger' ? 'text-rose-900' : 'text-amber-900'}`}>\r\n                            {title}\r\n                        </h3>\r\n                        <p className={`text-sm mt-1 font-medium ${variant === 'danger' ? 'text-rose-700' : 'text-amber-700'}`}>\r\n                            {description}\r\n                        </p>\r\n                    </div>\r\n                    <button\r\n                        onClick={onClose}\r\n                        className=\"ml-auto text-slate-400 hover:text-slate-600 transition-colors\"\r\n                        disabled={isLoading}\r\n                    >\r\n                        <X className=\"w-5 h-5\" />\r\n                    </button>\r\n                </div>\r\n\r\n                {/* Body */}\r\n                <div className=\"p-6 space-y-4\">\r\n                    <div className=\"space-y-2\">\r\n                        <label className=\"text-sm font-bold text-slate-700\">\r\n                            Para confirmar, escribe <span className=\"font-mono text-slate-900 bg-slate-100 px-1 rounded select-all\">{confirmKeyword}</span> abajo:\r\n                        </label>\r\n                        <input\r\n                            type=\"text\"\r\n                            value={input}\r\n                            onChange={(e) => {\r\n                                setInput(e.target.value);\r\n                                setError(false);\r\n                            }}\r\n                            placeholder={confirmKeyword}\r\n                            className={`w-full px-4 py-2.5 rounded-xl border-2 font-medium focus:ring-0 outline-none transition-all ${error\r\n                                ? 'border-rose-300 focus:border-rose-500 bg-rose-50 text-rose-900 placeholder-rose-300'\r\n                                : 'border-slate-200 focus:border-blue-500 bg-white text-slate-900'\r\n                                }`}\r\n                            autoFocus\r\n                            disabled={isLoading}\r\n                        />\r\n                        {error && (\r\n                            <p className=\"text-xs font-bold text-rose-500 flex items-center gap-1 animate-pulse\">\r\n                                La confirmaci√≥n no coincide. Int√©ntalo de nuevo.\r\n                            </p>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Footer */}\r\n                <div className=\"p-4 bg-slate-50 border-t border-slate-100 flex justify-end gap-3\">\r\n                    <button\r\n                        onClick={onClose}\r\n                        disabled={isLoading}\r\n                        className=\"px-4 py-2 text-slate-600 font-bold text-sm hover:bg-slate-200 rounded-lg transition-colors border border-transparent\"\r\n                    >\r\n                        Cancelar\r\n                    </button>\r\n                    <button\r\n                        onClick={handleConfirm}\r\n                        disabled={!isMatch || isLoading}\r\n                        className={`px-4 py-2 rounded-lg font-bold text-sm shadow-sm flex items-center gap-2 transition-all ${variant === 'danger'\r\n                            ? 'bg-rose-600 hover:bg-rose-700 text-white disabled:bg-rose-300'\r\n                            : 'bg-amber-500 hover:bg-amber-600 text-white disabled:bg-amber-300'\r\n                            } disabled:cursor-not-allowed`}\r\n                    >\r\n                        {isLoading && <Loader2 className=\"w-4 h-4 animate-spin\" />}\r\n                        {confirmButtonText}\r\n                    </button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default CriticalActionModal;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\overlays\\DocPreviewModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\overlays\\Drawer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\overlays\\Tooltip.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\overlays\\UpdatePrompt.d.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":3,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":3,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[75,78],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[75,78],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\n\r\ndeclare const Component: React.ComponentType<any>;\r\nexport default Component;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\overlays\\UpdatePrompt.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\overlays\\VersionChecker.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\overlays\\VersionChecker.tsx:52:9\n  50 |     useEffect(() => {\n  51 |         // Initial check\n> 52 |         checkVersion();\n     |         ^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  53 |\n  54 |         // Interval check\n  55 |         const interval = setInterval(checkVersion, CHECK_INTERVAL);","line":52,"column":9,"nodeType":null,"endLine":52,"endColumn":21}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport { useEffect, useState } from 'react';\r\nimport { RefreshCw } from 'lucide-react';\r\n// toast import removed as unused\r\n\r\nconst CHECK_INTERVAL = 60 * 1000; // Check every minute\r\nconst VERSION_URL = '/version.json';\r\n\r\n// Get current version from build\r\nimport currentVersionData from '../../public/version.json';\r\n\r\nexport const VersionChecker: React.FC = () => {\r\n    const [hasUpdate, setHasUpdate] = useState(false);\r\n    const [remoteVersion, setRemoteVersion] = useState<string | null>(null);\r\n\r\n    const checkVersion = async () => {\r\n        try {\r\n            // Add timestamp to bypass cache (Aggressive)\r\n            const res = await fetch(`${VERSION_URL}?t=${Date.now()}&r=${Math.random()}`, {\r\n                cache: 'no-store',\r\n                headers: {\r\n                    'Cache-Control': 'no-cache, no-store, must-revalidate',\r\n                    'Pragma': 'no-cache'\r\n                }\r\n            });\r\n            if (!res.ok) return;\r\n\r\n            const data = await res.json();\r\n            const localVersion = currentVersionData.version;\r\n\r\n            console.log(`[VersionChecker] Checking: Local=${localVersion} vs Remote=${data.version}`);\r\n\r\n            if (data.version !== localVersion) {\r\n                console.warn(`[VersionChecker] MISMATCH DETECTED! Initiating emergency update.`);\r\n                setRemoteVersion(data.version);\r\n                setHasUpdate(true);\r\n\r\n                // FORCE RELOAD IMMEDIATELY\r\n                // We use a small delay to allow the React state to render the \"Updating...\" banner if possible\r\n                setTimeout(() => {\r\n                    // Cache busting reload\r\n                    window.location.reload();\r\n                }, 1500);\r\n            }\r\n        } catch (err) {\r\n            console.error(\"[VersionChecker] Failed to check version\", err);\r\n        }\r\n    };\r\n\r\n    useEffect(() => {\r\n        // Initial check\r\n        checkVersion();\r\n\r\n        // Interval check\r\n        const interval = setInterval(checkVersion, CHECK_INTERVAL);\r\n        return () => clearInterval(interval);\r\n    }, []);\r\n\r\n    // handleUpdate removed as unused\r\n\r\n    if (!hasUpdate) return null;\r\n\r\n    // BLOCKING OVERLAY\r\n    return (\r\n        <div className=\"fixed inset-0 z-[9999] bg-black/90 flex flex-col items-center justify-center p-4\">\r\n            <div className=\"bg-slate-900 border border-emerald-500/50 rounded-2xl p-8 max-w-md w-full shadow-2xl shadow-emerald-500/20 text-center space-y-6 animate-in zoom-in duration-300\">\r\n                <div className=\"relative mx-auto w-24 h-24 flex items-center justify-center\">\r\n                    <div className=\"absolute inset-0 bg-emerald-500/20 rounded-full animate-ping\"></div>\r\n                    <div className=\"bg-slate-800 p-4 rounded-full border-2 border-emerald-500 relative z-10\">\r\n                        <RefreshCw className=\"w-10 h-10 text-emerald-400 animate-spin\" />\r\n                    </div>\r\n                </div>\r\n\r\n                <div>\r\n                    <h2 className=\"text-2xl font-bold text-white mb-2\">Actualizando Sistema</h2>\r\n                    <p className=\"text-slate-400\">\r\n                        Detectada versi√≥n <span className=\"font-mono text-emerald-400 font-bold\">{remoteVersion}</span>\r\n                        <br />\r\n                        Aplicando cambios cr√≠ticos...\r\n                    </p>\r\n                </div>\r\n\r\n                <div className=\"w-full bg-slate-800 rounded-full h-2 overflow-hidden\">\r\n                    <div className=\"h-full bg-emerald-500 animate-progress-indeterminate\"></div>\r\n                </div>\r\n\r\n                <p className=\"text-xs text-slate-500 animate-pulse\">\r\n                    No cierres la ventana, se recargar√° autom√°ticamente.\r\n                </p>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\primitives\\Badge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\primitives\\Button.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\primitives\\Card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\primitives\\SectionHeader.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\ui\\primitives\\StatValue.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\utils\\analyticsHelpers.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":39,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":39,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1049,1052],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1049,1052],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":77,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":77,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2608,2611],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2608,2611],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":77,"column":65,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":77,"endColumn":68,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2631,2634],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2631,2634],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Analytics Helpers - Pure Functions for Predictive Intelligence\r\n * Enforces \"Separate Logic from State\" law.\r\n */\r\n\r\n// --- CONSTANTS ---\r\nconst THRESHOLDS = {\r\n    SUPPORT_BOTTLENECK_RATIO: 0.1, // CHAOS MODE: Anything triggers it\r\n    ANOMALY_USER_GROWTH: 0, // CHAOS MODE: Any user is an anomaly\r\n};\r\n\r\nexport interface SupportAnalysis {\r\n    status: 'healthy' | 'bottleneck';\r\n    ratio: number;\r\n    newTickets: number;\r\n    resolvedRecent: number;\r\n    message: string;\r\n}\r\n\r\nexport interface UserAnomalyAnalysis {\r\n    detected: boolean;\r\n    type?: string;\r\n    level?: 'warning' | 'high' | 'med';\r\n    message: string;\r\n}\r\n\r\nexport interface Alert {\r\n    type: string;\r\n    level: 'warning' | 'high' | 'med';\r\n    message: string;\r\n    timestamp: Date;\r\n}\r\n\r\n/**\r\n * Analyzes Support Health based on ticket flow.\r\n * @param {Array} tickets - List of ticket objects\r\n * @returns {Object} { status: 'healthy'|'bottleneck', ratio: number, newTickets: number, resolvedTickets: number }\r\n */\r\nexport const checkSupportHealth = (tickets: any[] = []): SupportAnalysis => {\r\n    const now = new Date();\r\n    const oneDayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);\r\n\r\n    // Filter last 24h activity\r\n    const recentActivity = tickets.filter(t => {\r\n        const date = t.createdAt?.toDate ? t.createdAt.toDate() : new Date(t.createdAt);\r\n        return date > oneDayAgo;\r\n    });\r\n\r\n    // Count opens vs resolves (approximation based on status or separate logs)\r\n    // assuming 'resolved' status check\r\n    const newTickets = recentActivity.length;\r\n    const resolvedRecent = recentActivity.filter(t => t.status === 'resolved').length;\r\n\r\n    // Avoid division by zero\r\n    const comparisonBase = resolvedRecent === 0 ? 1 : resolvedRecent;\r\n    const ratio = newTickets / comparisonBase;\r\n\r\n    const isBottleneck = (ratio > THRESHOLDS.SUPPORT_BOTTLENECK_RATIO) && (newTickets > 5); // Minimum sample size\r\n\r\n    return {\r\n        status: isBottleneck ? 'bottleneck' : 'healthy',\r\n        ratio: parseFloat(ratio.toFixed(2)),\r\n        newTickets,\r\n        resolvedRecent,\r\n        message: isBottleneck\r\n            ? `Alerta de Cuello de Botella: ${newTickets} nuevos vs ${resolvedRecent} resueltos (Ratio ${ratio.toFixed(1)})`\r\n            : 'Flujo de soporte saludable'\r\n    };\r\n};\r\n\r\n/**\r\n * Detects Anomalies in User Growth vs Business Activity.\r\n * @param {Array} users - List of user objects\r\n * @param {Object} salesData - Sales metrics or dashboard data\r\n * @returns {Object} { detected: boolean, type: string, message: string }\r\n */\r\nexport const detectUserAnomaly = (users: any[] = [], salesData: any = {}): UserAnomalyAnalysis => {\r\n    const now = new Date();\r\n    const oneDayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);\r\n\r\n    // New Users last 24h\r\n    const newUsers = users.filter(u => {\r\n        const date = u.createdAt?.toDate ? u.createdAt.toDate() : new Date(u.createdAt);\r\n        return date > oneDayAgo;\r\n    });\r\n\r\n    const growthSpike = newUsers.length > THRESHOLDS.ANOMALY_USER_GROWTH;\r\n\r\n    // Check Sales Correlation (Simplified: If sales are 0 but users are growing fast -> Suspicious/Spam?)\r\n    // This assumes 'salesData' has a 'dailyRevenue' or similar.\r\n    const hasRevenue = (salesData?.currentRevenue || 0) > 0;\r\n\r\n    if (growthSpike && !hasRevenue) {\r\n        return {\r\n            detected: true,\r\n            type: 'high_traffic_low_conversion',\r\n            level: 'warning',\r\n            message: `Pico de usuarios (${newUsers.length}) sin correlaci√≥n de ventas.`\r\n        };\r\n    }\r\n\r\n    return { detected: false, message: 'Crecimiento org√°nico normal' };\r\n};\r\n\r\n/**\r\n * Agregates all analysis into a predictive alert list.\r\n * @param {Object} supportAnalysis \r\n * @param {Object} userAnalysis \r\n * @returns {Array} List of alert objects\r\n */\r\nexport const generatePredictiveAlerts = (supportAnalysis: SupportAnalysis, userAnalysis: UserAnomalyAnalysis): Alert[] => {\r\n    const alerts: Alert[] = [];\r\n\r\n    if (supportAnalysis.status === 'bottleneck') {\r\n        alerts.push({\r\n            type: 'support_bottleneck',\r\n            level: 'high',\r\n            message: supportAnalysis.message,\r\n            timestamp: new Date()\r\n        });\r\n    }\r\n\r\n    if (userAnalysis.detected) {\r\n        alerts.push({\r\n            type: userAnalysis.type || 'anomaly',\r\n            level: userAnalysis.level || 'warning',\r\n            message: userAnalysis.message,\r\n            timestamp: new Date()\r\n        });\r\n    }\r\n\r\n    return alerts;\r\n};\r\n\r\n// --- SCORING ---\r\nexport const calculateHealthScore = (alerts: Alert[] = []): number => {\r\n    let score = 100;\r\n    alerts.forEach(alert => {\r\n        if (alert.level === 'high') score -= 20;\r\n        if (alert.level === 'warning') score -= 10;\r\n        if (alert.level === 'med') score -= 5;\r\n    });\r\n    return Math.max(0, score);\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\utils\\colorPalette.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\utils\\dateHelpers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\utils\\dateUtils.d.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":8,"column":66,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":8,"endColumn":69,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[379,382],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[379,382],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Type declarations for date utilities\r\n\r\nexport function formatWeekRange(date: Date): string;\r\nexport function getWeekStart(date: Date): Date;\r\nexport function getWeekEnd(date: Date): Date;\r\nexport function addDays(date: Date, days: number): Date;\r\nexport function isSameDay(date1: Date, date2: Date): boolean;\r\nexport function toLocalDateString(date: Date | string, options?: any): string;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\utils\\dateUtils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\utils\\eventLayout.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\utils\\finance.d.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":3,"column":64,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":3,"endColumn":67,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[109,112],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[109,112],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":3,"column":72,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":3,"endColumn":75,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[117,120],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[117,120],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":5,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":5,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[236,239],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[236,239],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Type declarations for finance utilities\r\n\r\nexport function calculateLogisticsIntelligence(financeEntries: any[]): any;\r\nexport function formatCurrency(amount: number): string;\r\nexport function calculateMargin(revenue: number, costs: any): number;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\utils\\finance.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":29,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":29,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[642,645],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[642,645],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":null,"message":"Unused eslint-disable directive (no problems were reported from 'no-new-func').","line":81,"column":9,"severity":1,"nodeType":null,"fix":{"range":[2410,2449],"text":" "}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":1,"source":"/**\r\n * Safe Financial Utilities (TypeScript Version)\r\n * Pure functions with zero side effects.\r\n * Designed to withstand invalid inputs without crashing.\r\n */\r\n\r\nexport interface DeltaResult {\r\n    value: number;\r\n    isPositive: boolean;\r\n    changed: boolean;\r\n}\r\n\r\nexport interface ZoneStat {\r\n    name: string;\r\n    count: number;\r\n    revenue: number;\r\n    percentage: number;\r\n}\r\n\r\nexport interface LogisticsSnapshotItem {\r\n    rateId?: string;\r\n    rateName: string;\r\n    count: string | number;\r\n    total: string | number;\r\n}\r\n\r\nexport interface FinanceEntry {\r\n    logisticsSnapshot?: LogisticsSnapshotItem[];\r\n    [key: string]: any;\r\n}\r\n\r\n/**\r\n * Formats a number as EUR currency.\r\n * Returns empty string for invalid inputs (null, undefined, NaN).\r\n */\r\nexport const formatCurrency = (value: string | number | null | undefined): string => {\r\n    if (value === '' || value === null || value === undefined) return '';\r\n\r\n    // Safety check: parse if string (handles commas)\r\n    let num = value;\r\n    if (typeof value === 'string') {\r\n        num = parseFloat(value.replace(',', '.'));\r\n    }\r\n\r\n    if (typeof num === 'number' && isNaN(num)) return '';\r\n\r\n    try {\r\n        return new Intl.NumberFormat('es-ES', {\r\n            style: 'currency',\r\n            currency: 'EUR',\r\n            minimumFractionDigits: 2,\r\n            maximumFractionDigits: 2,\r\n            useGrouping: true, // Explicitly enforce grouping\r\n        }).format(num as number).replace(/\\u00a0/g, ' ');\r\n    } catch {\r\n        return ''; // Fail safe\r\n    }\r\n};\r\n\r\n/**\r\n * Evaluates a simple math expression string safely.\r\n * e.g. \"=50*12\" -> 600\r\n */\r\nexport const evaluateFormula = (expression: string): number => {\r\n    const normalized = expression?.replace(/^=/, '').trim();\r\n    if (!normalized) throw new Error(\"F√≥rmula vac√≠a\");\r\n\r\n    // Strict validation: Only allow numbers, math operators, parens, dots, and commas.\r\n    // This ensures XSS/Injections like <script> or alert() are rejected (thrown)\r\n    if (/[^0-9+\\-*/().,\\s]/.test(normalized)) {\r\n        throw new Error(\"Sintaxis incorrecta\");\r\n    }\r\n\r\n    const clean = normalized.replace(/,/g, '.').replace(/\\s/g, '');\r\n\r\n    // Safety: Prevent infinite loops or heavy calc, though unlikely in regex sanitized string\r\n    // Safety: Check for div by zero\r\n    if (/\\/0(?![.0-9])/.test(clean)) throw new Error(\"Divisi√≥n por cero\");\r\n\r\n    try {\r\n        // eslint-disable-next-line no-new-func\r\n        const result = new Function(`return ${clean}`)();\r\n\r\n        if (!isFinite(result) || isNaN(result as number)) throw new Error(\"Resultado inv√°lido\");\r\n        return result as number;\r\n    } catch {\r\n        throw new Error(\"Sintaxis incorrecta\");\r\n    }\r\n};\r\n\r\n/**\r\n * Calculates the delta between two numbers.\r\n */\r\nexport const calculateDelta = (current: number | null | undefined, previous: number | null | undefined): DeltaResult => {\r\n    // If either is incomplete, no delta\r\n    if (current === null || current === undefined || previous === null || previous === undefined) {\r\n        return { value: 0, isPositive: false, changed: false };\r\n    }\r\n\r\n    const diff = current - previous;\r\n    return {\r\n        value: diff,\r\n        isPositive: diff > 0,\r\n        changed: Math.abs(diff) > 0.001 // Floating point epsilon\r\n    };\r\n};\r\n\r\n/**\r\n * Aggregates logistics snapshot data from multiple finance entries.\r\n * Returns a sortable array of zone performance stats.\r\n */\r\nexport const calculateLogisticsIntelligence = (entries: FinanceEntry[]): ZoneStat[] => {\r\n    if (!Array.isArray(entries)) return [];\r\n\r\n    const zoneStats: Record<string, { name: string; count: number; revenue: number }> = {};\r\n\r\n    entries.forEach(entry => {\r\n        // Handle \"Snapshot\" data if available, otherwise ignore or handle legacy\r\n        const breakdown = entry.logisticsSnapshot || [];\r\n\r\n        breakdown.forEach(item => {\r\n            // Use ID as unique key, fallback to name (though name might change, ID is safe)\r\n            // If we have \"Ghost Zones\" (resurrected), they will have an ID.\r\n            const key = item.rateId || item.rateName;\r\n\r\n            if (!zoneStats[key]) {\r\n                zoneStats[key] = {\r\n                    name: item.rateName, // Keep the most recent name encountered\r\n                    count: 0,\r\n                    revenue: 0\r\n                };\r\n            }\r\n\r\n            zoneStats[key].count += (typeof item.count === 'string' ? parseFloat(item.count) : item.count) || 0;\r\n            zoneStats[key].revenue += (typeof item.total === 'string' ? parseFloat(item.total) : item.total) || 0;\r\n        });\r\n    });\r\n\r\n    // Calculate total for percentage\r\n    const totalRevenue = Object.values(zoneStats).reduce((acc, curr) => acc + curr.revenue, 0);\r\n\r\n    // Convert to array and enrich with percentage\r\n    return Object.values(zoneStats)\r\n        .map(stat => ({\r\n            ...stat,\r\n            percentage: totalRevenue > 0 ? (stat.revenue / totalRevenue) * 100 : 0\r\n        }))\r\n        .sort((a, b) => b.revenue - a.revenue);\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\utils\\firebaseErrors.d.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":6,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":6,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[228,231],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[228,231],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Converts Firebase error codes to user-friendly Spanish messages\r\n * @param error - Firebase error object or any error\r\n * @returns User-friendly error message in Spanish\r\n */\r\nexport function getUserFriendlyError(error: any): string;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\utils\\firebaseErrors.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":4,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":4,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[123,126],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[123,126],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Utility to parse Firebase Errors into user-friendly messages\r\n */\r\nexport const getFriendlyFirebaseError = (error: any): string => {\r\n    if (!error) return 'Error desconocido';\r\n\r\n    const code = error.code || '';\r\n\r\n    switch (code) {\r\n        case 'auth/user-not-found':\r\n            return 'Usuario no encontrado.';\r\n        case 'auth/wrong-password':\r\n            return 'Contrase√±a incorrecta.';\r\n        case 'auth/email-already-in-use':\r\n            return 'Este email ya est√° registrado.';\r\n        case 'auth/weak-password':\r\n            return 'La contrase√±a es muy d√©bil (min. 6 caracteres).';\r\n        case 'auth/invalid-email':\r\n            return 'Formato de email inv√°lido.';\r\n        case 'auth/too-many-requests':\r\n            return 'Demasiados intentos falidos. Int√©ntalo m√°s tarde.';\r\n        case 'permission-denied':\r\n            return 'No tienes permisos para realizar esta acci√≥n.';\r\n        case 'unavailable':\r\n            return 'Servicio temporalmente no disponible.';\r\n        default:\r\n            return error.message || 'Ocurri√≥ un error inesperado.';\r\n    }\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\utils\\formatDate.d.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\utils\\formatDate.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\utils\\formatters.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\utils\\geo.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\utils\\lazyWithRetry.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":8,"column":61,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":8,"endColumn":64,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[321,324],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[321,324],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":25,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":25,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1122,1125],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1122,1125],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { lazy, ComponentType } from 'react';\r\n\r\n/**\r\n * A wrapper for React.lazy that detects failure to load a chunk (often due to new deployments)\r\n * and forces a full page reload to fetch the latest version of the app.\r\n */\r\nexport const lazyWithRetry = (\r\n    componentImport: () => Promise<{ default: ComponentType<any> }>\r\n) =>\r\n    lazy(async () => {\r\n        // Check if we already tried reloading in the last 10 seconds to prevent loops\r\n        const lastRetry = window.sessionStorage.getItem('last-chunk-retry');\r\n        const now = Date.now();\r\n        const isRecentlyRetried = lastRetry && (now - parseInt(lastRetry)) < 10000;\r\n\r\n        try {\r\n            return await componentImport();\r\n        } catch (error) {\r\n            console.error(\"[LAZY RETRY] Failed to load component:\", error);\r\n\r\n            if (!isRecentlyRetried) {\r\n                window.sessionStorage.setItem('last-chunk-retry', now.toString());\r\n                console.warn(\"[LAZY RETRY] Outdated chunk detected. Forcing app reload...\");\r\n                window.location.reload();\r\n                return { default: () => null } as any; // Temporary return while reloading\r\n            }\r\n\r\n            // If it still fails after a reload, throw the error to the ErrorBoundary\r\n            throw error;\r\n        }\r\n    });\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\utils\\operationalMetrics.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":17,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":17,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[452,455],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[452,455],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { parseISO, differenceInMinutes } from 'date-fns';\r\n\r\n// =====================================================\r\n// TYPES & INTERFACES\r\n// =====================================================\r\n\r\nexport interface Shift {\r\n    startAt: string;\r\n    endAt: string;\r\n    riderId?: string | null;\r\n    riderName?: string;\r\n    shiftId?: string;\r\n    id?: string;\r\n    day?: string;\r\n    startTime?: string;\r\n    endTime?: string;\r\n    [key: string]: any;\r\n}\r\n\r\nexport interface WeeklyMetrics {\r\n    totalHours: number;\r\n    activeRiders: number;\r\n    unassigned: number;\r\n    coverage: number;\r\n}\r\n\r\n// =====================================================\r\n// UTILITY FUNCTIONS\r\n// =====================================================\r\n\r\n/**\r\n * Calcula las m√©tricas operativas de la semana bas√°ndose en los turnos raw.\r\n * @param shifts - Array de objetos turno (start, end, riderId, etc.)\r\n * @returns M√©tricas semanales calculadas\r\n */\r\nexport const calculateWeeklyMetrics = (shifts: Shift[] = []): WeeklyMetrics => {\r\n    // 1. Caso base: Sin datos\r\n    if (!shifts || shifts.length === 0) {\r\n        return {\r\n            totalHours: 0,\r\n            activeRiders: 0,\r\n            unassigned: 0,\r\n            coverage: 0\r\n        };\r\n    }\r\n\r\n    // 2. Calcular Horas Reales (Suma de duraciones)\r\n    const totalMinutes = shifts.reduce((acc, shift) => {\r\n        // Aseguramos que trabajamos con objetos Date\r\n        const start = typeof shift.startAt === 'string' ? parseISO(shift.startAt) : shift.startAt;\r\n        const end = typeof shift.endAt === 'string' ? parseISO(shift.endAt) : shift.endAt;\r\n\r\n        // Calculamos diferencia. Si hay error en fechas, sumamos 0.\r\n        const duration = differenceInMinutes(end as Date, start as Date);\r\n        return acc + (isNaN(duration) ? 0 : duration);\r\n    }, 0);\r\n\r\n    // 3. Riders √önicos (Fuerza laboral activa)\r\n    // Filtramos turnos que tengan riderId asignado\r\n    const activeRiders = new Set(\r\n        shifts\r\n            .filter(s => s.riderId)\r\n            .map(s => s.riderId)\r\n    ).size;\r\n\r\n    // 4. Huecos (Turnos sin asignar)\r\n    const unassigned = shifts.filter(s => !s.riderId).length;\r\n\r\n    // 5. Cobertura (Turnos Cubiertos / Total Turnos)\r\n    const totalSlots = shifts.length;\r\n    const assignedSlots = totalSlots - unassigned;\r\n    const coverage = totalSlots > 0\r\n        ? Math.round((assignedSlots / totalSlots) * 100)\r\n        : 0;\r\n\r\n    return {\r\n        totalHours: Math.round(totalMinutes / 60), // Convertimos a horas enteras\r\n        activeRiders,\r\n        unassigned,\r\n        coverage\r\n    };\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\utils\\riderColors.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":31,"column":76,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":31,"endColumn":79,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1820,1823],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1820,1823],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Rider Color Palette - Professional and Distinct Colors\r\nconst RIDER_COLORS = [\r\n    { bg: 'bg-indigo-500', border: 'border-indigo-600', text: 'text-white', light: 'bg-indigo-100', name: 'Indigo' },\r\n    { bg: 'bg-emerald-500', border: 'border-emerald-600', text: 'text-white', light: 'bg-emerald-100', name: 'Emerald' },\r\n    { bg: 'bg-amber-500', border: 'border-amber-600', text: 'text-slate-900', light: 'bg-amber-100', name: 'Amber' },\r\n    { bg: 'bg-rose-500', border: 'border-rose-600', text: 'text-white', light: 'bg-rose-100', name: 'Rose' },\r\n    { bg: 'bg-purple-500', border: 'border-purple-600', text: 'text-white', light: 'bg-purple-100', name: 'Purple' },\r\n    { bg: 'bg-cyan-500', border: 'border-cyan-600', text: 'text-white', light: 'bg-cyan-100', name: 'Cyan' },\r\n    { bg: 'bg-pink-500', border: 'border-pink-600', text: 'text-white', light: 'bg-pink-100', name: 'Pink' },\r\n    { bg: 'bg-teal-500', border: 'border-teal-600', text: 'text-white', light: 'bg-teal-100', name: 'Teal' },\r\n    { bg: 'bg-orange-500', border: 'border-orange-600', text: 'text-white', light: 'bg-orange-100', name: 'Orange' },\r\n    { bg: 'bg-lime-500', border: 'border-lime-600', text: 'text-slate-900', light: 'bg-lime-100', name: 'Lime' },\r\n];\r\n\r\n/**\r\n * Assigns a consistent color to a rider based on their ID\r\n */\r\nexport const getRiderColor = (riderId: string) => {\r\n    // Use a simple hash to consistently map rider ID to color index\r\n    let hash = 0;\r\n    for (let i = 0; i < riderId.length; i++) {\r\n        hash = riderId.charCodeAt(i) + ((hash << 5) - hash);\r\n    }\r\n    const index = Math.abs(hash) % RIDER_COLORS.length;\r\n    return RIDER_COLORS[index];\r\n};\r\n\r\n/**\r\n * Gets all unique riders from shifts and assigns them colors\r\n */\r\nexport const getRiderColorMap = (riders: Array<{ id: string;[key: string]: any }>) => {\r\n    const colorMap = new Map<string, typeof RIDER_COLORS[0]>();\r\n    riders.forEach(rider => {\r\n        colorMap.set(rider.id, getRiderColor(rider.id));\r\n    });\r\n    return colorMap;\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\utils\\schedulerValidation.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":23,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":23,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[530,533],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[530,533],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Valida conflictos de horario usando fechas completas (ISO Strings).\r\n * Funciona perfecto para turnos nocturnos.\r\n */\r\n\r\ninterface MotoAssignment {\r\n    motoId: string;\r\n    // other fields\r\n}\r\n\r\ninterface ValidationShift {\r\n    startAt: string;\r\n    endAt: string;\r\n    shiftId?: string;\r\n    riderId?: string | null;\r\n    riderName?: string | null;\r\n    motoAssignments?: MotoAssignment[];\r\n}\r\n\r\ninterface ConflictResult {\r\n    riderName: string;\r\n    // other relevant info about the conflict shift\r\n    [key: string]: any;\r\n}\r\n\r\nexport const findMotoConflict = (\r\n    newShift: ValidationShift,\r\n    existingShifts: ValidationShift[],\r\n    ignoreShiftId: string | null = null\r\n): ConflictResult | null => {\r\n    // Convertimos a milisegundos (Unix Timestamp) para comparaci√≥n num√©rica pura\r\n    const newStart = new Date(newShift.startAt).getTime();\r\n    const newEnd = new Date(newShift.endAt).getTime();\r\n\r\n    // Validaci√≥n de seguridad b√°sica\r\n    if (newEnd <= newStart) {\r\n        throw new Error(\"La hora de fin debe ser posterior a la de inicio.\");\r\n    }\r\n\r\n    // Buscamos el conflicto\r\n    const conflict = existingShifts.find(shift => {\r\n        // Ignorar el mismo turno si estamos editando\r\n        if (ignoreShiftId && shift.shiftId === ignoreShiftId) return false;\r\n\r\n        // 1. ¬øTiene asignada la misma moto?\r\n        // Analizamos cada asignaci√≥n de moto del NUEVO turno\r\n        // vs cada asignaci√≥n de moto del turno EXISTENTE + Seguridad para arrays nulos\r\n        const newAssignments = newShift.motoAssignments || [];\r\n        const existingAssignments = shift.motoAssignments || [];\r\n\r\n        const hasMotoConflict = newAssignments.some(newAssignment => {\r\n            return existingAssignments.some(existingAssignment => {\r\n                return newAssignment.motoId === existingAssignment.motoId;\r\n            });\r\n        });\r\n\r\n        if (!hasMotoConflict) return false;\r\n\r\n        // 2. Comprobaci√≥n de Solapamiento Temporal (Universal)\r\n        const existingStart = new Date(shift.startAt).getTime();\r\n        const existingEnd = new Date(shift.endAt).getTime();\r\n\r\n        // La l√≥gica de intersecci√≥n:\r\n        // Un evento A interseca con B si: (InicioA < FinB) Y (FinA > InicioB)\r\n        return (newStart < existingEnd && newEnd > existingStart);\r\n    });\r\n\r\n    return (conflict as ConflictResult) || null;\r\n};\r\n\r\n/**\r\n * Valida conflictos de RIDER (Un rider no puede estar en dos sitios a la vez)\r\n */\r\nexport const findRiderConflict = (\r\n    newShift: ValidationShift,\r\n    existingShifts: ValidationShift[],\r\n    ignoreShiftId: string | null = null\r\n): ConflictResult | null => {\r\n    const newStart = new Date(newShift.startAt).getTime();\r\n    const newEnd = new Date(newShift.endAt).getTime();\r\n\r\n    const conflict = existingShifts.find(shift => {\r\n        if (ignoreShiftId && shift.shiftId === ignoreShiftId) return false;\r\n\r\n        // Skip if either shift is unassigned (riderId null/undefined)\r\n        if (!shift.riderId || !newShift.riderId) return false;\r\n\r\n        // Mismo Rider en un turno *diferente*\r\n        if (shift.riderId !== newShift.riderId) return false;\r\n\r\n        const existingStart = new Date(shift.startAt).getTime();\r\n        const existingEnd = new Date(shift.endAt).getTime();\r\n\r\n        return (newStart < existingEnd && newEnd > existingStart);\r\n    });\r\n\r\n    return (conflict as ConflictResult) || null;\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\src\\vite-env.d.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\ver_todo.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\verify-purge.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\verify_dst_logic.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\verify_layout.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\verify_shift_logic.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\vite.config.d.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Usuario\\.gemini\\antigravity\\playground\\synthetic-sagan\\vitest.setup.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]