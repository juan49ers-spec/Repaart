rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- AUTHENTICATION & ROLE HELPERS ---
    function isAuthed() {
      return request.auth != null;
    }
    
    function getUserData() {
      // Returns Resource or null if not found
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }
    
    function isAdmin() {
      // Check token first (short-circuit), then fallback to document check
      return isAuthed() && (
        request.auth.token.role == 'admin' ||
        (getUserData() != null && getUserData().data.get('role', '') == 'admin')
      );
    }
    
    function isFranchise() {
      let userDoc = getUserData();
      return isAuthed() && (
        (userDoc != null && userDoc.data.get('role', '') == 'franchise') || 
        request.auth.token.role == 'franchise'
      );
    }

    function isRider() {
      let userDoc = getUserData();
       return isAuthed() && (
         (userDoc != null && userDoc.data.get('role', '') == 'rider') ||
         request.auth.token.role == 'rider'
       );
    }

    // --- IDENTITY AGNOSTIC OWNERSHIP ---
    function isDataOwner(data) {
      let userDoc = getUserData();
      // Safely access data or default to empty
      let userSlug = userDoc != null ? userDoc.data.get('franchiseId', '') : '';
      let userName = userDoc != null ? userDoc.data.get('name', '') : '';
      let userUid = request.auth.uid;
      
      let docFid = data.get('franchiseId', data.get('franchise_id', ''));
      
      return isAuthed() && (
        docFid == userUid || 
        docFid == userSlug ||
        docFid == userName
      );
    }

    // --- COLLECTION RULES ---

    // USERS: Owner can read/write own profile. Admin can read/write all. Franchise can read/list their riders.
    match /users/{userId} {
      allow read: if isAuthed() && (request.auth.uid == userId || isAdmin() || isFranchise());
      allow list: if isAuthed() && (isAdmin() || (isFranchise() && isDataOwner(resource.data))); 
      allow update: if isAuthed() && (isAdmin() || request.auth.uid == userId || (isFranchise() && isDataOwner(resource.data)));
      allow create: if isAdmin(); 
    }

    // WORK SHIFTS
    match /work_shifts/{shiftId} {
      allow read: if isAuthed() && (
        isAdmin() || 
        (isFranchise() && isDataOwner(resource.data)) || 
        resource.data.get('riderId', '') == request.auth.uid
      );
      // Fixed create/update logic
      allow create: if isAuthed() && (isAdmin() || (isFranchise() && isDataOwner(request.resource.data)));
      allow update: if isAuthed() && (
        isAdmin() || 
        (isFranchise() && isDataOwner(resource.data)) ||
        (resource.data.get('riderId', '') == request.auth.uid && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isConfirmed', 'swapRequested', 'changeRequested', 'changeReason', 'updatedAt']))
      );
      allow delete: if isAuthed() && (isAdmin() || (isFranchise() && isDataOwner(resource.data)));
    }
    
    // FINANCIAL RECORDS & SUMMARIES
    match /financial_records/{recordId} {
      allow read: if isAuthed() && (isAdmin() || (isFranchise() && isDataOwner(resource.data)));
      allow create: if isAuthed() && (isAdmin() || (isFranchise() && isDataOwner(request.resource.data)));
      allow update, delete: if isAuthed() && (isAdmin() || (isFranchise() && isDataOwner(resource.data)));
    }

    match /financial_summaries/{docId} {
       allow read: if isAuthed() && (isAdmin() || (isFranchise() && isDataOwner(resource.data)));
       allow write: if isAuthed() && (isAdmin() || (isFranchise() && isDataOwner(request.resource.data)));
    }

    match /finance_closures/{closureId} {
       allow read: if isAuthed() && (isAdmin() || (isFranchise() && isDataOwner(resource.data)));
       allow write: if isAuthed() && isAdmin();
    }

    // OPERATIONS: FRANCHISES & WEEKS
    match /franchises/{franchiseId} {
      allow read: if isAuthed() && (isAdmin() || request.auth.uid == franchiseId || getUserData().get('franchiseId', '') == franchiseId);
      allow write: if isAuthed() && isAdmin();
      
      match /weeks/{weekId} {
         allow read, write: if isAuthed() && (isAdmin() || request.auth.uid == franchiseId || getUserData().get('franchiseId', '') == franchiseId);
      }
    }

    // FLEET ASSETS
    match /fleet_assets/{assetId} {
      allow read: if isAuthed() && (isAdmin() || isDataOwner(resource.data));
      allow write: if isAuthed() && (isAdmin() || isDataOwner(request.resource.data));
    }
    
    // SUPPORT & INCIDENTS
    match /tickets/{ticketId} {
      allow read: if isAuthed() && (isAdmin() || resource.data.uid == request.auth.uid || isDataOwner(resource.data));
      allow create: if isAuthed();
      allow update: if isAuthed() && (isAdmin() || resource.data.uid == request.auth.uid);
      
      match /messages/{messageId} {
        allow read, write: if isAuthed(); 
      }
    }
    
    match /incidents/{incidentId} {
        allow read: if isAuthed() && (isAdmin() || resource.data.riderId == request.auth.uid || (isFranchise() && isDataOwner(resource.data)));
        allow create: if isAuthed();
        allow update: if isAuthed() && (isAdmin() || resource.data.riderId == request.auth.uid);
    }

    match /vehicle_checks/{checkId} {
         allow read: if isAuthed() && (isAdmin() || resource.data.riderId == request.auth.uid || (isFranchise() && isDataOwner(resource.data)));
         allow create: if isAuthed();
    }

    // ACADEMY & SETTINGS
    match /academy_encyclopedia/{cardId} { allow read: if isAuthed(); allow write: if isAdmin() || isFranchise(); }
    
    // Academy LMS Rules
    match /academy_courses/{courseId} { allow read: if isAuthed(); allow write: if isAdmin(); }
    match /academy_lessons/{lessonId} { allow read: if isAuthed(); allow write: if isAdmin(); }
    match /academy_quizzes/{quizId} { allow read: if isAuthed(); allow write: if isAdmin(); }
    
    match /academy_progress/{progressId} { 
      // Split read/write to avoid accessing request.resource on read (which causes crash)
      allow read: if isAuthed() && (
        resource.data.userId == request.auth.uid || 
        isAdmin()
      );
      
      allow create: if isAuthed() && (
        request.resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      
      allow update, delete: if isAuthed() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
    }

    match /settings/{settingId} { allow read: if isAuthed(); allow write: if isAdmin(); }

    // DEFAULT
    match /{document=**} {
      allow read, write: if isAuthed() && (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('role', '') == 'admin');
    }
  }
}
