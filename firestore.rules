rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- FUNCIONES AUXILIARES (EL CEREBRO DE SEGURIDAD) ---

    // 1. Verificar si el usuario está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }

    // 2. Obtener datos del usuario actual desde la DB (Costo: 1 lectura extra)
    function getUserData() {
      let resource = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return resource != null ? resource.data : {};
    }

    // 3. Verificar si es ADMIN (Dios)
    function isAdmin() {
      return isAuthenticated() && getUserData().get('role', 'user') == 'admin';
    }

    // 4. Verificar si el usuario pertenece a la franquicia que intenta tocar
    // 4. Verificar si el usuario pertenece a la franquicia que intenta tocar
    function belongsToFranchise(franchiseId) {
      // 1. Es el dueño (UID == FranchiseID)
      // 2. O es staff y tiene el franchiseId en su perfil
      return (request.auth.uid == franchiseId) || 
             (isAuthenticated() && (
               (getUserData().get('franchiseId', getUserData().get('franchise_id', null)) == franchiseId)
             ));
    }

    // 5. Validar que al crear/editar, no se cambie el franchise_id (Integridad)
    function isFranchiseIdPreserved() {
      // Usamos .get() en lugar de .keys().has() para seguridad y compatibilidad
      // request.resource.data es el documento entrante (escritura)
      // resource.data es el documento existente (lectura)
      
      return (request.resource.data.get('franchiseId', request.resource.data.get('franchise_id', null)) == null) ||
             (request.resource.data.get('franchiseId', request.resource.data.get('franchise_id', null)) == resource.data.get('franchiseId', resource.data.get('franchise_id', null))) ||
             belongsToFranchise(request.resource.data.get('franchiseId', request.resource.data.get('franchise_id', null)));
    }

    // --- REGLAS POR COLECCIÓN ---
    


    // 1. USUARIOS (Identidad)
    match /users/{userId} {
      // Admin lee/escribe todo. 
      // Usuario lee/escribe si es SU perfil.
      // Franquicia puede LEER si el usuario pertenece a su franquicia (Staff/Drivers)
      allow read: if isAdmin() || 
                  (isAuthenticated() && request.auth.uid == userId) ||
                  (isAuthenticated() && (
                    belongsToFranchise(resource.data.franchiseId) || 
                    belongsToFranchise(resource.data.franchise_id) ||
                    belongsToFranchise(userId)
                  ));
      allow write: if isAdmin() || 
                  (isAuthenticated() && request.auth.uid == userId) ||
                  (isAuthenticated() && (
                    // Permitir crear/editar si el usuario destino pertenece a mi franquicia
                    belongsToFranchise(request.resource.data.franchiseId) ||
                    // Permitir editar/borrar si el usuario existente pertenece a mi franquicia
                    (resource != null && belongsToFranchise(resource.data.franchiseId))
                  ));
    }

    // 2. FRANQUICIAS (Configuración)
    match /franchises/{franchiseId} {
      // Admin tiene control total.
      allow write: if isAdmin();
      // Franquiciado solo puede LEER su configuración. No tocar.
      allow read: if isAdmin() || belongsToFranchise(franchiseId);
      
      // Subcolección WEEKS (Horarios semanales)
      match /weeks/{weekId} {
        // Admin lee/escribe todo
        allow read, write: if isAdmin();
        // Franquicia lee/escribe solo sus propias semanas
        allow read, write: if belongsToFranchise(franchiseId);
      }
    }

    // 3. FLOTA (Activos)
    match /fleet_assets/{vehicleId} {
      // Admin total. Franquiciado lee/escribe si coincide el ID.
      allow read: if isAdmin() || belongsToFranchise(resource.data.franchise_id);
      allow create: if isAdmin() || belongsToFranchise(request.resource.data.franchise_id);
      allow update, delete: if isAdmin() || belongsToFranchise(resource.data.franchise_id);
    }

    // 4. TURNOS (Operaciones)
    match /work_shifts/{shiftId} {
      allow read: if isAdmin() || belongsToFranchise(resource.data.franchise_id);
      allow create: if isAdmin() || belongsToFranchise(request.resource.data.franchise_id);
      allow update, delete: if isAdmin() || belongsToFranchise(resource.data.franchise_id);
    }

    // 5. FINANZAS (El Dinero - ALTA SEGURIDAD)
    match /financial_records/{recordId} {
      // Lectura: Jerarquía estándar
      allow read: if isAdmin() || belongsToFranchise(resource.data.franchise_id);
      
      // Creación: OK si coincide la franquicia
      allow create: if isAdmin() || belongsToFranchise(request.resource.data.franchise_id);
      
      // Actualización: CUIDADO AQUÍ
      allow update: if 
        isAdmin() || // Admin hace lo que quiera (aprobar/rechazar)
        (
          belongsToFranchise(resource.data.franchise_id) && // Es su franquicia
          resource.data.status == 'pending' && // Solo puede editar si está PENDIENTE
          !request.resource.data.diff(resource.data).affectedKeys().hasAny(['status', 'franchise_id']) 
          // NO PUEDE CAMBIAR SU PROPIO ESTADO A 'APPROVED' NI MOVERLO DE FRANQUICIA
        );

      allow delete: if isAdmin(); // Solo Admin borra dinero (Auditoría)
    }

    // --- NUEVO: RESÚMENES FINANCIEROS (Snapshots mensuales) ---
    match /financial_summaries/{summaryId} {
      // El ID del documento es {franchiseId}_{month}
      // Lectura: Admin o Dueño de esa franquicia
      // Lectura: Admin, Dueño (por campo) O Dueño (por ID del documento, para permitir verificar existencia)
      allow read: if isAdmin() || 
                  (isAuthenticated() && (
                    summaryId.matches(request.auth.uid + '_.*') || 
                    (resource != null && belongsToFranchise(resource.data.franchiseId))
                  ));
      
      // Escritura: Admin o Dueño (para guardar cálculos)
      allow write: if isAdmin() || belongsToFranchise(request.resource.data.franchiseId);
    }

    // 6. ACADEMY (Formación)
    match /academy_courses/{courseId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin(); // Solo Admin crea cursos
    }
    
    match /academy_progress/{progressId} {
      // Allow authenticated users to query their progress (needed for onSnapshot with where clause)
      allow read: if isAuthenticated();
      // Admin can write anything
      allow write: if isAdmin();
      // Users can only create/update their own progress
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    match /academy_lessons/{lessonId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    match /academy_quizzes/{quizId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    match /academy_results/{resultId} {
      allow read: if isAdmin() || (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow write: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }

    // 6.5. DATOS FINANCIEROS (Dashboard)
    match /financial_data/{dataId} {
      // Admin lee todo
      allow read: if isAdmin();
      // Franquicia lee/escribe sus propios datos
      // PERMITIR si el ID empieza con el UID (para docs que no existen aun) O si la data coincide
      allow read: if isAuthenticated() && (
        dataId.matches(request.auth.uid + '_.*') ||
        (resource != null && belongsToFranchise(resource.data.franchiseId))
      );
      allow write: if isAuthenticated() && belongsToFranchise(request.resource.data.franchiseId);
      allow create: if isAuthenticated() && belongsToFranchise(request.resource.data.franchiseId);
    }

    // 6.6. NOTIFICACIONES
    match /notifications/{notificationId} {
      // Usuario lee solo sus notificaciones
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // Admin lee todo
      allow read: if isAdmin();
      // Sistema y admin pueden crear
      allow create: if isAdmin();
      // Usuario puede marcar como leída
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // 6.8. ADMIN NOTIFICATIONS (Global Stream)
    match /admin_notifications/{notificationId} {
      // Admin lee y gestiona (marcar leída)
      allow read, update: if isAdmin();
      // Franquicias (y sistema) crean notificaciones
      allow create: if isAuthenticated();
    }

    // 6.7. AUDIT LOGS (Solo admin)
    match /audit_logs/{logId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated(); // Cualquiera puede escribir logs
    }

    // 7. RECURSOS (Documentación compartida)
    match /resources/{resourceId} {
      // Cualquier usuario autenticado puede leer recursos
      allow read: if isAuthenticated();
      // Solo Admin puede crear/modificar/eliminar recursos
      allow write: if isAdmin();
    }

    // 8. TICKETS (Soporte)
    match /tickets/{ticketId} {
      // Admin lee todo
      allow read: if isAdmin();
      // Usuario lee solo sus propios tickets
      allow read: if isAuthenticated() && resource.data.uid == request.auth.uid;
      
      // Admin escribe todo
      allow write: if isAdmin();
      // Usuario puede crear tickets
      allow create: if isAuthenticated() && request.resource.data.uid == request.auth.uid;
      
      // Subcolección de mensajes
      match /messages/{messageId} {
        allow read: if isAdmin() || (isAuthenticated() && get(/databases/$(database)/documents/tickets/$(ticketId)).data.uid == request.auth.uid);
        allow write: if isAdmin();
        allow create: if isAuthenticated() && (isAdmin() || get(/databases/$(database)/documents/tickets/$(ticketId)).data.uid == request.auth.uid);
      }
    }

    // 9. ANUNCIOS (Noticias)
    match /announcements/{announcementId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // 10. FEATURE REQUESTS (Roadmap - Solo Admin)
    match /feature_requests/{requestId} {
      // Solo administradores pueden leer y escribir
      allow read, write: if isAdmin();
    }

    // 11. KANBAN PROJECT TASKS (Nuevo Sistema v2)
    match /project_tasks/{taskId} {
      // ESTRICTO: Solo Admin. Sin excepciones.
      allow read, write: if isAdmin();
    }
  }
}
