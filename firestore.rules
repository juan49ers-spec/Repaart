rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- AUTHENTICATION HELPERS ---
    function isAuthed() {
      return request.auth != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function isAdmin() {
      return isAuthed() && (
        getUserData().role == 'admin' || 
        request.auth.token.role == 'admin' // Support custom claims if used
      );
    }
    
    function isFranchise() {
      return isAuthed() && (
        getUserData().role == 'franchise' || 
        request.auth.token.role == 'franchise'
      );
    }

    function isRider() {
       return isAuthed(); // Simplified for now, or check role == 'rider'
    }

    // --- COLLECTION RULES ---

    // USERS: Owner can read/write own profile. Admin can read/write all. Franchise can read/list/update their riders.
    match /users/{userId} {
      allow read: if isAuthed() && (request.auth.uid == userId || isAdmin() || isFranchise());
      // CREATE: DENIED. Handled by Cloud Function 'createUserManaged' (Admin SDK)
      allow create: if false; 
      // UPDATE: Admin OR Own Profile OR Franchise updating their own riders
      allow update: if isAuthed() && (
        isAdmin() || 
        request.auth.uid == userId ||
        (isFranchise() && resource.data.franchiseId == request.auth.uid)
      );
      // Allow list queries for Admins and Franchises
      allow list: if isAuthed() && (isAdmin() || isFranchise()); 
    }

    // WORK SHIFTS
    match /work_shifts/{shiftId} {
      allow read: if isAuthed() && (isAdmin() || isFranchise() || resource.data.riderId == request.auth.uid);
      allow write: if isAuthed() && (isAdmin() || isFranchise());
    }
    
    // FINANCIAL DATA & SUMMARIES
    match /financial_records/{recordId} {
      allow read, write: if isAuthed() && (isAdmin() || isFranchise());
    }
    match /financial_data/{docId} {
      allow read, write: if isAuthed() && (isAdmin() || isFranchise());
    }
    match /finance_closures/{closureId} {
       allow read, write: if isAuthed() && (isAdmin() || isFranchise());
    }
    match /financial_summaries/{docId} {
       allow read, write: if isAuthed() && (isAdmin() || isFranchise());
    }

    // SUPPORT TICKETS (Incidents & SupportHub)
    match /tickets/{ticketId} {
      allow read: if isAuthed() && (isAdmin() || resource.data.uid == request.auth.uid || resource.data.franchiseId == request.auth.uid || resource.data.createdBy == request.auth.uid);
      allow create: if isAuthed();
      allow update: if isAuthed() && (isAdmin() || resource.data.uid == request.auth.uid || resource.data.createdBy == request.auth.uid);
      
      // Subcollection: Messages
      match /messages/{messageId} {
        allow read, write: if isAuthed();
      }
    }
    
    // RIDER INCIDENTS & CHECKS
    match /incidents/{incidentId} {
        allow read: if isAuthed() && (isAdmin() || resource.data.riderId == request.auth.uid || isFranchise());
        allow create: if isAuthed();
        allow update: if isAuthed() && (isAdmin() || resource.data.riderId == request.auth.uid);
    }
    match /vehicle_checks/{checkId} {
         allow read: if isAuthed() && (isAdmin() || resource.data.riderId == request.auth.uid || isFranchise());
         allow create: if isAuthed();
    }

    // NOTIFICATIONS
    match /notifications/{notificationId} {
      allow read: if isAuthed() && (
        resource.data.userId == request.auth.uid || 
        isAdmin() ||
        (isFranchise() && resource.data.userId == getUserData().franchiseId)
      );
      allow write: if isAuthed(); // Logic usually handled by server, but allowing client writes for now
    }
    match /admin_notifications/{notifId} {
      allow read, write: if isAuthed() && (isAdmin() || isFranchise()); // Franchise might create alerts
    }

    // FEATURES & ROADMAP
    match /feature_requests/{featureId} {
      allow read: if isAuthed();
      allow write: if isAuthed() && isAdmin(); // Only Admin edits roadmap
    }

    // PREMIUM SERVICES
    match /premium_services/{serviceId} {
      allow read: if isAuthed();
      allow write: if isAdmin();
    }
    
    // DOCUMENT REQUESTS
    match /document_requests/{requestId} {
      allow read: if isAuthed() && (isAdmin() || resource.data.franchiseId == request.auth.uid);
      allow create: if isAuthed() && isFranchise();
      allow update: if isAdmin();
    }

    // OPERATIONS: FRANCHISES & WEEKS (Matrix V3)
    // FIX: Auth UID might be mixed case while Franchise ID is uppercase. Allowing flexible check.
    match /franchises/{franchiseId} {
      allow read: if isAuthed() && (request.auth.uid.lower() == franchiseId.lower() || isAdmin());
      allow write: if isAuthed() && isAdmin();
      
      match /weeks/{weekId} {
         allow read, write: if isAuthed() && (request.auth.uid.lower() == franchiseId.lower() || isAdmin());
      }
    }

    // FLEET ASSETS (Vehicles)
    match /fleet_assets/{assetId} {
      allow read: if isAuthed() && (isAdmin() || resource.data.franchiseId.lower() == request.auth.uid.lower());
      allow write: if isAuthed() && (isAdmin() || resource.data.franchiseId.lower() == request.auth.uid.lower());
    }
    
    // AUDIT LOGS
    match /audit_logs/{logId} {
      allow create: if isAuthed();
      allow read: if isAdmin();
    }
    
    // ANNOUNCEMENTS
    match /announcements/{announcementId} {
      allow read: if isAuthed();
      allow write: if isAuthed() && isAdmin();
    }
    
    match /project_tasks/{taskId} {
      allow read, write: if isAuthed() && isAdmin();
    }
    
    // =============================================
    // ACADEMY SYSTEM (Courses, Lessons, Quizzes, Progress, Encyclopedia)
    // =============================================
    
    // ACADEMY COURSES (Modules)
    match /academy_courses/{courseId} {
      allow read: if isAuthed(); // All authenticated users can read courses
      allow write: if isAuthed() && isAdmin(); // Only admin can create/edit/delete courses
    }
    
    // ACADEMY LESSONS
    match /academy_lessons/{lessonId} {
      allow read: if isAuthed();
      allow write: if isAuthed() && isAdmin();
    }
    
    // ACADEMY QUIZZES
    match /academy_quizzes/{quizId} {
      allow read: if isAuthed();
      allow write: if isAuthed() && isAdmin();
    }
    
    // ACADEMY PROGRESS (User progress tracking)
    match /academy_progress/{progressId} {
      allow read: if isAuthed() && (
        isAdmin() || 
        resource.data.userId == request.auth.uid
      );
      allow create: if isAuthed(); // Users can create their own progress
      allow update: if isAuthed() && (
        isAdmin() || 
        resource.data.userId == request.auth.uid
      );
    }
    
    // QUIZ RESULTS
    match /quiz_results/{resultId} {
      allow read: if isAuthed() && (
        isAdmin() || 
        resource.data.userId == request.auth.uid
      );
      allow create: if isAuthed();
      allow update: if isAuthed() && isAdmin();
    }
    
    // ENCYCLOPEDIA CATEGORIES
    match /academy_encyclopedia_categories/{categoryId} {
      allow read: if isAuthed();
      allow write: if isAuthed() && isAdmin();
    }
    
    // ENCYCLOPEDIA ARTICLES
    match /academy_encyclopedia_articles/{articleId} {
      allow read: if isAuthed();
      allow write: if isAuthed() && isAdmin();
    }
    
    // LEGACY: academy_encyclopedia (for backwards compatibility)
    match /academy_encyclopedia/{cardId} {
      allow read: if isAuthed();
      allow write: if isAuthed() && (isAdmin() || isFranchise());
    }
    
    // SETTINGS (Banner, App Config, etc)
    match /settings/{settingId} {
      allow read: if isAuthed(); // All authenticated users can read settings
      allow write: if isAuthed() && isAdmin(); // Only Admin can modify settings
    }

    // RESOURCES (Franchise Resources Panel)
    match /resources/{resourceId} {
      allow read: if isAuthed();
      allow write: if isAuthed() && isAdmin();
    }

    // GUIDES (Financial Guides, Manuals)
    match /guides/{guideId} {
        allow read: if isAuthed();
        allow write: if isAuthed() && isAdmin();
    }
    
    // DEFAULT DENY
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
