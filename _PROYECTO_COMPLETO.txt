Generado el: 2025-12-19T18:10:01.806Z



================================================================================
FILE: eslint.config.js
================================================================================
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist', 'scripts/', 'public/sw.js']),
  {
    files: ['**/*.{js,jsx}'],
    extends: [
      js.configs.recommended,
      reactHooks.configs.flat.recommended,
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
      parserOptions: {
        ecmaVersion: 'latest',
        ecmaFeatures: { jsx: true },
        sourceType: 'module',
      },
    },
    rules: {
      'no-unused-vars': ['error', { varsIgnorePattern: '^[A-Z_]' }],
    },
  },
])



================================================================================
FILE: firebase.json
================================================================================
{
  "hosting": {
    "public": "dist",
    "ignore": [
      "firebase.json",
      "**/.*",
      "**/node_modules/**"
    ],
    "rewrites": [
      {
        "source": "**",
        "destination": "/index.html"
      }
    ],
    "headers": [
      {
        "source": "/index.html",
        "headers": [
          {
            "key": "Cache-Control",
            "value": "no-cache, no-store, must-revalidate"
          },
          {
            "key": "Pragma",
            "value": "no-cache"
          }
        ]
      },
      {
        "source": "/sw.js",
        "headers": [
          {
            "key": "Cache-Control",
            "value": "no-cache, no-store, must-revalidate"
          }
        ]
      }
    ]
  },
  "firestore": {
    "rules": "firestore.rules"
  },
  "storage": {
    "rules": "storage.rules"
  }
}


================================================================================
FILE: firestore.indexes.json
================================================================================
{
    "indexes": [
        {
            "collectionGroup": "academy_lessons",
            "queryScope": "COLLECTION",
            "fields": [
                {
                    "fieldPath": "moduleId",
                    "order": "ASCENDING"
                },
                {
                    "fieldPath": "order",
                    "order": "ASCENDING"
                }
            ]
        }
    ],
    "fieldOverrides": []
}


================================================================================
FILE: index.html
================================================================================
<!doctype html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" href="/icon.jpg" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)" />
  <meta name="theme-color" content="#102a43" media="(prefers-color-scheme: dark)" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <title>REPAART | Dashboard Financiero</title>
  <meta name="description" content="Dashboard de gesti√≥n financiera y operativa para franquicias de reparto." />
  <link rel="apple-touch-icon" href="/icon.jpg" />
  <link rel="manifest" href="/manifest.webmanifest" />
</head>

<body style="background-color: #020617; color: white;">
  <div id="root"></div>
  <script type="module" src="/src/main.jsx"></script>
</body>

</html>


================================================================================
FILE: package.json
================================================================================
{
  "name": "synthetic-sagan",
  "private": true,
  "version": "3.2.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "lint": "eslint .",
    "preview": "vite preview",
    "seed:encyclopedia": "node scripts/seedEncyclopedia.js"
  },
  "dependencies": {
    "@emailjs/browser": "^4.4.1",
    "@google/generative-ai": "^0.24.1",
    "firebase": "^12.6.0",
    "html2canvas": "^1.4.1",
    "jspdf": "^3.0.4",
    "jspdf-autotable": "^5.0.2",
    "lucide-react": "^0.561.0",
    "prop-types": "^15.8.1",
    "react": "^19.2.0",
    "react-dom": "^19.2.0",
    "react-is": "^19.2.3",
    "react-markdown": "^10.1.0",
    "react-quill": "^2.0.0",
    "recharts": "^2.13.0"
  },
  "devDependencies": {
    "@eslint/js": "^9.39.1",
    "@tailwindcss/postcss": "^4.1.18",
    "@types/react": "^19.2.5",
    "@types/react-dom": "^19.2.3",
    "@vitejs/plugin-react": "^5.1.1",
    "autoprefixer": "^10.4.23",
    "eslint": "^9.39.1",
    "eslint-plugin-react-hooks": "^7.0.1",
    "eslint-plugin-react-refresh": "^0.4.24",
    "firebase-admin": "^13.6.0",
    "firebase-tools": "^15.0.0",
    "globals": "^16.5.0",
    "postcss": "^8.5.6",
    "tailwindcss": "^4.1.18",
    "vite": "^7.2.4",
    "vite-plugin-pwa": "^1.2.0"
  }
}



================================================================================
FILE: postcss.config.js
================================================================================
export default {
    plugins: {
        '@tailwindcss/postcss': {},
        autoprefixer: {},
    },
}



================================================================================
FILE: public\cleanup-encyclopedia.html
================================================================================
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encyclopedia Cleanup Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 800px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            color: #1a202c;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .subtitle {
            color: #718096;
            margin-bottom: 30px;
        }

        .warning {
            background: #fed7d7;
            border-left: 4px solid #f56565;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .warning strong {
            color: #c53030;
        }

        .status {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
        }

        .status-line {
            padding: 4px 0;
            border-bottom: 1px solid #edf2f7;
        }

        .status-line:last-child {
            border-bottom: none;
        }

        .error {
            color: #e53e3e;
        }

        .success {
            color: #38a169;
        }

        .warning-text {
            color: #d69e2e;
        }

        .info {
            color: #3182ce;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            margin-top: 10px;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üßπ Encyclopedia Cleanup Tool</h1>
        <p class="subtitle">Herramienta de limpieza de m√≥dulos duplicados</p>

        <div class="warning">
            <strong>‚ö†Ô∏è ADVERTENCIA:</strong> Esta herramienta eliminar√° permanentemente los m√≥dulos duplicados.
            Solo ejecuta si eres administrador y est√°s seguro.
        </div>

        <div id="authSection">
            <p style="margin-bottom: 15px;">Por favor, inicia sesi√≥n como administrador para continuar:</p>
            <button onclick="login()">üîê Iniciar Sesi√≥n</button>
        </div>

        <div id="mainSection" class="hidden">
            <div class="stats">
                <div class="stat-card">
                    <span class="stat-number" id="totalModules">-</span>
                    <span class="stat-label">Total en BD</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="uniqueModules">-</span>
                    <span class="stat-label">√önicos</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="duplicateCount">-</span>
                    <span class="stat-label">Duplicados</span>
                </div>
            </div>

            <button onclick="scanDuplicates()" id="scanBtn">üîç Escanear Duplicados</button>
            <button onclick="cleanupDuplicates()" id="cleanupBtn" class="hidden">üóëÔ∏è Limpiar Duplicados</button>

            <div class="status" id="statusLog"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, deleteDoc, doc, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDGU0IjPPFe8Mz0MjbwK9E6EWZfEW7fVD8",
            authDomain: "repaartfinanzas.firebaseapp.com",
            projectId: "repaartfinanzas",
            storageBucket: "repaartfinanzas.firebasestorage.app",
            messagingSenderId: "893626733062",
            appId: "1:893626733062:web:6b4d45e43cbeef77ec2856"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let duplicatesToDelete = [];

        window.login = async function () {
            const email = prompt('Email de administrador:', 'admin@repaart.com');
            const password = prompt('Contrase√±a:');

            if (!email || !password) return;

            try {
                await signInWithEmailAndPassword(auth, email, password);
                log('‚úÖ Sesi√≥n iniciada correctamente', 'success');
            } catch (error) {
                log('‚ùå Error al iniciar sesi√≥n: ' + error.message, 'error');
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('authSection').classList.add('hidden');
                document.getElementById('mainSection').classList.remove('hidden');
                log('üë§ Conectado como: ' + user.email, 'info');
            } else {
                document.getElementById('authSection').classList.remove('hidden');
                document.getElementById('mainSection').classList.add('hidden');
            }
        });

        window.scanDuplicates = async function () {
            document.getElementById('scanBtn').disabled = true;
            document.getElementById('statusLog').innerHTML = '';

            log('üîç Escaneando base de datos...', 'info');

            try {
                const modulesRef = collection(db, 'encyclopedia_modules');
                const modulesQuery = query(modulesRef, orderBy('createdAt', 'asc'));
                const snapshot = await getDocs(modulesQuery);

                const modules = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                log(`üìä Total de documentos: ${modules.length}`, 'info');

                // Group by title
                const titleMap = new Map();
                duplicatesToDelete = [];

                modules.forEach(mod => {
                    const title = mod.title;

                    if (!titleMap.has(title)) {
                        titleMap.set(title, mod);
                    } else {
                        duplicatesToDelete.push({
                            id: mod.id,
                            title: title
                        });
                    }
                });

                document.getElementById('totalModules').textContent = modules.length;
                document.getElementById('uniqueModules').textContent = titleMap.size;
                document.getElementById('duplicateCount').textContent = duplicatesToDelete.length;

                if (duplicatesToDelete.length === 0) {
                    log('‚úÖ ¬°No se encontraron duplicados! La base de datos est√° limpia.', 'success');
                    document.getElementById('scanBtn').disabled = false;
                } else {
                    log(`‚ö†Ô∏è Se encontraron ${duplicatesToDelete.length} m√≥dulos duplicados`, 'warning-text');
                    duplicatesToDelete.slice(0, 10).forEach((dup, i) => {
                        log(`   ${i + 1}. "${dup.title}" (ID: ${dup.id})`, 'warning-text');
                    });

                    if (duplicatesToDelete.length > 10) {
                        log(`   ... y ${duplicatesToDelete.length - 10} m√°s`, 'warning-text');
                    }

                    document.getElementById('cleanupBtn').classList.remove('hidden');
                    document.getElementById('scanBtn').disabled = false;
                }

            } catch (error) {
                log('‚ùå Error al escanear: ' + error.message, 'error');
                document.getElementById('scanBtn').disabled = false;
            }
        };

        window.cleanupDuplicates = async function () {
            if (!confirm(`¬øEst√°s seguro de que quieres ELIMINAR ${duplicatesToDelete.length} m√≥dulos duplicados?\n\nEsta acci√≥n NO se puede deshacer.`)) {
                return;
            }

            document.getElementById('cleanupBtn').disabled = true;
            log('üóëÔ∏è Iniciando limpieza...', 'info');

            let deleted = 0;
            const total = duplicatesToDelete.length;

            for (const dup of duplicatesToDelete) {
                try {
                    await deleteDoc(doc(db, 'encyclopedia_modules', dup.id));
                    deleted++;

                    if (deleted % 10 === 0 || deleted === total) {
                        log(`Eliminados ${deleted}/${total}...`, 'info');
                    }
                } catch (error) {
                    log(`‚ùå Error eliminando ${dup.id}: ${error.message}`, 'error');
                }
            }

            log(`‚úÖ ¬°LIMPIEZA COMPLETA!`, 'success');
            log(`‚úÖ Eliminados: ${deleted} m√≥dulos duplicados`, 'success');
            log(`‚úÖ Restantes: ${parseInt(document.getElementById('totalModules').textContent) - deleted} m√≥dulos √∫nicos`, 'success');
            log('', 'info');
            log('üîÑ Recarga la aplicaci√≥n principal para ver los cambios', 'info');

            document.getElementById('duplicateCount').textContent = '0';
            document.getElementById('cleanupBtn').classList.add('hidden');
        };

        function log(message, type = 'info') {
            const statusLog = document.getElementById('statusLog');
            const line = document.createElement('div');
            line.className = `status-line ${type}`;
            line.textContent = message;
            statusLog.appendChild(line);
            statusLog.scrollTop = statusLog.scrollHeight;
        }
    </script>
</body>

</html>


================================================================================
FILE: public\encyclopediaSeed.js
================================================================================
export const ENCYCLOPEDIA_SEED_DATA = {
    "categories": [
        { "id": "estrategia", "name": "Estrategia", "icon": "TrendingUp", "color": "blue", "order": 1, "unlockRequirement": null },
        { "id": "finanzas", "name": "Finanzas", "icon": "DollarSign", "color": "emerald", "order": 2, "unlockRequirement": "estrategia" },
        { "id": "operativa", "name": "Operativa", "icon": "Truck", "color": "sky", "order": 3, "unlockRequirement": "finanzas" },
        { "id": "rrhh", "name": "RRHH & Equipo", "icon": "Users", "color": "indigo", "order": 4, "unlockRequirement": "operativa" },
        { "id": "seguridad", "name": "Seguridad", "icon": "ShieldAlert", "color": "red", "order": 5, "unlockRequirement": "rrhh" },
        { "id": "eficiencia", "name": "Eficiencia", "icon": "Zap", "color": "yellow", "order": 6, "unlockRequirement": "seguridad" },
        { "id": "comercial", "name": "Comercial", "icon": "Briefcase", "color": "purple", "order": 7, "unlockRequirement": "eficiencia" },
        { "id": "cultura", "name": "Cultura", "icon": "Heart", "color": "pink", "order": 8, "unlockRequirement": "comercial" },
        { "id": "maestria", "name": "Maestr√≠a", "icon": "Crown", "color": "amber", "order": 9, "unlockRequirement": "cultura" },
        { "id": "tactica", "name": "T√°ctica", "icon": "Wrench", "color": "slate", "order": 10, "unlockRequirement": "maestria" },
        { "id": "crisis", "name": "Legal & Crisis", "icon": "AlertCircle", "color": "orange", "order": 11, "unlockRequirement": "tactica" },
        { "id": "micro", "name": "Micro-Gesti√≥n", "icon": "Target", "color": "teal", "order": 12, "unlockRequirement": "crisis" }
    ],
    "modules": [
        // ESTRATEGIA (1-12)
        { "categoryId": "estrategia", "title": "Modelo 'Superaut√≥nomos'", "content": "No somos una ETT ni una plataforma gig-economy. Somos una Operadora Log√≠stica Descentralizada. Combinamos la flexibilidad operativa de la microempresa con una estructura s√≥lida de asalariados, eliminando el riesgo de 'falsos aut√≥nomos' para el cliente.", "action": "Vende 'Flota Dedicada' y seguridad jur√≠dica.", "order": 1 },
        { "categoryId": "estrategia", "title": "Packs: B√°sico vs Premium", "content": "El Pack B√°sico (1.500‚Ç¨) es para expertos. El Premium (3.000‚Ç¨) incluye Mentoring. Empezar con el B√°sico sin experiencia es el error m√°s caro que puedes cometer.", "action": "Si eres nuevo, el Pack Premium es obligatorio para tu supervivencia.", "order": 2 },
        { "categoryId": "estrategia", "title": "Matriz de Tarifas", "content": "La rentabilidad est√° en la densidad. Zona A (0-4km) a 6‚Ç¨ es el n√∫cleo. Zona D (6-7km) a 9‚Ç¨ es disuasoria para no perder productividad en viajes largos.", "action": "El 80% de tu facturaci√≥n debe ser Zona A.", "order": 3 },
        { "categoryId": "estrategia", "title": "Expansi√≥n Contigua", "content": "Crece como una mancha de aceite, barrio a barrio. Abrir una zona aislada duplica costes fijos sin sinergias de flota.", "action": "Jam√°s saltes geogr√°ficamente sin consolidar.", "order": 4 },
        { "categoryId": "estrategia", "title": "La Tela de Ara√±a", "content": "La densidad es dinero. Si ya vas a un restaurante, recoger otro pedido en el local de al lado tiene coste cero para ti. Si tienes un cliente, ve a por sus vecinos.", "action": "Visita inmediatamente a los locales de la misma calle.", "order": 5 },
        { "categoryId": "estrategia", "title": "Poda de Zona Lejana", "content": "En hora punta, los pedidos lejanos matan la rotaci√≥n. Un viaje de 14km te deja sin repartidor 40 minutos, perdiendo 3 pedidos cortos.", "action": "Viernes noche: Restringe el servicio a 5km m√°ximo.", "order": 6 },
        { "categoryId": "estrategia", "title": "Regla del 'Sem√°foro Rojo'", "content": "No inicies operaciones sin 700 pedidos firmados. Empezar con menos te obliga a tener estructura m√≠nima pero facturando la mitad, quemando tu dinero.", "action": "Disciplina f√©rrea: Sin firmas no se activan las motos.", "order": 7 },
        { "categoryId": "estrategia", "title": "Crecimiento Org√°nico", "content": "Optimiza recursos permitiendo que los repartidores fluyan entre zonas contiguas seg√∫n la demanda en tiempo real, como vasos comunicantes.", "action": "Dise√±a zonas que se toquen entre s√≠.", "order": 8 },
        { "categoryId": "estrategia", "title": "Zonificaci√≥n Inteligente", "content": "No todas las calles valen lo mismo. Prioriza zonas con alta densidad de restauraci√≥n y edificios altos (muchos vecinos en poco espacio).", "action": "Analiza el mapa antes de vender: busca 'colmenas' de pedidos.", "order": 9 },
        { "categoryId": "estrategia", "title": "El Riesgo de Concentraci√≥n", "content": "Aprende del caso Navalmoral. Nunca dependas m√°s del 30% de un solo cliente grande o partner. Si ellos cambian de pol√≠tica, t√∫ cierras.", "action": "Diversifica tu cartera de restaurantes peque√±os y medianos.", "order": 10 },
        { "categoryId": "estrategia", "title": "La Figura del Gerente", "content": "Al crecer, no puedes hacerlo todo. Necesitas un Responsable de Operaciones y Ventas (50/50) para seguir expandiendo sin colapsar.", "action": "Contrata ayuda cuando te satures operativamente.", "order": 11 },
        { "categoryId": "estrategia", "title": "Consultor√≠a Puntual", "content": "Si te atascas, contrata ayuda a la central por horas. Es mucho m√°s barato que cometer errores operativos mes tras mes.", "action": "Usa el comod√≠n de la llamada ante dudas cr√≠ticas.", "order": 12 },

        // FINANZAS (13-25)
        { "categoryId": "finanzas", "title": "Protocolo de Cobros", "content": "Facturaci√≥n quincenal con vencimiento a 5 d√≠as. Sistema de Corte Autom√°tico que suspende el servicio ante impagos al d√≠a 6.", "action": "Tolerancia cero con impagos. No financies a tus clientes.", "order": 13 },
        { "categoryId": "finanzas", "title": "Fondo de Maniobra", "content": "Capital intocable (~1.500‚Ç¨) para emergencias. No es beneficio repartible. Es tu seguro de vida para aver√≠as o fianzas.", "action": "Nunca lo uses para tu sueldo personal.", "order": 14 },
        { "categoryId": "finanzas", "title": "Disciplina Fiscal", "content": "Adelanta el 20% del beneficio trimestral a Hacienda. El dinero en caja no es todo tuyo, eres un recaudador de impuestos temporal.", "action": "Separa el 20% mensual en otra cuenta bancaria.", "order": 15 },
        { "categoryId": "finanzas", "title": "Caja de Resistencia", "content": "Alerta Roja: si el saldo baja de 1.100‚Ç¨, la viabilidad corre riesgo. Es el sem√°foro para cortar gastos radicales inmediatamente.", "action": "Si entras en alerta, corta gastos no esenciales hasta reponer saldo.", "order": 16 },
        { "categoryId": "finanzas", "title": "F√≥rmula del Beneficio", "content": "Solo hay dos palancas: Aumentar Ventas o Bajar Costes. Bajar costes es m√°s r√°pido. Revisa horas muertas y gasolina.", "action": "Audita costes antes de intentar vender m√°s.", "order": 17 },
        { "categoryId": "finanzas", "title": "Calidad de Deuda", "content": "Vigila la deuda a corto plazo. Si debes mucho para pagar 'ya', un solo mes malo te lleva a la quiebra.", "action": "Reestructura deuda a largo plazo para ganar ox√≠geno.", "order": 18 },
        { "categoryId": "finanzas", "title": "Umbral de Rentabilidad", "content": "Un repartidor debe hacer entre 2,2 y 2,5 pedidos por hora para cubrir su coste y el de la moto. Menos de eso es perder dinero.", "action": "Si baja el ratio, audita al repartidor o la zona.", "order": 19 },
        { "categoryId": "finanzas", "title": "El Valle de la Muerte", "content": "El primer mes tienes gastos desde el d√≠a 1 pero cobras el d√≠a 25. Necesitas liquidez inicial para aguantar ese decalaje.", "action": "Ten el dinero de la primera n√≥mina antes de abrir.", "order": 20 },
        { "categoryId": "finanzas", "title": "Billetes Falsos", "content": "De noche es f√°cil colar billetes falsos. El repartidor es un cajero con ruedas vulnerable.", "action": "Usa rotuladores detectores. Ante la duda, devuelve el billete amablemente.", "order": 21 },
        { "categoryId": "finanzas", "title": "Gastos Controlables", "content": "Distingue entre estructurales (alquiler, impuestos) y controlables (luz, material, reparaciones). Ataca los segundos.", "action": "Revisa facturas variables cada mes con lupa.", "order": 22 },
        { "categoryId": "finanzas", "title": "Cuadro de Mando", "content": "Monitoriza ratios clave: D√≠as de Caja, Ventas por Empleado y Plazo de Cobro real.", "action": "Revisa estos 3 datos cada viernes.", "order": 23 },
        { "categoryId": "finanzas", "title": "Trampa de Liquidez", "content": "Tener dinero en el banco no significa tener beneficios. Descuenta impuestos futuros y amortizaciones.", "action": "No gastes por falsa sensaci√≥n de riqueza.", "order": 24 },
        { "categoryId": "finanzas", "title": "Solvencia Real", "content": "Fondo de maniobra y cobertura de deuda. Miden si tu empresa aguantar√° un mal trimestre.", "action": "Calcula tu solvencia real trimestralmente.", "order": 25 },

        // OPERATIVA (26-38)
        { "categoryId": "operativa", "title": "Tecnolog√≠a Flyder", "content": "Flyder es el cerebro operativo. Coste 0,35‚Ç¨/pedido. Gestiona asignaci√≥n inteligente.", "action": "Revisa semanalmente pedidos duplicados para no pagar comisiones extra.", "order": 26 },
        { "categoryId": "operativa", "title": "Gesti√≥n de Flota", "content": "Renting vs Propiedad. El renting incluye mantenimiento, pero exige revisiones a rajatabla (1k, 5k, 10k km).", "action": "Ten siempre 1 moto propia de reserva por cada 10 de renting.", "order": 27 },
        { "categoryId": "operativa", "title": "Sin Cobertura", "content": "Zonas de sombra (s√≥tanos, muros gruesos). El rider desaparece del mapa.", "action": "Protocolo: Salir a cielo abierto, Modo Avi√≥n ON/OFF para forzar reconexi√≥n.", "order": 28 },
        { "categoryId": "operativa", "title": "El Limbo de los 10 D√≠as", "content": "Los contratos de renting suelen dar moto de sustituci√≥n SOLO si la aver√≠a supera los 10 d√≠as.", "action": "Cobertura propia (moto reserva o alquiler local) para aver√≠as cortas.", "order": 29 },
        { "categoryId": "operativa", "title": "Cliente Ausente", "content": "Protocolo legal: 3 llamadas en 5 minutos + Foto del portal/timbre.", "action": "Si no responde, devoluci√≥n al restaurante. Evita reclamaciones.", "order": 30 },
        { "categoryId": "operativa", "title": "Ingenier√≠a de Carga", "content": "Estiba incorrecta causa derrames. Separar fr√≠o/caliente. Bloquear salsas.", "action": "Formaci√≥n obligatoria en uso de separadores y espumas.", "order": 31 },
        { "categoryId": "operativa", "title": "Relevo R√°pido", "content": "Cambio de turno 'en caliente'. El turno de tarde llega 15 min antes.", "action": "Minimiza tiempo de moto parada. La moto debe rodar 14h/d√≠a.", "order": 32 },
        { "categoryId": "operativa", "title": "Control de Gasolina", "content": "Cruza Km App vs Litros repostados. Desviaci√≥n >20% = Robo o conducci√≥n agresiva.", "action": "Auditor√≠a mensual de consumo por matr√≠cula.", "order": 33 },
        { "categoryId": "operativa", "title": "Puntos Ciegos", "content": "Fallos de GPS en t√∫neles o calles estrechas.", "action": "Ense√±ar rutas alternativas manuales a los riders.", "order": 34 },
        { "categoryId": "operativa", "title": "Falsos Entregados", "content": "Fraude de rider: Marcar 'Entregado' antes de llegar para mejorar stats.", "action": "Cruza hora de clic con posici√≥n GPS real. Sanciona.", "order": 35 },
        { "categoryId": "operativa", "title": "Pedidos Fantasma", "content": "Pedidos cancelados que siguen en sistema y se cobran.", "action": "Limpieza de base de datos semanal.", "order": 36 },
        { "categoryId": "operativa", "title": "Alquiler Puente", "content": "Moto parada = 100‚Ç¨/d√≠a perdidos.", "action": "Convenio con alquiler local para picos o aver√≠as.", "order": 37 },
        { "categoryId": "operativa", "title": "El Minuto de Oro", "content": "Esperar 30s tras entrega por si el cliente reclama insitu.", "action": "Evita reembolsos totales por errores menores corregibles.", "order": 38 },

        // RRHH (39-51)
        { "categoryId": "rrhh", "title": "Perfil Ideal", "content": "24-40 a√±os. Estabilidad sobre velocidad. Evita perfiles 'turista laboral'.", "action": "Busca gente con hipoteca o familia, son m√°s fieles.", "order": 39 },
        { "categoryId": "rrhh", "title": "Control de Material", "content": "Casco, caj√≥n, ropa. Coste alto. Responsabilidad del trabajador.", "action": "Check-in/Check-out de material diario o semanal.", "order": 40 },
        { "categoryId": "rrhh", "title": "Liderazgo Adaptable", "content": "Directivo con novatos, Delegativo con veteranos.", "action": "No gestiones a todos igual. Ajusta tu presi√≥n.", "order": 41 },
        { "categoryId": "rrhh", "title": "Horas Complementarias", "content": "Mecanismo legal para cubrir picos sin horas extra ilegales.", "action": "Firma pacto de horas complementarias al contratar.", "order": 42 },
        { "categoryId": "rrhh", "title": "Reclutamiento Activo", "content": "No busques cuando tengas una baja. Ten siempre banquillo.", "action": "Entrevista 1 persona a la semana sistem√°ticamente.", "order": 43 },
        { "categoryId": "rrhh", "title": "Rituales de Equipo", "content": "Sentimiento de pertenencia reduce rotaci√≥n.", "action": "Briefing de 3 min pre-turno viernes noche.", "order": 44 },
        { "categoryId": "rrhh", "title": "Sistema de Referidos", "content": "Bono si un empleado trae a un amigo v√°lido (>2 meses).", "action": "Tus mejores empleados atraen gente similar.", "order": 45 },
        { "categoryId": "rrhh", "title": "Salida del Empleado", "content": "Recuperaci√≥n de activos cr√≠tica. Llaves, ropa, fianza.", "action": "Lista de chequeo de salida obligatoria.", "order": 46 },
        { "categoryId": "rrhh", "title": "Pol√≠tica de Propinas", "content": "Efectivo es suyo. App es del restaurante (a veces).", "action": "Claridad total para evitar rumores de robo.", "order": 47 },
        { "categoryId": "rrhh", "title": "Reciclaje Formativo", "content": "Los vicios de conducci√≥n aparecen a los 6 meses.", "action": "Curso de refresco semestral.", "order": 48 },
        { "categoryId": "rrhh", "title": "Flexibilidad Legal", "content": "Uso inteligente de contratos fijos-discontinuos.", "action": "Ases√≥rate bien para optimizar costes laborales.", "order": 49 },
        { "categoryId": "rrhh", "title": "Plan de Carrera", "content": "Rider -> Jefe de Tr√°fico -> Encargado.", "action": "Muestra camino de ascenso para retener talento.", "order": 50 },
        { "categoryId": "rrhh", "title": "Empleado Quemado", "content": "Signos: Quejas constantes, lentitud. R√≥talo de zona.", "action": "Cambia su rutina antes de que dimita.", "order": 51 },

        // SEGURIDAD (52-64)
        { "categoryId": "seguridad", "title": "Viento Lateral", "content": "Caj√≥n = Vela. >40km/h riesgo ca√≠da.", "action": "Reducir velocidad, circular centro carril. No adelantar camiones.", "order": 52 },
        { "categoryId": "seguridad", "title": "Kit de Emergencia", "content": "Bridas, cinta americana, destornillador, bombillas.", "action": "Reparaci√≥n in situ salva el turno.", "order": 53 },
        { "categoryId": "seguridad", "title": "Visera Sucia", "content": "Reflejos nocturnos ciegan. Peligro mortal.", "action": "Estaci√≥n de limpieza de cascos en la base.", "order": 54 },
        { "categoryId": "seguridad", "title": "Accidente Grave", "content": "Protocolo PAS: Proteger, Avisar, Socorrer. Fotos si posible.", "action": "Aviso inmediato a coordinador. Prioridad salud.", "order": 55 },
        { "categoryId": "seguridad", "title": "Protocolo Anti-Atraco", "content": "La vida vale m√°s que la moto o el efectivo.", "action": "No resistencia. Entregar todo. Llamar 112 luego.", "order": 56 },
        { "categoryId": "seguridad", "title": "Equipo B√°sico", "content": "Casco cerrado, chaqueta con protecciones, guantes.", "action": "Prohibido repartir en manga corta.", "order": 57 },
        { "categoryId": "seguridad", "title": "Zonas Rojas", "content": "Barrios conflictivos. Blacklist de calles peligrosas.", "action": "Mapa de zonas prohibidas en la base.", "order": 58 },
        { "categoryId": "seguridad", "title": "C√≥digo Rojo", "content": "Gesti√≥n de crisis post-accidente grave. Prensa/Familia.", "action": "Gerente asume el control de la comunicaci√≥n.", "order": 59 },
        { "categoryId": "seguridad", "title": "Sem√°foro Check", "content": "M√≥vil solo parado y pies en suelo.", "action": "Prohibido manipular GPS en marcha.", "order": 60 },
        { "categoryId": "seguridad", "title": "Efecto Vela II", "content": "Reiteraci√≥n viento. Peligro puentes y descampados.", "action": "Alerta meteorol√≥gica a la flota por WhatsApp.", "order": 61 },
        { "categoryId": "seguridad", "title": "Ver y Ser Visto", "content": "Luces funcionando siempre. Chaleco reflectante.", "action": "Revisi√≥n de luces diaria al salir.", "order": 62 },
        { "categoryId": "seguridad", "title": "Fatiga Visual", "content": "Lluvia + Noche = Ceguera. Spray repelente agua.", "action": "Tratamiento viseras en invierno.", "order": 63 },
        { "categoryId": "seguridad", "title": "Regla Anti-H√©roe", "content": "Reiteraci√≥n atraco. Tu seguridad es lo primero.", "action": "Formaci√≥n en desescaada de conflictos.", "order": 64 },

        // EFICIENCIA (65-77)
        { "categoryId": "eficiencia", "title": "Kil√≥metros Basura", "content": "Volver a base vac√≠o siempre es ineficiente.", "action": "Espera activa 3-5 min en zona de entrega.", "order": 65 },
        { "categoryId": "eficiencia", "title": "Pisos Bajos", "content": "Ascensor lento. 1¬∫, 2¬∫, 3¬∫ piso -> Escaleras.", "action": "Cardio t√°ctico: m√°s r√°pido y sano.", "order": 66 },
        { "categoryId": "eficiencia", "title": "Guantes T√°ctiles", "content": "Quitar/poner guantes = 1 min perdido por pedido.", "action": "Dotaci√≥n guantes compatibles con pantallas.", "order": 67 },
        { "categoryId": "eficiencia", "title": "Microcirug√≠a de Turnos", "content": "Escalonar entradas cada 15 min seg√∫n curva demanda.", "action": "No todos entran a las 20:00. 20:15, 20:30...", "order": 68 },
        { "categoryId": "eficiencia", "title": "Conducci√≥n Eficiente", "content": "Frenazos y acelerones gastan 30% m√°s.", "action": "Conducci√≥n fluida y anticipativa.", "order": 69 },
        { "categoryId": "eficiencia", "title": "Viajes en Vac√≠o", "content": "Optimizar triangulaciones. A -> B -> C -> Base.", "action": "Evitar rutas A -> Base -> B -> Base.", "order": 70 },
        { "categoryId": "eficiencia", "title": "Mapa de Obras", "content": "Alertas tr√°fico real en pizarra base.", "action": "Actualizar cortes de calle diariamente.", "order": 71 },
        { "categoryId": "eficiencia", "title": "Modo Oscuro", "content": "Ahorra bater√≠a m√≥vil. Menos fatiga visual noche.", "action": "Configuraci√≥n obligatoria apps.", "order": 72 },
        { "categoryId": "eficiencia", "title": "Cardio T√°ctico", "content": "Reiteraci√≥n escaleras. Salud laboral.", "action": "Fomentar deporte en el equipo.", "order": 73 },
        { "categoryId": "eficiencia", "title": "Kit Anti-Pinchazo", "content": "Spray reparaci√≥n temporal.", "action": "Llegar a base para cambio de moto.", "order": 74 },
        { "categoryId": "eficiencia", "title": "Ingenier√≠a Horarios", "content": "Turnos rotativos justos pero eficientes.", "action": "Cuadrantes publicados con 1 semana antelaci√≥n.", "order": 75 },
        { "categoryId": "eficiencia", "title": "Relevo Caliente II", "content": "Reiteraci√≥n cambio turno. Moto no enfr√≠a.", "action": "Coordinaci√≥n salida/entrada exacta.", "order": 76 },
        { "categoryId": "eficiencia", "title": "Guantes T√°ctiles II", "content": "Reiteraci√≥n. Esencial invierno.", "action": "Reponer stock guantes frecuentemente.", "order": 77 },

        // COMERCIAL (78-90)
        { "categoryId": "comercial", "title": "Argumentario de Venta", "content": "No vendes reparto, vendes paz mental y legalidad.", "action": "Enfoca en 'Flota Asalariada' vs 'Falsos Aut√≥nomos'.", "order": 78 },
        { "categoryId": "comercial", "title": "Estrategia Vecinal", "content": "Si vas a Pizzer√≠a X, visita a Hamburgueser√≠a Y de al lado.", "action": "Coste marginal de captaci√≥n casi cero.", "order": 79 },
        { "categoryId": "comercial", "title": "Diplomacia", "content": "Rider es la cara visible. Educaci√≥n extrema.", "action": "Saludo, casco fuera (si posible), sonrisa.", "order": 80 },
        { "categoryId": "comercial", "title": "Protocolo Activaci√≥n", "content": "Primeros d√≠as son test. El cliente busca fallos.", "action": "Supervisi√≥n doble las primeras 48h.", "order": 81 },
        { "categoryId": "comercial", "title": "Cliente Misterioso", "content": "Audita competencia. Pide comida para ver tiempos/estado.", "action": "Usa datos reales para vender mejora.", "order": 82 },
        { "categoryId": "comercial", "title": "Cancelaciones Falsas", "content": "Restaurante cancela en app pero pide llevar.", "action": "Fraude. No realizar el servicio si no est√° activo.", "order": 83 },
        { "categoryId": "comercial", "title": "Embajador B2B", "content": "Incentivo si restaurante recomienda a otro.", "action": "Descuento en factura por traer clientes.", "order": 84 },
        { "categoryId": "comercial", "title": "Momento Burofax", "content": "Impago reiterado. Seriedad legal inmediata.", "action": "No tiembles al reclamar lo tuyo.", "order": 85 },
        { "categoryId": "comercial", "title": "Puerta de Servicio", "content": "Entrar por cocina/trasera si el local lo pide.", "action": "No molestar a comensales en sala.", "order": 86 },
        { "categoryId": "comercial", "title": "Lista Negra", "content": "Locales insalubres o trato vejatorio a riders.", "action": "Expulsar cliente si da√±a moral o salud.", "order": 87 },
        { "categoryId": "comercial", "title": "Despido de Cliente", "content": "Cliente no rentable o t√≥xico. Fin contrato.", "action": "Mejor perder facturaci√≥n que perder paz.", "order": 88 },
        { "categoryId": "comercial", "title": "Escucha Radical", "content": "Buz√≥n de quejas del cliente. Atender r√°pido.", "action": "Respuesta <2h a incidencias graves.", "order": 89 },
        { "categoryId": "comercial", "title": "Auditor√≠a Envases", "content": "Recomendar mejores envases al cliente.", "action": "Asesorar para evitar manchas mejora tu vida.", "order": 90 },

        // CULTURA (91-102)
        { "categoryId": "cultura", "title": "Rituales de Tribu", "content": "Celebrar victorias. R√©cord de pedidos, aniversario.", "action": "Pizzas gratis para el equipo tras noche r√©cord.", "order": 91 },
        { "categoryId": "cultura", "title": "L√≠der Alfa", "content": "Identificar l√≠der natural del grupo. Gan√°rtelo.", "action": "√ösalo para transmitir valores.", "order": 92 },
        { "categoryId": "cultura", "title": "Ciclo de Feedback", "content": "Preguntar al equipo qu√© falla.", "action": "Reuni√≥n mensual abierta.", "order": 93 },
        { "categoryId": "cultura", "title": "Buen Vecino", "content": "No ruido en calle. Moto parada en esperas.", "action": "Respeto al descanso vecinal.", "order": 94 },
        { "categoryId": "cultura", "title": "Reputaci√≥n Online", "content": "Cuidar imagen en redes y Google Maps base.", "action": "Responder rese√±as, buenas y malas.", "order": 95 },
        { "categoryId": "cultura", "title": "Psicolog√≠a de Grupo", "content": "Evitar corros t√≥xicos de queja est√©ril.", "action": "Fomentar actitud constructiva.", "order": 96 },
        { "categoryId": "cultura", "title": "Salud Mental", "content": "Trabajo solitario y estresante. Empat√≠a.", "action": "Preguntar '¬øQu√© tal est√°s?' sinceramente.", "order": 97 },
        { "categoryId": "cultura", "title": "Gesti√≥n de Rumores", "content": "Transparencia radical ante dudas (sueldos, cambios).", "action": "Cortar bulos con informaci√≥n oficial.", "order": 98 },
        { "categoryId": "cultura", "title": "Descompresi√≥n", "content": "Espacio relax en base. Caf√©, agua.", "action": "Zona descanso digna.", "order": 99 },
        { "categoryId": "cultura", "title": "Efecto Mayordomo", "content": "Entrega a dos manos. Mirada a los ojos.", "action": "Diferenciaci√≥n por calidad humana.", "order": 100 },
        { "categoryId": "cultura", "title": "Efecto Sonrisa", "content": "Aunque lleves casco, la sonrisa se nota en la voz.", "action": "Protocolo de amabilidad telef√≥nica y presencial.", "order": 101 },
        { "categoryId": "cultura", "title": "Embajador de Marca", "content": "Uniforme limpio y bien llevado.", "action": "T√∫ eres la imagen de la empresa en la calle.", "order": 102 },

        // MAESTRIA (103-114)
        { "categoryId": "maestria", "title": "El Legado", "content": "Construir para durar. Procesos > Personas.", "action": "Documenta todo. Manual de Operaciones.", "order": 103 },
        { "categoryId": "maestria", "title": "Kaizen Avanzado", "content": "Mejora 1% diaria. Acumulativo.", "action": "Analiza un peque√±o fallo cada d√≠a y corr√≠gelo.", "order": 104 },
        { "categoryId": "maestria", "title": "Despido de Clientes II", "content": "Reiteraci√≥n. Saber decir NO es estrat√©gico.", "action": "Elimina el 10% de clientes peores anualmente.", "order": 105 },
        { "categoryId": "maestria", "title": "Lecci√≥n Navalmoral II", "content": "Reiteraci√≥n dependencia. Diversificaci√≥n extrema.", "action": "Ning√∫n cliente > 15% facturaci√≥n.", "order": 106 },
        { "categoryId": "maestria", "title": "Escalabilidad", "content": "Procedimientos est√°ndar para abrir nueva zona.", "action": "Crea tu 'Franquicia interna'.", "order": 107 },
        { "categoryId": "maestria", "title": "Factor Autob√∫s", "content": "Si te atropella un bus, ¬øsigue la empresa?", "action": "Delega claves y poderes cr√≠tico.", "order": 108 },
        { "categoryId": "maestria", "title": "Parte de Guerra", "content": "Registro hist√≥rico de incidencias mayores.", "action": "Aprende de errores pasados. No repetir.", "order": 109 },
        { "categoryId": "maestria", "title": "Crisis Viral", "content": "Gesti√≥n redes ante crisis imagen.", "action": "Honestidad y rapidez.", "order": 110 },
        { "categoryId": "maestria", "title": "Ingresos At√≠picos", "content": "Publicidad en cajones, Sampling.", "action": "Busca monetizar activos ociosos.", "order": 111 },
        { "categoryId": "maestria", "title": "Mentalidad de Due√±o", "content": "Inculcar responsabilidad en mandos intermedios.", "action": "Bonus por objetivos de rentabilidad.", "order": 112 },
        { "categoryId": "maestria", "title": "Visi√≥n a 5 A√±os", "content": "No mires solo el cierre de mes.", "action": "Planifica inversiones a largo plazo.", "order": 113 },
        { "categoryId": "maestria", "title": "Cultura de Excelencia", "content": "No tolerar la mediocridad cronificada.", "action": "Exige y da calidad siempre.", "order": 114 },

        // TACTICA (115-126)
        { "categoryId": "tactica", "title": "Mantenimiento Preventivo", "content": "Aceite, ruedas, frenos. Antes de que rompan.", "action": "Calendario revisiones visible en base.", "order": 115 },
        { "categoryId": "tactica", "title": "Brecha de Servicio", "content": "Plan B para ca√≠das de sistema o flota.", "action": "Tener riders de guardia o ETT activable.", "order": 116 },
        { "categoryId": "tactica", "title": "Auditor√≠a Visual", "content": "Estado de motos refleja estado de empresa.", "action": "Limpieza de motos semanal obligatoria.", "order": 117 },
        { "categoryId": "tactica", "title": "Moto Ajena", "content": "Cuidar la moto como propia.", "action": "Sancionar maltrato evidente veh√≠culo.", "order": 118 },
        { "categoryId": "tactica", "title": "Documentaci√≥n", "content": "Papeles en regla siempre en moto/nube.", "action": "Copia digital accesible por QR.", "order": 119 },
        { "categoryId": "tactica", "title": "Energ√≠a", "content": "Cargadores y Powerbanks.", "action": "Estaci√≥n de carga masiva en base.", "order": 120 },
        { "categoryId": "tactica", "title": "Gesti√≥n de Llaves", "content": "Control f√©rreo. P√©rdida = Caos.", "action": "Tablero de llaves con control num√©rico.", "order": 121 },
        { "categoryId": "tactica", "title": "Equipo de Lluvia", "content": "Impermeables de calidad y secado.", "action": "Inversi√≥n en ropa buena ahorra bajas.", "order": 122 },
        { "categoryId": "tactica", "title": "MacGyver II", "content": "Reiteraci√≥n Kit. Formaci√≥n b√°sica mec√°nica.", "action": "Taller 'r√°pido' para cosas simples.", "order": 123 },
        { "categoryId": "tactica", "title": "Ergonom√≠a", "content": "Postura en moto. Salud espalda.", "action": "Charla de fisioterapia/prevenci√≥n anual.", "order": 124 },
        { "categoryId": "tactica", "title": "Estabilizador Roto", "content": "Vibraci√≥n rompe c√°mara m√≥vil.", "action": "Usar soportes antivibraci√≥n (QuadLock).", "order": 125 },
        { "categoryId": "tactica", "title": "Soportes M√≥vil", "content": "Soporte roto = Rider ciego.", "action": "Recambios de soportes en stock siempre.", "order": 126 },

        // CRISIS (127-138)
        { "categoryId": "crisis", "title": "Privacidad RGPD", "content": "Datos clientes sagrados. No guardar tel√©fonos.", "action": "Prohibido contactar por WhatsApp personal.", "order": 127 },
        { "categoryId": "crisis", "title": "Higiene Digital", "content": "Ciberseguridad b√°sica. Claves fuertes.", "action": "2FA en todas las cuentas corporativas.", "order": 128 },
        { "categoryId": "crisis", "title": "C√≥digo Rojo II", "content": "Reiteraci√≥n Protocolo Accidente.", "action": "Simulacro de aviso accidente anual.", "order": 129 },
        { "categoryId": "crisis", "title": "Diplomacia Vial", "content": "Conflictos tr√°fico. No entrar al trapo.", "action": "Evita peleas. Da√±a la marca gravemente.", "order": 130 },
        { "categoryId": "crisis", "title": "Defensa Multas", "content": "Gesti√≥n sanciones. Identificaci√≥n conductor.", "action": "Protocolo √°gil de gesti√≥n multas.", "order": 131 },
        { "categoryId": "crisis", "title": "Redes Mudas", "content": "Discreci√≥n. No publicar tonter√≠as trabajando.", "action": "Pol√≠tica de RRSS corporativa clara.", "order": 132 },
        { "categoryId": "crisis", "title": "Conserjes", "content": "Aliados clave en edificios grandes.", "action": "Trato VIP a porteros y seguridad.", "order": 133 },
        { "categoryId": "crisis", "title": "Foto Testigo", "content": "Prueba de entrega ante reclamaci√≥n.", "action": "Foto obligatoria si se deja en puerta.", "order": 134 },
        { "categoryId": "crisis", "title": "Inspecci√≥n Trabajo", "content": "Protocolo ante visita inspector.", "action": "Documentaci√≥n centralizada y accesible.", "order": 135 },
        { "categoryId": "crisis", "title": "Robo Datos", "content": "Fuga de informaci√≥n. Alerta.", "action": "Bloqueo acceso remoto inmediato.", "order": 136 },
        { "categoryId": "crisis", "title": "Acoso", "content": "Tolerancia cero acoso interno/externo.", "action": "Canal de denuncia an√≥nimo.", "order": 137 },
        { "categoryId": "crisis", "title": "Prensa", "content": "Solicitud medios comunicaci√≥n.", "action": "Derivar siempre a Gerencia. No hablar.", "order": 138 },

        // MICRO-GESTI√ìN (139-150)
        { "categoryId": "micro", "title": "Marketing Guerrilla", "content": "Motos aparcadas = Valla publicitaria.", "action": "Aparcar en fila visible en zonas top.", "order": 139 },
        { "categoryId": "micro", "title": "Carga II", "content": "Reiteraci√≥n Estiba. Detalles.", "action": "Cuidar la presentaci√≥n de la bolsa.", "order": 140 },
        { "categoryId": "micro", "title": "Estr√©s T√©rmico", "content": "Ola de calor o fr√≠o extremo.", "action": "Protocolo avituallamiento agua/caldo.", "order": 141 },
        { "categoryId": "micro", "title": "Bonus Tormenta", "content": "Plus peligrosidad lluvia/nieve.", "action": "Motivaci√≥n extra en d√≠as duros.", "order": 142 },
        { "categoryId": "micro", "title": "Contra-Reembolso", "content": "Gesti√≥n de cash. Arqueo diario.", "action": "L√≠mite m√°ximo efectivo en bolsillo.", "order": 143 },
        { "categoryId": "micro", "title": "Orden 5S", "content": "Orden y limpieza en base operativa.", "action": "Un sitio para cada cosa.", "order": 144 },
        { "categoryId": "micro", "title": "Estacionalidad", "content": "Prever picos y valles anuales.", "action": "Ajustar plantilla a curva anual.", "order": 145 },
        { "categoryId": "micro", "title": "Robo Hormiga", "content": "P√©rdida material peque√±o.", "action": "Inventario material oficina/taller.", "order": 146 },
        { "categoryId": "micro", "title": "Eventos Masivos", "content": "F√∫tbol, Finales, Festivos.", "action": "Refuerzo plantilla preventivo.", "order": 147 },
        { "categoryId": "micro", "title": "Auditor√≠a Gula", "content": "Rider comiendo pedido cliente.", "action": "Despido fulminante. Tolerancia cero.", "order": 148 },
        { "categoryId": "micro", "title": "Marketing Basura", "content": "No tirar flyers al suelo.", "action": "Civismo corporativo.", "order": 149 },
        { "categoryId": "micro", "title": "Palabra Seguridad", "content": "Clave para pedir ayuda por radio discretamente.", "action": "C√≥digo 'Panam√°' o similar.", "order": 150 }
    ],
    "quizzes": [
        // ESTRATEGIA
        { "categoryId": "estrategia", "question": "¬øVolumen m√≠nimo pedidos?", "options": ["300", "500", "700", "1000"], "correctIndex": 2, "order": 1 },
        { "categoryId": "estrategia", "question": "¬øFunci√≥n Zona D?", "options": ["Volumen", "Disuasoria", "Competencia", "Rural"], "correctIndex": 1, "order": 2 },
        { "categoryId": "estrategia", "question": "¬øExpansi√≥n correcta?", "options": ["Salto", "Mancha Aceite", "Aislada", "R√°pida"], "correctIndex": 1, "order": 3 },
        { "categoryId": "estrategia", "question": "¬øVenta principal?", "options": ["Precio", "Seguridad Jur√≠dica", "Rapidez", "Motos"], "correctIndex": 1, "order": 4 },
        { "categoryId": "estrategia", "question": "¬øPack para expertos?", "options": ["Premium", "B√°sico", "Gold", "Free"], "correctIndex": 1, "order": 5 },
        { "categoryId": "estrategia", "question": "¬øRiesgo concentraci√≥n?", "options": ["Navalmoral", "Madrid", "Barcelona", "Sevilla"], "correctIndex": 0, "order": 6 },
        { "categoryId": "estrategia", "question": "¬øZonificaci√≥n?", "options": ["Todo igual", "Inteligente", "Azar", "Radio"], "correctIndex": 1, "order": 7 },
        { "categoryId": "estrategia", "question": "¬øGerente?", "options": ["Todo", "Ops/Ventas", "Solo Ops", "Solo Ventas"], "correctIndex": 1, "order": 8 },

        // FINANZAS
        { "categoryId": "finanzas", "question": "¬øAlerta Roja Saldo?", "options": ["<500", "<1100", "<2000", "<0"], "correctIndex": 1, "order": 1 },
        { "categoryId": "finanzas", "question": "¬øCorte impago d√≠a?", "options": ["1", "6", "15", "30"], "correctIndex": 1, "order": 2 },
        { "categoryId": "finanzas", "question": "¬øFondo Maniobra?", "options": ["Sueldo", "Emergencias", "Bonus", "Muebles"], "correctIndex": 1, "order": 3 },
        { "categoryId": "finanzas", "question": "¬øDisciplina Fiscal?", "options": ["Pagar tarde", "Adelantar 20%", "Evadir", "Ignorar"], "correctIndex": 1, "order": 4 },
        { "categoryId": "finanzas", "question": "¬øRentabilidad/h?", "options": ["1 ped", "2.2-2.5 ped", "4 ped", "1.5 ped"], "correctIndex": 1, "order": 5 },
        { "categoryId": "finanzas", "question": "¬øValle Muerte?", "options": ["Mes 1", "A√±o 1", "Siempre", "Nunca"], "correctIndex": 0, "order": 6 },
        { "categoryId": "finanzas", "question": "¬øBilletes Falsos?", "options": ["Aceptar", "Rotulador", "Ignorar", "Cambiar"], "correctIndex": 1, "order": 7 },
        { "categoryId": "finanzas", "question": "¬øSolvencia?", "options": ["Caja", "Fondo+Deuda", "Ventas", "Cobros"], "correctIndex": 1, "order": 8 },

        // OPERATIVA
        { "categoryId": "operativa", "question": "¬øSustituci√≥n Renting?", "options": ["D√≠a 1", ">10 d√≠as", "Siempre", "Nunca"], "correctIndex": 1, "order": 1 },
        { "categoryId": "operativa", "question": "¬øCoste Flyder?", "options": ["0.10", "0.20", "0.35", "0.50"], "correctIndex": 2, "order": 2 },
        { "categoryId": "operativa", "question": "¬øZona Sombra?", "options": ["Esperar", "Cielo abierto", "Reiniciar", "Llamar"], "correctIndex": 1, "order": 3 },
        { "categoryId": "operativa", "question": "¬øCliente Ausente?", "options": ["3 llamadas", "Irse", "Comer", "Tirar"], "correctIndex": 0, "order": 4 },
        { "categoryId": "operativa", "question": "¬øRevisi√≥n Renting?", "options": ["Cuando falle", "5k/10k", "Anual", "Nunca"], "correctIndex": 1, "order": 5 },
        { "categoryId": "operativa", "question": "¬øMinuto Oro?", "options": ["Esperar 30s", "Irse ya", "Hablar", "Fumar"], "correctIndex": 0, "order": 6 },
        { "categoryId": "operativa", "question": "¬øGasolina Desv√≠o?", "options": ["10%", "20%", "30%", "50%"], "correctIndex": 1, "order": 7 },
        { "categoryId": "operativa", "question": "¬øIngenier√≠a Carga?", "options": ["Todo junto", "Separar/Bloquear", "Suelto", "Mano"], "correctIndex": 1, "order": 8 },

        // RRHH
        { "categoryId": "rrhh", "question": "¬øEdad ideal?", "options": ["18-22", "24-40", "45-60", "Cualquiera"], "correctIndex": 1, "order": 1 },
        { "categoryId": "rrhh", "question": "¬øHoras Comp.?", "options": ["Ilegal", "Picos", "Siempre", "Nunca"], "correctIndex": 1, "order": 2 },
        { "categoryId": "rrhh", "question": "¬øLiderazgo Novato?", "options": ["Delegativo", "Directivo", "Libre", "Amigo"], "correctIndex": 1, "order": 3 },
        { "categoryId": "rrhh", "question": "¬øInventario?", "options": ["Empresa", "Trabajador", "Seguro", "Nadie"], "correctIndex": 1, "order": 4 },
        { "categoryId": "rrhh", "question": "¬øSalida?", "options": ["Adi√≥s", "Checklist", "Pagar", "Nada"], "correctIndex": 1, "order": 5 },
        { "categoryId": "rrhh", "question": "¬øPropinas?", "options": ["Empresa", "Rider", "Bote", "Restaurante"], "correctIndex": 1, "order": 6 },
        { "categoryId": "rrhh", "question": "¬øReciclaje?", "options": ["Nunca", "Semestral", "Anual", "Mensual"], "correctIndex": 1, "order": 7 },
        { "categoryId": "rrhh", "question": "¬øPlan Carrera?", "options": ["No hay", "Si", "Solo salario", "Solo horas"], "correctIndex": 1, "order": 8 },

        // SEGURIDAD
        { "categoryId": "seguridad", "question": "¬øViento >40kmh?", "options": ["Correr", "Centro/Lento", "Arc√©n", "Parar"], "correctIndex": 1, "order": 1 },
        { "categoryId": "seguridad", "question": "¬øVisera Sucia?", "options": ["Da igual", "Ceguera", "Limpia solo d√≠a", "Cambiar"], "correctIndex": 1, "order": 2 },
        { "categoryId": "seguridad", "question": "¬øPAS?", "options": ["Correr", "Proteger Avisar Socorrer", "Llorar", "Mirar"], "correctIndex": 1, "order": 3 },
        { "categoryId": "seguridad", "question": "¬øAtraco?", "options": ["Pelear", "Entregar", "Huir", "Gritar"], "correctIndex": 1, "order": 4 },
        { "categoryId": "seguridad", "question": "¬øLuces?", "options": ["Opcional", "Ver y ser visto", "Solo noche", "Apagadas"], "correctIndex": 1, "order": 5 },
        { "categoryId": "seguridad", "question": "¬øM√≥vil?", "options": ["Marcha", "Parado", "Semaforo", "Nunca"], "correctIndex": 1, "order": 6 },
        { "categoryId": "seguridad", "question": "¬øKit MacGyver?", "options": ["Nada", "Bridas/Cinta", "Motor", "Rueda"], "correctIndex": 1, "order": 7 },
        { "categoryId": "seguridad", "question": "¬øZonas Rojas?", "options": ["Entrar", "Prohibidas", "R√°pido", "Armado"], "correctIndex": 1, "order": 8 },

        // EFICIENCIA
        { "categoryId": "eficiencia", "question": "¬øRegreso Base?", "options": ["Siempre", "Espera Activa", "A casa", "Lento"], "correctIndex": 1, "order": 1 },
        { "categoryId": "eficiencia", "question": "¬øPisos Bajos?", "options": ["Ascensor", "Escaleras", "Portal", "Llamar"], "correctIndex": 1, "order": 2 },
        { "categoryId": "eficiencia", "question": "¬øGuantes?", "options": ["Quitar", "T√°ctiles", "Sin", "Mitones"], "correctIndex": 1, "order": 3 },
        { "categoryId": "eficiencia", "question": "¬øTurnos?", "options": ["Fijos", "Escalonados", "Libres", "Todos"], "correctIndex": 1, "order": 4 },
        { "categoryId": "eficiencia", "question": "¬øConducci√≥n?", "options": ["Sport", "Eficiente", "Lenta", "R√°pida"], "correctIndex": 1, "order": 5 },
        { "categoryId": "eficiencia", "question": "¬øVac√≠o?", "options": ["Volver", "Triangular", "Parar", "Casa"], "correctIndex": 1, "order": 6 },
        { "categoryId": "eficiencia", "question": "¬øObras?", "options": ["GPS", "Mapa Base", "Preguntar", "Mirar"], "correctIndex": 1, "order": 7 },
        { "categoryId": "eficiencia", "question": "¬øModo Oscuro?", "options": ["Feo", "Ahorro/Fatiga", "D√≠a", "Noche"], "correctIndex": 1, "order": 8 },

        // COMERCIAL
        { "categoryId": "comercial", "question": "¬øVenta?", "options": ["Precio", "Paz Mental", "Motos", "Apps"], "correctIndex": 1, "order": 1 },
        { "categoryId": "comercial", "question": "¬øVecinos?", "options": ["Ignorar", "Visitar", "Molestar", "Competencia"], "correctIndex": 1, "order": 2 },
        { "categoryId": "comercial", "question": "¬øDiplomacia?", "options": ["Serio", "Amable/Casco", "R√°pido", "Seco"], "correctIndex": 1, "order": 3 },
        { "categoryId": "comercial", "question": "¬øActivaci√≥n?", "options": ["Sola", "Supervisada", "Remota", "Lenta"], "correctIndex": 1, "order": 4 },
        { "categoryId": "comercial", "question": "¬øMistery?", "options": ["Comer", "Auditar", "Robar", "Copiar"], "correctIndex": 1, "order": 5 },
        { "categoryId": "comercial", "question": "¬øCancelaci√≥n?", "options": ["Llevar", "No hacer", "Cobrar", "Regalar"], "correctIndex": 1, "order": 6 },
        { "categoryId": "comercial", "question": "¬øEmbajador?", "options": ["Nadie", "Recomendaci√≥n", "Comercial", "Jefe"], "correctIndex": 1, "order": 7 },
        { "categoryId": "comercial", "question": "¬øImpago 15?", "options": ["Esperar", "Burofax", "Perdonar", "Olvidar"], "correctIndex": 1, "order": 8 },

        // CULTURA
        { "categoryId": "cultura", "question": "¬øRitual?", "options": ["Nada", "Briefing", "Fiesta", "Rezar"], "correctIndex": 1, "order": 1 },
        { "categoryId": "cultura", "question": "¬øL√≠der Alfa?", "options": ["Echar", "Aliado", "Ignorar", "Jefe"], "correctIndex": 1, "order": 2 },
        { "categoryId": "cultura", "question": "¬øRuido?", "options": ["Si", "No/Civismo", "Motos", "Gritos"], "correctIndex": 1, "order": 3 },
        { "categoryId": "cultura", "question": "¬øFeedback?", "options": ["Nunca", "Ciclico", "Buzon", "Queja"], "correctIndex": 1, "order": 4 },
        { "categoryId": "cultura", "question": "¬øReviews?", "options": ["Pasar", "Cuidar", "Borrar", "Comprar"], "correctIndex": 1, "order": 5 },
        { "categoryId": "cultura", "question": "¬øSoledad?", "options": ["Aguantar", "Empat√≠a", "Ignorar", "Normal"], "correctIndex": 1, "order": 6 },
        { "categoryId": "cultura", "question": "¬øRumores?", "options": ["Fomentar", "Cortar", "Creer", "Escuchar"], "correctIndex": 1, "order": 7 },
        { "categoryId": "cultura", "question": "¬øSonrisa?", "options": ["No", "Telef√≥nica", "Falsa", "Rara"], "correctIndex": 1, "order": 8 },

        // MAESTRIA
        { "categoryId": "maestria", "question": "¬øLegado?", "options": ["Vender", "Sistematizar", "Cerrar", "Hijos"], "correctIndex": 1, "order": 1 },
        { "categoryId": "maestria", "question": "¬øKaizen?", "options": ["100%", "1%", "0%", "10%"], "correctIndex": 1, "order": 2 },
        { "categoryId": "maestria", "question": "¬øClientes Malos?", "options": ["Quedar", "Despedir", "Cobrar m√°s", "Sufrir"], "correctIndex": 1, "order": 3 },
        { "categoryId": "maestria", "question": "¬øDependencia?", "options": ["50%", "15%", "30%", "100%"], "correctIndex": 1, "order": 4 },
        { "categoryId": "maestria", "question": "¬øEscalar?", "options": ["Caos", "Procesos", "Dinero", "Gente"], "correctIndex": 1, "order": 5 },
        { "categoryId": "maestria", "question": "¬øAutob√∫s?", "options": ["Morir", "Sobrevivir", "Cerrar", "Vender"], "correctIndex": 1, "order": 6 },
        { "categoryId": "maestria", "question": "¬øCrisis?", "options": ["Mentir", "Honestidad", "Callar", "Borrar"], "correctIndex": 1, "order": 7 },
        { "categoryId": "maestria", "question": "¬øDue√±o?", "options": ["Mandar", "Ejemplo", "Viajar", "Cobrar"], "correctIndex": 1, "order": 8 },

        // TACTICA
        { "categoryId": "tactica", "question": "¬øMantenimiento?", "options": ["Rotura", "Preventivo", "Nunca", "Barato"], "correctIndex": 1, "order": 1 },
        { "categoryId": "tactica", "question": "¬øBrecha?", "options": ["Cerrar", "Plan B", "Rezar", "Llorar"], "correctIndex": 1, "order": 2 },
        { "categoryId": "tactica", "question": "¬øImagen?", "options": ["Sucia", "Limpia", "Rota", "Vieja"], "correctIndex": 1, "order": 3 },
        { "categoryId": "tactica", "question": "¬øMoto Ajena?", "options": ["Maltrato", "Cuidado", "Gastar", "Romper"], "correctIndex": 1, "order": 4 },
        { "categoryId": "tactica", "question": "¬øPapeles?", "options": ["Base", "Nube/QR", "Nada", "Gestor"], "correctIndex": 1, "order": 5 },
        { "categoryId": "tactica", "question": "¬øEnerg√≠a?", "options": ["Sin", "Powerbank", "Enchufe", "Cables"], "correctIndex": 1, "order": 6 },
        { "categoryId": "tactica", "question": "¬øLlaves?", "options": ["Perder", "Control", "Llevar", "Esconder"], "correctIndex": 1, "order": 7 },
        { "categoryId": "tactica", "question": "¬øLluvia?", "options": ["Mojado", "Seco/Equipo", "Casa", "Bolsa"], "correctIndex": 1, "order": 8 },

        // CRISIS
        { "categoryId": "crisis", "question": "¬øRGPD?", "options": ["Guardar", "Borrar", "Vender", "Usar"], "correctIndex": 1, "order": 1 },
        { "categoryId": "crisis", "question": "¬øClaves?", "options": ["1234", "Fuertes/2FA", "Postit", "Compartir"], "correctIndex": 1, "order": 2 },
        { "categoryId": "crisis", "question": "¬øTr√°fico?", "options": ["Pelear", "Calma", "Pitar", "Bajar"], "correctIndex": 1, "order": 3 },
        { "categoryId": "crisis", "question": "¬øMultas?", "options": ["Tirar", "Gestionar", "Pagar", "Romper"], "correctIndex": 1, "order": 4 },
        { "categoryId": "crisis", "question": "¬øRedes?", "options": ["Todo", "Discreci√≥n", "Fotos", "Videos"], "correctIndex": 1, "order": 5 },
        { "categoryId": "crisis", "question": "¬øConserjes?", "options": ["Nada", "VIP", "Ignorar", "Molestar"], "correctIndex": 1, "order": 6 },
        { "categoryId": "crisis", "question": "¬øAcoso?", "options": ["Permitir", "Zero", "Ocultar", "Reir"], "correctIndex": 1, "order": 7 },
        { "categoryId": "crisis", "question": "¬øPrensa?", "options": ["Hablar", "Gerencia", "Opinar", "Foto"], "correctIndex": 1, "order": 8 },

        // MICRO
        { "categoryId": "micro", "question": "¬øGuerrilla?", "options": ["Flyer", "Aparcar", "Gritar", "Spam"], "correctIndex": 1, "order": 1 },
        { "categoryId": "micro", "question": "¬øEstiba?", "options": ["Mal", "Bien", "Rapido", "Tirar"], "correctIndex": 1, "order": 2 },
        { "categoryId": "micro", "question": "¬øClima?", "options": ["Nada", "Agua/Abrigo", "Irse", "Queja"], "correctIndex": 1, "order": 3 },
        { "categoryId": "micro", "question": "¬øBonus?", "options": ["No", "Tormenta", "Sol", "Lunes"], "correctIndex": 1, "order": 4 },
        { "categoryId": "micro", "question": "¬øCash?", "options": ["Bolsillo", "Arqueo", "Casa", "Gastar"], "correctIndex": 1, "order": 5 },
        { "categoryId": "micro", "question": "¬ø5S?", "options": ["Sucio", "Orden", "Lleno", "Vacio"], "correctIndex": 1, "order": 6 },
        { "categoryId": "micro", "question": "¬øGula?", "options": ["Comer", "Despido", "Multa", "Nada"], "correctIndex": 1, "order": 7 },
        { "categoryId": "micro", "question": "¬øSeguridad?", "options": ["Grito", "Clave", "Radio", "Nada"], "correctIndex": 1, "order": 8 }
    ]
};



================================================================================
FILE: public\seed-encyclopedia.html
================================================================================
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encyclopedia Seeder - COMPLETO</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 700px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #718096;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .status {
            background: #f7fafc;
            border-left: 4px solid #4299e1;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-size: 14px;
        }

        .progress {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .log {
            background: #2d3748;
            color: #a0aec0;
            padding: 20px;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
            line-height: 1.6;
        }

        .log-success {
            color: #48bb78;
        }

        .log-error {
            color: #f56565;
        }

        .log-info {
            color: #4299e1;
        }

        .log-warning {
            color: #ed8936;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: #f7fafc;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: #718096;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #2d3748;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üå± Encyclopedia Seeder COMPLETO</h1>
        <p class="subtitle">Carga TOTAL de 12 categor√≠as, 150 m√≥dulos y 96 quizzes</p>

        <div class="status" id="status">
            ‚è≥ Esperando autenticaci√≥n...
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-label">Categor√≠as</div>
                <div class="stat-value" id="catCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">M√≥dulos</div>
                <div class="stat-value" id="modCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Quizzes</div>
                <div class="stat-value" id="quizCount">0</div>
            </div>
        </div>

        <div class="progress">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <button id="seedBtn" onclick="initializeSeed()" disabled>üöÄ Inicializar Encyclopedia COMPLETA</button>

        <div class="log" id="log"></div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, doc, writeBatch, getDocs, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyC0vTiufm9bWbzXzWwqy2sEuIZLNxYiVdg",
            authDomain: "repaartfinanzas.firebaseapp.com",
            projectId: "repaartfinanzas",
            storageBucket: "repaartfinanzas.firebasestorage.app",
            messagingSenderId: "651763835836",
            appId: "1:651763835836:web:1e3fca83a49bf65fef95be"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let isAuthenticated = false;
        let userEmail = '';

        // Check authentication status
        onAuthStateChanged(auth, (user) => {
            if (user) {
                isAuthenticated = true;
                userEmail = user.email;
                updateStatus(`‚úÖ Autenticado como: ${user.email}`);
                log(`‚úì Usuario autenticado: ${user.email}`, 'success');
                document.getElementById('seedBtn').disabled = false;
            } else {
                isAuthenticated = false;
                updateStatus('‚ö†Ô∏è Debes iniciar sesi√≥n primero en la app principal');
                log('Abre https://repaartfinanzas.web.app en otra pesta√±a e inicia sesi√≥n', 'warning');
                log('Luego recarga esta p√°gina', 'info');
                document.getElementById('seedBtn').disabled = true;
            }
        });

        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const className = `log-${type}`;
            logEl.innerHTML += `<div class="${className}">[${new Date().toLocaleTimeString()}] ${message}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function updateProgress(percent) {
            document.getElementById('progressBar').style.width = percent + '%';
        }

        function updateStatus(text) {
            document.getElementById('status').textContent = text;
        }

        window.initializeSeed = async function () {
            if (!isAuthenticated) {
                log('‚ùå Debes iniciar sesi√≥n primero', 'error');
                return;
            }

            const btn = document.getElementById('seedBtn');
            btn.disabled = true;
            updateStatus('üîÑ Cargando datos desde seed...');
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
            log('Iniciando proceso de seeding COMPLETO...', 'info');
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');

            try {
                // Load seed data
                const response = await fetch('/encyclopediaSeed.js');
                const seedText = await response.text();

                // Extract data using regex
                const dataMatch = seedText.match(/export const ENCYCLOPEDIA_SEED_DATA = ({[\s\S]*});/);
                if (!dataMatch) throw new Error('No se pudo parsear encyclopediaSeed.js');

                const SEED_DATA = eval('(' + dataMatch[1] + ')');

                log(`‚úì Seed cargado exitosamente:`, 'success');
                log(`  - ${SEED_DATA.categories.length} categor√≠as`, 'info');
                log(`  - ${SEED_DATA.modules.length} m√≥dulos`, 'info');
                log(`  - ${SEED_DATA.quizzes.length} quizzes`, 'info');

                // 1. CATEGOR√çAS
                updateStatus('üì¶ Sincronizando categor√≠as...');
                updateProgress(5);
                log('', 'info');
                log('1Ô∏è‚É£ Cargando CATEGOR√çAS...', 'info');

                const catBatch = writeBatch(db);
                SEED_DATA.categories.forEach(cat => {
                    const ref = doc(db, 'encyclopedia_categories', cat.id);
                    catBatch.set(ref, { ...cat, updatedAt: new Date() }, { merge: true });
                });
                await catBatch.commit();

                document.getElementById('catCount').textContent = SEED_DATA.categories.length;
                log(`‚úì ${SEED_DATA.categories.length} categor√≠as sincronizadas`, 'success');
                updateProgress(15);

                // 2. M√ìDULOS
                updateStatus('üìö Cargando m√≥dulos...');
                log('', 'info');
                log('2Ô∏è‚É£ Cargando M√ìDULOS (puede tardar)...', 'info');

                const chunkSize = 450;
                const moduleChunks = [];
                for (let i = 0; i < SEED_DATA.modules.length; i += chunkSize) {
                    moduleChunks.push(SEED_DATA.modules.slice(i, i + chunkSize));
                }

                for (let i = 0; i < moduleChunks.length; i++) {
                    const batch = writeBatch(db);
                    moduleChunks[i].forEach(mod => {
                        const ref = doc(collection(db, 'encyclopedia_modules'));
                        batch.set(ref, { ...mod, createdAt: new Date() });
                    });
                    await batch.commit();
                    log(`  ‚úì Chunk ${i + 1}/${moduleChunks.length} completado (${moduleChunks[i].length} m√≥dulos)`, 'success');
                    updateProgress(15 + (35 * (i + 1) / moduleChunks.length));
                }

                document.getElementById('modCount').textContent = SEED_DATA.modules.length;
                log(`‚úì TOTAL: ${SEED_DATA.modules.length} m√≥dulos cargados`, 'success');
                updateProgress(50);

                // 3. QUIZZES (CR√çTICO - LIMPIEZA PREVIA)
                updateStatus('üéØ Preparando quizzes...');
                log('', 'info');
                log('3Ô∏è‚É£ Preparando QUIZZES...', 'info');

                // Verificar y limpiar quizzes antiguos
                const existingQuizzes = await getDocs(collection(db, 'encyclopedia_quizzes'));
                log(`  ‚ÑπÔ∏è  Quizzes existentes: ${existingQuizzes.size}`, 'info');

                if (existingQuizzes.size > 0) {
                    log(`  üóëÔ∏è  Limpiando ${existingQuizzes.size} quizzes antiguos...`, 'warning');
                    updateStatus('üóëÔ∏è Limpiando quizzes antiguos...');

                    // Limpiar en chunks para evitar l√≠mites
                    const deleteChunks = [];
                    let currentChunk = [];

                    existingQuizzes.docs.forEach(doc => {
                        currentChunk.push(doc);
                        if (currentChunk.length === 450) {
                            deleteChunks.push([...currentChunk]);
                            currentChunk = [];
                        }
                    });
                    if (currentChunk.length > 0) {
                        deleteChunks.push(currentChunk);
                    }

                    for (let i = 0; i < deleteChunks.length; i++) {
                        const deleteBatch = writeBatch(db);
                        deleteChunks[i].forEach(doc => {
                            deleteBatch.delete(doc.ref);
                        });
                        await deleteBatch.commit();
                        log(`    ‚úì Limpieza chunk ${i + 1}/${deleteChunks.length}`, 'warning');
                    }

                    log(`  ‚úì Limpieza completada`, 'success');
                }

                updateProgress(55);

                // Cargar nuevos quizzes
                updateStatus('üéØ Cargando quizzes NUEVOS...');
                log(`  üìù Cargando ${SEED_DATA.quizzes.length} quizzes...`, 'info');

                const quizChunks = [];
                for (let i = 0; i < SEED_DATA.quizzes.length; i += chunkSize) {
                    quizChunks.push(SEED_DATA.quizzes.slice(i, i + chunkSize));
                }

                for (let i = 0; i < quizChunks.length; i++) {
                    const batch = writeBatch(db);
                    quizChunks[i].forEach(quiz => {
                        const ref = doc(collection(db, 'encyclopedia_quizzes'));
                        batch.set(ref, { ...quiz, createdAt: new Date() });
                    });
                    await batch.commit();
                    log(`  ‚úì Chunk ${i + 1}/${quizChunks.length} completado (${quizChunks[i].length} quizzes)`, 'success');
                    updateProgress(55 + (40 * (i + 1) / quizChunks.length));
                }

                document.getElementById('quizCount').textContent = SEED_DATA.quizzes.length;
                log(`‚úì TOTAL: ${SEED_DATA.quizzes.length} quizzes cargados`, 'success');
                updateProgress(95);

                // VERIFICACI√ìN FINAL
                updateStatus('üîç Verificando integridad...');
                log('', 'info');
                log('4Ô∏è‚É£ VERIFICACI√ìN FINAL...', 'info');

                const finalCats = await getDocs(collection(db, 'encyclopedia_categories'));
                const finalMods = await getDocs(collection(db, 'encyclopedia_modules'));
                const finalQuiz = await getDocs(collection(db, 'encyclopedia_quizzes'));

                log(`  Categor√≠as: ${finalCats.size} / ${SEED_DATA.categories.length}`, 'info');
                log(`  M√≥dulos: ${finalMods.size} / ${SEED_DATA.modules.length}`, 'info');
                log(`  Quizzes: ${finalQuiz.size} / ${SEED_DATA.quizzes.length}`, 'info');

                updateProgress(100);

                if (finalQuiz.size === SEED_DATA.quizzes.length) {
                    updateStatus('‚úÖ ¬°CARGA COMPLETADA AL 100%!');
                    log('', 'success');
                    log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'success');
                    log('üéâ ¬°ENCYCLOPEDIA COMPLETAMENTE CARGADA!', 'success');
                    log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'success');
                    log('', 'info');
                    log('‚úÖ Puedes cerrar esta ventana', 'info');
                    log('‚úÖ Recarga la app principal para ver los cambios', 'info');
                } else {
                    throw new Error(`Solo se cargaron ${finalQuiz.size} de ${SEED_DATA.quizzes.length} quizzes`);
                }

            } catch (error) {
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'error');
                log('‚ùå ERROR: ' + error.message, 'error');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'error');
                updateStatus('‚ùå Error en la carga');
                console.error(error);
            } finally {
                btn.disabled = false;
            }
        };
    </script>
</body>

</html>


================================================================================
FILE: public\sw.js
================================================================================
// KAMIKAZE SERVICE WORKER
// Forces immediate removal of itself and reloads the page to clear the cache.

self.addEventListener('install', () => {
    // Take over immediately
    self.skipWaiting();
});

self.addEventListener('activate', (e) => {
    // Unregister this SW immediately
    e.waitUntil(
        self.registration.unregister().then(() => {
            return self.clients.matchAll();
        }).then((clients) => {
            // Force all open tabs to reload to get the new network content
            clients.forEach((client) => client.navigate(client.url));
        })
    );
});



================================================================================
FILE: scripts\cleanupDuplicates.js
================================================================================
/**
 * EMERGENCY CLEANUP - Remove duplicate Encyclopedia modules
 * 
 * WARNING: This will DELETE documents from Firestore
 * Run ONLY if you have confirmed duplicates exist
 * 
 * Strategy: Keep the OLDEST document for each unique title
 */

import { initializeApp } from 'firebase/app';
import { getFirestore, collection, getDocs, deleteDoc, doc, query, orderBy } from 'firebase/firestore';

// Firebase config (same as your app)
const firebaseConfig = {
    apiKey: "AIzaSyDGU0IjPPFe8Mz0MjbwK9E6EWZfEW7fVD8",
    authDomain: "repaartfinanzas.firebaseapp.com",
    projectId: "repaartfinanzas",
    storageBucket: "repaartfinanzas.firebasestorage.app",
    messagingSenderId: "893626733062",
    appId: "1:893626733062:web:6b4d45e43cbeef77ec2856",
    measurementId: "G-6F4G1EE925"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const COLORS = {
    RED: '\x1b[31m',
    GREEN: '\x1b[32m',
    YELLOW: '\x1b[33m',
    RESET: '\x1b[0m',
    BOLD: '\x1b[1m'
};

async function cleanupDuplicates() {
    console.log(`\n${COLORS.BOLD}üßπ STARTING CLEANUP PROCESS${COLORS.RESET}\n`);

    try {
        // Fetch all modules
        const modulesRef = collection(db, 'encyclopedia_modules');
        const modulesQuery = query(modulesRef, orderBy('createdAt', 'asc')); // Oldest first
        const snapshot = await getDocs(modulesQuery);

        const modules = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
        }));

        console.log(`üìä Total modules found: ${modules.length}`);
        console.log(`Expected: 150\n`);

        // Group by title
        const titleMap = new Map();
        const toDelete = [];

        modules.forEach(mod => {
            const title = mod.title;

            if (!titleMap.has(title)) {
                // First occurrence - KEEP IT
                titleMap.set(title, mod);
            } else {
                // Duplicate - MARK FOR DELETION
                toDelete.push(mod.id);
                console.log(`${COLORS.YELLOW}üóëÔ∏è  Duplicate: "${title}" (ID: ${mod.id})${COLORS.RESET}`);
            }
        });

        console.log(`\n${COLORS.BOLD}SUMMARY:${COLORS.RESET}`);
        console.log(`Unique modules: ${titleMap.size}`);
        console.log(`Duplicates to delete: ${toDelete.length}\n`);

        if (toDelete.length === 0) {
            console.log(`${COLORS.GREEN}‚úÖ No duplicates found! Database is clean.${COLORS.RESET}\n`);
            return;
        }

        // Confirmation
        console.log(`${COLORS.RED}${COLORS.BOLD}‚ö†Ô∏è  WARNING: About to DELETE ${toDelete.length} documents!${COLORS.RESET}`);
        console.log(`${COLORS.YELLOW}Press Ctrl+C NOW to cancel, or wait 5 seconds to proceed...${COLORS.RESET}\n`);

        await new Promise(resolve => setTimeout(resolve, 5000));

        // Delete duplicates
        let deleted = 0;
        for (const id of toDelete) {
            try {
                await deleteDoc(doc(db, 'encyclopedia_modules', id));
                deleted++;
                if (deleted % 10 === 0) {
                    console.log(`Deleted ${deleted}/${toDelete.length}...`);
                }
            } catch (error) {
                console.error(`${COLORS.RED}Error deleting ${id}:${COLORS.RESET}`, error.message);
            }
        }

        console.log(`\n${COLORS.GREEN}${COLORS.BOLD}‚úÖ CLEANUP COMPLETE!${COLORS.RESET}`);
        console.log(`${COLORS.GREEN}Deleted ${deleted} duplicate modules${COLORS.RESET}`);
        console.log(`${COLORS.GREEN}Remaining: ${modules.length - deleted} modules${COLORS.RESET}\n`);

    } catch (error) {
        console.error(`${COLORS.RED}Fatal error:${COLORS.RESET}`, error);
    }
}

cleanupDuplicates().then(() => {
    console.log('Script finished. Exiting...\n');
    process.exit(0);
}).catch(err => {
    console.error('Unhandled error:', err);
    process.exit(1);
});



================================================================================
FILE: scripts\diagnoseEncyclopedia.js
================================================================================
/**
 * SCRIPT DE DIAGN√ìSTICO - Encyclopedia Data Integrity
 * Identifica duplicados y problemas en Firestore
 */

import { db } from '../src/lib/firebase.js';
import { collection, getDocs, query, orderBy } from 'firebase/firestore';

const COLORS = {
    RED: '\x1b[31m',
    GREEN: '\x1b[32m',
    YELLOW: '\x1b[33m',
    BLUE: '\x1b[36m',
    RESET: '\x1b[0m',
    BOLD: '\x1b[1m'
};

console.log('\nüîç DIAGNOSING ENCYCLOPEDIA DATA...\n');

async function diagnose() {
    try {
        // Fetch all modules
        const modulesRef = collection(db, 'encyclopedia_modules');
        const modulesQuery = query(modulesRef, orderBy('order', 'asc'));
        const modulesSnapshot = await getDocs(modulesQuery);

        const modules = modulesSnapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
        }));

        console.log(`${COLORS.BLUE}üìä Total modules in Firestore: ${modules.length}${COLORS.RESET}`);
        console.log(`${COLORS.YELLOW}‚ö†Ô∏è  Expected: 150${COLORS.RESET}\n`);

        // Check for duplicates by title
        const titleMap = new Map();
        const duplicates = [];

        modules.forEach(mod => {
            const title = mod.title;
            if (titleMap.has(title)) {
                duplicates.push({
                    title,
                    ids: [...titleMap.get(title), mod.id]
                });
                titleMap.set(title, [...titleMap.get(title), mod.id]);
            } else {
                titleMap.set(title, [mod.id]);
            }
        });

        if (duplicates.length > 0) {
            console.log(`${COLORS.RED}‚ùå FOUND ${duplicates.length} DUPLICATE TITLES:${COLORS.RESET}\n`);
            duplicates.slice(0, 10).forEach((dup, index) => {
                console.log(`${index + 1}. "${dup.title}"`);
                console.log(`   IDs: ${dup.ids.join(', ')}\n`);
            });

            if (duplicates.length > 10) {
                console.log(`   ... and ${duplicates.length - 10} more duplicates\n`);
            }
        } else {
            console.log(`${COLORS.GREEN}‚úÖ No duplicate titles found${COLORS.RESET}\n`);
        }

        // Check for missing required fields
        console.log(`${COLORS.BLUE}üîç Checking for modules with missing data...${COLORS.RESET}\n`);

        const problematicModules = modules.filter(mod =>
            !mod.title || !mod.content || !mod.action || !mod.categoryId
        );

        if (problematicModules.length > 0) {
            console.log(`${COLORS.RED}‚ùå FOUND ${problematicModules.length} MODULES WITH MISSING DATA:${COLORS.RESET}\n`);
            problematicModules.slice(0, 5).forEach((mod, index) => {
                console.log(`${index + 1}. ID: ${mod.id}`);
                console.log(`   Title: ${mod.title || 'MISSING'}`);
                console.log(`   Has content: ${!!mod.content}`);
                console.log(`   Has action: ${!!mod.action}`);
                console.log(`   CategoryId: ${mod.categoryId || 'MISSING'}\n`);
            });
        } else {
            console.log(`${COLORS.GREEN}‚úÖ All modules have required fields${COLORS.RESET}\n`);
        }

        // Summary
        console.log(`${COLORS.BOLD}${COLORS.BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${COLORS.RESET}`);
        console.log(`${COLORS.BOLD}SUMMARY:${COLORS.RESET}`);
        console.log(`Total modules: ${modules.length} (expected: 150)`);
        console.log(`Duplicates found: ${duplicates.length}`);
        console.log(`Modules with missing data: ${problematicModules.length}`);
        console.log(`${COLORS.BOLD}${COLORS.BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${COLORS.RESET}\n`);

        // Export duplicate IDs for cleanup
        if (duplicates.length > 0) {
            const idsToDelete = [];
            duplicates.forEach(dup => {
                // Keep the first one, delete the rest
                idsToDelete.push(...dup.ids.slice(1));
            });

            console.log(`${COLORS.YELLOW}üí° To clean up, delete these ${idsToDelete.length} duplicate document IDs:${COLORS.RESET}`);
            console.log(JSON.stringify(idsToDelete, null, 2));
        }

    } catch (error) {
        console.error(`${COLORS.RED}Error during diagnosis:${COLORS.RESET}`, error);
    }
}

diagnose().then(() => {
    console.log('\n‚úÖ Diagnosis complete\n');
    process.exit(0);
}).catch(err => {
    console.error('Fatal error:', err);
    process.exit(1);
});



================================================================================
FILE: scripts\seedAcademy.js
================================================================================
/**
 * Script para poblar la academia con un m√≥dulo de ejemplo
 * Ejecutar: node scripts/seedAcademy.js
 */

import { initializeApp } from 'firebase/app';
import { getFirestore, collection, addDoc, setDoc, doc } from 'firebase/firestore';

// Configuraci√≥n de Firebase - COPIAR de src/lib/firebase.js
const firebaseConfig = {
    apiKey: "AIzaSyAglwWTTZf0u2Br3Lq3n9bMKU0w5DzuHgg",
    authDomain: "repaart-central.firebaseapp.com",
    projectId: "repaart-central",
    storageBucket: "repaart-central.firebasestorage.app",
    messagingSenderId: "267654177888",
    appId: "1:267654177888:web:c5c67cc8bc8be2bf30d28d"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// M√≥dulo de ejemplo: Introducci√≥n a Repaart
const exampleModule = {
    order: 1,
    title: "Introducci√≥n a Repaart",
    description: "Fundamentos del modelo de negocio y conceptos clave para gestionar tu franquicia con √©xito",
    duration: "45 min",
    published: true,
    lessonCount: 3,
    createdAt: new Date().toISOString()
};

// Lecciones del m√≥dulo
const exampleLessons = [
    {
        order: 1,
        title: "El Modelo de Franquicia Repaart",
        content: `# El Modelo de Franquicia Repaart

## üéØ Misi√≥n y Visi√≥n

Repaart no es una simple ETT de repartidores. Somos una **Operadora Log√≠stica Descentralizada** que transforma a emprendedores y riders en Directores de Flota Local.

### Nuestra Propuesta de Valor

El ecosistema del Food Delivery tradicional presenta varios problemas:
- **Erosi√≥n de m√°rgenes** para restaurantes (comisiones del 25-30%)
- **Precarizaci√≥n** del servicio de reparto
- **Falta de control** para los restaurantes

**Repaart ofrece la soluci√≥n:**

1. ‚úÖ **Coste predecible**: Tarifa plana por entrega
2. ‚úÖ **Control total**: Gesti√≥n directa de tu flota
3. ‚úÖ **Alta fiabilidad**: Servicio profesional garantizado
4. ‚úÖ **Imagen profesional**: Uniformes y motos branded

## üí∞ Modelo de Negocio

### Packs de Contrataci√≥n

| Pack | Inversi√≥n | Royalty | Incluye |
|------|-----------|---------|---------|
| **B√ÅSICO** | 1.500‚Ç¨ | 1% | Licencia, Manuales, Flyder, Yamimoto, Formaci√≥n |
| **PREMIUM** | 3.000‚Ç¨ | 3% | Todo lo anterior + Mentoring Quincenal |

### Servicios a la Carta

- üíº **Consultor√≠a**: 50‚Ç¨/hora
- üìä **Pack Financiero**: 100‚Ç¨/mes
- üéì **Formaci√≥n avanzada**: Bajo demanda

## üìà Rentabilidad Esperada

### Fase Despegue (700 pedidos/mes)
- **Ingresos brutos**: ~4.200‚Ç¨
- **Gastos operativos**: ~3.200‚Ç¨
- **Beneficio neto**: **~1.000‚Ç¨**

### Fase Rentabilidad (1.500 pedidos/mes)
- **Ingresos brutos**: ~9.000‚Ç¨
- **Gastos operativos**: ~7.200‚Ç¨
- **Beneficio neto**: **~1.800‚Ç¨**

> üí° **Clave del √©xito**: La rentabilidad depende de tu gesti√≥n diaria. "Te damos el coche, pero t√∫ conduces".

## üöÄ Pr√≥ximos Pasos

En las siguientes lecciones aprender√°s:
1. C√≥mo funciona la operativa diaria
2. Estrategias de captaci√≥n B2B
3. Gesti√≥n de tu equipo de riders

¬°Vamos a comenzar tu camino hacia la excelencia operativa!
`,
        resources: []
    },
    {
        order: 2,
        title: "Operativa y Tecnolog√≠a",
        content: `# Operativa y Tecnolog√≠a

## üñ•Ô∏è Flyder: Tu Sistema Operativo

**Flyder** es tu plataforma de gesti√≥n integral para coordinar entregas en tiempo real.

### Caracter√≠sticas Principales

1. **Optimizaci√≥n con IA**
   - Asignaci√≥n inteligente de pedidos
   - Rutas optimizadas por consumo de combustible
   - Predicci√≥n de tiempos de entrega

2. **Monitorizaci√≥n en Tiempo Real**
   - GPS en vivo de todos los riders
   - Alertas de retrasos
   - Dashboard de m√©tricas operativas

3. **Coste**
   - **Activaci√≥n**: 200‚Ç¨ (una sola vez)
   - **Variable**: 0,35‚Ç¨ por pedido procesado

## üèçÔ∏è Yamimoto: Tu Flota de Motos

### El Modelo de Renting

En lugar de comprar motos, usamos **renting integral**:

- **Cuota mensual**: 154‚Ç¨/moto
- **Incluye**: Seguro a terceros + Mantenimiento preventivo
- **Fianza**: 200‚Ç¨ (recuperable)

### Ventajas del Modelo

‚úÖ **Sin inversi√≥n inicial** en veh√≠culos
‚úÖ **Mantenimiento incluido** (revisiones 1k, 5k, 10k km)
‚úÖ **Sustituci√≥n** en caso de aver√≠a (m√°x. 10 d√≠as)
‚úÖ **Flexibilidad** para escalar la flota

### Protocolo de Mantenimiento

\`\`\`
1. Revisi√≥n diaria por el rider:
   - Nivel de aceite
   - Presi√≥n de neum√°ticos
   - Luces y frenos

2. Revisiones oficiales Yamimoto:
   - 1.000 km
   - 5.000 km
   - 10.000 km

3. Incidencias:
   - Reportar inmediatamente
   - No conducir si hay anomal√≠as
\`\`\`

> ‚ö†Ô∏è **Importante**: La negligencia en el mantenimiento es responsabilidad del rider

## üì¶ Checklist de Inicio de Turno

Antes de cada turno, verificar:

- [ ] Dep√≥sito de gasolina lleno
- [ ] Caj√≥n limpio y desinfectado
- [ ] M√≥vil cargado al 100%
- [ ] Uniforme en buen estado
- [ ] Documentaci√≥n en regla (permiso, seguro)

## üéØ KPIs Clave a Monitorizar

1. **Pedidos/hora/rider**: Objetivo 2.2-2.5
2. **Tiempo medio de entrega**: Objetivo <30 min
3. **Tasa de incidencias**: Objetivo <3%
4. **Coste por pedido**: Objetivo <3‚Ç¨

En la pr√≥xima lecci√≥n veremos c√≥mo captar restaurantes y construir tu cartera B2B.
`,
        resources: [
            {
                title: "Manual de Usuario Flyder (PDF)",
                url: "https://example.com/flyder-manual.pdf"
            },
            {
                title: "Protocolo de Mantenimiento Yamimoto",
                url: "https://example.com/yamimoto-maintenance.pdf"
            }
        ]
    },
    {
        order: 3,
        title: "Estrategia Comercial B2B",
        content: `# Estrategia Comercial B2B

## üéØ Tu Cliente Ideal

No todos los restaurantes son buenos clientes. Busca:

- üçΩÔ∏è **Volumen medio-alto**: 15+ pedidos/d√≠a m√≠nimo
- üìç **Zona A (0-4km)**: Maximiza margen y eficiencia
- üí™ **Compromiso**: Dispuestos a firmar m√≠nimo 700 pedidos/mes
- ‚öñÔ∏è **Profesionalidad**: Cocinas limpias, packaging adecuado

## üí∞ Estructura de Tarifas por Zona

| Zona | Distancia | Tarifa Cliente | Coste Rider | Margen |
|------|-----------|----------------|-------------|--------|
| **A** | 0-4 km | 5,50 - 6,00‚Ç¨ | 3,50‚Ç¨ | **~2,50‚Ç¨** |
| **B** | 4-5 km | 6,50 - 7,00‚Ç¨ | 4,00‚Ç¨ | ~2,50‚Ç¨ |
| **C** | 5-6 km | 7,50 - 8,00‚Ç¨ | 4,50‚Ç¨ | ~3,00‚Ç¨ |
| **D** | 6-7 km | 8,50 - 9,00‚Ç¨ | 5,00‚Ç¨ | ~3,50‚Ç¨ |

> üí° **Estrategia**: Prioriza Zona A para volumen. Zona D tiene precio disuasorio (queremos evitar ir).

## üìä El Argumento de Venta Definitivo

### El Ahorro Real

Un restaurante medio con plataformas tradicionales:
- **Comisi√≥n**: 28% sobre 30.000‚Ç¨/a√±o = **8.400‚Ç¨**
- **Riesgo laboral**: Alta (riders como empleados de facto)
- **Control**: Nulo

Con Repaart (1.000 pedidos/a√±o):
- **Coste fijo**: 6.000‚Ç¨
- **Riesgo laboral**: Cero (riders son nuestros)
- **Control**: Total

**Ahorro anual: ~2.400‚Ç¨** + Tranquilidad + Control

## üé£ El "Battle Card" (Argumentario)

### Vs. Glovo/Uber Eats

| Aspecto | Plataformas | Repaart |
|---------|-------------|---------|
| **Coste** | 25-30% comisi√≥n | Tarifa fija/pedido |
| **Control** | Cero | Total |
| **Riesgo laboral** | Alto | Cero (nosotros empleamos) |
| **Imagen** | Variable | Profesional garantizado |
| **Datos** | Son suyos | Son tuyos |

### Objeciones Comunes y Respuestas

**"Ya trabajo con Glovo y funciona"**
> Respuesta: "Perfecto. ¬øCu√°nto est√°s pagando en comisiones al mes? Nosotros te ahorramos X euros y t√∫ mantienes el control total del servicio."

**"No tengo suficiente volumen"**
> Respuesta: "Necesitamos un m√≠nimo de 700 pedidos al mes entre todos tus locales, o podemos empezar con un piloto de 3 meses para validar."

**"¬øQu√© pasa si un rider no viene?"**
> Respuesta: "Tenemos protocolos de redundancia. Siempre hay un rider de guardia y yo personalmente me pongo el casco si hace falta."

## üìû El Proceso de Ventas (Framework)

### 1. Prospecci√≥n (Semana 1-2)
- Mapea tu zona: ¬øQu√© restaurantes tienen delivery?
- Prioriza por volumen y ubicaci√≥n (Zona A)
- Identifica a los decisores (due√±os, gerentes)

### 2. Primer Contacto (Semana 3-4)
- Llamada o visita en persona (nunca email fr√≠o)
- Agenda reuni√≥n de 15 minutos
- Lleva calculadora de ahorro preparada

### 3. Reuni√≥n Comercial
**Estructura de 15 minutos:**
- Minutos 0-3: Presentaci√≥n del problema (comisiones altas)
- Minutos 3-8: Soluci√≥n Repaart (ahorro, control)
- Minutos 8-12: Calculadora de ahorro personalizada
- Minutos 12-15: Cierre y pr√≥ximos pasos

### 4. Cierre (Semana 5-6)
- Garant√≠a de volumen: 700 pedidos/mes comprometidos
- Firma de contrato marco
- Activaci√≥n t√©cnica (48h)

## üß† Secretos de Captaci√≥n Avanzada

### La T√°ctica "Mystery Shopper"
Pide delivery a la competencia y documenta:
- ‚ùå Packaging mal cerrado
- ‚ùå Comida fr√≠a
- ‚ùå Rider sin uniforme
- ‚ùå Retraso en entrega

Luego mu√©straselo al due√±o: "¬øVes esto? As√≠ llega tu comida con ellos. Nosotros garantizamos X, Y, Z"

### La T√°ctica "Zona Segura"
- Pegatina en la puerta: "Zona Segura Repaart"
- Marketing cruzado: Flyers en bolsas de otros clientes
- Moto como valla publicitaria m√≥vil

### El Referido de Oro
> Si tienes un cliente contento, p√≠dele que te presente a 2 vecinos. Ofrece 1 mes de descuento por cada nuevo cliente que traiga.

## ‚úÖ Checklist de Activaci√≥n (48h)

Cuando cierres un cliente:

**D√≠a 1: Auditor√≠a**
- [ ] Revisar carta (eliminar productos inviables)
- [ ] Verificar packaging (¬øes apto para delivery?)
- [ ] Test t√©cnico de integraci√≥n

**D√≠a 2: Formaci√≥n**
- [ ] Capacitar al equipo del restaurante
- [ ] Definir zona de espera del rider
- [ ] Entregar material (QR, instrucciones)

**D√≠a 3: GO LIVE**
- [ ] Primer pedido monitoreado en directo
- [ ] Feedback inmediato al restaurante
- [ ] Ajustes finales

---

## üéì Ejercicio Pr√°ctico

**Calcula tu objetivo comercial:**

Si necesitas llegar a 1.500 pedidos/mes para ser rentable:
- ¬øCu√°ntos restaurantes con 50 pedidos/mes necesitas? (Respuesta: 30)
- ¬øCu√°ntos con 100 pedidos/mes? (Respuesta: 15)
- ¬øCu√°l es m√°s realista para ti?

**Tu estrategia de los pr√≥ximos 30 d√≠as:**
1. Semana 1: Mapear 50 restaurantes potenciales
2. Semana 2: Contactar 20, agendar 10 reuniones
3. Semana 3: Realizar reuniones, cerrar 3-5 clientes
4. Semana 4: Activaci√≥n y primeros pedidos

---

¬°Felicidades! Has completado el M√≥dulo 1. Ya conoces los fundamentos para lanzar tu franquicia Repaart con √©xito.

**Pr√≥ximos pasos:**
- Completa el quiz de evaluaci√≥n (80% m√≠nimo)
- Recibe tu certificado
- Avanza al M√≥dulo 2: Gesti√≥n Operativa Avanzada
`,
        resources: [
            {
                title: "Plantilla de Calculadora de Ahorro (Excel)",
                url: "https://example.com/calculadora-ahorro.xlsx"
            },
            {
                title: "Contrato Marco Tipo",
                url: "https://example.com/contrato-marco.pdf"
            },
            {
                title: "Gui√≥n de Llamada Comercial",
                url: "https://example.com/guion-comercial.pdf"
            }
        ]
    }
];

async function seedAcademy() {
    try {
        console.log('üéì Iniciando poblaci√≥n de la Academia...\n');

        // 1. Crear el m√≥dulo
        console.log('üìö Creando m√≥dulo de ejemplo...');
        const moduleRef = await addDoc(collection(db, 'academy_modules'), exampleModule);
        console.log(`‚úÖ M√≥dulo creado con ID: ${moduleRef.id}\n`);

        // 2. Crear las lecciones
        console.log('üìù Creando lecciones...');
        for (const lesson of exampleLessons) {
            const lessonData = {
                ...lesson,
                moduleId: moduleRef.id,
                createdAt: new Date().toISOString()
            };

            const lessonRef = await addDoc(collection(db, 'academy_lessons'), lessonData);
            console.log(`  ‚úÖ Lecci√≥n ${lesson.order}: "${lesson.title}" creada`);
        }

        console.log('\nüéâ ¬°Academia poblada exitosamente!');
        console.log(`\nüìä Resumen:`);
        console.log(`  - M√≥dulos: 1`);
        console.log(`  - Lecciones: ${exampleLessons.length}`);
        console.log(`  - Contenido: ~3.500 palabras de contenido educativo`);
        console.log(`\nüëâ Accede a la academia desde la app para ver el contenido`);

        process.exit(0);
    } catch (error) {
        console.error('‚ùå Error poblando la academia:', error);
        process.exit(1);
    }
}

seedAcademy();



================================================================================
FILE: scripts\seedEncyclopedia.js
================================================================================
/**
 * Encyclopedia Seeder Script
 * Carga completa de categor√≠as, m√≥dulos y quizzes en Firestore
 */

import { initializeApp, cert } from 'firebase-admin/app';
import { getFirestore } from 'firebase-admin/firestore';
import { readFileSync } from 'fs';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';
import process from 'node:process';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

// Inicializar Firebase Admin
const serviceAccount = JSON.parse(
    readFileSync(join(__dirname, '../serviceAccountKey.json'), 'utf8')
);

initializeApp({
    credential: cert(serviceAccount)
});

const db = getFirestore();

// Cargar datos del seed
const seedDataPath = join(__dirname, '../src/data/encyclopediaSeed.js');
const seedContent = readFileSync(seedDataPath, 'utf8');

// Extraer el objeto de datos (simple parsing)
const dataMatch = seedContent.match(/export const ENCYCLOPEDIA_SEED_DATA = ({[\s\S]*});/);
if (!dataMatch) {
    console.error('‚ùå Error: No se pudo parsear encyclopediaSeed.js');
    process.exit(1);
}

const SEED_DATA = eval('(' + dataMatch[1] + ')');

console.log('üìä Datos cargados del seed:');
console.log(`   - Categor√≠as: ${SEED_DATA.categories.length}`);
console.log(`   - M√≥dulos: ${SEED_DATA.modules.length}`);
console.log(`   - Quizzes: ${SEED_DATA.quizzes.length}`);
console.log('');

async function seedCategories() {
    console.log('üì¶ Cargando categor√≠as...');
    const batch = db.batch();

    SEED_DATA.categories.forEach(cat => {
        const ref = db.collection('encyclopedia_categories').doc(cat.id);
        batch.set(ref, { ...cat, updatedAt: new Date() }, { merge: true });
    });

    await batch.commit();
    console.log(`‚úÖ ${SEED_DATA.categories.length} categor√≠as sincronizadas`);
}

async function seedModules() {
    console.log('üìö Cargando m√≥dulos...');

    // Firestore permite m√°ximo 500 operaciones por batch
    const BATCH_SIZE = 450;
    const chunks = [];

    for (let i = 0; i < SEED_DATA.modules.length; i += BATCH_SIZE) {
        chunks.push(SEED_DATA.modules.slice(i, i + BATCH_SIZE));
    }

    for (let i = 0; i < chunks.length; i++) {
        const batch = db.batch();

        chunks[i].forEach(mod => {
            const ref = db.collection('encyclopedia_modules').doc();
            batch.set(ref, { ...mod, createdAt: new Date() });
        });

        await batch.commit();
        console.log(`   ‚úì Chunk ${i + 1}/${chunks.length} completado (${chunks[i].length} m√≥dulos)`);
    }

    console.log(`‚úÖ ${SEED_DATA.modules.length} m√≥dulos cargados`);
}

async function seedQuizzes() {
    console.log('üéØ Cargando quizzes...');

    // Verificar primero cu√°ntos ya existen
    const existingQuizzes = await db.collection('encyclopedia_quizzes').get();
    console.log(`   ‚ÑπÔ∏è  Quizzes existentes: ${existingQuizzes.size}`);

    // Limpiar quizzes existentes para evitar duplicados
    if (existingQuizzes.size > 0) {
        console.log('   üóëÔ∏è  Limpiando quizzes antiguos...');
        const deleteBatch = db.batch();
        existingQuizzes.docs.forEach(doc => {
            deleteBatch.delete(doc.ref);
        });
        await deleteBatch.commit();
        console.log('   ‚úì Limpieza completada');
    }

    // Cargar nuevos quizzes
    const BATCH_SIZE = 450;
    const chunks = [];

    for (let i = 0; i < SEED_DATA.quizzes.length; i += BATCH_SIZE) {
        chunks.push(SEED_DATA.quizzes.slice(i, i + BATCH_SIZE));
    }

    for (let i = 0; i < chunks.length; i++) {
        const batch = db.batch();

        chunks[i].forEach(quiz => {
            const ref = db.collection('encyclopedia_quizzes').doc();
            batch.set(ref, { ...quiz, createdAt: new Date() });
        });

        await batch.commit();
        console.log(`   ‚úì Chunk ${i + 1}/${chunks.length} completado (${chunks[i].length} quizzes)`);
    }

    console.log(`‚úÖ ${SEED_DATA.quizzes.length} quizzes cargados`);
}

async function verifyData() {
    console.log('');
    console.log('üîç Verificando datos en Firestore...');

    const categories = await db.collection('encyclopedia_categories').get();
    const modules = await db.collection('encyclopedia_modules').get();
    const quizzes = await db.collection('encyclopedia_quizzes').get();

    console.log(`   - Categor√≠as: ${categories.size}`);
    console.log(`   - M√≥dulos: ${modules.size}`);
    console.log(`   - Quizzes: ${quizzes.size}`);

    const allCorrect =
        categories.size === SEED_DATA.categories.length &&
        modules.size >= SEED_DATA.modules.length && // >= porque pueden haber extras
        quizzes.size === SEED_DATA.quizzes.length;

    if (allCorrect) {
        console.log('');
        console.log('üéâ ¬°CARGA COMPLETADA EXITOSAMENTE!');
        console.log('   Todos los datos est√°n correctamente sincronizados.');
    } else {
        console.log('');
        console.log('‚ö†Ô∏è  ADVERTENCIA: Hay discrepancias en los datos');
        if (categories.size !== SEED_DATA.categories.length) {
            console.log(`   - Categor√≠as: esperadas ${SEED_DATA.categories.length}, obtenidas ${categories.size}`);
        }
        if (quizzes.size !== SEED_DATA.quizzes.length) {
            console.log(`   - Quizzes: esperados ${SEED_DATA.quizzes.length}, obtenidos ${quizzes.size}`);
        }
    }
}

async function main() {
    try {
        console.log('üå± Iniciando proceso de seeding de Encyclopedia...');
        console.log('');

        await seedCategories();
        await seedModules();
        await seedQuizzes();
        await verifyData();

        console.log('');
        console.log('‚ú® Proceso completado. Puedes cerrar esta ventana.');
        process.exit(0);
    } catch (error) {
        console.error('');
        console.error('‚ùå ERROR FATAL:');
        console.error(error);
        process.exit(1);
    }
}

main();



================================================================================
FILE: scripts\seedEncyclopediaFull.js
================================================================================
/* eslint-disable no-undef */
// Script completo para cargar los 150 m√≥dulos de Encyclopedia
import { initializeApp } from 'firebase/app';
import { getFirestore, collection, doc, setDoc } from 'firebase/firestore';

const firebaseConfig = {
    apiKey: "AIzaSyBvKB03R1antoQQVUdgvPuBDlY7xpjRx7Q",
    authDomain: "repaartfinanzas.firebaseapp.com",
    projectId: "repaartfinanzas",
    storageBucket: "repaartfinanzas.firebasestorage.app",
    messagingSenderId: "829736003569",
    appId: "1:829736003569:web:4f6cb9dee9a8e27c21f7af"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// 12 CATEGOR√çAS
const categories = [
    { id: "estrategia", name: "Estrategia", icon: "TrendingUp", color: "blue", order: 1, unlockRequirement: null },
    { id: "finanzas", name: "Finanzas", icon: "Trophy", color: "emerald", order: 2, unlockRequirement: "estrategia" },
    { id: "operativa", name: "Operativa", icon: "TrendingUp", color: "sky", order: 3, unlockRequirement: "finanzas" },
    { id: "rrhh", name: "RRHH & Equipo", icon: "Trophy", color: "indigo", order: 4, unlockRequirement: "operativa" },
    { id: "seguridad", name: "Seguridad", icon: "TrendingUp", color: "red", order: 5, unlockRequirement: "rrhh" },
    { id: "eficiencia", name: "Eficiencia", icon: "TrendingUp", color: "yellow", order: 6, unlockRequirement: "seguridad" },
    { id: "comercial", name: "Comercial", icon: "Trophy", color: "purple", order: 7, unlockRequirement: "eficiencia" },
    { id: "cultura", name: "Cultura", icon: "Trophy", color: "pink", order: 8, unlockRequirement: "comercial" },
    { id: "maestria", name: "Maestr√≠a", icon: "Trophy", color: "amber", order: 9, unlockRequirement: "cultura" },
    { id: "tactica", name: "T√°ctica", icon: "TrendingUp", color: "slate", order: 10, unlockRequirement: "maestria" },
    { id: "crisis", name: "Legal & Crisis", icon: "TrendingUp", color: "orange", order: 11, unlockRequirement: "tactica" },
    { id: "micro", name: "Micro-Gesti√≥n", icon: "TrendingUp", color: "teal", order: 12, unlockRequirement: "crisis" }
];

// 150 M√ìDULOS - DATOS COMPLETOS
const modules = [
    {
        "categoryId": "estrategia",
        "title": "El Modelo 'Superaut√≥nomos'",
        "content": "Repaart se diferencia radicalmente de las plataformas 'gig-economy' y de las ETTs tradicionales. Somos una Operadora Log√≠stica Descentralizada. Nuestro modelo combina la flexibilidad operativa de la microempresa con una estructura s√≥lida de asalariados, eliminando el riesgo de 'falsos aut√≥nomos' y ofreciendo estabilidad.",
        "action": "Vende 'Flota Dedicada' y 'Garant√≠a Total de Servicio' frente a la incertidumbre de la competencia.",
        "order": 1
    },
    {
        "categoryId": "estrategia",
        "title": "Estructura de Packs",
        "content": "El modelo se divide en dos niveles de inversi√≥n seg√∫n el perfil del gestor. El 'Pack B√°sico' (1.500‚Ç¨ + 1% royalty) est√° dise√±ado para expertos log√≠sticos que buscan autonom√≠a. El 'Pack Premium' (3.000‚Ç¨ + 3% royalty) ofrece un acompa√±amiento intensivo con Mentoring quincenal.",
        "action": "Si es tu primera experiencia en log√≠stica, la inversi√≥n en el Pack Premium es obligatoria para evitar errores de novato.",
        "order": 2
    },
    {
        "categoryId": "estrategia",
        "title": "Matriz de Tarifas por Zonas",
        "content": "La rentabilidad en √∫ltima milla depende estrictamente de la densidad y la distancia. La Zona A (0-4km) a 6‚Ç¨ es el n√∫cleo del negocio. La Zona D (6-7km) a 9‚Ç¨ es una tarifa disuasoria dise√±ada para proteger la productividad, no para generar volumen.",
        "action": "Audita tus rutas mensualmente: El 80% de tu facturaci√≥n debe provenir de la Zona A.",
        "order": 3
    },
    {
        "categoryId": "estrategia",
        "title": "Expansi√≥n 'Mancha de Aceite'",
        "content": "El error m√°s com√∫n es abrir nuevas zonas desconectadas geogr√°ficamente. El crecimiento debe ser contiguo (barrio a barrio) para permitir que la flota fluya entre zonas seg√∫n la demanda, optimizando los recursos y evitando tiempos muertos.",
        "action": "Jam√°s firmes un restaurante aislado a 10km de tu base actual, por muy buena que sea la marca.",
        "order": 4
    },
    {
        "categoryId": "finanzas",
        "title": "Protocolo de Tesorer√≠a Blindada",
        "content": "La liquidez es el ox√≠geno de la franquicia. Implementamos un ciclo de facturaci√≥n quincenal con vencimiento a 5 d√≠as. Para proteger tu caja, el sistema incluye un 'Kill-Switch' que corta el servicio autom√°ticamente ante impagos.",
        "action": "Aplica tolerancia cero: Si un restaurante no paga el d√≠a 5, el servicio se suspende el d√≠a 6.",
        "order": 5
    },
    {
        "categoryId": "finanzas",
        "title": "El Fondo de Maniobra Sagrado",
        "content": "Debes mantener un capital l√≠quido intocable de aproximadamente 1.500‚Ç¨. Este fondo no es beneficio; es un seguro de vida para cubrir imprevistos cr√≠ticos como aver√≠as simult√°neas de motos, retrasos bancarios o fianzas urgentes.",
        "action": "Crea una cuenta bancaria separada para este fondo y nunca la uses para gastos corrientes.",
        "order": 6
    },
    {
        "categoryId": "finanzas",
        "title": "Disciplina Fiscal (Modelo 130)",
        "content": "Muchos gerentes nuevos confunden el dinero en cuenta con beneficios reales. Recuerda que debes adelantar el 20% de tu beneficio trimestral a Hacienda mediante el Modelo 130 del IRPF. El dinero en caja no es todo tuyo.",
        "action": "Automatiza tu seguridad fiscal: Transfiere el 20% de cada beneficio mensual a una sub-cuenta de impuestos.",
        "order": 7
    },
    {
        "categoryId": "finanzas",
        "title": "La 'Caja de Resistencia'",
        "content": "Operar al l√≠mite de la caja es suicida. Hemos establecido un indicador de Alerta Roja: si el saldo de tu cuenta operativa baja de 1.100‚Ç¨, la viabilidad de la empresa est√° en riesgo inmediato.",
        "action": "Si entras en zona de Alerta Roja, activa un plan de austeridad radical cortando todo gasto no esencial.",
        "order": 8
    },
    {
        "categoryId": "operativa",
        "title": "Tecnolog√≠a Flyder",
        "content": "Flyder es el cerebro operativo que gestiona la asignaci√≥n inteligente. Con un coste de 0,35‚Ç¨/pedido, es tu principal herramienta de eficiencia. En dispositivos iOS, requiere una instalaci√≥n especial v√≠a TestFlight por ser software interno corporativo.",
        "action": "Realiza una auditor√≠a semanal de 'clics fantasma' para evitar pagar comisiones por pedidos cancelados o err√≥neos.",
        "order": 9
    },
    {
        "categoryId": "operativa",
        "title": "Gesti√≥n de Flota Yamimoto",
        "content": "El renting profesional incluye seguro y mantenimiento, pero exige cumplimiento estricto. Las revisiones a los 1.000, 5.000 y 10.000 km son obligatorias para mantener la validez de la garant√≠a mec√°nica.",
        "action": "Adquiere al menos 1 moto propia de 'reserva t√°ctica' para cubrir bajas de veh√≠culos de renting.",
        "order": 10
    },
    {
        "categoryId": "operativa",
        "title": "Protocolo 'Antena Ca√≠da'",
        "content": "En zonas de sombra (s√≥tanos, garajes), el rider pierde conexi√≥n y desaparece del mapa de Flyder, impidiendo la asignaci√≥n de nuevos pedidos y reduciendo la productividad.",
        "action": "Instruye a los riders: Salir a zona abierta, activar/desactivar modo avi√≥n para forzar reconexi√≥n y contactar a base.",
        "order": 11
    },
    {
        "categoryId": "operativa",
        "title": "La Brecha de los 10 D√≠as",
        "content": "Atenci√≥n a la letra peque√±a: El contrato de Yamimoto solo ofrece veh√≠culo de sustituci√≥n si la aver√≠a inmoviliza la moto m√°s de 10 d√≠as. Una aver√≠a de 8 d√≠as te deja pagando la cuota pero sin veh√≠culo.",
        "action": "Mitiga este riesgo financiero utilizando tu moto de reserva propia o un alquiler local por d√≠as.",
        "order": 12
    },
    {
        "categoryId": "rrhh",
        "title": "Perfil del Rider Ideal",
        "content": "Buscamos estabilidad. El perfil √≥ptimo se sit√∫a entre 24 y 40 a√±os. Los perfiles muy j√≥venes suelen presentar mayor rotaci√≥n e incidencias. Valoramos especialmente la presencia, higiene y habilidades de trato al cliente.",
        "action": "Mant√©n siempre a 3 candidatos entrevistados y validados en tu 'Bolsa de Reserva'.",
        "order": 13
    },
    {
        "categoryId": "rrhh",
        "title": "Control de Inventario",
        "content": "El equipamiento (Caj√≥n, Casco, Bolsa T√©rmica, Uniforme) representa un coste elevado. Es responsabilidad contractual del trabajador cuidarlo. La p√©rdida o da√±o por negligencia debe ser repercutida.",
        "action": "Realiza inspecciones visuales aleatorias y descuenta p√©rdidas del finiquito seg√∫n tarifa.",
        "order": 14
    },
    {
        "categoryId": "rrhh",
        "title": "Liderazgo Situacional",
        "content": "La gesti√≥n de personas no es talla √∫nica. Aplica un estilo Directivo (instrucciones precisas) con los novatos inseguros y un estilo Delegativo (autonom√≠a y consulta) con los veteranos fiables.",
        "action": "Adapta tu comunicaci√≥n: Al nuevo expl√≠cale el 'c√≥mo', al veterano preg√∫ntale su opini√≥n.",
        "order": 15
    },
    {
        "categoryId": "rrhh",
        "title": "Horas Complementarias",
        "content": "La demanda en delivery es vol√°til. Los contratos parciales deben incluir siempre el anexo de 'Horas Complementarias' para tener flexibilidad legal ante picos de trabajo imprevistos.",
        "action": "Utiliza este mecanismo legal para cubrir las noches de viernes sin pagar horas extra caras.",
        "order": 16
    },
    {
        "categoryId": "seguridad",
        "title": "Riesgo de Viento Lateral",
        "content": "El caj√≥n de reparto act√∫a como una vela. Con vientos superiores a 40km/h, el riesgo de que una r√°faga lateral desestabilice la moto o la saque del carril es cr√≠tico.",
        "action": "Protocolo: Prohibido adelantar a camiones o autobuses. Reducir velocidad un 20% y circular por el centro.",
        "order": 17
    },
    {
        "categoryId": "seguridad",
        "title": "El Kit 'MacGyver'",
        "content": "Las esperas de gr√∫a matan la rentabilidad. Una dotaci√≥n m√≠nima de herramientas bajo el asiento (bridas, cinta americana, destornillador) permite solucionar desperfectos menores in situ.",
        "action": "Equipa cada moto con este kit para reparaciones de emergencia y salvar el turno.",
        "order": 18
    },
    {
        "categoryId": "seguridad",
        "title": "Visibilidad Nocturna",
        "content": "Una visera de casco rayada o sucia refracta la luz de las farolas y los coches, cegando al rider por la noche y aumentando dr√°sticamente la fatiga y el riesgo de accidente.",
        "action": "Instala una estaci√≥n de limpieza en la salida. Haz obligatorio limpiar la visera antes del turno noche.",
        "order": 19
    },
    {
        "categoryId": "crisis",
        "title": "Accidente con Heridos",
        "content": "En situaciones graves, el p√°nico bloquea. Todo el equipo debe conocer la conducta PAS: Proteger la zona, Avisar al 112 y Socorrer. La prioridad es la vida, luego la burocracia.",
        "action": "El Gerente debe acudir o solicitar fotos inmediatas de la v√≠a antes de que se muevan los veh√≠culos.",
        "order": 20
    },
    {
        "categoryId": "crisis",
        "title": "Protocolo Anti-Atraco",
        "content": "La seguridad del personal es innegociable. Una moto cuesta 3.000‚Ç¨ y est√° asegurada; la integridad f√≠sica de tu rider no tiene precio. Evita confrontaciones a toda costa.",
        "action": "Instrucci√≥n tajante: Si hay amenaza, entrega la moto y las llaves inmediatamente. No te hagas el h√©roe.",
        "order": 21
    },
    {
        "categoryId": "comercial",
        "title": "Argumentario B2B",
        "content": "No entres en guerra de precios con las grandes apps. Tu propuesta de valor es la 'Paz Mental': ofreces seguridad jur√≠dica (riders asalariados) frente al riesgo de los 'falsos aut√≥nomos'.",
        "action": "Vende seguridad: 'Si hay una inspecci√≥n o accidente, la responsabilidad es 100% de Repaart'.",
        "order": 22
    },
    {
        "categoryId": "comercial",
        "title": "Mistery Shopper",
        "content": "Para ganar argumentos de venta, no basta con decir que eres mejor; debes demostrarlo. Realiza pedidos a trav√©s de la competencia para documentar sus fallos en tiempos y presentaci√≥n.",
        "action": "Lleva fotos de la competencia (pizza volcada) al due√±o del restaurante para cerrar la venta.",
        "order": 23
    },
    {
        "categoryId": "eficiencia",
        "title": "Tela de Ara√±a",
        "content": "La densidad de pedidos es la clave del margen. Si ya tienes un rider yendo a una calle, recoger otro pedido en el local de al lado tiene un coste marginal cercano a cero.",
        "action": "Cuando firmes un cliente, visita y capta inmediatamente a los 3 locales colindantes.",
        "order": 24
    },
    {
        "categoryId": "comercial",
        "title": "Marketing de Guerrilla",
        "content": "Tus motos son vallas publicitarias m√≥viles. Aparcarlas en callejones oscuros es desperdiciar impactos visuales gratuitos que generan confianza en la marca.",
        "action": "Instruye a los riders para aparcar en avenidas principales o frente a restaurantes concurridos.",
        "order": 25
    },
    {
        "categoryId": "eficiencia",
        "title": "Kil√≥metros Basura",
        "content": "El regreso autom√°tico a la base tras cada entrega ('Efecto Yo-Yo') es ineficiente. Se quema gasolina y tiempo volviendo de vac√≠o innecesariamente.",
        "action": "Imp√≥n la 'Espera Activa': Tras entregar, esperar 3 minutos en la zona por si sale otro pedido.",
        "order": 26
    },
    {
        "categoryId": "eficiencia",
        "title": "Eco-Conducci√≥n",
        "content": "Los acelerones bruscos y el ralent√≠ excesivo disparan el consumo de combustible. Una conducci√≥n agresiva no solo es peligrosa, sino que encarece la operaci√≥n un 15%.",
        "action": "Forma a los riders en conducci√≥n suave y apagado de motor en esperas superiores a 1 minuto.",
        "order": 27
    },
    {
        "categoryId": "eficiencia",
        "title": "Regla de Pisos Bajos",
        "content": "El ascensor es un ladr√≥n de tiempo en edificios antiguos. En entregas a 1¬∫, 2¬∫ o 3¬∫ piso, subir por las escaleras es estad√≠sticamente m√°s r√°pido.",
        "action": "Fomenta el uso de escaleras en pisos bajos. Ahorra 30 minutos acumulados al d√≠a por rider.",
        "order": 28
    },
    {
        "categoryId": "eficiencia",
        "title": "Guantes T√°ctiles",
        "content": "La micro-p√©rdida de tiempo al quitarse y ponerse los guantes en cada parada para usar el m√≥vil suma horas muertas al final del mes y genera riesgo de p√©rdida.",
        "action": "Invierte en guantes de invierno con punta conductiva para toda la flota.",
        "order": 29
    },
    {
        "categoryId": "cultura",
        "title": "Efecto Mayordomo",
        "content": "La entrega es el √∫nico punto de contacto f√≠sico. No estires el brazo con desgana. Saca el producto de la mochila t√©rmica delante del cliente para que vea el vapor.",
        "action": "Instruye para entregar con las dos manos. Esto justifica un precio premium.",
        "order": 30
    },
    {
        "categoryId": "calidad",
        "title": "Auditor√≠a de Packaging",
        "content": "Muchos gerentes pierden dinero por fallos de envase del restaurante. Si la comida llega volcada o fr√≠a por un envase barato, el cliente culpa a Repaart.",
        "action": "Rechaza servir restaurantes con envases inadecuados o exige grapas y precintos de seguridad.",
        "order": 31
    },
    {
        "categoryId": "cultura",
        "title": "Embajador en Restaurante",
        "content": "El rider es la cara de tu empresa. Entrar gritando, con el casco puesto o golpeando con la mochila da√±a tu imagen y molesta a los clientes que cenan.",
        "action": "Norma de etiqueta: Entrar por puerta trasera, quitarse el casco y hablar bajo.",
        "order": 32
    },
    {
        "categoryId": "cultura",
        "title": "Gesti√≥n de Conserjes",
        "content": "Un conserje enfadado puede prohibir la entrada a tus riders y obligarles a esperar en la calle, retrasando toda la cadena de reparto.",
        "action": "Establece el saludo obligatorio: 'Buenas noches caballero'. G√°natelos como aliados.",
        "order": 33
    },
    {
        "categoryId": "crisis",
        "title": "Protocolo Apocalipsis",
        "content": "Plan de contingencia ante ca√≠da mundial de servidores (Flyder/Google/AWS). La operativa no puede detenerse por un fallo inform√°tico en hora punta.",
        "action": "Ten mapas f√≠sicos y talonarios de papel en el local. Activa el modo 'Radio-Taxi' v√≠a tel√©fono.",
        "order": 34
    },
    {
        "categoryId": "cultura",
        "title": "Gesti√≥n del Rumor",
        "content": "'Radio Macuto' destruye la moral de la tropa. Los rumores sobre bajadas de sueldo o cambios de zona desmotivan si no se atajan.",
        "action": "Aplica transparencia radical. Desmiente rumores con datos oficiales en el grupo general.",
        "order": 35
    },
    {
        "categoryId": "operativa",
        "title": "El Minuto de Oro",
        "content": "El momento cr√≠tico es justo despu√©s de cerrar la puerta del cliente. Si falta algo, es mejor solucionarlo in situ que gestionar un reembolso posterior.",
        "action": "El rider debe esperar 30 segundos en el portal antes de irse por si el cliente reclama.",
        "order": 36
    },
    {
        "categoryId": "maestria",
        "title": "El Legado (Salida)",
        "content": "Un negocio real es aquel que funciona sin la presencia constante de su due√±o. Si todo el conocimiento est√° en tu cabeza, tienes un autoempleo fr√°gil.",
        "action": "Crea el 'Libro Rojo': Un documento con todas las claves y procesos para que el negocio ruede 15 d√≠as sin ti.",
        "order": 37
    },
    {
        "categoryId": "rrhh",
        "title": "Flexibilidad Contractual",
        "content": "El delivery tiene picos imprevisibles. Contratar gente nueva para 2 horas es inviable. El 'Pacto de Horas Complementarias' es tu herramienta legal.",
        "action": "Incluye este anexo en contratos parciales para cubrir picos legales sin pagar horas extra.",
        "order": 38
    },
    {
        "categoryId": "crisis",
        "title": "Protecci√≥n de Datos",
        "content": "Tus riders tienen datos sensibles de clientes. El uso indebido (contactar para ligar o vender) es una falta muy grave y un riesgo legal enorme.",
        "action": "Prohibici√≥n tajante de contacto post-servicio. Borrado semanal del historial de navegaci√≥n.",
        "order": 39
    },
    {
        "categoryId": "operativa",
        "title": "La Brecha de 10 D√≠as",
        "content": "El contrato de renting de Yamimoto tiene un vac√≠o: no da moto de sustituci√≥n si la aver√≠a dura menos de 10 d√≠as, pero sigues pagando la cuota.",
        "action": "Ten una moto propia de reserva o un acuerdo de alquiler local para cubrir estos huecos.",
        "order": 40
    },
    {
        "categoryId": "cultura",
        "title": "Rituales de Tribu",
        "content": "El dinero atrae, pero el sentido de pertenencia retiene. Difer√©nciate de la frialdad de las grandes apps creando un equipo humano real.",
        "action": "Realiza un briefing motivacional de 3 minutos antes del turno duro. Gamifica con rankings.",
        "order": 41
    },
    {
        "categoryId": "cultura",
        "title": "Descompresi√≥n",
        "content": "El rider llega a casa con la adrenalina del tr√°fico. Ayudarle a bajar pulsaciones antes de salir mejora su salud mental y reduce el burnout.",
        "action": "Fomenta 5 minutos de charla y agua en la base al terminar el turno antes de irse.",
        "order": 42
    },
    {
        "categoryId": "cultura",
        "title": "Combate Soledad",
        "content": "El trabajo de rider es solitario. Pasan 8 horas dentro de un casco sin hablar con nadie, lo que afecta al √°nimo.",
        "action": "Dedica 1 minuto de conversaci√≥n real (no laboral) a cada rider al cruzaros en la base.",
        "order": 43
    },
    {
        "categoryId": "tactica",
        "title": "Kit MacGyver",
        "content": "A veces la moto se 'desmonta' a mitad de servicio. Una dotaci√≥n m√≠nima de herramientas evita llamar a la gr√∫a por tonter√≠as.",
        "action": "Lleva bridas, cinta americana y destornillador bajo el asiento para reparaciones de trinchera.",
        "order": 44
    },
    {
        "categoryId": "tactica",
        "title": "Kit Anti-Pinchazo",
        "content": "Esperar a la gr√∫a por un clavo es ruinoso. Un spray de espuma permite acabar el turno y llevar la moto al taller rodando.",
        "action": "Dota a cada moto de un spray reparador. Ahorra 2 horas de inactividad por pinchazo.",
        "order": 45
    },
    {
        "categoryId": "finanzas",
        "title": "F√≥rmula del Beneficio",
        "content": "Solo hay dos formas de mejorar beneficios: Aumentar ventas o disminuir costes. Ante una crisis, cortar costes es inmediato; vender m√°s lleva tiempo.",
        "action": "Revisa primero el 'desag√ºe' de costes (personal sobrante, gasolina) antes de invertir en ventas.",
        "order": 46
    },
    {
        "categoryId": "finanzas",
        "title": "Calidad de la Deuda",
        "content": "No toda la deuda es igual. Si la mayor√≠a de tu deuda es a corto plazo, tienes un riesgo de insolvencia alto ante cualquier bache de ventas.",
        "action": "Si el ratio de deuda a corto plazo se dispara, renegocia con el banco para alargar plazos.",
        "order": 47
    },
    {
        "categoryId": "comercial",
        "title": "Canal de Escucha Radical",
        "content": "La percepci√≥n de calidad no depende de no fallar nunca, sino de la velocidad con la que arreglas el fallo. Un problema resuelto r√°pido fideliza.",
        "action": "Habilita un canal directo (WhatsApp VIP) para due√±os de restaurantes para resolver incidencias ya.",
        "order": 48
    },
    {
        "categoryId": "cultura",
        "title": "Reconocimiento P√∫blico",
        "content": "El salario emocional es clave. Reconocer el buen trabajo delante de los compa√±eros refuerza las conductas positivas y motiva al grupo.",
        "action": "Nombra al 'Rider del Mes' bas√°ndote en m√©tricas objetivas y pr√©miale simb√≥licamente.",
        "order": 49
    },
    {
        "categoryId": "cultura",
        "title": "Pol√≠tica de Buen Vecino",
        "content": "El ruido y el caos generan enemigos en el barrio. Si los vecinos se quejan, la polic√≠a vendr√°. Ser invisible ac√∫sticamente es rentabilidad.",
        "action": "Prohibido mantener motores arrancados en esperas o tocar el claxon para saludar.",
        "order": 50
    },
    {
        "categoryId": "maestria",
        "title": "El Radar de Falta de Respeto",
        "content": "La autoridad se pierde en los detalles. Si un rider te interrumpe, llega tarde sin avisar o mastica chicle mientras le hablas, te est√° midiendo. Si lo toleras, has perdido el mando.",
        "action": "Corrige la falta de respeto en el segundo 1. 'Por favor, tira el chicle antes de hablarme'.",
        "order": 51
    },
    {
        "categoryId": "maestria",
        "title": "La Regla del 3 para Despidos",
        "content": "Despedir es caro, pero mantener a un t√≥xico es ruina. La regla es: 1¬™ vez (Advertencia verbal), 2¬™ vez (Sanci√≥n escrita), 3¬™ vez (Despido disciplinario). Sin emociones.",
        "action": "Documenta cada paso. Sin papel, el despido es improcedente.",
        "order": 52
    },
    {
        "categoryId": "tactica",
        "title": "Optimizaci√≥n de Sem√°foros",
        "content": "En rutas repetitivas, memorizar los ciclos semaf√≥ricos ahorra minutos. Saber qu√© sem√°foro tarda 2 minutos en abrir permite apagar motor o elegir ruta alternativa.",
        "action": "Mapea los 'sem√°foros negros' de tu zona y dise√±a rutas para evitarlos.",
        "order": 53
    },
    {
        "categoryId": "tactica",
        "title": "El Atajo del Callej√≥n",
        "content": "Los GPS comerciales (Google Maps) priorizan avenidas. El conocimiento local de callejones, pasajes peatonales permitidos o zonas de carga y descarga es tu ventaja competitiva.",
        "action": "Dedica 1 hora semanal a explorar tu zona buscando atajos 'invisibles' para el GPS.",
        "order": 54
    },
    {
        "categoryId": "crisis",
        "title": "Gesti√≥n de Redadas",
        "content": "Si hay una inspecci√≥n de trabajo o policial en el local, el p√°nico es tu enemigo. El gerente debe ser el √∫nico interlocutor. El resto, silencio absoluto.",
        "action": "Ten la carpeta 'Inspecci√≥n' siempre a mano con: Alta IAE, Seguro RC y Contratos.",
        "order": 55
    },
    {
        "categoryId": "crisis",
        "title": "Crisis de Reputaci√≥n Online",
        "content": "Una rese√±a de 1 estrella bien contestada vale m√°s que 5 estrellas sin texto. Si un cliente ataca en Google, responde con educaci√≥n, datos y ofreciendo soluci√≥n offline.",
        "action": "Nunca discutas en p√∫blico. Respuesta tipo: 'Lamentamos lo ocurrido, por favor contacta al...'",
        "order": 56
    },
    {
        "categoryId": "micro",
        "title": "Control de Gasolina",
        "content": "El robo hormiga de combustible es com√∫n. Si el consumo de una moto se dispara un 20% sin justificaci√≥n mec√°nica, alguien est√° llenando su coche con tu tarjeta.",
        "action": "Cruza los litros repostados con los Km recorridos semanalmente por moto. Audita desviaciones.",
        "order": 57
    },
    {
        "categoryId": "micro",
        "title": "Auditor√≠a de Propinas",
        "content": "Las propinas digitales a veces 'se pierden' antes de llegar al rider. Esto genera desconfianza y robo interno como represalia. La transparencia en propinas es sagrada.",
        "action": "Publica el desglose de propinas digitales recibidas y entregadas mensualmente.",
        "order": 58
    },
    {
        "categoryId": "estrategia",
        "title": "La Trampa del Volumen",
        "content": "Facturar m√°s no es ganar m√°s si tus costes variables se disparan. A veces, rechazar un cliente lejano o poco rentable aumenta tu beneficio neto al final de mes.",
        "action": "Analiza la rentabilidad por cliente. Despide al 10% de clientes menos rentables cada a√±o.",
        "order": 59
    },
    {
        "categoryId": "estrategia",
        "title": "Diversificaci√≥n de Flota",
        "content": "Depender 100% de motos de gasolina te expone al precio del petr√≥leo. Introducir un 20% de flota el√©ctrica o bicis de carga para zona centro reduce riesgos y costes.",
        "action": "Prueba piloto con 1 veh√≠culo el√©ctrico en Zona A para comparar costes reales.",
        "order": 60
    },
    {
        "categoryId": "finanzas",
        "title": "Negociaci√≥n de Seguros",
        "content": "El seguro es un coste fijo brutal. No aceptes la primera renovaci√≥n. Al tener m√°s de 5 motos, puedes optar a p√≥lizas de flota con descuentos del 30-40%.",
        "action": "Contacta a un corredor especializado en flotas tres meses antes del vencimiento.",
        "order": 61
    },
    {
        "categoryId": "finanzas",
        "title": "Coste de Oportunidad",
        "content": "¬øCu√°nto vale tu hora de gerente? Si pasas 2 horas reparando un pinchazo para ahorrar 20‚Ç¨, est√°s perdiendo dinero. Tu labor es vender y gestionar, no mec√°nica.",
        "action": "Delega tareas de bajo valor (limpieza, mec√°nica b√°sica) en cuanto puedas pagarlo.",
        "order": 62
    },
    {
        "categoryId": "operativa",
        "title": "Rotaci√≥n de Zonas",
        "content": "Los riders se queman si siempre hacen la misma ruta aburrida o la misma ruta dif√≠cil (cuestas, sin ascensor). Rotarlos mantiene la frescura y reparte la carga.",
        "action": "Establece un sistema de rotaci√≥n semanal de zonas preferentes.",
        "order": 63
    },
    {
        "categoryId": "operativa",
        "title": "El Check-in Digital",
        "content": "El inicio de turno es ca√≥tico. Usa un formulario digital (Google Forms o App) para que el rider reporte estado de moto, Km y bater√≠a al entrar. Sin check-in no hay turno.",
        "action": "Implementa QR en cada moto que lleve al formulario de estado. Obligatorio foto de da√±os.",
        "order": 64
    },
    {
        "categoryId": "rrhh",
        "title": "El Efecto 'Manzana Podrida'",
        "content": "Un l√≠der negativo (que se queja de todo, incita a trabajar menos) contagia a todo el equipo en semanas. Identif√≠calo r√°pido. Si no cambia, debe salir inmediatamente.",
        "action": "A√≠sla al l√≠der negativo. No le des audiencia p√∫blica en reuniones.",
        "order": 65
    },
    {
        "categoryId": "rrhh",
        "title": "Entrevista de Salida",
        "content": "Cuando un buen rider se va, tienes una oportunidad de oro para aprender. ¬øSe va por sueldo? ¬øPor el trato? ¬øPor las motos? Pregunta con humildad real.",
        "action": "Realiza siempre una entrevista de salida confidencial para detectar fallos estructurales.",
        "order": 66
    },
    {
        "categoryId": "seguridad",
        "title": "Conducci√≥n Defensiva",
        "content": "En la jungla urbana, tener prioridad no evita el accidente. Asume que los coches NO te ven. El rider debe conducir pensando que es invisible.",
        "action": "Formaci√≥n: Jam√°s permanecer en el √°ngulo muerto de un coche o cami√≥n.",
        "order": 67
    },
    {
        "categoryId": "seguridad",
        "title": "Ropa de Alta Visibilidad",
        "content": "El negro es 'cool' pero invisible de noche. El chaleco reflectante no es opcional, es un EPI obligatorio. Un rider atropellado es una tragedia personal y empresarial.",
        "action": "Sanci√≥n grave por no llevar el chaleco o llevarlo oculto bajo la mochila.",
        "order": 68
    },
    {
        "categoryId": "eficiencia",
        "title": "Agrupaci√≥n de Pedidos",
        "content": "Llevar un solo pedido es ineficiente. El arte est√° en el 'doblete': recoger 2 pedidos de locales cercanos para clientes en la misma direcci√≥n vectorial.",
        "action": "Configura Flyder para permitir dobletes solo si el retraso a√±adido es < 5 min.",
        "order": 69
    },
    {
        "categoryId": "eficiencia",
        "title": "Layout del Local",
        "content": "Si el rider tarda 2 minutos en aparcar, entrar, coger bolsa y salir, pierdes dinero. El flujo en base debe ser tipo 'Pit Stop' de F1. Entrar, cargar, salir.",
        "action": "Dise√±a la zona de carga cerca de la puerta. Elimina obst√°culos.",
        "order": 70
    },
    {
        "categoryId": "comercial",
        "title": "Venta Cruzada en Entrega",
        "content": "El momento de la entrega es publicidad pura. Un folleto de 'Repaart' en la bolsa (si el restaurante lo permite) o una pegatina en el cierre fideliza al cliente final.",
        "action": "Negocia con restaurantes incluir tu branding a cambio de descuento por volumen.",
        "order": 71
    },
    {
        "categoryId": "comercial",
        "title": "Alianzas de Barrio",
        "content": "Tu flota est√° parada por las ma√±anas. ¬øQui√©n necesita repartos matinales? Farmacias, florister√≠as, paqueter√≠a local. Rentabiliza las horas valle.",
        "action": "Ofrece tarifas 'Valle' con 40% de descuento para repartos de 10:00 a 13:00.",
        "order": 72
    },
    {
        "categoryId": "cultura",
        "title": "Meritocracia Real",
        "content": "Si el vago cobra lo mismo que el crack, el crack se ir√° o se volver√° vago. Dise√±a un sistema de bonus variable basado en m√©tricas (puntualidad, 0 incidencias).",
        "action": "Implementa un 'Bonus de Excelencia' mensual de 50‚Ç¨ para el Top 3.",
        "order": 73
    },
    {
        "categoryId": "cultura",
        "title": "Tolerancia al Error",
        "content": "El miedo paraliza. Si castigas brutalmente cada error honesto, nadie tomar√° iniciativas. Diferencia entre 'error por desidia' (castigo) y 'error por intentar' (aprendizaje).",
        "action": "Celebra el 'Fallo del Mes' del que m√°s se haya aprendido para quitar miedo.",
        "order": 74
    },
    {
        "categoryId": "maestria",
        "title": "Lectura de Patrones",
        "content": "El experto no mira, observa. Detecta que un restaurante est√° colapsando antes de que lo digan (camareros corriendo, gritos en cocina) y frena la asignaci√≥n ah√≠.",
        "action": "Ense√±a a los riders a reportar 'Testigo de Caos' en restaurantes para ajustar tiempos.",
        "order": 75
    },
    {
        "categoryId": "maestria",
        "title": "Gesti√≥n de la Energ√≠a",
        "content": "El turno de 4 horas a tope quema. El experto gestiona sus fuerzas. Sabe cu√°ndo apretar (lluvia, partido) y cu√°ndo rodar suave para recuperar.",
        "action": "Fomenta micro-descansos de 2 min tras entregas de alta tensi√≥n (pisos sin ascensor).",
        "order": 76
    },
    {
        "categoryId": "tactica",
        "title": "El 'No' al Cliente",
        "content": "El cliente no siempre tiene la raz√≥n. Si pide algo ilegal (entrar en casa, comprar tabaco), el rider debe saber decir NO con elegancia y firmeza.",
        "action": "Guiones predefinidos: 'Lo siento, por protocolo de seguridad tengo prohibido...'",
        "order": 77
    },
    {
        "categoryId": "tactica",
        "title": "Uso del Caballete",
        "content": "Parece tonto, pero aparcar con pata de cabra en pendiente es ca√≠da segura (y rotura de maneta). El caballete central es obligatorio en paradas de m√°s de 1 minuto.",
        "action": "Instrucci√≥n de mec√°nica b√°sica: Pata de cabra solo para 'parada y sigo' en llano.",
        "order": 78
    },
    {
        "categoryId": "crisis",
        "title": "Robo de Veh√≠culo",
        "content": "Te robar√°n una moto. Es estad√≠stica. Lo importante es la recuperaci√≥n. El GPS oculto es vital, pero la rapidez de reacci√≥n lo es m√°s.",
        "action": "Protocolo Robo: 1. Localizar GPS. 2. Llamar 091. 3. Acudir con copia de llaves (con prudencia).",
        "order": 79
    },
    {
        "categoryId": "crisis",
        "title": "Agresi√≥n a Rider",
        "content": "Si un cliente o tercero agrede a un rider, la empresa debe responder con toda su fuerza legal. El rider debe sentirse protegido por una 'maquinaria' superior.",
        "action": "Asistencia jur√≠dica gratuita para el rider en caso de agresi√≥n en servicio.",
        "order": 80
    },
    {
        "categoryId": "micro",
        "title": "Limpieza de Mochilas",
        "content": "Una mochila sucia es un foco de bacterias y mala imagen. El cliente ve la mochila antes que la comida. Si huele mal o tiene manchas, pierdes confianza.",
        "action": "Revisi√≥n semanal de higiene de mochilas. Pulverizado de alcohol diario obligatorio.",
        "order": 81
    },
    {
        "categoryId": "micro",
        "title": "Orden en el M√≥vil",
        "content": "Un rider con el soporte del m√≥vil roto o el cable colgando es un peligro. La pantalla debe estar firme y visible a un golpe de vista para no apartar la mirada.",
        "action": "Ten soportes y cables de repuesto en la oficina. No dejes salir a nadie con 'apa√±os'.",
        "order": 82
    },
    {
        "categoryId": "estrategia",
        "title": "Escalabilidad vs Artesan√≠a",
        "content": "Al principio eres artesano (controlas todo). Para crecer, debes industrializar. Estandariza procesos para que cualquiera con el manual pueda hacerlo.",
        "action": "Si lo explicas m√°s de 3 veces, escr√≠belo en un procedimiento.",
        "order": 83
    },
    {
        "categoryId": "estrategia",
        "title": "An√°lisis de Competencia",
        "content": "No ignores a Glovo/Uber. √ösalos. Mira sus tiempos, sus precios din√°micos. Aprende de sus errores y copa los huecos que su algoritmo no cubre (trato personal).",
        "action": "Monitoriza las tarifas de entrega de las Apps en tu zona en d√≠as de lluvia.",
        "order": 84
    },
    {
        "categoryId": "finanzas",
        "title": "Amortizaci√≥n de Activos",
        "content": "La moto se gasta. El casco caduca. Debes guardar una provisi√≥n mensual para reposici√≥n de activos, o en 2 a√±os tendr√°s chatarra y cero capital.",
        "action": "Calcula la vida √∫til (ej. moto 3 a√±os) y reserva 1/36 del valor cada mes.",
        "order": 85
    },
    {
        "categoryId": "finanzas",
        "title": "Control de Caja Chica",
        "content": "Los peque√±os gastos sin ticket (caf√©s, propinas) son un agujero negro fiscal y contable. Todo gasto de empresa debe estar justificado o sale de tu bolsillo personal.",
        "action": "Prohibido gastos sin ticket. Usa Apps de escaneo de gastos.",
        "order": 86
    },
    {
        "categoryId": "operativa",
        "title": "Gesti√≥n de Lluvia",
        "content": "La lluvia es dinero... y peligro. La demanda se dispara, la velocidad baja. Debes reducir el radio de entrega para mantener tiempos y seguridad.",
        "action": "Activa 'Modo Lluvia': Radio m√°x 3km y +1‚Ç¨ por pedido al cliente.",
        "order": 87
    },
    {
        "categoryId": "operativa",
        "title": "Bater√≠a de M√≥viles",
        "content": "Sin bater√≠a no hay rider. Es la herramienta de trabajo #1. Quedarse sin bater√≠a a mitad de turno es falta grave de previsi√≥n.",
        "action": "Obligatorio Powerbank cargada personal o puerto USB funcional en la moto.",
        "order": 88
    },
    {
        "categoryId": "rrhh",
        "title": "Gesti√≥n de la Frustraci√≥n",
        "content": "El cliente no contesta, llueve, la moto falla. El rider acumula ira. Ens√©√±ales a ventilar esa ira de forma sana y no pagarla con el siguiente cliente.",
        "action": "T√©cnica de 'Reset': Respirar 10 segundos antes de llamar al siguiente timbre.",
        "order": 89
    },
    {
        "categoryId": "rrhh",
        "title": "Uniformidad e Identidad",
        "content": "El uniforme no solo identifica, protege y une. Un equipo mal uniformado (mezcla de prendas, ropa sucia) parece una banda, no una empresa.",
        "action": "Entrega 2 juegos de uniforme. Exige devoluci√≥n al finalizar contrato.",
        "order": 90
    },
    {
        "categoryId": "seguridad",
        "title": "Frenada de Emergencia",
        "content": "Pocos saben frenar en mojado sin ABS. El p√°nico lleva a bloquear rueda y caer. La t√©cnica es progresiva, usando ambos frenos sin bloquear.",
        "action": "Realiza pr√°cticas de frenada en parking vac√≠o un d√≠a de lluvia con los novatos.",
        "order": 91
    },
    {
        "categoryId": "seguridad",
        "title": "Fatiga Visual",
        "content": "Tras 6 horas de atenci√≥n continua, la visi√≥n t√∫nel aparece. El rider deja de ver los laterales. Es el momento de mayor riesgo.",
        "action": "Limita los turnos continuos a m√°ximo 4 horas sin descanso real.",
        "order": 92
    },
    {
        "categoryId": "eficiencia",
        "title": "Conocimiento del Portal",
        "content": "Perder 5 minutos buscando el portal 4B en una urbanizaci√≥n gigante mata la media. El saber d√≥nde est√° la entrada exacta es 'Data' valiosa.",
        "action": "Riders veteranos deben anotar trucos de acceso en las notas de cliente para los nuevos.",
        "order": 93
    },
    {
        "categoryId": "eficiencia",
        "title": "Preparaci√≥n Pre-Turno",
        "content": "Llegar y salir. Si el rider llega a su hora y tarda 15 min en vestirse, poner soporte, buscar llaves... es tiempo perdido.",
        "action": "El turno empieza 'listo para rodar'. Llegar 10 min antes es la norma no escrita.",
        "order": 94
    },
    {
        "categoryId": "comercial",
        "title": "Recuperaci√≥n de Cliente",
        "content": "Un cliente enfadado por un retraso se puede recuperar. Un pedido gratis o un descuento agresivo hoy asegura 20 pedidos futuros.",
        "action": "Autoriza a los riders a ofrecer disculpas y 'bonus' inmediato si la cagan.",
        "order": 95
    },
    {
        "categoryId": "comercial",
        "title": "Feedback de Restaurante",
        "content": "El restaurante sabe m√°s del cliente que t√∫ (si le gusta muy hecho, si es al√©rgico). Escuchar al cocinero te da pistas para mejorar el servicio.",
        "action": "Pregunta al due√±o: '¬øQu√© es lo que m√°s se quejan tus clientes del delivery?' y soluci√≥nalo.",
        "order": 96
    },
    {
        "categoryId": "cultura",
        "title": "Rituales de Entrada",
        "content": "El 'Onboarding' define la lealtad futura. Tirar al novato a la calle el primer d√≠a sin explicarle nada es decirle 'no me importas'.",
        "action": "Primer turno: 'Sombra'. Acompa√±a a un veterano 2 horas sin llevar moto.",
        "order": 97
    },
    {
        "categoryId": "cultura",
        "title": "Celebraci√≥n de Hitos",
        "content": "1.000 pedidos entregados sin incidencias. 1 a√±o en la empresa. Celebrar estas marcas crea historia y sentido de progreso.",
        "action": "Regalo simb√≥lico (casco mejor, chaqueta pro) al cumplir hitos de permanencia.",
        "order": 98
    },
    {
        "categoryId": "maestria",
        "title": "Anticipaci√≥n de Tr√°fico",
        "content": "El maestro no frena, deja de acelerar. Anticipa que el sem√°foro se pondr√° rojo 200m antes. Conducci√≥n fluida es igual a rapidez y seguridad.",
        "action": "Premia a quien gaste menos pastillas de freno (indicador de conducci√≥n suave).",
        "order": 99
    },
    {
        "categoryId": "maestria",
        "title": "Psicolog√≠a del Portero",
        "content": "En discotecas o fincas de lujo, el portero es la llave. Tratarlo con respeto y conocer su nombre te abre puertas (literalmente) que a otros les cierran.",
        "action": "Nunca pitar para que abran. Bajar y pedir por favor.",
        "order": 100
    },
    {
        "categoryId": "tactica",
        "title": "Carga de Mochila",
        "content": "Llevar las bebidas tumbadas o las pizzas en vertical es crimen. El uso de separadores y la correcta estiba evita desastres en la primera curva.",
        "action": "Formaci√≥n pr√°ctica de Tetris: C√≥mo cargar 3 pedidos sin que se mezclen.",
        "order": 101
    },
    {
        "categoryId": "tactica",
        "title": "Puntos Ciegos de GPS",
        "content": "Hay zonas donde el GPS falla o te manda contra direcci√≥n. Conocerlas evita vueltas absurdas y multas.",
        "action": "Crea un mapa de 'Zonas Negras' en la oficina con post-its de advertencia.",
        "order": 102
    },
    {
        "categoryId": "crisis",
        "title": "Aver√≠a Lejos de Base",
        "content": "Quedarse tirado a 8km. ¬øQu√© haces? ¬øAbandonas la moto? ¬øEsperas 2 horas? El plan de rescate debe ser claro.",
        "action": "Si hay otro rider cerca, hace de 'remolque' (ilegal pero efectivo en emergencia) o lleva al piloto a base.",
        "order": 103
    },
    {
        "categoryId": "crisis",
        "title": "Cliente Agresivo",
        "content": "Cliente borracho o violento en la puerta. La integridad del rider es primero. Entregar pedido (o tirarlo) y huir. No cobrar no es el problema.",
        "action": "Lista negra de clientes/direcciones peligrosas. Se deja de servir y punto.",
        "order": 104
    },
    {
        "categoryId": "micro",
        "title": "Presi√≥n de Neum√°ticos",
        "content": "Ruedas bajas = +consumo, -agarre, -velocidad. Es el mantenimiento m√°s barato y m√°s ignorado.",
        "action": "Man√≥metro en la entrada. Revisi√≥n obligatoria cada lunes.",
        "order": 105
    },
    {
        "categoryId": "micro",
        "title": "Ajuste de Espejos",
        "content": "Cada rider tiene una altura. Salir con los espejos del compa√±ero anterior es conducir a ciegas. Ajustar espejos es parte del ritual de arranque.",
        "action": "Checklist de salida: Casco, Guantes, Espejos, Gasolina.",
        "order": 106
    },
    {
        "categoryId": "estrategia",
        "title": "Econom√≠a de Escala",
        "content": "Con 2 motos sufres. Con 20 motos, dominas. Los costes fijos se diluyen. El objetivo de la franquicia debe ser alcanzar la 'Masa Cr√≠tica' (aprox 8-10 motos) lo antes posible.",
        "action": "Reinversi√≥n total de beneficios hasta llegar a la flota cr√≠tica.",
        "order": 107
    },
    {
        "categoryId": "estrategia",
        "title": "Especializaci√≥n de Nicho",
        "content": "¬øSushi o Hamburguesas? El sushi viaja mal, paga bien. Las hamburguesas viajan bien, pagan poco. Elige tu batalla.",
        "action": "Analiza qu√© tipo de comida predomina en tu zona y adapta tus mochilas.",
        "order": 108
    },
    {
        "categoryId": "finanzas",
        "title": "Ratio de Siniestralidad",
        "content": "Si tienes muchos accidentes, el seguro te echar√° o subir√° la prima un 200%. Un rider accidentado es un coste oculto gigante.",
        "action": "Bonifica a los riders con 0 partes de accidente al a√±o.",
        "order": 109
    },
    {
        "categoryId": "finanzas",
        "title": "Control de Multas",
        "content": "Las multas llegan meses tarde. Identificar qui√©n llevaba la moto tal d√≠a a tal hora es una pesadilla administrativa si no tienes registros perfectos.",
        "action": "Registro digital de asignaci√≥n Moto-Rider por franjas horarias exactas.",
        "order": 110
    },
    {
        "categoryId": "operativa",
        "title": "Zonas de Calor",
        "content": "La demanda se mueve. A las 13:00 oficinas. A las 21:00 residencial. Posicionar la flota est√°ticamente es ineficiente. La flota debe 'orbitar' hacia donde va a surgir la demanda.",
        "action": "Mueve a los riders en espera hacia las zonas calientes antes de que suene el pedido.",
        "order": 111
    },
    {
        "categoryId": "operativa",
        "title": "Gesti√≥n de Propina Digital",
        "content": "A veces la App da propina pero no la ves hasta fin de mes. Adelantarla o no es decisi√≥n financiera, pero comunicarla motiva hoy.",
        "action": "Informa al rider de la propina obtenida al cerrar el pedido para subid√≥n de dopamina.",
        "order": 112
    },
    {
        "categoryId": "rrhh",
        "title": "El Salario Emocional",
        "content": "Flexibilidad de turnos para estudiantes o padres. Eso vale dinero. Ofrecer turnos adaptados fideliza m√°s que 50‚Ç¨ extra.",
        "action": "Pregunta preferencias de horario antes de imponer el cuadrante.",
        "order": 113
    },
    {
        "categoryId": "rrhh",
        "title": "Gesti√≥n de Conflictos",
        "content": "Roces entre riders por zonas o motos mejores. C√≥rtalo de ra√≠z. Somos un equipo, no rivales. La competencia es externa.",
        "action": "Reuni√≥n de mediaci√≥n inmediata ante cualquier conato de pelea.",
        "order": 114
    },
    {
        "categoryId": "seguridad",
        "title": "Ojo a las Puertas",
        "content": "El enemigo n¬∫1 del rider urbano: la puerta de coche que se abre de golpe. Circular pegado a los coches aparcados es ruleta rusa.",
        "action": "Regla del metro y medio: Sep√°rate de la fila de aparcados siempre.",
        "order": 115
    },
    {
        "categoryId": "seguridad",
        "title": "Estado del Pavimento",
        "content": "Pintura blanca resbaladiza, tapas de alcantarilla, arena de obra. El suelo cambia. Leer la textura del asfalto evita ca√≠das tontas.",
        "action": "Alerta en grupo de WhatsApp sobre obras o manchas de aceite en la zona.",
        "order": 116
    },
    {
        "categoryId": "eficiencia",
        "title": "Memorizaci√≥n de C√≥digos",
        "content": "Perder tiempo buscando el c√≥digo del portal en el m√≥vil cada vez. Los c√≥digos comunes deben estar en la cabeza del rider.",
        "action": "Gamificaci√≥n: ¬øQui√©n se sabe el c√≥digo de tal urbanizaci√≥n? Premia la memoria.",
        "order": 117
    },
    {
        "categoryId": "eficiencia",
        "title": "Optimizaci√≥n de Bater√≠a",
        "content": "Pantalla al 100% de brillo gasta el doble. Modo oscuro ahorra bater√≠a. Peque√±os ajustes en el m√≥vil del rider extienden la vida √∫til del turno.",
        "action": "Configura los m√≥viles de empresa en modo ahorro de energ√≠a y modo oscuro.",
        "order": 118
    },
    {
        "categoryId": "comercial",
        "title": "Imagen de Flota",
        "content": "10 motos limpias y alineadas frente al local imponen respeto y marca. 10 motos sucias y tiradas dan pena. La est√©tica vende.",
        "action": "Obligatorio lavar la moto una vez a la semana. Paga el lavado.",
        "order": 119
    },
    {
        "categoryId": "comercial",
        "title": "Trato a la Mascota",
        "content": "Si el cliente tiene perro, ser amable con el perro (sin tocarlo por higiene) gana al due√±o para siempre. El detalle humano.",
        "action": "Un 'qu√© perro m√°s bonito' genera m√°s propina que llegar 1 minuto antes.",
        "order": 120
    },
    {
        "categoryId": "cultura",
        "title": "Lenguaje Interno",
        "content": "Crear jerga propia (ej. 'zona zombie', 'paquete bomba') une al grupo. Sentirse parte de una tribu con su propio c√≥digo.",
        "action": "No reprimas la jerga operativa, fom√©ntala si es positiva.",
        "order": 121
    },
    {
        "categoryId": "cultura",
        "title": "Mentoring Inverso",
        "content": "A veces el novato joven sabe m√°s de tecnolog√≠a/Apps que el veterano. Deja que los j√≥venes ense√±en trucos digitales a los mayores.",
        "action": "Fomenta parejas de trabajo intergeneracionales.",
        "order": 122
    },
    {
        "categoryId": "maestria",
        "title": "El Sexto Sentido",
        "content": "Saber que ese coche va a girar sin poner intermitente solo por c√≥mo se mueve. Eso es experiencia. Se adquiere con kil√≥metros conscientes.",
        "action": "Comenta jugadas de tr√°fico peligrosas en el debriefing.",
        "order": 123
    },
    {
        "categoryId": "maestria",
        "title": "Dominio del Clima",
        "content": "No existe mal tiempo, solo ropa inadecuada. El maestro va seco y caliente cuando todos se mojan. Equipamiento t√©cnico de calidad marca la diferencia.",
        "action": "Subvenciona ropa t√©rmica buena. Menos bajas por enfermedad.",
        "order": 124
    },
    {
        "categoryId": "tactica",
        "title": "Uso del Caballete (II)",
        "content": "Para cargar la mochila pesada, la moto debe estar plana. Cargarla inclinada desestabiliza la carga y puede volcar la bebida.",
        "action": "Carga siempre sobre caballete central.",
        "order": 125
    },
    {
        "categoryId": "tactica",
        "title": "La Llave Maestra",
        "content": "Tener copias de llaves de los candados o accesos en lugares estrat√©gicos por si se pierden. Perder una llave no puede parar un turno.",
        "action": "Juego de llaves de repuesto siempre en la caja fuerte del local.",
        "order": 126
    },
    {
        "categoryId": "crisis",
        "title": "Fallo de App",
        "content": "Se cae el sistema. ¬øQu√© hacemos? Vuelta al papel y boli. Talonarios de albaranes manuales siempre listos.",
        "action": "Simulacro de 'Ca√≠da de Sistema' una vez al a√±o. ¬øSaben operar sin m√≥vil?",
        "order": 127
    },
    {
        "categoryId": "crisis",
        "title": "Retenci√≥n Policial",
        "content": "Paran a un rider. Papeles, seguro, ITV. Todo debe estar en una carpeta plastificada en la moto. Si falta un papel, moto inmovilizada.",
        "action": "Revisi√≥n mensual de que la documentaci√≥n de la moto sigue ah√≠.",
        "order": 128
    },
    {
        "categoryId": "micro",
        "title": "Luces Fundidas",
        "content": "Una luz fundida es multa y peligro. Cambiar una bombilla cuesta 2‚Ç¨ y 5 minutos. No hacerlo es negligencia.",
        "action": "Stock de bombillas en el local. Se cambian al momento.",
        "order": 129
    },
    {
        "categoryId": "micro",
        "title": "Holgura de Frenos",
        "content": "Las manetas se destensan. Ajustar la tensi√≥n del freno es seguridad b√°sica. Si la maneta toca el pu√±o, no frena.",
        "action": "Ense√±a a tensar frenos con la rosca manual.",
        "order": 130
    },
    {
        "categoryId": "estrategia",
        "title": "Planificaci√≥n Anual",
        "content": "El delivery es estacional. En invierno facturas el doble que en verano. Guarda en invierno para comer en verano. No gastes todo en enero.",
        "action": "Crea un 'Fondo de Estacionalidad' para los meses flacos (julio/agosto).",
        "order": 131
    },
    {
        "categoryId": "estrategia",
        "title": "Alianzas con Talleres",
        "content": "No seas un cliente m√°s. S√© un socio. Negocia prioridad en reparaciones con un taller cercano a cambio de fidelidad. Tu moto no puede hacer cola.",
        "action": "Busca taller que ofrezca 'moto de cortes√≠a' o reparaci√≥n express.",
        "order": 132
    },
    {
        "categoryId": "finanzas",
        "title": "Control de Efectivo",
        "content": "Si cobras en efectivo, el cuadre de caja diario es sagrado. El dinero vuela. Sobres cerrados, conteo doble.",
        "action": "Cierre de caja obligatorio al terminar turno delante de responsable.",
        "order": 133
    },
    {
        "categoryId": "finanzas",
        "title": "Coste de Reclutamiento",
        "content": "Cada rider nuevo cuesta dinero (ropa, formaci√≥n, alta). Retener es m√°s barato que fichar. Calcula cu√°nto te cuesta cada baja.",
        "action": "Invierte el 50% de lo que te costar√≠a fichar en un bonus de retenci√≥n.",
        "order": 134
    },
    {
        "categoryId": "operativa",
        "title": "Gesti√≥n de Bajas Medicas",
        "content": "El absentismo 'falso' de fin de semana. Patr√≥n sospechoso de bajas los viernes. Requiere seguimiento estricto y mutua.",
        "action": "Visita de control o llamada de preocupaci√≥n genuina (que tambi√©n fiscaliza).",
        "order": 135
    },
    {
        "categoryId": "operativa",
        "title": "Overbooking Controlado",
        "content": "Vender m√°s capacidad de la que tienes. Arriesgado pero rentable si sabes gestionar los picos. Jugar al l√≠mite de la capacidad.",
        "action": "Solo haz overbooking si tienes capacidad de reacci√≥n (riders de guardia).",
        "order": 136
    },
    {
        "categoryId": "rrhh",
        "title": "Formaci√≥n Continua",
        "content": "El rider que no aprende se aburre. Cursos de seguridad, de mec√°nica, de atenci√≥n al cliente. Dales valor curricular.",
        "action": "Viernes de formaci√≥n: 15 min de charla t√©cnica antes, pizzas despu√©s.",
        "order": 137
    },
    {
        "categoryId": "rrhh",
        "title": "Plan de Carrera",
        "content": "De Rider a Jefe de Equipo a Encargado. Mostrar un camino de ascenso motiva a los ambiciosos.",
        "action": "Publica el organigrama y los requisitos para subir de nivel.",
        "order": 138
    },
    {
        "categoryId": "seguridad",
        "title": "Respeto al Peat√≥n",
        "content": "La acera es lava. Invadir acera para atajar da mala imagen y multas. El rider profesional respeta al m√°s d√©bil.",
        "action": "Prohibici√≥n absoluta de circular por aceras, ni con motor apagado.",
        "order": 139
    },
    {
        "categoryId": "seguridad",
        "title": "Uso del M√≥vil",
        "content": "Mirar el GPS en marcha es accidente. Se mira parado, se memoriza el tramo, se avanza. Audio-gu√≠a mejor que visual.",
        "action": "Configura el GPS para instrucciones por voz al auricular (un solo o√≠do).",
        "order": 140
    },
    {
        "categoryId": "eficiencia",
        "title": "Rutas Circulares",
        "content": "Evita ir y volver por el mismo sitio si puedes hacer un c√≠rculo que te deje en otra zona de demanda. Optimiza el flujo.",
        "action": "Planifica la vuelta a base pasando por zonas de recogida potenciales.",
        "order": 141
    },
    {
        "categoryId": "eficiencia",
        "title": "Velocidad vs Prisa",
        "content": "Correr no es llegar antes. Fluidez es llegar antes. Los acelerones y frenazos solo gastan. Mantener velocidad media constante es la clave.",
        "action": "El rider 'lento' pero constante suele tener mejores medias que el 'loco'.",
        "order": 142
    },
    {
        "categoryId": "comercial",
        "title": "Detalle en Lluvia",
        "content": "Entregar la bolsa seca. Llevar un trapo para secar la bolsa antes de d√°rsela al cliente. Ese detalle marca la diferencia premium.",
        "action": "Trapo de microfibra en cada moto para d√≠as de lluvia.",
        "order": 143
    },
    {
        "categoryId": "comercial",
        "title": "Saludo Personalizado",
        "content": "Mirar el nombre del cliente en el ticket. 'Aqu√≠ tiene su cena, Ana'. Rompe la barrera del anonimato.",
        "action": "Obligatorio usar el nombre del cliente al entregar.",
        "order": 144
    },
    {
        "categoryId": "cultura",
        "title": "Humildad del L√≠der",
        "content": "El gerente tambi√©n reparte si hace falta. Que te vean coger una moto en un pico de faena gana m√°s respeto que 100 discursos.",
        "action": "Una vez al mes, haz un turno de reparto real con ellos.",
        "order": 145
    },
    {
        "categoryId": "cultura",
        "title": "Transparencia de Errores",
        "content": "Si la empresa se equivoca (n√≥mina mal, turno mal), pide perd√≥n p√∫blicamente y compensa. Ocultar errores directivos rompe la confianza.",
        "action": "Admite tus errores r√°pido y corr√≠gelos con intereses.",
        "order": 146
    },
    {
        "categoryId": "maestria",
        "title": "Zen en el Caos",
        "content": "Viernes noche, lluvia, todo pita. El maestro mantiene la calma. Si el l√≠der se pone nervioso, el equipo colapsa. Tu calma es su calma.",
        "action": "T√©cnicas de control de voz y respiraci√≥n en momentos de estr√©s m√°ximo.",
        "order": 147
    },
    {
        "categoryId": "maestria",
        "title": "Visi√≥n Perif√©rica",
        "content": "Ver lo que no pasa. Una pelota que sale rodando implica un ni√±o detr√°s. Anticiparse al error ajeno te salva la vida.",
        "action": "Entrena la mirada a 50 metros, no a 5 metros.",
        "order": 148
    },
    {
        "categoryId": "tactica",
        "title": "Gesti√≥n de llaves",
        "content": "Llavero retr√°ctil amarrado al pantal√≥n. Jam√°s poner las llaves sobre el mostrador o el asiento. Se pierden u olvidan.",
        "action": "Dota de llaveros extensibles a todos. Llaves siempre pegadas al cuerpo.",
        "order": 149
    },
    {
        "categoryId": "tactica",
        "title": "Cierre de Jornada",
        "content": "No te vas hasta que la moto est√° lista para ma√±ana (llena, limpia, cargada). Dejar problemas para el turno de ma√±ana es falta de compa√±erismo.",
        "action": "Checklist de cierre tan importante como el de apertura.",
        "order": 150
    }
];

async function seedEncyclopedia() {
    console.log('üå± Iniciando seed completo de Encyclopedia (150 m√≥dulos)...\n');

    try {
        // 1. Categor√≠as
        console.log('üìÅ Creando 12 categor√≠as...');
        for (const cat of categories) {
            await setDoc(doc(db, 'encyclopedia_categories', cat.id), {
                ...cat,
                createdAt: new Date()
            });
            console.log(`  ‚úì ${cat.name}`);
        }

        // 2. M√≥dulos
        console.log('\nüìö Creando 150 m√≥dulos...');
        let count = 0;
        for (const mod of modules) {
            const docRef = doc(collection(db, 'encyclopedia_modules'));
            await setDoc(docRef, {
                ...mod,
                createdAt: new Date()
            });
            count++;
            if (count % 10 === 0) console.log(`  ‚úì ${count}/150 m√≥dulos cargados...`);
        }
        console.log(`  ‚úì ${modules.length} m√≥dulos completados`);

        console.log('\n‚úÖ Encyclopedia inicializada correctamente!');
        console.log(`\nüìä Resumen:`);
        console.log(`   - ${categories.length} categor√≠as`);
        console.log(`   - ${modules.length} m√≥dulos`);
        console.log('\nüéì Ahora ve a Academy ‚Üí Encyclopedia\n');

        console.log('üèÅ Proceso finalizado.');
        if (typeof process !== 'undefined' && process.exit) {
            process.exit(0);
        }
    } catch (error) {
        console.error('\n‚ùå Error:', error.message);
        console.error(error);
        if (typeof process !== 'undefined' && process.exit) {
            process.exit(1);
        }
    }
}

seedEncyclopedia();



================================================================================
FILE: scripts\validateEncyclopedia.js
================================================================================
/**
 * ENCYCLOPEDIA INTEGRITY CHECKER
 * Script para validar integridad de datos de la Encyclopedia
 * 
 * Verifica:
 * - Referencias v√°lidas entre categor√≠as, m√≥dulos y quizzes
 * - Duplicados
 * - Orden secuencial
 * - Distribuci√≥n de contenido
 * - Estructura de datos
 */

import { ENCYCLOPEDIA_SEED_DATA } from '../src/data/encyclopediaSeed.js';

const COLORS = {
    RED: '\x1b[31m',
    GREEN: '\x1b[32m',
    YELLOW: '\x1b[33m',
    BLUE: '\x1b[36m',
    RESET: '\x1b[0m',
    BOLD: '\x1b[1m'
};

class EncyclopediaValidator {
    constructor(data) {
        this.data = data;
        this.errors = [];
        this.warnings = [];
        this.stats = {};
    }

    log(message, color = COLORS.RESET) {
        console.log(`${color}${message}${COLORS.RESET}`);
    }

    addError(message) {
        this.errors.push(message);
        this.log(`‚ùå ERROR: ${message}`, COLORS.RED);
    }

    addWarning(message) {
        this.warnings.push(message);
        this.log(`‚ö†Ô∏è  WARNING: ${message}`, COLORS.YELLOW);
    }

    addSuccess(message) {
        this.log(`‚úÖ ${message}`, COLORS.GREEN);
    }

    // Test 1: Validate Categories
    validateCategories() {
        this.log('\nüìÅ === VALIDATING CATEGORIES ===', COLORS.BOLD + COLORS.BLUE);

        const categories = this.data.categories;
        const categoryIds = new Set();
        const categoryNames = new Set();
        const orders = new Set();

        categories.forEach((cat, idx) => {
            // Check required fields
            if (!cat.id) this.addError(`Category at index ${idx} missing 'id'`);
            if (!cat.name) this.addError(`Category '${cat.id}' missing 'name'`);
            if (!cat.color) this.addWarning(`Category '${cat.id}' missing 'color'`);
            if (cat.order === undefined) this.addError(`Category '${cat.id}' missing 'order'`);

            // Check duplicates
            if (categoryIds.has(cat.id)) {
                this.addError(`Duplicate category ID: '${cat.id}'`);
            }
            categoryIds.add(cat.id);

            if (categoryNames.has(cat.name)) {
                this.addWarning(`Duplicate category name: '${cat.name}'`);
            }
            categoryNames.add(cat.name);

            if (orders.has(cat.order)) {
                this.addError(`Duplicate order ${cat.order} in categories`);
            }
            orders.add(cat.order);
        });

        // Check order sequence
        const sortedOrders = Array.from(orders).sort((a, b) => a - b);
        const expectedOrders = Array.from({ length: sortedOrders.length }, (_, i) => i + 1);
        const hasGaps = !sortedOrders.every((order, idx) => order === expectedOrders[idx]);

        if (hasGaps) {
            this.addWarning(`Category orders have gaps: ${sortedOrders.join(', ')}`);
        } else {
            this.addSuccess(`Category orders are sequential (1-${categories.length})`);
        }

        this.addSuccess(`Validated ${categories.length} categories`);
        return categoryIds;
    }

    // Test 2: Validate Modules
    validateModules(categoryIds) {
        this.log('\nüìö === VALIDATING MODULES ===', COLORS.BOLD + COLORS.BLUE);

        const modules = this.data.modules;
        const moduleTitles = new Set();
        const orphanModules = [];
        const categoryModuleCounts = {};

        modules.forEach((mod, idx) => {
            // Check required fields
            if (!mod.title) this.addError(`Module at index ${idx} missing 'title'`);
            if (!mod.content) this.addWarning(`Module '${mod.title}' missing 'content'`);
            if (!mod.action) this.addWarning(`Module '${mod.title}' missing 'action'`);
            if (!mod.categoryId) {
                this.addError(`Module '${mod.title}' missing 'categoryId'`);
            } else {
                // Check if categoryId exists
                if (!categoryIds.has(mod.categoryId)) {
                    this.addError(`Module '${mod.title}' references non-existent category '${mod.categoryId}'`);
                    orphanModules.push(mod.title);
                }

                // Count modules per category
                categoryModuleCounts[mod.categoryId] = (categoryModuleCounts[mod.categoryId] || 0) + 1;
            }

            // Check duplicates
            if (moduleTitles.has(mod.title)) {
                this.addWarning(`Duplicate module title: '${mod.title}'`);
            }
            moduleTitles.add(mod.title);

            // Check order
            if (mod.order === undefined) {
                this.addWarning(`Module '${mod.title}' missing 'order'`);
            }
        });

        // Report orphans
        if (orphanModules.length > 0) {
            this.addError(`Found ${orphanModules.length} orphan modules (invalid categoryId)`);
        }

        // Report distribution
        this.log('\nüìä Modules per category:', COLORS.BLUE);
        const categoriesArray = this.data.categories;
        categoriesArray.forEach(cat => {
            const count = categoryModuleCounts[cat.id] || 0;
            const color = count === 0 ? COLORS.RED : count < 5 ? COLORS.YELLOW : COLORS.GREEN;
            this.log(`   ${cat.name}: ${count} modules`, color);
        });

        this.addSuccess(`Validated ${modules.length} modules`);
        return categoryModuleCounts;
    }

    // Test 3: Validate Quizzes
    validateQuizzes(categoryIds) {
        this.log('\nüéØ === VALIDATING QUIZZES ===', COLORS.BOLD + COLORS.BLUE);

        const quizzes = this.data.quizzes;
        const quizQuestions = new Set();
        const categoryQuizCounts = {};

        quizzes.forEach((quiz, idx) => {
            // Check required fields
            if (!quiz.question) this.addError(`Quiz at index ${idx} missing 'question'`);
            if (!quiz.options || !Array.isArray(quiz.options)) {
                this.addError(`Quiz '${quiz.question}' missing valid 'options' array`);
            } else {
                if (quiz.options.length !== 4) {
                    this.addWarning(`Quiz '${quiz.question}' has ${quiz.options.length} options (expected 4)`);
                }
                // Check for empty options
                quiz.options.forEach((opt, i) => {
                    if (!opt || opt.trim() === '') {
                        this.addError(`Quiz '${quiz.question}' has empty option at index ${i}`);
                    }
                });
            }

            if (quiz.correctIndex === undefined) {
                this.addError(`Quiz '${quiz.question}' missing 'correctIndex'`);
            } else if (quiz.correctIndex < 0 || quiz.correctIndex > 3) {
                this.addError(`Quiz '${quiz.question}' has invalid correctIndex: ${quiz.correctIndex}`);
            }

            if (!quiz.categoryId) {
                this.addError(`Quiz '${quiz.question}' missing 'categoryId'`);
            } else {
                if (!categoryIds.has(quiz.categoryId)) {
                    this.addError(`Quiz '${quiz.question}' references non-existent category '${quiz.categoryId}'`);
                }
                categoryQuizCounts[quiz.categoryId] = (categoryQuizCounts[quiz.categoryId] || 0) + 1;
            }

            // Check duplicates
            if (quizQuestions.has(quiz.question)) {
                this.addWarning(`Duplicate quiz question: '${quiz.question}'`);
            }
            quizQuestions.add(quiz.question);
        });

        // Report distribution
        this.log('\nüìä Quizzes per category:', COLORS.BLUE);
        const categoriesArray = this.data.categories;
        categoriesArray.forEach(cat => {
            const count = categoryQuizCounts[cat.id] || 0;
            const color = count === 0 ? COLORS.RED : count < 3 ? COLORS.YELLOW : COLORS.GREEN;
            this.log(`   ${cat.name}: ${count} quizzes`, color);
        });

        this.addSuccess(`Validated ${quizzes.length} quizzes`);
        return categoryQuizCounts;
    }

    // Test 4: Check Content Balance
    validateBalance(categoryModuleCounts, categoryQuizCounts) {
        this.log('\n‚öñÔ∏è  === CHECKING CONTENT BALANCE ===', COLORS.BOLD + COLORS.BLUE);

        const categoriesArray = this.data.categories;
        const imbalanced = [];

        categoriesArray.forEach(cat => {
            const moduleCount = categoryModuleCounts[cat.id] || 0;
            const quizCount = categoryQuizCounts[cat.id] || 0;

            // Recommended: at least 8 modules and 8 quizzes per category
            if (moduleCount < 8) {
                imbalanced.push(`${cat.name}: only ${moduleCount} modules (recommended: 8+)`);
            }
            if (quizCount < 8) {
                imbalanced.push(`${cat.name}: only ${quizCount} quizzes (recommended: 8+)`);
            }
        });

        if (imbalanced.length > 0) {
            this.addWarning(`Found ${imbalanced.length} imbalanced categories:`);
            imbalanced.forEach(msg => this.log(`   - ${msg}`, COLORS.YELLOW));
        } else {
            this.addSuccess('All categories have balanced content (8+ modules and quizzes each)');
        }
    }

    // Test 5: Statistics
    generateStats() {
        this.log('\nüìà === STATISTICS ===', COLORS.BOLD + COLORS.BLUE);

        const stats = {
            totalCategories: this.data.categories.length,
            totalModules: this.data.modules.length,
            totalQuizzes: this.data.quizzes.length,
            avgModulesPerCategory: (this.data.modules.length / this.data.categories.length).toFixed(2),
            avgQuizzesPerCategory: (this.data.quizzes.length / this.data.categories.length).toFixed(2)
        };

        this.log(`   Total Categories: ${stats.totalCategories}`, COLORS.GREEN);
        this.log(`   Total Modules: ${stats.totalModules}`, COLORS.GREEN);
        this.log(`   Total Quizzes: ${stats.totalQuizzes}`, COLORS.GREEN);
        this.log(`   Avg Modules/Category: ${stats.avgModulesPerCategory}`, COLORS.BLUE);
        this.log(`   Avg Quizzes/Category: ${stats.avgQuizzesPerCategory}`, COLORS.BLUE);

        this.stats = stats;
    }

    // Run all tests
    runAllTests() {
        this.log('\n' + '='.repeat(60), COLORS.BOLD);
        this.log('üîç ENCYCLOPEDIA INTEGRITY CHECK', COLORS.BOLD + COLORS.BLUE);
        this.log('='.repeat(60), COLORS.BOLD);

        const categoryIds = this.validateCategories();
        const moduleDistribution = this.validateModules(categoryIds);
        const quizDistribution = this.validateQuizzes(categoryIds);
        this.validateBalance(moduleDistribution, quizDistribution);
        this.generateStats();

        // Final Report
        this.log('\n' + '='.repeat(60), COLORS.BOLD);
        this.log('üìã FINAL REPORT', COLORS.BOLD + COLORS.BLUE);
        this.log('='.repeat(60), COLORS.BOLD);

        if (this.errors.length === 0 && this.warnings.length === 0) {
            this.log('\nüéâ PERFECT! No errors or warnings found!', COLORS.BOLD + COLORS.GREEN);
        } else {
            if (this.errors.length > 0) {
                this.log(`\n‚ùå Found ${this.errors.length} error(s)`, COLORS.RED);
            }
            if (this.warnings.length > 0) {
                this.log(`‚ö†Ô∏è  Found ${this.warnings.length} warning(s)`, COLORS.YELLOW);
            }
        }

        this.log('='.repeat(60) + '\n', COLORS.BOLD);

        return {
            errors: this.errors,
            warnings: this.warnings,
            stats: this.stats,
            success: this.errors.length === 0
        };
    }
}

// Run the validator
console.log('\n');
const validator = new EncyclopediaValidator(ENCYCLOPEDIA_SEED_DATA);
const result = validator.runAllTests();

// Exit with appropriate code
process.exit(result.success ? 0 : 1);



================================================================================
FILE: src\App.css
================================================================================
#root {
  max-width: 1280px;
  margin: 0 auto;
  padding: 2rem;
  text-align: center;
}

.logo {
  height: 6em;
  padding: 1.5em;
  will-change: filter;
  transition: filter 300ms;
}
.logo:hover {
  filter: drop-shadow(0 0 2em #646cffaa);
}
.logo.react:hover {
  filter: drop-shadow(0 0 2em #61dafbaa);
}

@keyframes logo-spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

@media (prefers-reduced-motion: no-preference) {
  a:nth-of-type(2) .logo {
    animation: logo-spin infinite 20s linear;
  }
}

.card {
  padding: 2em;
}

.read-the-docs {
  color: #888;
}



================================================================================
FILE: src\App.jsx
================================================================================
import React, { useState, useEffect, Suspense } from 'react';
import { useAuth } from './context/AuthContext';
import { useAppNavigation } from './hooks/useAppNavigation';
import { useExport } from './hooks/useExport';
import { useTheme } from './hooks/useTheme';
import { useToast } from './hooks/useToast';
import { ToastProvider } from './context/ToastContext';
import { ThemeProvider } from './context/ThemeContext';
import { doc, getDoc } from 'firebase/firestore';
import { db } from './lib/firebase';

// Layout & UI
import DashboardLayout from './layouts/DashboardLayout';
import DashboardSkeleton from './components/DashboardSkeleton';
import Login from './components/Login';

// Components
import ViewSwitcher from './components/ViewSwitcher';
import { generatePDFReport } from './lib/pdfGenerator';
import { useDashboardData } from './hooks/useDashboardData';


// Lazy Loaded Components
const DashboardCharts = React.lazy(() => import('./components/DashboardCharts'));

function App() {
  const { user, roleConfig, logout, loading, isAdmin } = useAuth();

  // --- STATE ---
  const getCurrentMonth = () => new Date().toISOString().slice(0, 7);
  const [selectedMonth, setSelectedMonth] = useState(getCurrentMonth());
  const [viewPeriod, setViewPeriod] = useState('month'); // 'month' | 'year'
  const [isChatOpen, setIsChatOpen] = useState(false);
  const [tariffs, setTariffs] = useState(null);

  // Admin/Franchise Navigation
  const {
    viewMode, setViewMode,
    franchiseView, setFranchiseView,
    targetFranchiseId, targetFranchiseName,
    handleAdminSelectFranchise,
  } = useAppNavigation();

  const { exportCSV } = useExport();

  // Helper flags
  // isAdmin viene del context ahora
  const isFranchise = roleConfig?.role === 'franchisee';
  const isReadOnly = isAdmin && viewMode === 'franchise_detail';

  // --- DATA FETCHING (Centralized Hook) ---
  // If admin is viewing a specific franchise, we pass that ID. Otherwise, if it's a franchisee, use their own ID.
  const dataHookFranchiseId = (isAdmin && targetFranchiseId)
    ? targetFranchiseId
    : (user?.uid);

  // PREVENT PREMATURE FETCHING: Only fetch if user exists and logic applies
  const shouldFetchData = user && (isFranchise || (isAdmin && viewMode === 'franchise_detail'));

  const {
    currentData,
    report,
    previousReport,
    last6MonthsData,
    loading: dataLoading,
    error,
    handleUpdate,
    saving
  } = useDashboardData(shouldFetchData ? dataHookFranchiseId : null, selectedMonth);

  // --- EFFECTS ---
  // SECURITY FIX: Only fetch tariffs if user is logged in
  useEffect(() => {
    if (!user) return; // <--- EL PORTERO: Si no hay usuario, no entras a la DB.

    const fetchTariffs = async () => {
      try {
        const snap = await getDoc(doc(db, "config", "tariffs"));
        if (snap.exists()) setTariffs(snap.data());
      } catch (e) {
        console.warn("Using default tariffs", e);
      }
    };
    fetchTariffs();
  }, [user]); // <--- Dependencia a√±adida para que se ejecute al loguearse

  // Optimize Layout Props to avoid re-renders (Phase 6)
  const layoutProps = React.useMemo(() => {
    // console.log('DEBUG: App LayoutProps Memoization executed'); // Commented out for prod
    return {
      user, isAdmin, isFranchise,
      viewMode, setViewMode, franchiseView, setFranchiseView,
      targetFranchiseName,
      selectedMonth, onMonthChange: setSelectedMonth,
      viewPeriod, setViewPeriod,
      onLogout: logout,
      onExport: () => exportCSV(report, selectedMonth, isAdmin && targetFranchiseName ? targetFranchiseName : 'REPAART'),
      onPrint: async () => await generatePDFReport(report, targetFranchiseName || "Franchise", selectedMonth),
      sidebarData: currentData, onCalculate: handleUpdate, readOnly: isReadOnly,
      saving,
      isChatOpen, setIsChatOpen, chatData: { report }
    };
  }, [
    user, isAdmin, isFranchise, viewMode, setViewMode, franchiseView, setFranchiseView,
    targetFranchiseName, selectedMonth, viewPeriod, setViewPeriod, logout,
    exportCSV, report, currentData, handleUpdate, isReadOnly, saving, isChatOpen, setIsChatOpen
  ]);

  // 1. LOADING STATE
  if (loading) {
    return (
      <ThemeProvider>
        <ToastProvider>
          <DashboardLayout
            user={null}
            isAdmin={false}
            isSidebarOpen={false}
            viewMode="dashboard"
          >
            <DashboardSkeleton />
          </DashboardLayout>
        </ToastProvider>
      </ThemeProvider>
    );
  }

  // 2. UNAUTHENTICATED STATE (LOGIN)
  if (!user) {
    return (
      <ThemeProvider>
        <ToastProvider>
          <Login />
        </ToastProvider>
      </ThemeProvider>
    );
  }

  // 3. AUTHENTICATED STATE (DASHBOARD)
  return (
    <ThemeProvider>
      <ToastProvider>
        <Suspense fallback={
          <DashboardLayout user={user} isAdmin={isAdmin} viewMode="dashboard">
            <DashboardSkeleton />
          </DashboardLayout>
        }>
          <DashboardLayout {...layoutProps}>
            <div className="animate-fade-in-up w-full">
              <ViewSwitcher
                viewMode={viewMode} setViewMode={setViewMode}
                franchiseView={franchiseView} setFranchiseView={setFranchiseView}
                isAdmin={isAdmin} isFranchise={isFranchise}
                selectedMonth={selectedMonth} setSelectedMonth={setSelectedMonth}
                currentData={currentData} report={report} previousReport={previousReport} last6MonthsData={last6MonthsData}
                handleAdminSelectFranchise={handleAdminSelectFranchise}
                user={user}
              />
            </div>
          </DashboardLayout>
        </Suspense>
      </ToastProvider>
    </ThemeProvider>
  );
}

export default App;



================================================================================
FILE: src\components\Academy\Academy.jsx
================================================================================
import React, { useState } from 'react';
import { useAuth } from '../../context/AuthContext';
import AcademyDashboard from './AcademyDashboard';
import AdminAcademyPanel from './AdminAcademyPanel';
import ModuleViewer from './ModuleViewer';

/**
 * Academy Main Component - Punto de entrada principal
 * Maneja la vista admin vs franquiciado y la navegaci√≥n entre m√≥dulos
 */
const Academy = () => {
    const { user, isAdmin } = useAuth();
    const [selectedModule, setSelectedModule] = useState(null);
    const [activeView, setActiveView] = useState('student'); // 'student' | 'admin'

    // Si hay un m√≥dulo seleccionado, mostrar el visor
    if (selectedModule) {
        return (
            <ModuleViewer
                module={selectedModule}
                onBack={() => setSelectedModule(null)}
            />
        );
    }

    // Vista de administrador
    if (isAdmin && activeView === 'admin') {
        return (
            <div>
                {/* Toggle View Button */}
                <div className="bg-white border-b border-slate-200 p-4">
                    <div className="max-w-7xl mx-auto flex justify-between items-center">
                        <h2 className="text-lg font-bold text-slate-800">
                            Vista: Administrador
                        </h2>
                        <button
                            onClick={() => setActiveView('student')}
                            className="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 font-bold transition text-sm"
                        >
                            üëÅÔ∏è Ver como Estudiante
                        </button>
                    </div>
                </div>
                <AdminAcademyPanel />
            </div>
        );
    }

    // Vista de estudiante (para admin tambi√©n puede verla)
    return (
        <div>
            {isAdmin && (
                <div className="bg-white border-b border-slate-200 p-4">
                    <div className="max-w-7xl mx-auto flex justify-between items-center">
                        <h2 className="text-lg font-bold text-slate-800">
                            Vista: Estudiante
                        </h2>
                        <button
                            onClick={() => setActiveView('admin')}
                            className="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 font-bold transition text-sm"
                        >
                            ‚öôÔ∏è Panel de Administraci√≥n
                        </button>
                    </div>
                </div>
            )}
            <AcademyDashboard onModuleClick={setSelectedModule} />
        </div>
    );
};

export default Academy;



================================================================================
FILE: src\components\Academy\AcademyAnalytics.jsx
================================================================================
import React, { useState, useEffect } from 'react';
import { db } from '../../lib/firebase';
import { collection, getDocs } from 'firebase/firestore';
import {
    TrendingUp,
    Users,
    Award,
    BookOpen,
    BarChart3,
    Clock
} from 'lucide-react';
import { PieChart, Pie, Cell, ResponsiveContainer, BarChart, Bar, XAxis, YAxis, Tooltip, Legend } from 'recharts';

/**
 * AcademyAnalytics - Dashboard de m√©tricas para el administrador
 */
const AcademyAnalytics = () => {
    const [loading, setLoading] = useState(true);
    const [stats, setStats] = useState({
        totalStudents: 0,
        activeStudents: 0,
        completedModules: 0,
        averageScore: 0,
        moduleProgress: []
    });

    useEffect(() => {
        fetchAnalytics();
    }, []);

    const fetchAnalytics = async () => {
        try {
            // Fetch all progress data
            const progressSnap = await getDocs(collection(db, 'academy_progress'));
            const modulesSnap = await getDocs(collection(db, 'academy_modules'));

            const progressData = progressSnap.docs.map(doc => doc.data());
            const modulesData = modulesSnap.docs.reduce((acc, doc) => {
                acc[doc.id] = doc.data().title;
                return acc;
            }, {});

            // Process Metrics
            const uniqueStudents = new Set(progressData.map(p => p.userId));
            const completedCount = progressData.filter(p => p.completed).length;

            // Calculate Average Quiz Score
            const scores = progressData.filter(p => p.score).map(p => p.score);
            const avgScore = scores.length > 0
                ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length)
                : 0;

            // Module Breakdown
            const moduleStats = {};
            progressData.forEach(p => {
                if (!moduleStats[p.moduleId]) {
                    moduleStats[p.moduleId] = {
                        name: modulesData[p.moduleId] || 'M√≥dulo Desconocido',
                        completed: 0,
                        started: 0
                    };
                }
                moduleStats[p.moduleId].started++;
                if (p.completed) moduleStats[p.moduleId].completed++;
            });

            const moduleChartData = Object.values(moduleStats);

            setStats({
                totalStudents: uniqueStudents.size,
                activeStudents: uniqueStudents.size, // Simplificado, idealmente filtrar por lastActivity
                completedModules: completedCount,
                averageScore: avgScore,
                moduleProgress: moduleChartData
            });

        } catch (error) {
            console.error("Error fetching analytics:", error);
        } finally {
            setLoading(false);
        }
    };

    if (loading) return <div className="p-8 text-center text-slate-500">Cargando m√©tricas...</div>;

    return (
        <div className="space-y-8 animate-fade-in">
            {/* Header */}
            <div>
                <h2 className="text-2xl font-black text-slate-800 flex items-center gap-3">
                    <BarChart3 className="w-8 h-8 text-blue-600" />
                    Analytics de Formaci√≥n
                </h2>
                <p className="text-slate-500">Visi√≥n global del rendimiento de la academia</p>
            </div>

            {/* KPI Grid */}
            <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <div className="flex justify-between items-start mb-4">
                        <div className="p-3 bg-blue-50 rounded-xl text-blue-600">
                            <Users size={24} />
                        </div>
                        <span className="bg-green-100 text-green-700 text-xs font-bold px-2 py-1 rounded-full">+12%</span>
                    </div>
                    <p className="text-3xl font-black text-slate-800">{stats.totalStudents}</p>
                    <p className="text-sm font-medium text-slate-400">Estudiantes Activos</p>
                </div>

                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <div className="flex justify-between items-start mb-4">
                        <div className="p-3 bg-emerald-50 rounded-xl text-emerald-600">
                            <BookOpen size={24} />
                        </div>
                    </div>
                    <p className="text-3xl font-black text-slate-800">{stats.completedModules}</p>
                    <p className="text-sm font-medium text-slate-400">M√≥dulos Completados</p>
                </div>

                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <div className="flex justify-between items-start mb-4">
                        <div className="p-3 bg-purple-50 rounded-xl text-purple-600">
                            <Award size={24} />
                        </div>
                    </div>
                    <p className="text-3xl font-black text-slate-800">{stats.averageScore}%</p>
                    <p className="text-sm font-medium text-slate-400">Nota Promedio Quiz</p>
                </div>

                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <div className="flex justify-between items-start mb-4">
                        <div className="p-3 bg-orange-50 rounded-xl text-orange-600">
                            <Clock size={24} />
                        </div>
                    </div>
                    <p className="text-3xl font-black text-slate-800">45m</p>
                    <p className="text-sm font-medium text-slate-400">Tiempo Promedio/M√≥dulo</p>
                </div>
            </div>

            {/* Charts Row */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                {/* Module Progress Chart */}
                <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                    <h3 className="text-lg font-bold text-slate-800 mb-6">Progreso por M√≥dulo</h3>
                    <div className="h-64">
                        <ResponsiveContainer width="100%" height="100%">
                            <BarChart data={stats.moduleProgress}>
                                <XAxis dataKey="name" fontSize={10} angle={-15} textAnchor="end" height={60} />
                                <YAxis />
                                <Tooltip />
                                <Bar dataKey="started" name="Iniciados" fill="#e2e8f0" radius={[4, 4, 0, 0]} />
                                <Bar dataKey="completed" name="Completados" fill="#3b82f6" radius={[4, 4, 0, 0]} />
                            </BarChart>
                        </ResponsiveContainer>
                    </div>
                </div>

                {/* Score Distribution (Mock data for visuals) */}
                <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                    <h3 className="text-lg font-bold text-slate-800 mb-6">Distribuci√≥n de Notas</h3>
                    <div className="h-64 flex items-center justify-center">
                        <ResponsiveContainer width="100%" height="100%">
                            <PieChart>
                                <Pie
                                    data={[
                                        { name: 'Excelente (90-100)', value: 40 },
                                        { name: 'Bueno (80-89)', value: 30 },
                                        { name: 'Regular (70-79)', value: 20 },
                                        { name: 'Bajo (<70)', value: 10 },
                                    ]}
                                    innerRadius={60}
                                    outerRadius={80}
                                    paddingAngle={5}
                                    dataKey="value"
                                >
                                    <Cell fill="#10b981" />
                                    <Cell fill="#3b82f6" />
                                    <Cell fill="#f59e0b" />
                                    <Cell fill="#ef4444" />
                                </Pie>
                                <Tooltip />
                                <Legend />
                            </PieChart>
                        </ResponsiveContainer>
                    </div>
                </div>
            </div>
        </div>
    );
};

export default AcademyAnalytics;



================================================================================
FILE: src\components\Academy\AcademyDashboard.jsx
================================================================================
import React from 'react';
import { BookOpen, Lock, CheckCircle, Clock, PlayCircle, Award } from 'lucide-react';
import { useAcademyModules, useAcademyProgress } from '../../hooks/useAcademy';
import { useAuth } from '../../context/AuthContext';

/**
 * Academy Dashboard - Vista principal de la academia
 * Para franquiciados: Muestra m√≥dulos y progreso
 */
const AcademyDashboard = ({ onModuleClick }) => {
    const { user } = useAuth();
    const { modules, loading } = useAcademyModules();
    const { progress, totalProgress } = useAcademyProgress(user?.uid);

    const getModuleStatus = (module) => {
        const moduleProgress = progress[module.id];

        if (!moduleProgress) {
            // Verificar si est√° desbloqueado
            if (module.order === 1) return 'available';

            // Verificar si el m√≥dulo anterior est√° completado
            const prevModule = modules.find(m => m.order === module.order - 1);
            const prevProgress = progress[prevModule?.id];

            if (prevProgress && prevProgress.score >= 80) {
                return 'available';
            }

            return 'locked';
        }

        if (moduleProgress.completed) return 'completed';
        return 'in_progress';
    };

    const getStatusIcon = (status) => {
        switch (status) {
            case 'completed':
                return <CheckCircle className="w-6 h-6 text-emerald-500" />;
            case 'in_progress':
                return <PlayCircle className="w-6 h-6 text-blue-500" />;
            case 'locked':
                return <Lock className="w-6 h-6 text-slate-400" />;
            default:
                return <BookOpen className="w-6 h-6 text-blue-500" />;
        }
    };

    const getStatusColor = (status) => {
        switch (status) {
            case 'completed':
                return 'border-emerald-500 bg-emerald-50';
            case 'in_progress':
                return 'border-blue-500 bg-blue-50';
            case 'locked':
                return 'border-slate-200 bg-slate-50 opacity-60';
            default:
                return 'border-blue-500 bg-blue-50';
        }
    };

    if (loading) {
        return (
            <div className="flex items-center justify-center h-96">
                <div className="text-center">
                    <BookOpen className="w-12 h-12 mx-auto mb-4 text-blue-500 animate-pulse" />
                    <p className="text-slate-500 font-medium">Cargando academia...</p>
                </div>
            </div>
        );
    }

    return (
        <div className="p-4 md:p-8 max-w-7xl mx-auto space-y-6 md:space-y-8">
            {/* Header */}
            <div className="bg-gradient-to-br from-blue-900 to-blue-800 rounded-3xl p-6 md:p-8 text-white shadow-2xl">
                <div className="flex flex-col md:flex-row md:items-start justify-between gap-4">
                    <div>
                        <h1 className="text-3xl md:text-4xl font-black mb-2">üéì Academia Repaart</h1>
                        <p className="text-blue-200 text-base md:text-lg">
                            Tu camino hacia la excelencia operativa
                        </p>
                    </div>
                    <div className="text-left md:text-right bg-blue-900/40 p-3 rounded-xl md:bg-transparent md:p-0">
                        <p className="text-sm text-blue-300 mb-1 font-medium">Progreso Total</p>
                        <p className="text-4xl md:text-5xl font-black">{Math.round(totalProgress)}%</p>
                    </div>
                </div>

                {/* Progress Bar */}
                <div className="mt-6 bg-blue-950/50 rounded-full h-4 overflow-hidden">
                    <div
                        className="bg-gradient-to-r from-emerald-400 to-teal-300 h-full transition-all duration-500"
                        style={{ width: `${totalProgress}%` }}
                    />
                </div>
            </div>

            {/* Modules Grid */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
                {modules.map((module) => {
                    const status = getModuleStatus(module);
                    const moduleProgress = progress[module.id];
                    const isLocked = status === 'locked';

                    return (
                        <div
                            key={module.id}
                            onClick={() => !isLocked && onModuleClick(module)}
                            className={`
                                relative rounded-2xl border-2 p-6 transition-all duration-300
                                ${getStatusColor(status)}
                                ${!isLocked ? 'cursor-pointer hover:shadow-xl hover:-translate-y-1 active-press' : 'cursor-not-allowed'}
                            `}
                        >
                            {/* Status Badge */}
                            <div className="absolute top-4 right-4">
                                {getStatusIcon(status)}
                            </div>

                            {/* Module Info */}
                            <div className="mb-4">
                                <div className="flex items-center gap-2 mb-2">
                                    <span className="text-xs font-bold text-slate-500 uppercase tracking-wider">
                                        M√≥dulo {module.order}
                                    </span>
                                    {module.duration && (
                                        <span className="flex items-center text-xs text-slate-500">
                                            <Clock className="w-3 h-3 mr-1" />
                                            {module.duration}
                                        </span>
                                    )}
                                </div>
                                <h3 className="text-xl font-black text-slate-800 mb-2 line-clamp-2">
                                    {module.title}
                                </h3>
                                <p className="text-sm text-slate-600 line-clamp-3">
                                    {module.description}
                                </p>
                            </div>

                            {/* Progress */}
                            {moduleProgress && (
                                <div className="space-y-2">
                                    <div className="flex justify-between items-center text-xs font-bold">
                                        <span className="text-slate-600">
                                            {moduleProgress.completedLessons || 0}/{module.lessonCount || 0} lecciones
                                        </span>
                                        <span className="text-blue-600">
                                            {Math.round(moduleProgress.progress || 0)}%
                                        </span>
                                    </div>
                                    <div className="bg-slate-200 rounded-full h-2 overflow-hidden">
                                        <div
                                            className="bg-blue-500 h-full transition-all"
                                            style={{ width: `${moduleProgress.progress || 0}%` }}
                                        />
                                    </div>
                                </div>
                            )}

                            {/* Certificate Badge */}
                            {status === 'completed' && moduleProgress?.score >= 80 && (
                                <div className="mt-4 flex items-center gap-2 text-emerald-600 text-xs font-bold">
                                    <Award className="w-4 h-4" />
                                    Certificado obtenido ({moduleProgress.score}%)
                                </div>
                            )}

                            {/* Locked Message */}
                            {isLocked && (
                                <div className="mt-4 text-xs text-slate-500 italic">
                                    Completa el m√≥dulo anterior para desbloquear
                                </div>
                            )}
                        </div>
                    );
                })}
            </div>

            {/* Empty State */}
            {modules.length === 0 && (
                <div className="text-center py-16">
                    <BookOpen className="w-16 h-16 mx-auto mb-4 text-slate-300" />
                    <h3 className="text-xl font-bold text-slate-600 mb-2">
                        No hay m√≥dulos disponibles
                    </h3>
                    <p className="text-slate-500">
                        Los m√≥dulos aparecer√°n aqu√≠ cuando el administrador los publique
                    </p>
                </div>
            )}
        </div>
    );
};

export default AcademyDashboard;



================================================================================
FILE: src\components\Academy\AdminAcademyPanel.jsx
================================================================================
import React, { useState } from 'react';
import { Plus, Edit2, Trash2, Save, X, GripVertical, BookOpen, Award, AlertCircle, FileText, ClipboardCheck } from 'lucide-react';
import { useAcademyModules, useCreateModule, useUpdateModule, useDeleteModule } from '../../hooks/useAcademy';
import { formatDate } from '../../utils/formatDate';
import CreateExampleModuleButton from './CreateExampleModuleButton';
import LessonEditor from './LessonEditor';
import QuizEditor from './QuizEditor';
import AcademyAnalytics from './AcademyAnalytics'; // [NEW]

/**
 * Admin Panel for Academy - CRUD de m√≥dulos y lecciones
 * Solo visible para administradores
 */
const AdminAcademyPanel = () => {
    const { modules, loading } = useAcademyModules();
    const createModule = useCreateModule();
    const updateModule = useUpdateModule();
    const deleteModule = useDeleteModule();

    // Tabs: 'modules' | 'analytics'
    const [activeTab, setActiveTab] = useState('modules');

    const [selectedModule, setSelectedModule] = useState(null);
    const [selectedQuizModule, setSelectedQuizModule] = useState(null);
    const [editingModule, setEditingModule] = useState(null);
    const [isCreating, setIsCreating] = useState(false);
    const [formData, setFormData] = useState({
        title: '',
        description: '',
        duration: '',
        order: modules.length + 1
    });

    const handleCreate = async () => {
        if (!formData.title.trim()) {
            alert('El t√≠tulo es obligatorio');
            return;
        }

        try {
            await createModule({
                ...formData,
                order: modules.length + 1,
                lessonCount: 0,
                createdAt: new Date().toISOString()
            });

            setFormData({ title: '', description: '', duration: '', order: modules.length + 2 });
            setIsCreating(false);
        } catch (error) {
            console.error('Error creating module:', error);
            alert('Error al crear el m√≥dulo');
        }
    };

    const handleUpdate = async (moduleId) => {
        try {
            await updateModule(moduleId, editingModule);
            setEditingModule(null);
        } catch (error) {
            console.error('Error updating module:', error);
            alert('Error al actualizar el m√≥dulo');
        }
    };

    const handleDelete = async (moduleId, moduleTitle) => {
        if (!confirm(`¬øSeguro que quieres eliminar "${moduleTitle}"? Esta acci√≥n no se puede deshacer.`)) {
            return;
        }

        try {
            await deleteModule(moduleId);
        } catch (error) {
            console.error('Error deleting module:', error);
            alert('Error al eliminar el m√≥dulo');
        }
    };

    if (loading) {
        return (
            <div className="flex items-center justify-center h-96">
                <div className="text-center">
                    <BookOpen className="w-12 h-12 mx-auto mb-4 text-blue-500 animate-pulse" />
                    <p className="text-slate-500 font-medium">Cargando panel de administraci√≥n...</p>
                </div>
            </div>
        );
    }

    // Si hay un m√≥dulo seleccionado, mostrar el editor de lecciones
    if (selectedModule) {
        return (
            <LessonEditor
                module={selectedModule}
                onBack={() => setSelectedModule(null)}
            />
        );
    }

    // Si hay un m√≥dulo seleccionado para quiz, mostrar el editor de quiz
    if (selectedQuizModule) {
        return (
            <QuizEditor
                module={selectedQuizModule}
                onBack={() => setSelectedQuizModule(null)}
            />
        );
    }

    // [NEW] Render Analytics Tab
    if (activeTab === 'analytics') {
        return (
            <div className="p-8 max-w-7xl mx-auto space-y-8">
                <div className="flex items-center justify-between">
                    <div>
                        <h1 className="text-3xl font-black text-slate-800 flex items-center gap-3">
                            <BookOpen className="w-8 h-8 text-blue-600" />
                            Gestor de Academia
                        </h1>
                    </div>
                    {/* Tab Switcher */}
                    <div className="flex bg-slate-100 p-1 rounded-xl">
                        <button
                            onClick={() => setActiveTab('modules')}
                            className={`px-4 py-2 rounded-lg text-sm font-bold transition ${activeTab === 'modules' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                        >
                            M√≥dulos
                        </button>
                        <button
                            onClick={() => setActiveTab('analytics')}
                            className={`px-4 py-2 rounded-lg text-sm font-bold transition ${activeTab === 'analytics' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                        >
                            Analytics
                        </button>
                    </div>
                </div>
                <AcademyAnalytics />
            </div>
        );
    }

    return (
        <div className="p-8 max-w-7xl mx-auto space-y-8">
            {/* Header */}
            <div className="flex items-center justify-between">
                <div>
                    <h1 className="text-3xl font-black text-slate-800 flex items-center gap-3">
                        <BookOpen className="w-8 h-8 text-blue-600" />
                        Gestor de Academia
                    </h1>
                    <p className="text-slate-500 mt-1">
                        Administra los m√≥dulos y lecciones de la academia
                    </p>
                </div>

                {/* [NEW] Tab Switcher */}
                <div className="flex bg-slate-100 p-1 rounded-xl h-fit">
                    <button
                        onClick={() => setActiveTab('modules')}
                        className={`px-4 py-2 rounded-lg text-sm font-bold transition ${activeTab === 'modules' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                    >
                        M√≥dulos
                    </button>
                    <button
                        onClick={() => setActiveTab('analytics')}
                        className={`px-4 py-2 rounded-lg text-sm font-bold transition ${activeTab === 'analytics' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                    >
                        Analytics
                    </button>
                </div>

                <div className="flex gap-3">
                    <CreateExampleModuleButton onComplete={() => { }} />
                    <button
                        onClick={() => setIsCreating(true)}
                        className="flex items-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 font-bold shadow-lg transition"
                    >
                        <Plus className="w-5 h-5" />
                        Nuevo M√≥dulo
                    </button>
                </div>
            </div>

            {/* Create Module Form */}
            {isCreating && (
                <div className="bg-white rounded-2xl border-2 border-blue-200 p-6 shadow-lg">
                    <div className="flex items-center justify-between mb-4">
                        <h3 className="text-xl font-bold text-slate-800">Crear Nuevo M√≥dulo</h3>
                        <button
                            onClick={() => setIsCreating(false)}
                            className="p-2 hover:bg-slate-100 rounded-lg transition"
                        >
                            <X className="w-5 h-5 text-slate-500" />
                        </button>
                    </div>

                    <div className="space-y-4">
                        <div>
                            <label className="block text-sm font-bold text-slate-700 mb-2">
                                T√≠tulo del M√≥dulo *
                            </label>
                            <input
                                type="text"
                                value={formData.title}
                                onChange={(e) => setFormData({ ...formData, title: e.target.value })}
                                placeholder="Ej: Introducci√≥n a Repaart"
                                className="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-medium"
                            />
                        </div>

                        <div>
                            <label className="block text-sm font-bold text-slate-700 mb-2">
                                Descripci√≥n
                            </label>
                            <textarea
                                value={formData.description}
                                onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                                placeholder="Breve descripci√≥n del contenido del m√≥dulo"
                                rows="3"
                                className="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-medium resize-none"
                            />
                        </div>

                        <div>
                            <label className="block text-sm font-bold text-slate-700 mb-2">
                                Duraci√≥n Estimada
                            </label>
                            <input
                                type="text"
                                value={formData.duration}
                                onChange={(e) => setFormData({ ...formData, duration: e.target.value })}
                                placeholder="Ej: 45 min"
                                className="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-medium"
                            />
                        </div>

                        <div className="flex gap-3 pt-4">
                            <button
                                onClick={handleCreate}
                                className="flex-1 flex items-center justify-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 font-bold shadow-lg transition"
                            >
                                <Save className="w-5 h-5" />
                                Crear M√≥dulo
                            </button>
                            <button
                                onClick={() => setIsCreating(false)}
                                className="px-6 py-3 bg-slate-100 text-slate-700 rounded-xl hover:bg-slate-200 font-bold transition"
                            >
                                Cancelar
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Info Banner */}
            <div className="bg-blue-50 border border-blue-200 rounded-xl p-4 flex items-start gap-3">
                <AlertCircle className="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" />
                <div className="text-sm">
                    <p className="font-bold text-blue-900 mb-1">‚ÑπÔ∏è Instrucciones</p>
                    <p className="text-blue-700">
                        Los m√≥dulos se desbloquean secuencialmente. Los franquiciados deben completar cada m√≥dulo con 80% o m√°s para acceder al siguiente.
                    </p>
                </div>
            </div>

            {/* Modules List */}
            <div className="space-y-4">
                {modules.map((module) => {
                    const isEditing = editingModule?.id === module.id;

                    return (
                        <div
                            key={module.id}
                            className="bg-white rounded-2xl border-2 border-slate-200 p-6 hover:shadow-lg transition-shadow"
                        >
                            {isEditing ? (
                                /* Edit Mode */
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-bold text-slate-700 mb-2">
                                            T√≠tulo del M√≥dulo
                                        </label>
                                        <input
                                            type="text"
                                            value={editingModule.title}
                                            onChange={(e) => setEditingModule({ ...editingModule, title: e.target.value })}
                                            className="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 font-medium"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-bold text-slate-700 mb-2">
                                            Descripci√≥n
                                        </label>
                                        <textarea
                                            value={editingModule.description}
                                            onChange={(e) => setEditingModule({ ...editingModule, description: e.target.value })}
                                            rows="3"
                                            className="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 font-medium resize-none"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-bold text-slate-700 mb-2">
                                            Duraci√≥n
                                        </label>
                                        <input
                                            type="text"
                                            value={editingModule.duration}
                                            onChange={(e) => setEditingModule({ ...editingModule, duration: e.target.value })}
                                            className="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 font-medium"
                                        />
                                    </div>

                                    <div className="flex gap-3 pt-2">
                                        <button
                                            onClick={() => handleUpdate(module.id)}
                                            className="flex-1 flex items-center justify-center gap-2 px-6 py-3 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 font-bold transition"
                                        >
                                            <Save className="w-5 h-5" />
                                            Guardar Cambios
                                        </button>
                                        <button
                                            onClick={() => setEditingModule(null)}
                                            className="px-6 py-3 bg-slate-100 text-slate-700 rounded-xl hover:bg-slate-200 font-bold transition"
                                        >
                                            Cancelar
                                        </button>
                                    </div>
                                </div>
                            ) : (
                                /* View Mode */
                                <div className="flex items-start justify-between">
                                    <div className="flex-1">
                                        <div className="flex items-center gap-3 mb-2">
                                            <GripVertical className="w-5 h-5 text-slate-400" />
                                            <span className="text-xs font-bold text-slate-500 uppercase tracking-wider">
                                                M√≥dulo {module.order}
                                            </span>
                                            {module.duration && (
                                                <span className="text-xs text-slate-500">
                                                    {module.duration}
                                                </span>
                                            )}
                                        </div>
                                        <h3 className="text-xl font-black text-slate-800 mb-2">
                                            {module.title}
                                        </h3>
                                        <p className="text-slate-600 mb-3">
                                            {module.description}
                                        </p>
                                        <div className="flex items-center gap-4 text-sm">
                                            <span className="text-slate-500">
                                                {module.lessonCount || 0} lecciones
                                            </span>
                                            {module.published ? (
                                                <span className="text-emerald-600 font-bold flex items-center gap-1">
                                                    <Award className="w-4 h-4" />
                                                    Publicado
                                                </span>
                                            ) : (
                                                <span className="text-amber-600 font-bold">
                                                    Borrador
                                                </span>
                                            )}

                                        </div>
                                        <div className="mt-2 text-xs text-slate-400 font-medium">
                                            Actualizado: {formatDate(module.updatedAt || module.createdAt)}
                                        </div>
                                    </div>

                                    <div className="flex gap-2">
                                        <button
                                            onClick={() => setSelectedModule(module)}
                                            className="p-2 hover:bg-indigo-50 text-indigo-600 rounded-lg transition"
                                            title="Gestionar lecciones"
                                        >
                                            <FileText className="w-5 h-5" />
                                        </button>
                                        <button
                                            onClick={() => setSelectedQuizModule(module)}
                                            className="p-2 hover:bg-purple-50 text-purple-600 rounded-lg transition"
                                            title="Gestionar Quiz"
                                        >
                                            <ClipboardCheck className="w-5 h-5" />
                                        </button>
                                        <button
                                            onClick={() => setEditingModule(module)}
                                            className="p-2 hover:bg-blue-50 text-blue-600 rounded-lg transition"
                                            title="Editar m√≥dulo"
                                        >
                                            <Edit2 className="w-5 h-5" />
                                        </button>
                                        <button
                                            onClick={() => handleDelete(module.id, module.title)}
                                            className="p-2 hover:bg-rose-50 text-rose-600 rounded-lg transition"
                                            title="Eliminar m√≥dulo"
                                        >
                                            <Trash2 className="w-5 h-5" />
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    );
                })}
            </div>

            {/* Empty State */}
            {modules.length === 0 && !isCreating && (
                <div className="text-center py-16">
                    <BookOpen className="w-16 h-16 mx-auto mb-4 text-slate-300" />
                    <h3 className="text-xl font-bold text-slate-600 mb-2">
                        No hay m√≥dulos creados
                    </h3>
                    <p className="text-slate-500 mb-6">
                        Crea tu primer m√≥dulo para empezar a construir la academia
                    </p>
                    <div className="flex flex-col sm:flex-row gap-3 justify-center">
                        <CreateExampleModuleButton onComplete={() => { }} />
                        <button
                            onClick={() => setIsCreating(true)}
                            className="inline-flex items-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 font-bold shadow-lg transition"
                        >
                            <Plus className="w-5 h-5" />
                            Crear M√≥dulo Vac√≠o
                        </button>
                    </div>
                </div>
            )}
        </div>
    );
};

export default AdminAcademyPanel;



================================================================================
FILE: src\components\Academy\CalculatorWidget.jsx
================================================================================
import React, { useState, useEffect } from 'react';
import { Calculator, DollarSign, TrendingUp, RefreshCw, PieChart, Coins } from 'lucide-react';
import { formatMoney } from '../../lib/finance';

/**
 * CalculatorWidget - Componente interactivo para lecciones
 * Tipos soportados: 'profitability', 'roi', 'taxes'
 */
const CalculatorWidget = ({ type = 'profitability' }) => {
    // --- STATE MANAGEMENT ---
    // Initial Defaults based on type
    const [values, setValues] = useState(() => {
        if (type === 'profitability') return { orders: 800, ticket: 7.5, riders: 4, costPerOrder: 6.2 };
        if (type === 'roi') return { investment: 4000, monthlyProfit: 1200 };
        if (type === 'taxes') return { revenue: 6000, expenses: 4500 };
        return {};
    });

    // Reset values when type changes (if needed, though usually component remounts or we can keep effect with simple setState)
    useEffect(() => {
        const timer = setTimeout(() => {
            if (type === 'profitability') setValues({ orders: 800, ticket: 7.5, riders: 4, costPerOrder: 6.2 });
            else if (type === 'roi') setValues({ investment: 4000, monthlyProfit: 1200 });
            else if (type === 'taxes') setValues({ revenue: 6000, expenses: 4500 });
        }, 0);
        return () => clearTimeout(timer);
    }, [type]);

    // --- CALCULATIONS (Derived State) ---
    const result = React.useMemo(() => {
        if (Object.keys(values).length === 0) return null;

        if (type === 'profitability') {
            const revenue = (values.orders || 0) * (values.ticket || 0);
            const costs = (values.orders || 0) * (values.costPerOrder || 0);
            const profit = revenue - costs;
            const margin = revenue > 0 ? (profit / revenue) * 100 : 0;
            return { revenue, costs, profit, margin };
        }
        else if (type === 'roi') {
            const months = values.monthlyProfit > 0 ? values.investment / values.monthlyProfit : 0;
            const annualRoi = values.investment > 0 ? ((values.monthlyProfit * 12) / values.investment) * 100 : 0;
            return { months: Math.ceil(months), annualRoi };
        }
        else if (type === 'taxes') {
            const ivaRepercutido = (values.revenue || 0) * 0.21;
            const ivaSoportado = (values.expenses || 0) * 0.21;
            const ivaPagar = ivaRepercutido - ivaSoportado;
            const profitPreTax = (values.revenue || 0) - (values.expenses || 0);
            const irpf = profitPreTax > 0 ? profitPreTax * 0.20 : 0;
            return { ivaPagar, irpf, totalTaxes: ivaPagar + irpf };
        }
        return null;
    }, [values, type]);

    const handleChange = (key, val) => {
        setValues(prev => ({ ...prev, [key]: parseFloat(val) || 0 }));
    };

    // --- RENDERERS ---

    const renderProfitability = () => (
        <div className="space-y-6">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Pedidos Mensuales</label>
                    <input
                        type="number"
                        value={values.orders || ''}
                        onChange={e => handleChange('orders', e.target.value)}
                        className="w-full p-2 border rounded-lg font-mono text-zinc-700 focus:ring-2 focus:ring-blue-500"
                    />
                </div>
                <div>
                    <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Ticket Medio (‚Ç¨)</label>
                    <input
                        type="number"
                        value={values.ticket || ''}
                        onChange={e => handleChange('ticket', e.target.value)}
                        className="w-full p-2 border rounded-lg font-mono text-zinc-700 focus:ring-2 focus:ring-blue-500"
                    />
                </div>
                <div>
                    <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Coste x Pedido (‚Ç¨)</label>
                    <input
                        type="number"
                        value={values.costPerOrder || ''}
                        onChange={e => handleChange('costPerOrder', e.target.value)}
                        className="w-full p-2 border rounded-lg font-mono text-zinc-700 focus:ring-2 focus:ring-blue-500"
                    />
                </div>
            </div>

            {result && (
                <div className="bg-slate-50 rounded-xl p-4 border border-slate-200">
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <p className="text-xs text-slate-500">Ingresos</p>
                            <p className="text-lg font-bold text-blue-600">{formatMoney(result.revenue)}‚Ç¨</p>
                        </div>
                        <div>
                            <p className="text-xs text-slate-500">Beneficio Est.</p>
                            <p className={`text-lg font-black ${result.profit >= 0 ? 'text-emerald-600' : 'text-rose-600'}`}>
                                {formatMoney(result.profit)}‚Ç¨
                            </p>
                        </div>
                    </div>
                    <div className="mt-2 text-right">
                        <span className={`text-xs font-bold px-2 py-1 rounded-full ${result.margin >= 15 ? 'bg-emerald-100 text-emerald-700' : 'bg-orange-100 text-orange-700'}`}>
                            Margen: {result.margin.toFixed(1)}%
                        </span>
                    </div>
                </div>
            )}
        </div>
    );

    const renderROI = () => (
        <div className="space-y-6">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Inversi√≥n Inicial (‚Ç¨)</label>
                    <input
                        type="number"
                        value={values.investment || ''}
                        onChange={e => handleChange('investment', e.target.value)}
                        className="w-full p-2 border rounded-lg font-mono text-zinc-700 focus:ring-2 focus:ring-purple-500"
                    />
                </div>
                <div>
                    <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Beneficio Mensual (‚Ç¨)</label>
                    <input
                        type="number"
                        value={values.monthlyProfit || ''}
                        onChange={e => handleChange('monthlyProfit', e.target.value)}
                        className="w-full p-2 border rounded-lg font-mono text-zinc-700 focus:ring-2 focus:ring-purple-500"
                    />
                </div>
            </div>

            {result && (
                <div className="bg-purple-50 rounded-xl p-4 border border-purple-100">
                    <div className="flex justify-between items-center mb-4">
                        <div className="text-center flex-1 border-r border-purple-200">
                            <p className="text-xs text-purple-600 uppercase font-bold">Retorno</p>
                            <p className="text-2xl font-black text-purple-700">{result.months} Meses</p>
                        </div>
                        <div className="text-center flex-1">
                            <p className="text-xs text-purple-600 uppercase font-bold">ROI Anual</p>
                            <p className="text-2xl font-black text-purple-700">{result.annualRoi.toFixed(0)}%</p>
                        </div>
                    </div>
                    <p className="text-center text-xs text-purple-500">
                        *Estimaci√≥n basada en beneficio constante
                    </p>
                </div>
            )}
        </div>
    );

    const renderTaxes = () => (
        <div className="space-y-6">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Ingresos Base (‚Ç¨)</label>
                    <input
                        type="number"
                        value={values.revenue || ''}
                        onChange={e => handleChange('revenue', e.target.value)}
                        className="w-full p-2 border rounded-lg font-mono text-zinc-700 focus:ring-2 focus:ring-orange-500"
                    />
                </div>
                <div>
                    <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Gastos Base (‚Ç¨)</label>
                    <input
                        type="number"
                        value={values.expenses || ''}
                        onChange={e => handleChange('expenses', e.target.value)}
                        className="w-full p-2 border rounded-lg font-mono text-zinc-700 focus:ring-2 focus:ring-orange-500"
                    />
                </div>
            </div>

            {result && (
                <div className="bg-orange-50 rounded-xl p-4 border border-orange-100">
                    <h4 className="text-sm font-bold text-orange-800 mb-3 border-b border-orange-200 pb-2">Hacienda Somos Todos (Estimaci√≥n)</h4>
                    <div className="space-y-2 text-sm">
                        <div className="flex justify-between">
                            <span className="text-orange-700">IVA a Pagar (Modelo 303):</span>
                            <span className="font-bold text-orange-900">{formatMoney(result.ivaPagar)}‚Ç¨</span>
                        </div>
                        <div className="flex justify-between">
                            <span className="text-orange-700">IRPF (Modelo 130):</span>
                            <span className="font-bold text-orange-900">{formatMoney(result.irpf)}‚Ç¨</span>
                        </div>
                        <div className="border-t border-orange-200 mt-2 pt-2 flex justify-between font-bold text-lg">
                            <span className="text-orange-800">Total Trimestre:</span>
                            <span className="text-orange-900">{formatMoney(result.totalTaxes * 3)}‚Ç¨</span>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );

    const configs = {
        profitability: { title: 'Simulador de Rentabilidad', icon: TrendingUp, color: 'text-blue-600', render: renderProfitability },
        roi: { title: 'Calculadora ROI', icon: RefreshCw, color: 'text-purple-600', render: renderROI },
        taxes: { title: 'Estimador Fiscal', icon: Coins, color: 'text-orange-600', render: renderTaxes },
    };

    const config = configs[type] || configs.profitability;
    const Icon = config.icon;

    return (
        <div className="my-8 max-w-md mx-auto bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden transform transition-all hover:scale-[1.02]">
            <div className="p-4 bg-slate-50 border-b border-slate-100 flex items-center gap-3">
                <div className={`p-2 rounded-lg bg-white shadow-sm ${config.color}`}>
                    <Icon className="w-5 h-5" />
                </div>
                <h3 className="font-bold text-slate-700">{config.title}</h3>
            </div>
            <div className="p-6">
                {config.render()}
            </div>
        </div>
    );
};

export default CalculatorWidget;



================================================================================
FILE: src\components\Academy\CreateExampleModuleButton.jsx
================================================================================
import React, { useState } from 'react';
import { Sparkles, Loader2 } from 'lucide-react';
import { collection, addDoc } from 'firebase/firestore';
import { db } from '../../lib/firebase';

/**
 * Bot√≥n para crear m√≥dulo de ejemplo con contenido educativo
 */
const CreateExampleModuleButton = ({ onComplete }) => {
    const [loading, setLoading] = useState(false);

    const exampleModule = {
        order: 1,
        title: "Introducci√≥n a Repaart",
        description: "Fundamentos del modelo de negocio y conceptos clave para gestionar tu franquicia con √©xito",
        duration: "45 min",
        published: true,
        lessonCount: 3,
        createdAt: new Date().toISOString()
    };

    const exampleLessons = [
        {
            order: 1,
            title: "El Modelo de Franquicia Repaart",
            content: `# El Modelo de Franquicia Repaart

## üéØ Misi√≥n y Visi√≥n

Repaart no es una simple ETT de repartidores. Somos una **Operadora Log√≠stica Descentralizada** que transforma a emprendedores y riders en Directores de Flota Local.

### Nuestra Propuesta de Valor

El ecosistema del Food Delivery tradicional presenta varios problemas:
- **Erosi√≥n de m√°rgenes** para restaurantes (comisiones del 25-30%)
- **Precarizaci√≥n** del servicio de reparto
- **Falta de control** para los restaurantes

**Repaart ofrece la soluci√≥n:**

1. ‚úÖ **Coste predecible**: Tarifa plana por entrega
2. ‚úÖ **Control total**: Gesti√≥n directa de tu flota
3. ‚úÖ **Alta fiabilidad**: Servicio profesional garantizado
4. ‚úÖ **Imagen profesional**: Uniformes y motos branded

## üí∞ Modelo de Negocio

### Packs de Contrataci√≥n

| Pack | Inversi√≥n | Royalty | Incluye |
|------|-----------|---------|---------|
| **B√ÅSICO** | 1.500‚Ç¨ | 1% | Licencia, Manuales, Flyder, Yamimoto, Formaci√≥n |
| **PREMIUM** | 3.000‚Ç¨ | 3% | Todo lo anterior + Mentoring Quincenal |

### Servicios a la Carta

- üíº **Consultor√≠a**: 50‚Ç¨/hora
- üìä **Pack Financiero**: 100‚Ç¨/mes
- üéì **Formaci√≥n avanzada**: Bajo demanda

## üìà Rentabilidad Esperada

### Fase Despegue (700 pedidos/mes)
- **Ingresos brutos**: ~4.200‚Ç¨
- **Gastos operativos**: ~3.200‚Ç¨
- **Beneficio neto**: **~1.000‚Ç¨**

### Fase Rentabilidad (1.500 pedidos/mes)
- **Ingresos brutos**: ~9.000‚Ç¨
- **Gastos operativos**: ~7.200‚Ç¨
- **Beneficio neto**: **~1.800‚Ç¨**

> üí° **Clave del √©xito**: La rentabilidad depende de tu gesti√≥n diaria. "Te damos el coche, pero t√∫ conduces".

## üöÄ Pr√≥ximos Pasos

En las siguientes lecciones aprender√°s:
1. C√≥mo funciona la operativa diaria
2. Estrategias de captaci√≥n B2B
3. Gesti√≥n de tu equipo de riders

¬°Vamos a comenzar tu camino hacia la excelencia operativa!
`,
            resources: []
        },
        {
            order: 2,
            title: "Operativa y Tecnolog√≠a",
            content: `# Operativa y Tecnolog√≠a

## üñ•Ô∏è Flyder: Tu Sistema Operativo

**Flyder** es tu plataforma de gesti√≥n integral para coordinar entregas en tiempo real.

### Caracter√≠sticas Principales

1. **Optimizaci√≥n con IA**
   - Asignaci√≥n inteligente de pedidos
   - Rutas optimizadas por consumo de combustible
   - Predicci√≥n de tiempos de entrega

2. **Monitorizaci√≥n en Tiempo Real**
   - GPS en vivo de todos los riders
   - Alertas de retrasos
   - Dashboard de m√©tricas operativas

3. **Coste**
   - **Activaci√≥n**: 200‚Ç¨ (una sola vez)
   - **Variable**: 0,35‚Ç¨ por pedido procesado

## üèçÔ∏è Yamimoto: Tu Flota de Motos

### El Modelo de Renting

En lugar de comprar motos, usamos **renting integral**:

- **Cuota mensual**: 154‚Ç¨/moto
- **Incluye**: Seguro a terceros + Mantenimiento preventivo
- **Fianza**: 200‚Ç¨ (recuperable)

### Ventajas del Modelo

‚úÖ **Sin inversi√≥n inicial** en veh√≠culos  
‚úÖ **Mantenimiento incluido** (revisiones 1k, 5k, 10k km)  
‚úÖ **Sustituci√≥n** en caso de aver√≠a (m√°x. 10 d√≠as)  
‚úÖ **Flexibilidad** para escalar la flota

## üì¶ Checklist de Inicio de Turno

Antes de cada turno, verificar:

- [ ] Dep√≥sito de gasolina lleno
- [ ] Caj√≥n limpio y desinfectado
- [ ] M√≥vil cargado al 100%
- [ ] Uniforme en buen estado
- [ ] Documentaci√≥n en regla (permiso, seguro)

## üéØ KPIs Clave a Monitorizar

1. **Pedidos/hora/rider**: Objetivo 2.2-2.5
2. **Tiempo medio de entrega**: Objetivo <30 min
3. **Tasa de incidencias**: Objetivo <3%
4. **Coste por pedido**: Objetivo <3‚Ç¨

En la pr√≥xima lecci√≥n veremos c√≥mo captar restaurantes y construir tu cartera B2B.
`,
            resources: []
        },
        {
            order: 3,
            title: "Estrategia Comercial B2B",
            content: `# Estrategia Comercial B2B

## üéØ Tu Cliente Ideal

No todos los restaurantes son buenos clientes. Busca:

- üçΩÔ∏è **Volumen medio-alto**: 15+ pedidos/d√≠a m√≠nimo
- üìç **Zona A (0-4km)**: Maximiza margen y eficiencia
- üí™ **Compromiso**: Dispuestos a firmar m√≠nimo 700 pedidos/mes
- ‚öñÔ∏è **Profesionalidad**: Cocinas limpias, packaging adecuado

## üí∞ Estructura de Tarifas por Zona

| Zona | Distancia | Tarifa Cliente | Coste Rider | Margen |
|------|-----------|----------------|-------------|--------|
| **A** | 0-4 km | 5,50 - 6,00‚Ç¨ | 3,50‚Ç¨ | **~2,50‚Ç¨** |
| **B** | 4-5 km | 6,50 - 7,00‚Ç¨ | 4,00‚Ç¨ | ~2,50‚Ç¨ |
| **C** | 5-6 km | 7,50 - 8,00‚Ç¨ | 4,50‚Ç¨ | ~3,00‚Ç¨ |
| **D** | 6-7 km | 8,50 - 9,00‚Ç¨ | 5,00‚Ç¨ | ~3,50‚Ç¨ |

> üí° **Estrategia**: Prioriza Zona A para volumen. Zona D tiene precio disuasorio (queremos evitar ir).

## üìä El Argumento de Venta Definitivo

### El Ahorro Real

Un restaurante medio con plataformas tradicionales:
- **Comisi√≥n**: 28% sobre 30.000‚Ç¨/a√±o = **8.400‚Ç¨**
- **Riesgo laboral**: Alta (riders como empleados de facto)
- **Control**: Nulo

Con Repaart (1.000 pedidos/a√±o):
- **Coste fijo**: 6.000‚Ç¨
- **Riesgo laboral**: Cero (riders son nuestros)
- **Control**: Total

**Ahorro anual: ~2.400‚Ç¨** + Tranquilidad + Control

## üé£ El "Battle Card" (Argumentario)

### Vs. Glovo/Uber Eats

| Aspecto | Plataformas | Repaart |
|---------|-------------|---------|
| **Coste** | 25-30% comisi√≥n | Tarifa fija/pedido |
| **Control** | Cero | Total |
| **Riesgo laboral** | Alto | Cero (nosotros empleamos) |
| **Imagen** | Variable | Profesional garantizado |
| **Datos** | Son suyos | Son tuyos |

## üìû El Proceso de Ventas (Framework)

### 1. Prospecci√≥n (Semana 1-2)
- Mapea tu zona: ¬øQu√© restaurantes tienen delivery?
- Prioriza por volumen y ubicaci√≥n (Zona A)
- Identifica a los decisores (due√±os, gerentes)

### 2. Primer Contacto (Semana 3-4)
- Llamada o visita en persona (nunca email fr√≠o)
- Agenda reuni√≥n de 15 minutos
- Lleva calculadora de ahorro preparada

### 3. Reuni√≥n Comercial
**Estructura de 15 minutos:**
- Minutos 0-3: Presentaci√≥n del problema (comisiones altas)
- Minutos 3-8: Soluci√≥n Repaart (ahorro, control)
- Minutos 8-12: Calculadora de ahorro personalizada
- Minutos 12-15: Cierre y pr√≥ximos pasos

### 4. Cierre (Semana 5-6)
- Garant√≠a de volumen: 700 pedidos/mes comprometidos
- Firma de contrato marco
- Activaci√≥n t√©cnica (48h)

---

¬°Felicidades! Has completado el M√≥dulo 1. Ya conoces los fundamentos para lanzar tu franquicia Repaart con √©xito.

**Pr√≥ximos pasos:**
- Completa el quiz de evaluaci√≥n (80% m√≠nimo)
- Recibe tu certificado
- Avanza al M√≥dulo 2: Gesti√≥n Operativa Avanzada
`,
            resources: []
        }
    ];

    const handleCreate = async () => {
        setLoading(true);
        try {
            // 1. Crear el m√≥dulo
            const moduleRef = await addDoc(collection(db, 'academy_modules'), exampleModule);
            console.log(`M√≥dulo creado con ID: ${moduleRef.id}`);

            // 2. Crear las lecciones
            for (const lesson of exampleLessons) {
                const lessonData = {
                    ...lesson,
                    moduleId: moduleRef.id,
                    createdAt: new Date().toISOString()
                };

                await addDoc(collection(db, 'academy_lessons'), lessonData);
            }

            alert('‚úÖ M√≥dulo de ejemplo creado con √©xito!\n\nüìö M√≥dulo: Introducci√≥n a Repaart\nüìù Lecciones: 3\n\nYa puedes verlo en la academia.');

            if (onComplete) onComplete();
        } catch (error) {
            console.error('Error creando m√≥dulo de ejemplo:', error);
            alert('‚ùå Error al crear el m√≥dulo de ejemplo: ' + error.message);
        } finally {
            setLoading(false);
        }
    };

    return (
        <button
            onClick={handleCreate}
            disabled={loading}
            className="flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-xl hover:from-purple-700 hover:to-pink-700 font-bold shadow-lg transition disabled:opacity-50 disabled:cursor-not-allowed"
        >
            {loading ? (
                <>
                    <Loader2 className="w-5 h-5 animate-spin" />
                    Creando...
                </>
            ) : (
                <>
                    <Sparkles className="w-5 h-5" />
                    Crear M√≥dulo de Ejemplo
                </>
            )}
        </button>
    );
};

export default CreateExampleModuleButton;



================================================================================
FILE: src\components\Academy\LessonEditor.jsx
================================================================================
import React, { useState } from 'react';
import { ArrowLeft, Plus, Edit2, Trash2, Save, X, Eye, Code, GripVertical, ClipboardCheck } from 'lucide-react';
import ReactMarkdown from 'react-markdown';
import { useModuleLessons, useCreateLesson, useUpdateLesson, useDeleteLesson } from '../../hooks/useAcademy';

/**
 * Lesson Editor - CRUD completo de lecciones para un m√≥dulo
 */
const LessonEditor = ({ module, onBack }) => {
    const { lessons, loading } = useModuleLessons(module.id);
    const createLesson = useCreateLesson();
    const updateLesson = useUpdateLesson();
    const deleteLesson = useDeleteLesson();

    const [editingLesson, setEditingLesson] = useState(null);
    const [isCreating, setIsCreating] = useState(false);
    const [showPreview, setShowPreview] = useState(false);
    const [formData, setFormData] = useState({
        title: '',
        content: '',
        order: lessons.length + 1,
        resources: []
    });

    const handleCreate = async () => {
        if (!formData.title.trim() || !formData.content.trim()) {
            alert('El t√≠tulo y el contenido son obligatorios');
            return;
        }

        try {
            await createLesson({
                moduleId: module.id,
                ...formData,
                order: lessons.length + 1
            });

            setFormData({ title: '', content: '', order: lessons.length + 2, resources: [] });
            setIsCreating(false);
            alert('‚úÖ Lecci√≥n creada con √©xito');
        } catch (error) {
            console.error('Error creating lesson:', error);
            alert('Error al crear la lecci√≥n');
        }
    };

    const handleUpdate = async (lessonId) => {
        try {
            await updateLesson(lessonId, editingLesson);
            setEditingLesson(null);
            alert('‚úÖ Lecci√≥n actualizada');
        } catch (error) {
            console.error('Error updating lesson:', error);
            alert('Error al actualizar la lecci√≥n');
        }
    };

    const handleDelete = async (lessonId, lessonTitle) => {
        if (!confirm(`¬øSeguro que quieres eliminar "${lessonTitle}" ? `)) {
            return;
        }

        try {
            await deleteLesson(lessonId, module.id);
            alert('‚úÖ Lecci√≥n eliminada');
        } catch (error) {
            console.error('Error deleting lesson:', error);
            alert('Error al eliminar la lecci√≥n');
        }
    };

    if (loading) {
        return (
            <div className="flex items-center justify-center h-96">
                <div className="text-center">
                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
                    <p className="text-slate-500 font-medium">Cargando lecciones...</p>
                </div>
            </div>
        );
    }

    return (
        <div className="p-8 max-w-7xl mx-auto space-y-8">
            {/* Header */}
            <div className="flex items-center justify-between">
                <div>
                    <button
                        onClick={onBack}
                        className="flex items-center gap-2 text-blue-600 hover:text-blue-700 font-bold mb-4 transition"
                    >
                        <ArrowLeft className="w-5 h-5" />
                        Volver a m√≥dulos
                    </button>
                    <h1 className="text-3xl font-black text-slate-800">
                        Gesti√≥n de Lecciones
                    </h1>
                    <p className="text-slate-500 mt-1">
                        M√≥dulo: <span className="font-bold">{module.title}</span>
                    </p>
                </div>
                <button
                    onClick={() => setIsCreating(true)}
                    className="flex items-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 font-bold shadow-lg transition"
                >
                    <Plus className="w-5 h-5" />
                    Nueva Lecci√≥n
                </button>
            </div>

            {/* Create/Edit Lesson Form */}
            {(isCreating || editingLesson) && (
                <div className="bg-white rounded-2xl border-2 border-blue-200 p-6 shadow-lg">
                    <div className="flex items-center justify-between mb-4">
                        <div className="flex items-center gap-3">
                            <h3 className="text-xl font-bold text-slate-800">
                                {editingLesson ? 'Editar Lecci√≥n' : 'Crear Nueva Lecci√≥n'}
                            </h3>
                            <button
                                onClick={() => setShowPreview(!showPreview)}
                                className={`flex items - center gap - 1 px - 3 py - 1.5 rounded - lg text - sm font - bold transition ${showPreview
                                    ? 'bg-blue-100 text-blue-700'
                                    : 'bg-slate-100 text-slate-600'
                                    } `}
                            >
                                {showPreview ? <Code className="w-4 h-4" /> : <Eye className="w-4 h-4" />}
                                {showPreview ? 'Editar' : 'Preview'}
                            </button>
                        </div>
                        <button
                            onClick={() => {
                                setIsCreating(false);
                                setEditingLesson(null);
                                setShowPreview(false);
                            }}
                            className="p-2 hover:bg-slate-100 rounded-lg transition"
                        >
                            <X className="w-5 h-5 text-slate-500" />
                        </button>
                    </div>

                    {!showPreview ? (
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-bold text-slate-700 mb-2">
                                    T√≠tulo de la Lecci√≥n *
                                </label>
                                <input
                                    type="text"
                                    value={editingLesson ? editingLesson.title : formData.title}
                                    onChange={(e) => editingLesson
                                        ? setEditingLesson({ ...editingLesson, title: e.target.value })
                                        : setFormData({ ...formData, title: e.target.value })
                                    }
                                    placeholder="Ej: Introducci√≥n al Modelo de Negocio"
                                    className="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-medium"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-bold text-slate-700 mb-2">
                                    Contenido (Markdown) *
                                </label>

                                {/* [NEW] Toolbar */}
                                <div className="flex flex-wrap gap-2 mb-2 p-2 bg-slate-50 border border-slate-200 rounded-lg">
                                    <button
                                        onClick={() => {
                                            const content = editingLesson ? editingLesson.content : formData.content;
                                            const update = (val) => editingLesson ? setEditingLesson({ ...editingLesson, content: val }) : setFormData({ ...formData, content: val });
                                            update(content + '\n\n**Negrita**');
                                        }}
                                        className="px-2 py-1 bg-white border border-slate-300 rounded hover:bg-slate-100 text-xs font-bold"
                                    >
                                        B
                                    </button>
                                    <button
                                        onClick={() => {
                                            const content = editingLesson ? editingLesson.content : formData.content;
                                            const update = (val) => editingLesson ? setEditingLesson({ ...editingLesson, content: val }) : setFormData({ ...formData, content: val });
                                            update(content + '\n\n*Cursiva*');
                                        }}
                                        className="px-2 py-1 bg-white border border-slate-300 rounded hover:bg-slate-100 text-xs italic font-bold"
                                    >
                                        I
                                    </button>
                                    <div className="w-px bg-slate-300 mx-2"></div>
                                    <span className="text-xs font-bold text-slate-500 self-center uppercase">Widgets:</span>

                                    <button
                                        onClick={() => {
                                            const content = editingLesson ? editingLesson.content : formData.content;
                                            const update = (val) => editingLesson ? setEditingLesson({ ...editingLesson, content: val }) : setFormData({ ...formData, content: val });
                                            update(content + '\n\n{{WIDGET:CALCULATOR_PROFITABILITY}}\n\n');
                                        }}
                                        className="px-2 py-1 bg-blue-50 border border-blue-200 text-blue-600 rounded hover:bg-blue-100 text-xs font-bold"
                                    >
                                        + Rentab.
                                    </button>
                                    <button
                                        onClick={() => {
                                            const content = editingLesson ? editingLesson.content : formData.content;
                                            const update = (val) => editingLesson ? setEditingLesson({ ...editingLesson, content: val }) : setFormData({ ...formData, content: val });
                                            update(content + '\n\n{{WIDGET:CALCULATOR_ROI}}\n\n');
                                        }}
                                        className="px-2 py-1 bg-purple-50 border border-purple-200 text-purple-600 rounded hover:bg-purple-100 text-xs font-bold"
                                    >
                                        + ROI
                                    </button>
                                    <button
                                        onClick={() => {
                                            const content = editingLesson ? editingLesson.content : formData.content;
                                            const update = (val) => editingLesson ? setEditingLesson({ ...editingLesson, content: val }) : setFormData({ ...formData, content: val });
                                            update(content + '\n\n{{WIDGET:CALCULATOR_TAXES}}\n\n');
                                        }}
                                        className="px-2 py-1 bg-orange-50 border border-orange-200 text-orange-600 rounded hover:bg-orange-100 text-xs font-bold"
                                    >
                                        + Impuestos
                                    </button>
                                    <div className="w-px bg-slate-300 mx-2"></div>
                                    <button
                                        onClick={() => {
                                            const url = prompt("URL del video (Embed):");
                                            if (!url) return;
                                            const content = editingLesson ? editingLesson.content : formData.content;
                                            const update = (val) => editingLesson ? setEditingLesson({ ...editingLesson, content: val }) : setFormData({ ...formData, content: val });
                                            update(content + `\n\n{{VIDEO:${url}}}\n\n`);
                                        }}
                                        className="px-2 py-1 bg-red-50 border border-red-200 text-red-600 rounded hover:bg-red-100 text-xs font-bold"
                                    >
                                        + Video
                                    </button>
                                </div>

                                <textarea
                                    value={editingLesson ? editingLesson.content : formData.content}
                                    onChange={(e) => editingLesson
                                        ? setEditingLesson({ ...editingLesson, content: e.target.value })
                                        : setFormData({ ...formData, content: e.target.value })
                                    }
                                    placeholder="# T√≠tulo Principal&#10;&#10;## Subt√≠tulo&#10;&#10;Escribe tu contenido aqu√≠ usando Markdown..."
                                    rows="15"
                                    className="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono text-sm resize-none"
                                />
                                <p className="text-xs text-slate-500 mt-2">
                                    üí° Soporta Markdown: **negrita**, *cursiva*, listas, tablas, c√≥digo, etc.
                                </p>
                            </div>

                            <div className="flex gap-3 pt-4">
                                <button
                                    onClick={() => editingLesson ? handleUpdate(editingLesson.id) : handleCreate()}
                                    className="flex-1 flex items-center justify-center gap-2 px-6 py-3 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 font-bold shadow-lg transition"
                                >
                                    <Save className="w-5 h-5" />
                                    {editingLesson ? 'Guardar Cambios' : 'Crear Lecci√≥n'}
                                </button>
                                <button
                                    onClick={() => {
                                        setIsCreating(false);
                                        setEditingLesson(null);
                                    }}
                                    className="px-6 py-3 bg-slate-100 text-slate-700 rounded-xl hover:bg-slate-200 font-bold transition"
                                >
                                    Cancelar
                                </button>
                            </div>
                        </div>
                    ) : (
                        <div className="bg-slate-50 rounded-xl p-6 max-h-96 overflow-y-auto">
                            <h4 className="text-sm font-bold text-slate-600 mb-4 uppercase tracking-wider">
                                Preview del Contenido
                            </h4>
                            <div className="prose prose-slate max-w-none bg-white p-6 rounded-lg">
                                <ReactMarkdown>
                                    {editingLesson ? editingLesson.content : formData.content}
                                </ReactMarkdown>
                            </div>
                        </div>
                    )}
                </div>
            )}

            {/* Lessons List */}
            <div className="space-y-4">
                <h3 className="text-lg font-bold text-slate-700">
                    Lecciones del M√≥dulo ({lessons.length})
                </h3>

                {lessons.map((lesson, index) => (
                    <div
                        key={lesson.id}
                        className="bg-white rounded-2xl border-2 border-slate-200 p-6 hover:shadow-lg transition-shadow"
                    >
                        <div className="flex items-start justify-between">
                            <div className="flex-1">
                                <div className="flex items-center gap-3 mb-2">
                                    <GripVertical className="w-5 h-5 text-slate-400" />
                                    <span className="text-xs font-bold text-slate-500 uppercase tracking-wider">
                                        Lecci√≥n {lesson.order || index + 1}
                                    </span>
                                </div>
                                <h3 className="text-xl font-black text-slate-800 mb-2">
                                    {lesson.title}
                                </h3>
                                <p className="text-sm text-slate-600 line-clamp-2">
                                    {lesson.content ? lesson.content.substring(0, 150) + '...' : 'Sin contenido'}
                                </p>
                                <div className="mt-3 text-xs text-slate-500">
                                    {lesson.content ? lesson.content.length : 0} caracteres
                                </div>
                            </div>

                            <div className="flex gap-2">
                                <button
                                    onClick={() => setEditingLesson(lesson)}
                                    className="p-2 hover:bg-blue-50 text-blue-600 rounded-lg transition"
                                    title="Editar lecci√≥n"
                                >
                                    <Edit2 className="w-5 h-5" />
                                </button>
                                <button
                                    onClick={() => handleDelete(lesson.id, lesson.title)}
                                    className="p-2 hover:bg-rose-50 text-rose-600 rounded-lg transition"
                                    title="Eliminar lecci√≥n"
                                >
                                    <Trash2 className="w-5 h-5" />
                                </button>
                            </div>
                        </div>
                    </div>
                ))}
            </div>

            {/* Empty State */}
            {lessons.length === 0 && !isCreating && (
                <div className="text-center py-16">
                    <div className="text-6xl mb-4">üìù</div>
                    <h3 className="text-xl font-bold text-slate-600 mb-2">
                        No hay lecciones en este m√≥dulo
                    </h3>
                    <p className="text-slate-500 mb-6">
                        Crea tu primera lecci√≥n para empezar a construir el contenido
                    </p>
                    <button
                        onClick={() => setIsCreating(true)}
                        className="inline-flex items-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 font-bold shadow-lg transition"
                    >
                        <Plus className="w-5 h-5" />
                        Crear Primera Lecci√≥n
                    </button>
                </div>
            )}
        </div>
    );
};

export default LessonEditor;



================================================================================
FILE: src\components\Academy\ModuleViewer.jsx
================================================================================
import React, { useState, useEffect } from 'react';
import { ArrowLeft, ArrowRight, CheckCircle, BookOpen, Clock } from 'lucide-react';
import ReactMarkdown from 'react-markdown';
import { useModuleLessons, useMarkLessonComplete, useModuleQuiz } from '../../hooks/useAcademy';
import { useAuth } from '../../context/AuthContext';
import QuizEngine from './QuizEngine';
import CalculatorWidget from './CalculatorWidget'; // [NEW]

/**
 * Module Viewer - Vista de consumo de m√≥dulos para franquiciados
 * Muestra lecciones en formato markdown con navegaci√≥n
 */
const ModuleViewer = ({ module, onBack }) => {
    const { user } = useAuth();
    const { lessons, loading } = useModuleLessons(module.id);
    const { quiz } = useModuleQuiz(module.id);
    const markComplete = useMarkLessonComplete();

    const [currentLessonIndex, setCurrentLessonIndex] = useState(0);
    const [completedLessons, setCompletedLessons] = useState(new Set());
    const [showQuiz, setShowQuiz] = useState(false);

    // [NEW] Helper to render content with widgets
    const renderContentWithWidgets = (content) => {
        if (!content) return null;

        // Split by widget tags using regex capture group
        const parts = content.split(/({{WIDGET:[^}]+}}|{{VIDEO:[^}]+}})/g);

        return parts.map((part, index) => {
            if (part.startsWith('{{WIDGET:')) {
                const widgetType = part.replace('{{WIDGET:', '').replace('}}', '').toLowerCase();

                if (widgetType.startsWith('calculator_')) {
                    const calcType = widgetType.replace('calculator_', '');
                    return <CalculatorWidget key={index} type={calcType} />;
                }
                return null;
            }

            if (part.startsWith('{{VIDEO:')) {
                const videoUrl = part.replace('{{VIDEO:', '').replace('}}', '');
                return (
                    <div key={index} className="my-8 rounded-2xl overflow-hidden shadow-lg border-4 border-slate-900 aspect-video bg-black">
                        <iframe
                            src={videoUrl}
                            title="Video Lesson"
                            className="w-full h-full"
                            frameBorder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                            allowFullScreen
                        ></iframe>
                    </div>
                );
            }

            // Normal markdown content
            return <div key={index} className="prose prose-slate max-w-none mb-6">
                <ReactMarkdown
                    components={{
                        h1: ({ ...props }) => <h1 className="text-3xl font-black text-slate-800 mb-4" {...props} />,
                        h2: ({ ...props }) => <h2 className="text-2xl font-black text-slate-800 mb-3 mt-8" {...props} />,
                        h3: ({ ...props }) => <h3 className="text-xl font-bold text-slate-800 mb-2 mt-6" {...props} />,
                        p: ({ ...props }) => <p className="text-slate-700 leading-relaxed mb-4" {...props} />,
                        ul: ({ ...props }) => <ul className="list-disc pl-6 mb-4 space-y-2" {...props} />,
                        ol: ({ ...props }) => <ol className="list-decimal pl-6 mb-4 space-y-2" {...props} />,
                        li: ({ ...props }) => <li className="text-slate-700" {...props} />,
                        blockquote: ({ ...props }) => (
                            <blockquote className="border-l-4 border-blue-500 bg-blue-50 pl-4 py-2 my-4 italic text-slate-700" {...props} />
                        ),
                        code: ({ inline, ...props }) =>
                            inline
                                ? <code className="bg-slate-100 text-slate-800 px-1.5 py-0.5 rounded font-mono text-sm" {...props} />
                                : <code className="block bg-slate-900 text-slate-100 p-4 rounded-lg font-mono text-sm overflow-x-auto" {...props} />,
                        strong: ({ ...props }) => <strong className="font-bold text-slate-900" {...props} />,
                        a: ({ ...props }) => <a className="text-blue-600 hover:text-blue-700 underline font-medium" {...props} />
                    }}
                >
                    {part}
                </ReactMarkdown>
            </div>;
        });
    };

    const currentLesson = lessons[currentLessonIndex];
    const isFirstLesson = currentLessonIndex === 0;
    const isLastLesson = currentLessonIndex === lessons.length - 1;
    const allLessonsCompleted = completedLessons.size === lessons.length && lessons.length > 0;

    // Mostrar quiz cuando se completan todas las lecciones
    useEffect(() => {
        if (allLessonsCompleted && quiz && !showQuiz) {
            // Avoid synchronous state update
            const timer = setTimeout(() => setShowQuiz(true), 0);
            return () => clearTimeout(timer);
        }
    }, [allLessonsCompleted, quiz, showQuiz]);

    const handleMarkComplete = async () => {
        if (!currentLesson) return;

        try {
            await markComplete(user.uid, module.id, currentLesson.id);
            setCompletedLessons(prev => new Set([...prev, currentLesson.id]));

            // Auto-avanzar a la siguiente lecci√≥n
            if (!isLastLesson) {
                setCurrentLessonIndex(prev => prev + 1);
            }
        } catch (error) {
            console.error('Error marking lesson complete:', error);
        }
    };

    const handlePrevious = () => {
        if (!isFirstLesson) {
            setCurrentLessonIndex(prev => prev - 1);
        }
    };

    const handleNext = () => {
        if (!isLastLesson) {
            setCurrentLessonIndex(prev => prev + 1);
        }
    };

    if (loading) {
        return (
            <div className="flex items-center justify-center h-96">
                <div className="text-center">
                    <BookOpen className="w-12 h-12 mx-auto mb-4 text-blue-500 animate-pulse" />
                    <p className="text-slate-500 font-medium">Cargando lecciones...</p>
                </div>
            </div>
        );
    }

    if (lessons.length === 0) {
        return (
            <div className="p-8 max-w-4xl mx-auto">
                <button
                    onClick={onBack}
                    className="flex items-center gap-2 text-blue-600 hover:text-blue-700 font-bold mb-6 transition"
                >
                    <ArrowLeft className="w-5 h-5" />
                    Volver a m√≥dulos
                </button>

                <div className="bg-amber-50 border border-amber-200 rounded-2xl p-8 text-center">
                    <BookOpen className="w-16 h-16 mx-auto mb-4 text-amber-500" />
                    <h3 className="text-xl font-bold text-amber-900 mb-2">
                        Este m√≥dulo est√° en construcci√≥n
                    </h3>
                    <p className="text-amber-700">
                        Las lecciones se agregar√°n pronto
                    </p>
                </div>
            </div>
        );
    }

    // Si todas las lecciones est√°n completadas y hay quiz, mostrar el quiz
    if (showQuiz && quiz) {
        return (
            <QuizEngine
                quiz={quiz}
                module={module}
                onComplete={() => {
                    // Volver al dashboard cuando completa el quiz
                    onBack();
                }}
            />
        );
    }

    return (
        <div className="min-h-screen bg-slate-50">
            {/* Header */}
            {/* Header */}
            <div className="bg-white border-b border-slate-200 sticky top-0 z-10 shadow-sm">
                <div className="max-w-4xl mx-auto px-4 md:px-8 py-4">
                    <button
                        onClick={onBack}
                        className="flex items-center gap-2 text-slate-600 hover:text-slate-900 font-bold mb-3 transition"
                    >
                        <ArrowLeft className="w-5 h-5" />
                        Volver a m√≥dulos
                    </button>

                    <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div>
                            <div className="flex items-center gap-2 mb-1">
                                <span className="text-xs font-bold text-slate-500 uppercase tracking-wider">
                                    M√≥dulo {module.order}
                                </span>
                                {module.duration && (
                                    <span className="flex items-center text-xs text-slate-500">
                                        <Clock className="w-3 h-3 mr-1" />
                                        {module.duration}
                                    </span>
                                )}
                            </div>
                            <h1 className="text-xl md:text-2xl font-black text-slate-800">
                                {module.title}
                            </h1>
                        </div>

                        <div className="flex items-center justify-between md:block md:text-right">
                            <p className="text-xs text-slate-500 mb-1">Progreso</p>
                            <p className="text-2xl font-black text-blue-600">
                                {Math.round((completedLessons.size / lessons.length) * 100)}%
                            </p>
                        </div>
                    </div>

                    {/* Progress Bar */}
                    <div className="mt-4 bg-slate-200 rounded-full h-2 overflow-hidden">
                        <div
                            className="bg-blue-500 h-full transition-all duration-300"
                            style={{ width: `${(completedLessons.size / lessons.length) * 100}%` }}
                        />
                    </div>
                </div>
            </div>

            {/* Content */}
            <div className="max-w-4xl mx-auto px-4 md:px-8 py-8">
                {/* Lesson Header */}
                <div className="mb-8">
                    <div className="flex items-center gap-2 mb-2">
                        <span className="text-sm font-bold text-slate-500">
                            Lecci√≥n {currentLessonIndex + 1} de {lessons.length}
                        </span>
                        {completedLessons.has(currentLesson?.id) && (
                            <span className="flex items-center gap-1 text-xs font-bold text-emerald-600">
                                <CheckCircle className="w-4 h-4" />
                                Completada
                            </span>
                        )}
                    </div>
                    <h2 className="text-3xl font-black text-slate-800">
                        {currentLesson?.title}
                    </h2>
                </div>

                {/* Lesson Content */}
                <div className="bg-white rounded-2xl border border-slate-200 shadow-sm p-8 mb-8">
                    {/* [UPDATED] Render with Widgets */}
                    {renderContentWithWidgets(currentLesson?.content || '')}

                    {/* Resources */}
                    {currentLesson?.resources && currentLesson.resources.length > 0 && (
                        <div className="mt-8 pt-8 border-t border-slate-200">
                            <h4 className="text-lg font-bold text-slate-800 mb-4">üìé Recursos adicionales</h4>
                            <div className="space-y-2">
                                {currentLesson.resources.map((resource, index) => (
                                    <a
                                        key={index}
                                        href={resource.url}
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        className="block p-4 bg-slate-50 hover:bg-slate-100 rounded-xl transition font-medium text-slate-700 hover:text-blue-600"
                                    >
                                        üìÑ {resource.title}
                                    </a>
                                ))}
                            </div>
                        </div>
                    )}
                </div>

                {/* Navigation */}
                <div className="flex items-center justify-between gap-4">
                    <button
                        onClick={handlePrevious}
                        disabled={isFirstLesson}
                        className="flex items-center gap-2 px-6 py-3 bg-white border-2 border-slate-300 text-slate-700 rounded-xl hover:bg-slate-50 font-bold transition disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        <ArrowLeft className="w-5 h-5" />
                        Anterior
                    </button>

                    {!completedLessons.has(currentLesson?.id) && (
                        <button
                            onClick={handleMarkComplete}
                            className="flex items-center gap-2 px-6 py-3 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 font-bold shadow-lg transition"
                        >
                            <CheckCircle className="w-5 h-5" />
                            Marcar como completada
                        </button>
                    )}

                    <button
                        onClick={handleNext}
                        disabled={isLastLesson}
                        className="flex items-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 font-bold shadow-lg transition disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        Siguiente
                        <ArrowRight className="w-5 h-5" />
                    </button>
                </div>

                {/* Completion Status */}
                {isLastLesson && completedLessons.size === lessons.length && (
                    <div className="mt-8 bg-emerald-50 border-2 border-emerald-200 rounded-2xl p-6 text-center">
                        <CheckCircle className="w-12 h-12 mx-auto mb-3 text-emerald-600" />
                        <h3 className="text-xl font-black text-emerald-900 mb-2">
                            üéâ ¬°M√≥dulo completado!
                        </h3>
                        <p className="text-emerald-700">
                            Has terminado todas las lecciones de este m√≥dulo
                        </p>
                    </div>
                )}
            </div>
        </div>
    );
};

export default ModuleViewer;



================================================================================
FILE: src\components\Academy\QuizEditor.jsx
================================================================================
import React, { useState, useEffect } from 'react';
import { Save, Plus, Trash2, X, CheckCircle } from 'lucide-react';
import { useModuleQuiz, useSaveQuiz, useDeleteQuiz } from '../../hooks/useAcademy';

/**
 * Editor de Quizzes para Admin
 * Permite crear evaluaciones con preguntas de opci√≥n m√∫ltiple
 */
const QuizEditor = ({ module, onBack }) => {
    const { quiz, loading } = useModuleQuiz(module.id);
    const saveQuiz = useSaveQuiz();
    const deleteQuiz = useDeleteQuiz();

    const [questions, setQuestions] = useState([]);
    const [currentQuestion, setCurrentQuestion] = useState({
        type: 'multiple-choice', // 'multiple-choice', 'true-false', 'multi-select'
        question: '',
        options: ['', '', '', ''],
        correctAnswer: 0, // For multiple-choice and true-false
        correctAnswers: [] // For multi-select (array of indices)
    });

    // Sync quiz data when it loads from Firestore
    useEffect(() => {
        if (quiz?.questions) {
            const timer = setTimeout(() => {
                setQuestions(quiz.questions);
            }, 0);
            return () => clearTimeout(timer);
        }
    }, [quiz]);

    const handleAddQuestion = () => {
        // Validaci√≥n seg√∫n tipo de pregunta
        if (!currentQuestion.question.trim()) {
            alert('Por favor completa la pregunta');
            return;
        }

        // Validar seg√∫n tipo
        if (currentQuestion.type === 'multiple-choice' || currentQuestion.type === 'multi-select') {
            if (currentQuestion.options.some(o => !o.trim())) {
                alert('Por favor completa todas las opciones');
                return;
            }
        }

        if (currentQuestion.type === 'multi-select' && currentQuestion.correctAnswers.length === 0) {
            alert('Por favor selecciona al menos una respuesta correcta');
            return;
        }

        setQuestions([...questions, currentQuestion]);

        // Reset seg√∫n tipo
        const resetState = {
            type: currentQuestion.type, // Mantener el tipo seleccionado
            question: '',
            correctAnswer: 0,
            correctAnswers: []
        };

        // Resetear opciones seg√∫n tipo
        if (currentQuestion.type === 'true-false') {
            resetState.options = ['Verdadero', 'Falso'];
        } else {
            resetState.options = ['', '', '', ''];
        }

        setCurrentQuestion(resetState);
    };

    const handleRemoveQuestion = (index) => {
        setQuestions(questions.filter((_, i) => i !== index));
    };

    const handleSave = async () => {
        if (questions.length === 0) {
            alert('Agrega al menos una pregunta');
            return;
        }

        try {
            await saveQuiz(module.id, {
                questions,
                passingScore: 80,
                title: `Evaluaci√≥n: ${module.title}`
            });
            alert('‚úÖ Quiz guardado con √©xito');
        } catch (error) {
            console.error('Error saving quiz:', error);
            alert('Error al guardar el quiz');
        }
    };

    const handleDelete = async () => {
        if (!quiz || !confirm('¬øSeguro que quieres eliminar este quiz?')) {
            return;
        }

        try {
            await deleteQuiz(quiz.id);
            setQuestions([]);
            alert('‚úÖ Quiz eliminado');
        } catch (error) {
            console.error('Error deleting quiz:', error);
            alert('Error al eliminar el quiz');
        }
    };

    if (loading) {
        return (
            <div className="flex items-center justify-center h-96">
                <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
            </div>
        );
    }

    return (
        <div className="p-8 max-w-4xl mx-auto space-y-6">
            {/* Header */}
            <div className="flex items-center justify-between">
                <div>
                    <button
                        onClick={onBack}
                        className="text-blue-600 hover:text-blue-700 font-bold mb-4"
                    >
                        ‚Üê Volver
                    </button>
                    <h1 className="text-3xl font-black text-slate-800">
                        Editor de Quiz
                    </h1>
                    <p className="text-slate-500">
                        M√≥dulo: <span className="font-bold">{module.title}</span>
                    </p>
                </div>
                <div className="flex gap-3">
                    {quiz && (
                        <button
                            onClick={handleDelete}
                            className="px-4 py-2 bg-rose-100 text-rose-700 rounded-lg hover:bg-rose-200 font-bold"
                        >
                            Eliminar Quiz
                        </button>
                    )}
                    <button
                        onClick={handleSave}
                        className="flex items-center gap-2 px-6 py-3 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 font-bold shadow-lg"
                    >
                        <Save className="w-5 h-5" />
                        Guardar Quiz
                    </button>
                </div>
            </div>

            {/* Add Question Form */}
            <div className="bg-white rounded-xl border-2 border-blue-200 p-6">
                <h3 className="text-lg font-bold text-slate-800 mb-4">
                    Agregar Nueva Pregunta
                </h3>

                <div className="space-y-4">
                    {/* Type Selector */}
                    <div>
                        <label className="block text-sm font-bold text-slate-700 mb-2">
                            Tipo de Pregunta
                        </label>
                        <select
                            value={currentQuestion.type}
                            onChange={(e) => {
                                const newType = e.target.value;
                                const newState = {
                                    ...currentQuestion,
                                    type: newType,
                                    correctAnswers: []
                                };

                                // Cambiar opciones seg√∫n tipo
                                if (newType === 'true-false') {
                                    newState.options = ['Verdadero', 'Falso'];
                                    newState.correctAnswer = 0;
                                } else if (newType === 'multiple-choice' || newType === 'multi-select') {
                                    if (currentQuestion.type === 'true-false') {
                                        newState.options = ['', '', '', ''];
                                    }
                                }

                                setCurrentQuestion(newState);
                            }}
                            className="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500 font-medium"
                        >
                            <option value="multiple-choice">Opci√≥n M√∫ltiple (1 correcta)</option>
                            <option value="true-false">Verdadero/Falso</option>
                            <option value="multi-select">Selecci√≥n M√∫ltiple (varias correctas)</option>
                        </select>
                        <p className="text-xs text-slate-500 mt-1">
                            {currentQuestion.type === 'multiple-choice' && '4 opciones, 1 respuesta correcta'}
                            {currentQuestion.type === 'true-false' && '2 opciones predefinidas'}
                            {currentQuestion.type === 'multi-select' && '4 opciones, m√∫ltiples respuestas correctas'}
                        </p>
                    </div>

                    {/* Question Input */}
                    <div>
                        <label className="block text-sm font-bold text-slate-700 mb-2">
                            Pregunta *
                        </label>
                        <input
                            type="text"
                            value={currentQuestion.question}
                            onChange={(e) => setCurrentQuestion({ ...currentQuestion, question: e.target.value })}
                            placeholder={
                                currentQuestion.type === 'true-false'
                                    ? '¬øEl m√≥dulo de facturaci√≥n es obligatorio?'
                                    : '¬øCu√°l es la tarifa de Zona A?'
                            }
                            className="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500"
                        />
                    </div>

                    {/* Options - Conditional Rendering */}
                    <div>
                        <label className="block text-sm font-bold text-slate-700 mb-2">
                            {currentQuestion.type === 'true-false' ? 'Respuesta Correcta' : 'Opciones de Respuesta'}
                        </label>

                        {currentQuestion.type === 'true-false' ? (
                            // True/False - Radio buttons only
                            <div className="space-y-2">
                                {currentQuestion.options.map((option, index) => (
                                    <div key={index} className="flex items-center gap-3 p-3 border-2 rounded-lg hover:bg-slate-50 cursor-pointer"
                                        onClick={() => setCurrentQuestion({ ...currentQuestion, correctAnswer: index })}
                                    >
                                        <input
                                            type="radio"
                                            checked={currentQuestion.correctAnswer === index}
                                            onChange={() => setCurrentQuestion({ ...currentQuestion, correctAnswer: index })}
                                            className="w-5 h-5"
                                        />
                                        <span className="font-medium text-slate-700">{option}</span>
                                        {currentQuestion.correctAnswer === index && (
                                            <CheckCircle className="w-5 h-5 text-emerald-500 ml-auto" />
                                        )}
                                    </div>
                                ))}
                            </div>
                        ) : currentQuestion.type === 'multi-select' ? (
                            // Multi-Select - Checkboxes
                            <div className="space-y-2">
                                {currentQuestion.options.map((option, index) => (
                                    <div key={index} className="flex items-center gap-3 mb-2">
                                        <input
                                            type="checkbox"
                                            checked={currentQuestion.correctAnswers.includes(index)}
                                            onChange={(e) => {
                                                let newCorrect = [...currentQuestion.correctAnswers];
                                                if (e.target.checked) {
                                                    newCorrect.push(index);
                                                } else {
                                                    newCorrect = newCorrect.filter(i => i !== index);
                                                }
                                                setCurrentQuestion({ ...currentQuestion, correctAnswers: newCorrect });
                                            }}
                                            className="w-5 h-5"
                                        />
                                        <input
                                            type="text"
                                            value={option}
                                            onChange={(e) => {
                                                const newOptions = [...currentQuestion.options];
                                                newOptions[index] = e.target.value;
                                                setCurrentQuestion({ ...currentQuestion, options: newOptions });
                                            }}
                                            placeholder={`Opci√≥n ${index + 1}`}
                                            className="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                        />
                                        {currentQuestion.correctAnswers.includes(index) && (
                                            <CheckCircle className="w-5 h-5 text-emerald-500" />
                                        )}
                                    </div>
                                ))}
                                <p className="text-xs text-slate-500 mt-2">
                                    Marca las casillas de TODAS las respuestas correctas
                                </p>
                            </div>
                        ) : (
                            // Multiple Choice - Radio buttons + text inputs
                            <div className="space-y-2">
                                {currentQuestion.options.map((option, index) => (
                                    <div key={index} className="flex items-center gap-3 mb-2">
                                        <input
                                            type="radio"
                                            checked={currentQuestion.correctAnswer === index}
                                            onChange={() => setCurrentQuestion({ ...currentQuestion, correctAnswer: index })}
                                            className="w-5 h-5"
                                        />
                                        <input
                                            type="text"
                                            value={option}
                                            onChange={(e) => {
                                                const newOptions = [...currentQuestion.options];
                                                newOptions[index] = e.target.value;
                                                setCurrentQuestion({ ...currentQuestion, options: newOptions });
                                            }}
                                            placeholder={`Opci√≥n ${index + 1}`}
                                            className="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                        />
                                        {currentQuestion.correctAnswer === index && (
                                            <CheckCircle className="w-5 h-5 text-emerald-500" />
                                        )}
                                    </div>
                                ))}
                                <p className="text-xs text-slate-500 mt-2">
                                    Marca el c√≠rculo de la respuesta correcta
                                </p>
                            </div>
                        )}
                    </div>

                    <button
                        onClick={handleAddQuestion}
                        className="w-full flex items-center justify-center gap-2 px-4 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 font-bold"
                    >
                        <Plus className="w-5 h-5" />
                        Agregar Pregunta
                    </button>
                </div>
            </div>

            {/* Questions List */}
            <div className="space-y-4">
                <h3 className="text-lg font-bold text-slate-700">
                    Preguntas del Quiz ({questions.length})
                </h3>

                {questions.map((q, index) => (
                    <div key={index} className="bg-white rounded-xl border-2 border-slate-200 p-6">
                        <div className="flex items-start justify-between">
                            <div className="flex-1">
                                <div className="flex items-center gap-2 mb-2">
                                    <span className="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-bold">
                                        Pregunta {index + 1}
                                    </span>
                                    <span className={`px-3 py-1 rounded-full text-xs font-bold ${q.type === 'true-false' ? 'bg-purple-100 text-purple-700' :
                                        q.type === 'multi-select' ? 'bg-orange-100 text-orange-700' :
                                            'bg-teal-100 text-teal-700'
                                        }`}>
                                        {q.type === 'true-false' ? 'V/F' :
                                            q.type === 'multi-select' ? 'Multi' :
                                                '√önica'}
                                    </span>
                                </div>
                                <h4 className="text-lg font-bold text-slate-800 mb-3">
                                    {q.question}
                                </h4>
                                <div className="space-y-2">
                                    {q.options.map((option, optIndex) => {
                                        // Para multi-select, verificar si est√° en correctAnswers
                                        const isCorrect = q.type === 'multi-select'
                                            ? q.correctAnswers?.includes(optIndex)
                                            : optIndex === q.correctAnswer;

                                        return (
                                            <div
                                                key={optIndex}
                                                className={`flex items-center gap-2 px-4 py-2 rounded-lg ${isCorrect
                                                    ? 'bg-emerald-50 border-2 border-emerald-500'
                                                    : 'bg-slate-50'
                                                    }`}
                                            >
                                                <span className="font-bold text-slate-600">
                                                    {String.fromCharCode(65 + optIndex)}.
                                                </span>
                                                <span className={isCorrect ? 'font-bold text-emerald-700' : ''}>
                                                    {option}
                                                </span>
                                                {isCorrect && (
                                                    <CheckCircle className="w-4 h-4 text-emerald-500 ml-auto" />
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                            <button
                                onClick={() => handleRemoveQuestion(index)}
                                className="p-2 hover:bg-rose-50 text-rose-600 rounded-lg"
                            >
                                <Trash2 className="w-5 h-5" />
                            </button>
                        </div>
                    </div>
                ))}

                {questions.length === 0 && (
                    <div className="text-center py-12">
                        <p className="text-slate-500">No hay preguntas a√∫n. Agrega la primera pregunta arriba.</p>
                    </div>
                )}
            </div>
        </div>
    );
};

export default QuizEditor;



================================================================================
FILE: src\components\Academy\QuizEngine.jsx
================================================================================
import React, { useState } from 'react';
import { CheckCircle, XCircle, Award, RotateCcw } from 'lucide-react';
import { useSaveQuizResult } from '../../hooks/useAcademy';
import { useAuth } from '../../context/AuthContext';
import QuizResults from './QuizResults';

/**
 * Quiz Engine - Motor de evaluaci√≥n para estudiantes
 * Muestra preguntas, valida respuestas y guarda resultados
 */
const QuizEngine = ({ quiz, module, onComplete }) => {
    const { user } = useAuth();
    const saveQuizResult = useSaveQuizResult();

    const [currentQuestion, setCurrentQuestion] = useState(0);
    const [answers, setAnswers] = useState({}); // For single-choice: number, for multi-select: array
    const [showResults, setShowResults] = useState(false);
    const [score, setScore] = useState(0);

    // Handle para respuesta √∫nica (multiple-choice y true-false)
    const handleSingleAnswer = (questionIndex, answerIndex) => {
        setAnswers({
            ...answers,
            [questionIndex]: answerIndex
        });
    };

    // Handle para respuesta m√∫ltiple (multi-select)
    const handleMultiAnswer = (questionIndex, answerIndex) => {
        const currentAnswers = answers[questionIndex] || [];
        let newAnswers;

        if (currentAnswers.includes(answerIndex)) {
            newAnswers = currentAnswers.filter(a => a !== answerIndex);
        } else {
            newAnswers = [...currentAnswers, answerIndex];
        }

        setAnswers({
            ...answers,
            [questionIndex]: newAnswers
        });
    };

    const handleSubmit = async () => {
        // Calcular puntuaci√≥n
        let correct = 0;
        quiz.questions.forEach((q, index) => {
            const userAnswer = answers[index];

            if (q.type === 'multi-select') {
                // Para multi-select, comparar arrays
                const correctAnswers = q.correctAnswers || [];
                const userAnswers = userAnswer || [];

                // Correcta si tiene todas las correctas y ninguna incorrecta
                const hasAllCorrect = correctAnswers.every(a => userAnswers.includes(a));
                const hasNoIncorrect = userAnswers.every(a => correctAnswers.includes(a));

                if (hasAllCorrect && hasNoIncorrect && userAnswers.length > 0) {
                    correct++;
                }
            } else {
                // Para single-choice y true-false
                if (userAnswer === q.correctAnswer) {
                    correct++;
                }
            }
        });

        const finalScore = Math.round((correct / quiz.questions.length) * 100);
        setScore(finalScore);
        setShowResults(true);

        // Guardar resultado
        try {
            await saveQuizResult(user.uid, module.id, finalScore, answers);

            if (finalScore >= 80) {
                setTimeout(() => {
                    if (onComplete) onComplete(finalScore);
                }, 3000);
            }
        } catch (error) {
            console.error('Error saving quiz result:', error);
        }
    };

    const handleRetry = () => {
        setCurrentQuestion(0);
        setAnswers({});
        setShowResults(false);
        setScore(0);
    };

    const allAnswered = quiz.questions.every((q, index) => {
        const answer = answers[index];
        if (q.type === 'multi-select') {
            // Para multi-select, verificar que hay al menos una respuesta
            return Array.isArray(answer) && answer.length > 0;
        }
        // Para single-choice y true-false
        return answer !== undefined;
    });

    if (showResults) {
        return (
            <QuizResults
                quiz={quiz}
                answers={answers}
                score={score}
                onRetry={handleRetry}
                onComplete={() => onComplete && onComplete(score)}
            />
        );
    }

    const question = quiz.questions[currentQuestion];

    return (
        <div className="max-w-2xl mx-auto p-8">
            {/* Progress Bar */}
            <div className="mb-8">
                <div className="flex items-center justify-between mb-2">
                    <span className="text-sm font-bold text-slate-600">
                        Pregunta {currentQuestion + 1} de {quiz.questions.length}
                    </span>
                    <span className="text-sm text-slate-500">
                        {Object.keys(answers).length}/{quiz.questions.length} respondidas
                    </span>
                </div>
                <div className="h-2 bg-slate-200 rounded-full overflow-hidden">
                    <div
                        className="h-full bg-blue-500 transition-all duration-300"
                        style={{ width: `${((currentQuestion + 1) / quiz.questions.length) * 100}%` }}
                    ></div>
                </div>
            </div>

            {/* Question */}
            <div className="bg-white rounded-2xl border-2 border-slate-200 p-8 mb-6">
                {/* Question Type Badge */}
                <div className="flex items-center gap-2 mb-4">
                    <span className={`px-3 py-1 rounded-full text-xs font-bold ${question.type === 'true-false' ? 'bg-purple-100 text-purple-700' :
                        question.type === 'multi-select' ? 'bg-orange-100 text-orange-700' :
                            'bg-teal-100 text-teal-700'
                        }`}>
                        {question.type === 'true-false' ? 'Verdadero/Falso' :
                            question.type === 'multi-select' ? 'Selecci√≥n M√∫ltiple' :
                                'Opci√≥n M√∫ltiple'}
                    </span>
                    {question.type === 'multi-select' && (
                        <span className="text-xs text-slate-500">
                            Selecciona todas las correctas
                        </span>
                    )}
                </div>

                <h2 className="text-2xl font-black text-slate-800 mb-6">
                    {question.question}
                </h2>

                <div className="space-y-3">
                    {question.type === 'multi-select' ? (
                        // Multi-Select - Checkboxes
                        question.options.map((option, index) => {
                            const userAnswers = answers[currentQuestion] || [];
                            const isSelected = userAnswers.includes(index);

                            return (
                                <button
                                    key={index}
                                    onClick={() => handleMultiAnswer(currentQuestion, index)}
                                    className={`w-full text-left px-6 py-4 rounded-xl border-2 font-medium transition-all ${isSelected
                                        ? 'border-blue-500 bg-blue-50 text-blue-700'
                                        : 'border-slate-200 hover:border-blue-300 hover:bg-slate-50'
                                        }`}
                                >
                                    <div className="flex items-center gap-3">
                                        <div className={`w-6 h-6 rounded border-2 flex items-center justify-center ${isSelected
                                            ? 'border-blue-500 bg-blue-500'
                                            : 'border-slate-300'
                                            }`}>
                                            {isSelected && (
                                                <CheckCircle className="w-4 h-4 text-white" />
                                            )}
                                        </div>
                                        <span className="font-bold text-slate-600 mr-2">
                                            {String.fromCharCode(65 + index)}.
                                        </span>
                                        <span>{option}</span>
                                    </div>
                                </button>
                            );
                        })
                    ) : (
                        // Single-Choice - Radio buttons
                        question.options.map((option, index) => {
                            const isSelected = answers[currentQuestion] === index;

                            return (
                                <button
                                    key={index}
                                    onClick={() => handleSingleAnswer(currentQuestion, index)}
                                    className={`w-full text-left px-6 py-4 rounded-xl border-2 font-medium transition-all ${isSelected
                                        ? 'border-blue-500 bg-blue-50 text-blue-700'
                                        : 'border-slate-200 hover:border-blue-300 hover:bg-slate-50'
                                        }`}
                                >
                                    <div className="flex items-center gap-3">
                                        <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${isSelected
                                            ? 'border-blue-500 bg-blue-500'
                                            : 'border-slate-300'
                                            }`}>
                                            {isSelected && (
                                                <div className="w-3 h-3 bg-white rounded-full"></div>
                                            )}
                                        </div>
                                        <span className="font-bold text-slate-600 mr-2">
                                            {String.fromCharCode(65 + index)}.
                                        </span>
                                        <span>{option}</span>
                                    </div>
                                </button>
                            );
                        })
                    )}
                </div>
            </div>

            {/* Navigation */}
            <div className="flex items-center justify-between">
                <button
                    onClick={() => setCurrentQuestion(Math.max(0, currentQuestion - 1))}
                    disabled={currentQuestion === 0}
                    className="px-6 py-3 bg-slate-100 text-slate-700 rounded-xl hover:bg-slate-200 font-bold disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    ‚Üê Anterior
                </button>

                {currentQuestion === quiz.questions.length - 1 ? (
                    <button
                        onClick={handleSubmit}
                        disabled={!allAnswered}
                        className="flex items-center gap-2 px-6 py-3 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 font-bold shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        <Award className="w-5 h-5" />
                        Finalizar Quiz
                    </button>
                ) : (
                    <button
                        onClick={() => setCurrentQuestion(Math.min(quiz.questions.length - 1, currentQuestion + 1))}
                        disabled={answers[currentQuestion] === undefined}
                        className="px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 font-bold disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        Siguiente ‚Üí
                    </button>
                )}
            </div>
        </div>
    );
};

export default QuizEngine;



================================================================================
FILE: src\components\Academy\QuizResults.jsx
================================================================================
import React, { useEffect, useState } from 'react';
import { Trophy, CheckCircle, XCircle, ArrowRight, RotateCcw, TrendingUp } from 'lucide-react';

/**
 * QuizResults - Pantalla de resultados mejorada con animaciones
 * Muestra puntuaci√≥n, feedback y desglose de respuestas
 */
const QuizResults = ({ quiz, answers, score, onRetry, onComplete }) => {
    const [showConfetti, setShowConfetti] = useState(false);
    const passed = score >= (quiz.passingScore || 80);

    const [confettiPieces, setConfettiPieces] = useState([]);

    useEffect(() => {
        if (passed) {
            // Generate deterministic confetti for this run
            const pieces = [...Array(50)].map((_, i) => ({
                id: i,
                left: Math.random() * 100,
                delay: Math.random() * 3,
                color: ['#f59e0b', '#3b82f6', '#10b981', '#ef4444', '#8b5cf6'][Math.floor(Math.random() * 5)]
            }));
            const timer = setTimeout(() => {
                setConfettiPieces(pieces);
                setShowConfetti(true);
            }, 0);

            const hideTimer = setTimeout(() => setShowConfetti(false), 3000);
            return () => { clearTimeout(timer); clearTimeout(hideTimer); };
        }
    }, [passed]);

    // Calculate breakdown and stats
    const breakdown = React.useMemo(() => {
        return quiz.questions.map((q, index) => {
            const userAnswer = answers[index];
            let isCorrect = false;
            let userAnswerText = '';
            let correctAnswerText = '';

            if (q.type === 'multi-select') {
                const correctAnswers = q.correctAnswers || [];
                const userAnswers = userAnswer || [];

                const hasAllCorrect = correctAnswers.every(a => userAnswers.includes(a));
                const hasNoIncorrect = userAnswers.every(a => correctAnswers.includes(a));
                isCorrect = hasAllCorrect && hasNoIncorrect && userAnswers.length > 0;

                userAnswerText = userAnswers.map(i => q.options[i]).join(', ');
                correctAnswerText = correctAnswers.map(i => q.options[i]).join(', ');
            } else {
                isCorrect = userAnswer === q.correctAnswer;
                userAnswerText = (userAnswer !== undefined && q.options[userAnswer]) ? q.options[userAnswer] : '---';
                correctAnswerText = q.options[q.correctAnswer];
            }

            return {
                question: q.question,
                isCorrect,
                userAnswer: userAnswerText,
                correctAnswer: correctAnswerText
            };
        });
    }, [quiz, answers]);

    const correctCount = breakdown.filter(i => i.isCorrect).length;
    const incorrectCount = breakdown.length - correctCount;

    // ... (rest of code) ...

    return (
        <>
            {/* Confetti Animation */}
            {showConfetti && (
                <div className="fixed inset-0 pointer-events-none z-50">
                    <div className="confetti-container">
                        {confettiPieces.map((piece) => (
                            <div
                                key={piece.id}
                                className="confetti"
                                style={{
                                    left: `${piece.left}%`,
                                    animationDelay: `${piece.delay}s`,
                                    backgroundColor: piece.color
                                }}
                            />
                        ))}
                    </div>
                </div>
            )}

            <div className="max-w-4xl mx-auto space-y-8 animate-fade-in">
                {/* Header Card */}
                <div className={`bg-white rounded-3xl shadow-2xl p-12 text-center transform transition-all duration-500 ${passed ? 'border-4 border-emerald-400' : 'border-4 border-rose-400'
                    } hover:scale-105`}>
                    {/* Icon */}
                    <div className="mb-6 flex justify-center">
                        {passed ? (
                            <div className="w-32 h-32 bg-emerald-100 rounded-full flex items-center justify-center animate-bounce-slow">
                                <Trophy className="w-20 h-20 text-emerald-600" />
                            </div>
                        ) : (
                            <div className="w-32 h-32 bg-rose-100 rounded-full flex items-center justify-center animate-pulse">
                                <RotateCcw className="w-20 h-20 text-rose-600" />
                            </div>
                        )}
                    </div>

                    {/* Title */}
                    <h1 className={`text-5xl font-black mb-4 ${passed ? 'text-emerald-600' : 'text-rose-600'
                        }`}>
                        {passed ? '¬°Felicidades!' : 'No Aprobado'}
                    </h1>

                    {/* Score */}
                    <div className="mb-6">
                        <div className="text-8xl font-black bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                            {score}%
                        </div>
                        <p className="text-xl text-slate-600 mt-2">
                            {correctCount} de {quiz.questions.length} correctas
                        </p>
                    </div>

                    {/* Message */}
                    <p className="text-lg text-slate-600 max-w-2xl mx-auto mb-8">
                        {passed
                            ? '¬°Has completado el m√≥dulo con √©xito! Tu conocimiento ha sido validado.'
                            : `Necesitas al menos ${quiz.passingScore || 80}% para aprobar. ¬°No te rindas, int√©ntalo de nuevo!`
                        }
                    </p>

                    {/* Stats Summary */}
                    <div className="grid grid-cols-2 gap-6 max-w-md mx-auto">
                        <div className="bg-emerald-50 rounded-2xl p-6 border-2 border-emerald-200">
                            <CheckCircle className="w-8 h-8 text-emerald-600 mx-auto mb-2" />
                            <div className="text-3xl font-bold text-emerald-600">{correctCount}</div>
                            <div className="text-sm text-emerald-700">Correctas</div>
                        </div>
                        <div className="bg-rose-50 rounded-2xl p-6 border-2 border-rose-200">
                            <XCircle className="w-8 h-8 text-rose-600 mx-auto mb-2" />
                            <div className="text-3xl font-bold text-rose-600">{incorrectCount}</div>
                            <div className="text-sm text-rose-700">Incorrectas</div>
                        </div>
                    </div>
                </div>

                {/* Breakdown Card */}
                <div className="bg-white rounded-3xl shadow-xl p-8">
                    <h2 className="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-3">
                        <TrendingUp className="w-7 h-7 text-blue-600" />
                        Desglose Detallado
                    </h2>

                    <div className="space-y-4">
                        {breakdown.map((item, index) => (
                            <div
                                key={index}
                                className={`p-6 rounded-2xl border-2 transition-all hover:shadow-md ${item.isCorrect
                                    ? 'bg-emerald-50 border-emerald-300'
                                    : 'bg-rose-50 border-rose-300'
                                    }`}
                            >
                                <div className="flex items-start gap-4">
                                    {item.isCorrect ? (
                                        <CheckCircle className="w-6 h-6 text-emerald-600 flex-shrink-0 mt-1" />
                                    ) : (
                                        <XCircle className="w-6 h-6 text-rose-600 flex-shrink-0 mt-1" />
                                    )}
                                    <div className="flex-1">
                                        <h3 className="font-bold text-slate-800 mb-3">
                                            Pregunta {index + 1}: {item.question}
                                        </h3>
                                        <div className="space-y-2">
                                            <div className={`flex items-center gap-2 ${item.isCorrect ? 'text-emerald-700' : 'text-rose-700'
                                                }`}>
                                                <span className="font-semibold">Tu respuesta:</span>
                                                <span>{item.userAnswer}</span>
                                            </div>
                                            {!item.isCorrect && (
                                                <div className="flex items-center gap-2 text-emerald-700">
                                                    <span className="font-semibold">Respuesta correcta:</span>
                                                    <span className="font-bold">{item.correctAnswer}</span>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>

                {/* Actions */}
                <div className="flex gap-4 justify-center">
                    {!passed && onRetry && (
                        <button
                            onClick={onRetry}
                            className="flex items-center gap-3 px-8 py-4 bg-blue-600 text-white rounded-2xl hover:bg-blue-700 font-bold text-lg shadow-lg hover:shadow-xl transition-all transform hover:scale-105"
                        >
                            <RotateCcw className="w-6 h-6" />
                            Reintentar Quiz
                        </button>
                    )}
                    <button
                        onClick={onComplete}
                        className={`flex items-center gap-3 px-8 py-4 rounded-2xl font-bold text-lg shadow-lg hover:shadow-xl transition-all transform hover:scale-105 ${passed
                            ? 'bg-emerald-600 text-white hover:bg-emerald-700'
                            : 'bg-slate-200 text-slate-700 hover:bg-slate-300'
                            }`}
                    >
                        {passed ? 'Continuar' : 'Volver'}
                        <ArrowRight className="w-6 h-6" />
                    </button>
                </div>

                {/* Progress Saved Message */}
                {passed && (
                    <div className="text-center">
                        <p className="text-emerald-600 font-bold text-lg animate-pulse">
                            ‚úÖ Progreso guardado - Siguiente m√≥dulo desbloqueado
                        </p>
                    </div>
                )}
            </div>

            {/* CSS for Confetti */}
            <style jsx>{`
                @keyframes confetti-fall {
                    to {
                        transform: translateY(100vh) rotate(360deg);
                    }
                }

                @keyframes fade-in {
                    from {
                        opacity: 0;
                        transform: translateY(20px);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }

                @keyframes bounce-slow {
                    0%, 100% {
                        transform: translateY(0);
                    }
                    50% {
                        transform: translateY(-20px);
                    }
                }

                .confetti {
                    position: absolute;
                    width: 10px;
                    height: 10px;
                    top: -10px;
                    animation: confetti-fall 3s linear infinite;
                }

                .animate-fade-in {
                    animation: fade-in 0.6s ease-out;
                }

                .animate-bounce-slow {
                    animation: bounce-slow 2s ease-in-out infinite;
                }
            `}</style>
        </>
    );

};

export default QuizResults;



================================================================================
FILE: src\components\admin\dashboard\AdminHero.jsx
================================================================================
import React from 'react';
import { DollarSign, Calculator, Store, Plus, Users2, Activity } from 'lucide-react';

const AdminHero = ({
    stats,
    selectedMonth,
    onMonthChange,
    onManageTariffs,
    onOpenSimulator,
    onNavigate
}) => {
    console.log('DEBUG: AdminHero mounted');
    return (
        <div className="relative rounded-3xl bg-gradient-to-br from-blue-900 to-blue-800 p-6 md:p-10 shadow-2xl text-white overflow-hidden border border-blue-500/20">
            <div className="relative z-10 flex flex-col md:flex-row justify-between items-start md:items-end">
                <div className="space-y-4">
                    <h2 className="text-2xl md:text-3xl lg:text-4xl font-black tracking-tight mb-2 text-white drop-shadow-lg">
                        DASHBOARD REPAART
                    </h2>
                    <div className="flex space-x-6 text-blue-200 text-sm font-medium items-center">
                        <button
                            onClick={onManageTariffs}
                            className="flex items-center bg-blue-500/20 hover:bg-blue-500/40 text-blue-100 px-3 py-1.5 rounded-lg border border-blue-400/30 transition-all text-xs font-bold uppercase tracking-wider"
                        >
                            <DollarSign className="w-4 h-4 mr-2" />
                            Tarifas
                        </button>
                        <button
                            onClick={onOpenSimulator}
                            className="flex items-center bg-indigo-500/20 hover:bg-indigo-500/40 text-indigo-100 px-3 py-1.5 rounded-lg border border-indigo-400/30 transition-all text-xs font-bold uppercase tracking-wider"
                        >
                            <Calculator className="w-4 h-4 mr-2" />
                            Simulador
                        </button>
                        <span className="flex items-center"><Store className="w-4 h-4 mr-2 opacity-70" /> {stats?.franchiseCount || 0} Franquicias</span>
                        <button
                            onClick={() => onNavigate('onboarding')}
                            className="flex items-center bg-emerald-500/20 hover:bg-emerald-500/40 text-emerald-100 px-3 py-1.5 rounded-lg border border-emerald-400/30 transition-all text-xs font-bold uppercase tracking-wider"
                        >
                            <Plus className="w-4 h-4 mr-1" />
                            Nueva
                        </button>
                        <button
                            onClick={() => onNavigate('permissions')}
                            className="flex items-center bg-purple-500/20 hover:bg-purple-500/40 text-purple-100 px-3 py-1.5 rounded-lg border border-purple-400/30 transition-all text-xs font-bold uppercase tracking-wider"
                        >
                            <Users2 className="w-4 h-4 mr-1" />
                            Permisos
                        </button>
                        <div className="flex items-center bg-blue-800/50 rounded-lg p-1 border border-blue-500/30">
                            <Activity className="w-4 h-4 mr-2 opacity-70 ml-2" />
                            <input
                                type="month"
                                value={selectedMonth}
                                onChange={(e) => onMonthChange(e.target.value)}
                                className="bg-transparent text-white font-bold outline-none border-none text-sm uppercase cursor-pointer"
                            />
                        </div>
                    </div>
                </div>
                <div className="mt-8 md:mt-0 text-right">
                    <p className="text-xs text-blue-300 uppercase tracking-widest font-bold mb-1">Beneficio Neto Consolidado</p>
                    <p className={`text-3xl md:text-4xl lg:text-5xl font-black tracking-tight ${(stats?.totalProfit || 0) >= 0 ? "text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-teal-300" : "text-rose-400"}`}>
                        {(stats?.totalProfit || 0).toLocaleString('es-ES', { minimumFractionDigits: 0 })}‚Ç¨
                    </p>
                    <div className="flex justify-end mt-2">
                        <span className={`text-sm font-bold px-3 py-1 rounded-lg backdrop-blur-md border ${(stats?.margin || 0) > 15 ? 'bg-emerald-500/20 border-emerald-500/30 text-emerald-300' : 'bg-amber-500/20 border-amber-500/30 text-amber-300'}`}>
                            Margen Red: {(stats?.margin || 0).toFixed(1)}%
                        </span>
                    </div>
                </div>
            </div>
            <div className="absolute top-0 right-0 -mr-32 -mt-32 w-96 h-96 bg-blue-500 rounded-full mix-blend-overlay filter blur-[80px] opacity-20 animate-pulse-slow"></div>
        </div>
    );
};

export default AdminHero;



================================================================================
FILE: src\components\admin\dashboard\AlertItem.jsx
================================================================================
import React from 'react';
import { AlertCircle, AlertTriangle, Info, CheckCircle } from 'lucide-react';

const alertConfig = {
    high: {
        bg: 'bg-rose-50',
        border: 'border-rose-100',
        text: 'text-rose-800',
        icon: AlertCircle,
        iconColor: 'text-rose-500'
    },
    warning: {
        bg: 'bg-amber-50',
        border: 'border-amber-100',
        text: 'text-amber-800',
        icon: AlertTriangle,
        iconColor: 'text-amber-500'
    },
    med: { // 'med' mapped to info/blue for now or similar to warning
        bg: 'bg-blue-50',
        border: 'border-blue-100',
        text: 'text-blue-800',
        icon: Info,
        iconColor: 'text-blue-500'
    }
};

const AlertItem = ({ alert }) => {
    const config = alertConfig[alert.level] || alertConfig.med;
    const Icon = config.icon;

    return (
        <div className={`flex items-start gap-3 p-3 rounded-xl border ${config.bg} ${config.border} animate-in slide-in-from-right-2 duration-300`}>
            <div className={`mt-0.5 ${config.iconColor}`}>
                <Icon className="w-5 h-5" />
            </div>
            <div>
                <p className={`text-sm font-bold ${config.text}`}>
                    {alert.type === 'support_bottleneck' && 'Sobrecarga de Soporte'}
                    {alert.type === 'high_traffic_low_conversion' && 'Tr√°fico Sospechoso'}
                    {/* Add more mappings as needed, fallback to raw type if necessary */}
                    {!['support_bottleneck', 'high_traffic_low_conversion'].includes(alert.type) && alert.type}
                </p>
                <p className={`text-xs ${config.text} opacity-80 mt-0.5`}>
                    {alert.message}
                </p>
                <p className="text-[10px] text-slate-400 mt-1">
                    Detectado: {alert.timestamp?.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                </p>
            </div>
        </div>
    );
};

export default AlertItem;



================================================================================
FILE: src\components\admin\dashboard\FranchiseDirectory.jsx
================================================================================
import React from 'react';
import { Users, Search, Sliders } from 'lucide-react';
import { formatMoney } from '../../../lib/finance';

const FranchiseDirectory = ({ franchises, onSelectFranchise, setSelectedScorecard }) => {
    console.log('DEBUG: FranchiseDirectory mounted');
    return (
        <div className="space-y-4">
            {/* TABLE: Hidden on Mobile, Visible on Desktop */}
            <div className="hidden md:block bg-white rounded-2xl shadow-lg border border-slate-100 overflow-hidden">
                <div className="px-8 py-6 border-b border-slate-50 bg-slate-50/50 flex justify-between items-center backdrop-blur-sm">
                    <h3 className="font-bold text-slate-800 flex items-center text-lg">
                        <Users className="w-5 h-5 mr-3 text-blue-500" /> Directorio de Franquicias
                    </h3>
                    <div className="flex items-center bg-white border border-slate-200 rounded-lg px-3 py-1.5 shadow-sm">
                        <Search className="w-4 h-4 text-slate-400 mr-2" />
                        <input type="text" placeholder="Buscar..." className="bg-transparent border-none text-sm focus:outline-none text-slate-600 placeholder-slate-400 w-32" />
                    </div>
                </div>
                <div className="overflow-x-auto">
                    <table className="w-full text-left border-collapse">
                        <thead>
                            <tr className="text-xs font-bold text-slate-500 uppercase bg-slate-50/50 border-b border-slate-100">
                                <th className="px-6 py-4 pl-8">Franquicia</th>
                                <th className="px-6 py-4 text-center">Estado</th>
                                <th className="px-6 py-4 text-right">Ingresos</th>
                                <th className="px-6 py-4 text-right">Beneficio</th>
                                <th className="px-6 py-4"></th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-50">
                            {franchises.map((f) => (
                                <tr
                                    key={f.id}
                                    onClick={() => setSelectedScorecard(f)}
                                    className="hover:bg-blue-50/40 transition-colors group cursor-pointer"
                                >
                                    <td className="px-6 py-4 pl-8">
                                        <div className="flex items-center">
                                            <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-slate-100 to-slate-200 flex items-center justify-center text-xs font-black text-slate-500 mr-4 shadow-sm group-hover:from-blue-100 group-hover:to-blue-200 group-hover:text-blue-600 transition-all">
                                                {f.name.substring(0, 2)}
                                            </div>
                                            <div>
                                                <p className="font-bold text-slate-800 group-hover:text-blue-700 transition-colors">{f.name}</p>
                                                <p className="text-xs text-slate-400">{f.email}</p>
                                            </div>
                                        </div>
                                    </td>
                                    <td className="px-6 py-4 text-center">
                                        {f.metrics.profit > 0 ? (
                                            <span className="inline-flex w-3 h-3 rounded-full bg-emerald-500 shadow-sm border border-white ring-2 ring-emerald-100"></span>
                                        ) : (
                                            <span className="inline-flex w-3 h-3 rounded-full bg-rose-500 shadow-sm border border-white ring-2 ring-rose-100"></span>
                                        )}
                                    </td>
                                    <td className="px-6 py-4 text-right text-slate-600 font-medium font-mono">{formatMoney(f.metrics.revenue, 0)}‚Ç¨</td>
                                    <td className={`px-6 py-4 text-right font-bold font-mono ${f.metrics.profit >= 0 ? 'text-emerald-600' : 'text-rose-600'}`}>
                                        {formatMoney(f.metrics.profit, 0)}‚Ç¨
                                    </td>
                                    <td className="px-6 py-4 text-right">
                                        <button
                                            onClick={(e) => { e.stopPropagation(); onSelectFranchise(f.id, f.name); }}
                                            className="text-slate-400 hover:text-blue-600 transition-colors p-2 hover:bg-slate-100 rounded-full"
                                            title="Editar Datos"
                                        >
                                            <Sliders className="w-4 h-4" />
                                        </button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>

            {/* MOBILE CARD VIEW: Visible on Mobile, Hidden on Desktop */}
            <div className="md:hidden space-y-4">
                <h3 className="font-bold text-slate-800 flex items-center text-lg px-2">
                    <Users className="w-5 h-5 mr-3 text-blue-500" /> Directorio
                </h3>
                {franchises.map((f) => (
                    <div
                        key={f.id}
                        onClick={() => setSelectedScorecard(f)}
                        className="bg-white rounded-xl p-4 shadow-sm border border-slate-100 active:scale-95 transition-transform"
                    >
                        <div className="flex justify-between items-start mb-3">
                            <div className="flex items-center">
                                <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-slate-100 to-slate-200 flex items-center justify-center text-xs font-black text-slate-500 mr-3 shadow-sm">
                                    {f.name.substring(0, 2)}
                                </div>
                                <div>
                                    <p className="font-bold text-slate-800 text-sm">{f.name}</p>
                                    <p className="text-xs text-slate-400 truncate max-w-[150px]">{f.email}</p>
                                </div>
                            </div>
                            <div className="text-right">
                                <span className={`text-xs font-bold px-2 py-0.5 rounded-full ${f.metrics.profit > 0 ? 'bg-emerald-100 text-emerald-600' : 'bg-rose-100 text-rose-600'}`}>
                                    {f.metrics.profit > 0 ? 'Rentable' : 'P√©rdidas'}
                                </span>
                            </div>
                        </div>
                        <div className="grid grid-cols-2 gap-4 border-t border-blue-50 pt-3">
                            <div>
                                <p className="text-[10px] text-slate-400 uppercase font-bold">Ingresos</p>
                                <p className="font-mono font-bold text-blue-900">{formatMoney(f.metrics.revenue, 0)}‚Ç¨</p>
                            </div>
                            <div className="text-right">
                                <p className="text-[10px] text-slate-400 uppercase font-bold">Beneficio</p>
                                <p className={`font-mono font-bold ${f.metrics.profit >= 0 ? 'text-emerald-600' : 'text-rose-600'}`}>
                                    {formatMoney(f.metrics.profit, 0)}‚Ç¨
                                </p>
                            </div>
                        </div>
                        <div className="flex justify-end mt-3 pt-2">
                            <button
                                onClick={(e) => { e.stopPropagation(); onSelectFranchise(f.id, f.name); }}
                                className="flex items-center text-xs font-bold text-blue-600 bg-blue-50 px-3 py-1.5 rounded-lg active:bg-blue-100"
                            >
                                <Sliders className="w-3 h-3 mr-1" /> Gestionar
                            </button>
                        </div>
                    </div>
                ))}
            </div>
        </div>
    );
};

export default FranchiseDirectory;



================================================================================
FILE: src\components\admin\dashboard\IntelligenceGrid.jsx
================================================================================
import React from 'react';
import { ScatterChart as ScatterIcon, BarChart2 } from 'lucide-react';
import { ResponsiveContainer, ScatterChart, Scatter, XAxis, YAxis, CartesianGrid, Tooltip, Cell, BarChart, ReferenceLine, Bar, LabelList } from 'recharts';
import CustomChartTooltip from '../../CustomChartTooltip';
import { formatMoney } from '../../../lib/finance';

const IntelligenceGrid = ({ franchises, stats, setSelectedScorecard }) => {
    console.log('DEBUG: IntelligenceGrid mounted');
    return (
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
            {/* SCATTER PLOT */}
            <div className="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 flex flex-col">
                <div className="flex justify-between items-center mb-6">
                    <div>
                        <h4 className="font-bold text-slate-800 text-lg flex items-center"><ScatterIcon className="w-5 h-5 mr-2 text-blue-500" /> Matriz de Eficiencia</h4>
                        <p className="text-xs text-slate-400 mt-1">Comparativa Volumen vs Rentabilidad</p>
                    </div>
                    <div className="flex space-x-2">
                        <span className="w-3 h-3 rounded-full bg-emerald-400"></span><span className="text-[10px] text-slate-400">Rentable</span>
                        <span className="w-3 h-3 rounded-full bg-rose-400 ml-2"></span><span className="text-[10px] text-slate-400">P√©rdidas</span>
                    </div>
                </div>
                <div className="flex-1 w-full h-80">
                    <ResponsiveContainer width="100%" height="100%">
                        <ScatterChart margin={{ top: 20, right: 20, bottom: 20, left: 20 }}>
                            <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" />
                            <XAxis type="number" dataKey="metrics.orders" name="Pedidos" stroke="#94a3b8" tick={{ fontSize: 12 }} />
                            <YAxis type="number" dataKey="metrics.profit" name="Beneficio" stroke="#94a3b8" tick={{ fontSize: 12 }} />
                            <Tooltip content={<CustomChartTooltip />} cursor={{ strokeDasharray: '3 3' }} />
                            <Scatter name="Franquicias" data={franchises} shape="circle" onClick={(data) => setSelectedScorecard(data)}>
                                {franchises.map((entry, index) => (
                                    <Cell
                                        key={`cell-${index}`}
                                        fill={entry.metrics.profit >= 0 ? '#10b981' : '#ef4444'}
                                        stroke="white"
                                        strokeWidth={2}
                                        className="cursor-pointer hover:opacity-80 transition-opacity"
                                    />
                                ))}
                            </Scatter>
                        </ScatterChart>
                    </ResponsiveContainer>
                </div>
            </div>

            {/* UNIT ECONOMICS WATERFALL */}
            <div className="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 flex flex-col">
                <div className="mb-6">
                    <h4 className="font-bold text-slate-800 text-lg flex items-center"><BarChart2 className="w-5 h-5 mr-2 text-blue-500" /> Unit Economics (Por Pedido)</h4>
                    <p className="text-xs text-slate-400 mt-1">Desglose medio de rentabilidad por pedido (Red Global). ¬øD√≥nde va el dinero?</p>
                </div>
                <div className="flex-1 w-full h-80 min-h-[320px]">
                    {stats.totalOrders > 0 ? (
                        <ResponsiveContainer width="100%" height="100%">
                            <BarChart
                                data={[
                                    { name: 'Ticket Medio', value: stats.totalOrders > 0 ? stats.totalRevenue / stats.totalOrders : 0, fill: '#6366f1' }, // Ingreso
                                    { name: 'Coste Rider', value: stats.totalOrders > 0 ? -(stats.costStructure.find(c => c.name === 'Salarios')?.value || 0) / stats.totalOrders : 0, fill: '#ef4444' },
                                    { name: 'Gasolina', value: stats.totalOrders > 0 ? -((stats.costStructure.find(c => c.name === 'Gasolina')?.value || 0)) / stats.totalOrders : 0, fill: '#f59e0b' },
                                    { name: 'Estructura', value: stats.totalOrders > 0 ? -((stats.costStructure.find(c => c.name === 'Otros')?.value || 0) + (stats.costStructure.find(c => c.name === 'Marketing')?.value || 0) + (stats.costStructure.find(c => c.name === 'Motos')?.value || 0)) / stats.totalOrders : 0, fill: '#94a3b8' },
                                    { name: 'Beneficio', value: stats.totalOrders > 0 ? stats.totalProfit / stats.totalOrders : 0, fill: stats.totalProfit > 0 ? '#10b981' : '#ef4444' }
                                ]}
                                margin={{ top: 20, right: 30, left: 20, bottom: 5 }}
                            >
                                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                <XAxis dataKey="name" tick={{ fontSize: 10, fontWeight: 600 }} interval={0} />
                                <YAxis tick={{ fontSize: 12 }} tickFormatter={(value) => `${(value || 0).toFixed(1)}‚Ç¨`} />
                                <Tooltip
                                    cursor={{ fill: '#f8fafc' }}
                                    content={({ active, payload }) => {
                                        if (active && payload && payload.length) {
                                            const data = payload[0].payload;
                                            return (
                                                <div className="bg-slate-900 text-white p-3 rounded-lg text-xs shadow-xl border border-slate-700">
                                                    <p className="font-bold mb-1 text-slate-300">{data.name}</p>
                                                    <p className={`text-lg font-black ${data.value >= 0 ? "text-emerald-400" : "text-rose-400"}`}>
                                                        {formatMoney(data.value)}‚Ç¨
                                                    </p>
                                                    <p className="text-[10px] text-slate-500 mt-1">por pedido</p>
                                                </div>
                                            );
                                        }
                                        return null;
                                    }}
                                />
                                <ReferenceLine y={0} stroke="#cbd5e1" strokeWidth={2} />
                                <Bar dataKey="value" radius={[4, 4, 4, 4]} barSize={45}>
                                    <LabelList dataKey="value" position="top" formatter={(val) => formatMoney(val) + '‚Ç¨'} style={{ fill: '#64748b', fontSize: '11px', fontWeight: 'bold' }} />
                                </Bar>
                            </BarChart>
                        </ResponsiveContainer>
                    ) : (
                        <div className="flex items-center justify-center h-full text-slate-400">
                            <p>Sin datos de pedidos para este mes</p>
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
};

export default IntelligenceGrid;



================================================================================
FILE: src\components\admin\dashboard\IntelligenceWidget.jsx
================================================================================
import React, { memo } from 'react';
import { Activity, ShieldCheck, Zap } from 'lucide-react';
import AlertItem from './AlertItem';

const IntelligenceWidget = memo(({ healthScore, alerts = [], predictions }) => {

    // Determine status color based on score
    const getScoreColor = (score) => {
        if (score >= 80) return 'text-emerald-500';
        if (score >= 50) return 'text-amber-500';
        return 'text-rose-500';
    };

    const scoreColor = getScoreColor(healthScore);
    const isHealthy = alerts.length === 0;
    const healthStatus = isHealthy ? 'Saludable' : 'Anomal√≠a';

    return (
        <div className={`h-full bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden flex flex-col transition-all duration-300 relative ${isHealthy ? 'hover:border-emerald-200' : 'hover:border-rose-200'}`}>

            {/* Header / Score */}
            <div className="p-5 border-b border-gray-100 bg-gray-50/50">
                <div className="flex justify-between items-start">
                    <div>
                        <div className="flex items-center gap-2 mb-1">
                            <Zap className={`w-4 h-4 ${scoreColor}`} />
                            <h3 className="text-xs font-bold text-gray-500 uppercase tracking-wider">
                                Inteligencia
                            </h3>
                        </div>
                        <p className={`text-3xl font-bold tracking-tighter ${scoreColor}`}>
                            {healthScore}% <span className="text-sm font-medium text-gray-400">/ 100</span>
                        </p>
                    </div>
                    <div className={`mt-1 px-2 py-1 rounded-md border text-[10px] font-bold uppercase tracking-wide ${isHealthy
                            ? 'bg-emerald-50 text-emerald-700 border-emerald-100'
                            : 'bg-rose-50 text-rose-700 border-rose-100'
                        }`}>
                        {healthStatus}
                    </div>
                </div>
            </div>

            {/* Content Body */}
            <div className="flex-1 p-0 overflow-y-auto max-h-[400px]">
                {/* Predictions / Trends Mini-Section */}
                {(predictions.supportLoad || predictions.growth) && (
                    <div className="grid grid-cols-2 gap-px bg-gray-100 border-b border-gray-100">
                        <div className="bg-white p-3 text-center">
                            <span className="block text-[10px] uppercase text-gray-400 font-bold mb-1">Carga Soporte</span>
                            <span className="text-xs font-semibold text-gray-700">
                                {predictions.supportLoad === 'increasing' ? '‚Üó Creciendo' : '‚Üí Estable'}
                            </span>
                        </div>
                        <div className="bg-white p-3 text-center">
                            <span className="block text-[10px] uppercase text-gray-400 font-bold mb-1">Crecimiento</span>
                            <span className="text-xs font-semibold text-gray-700">
                                {predictions.growth === 'organic' ? 'üå± Org√°nico' : 'üöÄ Agresivo'}
                            </span>
                        </div>
                    </div>
                )}

                {/* Alerts List */}
                <div className="p-4 space-y-3">
                    {alerts.length > 0 ? (
                        alerts.map((alert, idx) => (
                            <AlertItem key={idx} alert={alert} />
                        ))
                    ) : (
                        <div className="flex flex-col items-center justify-center py-8 text-center opacity-60">
                            <div className="p-3 bg-emerald-50 rounded-full mb-3 animate-pulse">
                                <ShieldCheck className="w-8 h-8 text-emerald-500" />
                            </div>
                            <h4 className="text-sm font-bold text-gray-800">Todo en Orden</h4>
                            <p className="text-xs text-gray-400 max-w-[150px] mt-1">
                                No se detectan anomal√≠as en m√©tricas clave.
                            </p>
                        </div>
                    )}
                </div>
            </div>

            {/* Footer decoration */}
            <div className={`h-1 w-full ${isHealthy ? 'bg-emerald-500' : 'bg-rose-500'}`} />
        </div>
    );
});

export default IntelligenceWidget;



================================================================================
FILE: src\components\admin\dashboard\OperationalMetrics.jsx
================================================================================
import React from 'react';
import { Target } from 'lucide-react';
import { ResponsiveContainer, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Cell } from 'recharts';
import CustomChartTooltip from '../../CustomChartTooltip';
import InfoTooltip from '../../InfoTooltip';

const OperationalMetrics = ({ franchises }) => {
    const totalRevenue = franchises.reduce((acc, f) => acc + (f.revenue || 0), 0);
    const totalMargin = franchises.reduce((acc, f) => acc + (f.margin || 0), 0);
    const avgMargin = franchises.length > 0 ? (totalMargin / franchises.length) : 0;
    const activeAlerts = franchises.reduce((acc, f) => acc + (f.alerts || 0), 0);
    console.log('DEBUG: OperationalMetrics mounted');
    return (
        <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 className="text-lg font-bold text-gray-900 mb-6 flex items-center">
                <Target className="w-5 h-5 mr-2 text-blue-600" />
                COMPARATIVA OPERATIVA
                <InfoTooltip text="M√©tricas f√≠sicas reales. Detecta problemas de personal o log√≠stica." />
            </h3>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                {/* Productivity Chart */}
                <div className="bg-gray-50/50 p-5 rounded-lg border border-gray-100">
                    <h4 className="flex justify-between items-center mb-4">
                        <span className="text-xs font-bold text-gray-500 uppercase tracking-wider">Productividad</span>
                        <span className="px-2 py-1 bg-white border border-gray-200 rounded text-[10px] font-mono text-gray-500">
                            Target {'>'} 2.5
                        </span>
                    </h4>
                    <div className="h-48 mt-2">
                        <ResponsiveContainer width="100%" height="100%">
                            <BarChart layout="vertical" data={franchises.slice(0, 5)} margin={{ top: 0, right: 10, left: 10, bottom: 0 }}>
                                <CartesianGrid strokeDasharray="3 3" horizontal={false} stroke="#e2e8f0" />
                                <XAxis type="number" hide />
                                <YAxis dataKey="name" type="category" width={80} tick={{ fontSize: 10, fill: '#64748b' }} axisLine={false} tickLine={false} />
                                <Tooltip content={<CustomChartTooltip />} cursor={{ fill: '#f1f5f9' }} />
                                <Bar dataKey="metrics.productivity" name="Peds/H" fill="#8b5cf6" radius={[0, 4, 4, 0]} barSize={12}>
                                    {franchises.map((entry, index) => (
                                        <Cell key={`cell-${index}`} fill={entry.metrics.productivity < 2 ? '#f43f5e' : '#8b5cf6'} />
                                    ))}
                                </Bar>
                            </BarChart>
                        </ResponsiveContainer>
                    </div>
                </div>

                {/* Distance Chart */}
                <div className="bg-gray-50/50 p-5 rounded-lg border border-gray-100">
                    <h4 className="flex justify-between items-center mb-4">
                        <span className="text-xs font-bold text-gray-500 uppercase tracking-wider">Eficiencia Log√≠stica</span>
                        <span className="px-2 py-1 bg-white border border-gray-200 rounded text-[10px] font-mono text-gray-500">
                            {'<'} 3.5km
                        </span>
                    </h4>
                    <div className="h-48 mt-2">
                        <ResponsiveContainer width="100%" height="100%">
                            <BarChart layout="vertical" data={franchises.slice(0, 5)} margin={{ top: 0, right: 10, left: 10, bottom: 0 }}>
                                <CartesianGrid strokeDasharray="3 3" horizontal={false} stroke="#e2e8f0" />
                                <XAxis type="number" hide />
                                <YAxis dataKey="name" type="category" width={80} tick={{ fontSize: 10, fill: '#64748b' }} axisLine={false} tickLine={false} />
                                <Tooltip content={<CustomChartTooltip />} cursor={{ fill: '#f1f5f9' }} />
                                <Bar dataKey="metrics.avgDistance" name="Km" fill="#06b6d4" radius={[0, 4, 4, 0]} barSize={12} />
                            </BarChart>
                        </ResponsiveContainer>
                    </div>
                </div>
            </div>
        </div>
    );
};

export default OperationalMetrics;



================================================================================
FILE: src\components\admin\dashboard\PowerMetrics.jsx
================================================================================
import React from 'react';
import { Users2, AlertOctagon, Users } from 'lucide-react';
import { formatMoney } from '../../../lib/finance';
import InfoTooltip from '../../InfoTooltip';

const PowerMetrics = ({ stats }) => {
    console.log('DEBUG: PowerMetrics mounted');
    return (
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 hover:shadow-lg transition-all group relative">
                <div className="absolute inset-0 overflow-hidden rounded-2xl pointer-events-none">
                    <div className="absolute top-0 right-0 w-24 h-24 bg-purple-50 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110"></div>
                </div>
                <div className="relative z-10">
                    <div className="flex justify-between items-start mb-4">
                        <div>
                            <p className="text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center">
                                CAC Global <InfoTooltip text="Coste de Adquisici√≥n de Cliente. Marketing / Nuevos Pedidos." />
                            </p>
                            <h3 className="text-3xl font-black text-slate-800 mt-1">{formatMoney(stats.powerMetrics.globalCAC)}‚Ç¨</h3>
                        </div>
                        <div className="bg-purple-100 p-2.5 rounded-xl text-purple-600 shadow-inner"><Users2 className="w-6 h-6" /></div>
                    </div>
                    <div className="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden">
                        <div className="bg-purple-500 h-full w-[45%]"></div>
                    </div>
                </div>
            </div>

            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 hover:shadow-lg transition-all group relative">
                <div className="absolute inset-0 overflow-hidden rounded-2xl pointer-events-none">
                    <div className="absolute top-0 right-0 w-24 h-24 bg-rose-50 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110"></div>
                </div>
                <div className="relative z-10">
                    <div className="flex justify-between items-start mb-4">
                        <div>
                            <p className="text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center">
                                Incidencias <InfoTooltip text="Porcentaje de ingresos perdidos en devoluciones o errores." />
                            </p>
                            <h3 className={`text-3xl font-black mt-1 ${(stats.powerMetrics.globalIncidentRatio || 0) > 1 ? 'text-rose-500' : 'text-emerald-500'}`}>
                                {(stats.powerMetrics.globalIncidentRatio || 0).toFixed(2)}%
                            </h3>
                        </div>
                        <div className="bg-rose-100 p-2.5 rounded-xl text-rose-600 shadow-inner"><AlertOctagon className="w-6 h-6" /></div>
                    </div>
                    <div className="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden">
                        <div className={`h-full ${stats.powerMetrics.globalIncidentRatio > 1 ? 'bg-rose-500' : 'bg-emerald-500'}`} style={{ width: `${stats.powerMetrics.globalIncidentRatio * 20}%` }}></div>
                    </div>
                </div>
            </div>

            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 hover:shadow-lg transition-all group relative">
                <div className="absolute inset-0 overflow-hidden rounded-2xl pointer-events-none">
                    <div className="absolute top-0 right-0 w-24 h-24 bg-blue-50 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110"></div>
                </div>
                <div className="relative z-10">
                    <div className="flex justify-between items-start mb-4">
                        <div>
                            <p className="text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center">
                                Carga Laboral <InfoTooltip text="Porcentaje de la Venta destinado a Salarios. Debe ser < 60-65%." />
                            </p>
                            <h3 className="text-3xl font-black text-slate-800 mt-1">{(stats.powerMetrics.avgLaborRatio || 0).toFixed(1)}%</h3>
                        </div>
                        <div className="bg-blue-100 p-2.5 rounded-xl text-blue-600 shadow-inner"><Users className="w-6 h-6" /></div>
                    </div>
                    <div className="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden">
                        <div className="bg-blue-500 h-full" style={{ width: `${stats.powerMetrics.avgLaborRatio}%` }}></div>
                    </div>
                </div>
            </div>
        </div>
    );
};

export default PowerMetrics;



================================================================================
FILE: src\components\admin\dashboard\SidebarWidgets.jsx
================================================================================
import React from 'react';
import { AlertTriangle, Award, Users } from 'lucide-react';
import { detectAnomalies } from '../../../lib/fraudDetection';
import { formatMoney } from '../../../lib/finance';

const SidebarWidgets = ({ franchises, setSelectedScorecard }) => {
    console.log('DEBUG: SidebarWidgets mounted');
    // Collect all alerts
    const allAlerts = franchises.flatMap(f => {
        const fAlerts = detectAnomalies(f);
        return fAlerts.map(a => ({ ...a, franchiseName: f.name, franchiseId: f.id, franchise: f }));
    });

    return (
        <div className="space-y-6">
            {/* ALERTS SECTION (Dynamic Fraud Detection) */}
            {allAlerts.length > 0 && (
                <div className="bg-rose-50/50 backdrop-blur-md border border-rose-100 rounded-2xl p-6 relative overflow-hidden shadow-sm">
                    <div className="flex items-center mb-4 relative z-10">
                        <span className="bg-rose-100 p-1.5 rounded-lg mr-2"><AlertTriangle className="w-4 h-4 text-rose-600" /></span>
                        <h3 className="font-bold text-rose-800 text-sm">Centro de Alertas & Anomal√≠as</h3>
                    </div>
                    <div className="space-y-3 relative z-10 max-h-96 overflow-y-auto pr-1 scrollbar-thin scrollbar-thumb-rose-200">
                        {allAlerts.map((alert, idx) => (
                            <div
                                key={`${alert.franchiseId}-${idx}`}
                                className="bg-white p-3 rounded-xl border border-rose-100 shadow-sm hover:shadow-md transition-shadow cursor-pointer group"
                                onClick={() => setSelectedScorecard(alert.franchise)}
                            >
                                <div className="flex justify-between items-start mb-1">
                                    <span className="font-bold text-slate-700 text-xs uppercase tracking-wider">{alert.franchiseName}</span>
                                    {alert.type === 'CRITICAL' && <span className="bg-rose-100 text-rose-600 text-[10px] font-bold px-1.5 py-0.5 rounded">CR√çTICO</span>}
                                </div>
                                <p className="font-bold text-rose-800 text-sm leading-tight">{alert.title}</p>
                                <p className="text-xs text-slate-500 mt-1">{alert.message}</p>
                                <p className="text-xs font-mono font-bold text-rose-500 mt-1 text-right">{alert.metric}</p>
                            </div>
                        ))}
                    </div>
                </div>
            )}

            {/* TOP 3 PODIUM */}
            <div className="bg-white rounded-2xl shadow-lg border border-slate-100 p-6 relative overflow-hidden">
                <h3 className="font-bold text-slate-800 mb-6 flex items-center">
                    <Award className="w-5 h-5 mr-3 text-blue-500" />
                    Top Rendimiento
                </h3>
                <div className="space-y-4 relative z-10">
                    {franchises.map((f) => {
                        const genericStyle = {
                            border: 'border-slate-200',
                            bg: 'bg-slate-100',
                            color: 'text-slate-600',
                            label: 'Franquicia',
                            icon: Users // Using Users icon as a generic placeholder
                        };
                        return (
                            <div key={f.id} onClick={() => setSelectedScorecard(f)} className={`flex items-center p-3 rounded-xl bg-slate-50 border ${genericStyle.border} hover:shadow-md transition-all cursor-pointer group`}>
                                <div className={`w-10 h-10 rounded-full flex items-center justify-center mr-4 ${genericStyle.bg} ${genericStyle.color} shadow-sm group-hover:scale-110 transition-transform`}>
                                    <Users className="w-5 h-5" />
                                </div>
                                <div className="flex-1">
                                    <p className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">{genericStyle.label}</p>
                                    <p className="font-bold text-slate-800">{f.name}</p>
                                </div>
                                <div className="text-right">
                                    <p className="font-black text-emerald-600">+{formatMoney(f.metrics.profit, 0)}‚Ç¨</p>
                                </div>
                            </div>
                        )
                    })}
                </div>
                {/* Decoration */}
                <div className="absolute top-0 right-0 -mt-10 -mr-10 w-32 h-32 bg-gradient-to-br from-yellow-100 to-amber-100 rounded-full mix-blend-multiply opacity-50 blur-xl"></div>
            </div>
        </div>
    );
};

export default SidebarWidgets;



================================================================================
FILE: src\components\admin\dashboard\TrendsSection.jsx
================================================================================
import React from 'react';
import { TrendingUp } from 'lucide-react';
import { ResponsiveContainer, ComposedChart, CartesianGrid, XAxis, YAxis, Tooltip, Legend, Area, Line } from 'recharts';
import CustomChartTooltip from '../../CustomChartTooltip';
import InfoTooltip from '../../InfoTooltip';

const TrendsSection = ({ trendData }) => {
    console.log('DEBUG: TrendsSection mounted');
    return (
        <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 p-8">
            <div className="flex justify-between items-center mb-6">
                <div>
                    <h3 className="text-xl font-bold text-slate-800 dark:text-white flex items-center">
                        <TrendingUp className="w-6 h-6 mr-3 text-blue-600" />
                        Evoluci√≥n de la Red
                        <InfoTooltip text="Tendencia de Facturaci√≥n y Beneficios en los √∫ltimos 6 meses." />
                    </h3>
                    <p className="text-sm text-slate-400 mt-1">An√°lisis hist√≥rico consolidado</p>
                </div>
            </div>
            <div className="h-80 w-full">
                <ResponsiveContainer width="100%" height="100%">
                    <ComposedChart data={trendData} margin={{ top: 20, right: 20, bottom: 20, left: 20 }}>
                        <defs>
                            <linearGradient id="colorRev" x1="0" y1="0" x2="0" y2="1">
                                <stop offset="5%" stopColor="#6366f1" stopOpacity={0.2} />
                                <stop offset="95%" stopColor="#6366f1" stopOpacity={0} />
                            </linearGradient>
                        </defs>
                        <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                        <XAxis dataKey="shortName" stroke="#94a3b8" tick={{ fontSize: 12 }} axisLine={false} tickLine={false} />
                        <YAxis yAxisId="left" stroke="#94a3b8" tick={{ fontSize: 12 }} axisLine={false} tickLine={false} tickFormatter={(value) => `${((value || 0) / 1000).toFixed(0)}k`} />
                        <YAxis yAxisId="right" orientation="right" stroke="#10b981" tick={{ fontSize: 12 }} axisLine={false} tickLine={false} tickFormatter={(value) => `${((value || 0) / 1000).toFixed(0)}k`} />
                        <Tooltip content={<CustomChartTooltip />} />
                        <Legend wrapperStyle={{ paddingTop: '20px' }} />
                        <Area yAxisId="left" type="monotone" dataKey="revenue" name="Ingresos" stroke="#6366f1" fillOpacity={1} fill="url(#colorRev)" strokeWidth={3} />
                        <Line yAxisId="right" type="monotone" dataKey="profit" name="Beneficio Neto" stroke="#10b981" strokeWidth={3} dot={{ r: 4, strokeWidth: 2, fill: '#fff' }} />

                        {/* Forecast Lines (Dashed) */}
                        <Area yAxisId="left" type="monotone" dataKey="forecastRevenue" name="Previsi√≥n Ing." stroke="#6366f1" strokeDasharray="5 5" fill="none" strokeWidth={2} />
                        <Line yAxisId="right" type="monotone" dataKey="forecastProfit" name="Previsi√≥n Ben." stroke="#10b981" strokeDasharray="5 5" strokeWidth={2} dot={false} />
                    </ComposedChart>
                </ResponsiveContainer>
            </div>
        </div>
    );
};

export default TrendsSection;



================================================================================
FILE: src\components\admin\support\SupportMetrics.jsx
================================================================================
import React from 'react';
import PropTypes from 'prop-types';
import { Inbox, Eye, Clock, AlertTriangle, Search, CheckSquare, AlertOctagon, TrendingUp, CheckCircle } from 'lucide-react';
import { useSupport } from '../../../hooks/useSupport';

const SupportMetrics = ({ viewMode }) => {
    const { metrics } = useSupport();

    if (viewMode === 'analytics') {
        return (
            <div className="bg-white border border-slate-200 rounded-2xl p-8 shadow-sm animate-in fade-in zoom-in-95 duration-300">
                <h2 className="text-xl font-black text-slate-800 mb-6">M√©tricas de Rendimiento</h2>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-10">
                    {/* Categories */}
                    <div>
                        <h3 className="text-sm font-bold text-slate-500 uppercase mb-4">Volumen por Categor√≠a</h3>
                        <div className="space-y-4">
                            {Object.entries(metrics.byCategory).map(([key, val]) => (
                                <div key={key}>
                                    <div className="flex justify-between text-sm mb-1">
                                        <span className="font-bold capitalize text-slate-700">{key}</span>
                                        <span className="font-bold text-slate-900">{val} / {metrics.total}</span>
                                    </div>
                                    <div className="w-full bg-slate-100 rounded-full h-2.5 overflow-hidden">
                                        <div
                                            className="bg-blue-600 h-2.5 rounded-full transition-all duration-1000 ease-out"
                                            style={{ width: metrics.total > 0 ? `${(val / metrics.total) * 100}%` : '0%' }}
                                        ></div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                    {/* Efficiency */}
                    <div>
                        <h3 className="text-sm font-bold text-slate-500 uppercase mb-4">Eficiencia Operativa</h3>
                        <div className="grid grid-cols-2 gap-4">
                            <div className="bg-emerald-50 rounded-xl p-5 border border-emerald-100">
                                <p className="text-emerald-800 text-sm font-bold mb-1">Tasa de Resoluci√≥n</p>
                                <p className="text-3xl font-black text-emerald-600">
                                    {metrics.total > 0 ? ((metrics.resolved / metrics.total) * 100).toFixed(0) : 0}%
                                </p>
                            </div>
                            <div className="bg-rose-50 rounded-xl p-5 border border-rose-100">
                                <p className="text-rose-800 text-sm font-bold mb-1">Alta Prioridad</p>
                                <p className="text-3xl font-black text-rose-600">{metrics.critical + metrics.high}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        );
    }

    return (
        <div className="grid grid-cols-2 lg:grid-cols-5 gap-3 mb-6">
            {/* Total */}
            <div className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex flex-col justify-between">
                <span className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Total</span>
                <div className="flex items-end justify-between">
                    <span className="text-2xl font-black text-slate-800">{metrics.total}</span>
                    <Inbox className="w-5 h-5 text-blue-100" />
                </div>
            </div>
            {/* Unread */}
            <div className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex flex-col justify-between relative overflow-hidden">
                {metrics.unread > 0 && <div className="absolute top-0 right-0 w-2 h-2 bg-blue-500 rounded-full m-2 animate-pulse"></div>}
                <span className="text-xs font-bold text-blue-500 uppercase tracking-wider mb-1">Sin Leer</span>
                <div className="flex items-end justify-between">
                    <span className="text-2xl font-black text-blue-600">{metrics.unread}</span>
                    <Eye className="w-5 h-5 text-blue-100" />
                </div>
            </div>
            {/* Open */}
            <div className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex flex-col justify-between">
                <span className="text-xs font-bold text-amber-500 uppercase tracking-wider mb-1">Abiertos</span>
                <div className="flex items-end justify-between">
                    <span className="text-2xl font-black text-amber-600">{metrics.open}</span>
                    <Clock className="w-5 h-5 text-amber-100" />
                </div>
            </div>
            {/* Resolved */}
            <div className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex flex-col justify-between">
                <span className="text-xs font-bold text-emerald-500 uppercase tracking-wider mb-1">Resueltos</span>
                <div className="flex items-end justify-between">
                    <span className="text-2xl font-black text-emerald-600">{metrics.resolved}</span>
                    <CheckCircle className="w-5 h-5 text-emerald-100" />
                </div>
            </div>
            {/* Avg Time */}
            <div className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex flex-col justify-between">
                <span className="text-xs font-bold text-purple-500 uppercase tracking-wider mb-1">T. Medio</span>
                <div className="flex items-end justify-between">
                    <span className="text-2xl font-black text-purple-600">
                        {metrics.avgResponseMinutes < 60
                            ? Math.round(metrics.avgResponseMinutes) + 'm'
                            : (metrics.avgResponseMinutes / 60).toFixed(1) + 'h'}
                    </span>
                    <TrendingUp className="w-5 h-5 text-purple-100" />
                </div>
            </div>
        </div>
    );
};

SupportMetrics.propTypes = {
    viewMode: PropTypes.string.isRequired
};

export default SupportMetrics;



================================================================================
FILE: src\components\admin\support\TicketDetail.jsx
================================================================================
import React, { memo } from 'react';
import PropTypes from 'prop-types';
import ReactQuill from 'react-quill';
import 'react-quill/dist/quill.snow.css';
import { User, Clock, Download, Lock, Send, Loader2, MessageSquare, Zap } from 'lucide-react';
import { getStatusConfig, TICKET_STATUSES } from '../../../lib/constants';
import { useSupport } from '../../../hooks/useSupport';
import { formatDate } from '../../../utils/formatDate';

// --- SUB-COMPONENTS FOR PERFORMANCE ---

// --- SUB-COMPONENTS FOR PERFORMANCE ---

const MessageItem = memo(({ msg, email }) => {
    const isInternal = msg.isInternal;
    const senderIsAdmin = msg.senderRole === 'admin';

    if (isInternal) {
        return (
            <div className="flex justify-center my-4">
                <div className="bg-yellow-50 border border-yellow-200 text-yellow-800 p-3 rounded-xl max-w-lg text-sm flex items-start gap-3 shadow-sm">
                    <Lock className="w-4 h-4 mt-0.5 shrink-0" />
                    <div>
                        <p className="font-bold text-xs uppercase mb-1 opacity-70">Nota Interna</p>
                        <div
                            className='prose prose-sm prose-yellow'
                            dangerouslySetInnerHTML={{ __html: msg.text }}
                        />
                    </div>
                </div>
            </div>
        );
    }

    return (
        <div className={`flex ${senderIsAdmin ? 'justify-end' : 'justify-start'}`}>
            <div className={`p-4 rounded-2xl max-w-[85%] shadow-sm ${senderIsAdmin
                ? 'bg-slate-800 text-white rounded-tr-sm'
                : 'bg-white border border-slate-200 text-slate-700 rounded-tl-sm'
                }`}>
                <div className="flex items-center gap-2 mb-1">
                    <span className={`text-xs font-bold ${senderIsAdmin ? 'text-slate-300' : 'text-blue-600'}`}>
                        {senderIsAdmin ? 'Soporte HQ' : email}
                    </span>
                    <span className={`text-[10px] ${senderIsAdmin ? 'text-slate-500' : 'text-slate-400'}`}>
                        {formatDate(msg.createdAt)}
                    </span>
                </div>
                <div
                    className={`prose prose-sm ${senderIsAdmin ? 'prose-invert' : 'prose-slate'}`}
                    dangerouslySetInnerHTML={{ __html: msg.text }}
                />
            </div>
        </div>
    );
});

MessageItem.propTypes = {
    msg: PropTypes.object.isRequired,
    email: PropTypes.string
};

// --- PURE PRESENTATIONAL COMPONENT ---

const TicketDetailInner = memo(({
    selectedTicket,
    messages,
    onStatusChange,
    reply,
    setReply,
    isInternal,
    setIsInternal,
    onReply,
    isSendingReply,
    messagesEndRef
}) => {

    if (!selectedTicket) {
        return (
            <div className="lg:col-span-8 bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden flex flex-col h-full relative">
                <div className="h-full flex flex-col items-center justify-center text-slate-300 bg-slate-50/30">
                    <div className="w-24 h-24 bg-slate-100 rounded-full flex items-center justify-center mb-4">
                        <MessageSquare className="w-10 h-10 text-slate-300" />
                    </div>
                    <p className="text-xl font-black text-slate-400">Selecciona un ticket</p>
                    <p className="text-sm font-medium mt-2">O utiliza <kbd className="font-mono bg-slate-100 px-1 rounded">‚åòK</kbd> para buscar</p>
                </div>
            </div>
        );
    }

    return (
        <div className="lg:col-span-8 bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden flex flex-col h-full relative">
            <div className="h-full flex flex-col animate-in slide-in-from-right-4 duration-300">
                {/* Detail Header */}
                <div className="p-6 border-b border-slate-100 bg-slate-50/50 flex justify-between items-start">
                    <div className="max-w-2xl">
                        <div className="flex items-center gap-2 mb-2">
                            <span className={`px-2 py-0.5 rounded textxs font-bold uppercase border ${getStatusConfig(selectedTicket.status).bg} ${getStatusConfig(selectedTicket.status).text} ${getStatusConfig(selectedTicket.status).border}`}>
                                {getStatusConfig(selectedTicket.status).label}
                            </span>
                            <span className="text-slate-400 text-xs">‚Ä¢</span>
                            <span className="text-xs text-slate-500 font-medium">Ticket #{selectedTicket.id.slice(0, 8)}</span>
                        </div>
                        <h2 className="text-2xl font-black text-slate-900 mb-1">{selectedTicket.subject}</h2>
                        <div className="flex items-center gap-4 text-sm text-slate-500">
                            <span className="flex items-center gap-1.5">
                                <User className="w-4 h-4 text-slate-400" />
                                {selectedTicket.email}
                            </span>
                            <span className="flex items-center gap-1.5">
                                <Clock className="w-4 h-4 text-slate-400" />
                                {formatDate(selectedTicket.createdAt)}
                            </span>
                        </div>
                    </div>

                    {/* Status Selector */}
                    <div className="flex items-center gap-2">
                        <label className="text-xs font-bold text-slate-400 uppercase mr-1">Estado:</label>
                        <select
                            value={selectedTicket.status || 'open'}
                            onChange={(e) => onStatusChange(selectedTicket.id, e.target.value)}
                            className="bg-white border border-slate-300 rounded-lg px-3 py-1.5 text-sm font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer"
                        >
                            {Object.values(TICKET_STATUSES).map(s => (
                                <option key={s.id} value={s.id}>{s.label}</option>
                            ))}
                        </select>
                    </div>
                </div>

                {/* Content Scrollable - CHAT MODE */}
                <div className="flex-1 overflow-y-auto p-6 space-y-6 bg-slate-50/30">
                    {/* Original Ticket Info Block */}
                    <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-1 h-full bg-blue-500"></div>
                        <div className="flex items-center gap-2 mb-3">
                            <div className="w-8 h-8 rounded-full bg-blue-50 flex items-center justify-center">
                                <User className="w-4 h-4 text-blue-600" />
                            </div>
                            <div>
                                <p className="text-sm font-bold text-slate-900">Consulta Original</p>
                                <p className="text-xs text-slate-400">Hace {selectedTicket.createdAt?.toDate ? Math.floor((new Date() - selectedTicket.createdAt.toDate()) / (1000 * 60 * 60)) : 0} horas</p>
                            </div>
                        </div>
                        <p className="text-slate-700 whitespace-pre-wrap leading-relaxed pl-10 text-base">
                            {selectedTicket.message}
                        </p>

                        {selectedTicket.attachmentUrl && (
                            <div className="mt-4 pt-4 border-t border-slate-100 pl-10">
                                <a href={selectedTicket.attachmentUrl} target="_blank" rel="noreferrer" className="inline-flex items-center gap-2 text-blue-600 hover:underline text-sm font-bold">
                                    <Download className="w-4 h-4" /> Ver Adjunto
                                </a>
                            </div>
                        )}
                    </div>

                    {/* Legacy Response Block */}
                    {selectedTicket.response && messages.length === 0 && (
                        <div className="flex justify-end">
                            <div className="bg-slate-100 text-slate-700 p-4 rounded-2xl rounded-tr-sm max-w-[85%] border border-slate-200">
                                <p className="text-xs font-bold text-slate-500 mb-1">Respuesta Anterior</p>
                                <div className="prose prose-sm prose-slate" dangerouslySetInnerHTML={{ __html: selectedTicket.response }} />
                            </div>
                        </div>
                    )}

                    {/* Messages Feed */}
                    {messages.map(msg => (
                        <MessageItem key={msg.id} msg={msg} email={selectedTicket.email} isAdmin={true} />
                    ))}
                    <div ref={messagesEndRef} />
                </div>

                {/* Reply Box */}
                {selectedTicket.status !== 'resolved' && (
                    <div className="p-4 border-t border-slate-200 bg-slate-50 relative z-20">
                        <div className="relative">
                            <div className="bg-white rounded-xl border border-slate-300 shadow-sm overflow-hidden">
                                <ReactQuill
                                    theme="snow"
                                    value={reply}
                                    onChange={setReply}
                                    placeholder={isInternal ? "Escribe una nota interna..." : "Escribe tu respuesta..."}
                                    className={isInternal ? "bg-yellow-50" : "bg-white"}
                                    modules={{
                                        toolbar: [
                                            ['bold', 'italic', 'underline', 'strike'],
                                            [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                                            ['link', 'clean']
                                        ]
                                    }}
                                />
                            </div>
                            <div className="absolute bottom-3 right-3 flex items-center gap-2 z-10">
                                <button
                                    type="button"
                                    onClick={() => setIsInternal(!isInternal)}
                                    className={`p-1.5 rounded-lg transition-all ${isInternal
                                        ? 'bg-yellow-100 text-yellow-700 ring-1 ring-yellow-300'
                                        : 'bg-slate-100 text-slate-400 hover:bg-slate-200'
                                        }`}
                                    title="Modo Nota Interna"
                                >
                                    <Lock className="w-4 h-4" />
                                </button>
                                <button
                                    onClick={onReply}
                                    disabled={isSendingReply || !reply.trim()}
                                    className={`bg-blue-600 hover:bg-blue-700 text-white rounded-lg px-4 py-1.5 text-sm font-bold flex items-center gap-2 transition-all shadow-md ${(isSendingReply || !reply.trim()) ? 'opacity-50 cursor-not-allowed' : 'hover:scale-105 active:scale-95'
                                        }`}
                                >
                                    {isSendingReply ? <Loader2 className="w-4 h-4 animate-spin" /> : <Send className="w-4 h-4" />}
                                    {isSendingReply ? 'Enviando...' : 'Enviar'}
                                </button>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
});

TicketDetailInner.propTypes = {
    selectedTicket: PropTypes.object,
    messages: PropTypes.array,
    onStatusChange: PropTypes.func.isRequired,
    reply: PropTypes.string.isRequired,
    setReply: PropTypes.func.isRequired,
    isInternal: PropTypes.bool.isRequired,
    setIsInternal: PropTypes.func.isRequired,
    onReply: PropTypes.func.isRequired,
    isSendingReply: PropTypes.bool.isRequired,
    messagesEndRef: PropTypes.object
};

// --- CONTAINER COMPONENT ---

const TicketDetail = () => {
    const {
        selectedTicket,
        messages,
        handleStatusChange,
        reply,
        setReply,
        isInternal,
        setIsInternal,
        handleReply,
        isSendingReply,
        messagesEndRef
    } = useSupport();

    return (
        <TicketDetailInner
            selectedTicket={selectedTicket}
            messages={messages}
            onStatusChange={handleStatusChange}
            reply={reply}
            setReply={setReply}
            isInternal={isInternal}
            setIsInternal={setIsInternal}
            onReply={handleReply}
            isSendingReply={isSendingReply}
            messagesEndRef={messagesEndRef}
        />
    );
};

export default TicketDetail;



================================================================================
FILE: src\components\admin\support\TicketList.jsx
================================================================================
import React from 'react';
import PropTypes from 'prop-types';
import { Search, Inbox, Eye, EyeOff, CheckCircle, Clock, AlertTriangle, CheckSquare, AlertOctagon } from 'lucide-react';
import { getStatusConfig } from '../../../lib/constants';
import { useSupport } from '../../../hooks/useSupport';
import { formatDate } from '../../../utils/formatDate';

// Helper for skeletal loading
const TicketSkeleton = () => (
    <div className="p-4 rounded-xl border-2 border-slate-100 bg-white space-y-3 animate-pulse">
        <div className="flex justify-between">
            <div className="w-16 h-5 bg-slate-200 rounded-md"></div>
            <div className="w-12 h-4 bg-slate-200 rounded-md"></div>
        </div>
        <div className="w-3/4 h-5 bg-slate-200 rounded-md"></div>
        <div className="w-1/2 h-4 bg-slate-200 rounded-md"></div>
    </div>
);

const TicketList = () => {
    const {
        filteredTickets: tickets,
        loading,
        selectedTicketId,
        handleSelectTicket: onSelectTicket,
        handleToggleRead: onToggleRead,
        filterTab,
        setFilterTab,
        searchQuery,
        setSearchQuery,
        metrics
    } = useSupport();

    const TABS = [
        { id: 'all', label: 'Todos', icon: Inbox, count: metrics.total },
        { id: 'unread', label: 'No Le√≠dos', icon: Eye, count: metrics.unread },
        { id: 'open', label: 'Abiertos', icon: Clock, count: metrics.open },
        { id: 'pending_user', label: 'Pendientes Info', icon: AlertTriangle, count: metrics.pending },
        { id: 'investigating', label: 'En Revisi√≥n', icon: Search, count: metrics.investigating },
        { id: 'resolved', label: 'Resueltos', icon: CheckSquare, count: metrics.resolved },
        { id: 'high', label: 'Urgentes', icon: AlertOctagon, count: metrics.critical + metrics.high },
    ];

    return (
        <div className="lg:col-span-4 bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col overflow-hidden h-[600px] lg:h-auto">
            {/* Search & Tabs */}
            <div className="p-2 border-b border-slate-100 bg-slate-50/50">
                <div className="relative mb-2 px-2 pt-2">
                    <Search className="w-4 h-4 text-slate-400 absolute left-5 top-5" />
                    <input
                        id="ticket-search"
                        type="text"
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                        placeholder="Buscar tickets..."
                        className="w-full pl-9 pr-4 py-2.5 bg-white border border-slate-200 rounded-xl text-sm font-medium focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all shadow-sm"
                    />
                </div>
                <div className="flex gap-1 overflow-x-auto px-2 pb-2 scrollbar-hide">
                    {TABS.map(tab => (
                        <button
                            key={tab.id}
                            onClick={() => setFilterTab(tab.id)}
                            className={`flex items-center space-x-1.5 px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap transition-colors ${filterTab === tab.id
                                ? 'bg-slate-800 text-white shadow-sm'
                                : 'text-slate-500 hover:bg-slate-100'
                                }`}
                        >
                            <span>{tab.label}</span>
                            <span className={`px-1.5 py-0.5 rounded-md text-[10px] ${filterTab === tab.id ? 'bg-slate-700 text-slate-200' : 'bg-slate-100 text-slate-500'
                                }`}>{tab.count}</span>
                        </button>
                    ))}
                </div>
            </div>

            {/* List Items */}
            <div className="flex-1 overflow-y-auto p-2 space-y-1 bg-slate-50/30">
                {loading ? (
                    <>
                        <TicketSkeleton />
                        <TicketSkeleton />
                        <TicketSkeleton />
                    </>
                ) : tickets.length === 0 ? (
                    <div className="h-full flex flex-col items-center justify-center text-slate-400 p-8 text-center">
                        <Inbox className="w-12 h-12 mb-2 opacity-20" />
                        <p className="text-sm font-medium">No se encontraron tickets</p>
                    </div>
                ) : (
                    tickets.map(t => {
                        const isSelected = selectedTicketId === t.id;
                        const isUnread = !t.read;
                        const dateStr = formatDate(t.createdAt);
                        const status = getStatusConfig(t.status);

                        return (
                            <div
                                key={t.id}
                                onClick={() => onSelectTicket(t.id)}
                                className={`group relative p-3.5 rounded-xl cursor-pointer border transition-all duration-200 ${isSelected
                                    ? 'bg-white border-blue-500 shadow-md ring-1 ring-blue-500 z-10'
                                    : 'bg-white border-transparent hover:border-slate-200 hover:shadow-sm'
                                    } ${isUnread ? 'bg-blue-50/30' : ''}`}
                            >
                                <div className="flex justify-between items-start mb-1">
                                    <div className="flex items-center gap-2">
                                        {isUnread && <div className="w-2 h-2 bg-blue-500 rounded-full"></div>}
                                        <span className={`text-[10px] font-black px-1.5 py-0.5 rounded uppercase ${t.urgency === 'critical' ? 'bg-rose-100 text-rose-700' :
                                            t.urgency === 'high' ? 'bg-amber-100 text-amber-700' :
                                                'bg-slate-100 text-slate-600'
                                            }`}>
                                            {t.urgency === 'critical' ? 'SOS' : t.urgency === 'high' ? 'Alta' : 'Normal'}
                                        </span>

                                        <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded uppercase border ${status.bg} ${status.text} ${status.border}`}>
                                            {status.label}
                                        </span>
                                        {t.category && (
                                            <span className="text-[10px] font-bold text-slate-400 uppercase tracking-wide">
                                                {t.category}
                                            </span>
                                        )}
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <span className="text-[10px] font-bold text-slate-400">{dateStr}</span>
                                        <button
                                            onClick={(e) => onToggleRead(e, t.id, t.read)}
                                            className={`p-1 rounded-md hover:bg-slate-100 transition ${t.read ? 'text-slate-300' : 'text-blue-500'}`}
                                        >
                                            {t.read ? <EyeOff className="w-3 h-3" /> : <Eye className="w-3 h-3" />}
                                        </button>
                                    </div>
                                </div>

                                <h4 className={`text-sm font-bold mb-1 line-clamp-1 ${isSelected ? 'text-blue-900' : isUnread ? 'text-slate-900' : 'text-slate-700'
                                    }`}>
                                    {t.subject}
                                </h4>

                                <div className="flex items-center justify-between">
                                    <p className="text-xs text-slate-500 truncate flex-1 pr-2">{t.email}</p>
                                    {t.status === 'resolved' && <CheckCircle className="w-3 h-3 text-emerald-500 shrink-0" />}
                                </div>
                            </div>
                        );
                    })
                )}
            </div>
        </div>
    );
};

export default TicketList;



================================================================================
FILE: src\components\admin\users\UserTable.jsx
================================================================================
import React, { useRef, useState, useEffect } from 'react';
import PropTypes from 'prop-types';
import { MoreVertical, Shield, Trash2, Ban } from 'lucide-react';
import { getRoleConfig, getStatusConfig } from '../../../lib/constants';
import { formatDate } from '../../../utils/formatDate';

// --- ROW COMPONENT (Pure for performance) ---
const UserRow = ({ user, style, actions, onAction, currentUserRole }) => {
    const roleConfig = getRoleConfig(user.role);
    const statusConfig = getStatusConfig(user.status);

    return (
        <div style={style} className="flex items-center border-b border-white/5 hover:bg-white/5 transition-colors px-4 group">
            {/* User Info */}
            <div className="flex-1 flex items-center gap-3 min-w-[200px]">
                <div className="w-8 h-8 rounded-full bg-indigo-500/20 flex items-center justify-center text-xs font-bold text-indigo-300 ring-1 ring-inset ring-indigo-500/30">
                    {user.email.substring(0, 2).toUpperCase()}
                </div>
                <div className="flex flex-col">
                    <span className="text-sm font-bold text-white tracking-tight">{user.displayName || 'Usuario Sin Nombre'}</span>
                    <span className="text-xs text-slate-400 font-mono">{user.email}</span>
                </div>
            </div>

            {/* Role */}
            <div className="w-[150px] hidden md:flex">
                <span className={`px-2 py-0.5 rounded text-[10px] font-bold uppercase border ${roleConfig.bg === 'bg-slate-100' ? 'bg-slate-800 text-slate-300 border-slate-700' :
                    roleConfig.bg.replace('bg-', 'bg-').replace('100', '500/10') + ' ' + roleConfig.text.replace('800', '400') + ' ' + roleConfig.border.replace('200', '500/20')
                    } flex items-center gap-1`}>
                    <Shield className="w-3 h-3" />
                    {roleConfig.label}
                </span>
            </div>

            {/* Status */}
            <div className="w-[120px] hidden sm:flex">
                <span className={`px-2 py-0.5 rounded text-[10px] font-bold uppercase border ${statusConfig.bg === 'bg-emerald-100' ? 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20' :
                    'bg-rose-500/10 text-rose-400 border-rose-500/20'
                    }`}>
                    {statusConfig.label}
                </span>
            </div>

            {/* Date */}
            <div className="w-[150px] hidden lg:flex text-xs text-slate-500 font-medium font-mono">
                {formatDate(user.createdAt)}
            </div>

            {/* Actions */}
            <div className="w-[60px] flex justify-end">
                {currentUserRole === 'admin' && (
                    <div className="flex items-center gap-1 opacity-100 md:opacity-0 md:group-hover:opacity-100 transition-opacity">
                        <button
                            onClick={() => onAction('toggleStatus', user)}
                            className="p-1.5 text-slate-400 hover:text-amber-400 rounded hover:bg-amber-500/10 transition-colors"
                            title={user.status === 'active' ? "Bloquear" : "Desbloquear"}
                        >
                            <Ban className="w-4 h-4" />
                        </button>
                        <button
                            onClick={() => onAction('delete', user)}
                            className="p-1.5 text-slate-400 hover:text-rose-400 rounded hover:bg-rose-500/10 transition-colors"
                            title="Eliminar Usuario"
                        >
                            <Trash2 className="w-4 h-4" />
                        </button>
                    </div>
                )}
            </div>
        </div>
    );
};

UserRow.propTypes = {
    user: PropTypes.object.isRequired,
    style: PropTypes.object,
    onAction: PropTypes.func.isRequired,
    currentUserRole: PropTypes.string.isRequired
};

// --- VIRTUALIZED TABLE ---

const ROW_HEIGHT = 60; // Fixed height strictly enforced

const UserTable = ({ users, onAction, currentUserRole }) => {
    const containerRef = useRef(null);
    const [scrollTop, setScrollTop] = useState(0);
    const [containerHeight, setContainerHeight] = useState(600);

    // Dynamic resize handler
    useEffect(() => {
        const handleResize = () => {
            if (containerRef.current) {
                setContainerHeight(containerRef.current.clientHeight);
            }
        };
        // Initial set
        handleResize();
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
    }, []);

    // Virtualization Logic
    const totalContentHeight = users.length * ROW_HEIGHT;
    const startIndex = Math.max(0, Math.floor(scrollTop / ROW_HEIGHT) - 2); // Buffer top
    const endIndex = Math.min(users.length, Math.floor((scrollTop + containerHeight) / ROW_HEIGHT) + 2); // Buffer bottom
    const visibleUsers = users.slice(startIndex, endIndex);
    const offsetY = startIndex * ROW_HEIGHT;

    const handleScroll = (e) => {
        requestAnimationFrame(() => {
            setScrollTop(e.target.scrollTop);
        });
    };

    if (users.length === 0) {
        return (
            <div className="h-[400px] flex flex-col items-center justify-center text-slate-400 border-0 rounded-xl glass-panel-exec">
                <p className="font-bold">No se encontraron usuarios</p>
            </div>
        );
    }

    return (
        <div className="glass-panel-exec rounded-xl overflow-hidden shadow-lg flex flex-col h-full ring-1 ring-white/10">
            {/* Header - Fixed to avoid scroll */}
            <div className="bg-white/5 border-b border-white/5 flex items-center px-4 h-[40px] shrink-0 backdrop-blur-sm">
                <div className="flex-1 text-xs font-bold text-indigo-300 uppercase tracking-wider">Usuario</div>
                <div className="w-[150px] hidden md:block text-xs font-bold text-indigo-300 uppercase tracking-wider">Rol</div>
                <div className="w-[120px] hidden sm:block text-xs font-bold text-indigo-300 uppercase tracking-wider">Estado</div>
                <div className="w-[150px] hidden lg:block text-xs font-bold text-indigo-300 uppercase tracking-wider">Fecha Registro</div>
                <div className="w-[60px]"></div>
            </div>

            {/* Virtual Scroll Container */}
            <div
                ref={containerRef}
                onScroll={handleScroll}
                className="flex-1 overflow-y-auto relative custom-scrollbar"
                style={{ height: '100%' }}
            >
                <div style={{ height: totalContentHeight, position: 'relative' }}>
                    <div style={{ transform: `translateY(${offsetY}px)` }}>
                        {visibleUsers.map((user) => (
                            <UserRow
                                key={user.uid || user.id}
                                user={user}
                                style={{ height: ROW_HEIGHT }}
                                onAction={onAction}
                                currentUserRole={currentUserRole}
                            />
                        ))}
                    </div>
                </div>
            </div>
        </div>
    );
};

UserTable.propTypes = {
    users: PropTypes.array.isRequired,
    onAction: PropTypes.func.isRequired,
    currentUserRole: PropTypes.string.isRequired
};

export default UserTable;



================================================================================
FILE: src\components\AdminDashboard.jsx
================================================================================
import React, { useState } from 'react';
import PropTypes from 'prop-types';
import {
    Activity,
    Truck,
    AlertTriangle,
    DollarSign,
    Wallet,
    Percent,
    Store,
    Calendar,
    Download
} from 'lucide-react';
import { useAdminDashboardData } from '../hooks/useAdminDashboardData';
import { useIntelligence } from '../hooks/useIntelligence';
import { useUserManager } from '../hooks/useUserManager';
import { useAuth } from '../context/AuthContext';

// Sub-components
import NetworkStatusWidget from './NetworkStatusWidget';
import TrendsSection from './admin/dashboard/TrendsSection';
import OperationalMetrics from './admin/dashboard/OperationalMetrics';
import IntelligenceWidget from './admin/dashboard/IntelligenceWidget';
import OperationsDashboard from './OperationsDashboard';
import FleetManager from './FleetManager';
import ShiftPlanner from './ShiftPlanner';
import FranchiseOnboarding from './FranchiseOnboarding';
import DashboardSkeleton from './DashboardSkeleton';
import EmptyState from './ui/EmptyState';
import ErrorBoundary from './common/ErrorBoundary';

/**
 * CFO Stat Card
 * Strict font-mono for numbers.
 */
const StatCard = ({ title, value, change, icon: Icon, color, trend, subtext }) => (
    <div className="glass-panel-exec p-6 rounded-xl hover:shadow-lg transition-transform duration-300 hover:-translate-y-1 flex flex-col justify-between h-full group">
        <div className="flex justify-between items-start mb-2">
            <div className={`p-2.5 rounded-lg ${color} bg-opacity-20 group-hover:bg-opacity-30 transition-all`}>
                <Icon className={`w-5 h-5 ${color.replace('bg-', 'text-')}-300`} />
            </div>
            {change && (
                <div className="text-right">
                    <span className={`text-[10px] font-bold px-2 py-1 rounded-full border ${trend === 'up' ? 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20' :
                        'bg-rose-500/10 text-rose-400 border-rose-500/20'
                        }`}>
                        {change}
                    </span>
                </div>
            )}
        </div>
        <div>
            <h3 className="text-slate-400 text-xs font-bold uppercase tracking-widest mb-1">{title}</h3>
            <p className="text-3xl font-bold text-white tracking-tight font-mono leading-none drop-shadow-sm">{value}</p>
            {subtext && <p className="text-[10px] text-slate-500 mt-2 font-medium font-mono">{subtext}</p>}
        </div>
    </div>
);

const AdminDashboard = ({
    onSelectFranchise, // eslint-disable-line no-unused-vars
    selectedMonth,
    onMonthChange, // eslint-disable-line no-unused-vars
    onManageTariffs, // eslint-disable-line no-unused-vars
    onOpenSimulator // eslint-disable-line no-unused-vars
}) => {
    const { user } = useAuth();
    const [selectedPanel, setSelectedPanel] = useState('dashboard');

    // 1. Data Hooks
    const { stats, trendData, franchises, loading, error } = useAdminDashboardData(selectedMonth);
    const { users } = useUserManager(); // Needed for Intelligence

    // 2. Intelligence Engine
    const { healthScore, alerts, predictions } = useIntelligence({
        tickets: [], // Optional/Empty for CFO view to avoid noise
        users: users || [],
        dashboardData: stats
    });

    const renderDashboardView = () => {
        if (loading) return <DashboardSkeleton />;
        if (error) return <EmptyState title="Error de conexi√≥n" description={error} icon={AlertTriangle} />;

        // Safe Fallback
        const safeStats = stats || { totalRevenue: 0, totalProfit: 0, margin: 0, franchiseCount: 0 };

        return (
            <div className="space-y-6 animate-in fade-in duration-500">

                {/* ROW 1: Header (Financial KPIs) */}
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <StatCard
                        title="Ingresos Totales"
                        value={`$${safeStats.totalRevenue.toLocaleString()}`}
                        icon={DollarSign}
                        color="bg-emerald-500"
                        change="+12.5%" trend="up"
                    />
                    <StatCard
                        title="Beneficio Neto"
                        value={`$${safeStats.totalProfit.toLocaleString()}`}
                        icon={Wallet}
                        color="bg-indigo-500"
                        change="+8.2%" trend="up"
                    />
                    <StatCard
                        title="Margen Global"
                        value={`${safeStats.margin.toFixed(1)}%`}
                        icon={Percent}
                        color="bg-blue-500"
                        change="+1.1%" trend="up"
                    />
                    <StatCard
                        title="Franquicias Activas"
                        value={safeStats.franchiseCount.toString()}
                        icon={Store}
                        color="bg-amber-500"
                        change="+2" trend="up"
                    />
                </div>

                {/* ROW 2: Main Body (Charts & Intelligence) */}
                <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 items-stretch">

                    {/* Left: Trends (8 cols) */}
                    <div className="lg:col-span-8">
                        <TrendsSection trendData={trendData || []} />
                    </div>

                    {/* Right: Intelligence (4 cols) */}
                    <div className="lg:col-span-4 h-full">
                        <ErrorBoundary>
                            <IntelligenceWidget
                                healthScore={healthScore}
                                alerts={alerts}
                                predictions={predictions}
                            />
                        </ErrorBoundary>
                    </div>
                </div>

                {/* ROW 3: Footer Operativo (Network & Costs) */}
                <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 items-start">

                    {/* Left: Network Status (8 cols) */}
                    <div className="lg:col-span-8">
                        <NetworkStatusWidget franchises={franchises || []} />
                    </div>

                    {/* Right: Cost Structure (4 cols) */}
                    <div className="lg:col-span-4">
                        <div className="glass-panel-exec rounded-xl overflow-hidden">
                            {/* Header Injection for 'Estructura de Costes' */}
                            <div className="px-6 py-4 border-b border-white/5 bg-white/5">
                                <h3 className="text-sm font-bold text-slate-300 uppercase tracking-wide">
                                    Estructura de Costes
                                </h3>
                            </div>
                            <div className="-mt-4">
                                {/* Negative margin to pull OperationalMetrics content up if it has padding, 
                                    or just let it render. Since we can't easily change OperationalMetrics internals,
                                    we wrap it cleanly. */}
                                <OperationalMetrics franchises={franchises || []} />
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        );
    };

    const renderPanel = () => {
        switch (selectedPanel) {
            case 'dashboard': return renderDashboardView();
            case 'operations': return <OperationsDashboard readOnly={true} />;
            case 'fleet': return <FleetManager />;
            case 'shifts': return <ShiftPlanner />;
            case 'onboarding': return (
                <FranchiseOnboarding
                    onCancel={() => setSelectedPanel('dashboard')}
                    onComplete={() => setSelectedPanel('dashboard')}
                />
            );
            default: return renderDashboardView();
        }
    };

    const navItems = [
        { id: 'dashboard', label: 'CFO Overview', icon: Activity },
        { id: 'operations', label: 'Centro de Operaciones', icon: Truck },
    ];

    return (
        <div className="min-h-screen bg-transparent font-sans text-slate-100">
            <div className="max-w-[1600px] mx-auto p-6 lg:p-8">

                {/* TOOLBAR */}
                <div className="flex flex-col md:flex-row md:items-end justify-between gap-6 mb-8 border-b border-white/10 pb-6">
                    <div>
                        <h1 className="text-2xl font-bold text-white tracking-tight">CFO Command Center</h1>
                        <p className="text-sm text-slate-400 font-medium mt-1">
                            Visi√≥n financiera global. {user?.displayName}
                        </p>
                    </div>

                    <div className="flex items-center gap-3">
                        <div className="flex items-center glass-panel-exec border-0 rounded-lg px-3 py-2 shadow-sm">
                            <Calendar className="w-4 h-4 text-indigo-400 mr-2" />
                            <span className="text-sm font-semibold text-slate-200 font-mono">{selectedMonth || 'Dic 2025'}</span>
                        </div>
                        <button className="flex items-center gap-2 glass-panel-exec hover:bg-white/10 text-slate-200 px-4 py-2 rounded-lg text-sm font-bold transition shadow-sm border-0">
                            <Download className="w-4 h-4" /> Exportar
                        </button>
                    </div>
                </div>

                {/* NAV */}
                <div className="flex space-x-2 mb-8">
                    {navItems.map(item => (
                        <button
                            key={item.id}
                            onClick={() => setSelectedPanel(item.id)}
                            className={`flex items-center px-4 py-2 rounded-lg text-sm font-bold transition-all ${selectedPanel === item.id
                                ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-500/20'
                                : 'glass-panel-exec text-slate-400 hover:text-white hover:bg-white/10'
                                }`}
                        >
                            <item.icon className="w-4 h-4 mr-2" />
                            {item.label}
                        </button>
                    ))}
                </div>

                {/* CONTENT */}
                {renderPanel()}
            </div>
        </div>
    );
};

AdminDashboard.propTypes = {
    selectedMonth: PropTypes.string,
    onSelectFranchise: PropTypes.func,
    onMonthChange: PropTypes.func,
    onManageTariffs: PropTypes.func,
    onOpenSimulator: PropTypes.func
};

export default AdminDashboard;



================================================================================
FILE: src\components\AdminResourcesPanel.jsx
================================================================================
import React, { useState, useEffect, useMemo } from 'react';
import { db, storage } from '../lib/firebase';
import { collection, addDoc, deleteDoc, updateDoc, doc, query, orderBy, onSnapshot, serverTimestamp } from 'firebase/firestore';
import { ref, uploadBytesResumable, deleteObject, getDownloadURL } from 'firebase/storage';
import {
    Upload, Trash2, FileText, Loader2, X, Search, Grid, List,
    Folder, Image, File, Filter, Cloud, Star, Download
} from 'lucide-react';

const AdminResourcesPanel = () => {
    // Data State
    const [resources, setResources] = useState([]);
    const [loading, setLoading] = useState(true);

    // Upload State
    const [uploading, setUploading] = useState(false);
    const [progress, setProgress] = useState(0);
    const [dragActive, setDragActive] = useState(false);

    // View/Filter State
    const [viewMode, setViewMode] = useState('grid'); // 'grid' | 'list'
    const [searchQuery, setSearchQuery] = useState('');
    const [categoryFilter, setCategoryFilter] = useState('all');

    // Form State (kept for modal/upload logic)
    const [title, setTitle] = useState('');
    const [category, setCategory] = useState('marketing');
    const [file, setFile] = useState(null);

    // Initial Data Fetch
    useEffect(() => {
        const q = query(collection(db, "resources"), orderBy("createdAt", "desc"));
        const unsubscribe = onSnapshot(q, snapshot => {
            setResources(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
            setLoading(false);
        });
        return () => unsubscribe();
    }, []);

    // Filter Logic sorted by PINNED first
    const filteredResources = useMemo(() => {
        const filtered = resources.filter(res => {
            const matchesSearch = res.title.toLowerCase().includes(searchQuery.toLowerCase());
            const matchesCategory = categoryFilter === 'all' || res.category === categoryFilter;
            return matchesSearch && matchesCategory;
        });

        // Sort: Pinned first, then by date (already sorted by query, but let's reinforce)
        return filtered.sort((a, b) => {
            if (a.isPinned === b.isPinned) return 0;
            return a.isPinned ? -1 : 1;
        });
    }, [resources, searchQuery, categoryFilter]);

    // Actions
    const handleTogglePin = async (e, resource) => {
        e.stopPropagation();
        try {
            await updateDoc(doc(db, "resources", resource.id), {
                isPinned: !resource.isPinned
            });
        } catch (error) {
            console.error("Error pinning:", error);
        }
    };

    const handleDownload = async (resource) => {
        // 1. Open immediately to avoid popup blockers and feel faster
        window.open(resource.url, '_blank');

        // 2. Track download in background (Fire and forget)
        try {
            await updateDoc(doc(db, "resources", resource.id), {
                downloadCount: (resource.downloadCount || 0) + 1
            });
        } catch (error) {
            console.error("Error tracking download:", error);
        }
    };

    /* ... Upload Handlers ... */
    const handleDrag = (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (e.type === "dragenter" || e.type === "dragover") {
            setDragActive(true);
        } else if (e.type === "dragleave") {
            setDragActive(false);
        }
    };

    const handleDrop = (e) => {
        e.preventDefault();
        e.stopPropagation();
        setDragActive(false);
        if (e.dataTransfer.files && e.dataTransfer.files[0]) {
            const droppedFile = e.dataTransfer.files[0];
            setFile(droppedFile);
            setTitle(droppedFile.name.split('.').slice(0, -1).join('.'));
        }
    };

    const handleFileSelect = (e) => {
        if (e.target.files && e.target.files[0]) {
            const selectedFile = e.target.files[0];
            setFile(selectedFile);
            setTitle(selectedFile.name.split('.').slice(0, -1).join('.'));
        }
    };

    const handleUpload = (e) => {
        e.preventDefault();
        if (!file || !title) return;

        setUploading(true);
        setProgress(0);

        const storageRef = ref(storage, `resources/${Date.now()}_${file.name}`);
        const uploadTask = uploadBytesResumable(storageRef, file);

        uploadTask.on('state_changed',
            (snapshot) => {
                const p = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                setProgress(p);
            },
            (error) => {
                console.error("Upload error:", error);
                alert("Error al subir: " + error.message);
                setUploading(false);
            },
            async () => {
                try {
                    const url = await getDownloadURL(uploadTask.snapshot.ref);
                    await addDoc(collection(db, "resources"), {
                        title,
                        category,
                        url,
                        storagePath: storageRef.fullPath,
                        type: file.type,
                        isPinned: false,
                        downloadCount: 0,
                        createdAt: serverTimestamp()
                    });
                    setTitle('');
                    setFile(null);
                    setProgress(0);
                } catch (err) {
                    console.error("Firestore save error:", err);
                    alert("Error al guardar referencia.");
                } finally {
                    setUploading(false);
                }
            }
        );
    };

    const handleDelete = async (resource) => {
        if (!confirm('¬øSeguro que quieres eliminar este recurso?')) return;
        try {
            if (resource.storagePath) {
                const storageRef = ref(storage, resource.storagePath);
                await deleteObject(storageRef).catch(err => console.warn("File not found", err));
            }
            await deleteDoc(doc(db, "resources", resource.id));
        } catch (error) {
            console.error("Delete error:", error);
            alert("Error al eliminar.");
        }
    };

    // Helper functions
    const getFileIcon = (type) => {
        if (type?.includes('image')) return <Image className="w-8 h-8 text-purple-500" />;
        if (type?.includes('pdf')) return <FileText className="w-8 h-8 text-rose-500" />;
        return <File className="w-8 h-8 text-blue-500" />;
    };

    const categories = [
        { id: 'all', label: 'Todos' },
        { id: 'marketing', label: 'Marketing' },
        { id: 'legal', label: 'Legal' },
        { id: 'operaciones', label: 'Operaciones' },
        { id: 'recursos_humanos', label: 'RR.HH.' },
        { id: 'otros', label: 'Otros' }
    ];

    return (
        <div className="p-4 md:p-8 max-w-7xl mx-auto min-h-screen relative overflow-hidden animate-fade-in-up">
            {/* Background Blob - Top Right */}
            <div className="absolute top-0 right-0 w-[500px] h-[500px] bg-blue-50/50 rounded-full blur-3xl -z-10 opacity-60"></div>
            {/* Background Blob - Bottom Left */}
            <div className="absolute bottom-0 left-0 w-[500px] h-[500px] bg-purple-50/50 rounded-full blur-3xl -z-10 opacity-60"></div>

            {/* Header */}
            <div className="mb-8 flex flex-col md:flex-row md:items-end justify-between gap-4">
                <div>
                    <h1 className="text-3xl font-black text-slate-800 tracking-tight mb-2">Centro de Recursos</h1>
                    <p className="text-slate-500 font-medium">Gestiona manuales y documentos para la red.</p>
                </div>

                {/* Stats */}
                <div className="flex gap-4">
                    <div className="bg-white/60 backdrop-blur-sm px-5 py-3 rounded-2xl border border-white/50 shadow-sm flex items-center gap-4">
                        <div className="p-2.5 bg-blue-50 rounded-xl text-blue-600">
                            <Cloud className="w-5 h-5" />
                        </div>
                        <div>
                            <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Total Archivos</p>
                            <p className="text-2xl font-black text-slate-800">{resources.length}</p>
                        </div>
                    </div>
                </div>
            </div>

            {/* Smart Upload Zone */}
            <div
                className={`mb-10 border-2 border-dashed rounded-3xl transition-all duration-300 relative overflow-hidden group
                    ${dragActive ? 'border-blue-500 bg-blue-50/50 scale-[1.01] shadow-xl' : 'border-slate-300/50 bg-white/60 hover:border-blue-300 hover:bg-white/80'}
                    ${file ? 'p-0 border-transparent shadow-lg ring-1 ring-black/5' : 'p-10'}
                `}
                onDragEnter={handleDrag}
                onDragLeave={handleDrag}
                onDragOver={handleDrag}
                onDrop={handleDrop}
            >
                {/* Upload Overlay Form - Shows when file selected */}
                {file ? (
                    <div className="p-8 bg-white animate-in fade-in slide-in-from-top-4 duration-300">
                        <div className="flex items-start justify-between mb-6">
                            <div className="flex items-center gap-4">
                                <div className="p-3 bg-blue-100 text-blue-600 rounded-2xl">
                                    <FileText className="w-8 h-8" />
                                </div>
                                <div>
                                    <h3 className="font-bold text-slate-800 text-xl">{file.name}</h3>
                                    <p className="text-slate-400 font-medium">{(file.size / 1024 / 1024).toFixed(2)} MB</p>
                                </div>
                            </div>
                            <button onClick={() => setFile(null)} className="p-2 hover:bg-slate-100 rounded-full text-slate-400 hover:text-slate-600 transition">
                                <X className="w-6 h-6" />
                            </button>
                        </div>

                        <form onSubmit={handleUpload} className="grid grid-cols-1 md:grid-cols-4 gap-6 items-end">
                            <div className="md:col-span-2 space-y-2">
                                <label className="text-xs font-bold text-slate-400 uppercase tracking-wider block ml-1">T√≠tulo Profesional</label>
                                <input
                                    type="text"
                                    value={title}
                                    onChange={e => setTitle(e.target.value)}
                                    className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition shadow-sm"
                                    placeholder="Ej: Manual de Operaciones 2024"
                                />
                            </div>
                            <div className="space-y-2">
                                <label className="text-xs font-bold text-slate-400 uppercase tracking-wider block ml-1">Etiqueta</label>
                                <div className="relative">
                                    <Filter className="w-4 h-4 text-slate-400 absolute left-3 top-3.5 z-10" />
                                    <select
                                        value={category}
                                        onChange={e => setCategory(e.target.value)}
                                        className="w-full pl-9 bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-blue-500 appearance-none transition shadow-sm cursor-pointer"
                                    >
                                        {categories.filter(c => c.id !== 'all').map(c => (
                                            <option key={c.id} value={c.id}>{c.label}</option>
                                        ))}
                                    </select>
                                </div>
                            </div>
                            <button
                                type="submit"
                                disabled={uploading}
                                className="h-[52px] bg-gradient-to-r from-blue-600 to-blue-500 text-white rounded-xl font-bold flex items-center justify-center gap-2 hover:shadow-lg hover:shadow-blue-200 hover:scale-[1.02] active:scale-95 transition-all relative overflow-hidden"
                            >
                                {uploading ? (
                                    <>
                                        <div className="absolute inset-y-0 left-0 bg-blue-700 transition-all duration-300" style={{ width: `${progress}%`, zIndex: 0 }}></div>
                                        <div className="relative z-10 flex items-center gap-2">
                                            <Loader2 className="w-4 h-4 animate-spin" />
                                            {Math.round(progress)}%
                                        </div>
                                    </>
                                ) : (
                                    <>
                                        <Upload className="w-5 h-5" /> <span className="tracking-wide">SUBIR AHORA</span>
                                    </>
                                )}
                            </button>
                        </form>
                    </div>
                ) : (
                    // Default Drag State
                    <div className="flex flex-col items-center justify-center text-center cursor-pointer py-10" onClick={() => document.getElementById('file-upload').click()}>
                        <div className="w-20 h-20 bg-white shadow-sm border border-slate-100 rounded-3xl flex items-center justify-center mb-6 group-hover:scale-110 group-hover:rotate-3 transition-all duration-300">
                            <Cloud className={`w-10 h-10 ${dragActive ? 'text-blue-500' : 'text-slate-400'}`} />
                        </div>
                        <h3 className="text-xl font-black text-slate-700 mb-2">
                            {dragActive ? '¬°Suelta el archivo aqu√≠!' : 'Arrastra tus documentos aqu√≠'}
                        </h3>
                        <p className="text-slate-400 font-medium text-sm">o haz clic para explorar tus carpetas locales</p>
                        <input id="file-upload" type="file" className="hidden" onChange={handleFileSelect} />
                    </div>
                )}
            </div>

            {/* Toolbar */}
            <div className="bg-white/70 backdrop-blur-md p-2 rounded-2xl shadow-sm border border-white/50 mb-8 flex flex-col md:flex-row gap-4 items-center justify-between sticky top-6 z-30 transition-all">
                {/* Search */}
                <div className="relative flex-1 w-full md:w-auto">
                    <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
                    <input
                        type="text"
                        placeholder="Buscar archivo por nombre..."
                        value={searchQuery}
                        onChange={e => setSearchQuery(e.target.value)}
                        className="w-full pl-10 pr-4 py-2.5 bg-slate-50/50 border-none rounded-xl font-medium text-slate-600 placeholder:text-slate-400 focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all"
                    />
                </div>

                {/* Filters & Toggles */}
                <div className="flex items-center gap-2 w-full md:w-auto overflow-x-auto pb-2 md:pb-0 scrollbar-hide">
                    <div className="flex bg-slate-100/50 p-1 rounded-xl gap-1">
                        {categories.map(cat => (
                            <button
                                key={cat.id}
                                onClick={() => setCategoryFilter(cat.id)}
                                className={`px-4 py-2 rounded-lg text-xs font-bold transition-all whitespace-nowrap ${categoryFilter === cat.id ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-400 hover:text-slate-600 hover:bg-white/50'
                                    }`}
                            >
                                {cat.label}
                            </button>
                        ))}
                    </div>

                    <div className="w-px h-8 bg-slate-200 mx-2 hidden md:block"></div>

                    <div className="flex bg-slate-100/50 p-1 rounded-xl gap-1 hidden md:flex">
                        <button
                            onClick={() => setViewMode('grid')}
                            className={`p-2 rounded-lg transition-all ${viewMode === 'grid' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-400 hover:bg-white/50'}`}
                        >
                            <Grid className="w-4 h-4" />
                        </button>
                        <button
                            onClick={() => setViewMode('list')}
                            className={`p-2 rounded-lg transition-all ${viewMode === 'list' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-400 hover:bg-white/50'}`}
                        >
                            <List className="w-4 h-4" />
                        </button>
                    </div>
                </div>
            </div>

            {/* Main Content Area */}
            {/* Main Content Area */}
            {loading ? (
                <div className="flex items-center justify-center h-64">
                    <Loader2 className="w-10 h-10 text-blue-600 animate-spin" />
                </div>
            ) : filteredResources.length === 0 ? (
                <div className="text-center py-24 bg-white/40 backdrop-blur-sm rounded-3xl border border-dashed border-slate-200/50">
                    <div className="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-4">
                        <Folder className="w-10 h-10 text-slate-300" />
                    </div>
                    <h3 className="text-xl font-bold text-slate-800 mb-2">No se encontraron archivos</h3>
                    <p className="text-slate-400">Prueba a buscar con otro t√©rmino o sube un nuevo documento.</p>
                </div>
            ) : (
                <>
                    {/* Grid View */}
                    {viewMode === 'grid' && (
                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                            {filteredResources.map(resource => (
                                <ResourceCard
                                    key={resource.id}
                                    resource={resource}
                                    onDownload={handleDownload}
                                    onPin={handleTogglePin}
                                    onDelete={handleDelete}
                                    getFileIcon={getFileIcon}
                                />
                            ))}
                        </div>
                    )}

                    {/* List View */}
                    {viewMode === 'list' && (
                        <div className="bg-white/80 backdrop-blur-md rounded-3xl border border-white/60 overflow-hidden shadow-xl shadow-slate-100/50">
                            <table className="w-full text-left border-collapse">
                                <thead className="bg-slate-50/80 border-b border-slate-200">
                                    <tr>
                                        <th className="p-5 text-xs font-black text-slate-400 uppercase tracking-wider pl-8 w-10"></th>
                                        <th className="p-5 text-xs font-black text-slate-400 uppercase tracking-wider">Nombre</th>
                                        <th className="p-5 text-xs font-black text-slate-400 uppercase tracking-wider">Categor√≠a</th>
                                        <th className="p-5 text-xs font-black text-slate-400 uppercase tracking-wider text-center">Descargas</th>
                                        <th className="p-5 text-xs font-black text-slate-400 uppercase tracking-wider text-right pr-8">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {filteredResources.map(resource => (
                                        <ResourceRow
                                            key={resource.id}
                                            resource={resource}
                                            onDownload={handleDownload}
                                            onPin={handleTogglePin}
                                            onDelete={handleDelete}
                                            getFileIcon={getFileIcon}
                                        />
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </>
            )}
        </div>
    );
};

// --- MEMOIZED COMPONENTS ---

const ResourceCard = React.memo(({ resource, onDownload, onPin, onDelete, getFileIcon }) => (
    <div className="group bg-white/80 backdrop-blur-md p-4 rounded-3xl border border-white/60 shadow-lg shadow-slate-100/50 hover:shadow-xl hover:scale-[1.02] transition-all duration-300 relative cursor-pointer" onClick={() => onDownload(resource)}>

        {/* Pin Button */}
        <button
            onClick={(e) => onPin(e, resource)}
            className={`absolute top-4 left-4 z-20 p-2 rounded-full transition-all ${resource.isPinned ? 'text-amber-400 bg-white shadow-sm' : 'text-slate-300 hover:text-amber-400 bg-black/5 hover:bg-white'}`}
        >
            <Star className={`w-4 h-4 ${resource.isPinned ? 'fill-current' : ''}`} />
        </button>

        {/* Action Menu Trigger (Visible on Hover) */}
        <button
            onClick={(e) => { e.stopPropagation(); onDelete(resource); }}
            className="absolute top-4 right-4 p-2 bg-white/90 rounded-full text-slate-400 hover:text-rose-500 hover:bg-rose-50 opacity-0 group-hover:opacity-100 transition-all z-20 shadow-sm"
            title="Eliminar archivo"
        >
            <Trash2 className="w-4 h-4" />
        </button>

        {/* Card Content */}
        <div className="flex flex-col h-full bg-slate-50/50 rounded-2xl overflow-hidden border border-slate-100">
            <div className="h-40 flex items-center justify-center bg-slate-100/50 relative overflow-hidden group-hover:bg-blue-50/30 transition duration-500">
                {resource.type?.includes('image') ? (
                    <img src={resource.url} alt={resource.title} className="w-full h-full object-cover opacity-90 group-hover:opacity-100 group-hover:scale-110 transition duration-700" />
                ) : (
                    <div className="scale-150 transform transition group-hover:scale-125 duration-300">{getFileIcon(resource.type)}</div>
                )}

                {/* Type Badge */}
                <span className="absolute bottom-3 left-3 px-2.5 py-1 bg-black/60 backdrop-blur-md text-white text-[10px] font-bold rounded-lg uppercase tracking-wider">
                    {resource.category}
                </span>
            </div>

            <div className="p-5 bg-white/50 backdrop-blur-sm flex-1 flex flex-col justify-between">
                <div>
                    <h3 className="font-bold text-slate-700 text-sm mb-2 line-clamp-2 leading-relaxed" title={resource.title}>{resource.title}</h3>
                    <p className="text-xs text-slate-400 flex items-center gap-1">
                        <span className="bg-slate-100 px-1.5 py-0.5 rounded text-[10px] uppercase font-bold tracking-wider">{resource.type?.split('/')[1] || 'FILE'}</span>
                    </p>
                </div>

                <div className="mt-4 pt-4 border-t border-slate-100 flex items-center justify-between text-xs text-slate-400">
                    <span>{resource.createdAt ? new Date(resource.createdAt.seconds * 1000).toLocaleDateString() : 'Procesando...'}</span>
                    <span className="flex items-center gap-1 group-hover:text-blue-600 transition-colors">
                        <Download className="w-3 h-3" /> {resource.downloadCount || 0}
                    </span>
                </div>
            </div>
        </div>
    </div>
));

const ResourceRow = React.memo(({ resource, onDownload, onPin, onDelete, getFileIcon }) => (
    <tr className="hover:bg-blue-50/40 transition group cursor-pointer" onClick={() => onDownload(resource)}>
        <td className="p-5 pl-8">
            <button
                onClick={(e) => onPin(e, resource)}
                className={`transition-all ${resource.isPinned ? 'text-amber-400' : 'text-slate-200 hover:text-amber-400'}`}
            >
                <Star className={`w-4 h-4 ${resource.isPinned ? 'fill-current' : ''}`} />
            </button>
        </td>
        <td className="p-5">
            <div className="flex items-center gap-4">
                <div className="p-2.5 bg-slate-100 rounded-xl group-hover:scale-110 transition-transform duration-300 shadow-sm border border-slate-200">
                    {getFileIcon(resource.type)}
                </div>
                <div>
                    <div className="font-bold text-slate-700 text-sm group-hover:text-blue-700 transition">{resource.title}</div>
                    <div className="text-[10px] text-slate-400 uppercase font-bold tracking-wider mt-0.5">{resource.type?.split('/')[1]}</div>
                </div>
            </div>
        </td>
        <td className="p-5">
            <span className="px-3 py-1.5 bg-slate-100 text-slate-500 text-[10px] font-black uppercase rounded-lg tracking-wide border border-slate-200">
                {resource.category}
            </span>
        </td>
        <td className="p-5 text-center">
            <span className="text-xs font-bold text-slate-500 flex items-center justify-center gap-1 bg-slate-50 py-1 rounded-md">
                <Download className="w-3 h-3" /> {resource.downloadCount || 0}
            </span>
        </td>
        <td className="p-5 text-right pr-8">
            <button
                onClick={(e) => { e.stopPropagation(); onDelete(resource); }}
                className="p-2 text-slate-300 hover:text-rose-600 hover:bg-rose-50 rounded-xl transition"
            >
                <Trash2 className="w-4 h-4" />
            </button>
        </td>
    </tr>
));

export default AdminResourcesPanel;



================================================================================
FILE: src\components\AdminSimulationEditor.jsx
================================================================================
import React, { useState } from 'react';
import { Gamepad2, X, Edit2 } from 'lucide-react';

const AdminSimulationEditor = ({ simulationData = [], onChange }) => {
    const [currentScene, setCurrentScene] = useState({
        id: (simulationData?.length || 0) + 1,
        text: '',
        choices: [{ text: '', nextScene: 'next', feedback: '' }]
    });
    const [editingSceneIndex, setEditingSceneIndex] = useState(null);

    const handleAddChoice = () => {
        setCurrentScene({
            ...currentScene,
            choices: [...currentScene.choices, { text: '', nextScene: 'next', feedback: '' }]
        });
    };

    const handleChoiceChange = (idx, field, value) => {
        const newChoices = [...currentScene.choices];
        newChoices[idx] = { ...newChoices[idx], [field]: value };
        setCurrentScene({ ...currentScene, choices: newChoices });
    };

    const addSceneToSimulation = () => {
        if (!currentScene.text) {
            alert("Escribe el texto de la escena");
            return;
        }

        let newData;
        if (editingSceneIndex !== null) {
            newData = [...simulationData];
            newData[editingSceneIndex] = currentScene;
            setEditingSceneIndex(null);
        } else {
            newData = [...simulationData, { ...currentScene, id: simulationData.length + 1 }];
        }

        onChange(newData);

        // Reset scene builder
        setCurrentScene({
            id: newData.length + 1,
            text: '',
            choices: [{ text: '', nextScene: 'next', feedback: '' }]
        });
    };

    const handleEditScene = (scene, idx) => {
        setCurrentScene(scene);
        setEditingSceneIndex(idx);
    };

    const handleDeleteScene = (idx) => {
        const newData = simulationData.filter((_, i) => i !== idx);
        onChange(newData);
    };

    return (
        <div className="max-w-4xl mx-auto animate-in fade-in">
            <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm mb-6">
                <h3 className="font-bold text-slate-700 mb-4 flex items-center gap-2">
                    <Gamepad2 className="w-4 h-4 text-orange-600" />
                    {editingSceneIndex !== null ? `Editar Escena #${editingSceneIndex + 1}` : 'Nueva Escena'}
                </h3>

                <div className="mb-4">
                    <label className="block text-xs font-bold text-slate-400 uppercase mb-1">Narrativa de la Escena</label>
                    <textarea
                        className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg font-medium focus:ring-2 focus:ring-orange-500 focus:outline-none h-24"
                        placeholder="Describe la situaci√≥n: 'El cliente entra enfadado...'"
                        value={currentScene.text}
                        onChange={e => setCurrentScene({ ...currentScene, text: e.target.value })}
                    />
                </div>

                <div className="space-y-3 mb-4">
                    <label className="block text-xs font-bold text-slate-400 uppercase">Opciones de Decisi√≥n</label>
                    {currentScene.choices.map((choice, idx) => (
                        <div key={idx} className="flex gap-2 items-start p-3 bg-slate-50 rounded-lg border border-slate-100">
                            <div className="flex-1 space-y-2">
                                <input
                                    className="w-full p-2 text-sm border border-slate-200 rounded bg-white"
                                    placeholder="Texto de la opci√≥n (ej: 'Pedir disculpas')"
                                    value={choice.text}
                                    onChange={e => handleChoiceChange(idx, 'text', e.target.value)}
                                />
                                <div className="flex gap-2">
                                    <input
                                        className="flex-1 p-2 text-xs border border-slate-200 rounded bg-white"
                                        placeholder="Feedback (ej: 'Buena elecci√≥n, se calma.')"
                                        value={choice.feedback}
                                        onChange={e => handleChoiceChange(idx, 'feedback', e.target.value)}
                                    />
                                    <select
                                        className="w-32 p-2 text-xs border border-slate-200 rounded bg-white"
                                        value={choice.nextScene}
                                        onChange={e => handleChoiceChange(idx, 'nextScene', e.target.value)}
                                    >
                                        <option value="next">Siguiente (+1)</option>
                                        <option value="end_success">Fin (√âxito)</option>
                                        <option value="end_fail">Fin (Fallo)</option>
                                        {simulationData.map((s, i) => (
                                            <option key={s.id} value={s.id}>Escena {i + 1}</option>
                                        ))}
                                    </select>
                                </div>
                            </div>
                            <button
                                onClick={() => {
                                    const newChoices = currentScene.choices.filter((_, i) => i !== idx);
                                    setCurrentScene({ ...currentScene, choices: newChoices });
                                }}
                                className="p-1 hover:bg-rose-100 text-rose-400 rounded"
                            >
                                <X className="w-4 h-4" />
                            </button>
                        </div>
                    ))}
                    <button
                        onClick={handleAddChoice}
                        className="text-xs font-bold text-orange-600 hover:bg-orange-50 px-3 py-1.5 rounded-lg border border-orange-200 border-dashed w-full"
                    >
                        + A√±adir Opci√≥n
                    </button>
                </div>

                <div className="flex justify-end pt-4 border-t border-slate-100">
                    <button
                        onClick={addSceneToSimulation}
                        className="px-6 py-2 bg-orange-600 text-white rounded-lg font-bold hover:bg-orange-700 transition shadow-md"
                    >
                        {editingSceneIndex !== null ? 'Guardar Cambios' : 'A√±adir Escena'}
                    </button>
                </div>
            </div>

            {/* Scene List Preview */}
            <div className="space-y-4">
                {simulationData.length === 0 && (
                    <div className="text-center p-8 bg-white rounded-xl border border-dashed border-slate-200">
                        <Gamepad2 className="w-12 h-12 text-slate-300 mx-auto mb-2" />
                        <p className="text-slate-400 font-medium">No hay escenas creadas. ¬°Empieza la aventura!</p>
                    </div>
                )}
                {simulationData.map((scene, idx) => (
                    <div key={idx} className="bg-white p-4 rounded-xl border border-slate-200 flex gap-4 group hover:shadow-md transition-all relative">
                        <div className="w-8 h-8 flex-shrink-0 bg-slate-100 rounded-full flex items-center justify-center font-black text-slate-500 text-sm border-2 border-white shadow-sm">
                            {idx + 1}
                        </div>
                        <div className="flex-1">
                            <p className="font-medium text-slate-800 text-sm mb-2 line-clamp-2">"{scene.text}"</p>
                            <div className="flex gap-2 flex-wrap">
                                {scene.choices.map((c, cIdx) => (
                                    <span key={cIdx} className="text-[10px] bg-slate-50 border border-slate-100 px-2 py-1 rounded text-slate-500">
                                        {c.text} ‚Üí {c.nextScene === 'next' ? 'Sig.' : c.nextScene === 'end_success' ? 'üèÜ' : c.nextScene === 'end_fail' ? 'üíÄ' : `Escena ${c.nextScene}`}
                                    </span>
                                ))}
                            </div>
                        </div>
                        <div className="flex flex-col gap-1 absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button
                                onClick={() => handleEditScene(scene, idx)}
                                className="p-1.5 hover:bg-blue-50 text-blue-500 rounded"
                            >
                                <Edit2 className="w-4 h-4" />
                            </button>
                            <button
                                onClick={() => handleDeleteScene(idx)}
                                className="p-1.5 hover:bg-rose-50 text-rose-500 rounded"
                            >
                                <X className="w-4 h-4" />
                            </button>
                        </div>
                    </div>
                ))}
            </div>
        </div>
    );
};

export default AdminSimulationEditor;



================================================================================
FILE: src\components\AdminSupportPanel.jsx
================================================================================
import React, { useState } from 'react';
import { MessageSquare, BarChart3, Download, Loader2 } from 'lucide-react';
import { SupportProvider } from '../context/SupportContext';
import { useSupport } from '../hooks/useSupport';

// Sub-components
import SupportMetrics from './admin/support/SupportMetrics';
import TicketList from './admin/support/TicketList';
import TicketDetail from './admin/support/TicketDetail';

const AdminSupportContent = () => {
    const {
        loading,
        tickets,
        exportToCSV
    } = useSupport();

    const [viewMode, setViewMode] = useState('cards'); // 'cards' | 'analytics'

    if (loading && tickets.length === 0) {
        return (
            <div className="h-screen flex items-center justify-center bg-slate-50">
                <div className="flex flex-col items-center animate-pulse">
                    <Loader2 className="w-10 h-10 text-blue-500 animate-spin mb-4" />
                    <p className="text-slate-500 font-bold text-lg">Cargando Centro de Soporte...</p>
                </div>
            </div>
        );
    }

    return (
        <div className="p-8 min-h-screen bg-slate-50/50 font-sans text-slate-800 animate-in fade-in duration-500">
            {/* TOP BAR */}
            <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
                <div className="flex items-center space-x-3">
                    <div className="w-12 h-12 bg-white rounded-xl flex items-center justify-center shadow-sm border border-slate-100">
                        <MessageSquare className="w-6 h-6 text-blue-600" />
                    </div>
                    <div>
                        <h1 className="text-2xl font-black text-slate-900 tracking-tight">Support HQ</h1>
                        <p className="text-slate-500 text-sm font-medium flex items-center gap-2">
                            <span className="bg-blue-50 text-blue-700 px-1.5 py-0.5 rounded textxs">‚åòK</span> Buscar
                            <span className="text-slate-300">‚Ä¢</span>
                            Gesti√≥n Centralizada
                        </p>
                    </div>
                </div>
                <div className="flex items-center gap-3">
                    <button
                        onClick={() => setViewMode(v => v === 'cards' ? 'analytics' : 'cards')}
                        className={`flex items-center space-x-2 px-4 py-2.5 rounded-xl font-bold text-sm transition-all border ${viewMode === 'analytics'
                            ? 'bg-blue-50 border-blue-200 text-blue-700'
                            : 'bg-white border-slate-200 text-slate-600 hover:border-slate-300'
                            }`}
                    >
                        <BarChart3 className="w-4 h-4" />
                        <span>{viewMode === 'cards' ? 'Analytics' : 'Tickets'}</span>
                    </button>
                    <button
                        onClick={exportToCSV}
                        className="flex items-center space-x-2 px-4 py-2.5 bg-white border border-slate-200 text-slate-600 rounded-xl font-bold text-sm hover:bg-slate-50 transition-all hover:text-slate-900"
                    >
                        <Download className="w-4 h-4" />
                        <span>CSV</span>
                    </button>
                </div>
            </div>

            {/* METRICS / ANALYTICS */}
            <SupportMetrics viewMode={viewMode} />

            {/* MAIN CONTENT */}
            {viewMode === 'cards' && (
                <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 h-[calc(100vh-280px)] min-h-[600px]">
                    {/* LEFT: LIST */}
                    <TicketList />

                    {/* RIGHT: DETAIL */}
                    <TicketDetail />
                </div>
            )}
        </div>
    );
};

const AdminSupportPanel = () => {
    return (
        <SupportProvider>
            <AdminSupportContent />
        </SupportProvider>
    );
};

export default AdminSupportPanel;



================================================================================
FILE: src\components\AICoachWidget.jsx
================================================================================
import React, { useState, useEffect, useRef } from 'react';
import { Bot, Sparkles, TrendingUp, TrendingDown, ArrowRight, BookOpen, AlertTriangle, Loader2, Mic, Send, X, MessageSquare, Maximize2 } from 'lucide-react';
import { sendMessageToGemini } from '../lib/gemini';
import { formatMoney } from '../lib/finance';

const AICoachWidget = ({ stats, report, history, userName = "Socio", onNavigate }) => {
    // Mode: 'summary' (widget) | 'chat' (full conversation)
    const [mode, setMode] = useState('summary');

    // Summary State
    const [recommendation, setRecommendation] = useState(null);
    const [loadingSummary, setLoadingSummary] = useState(true);
    const [error, setError] = useState(false);

    // Chat State
    const [messages, setMessages] = useState([]);
    const [input, setInput] = useState('');
    const [isListening, setIsListening] = useState(false);
    const [isSending, setIsSending] = useState(false);
    const messagesEndRef = useRef(null);

    // --- 1. INITIAL ANALYSIS (WIDGET MODE) ---
    useEffect(() => {
        let isMounted = true;
        const analyzeBusiness = async () => {
            if (!report && !stats) return;

            // Generate Historical Context String
            let historyText = "No hay datos hist√≥ricos.";
            if (history && history.length > 0) {
                historyText = history.map(h =>
                    `Mes ${h.month}: Ingr ${formatMoney(h.revenue)}, Ben ${formatMoney(h.profit)}`
                ).join("; ");
            }

            try {
                // Context-Aware Prompt Analysis
                const prompt = `
                [SYSTEM: ACT AS FINANCIAL ANALYST]
               Analiza estos datos del mes actual (${new Date().toLocaleDateString()}):
               - Ingresos: ${formatMoney(report?.revenue || 0)}‚Ç¨
               - Beneficio Neto: ${formatMoney(report?.taxes?.netProfitPostTax || 0)}‚Ç¨
               - Margen Seguridad: ${report?.metrics?.safetyMargin || 0}%
               - Tendencia: ${stats?.profitTrend > 0 ? 'Subiendo' : 'Bajando'} (${stats?.profitTrend}%)
               
               CONTEXTO HIST√ìRICO (√öltimos 6 meses):
               ${historyText}

               TAREA 1: Responde SOLO con un JSON (sin markdown) para el widget resumen:
               {
                 "type": "growth" | "warning" | "critical",
                 "title": "Titulo Corto",
                 "reason": "1 frase potente sobre la situaci√≥n actual comparada con la historia.",
                 "action_label": "Bot√≥n Acci√≥n",
                 "action_route": "resources" | "support" | "dashboard", 
                 "color": "emerald" | "orange" | "rose" | "blue"
               }
               `;

                const responseText = await sendMessageToGemini(prompt);

                // Parse JSON
                const cleanJson = responseText.replace(/```json/g, '').replace(/```/g, '').trim();
                const aiData = JSON.parse(cleanJson);

                if (isMounted) {
                    setRecommendation(aiData);
                    setLoadingSummary(false);
                    // Initialize chat with AI's first analysis implicitly 
                    setMessages([
                        { role: 'assistant', text: `¬°Hola ${userName}! He analizado tus finanzas. ${aiData.reason} ¬øQuieres profundizar en alg√∫n dato?` }
                    ]);
                }
            } catch (err) {
                console.error("AI Analysis Failed", err);
                if (isMounted) {
                    setError(true);
                    setLoadingSummary(false);
                }
            }
        };

        const timer = setTimeout(analyzeBusiness, 1000);
        return () => { isMounted = false; clearTimeout(timer); };
    }, [report, stats, history, userName]);

    // --- 2. CHAT LOGIC ---
    useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
    }, [messages, mode]);

    const handleSend = async () => {
        if (!input.trim()) return;

        const userMsg = input;
        setInput('');
        setMessages(prev => [...prev, { role: 'user', text: userMsg }]);
        setIsSending(true);

        try {
            // "Conversational Only" prompt injection is handled by the persistent session in gemini.js
            // We just send the text now.
            const response = await sendMessageToGemini(userMsg);
            setMessages(prev => [...prev, { role: 'assistant', text: response }]);
        } catch {
            setMessages(prev => [...prev, { role: 'assistant', text: "Lo siento, hubo un error de conexi√≥n." }]);
        } finally {
            setIsSending(false);
        }
    };

    const handleVoice = () => {
        if (!('webkitSpeechRecognition' in window)) {
            alert("Tu navegador no soporta entrada de voz.");
            return;
        }
        const recognition = new window.webkitSpeechRecognition();
        recognition.lang = 'es-ES';
        recognition.onstart = () => setIsListening(true);
        recognition.onend = () => setIsListening(false);
        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            setInput(transcript);
            // Optionally auto-send: handleSend() could be called here
        };
        recognition.start();
    };

    // --- 3. RENDER ---

    // --- MODE: CHAT OVERLAY ---
    if (mode === 'chat') {
        return (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-sm animate-in fade-in duration-200">
                <div className="w-full max-w-lg bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl flex flex-col h-[80vh] overflow-hidden relative">
                    {/* Header */}
                    <div className="p-4 border-b border-slate-800 flex justify-between items-center bg-slate-800/50">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-600 to-indigo-600 flex items-center justify-center shadow-lg">
                                <Bot className="w-6 h-6 text-white" />
                            </div>
                            <div>
                                <h3 className="font-bold text-white">REPAART Coach AI</h3>
                                <p className="text-xs text-emerald-400 flex items-center gap-1">
                                    <span className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span> Online
                                </p>
                            </div>
                        </div>
                        <button onClick={() => setMode('summary')} className="p-2 hover:bg-slate-700 rounded-lg text-slate-400 hover:text-white transition-colors">
                            <X className="w-5 h-5" />
                        </button>
                    </div>

                    {/* Messages */}
                    <div className="flex-1 overflow-y-auto p-4 space-y-4 scrollbar-thin scrollbar-thumb-slate-700">
                        {messages.map((msg, idx) => (
                            <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[85%] rounded-2xl p-3 text-sm ${msg.role === 'user'
                                    ? 'bg-blue-600 text-white rounded-tr-none'
                                    : 'bg-slate-800 text-slate-200 border border-slate-700 rounded-tl-none relative group'
                                    }`}>
                                    {msg.text}
                                    {msg.role === 'assistant' && (
                                        <div className="hidden group-hover:block absolute -right-8 top-0 text-[10px] text-slate-600">Bot</div>
                                    )}
                                </div>
                            </div>
                        ))}
                        {isSending && (
                            <div className="flex justify-start">
                                <div className="bg-slate-800 border border-slate-700 rounded-2xl rounded-tl-none p-4 flex gap-1">
                                    <span className="w-2 h-2 bg-slate-500 rounded-full animate-bounce"></span>
                                    <span className="w-2 h-2 bg-slate-500 rounded-full animate-bounce delay-100"></span>
                                    <span className="w-2 h-2 bg-slate-500 rounded-full animate-bounce delay-200"></span>
                                </div>
                            </div>
                        )}
                        <div ref={messagesEndRef} />
                    </div>

                    {/* Input Area */}
                    <div className="p-4 bg-slate-800/30 border-t border-slate-800 backdrop-blur-md">
                        <div className="flex gap-2 relative">
                            <button
                                onClick={handleVoice}
                                className={`p-3 rounded-xl transition-all ${isListening
                                    ? 'bg-red-500/20 text-red-500 animate-pulse ring-2 ring-red-500/50'
                                    : 'bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white border border-slate-700'
                                    }`}
                            >
                                <Mic className="w-5 h-5" />
                            </button>
                            <input
                                type="text"
                                value={input}
                                onChange={(e) => setInput(e.target.value)}
                                onKeyDown={(e) => e.key === 'Enter' && handleSend()}
                                placeholder="Escribe o dicta tu pregunta..."
                                className="flex-1 bg-slate-900/50 border border-slate-700 rounded-xl px-4 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500/50"
                            />
                            <button
                                onClick={handleSend}
                                disabled={!input.trim() || isSending}
                                className="p-3 bg-blue-600 hover:bg-blue-500 disabled:opacity-50 disabled:cursor-not-allowed rounded-xl text-white shadow-lg shadow-blue-600/20 transition-all active:scale-95"
                            >
                                <Send className="w-5 h-5" />
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        );
    }

    // --- MODE: WIDGET SUMMARY ---

    // Loading State
    if (loadingSummary) {
        return (
            <div className="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 rounded-2xl p-6 shadow-xl border border-slate-700 relative h-full flex items-center justify-center">
                <div className="text-center space-y-3">
                    <Loader2 className="w-8 h-8 text-blue-400 animate-spin mx-auto" />
                    <p className="text-sm text-slate-400 animate-pulse">Analizando finanzas...</p>
                </div>
            </div>
        );
    }

    // Fallback/Loaded State
    const displayRec = recommendation || {
        type: 'growth',
        title: 'Coach IA',
        reason: 'Tus m√©tricas est√°n listas. Abre el chat para analizar detalles.',
        action_label: 'Ver Recursos',
        action_route: 'resources',
        color: 'blue'
    };

    const colors = {
        emerald: { bg: 'bg-emerald-500/10', text: 'text-emerald-400', border: 'hover:border-emerald-500/50' },
        orange: { bg: 'bg-orange-500/10', text: 'text-orange-400', border: 'hover:border-orange-500/50' },
        rose: { bg: 'bg-rose-500/10', text: 'text-rose-400', border: 'hover:border-rose-500/50' },
        blue: { bg: 'bg-blue-500/10', text: 'text-blue-400', border: 'hover:border-blue-500/50' }
    };
    const theme = colors[displayRec.color] || colors.blue;

    return (
        <div className="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 rounded-2xl p-6 shadow-xl border border-slate-700 relative group h-full transition-all hover:shadow-2xl hover:shadow-blue-900/20">
            {/* Action Bar (Top Right) */}
            <div className="absolute top-4 right-4 z-20 flex gap-2">
                <button
                    onClick={() => setMode('chat')}
                    className="p-2 bg-slate-800/80 hover:bg-blue-600 text-slate-300 hover:text-white rounded-lg border border-slate-700 hover:border-blue-500 transition-all shadow-lg backdrop-blur-sm"
                    title="Abrir Chat con IA"
                >
                    <Maximize2 className="w-4 h-4" />
                </button>
            </div>

            {/* Background Decor */}
            <div className="absolute inset-0 overflow-hidden rounded-2xl pointer-events-none">
                <div className="absolute top-0 right-0 w-64 h-64 bg-blue-500/10 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>
            </div>

            <div className="flex items-start gap-4 relative z-10 h-full flex-col">
                <div className="flex items-center gap-4 w-full">
                    {/* Avatar */}
                    <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center shadow-lg shadow-blue-500/20 shrink-0">
                        <Bot className="w-7 h-7 text-white" />
                    </div>
                    <div>
                        <h3 className="text-lg font-bold text-white flex items-center gap-2">
                            Coach IA
                            <span className={`px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider ${error ? 'bg-red-500/20 text-red-300' : 'bg-emerald-500/20 text-emerald-300'}`}>
                                {error ? 'Offline' : 'Online'}
                            </span>
                        </h3>
                        <p className="text-slate-400 text-xs font-medium">Historial: {history?.length || 0} meses analizados</p>
                    </div>
                </div>

                <div className="flex-1 w-full mt-4 flex flex-col justify-between">
                    <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-700 mb-4 backdrop-blur-sm relative overflow-hidden group/card cursor-pointer" onClick={() => setMode('chat')}>
                        <div className="absolute top-2 right-2 opacity-0 group-hover/card:opacity-100 transition-opacity">
                            <MessageSquare className="w-4 h-4 text-slate-500" />
                        </div>
                        <p className="text-slate-200 text-sm italic leading-relaxed">
                            "{displayRec.reason}"
                        </p>
                    </div>

                    <div className="grid grid-cols-5 gap-2">
                        {/* Primary Action Button */}
                        <button
                            onClick={() => onNavigate && onNavigate(displayRec.action_route)}
                            className={`col-span-4 group/btn relative overflow-hidden rounded-xl p-3 flex items-center justify-between transition-all border border-slate-700 bg-slate-800 hover:bg-slate-800/80 ${theme.border} active:scale-95`}
                        >
                            <div className="flex items-center gap-3">
                                <div className={`p-2 rounded-lg ${theme.bg} ${theme.text}`}>
                                    <BookOpen className="w-5 h-5" />
                                </div>
                                <div className="text-left">
                                    <p className="text-[10px] uppercase font-bold text-slate-400">Recomendaci√≥n</p>
                                    <p className="font-bold text-white text-xs sm:text-xs truncate max-w-[120px]">
                                        {displayRec.action_label || "Ver Detalles"}
                                    </p>
                                </div>
                            </div>
                            <ArrowRight className="w-5 h-5 text-slate-500 group-hover/btn:text-white transform group-hover/btn:translate-x-1 transition-all" />
                        </button>

                        {/* Quick Chat Button */}
                        <button
                            onClick={() => setMode('chat')}
                            className="col-span-1 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-xl flex items-center justify-center text-slate-400 hover:text-white transition-all active:scale-95"
                            title="Hablar con Coach"
                        >
                            <Mic className="w-5 h-5" />
                        </button>
                    </div>
                </div>
            </div>
        </div>
    );
};

export default AICoachWidget;



================================================================================
FILE: src\components\AlertsWidget.jsx
================================================================================
import React from 'react';
import { AlertTriangle, TrendingDown, Info, CheckCircle2, XCircle } from 'lucide-react';
import { formatMoney } from '../lib/finance';
import { ALERT_THRESHOLDS } from '../lib/constants';

const AlertsWidget = ({ report, previousReport }) => {
    if (!report) return null;

    const alerts = [];

    // Alert 1: Margen bajo (cr√≠tico)
    if (report.metrics?.profitMargin < ALERT_THRESHOLDS.MIN_PROFIT_MARGIN) {
        alerts.push({
            type: 'error',
            icon: AlertTriangle,
            title: 'Margen Reducido',
            message: `Tu margen actual es ${(report.metrics.profitMargin || 0).toFixed(1)}%. El objetivo saludable es >${ALERT_THRESHOLDS.MIN_PROFIT_MARGIN}%.`
        });
    }

    // Alert 2: No alcanzas break-even
    if (report.orders < report.metrics?.breakEvenOrders) {
        const shortage = report.metrics.breakEvenOrders - report.orders;
        alerts.push({
            type: 'error',
            icon: XCircle,
            title: 'Objetivo de Pedidos',
            message: `Faltan ${shortage} pedidos para cubrir gastos fijos.`
        });
    }

    // Alert 3: Gastos fijos muy altos
    const fixedCostRatio = report.revenue > 0 ? (report.expenses / report.revenue) * 100 : 0;
    if (fixedCostRatio > ALERT_THRESHOLDS.MAX_EXPENSE_RATIO) {
        alerts.push({
            type: 'warning',
            icon: Info,
            title: 'Gastos Estructurales',
            message: `Costes fijos: ${fixedCostRatio.toFixed(1)}% de ingresos. Intenta optimizar.`
        });
    }

    // Alert 4: Coste por km alto
    if (report.metrics?.costPerKm > ALERT_THRESHOLDS.MAX_COST_PER_KM) {
        alerts.push({
            type: 'warning',
            icon: Info,
            title: 'Eficiencia Log√≠stica',
            message: `Coste/km: ${formatMoney(report.metrics.costPerKm)}‚Ç¨. Objetivo: <${ALERT_THRESHOLDS.MAX_COST_PER_KM}‚Ç¨.`
        });
    }

    // Alert 5: Ca√≠da fuerte vs mes anterior
    if (previousReport && previousReport.revenue > 0) {
        const revenueChange = ((report.revenue - previousReport.revenue) / previousReport.revenue) * 100;
        if (revenueChange < ALERT_THRESHOLDS.MAX_REVENUE_DROP) {
            alerts.push({
                type: 'warning',
                icon: TrendingDown,
                title: 'Ca√≠da de Ingresos',
                message: `La facturaci√≥n ha bajado un ${Math.abs(revenueChange).toFixed(1)}%.`
            });
        }
    }

    // Alert 6: Excelente rendimiento (positivo)
    if (report.metrics?.profitMargin > ALERT_THRESHOLDS.EXCELLENT_MARGIN) {
        alerts.push({
            type: 'success',
            icon: CheckCircle2,
            title: 'Excelente Margen',
            message: `¬°Gran trabajo! Margen del ${report.metrics.profitMargin.toFixed(1)}%.`
        });
    }

    // Alert 7: Superaste break-even significativamente
    if (report.orders > report.metrics?.breakEvenOrders * ALERT_THRESHOLDS.BREAKEVEN_MULTIPLIER) {
        const surplus = report.orders - report.metrics.breakEvenOrders;
        alerts.push({
            type: 'success',
            icon: CheckCircle2,
            title: 'Objetivos Superados',
            message: `Superado punto de equilibrio por ${surplus} pedidos.`
        });
    }

    if (alerts.length === 0) return null;

    return (
        <div className="space-y-3">
            {alerts.slice(0, 3).map((alert, i) => { // Limit to 3 max
                const Icon = alert.icon;
                const isError = alert.type === 'error';
                const isWarning = alert.type === 'warning';

                // Dynamic Styles based on type
                const containerClasses = isError
                    ? "bg-rose-50/50 border-rose-100 hover:border-rose-200"
                    : isWarning
                        ? "bg-amber-50/50 border-amber-100 hover:border-amber-200"
                        : "bg-emerald-50/50 border-emerald-100 hover:border-emerald-200";

                const iconContainerClasses = isError
                    ? "bg-rose-100 text-rose-600 shadow-rose-100/50"
                    : isWarning
                        ? "bg-amber-100 text-amber-600 shadow-amber-100/50"
                        : "bg-emerald-100 text-emerald-600 shadow-emerald-100/50";

                const titleColor = isError ? "text-rose-900" : isWarning ? "text-amber-900" : "text-emerald-900";
                const bodyColor = isError ? "text-rose-700" : isWarning ? "text-amber-700" : "text-emerald-700";

                return (
                    <div
                        key={i}
                        className={`
                            glass-panel rounded-xl p-3 flex items-start gap-3 border transition-all duration-300 hover:shadow-md
                            ${containerClasses}
                        `}
                    >
                        <div className={`p-2 rounded-lg flex-shrink-0 shadow-sm ${iconContainerClasses}`}>
                            <Icon className="w-4 h-4" />
                        </div>
                        <div className="pt-0.5">
                            <h4 className={`font-bold text-sm mb-0.5 ${titleColor} tracking-tight`}>{alert.title}</h4>
                            <p className={`text-xs leading-relaxed font-medium ${bodyColor} break-words`}>
                                {alert.message}
                            </p>
                        </div>
                    </div>
                );
            })}
        </div>
    );
};

// Memoize with custom comparison to prevent recalculating alerts unnecessarily
export default React.memo(AlertsWidget, (prevProps, nextProps) => {
    return prevProps.report === nextProps.report && prevProps.previousReport === nextProps.previousReport;
});



================================================================================
FILE: src\components\AnnouncementSystem.jsx
================================================================================
import React, { useState } from 'react';
import { useAdminAnnouncements } from '../hooks/useAdminAnnouncements';
import { db } from '../lib/firebase';
import { collection, getDocs } from 'firebase/firestore';
import { Plus, Trash2, Megaphone, AlertTriangle, Info, X, Users, Eye } from 'lucide-react';
import Card from './ui/Card';
import Button from './ui/Button';

const AnnouncementSystem = () => {
    const { announcements, loading, createAnnouncement, deleteAnnouncement } = useAdminAnnouncements();
    const [isCreating, setIsCreating] = useState(false);
    const [newPost, setNewPost] = useState({
        title: '',
        content: '',
        priority: 'normal',
        type: 'news',
        targetAudience: 'all', // 'all' or 'specific'
        targetFranchises: []
    });

    // Franchise logic
    const [franchises, setFranchises] = useState([]);

    // Load Franchise List on mount
    React.useEffect(() => {
        const loadFranchises = async () => {
            try {
                const snap = await getDocs(collection(db, "users_config"));
                const list = snap.docs
                    .map(d => ({ id: d.id, ...d.data() }))
                    .filter(u => u.role === 'franchise');
                setFranchises(list);
            } catch (e) {
                console.error("Error loading franchises", e);
            }
        };
        loadFranchises();
    }, []);

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (!newPost.title || !newPost.content) return;

        await createAnnouncement(
            newPost.title,
            newPost.content,
            newPost.type,
            newPost.priority,
            newPost.targetAudience,
            newPost.targetFranchises
        );

        setNewPost({
            title: '',
            content: '',
            priority: 'normal',
            type: 'news',
            targetAudience: 'all',
            targetFranchises: []
        });
        setIsCreating(false);
    };

    const toggleFranchiseSelection = (franchiseId) => {
        setNewPost(prev => {
            const current = prev.targetFranchises;
            const newSelection = current.includes(franchiseId)
                ? current.filter(id => id !== franchiseId)
                : [...current, franchiseId];
            return { ...prev, targetFranchises: newSelection };
        });
    };

    if (loading) return <div className="p-4 text-center">Cargando sistema de anuncios...</div>;

    return (
        <div className="space-y-6">
            <div className="flex justify-between items-center">
                <h2 className="text-2xl font-bold text-slate-800 flex items-center">
                    <Megaphone className="w-6 h-6 mr-3 text-blue-600" />
                    Centro de Comunicaci√≥n HQ
                </h2>
                <Button onClick={() => setIsCreating(!isCreating)} icon={isCreating ? X : Plus} variant={isCreating ? 'secondary' : 'primary'}>
                    {isCreating ? 'Cancelar' : 'Nuevo Anuncio'}
                </Button>
            </div>

            {/* CREATION FORM */}
            {isCreating && (
                <Card className="animate-fade-in-down border-blue-200 shadow-lg">
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-bold text-slate-700 mb-1">T√≠tulo</label>
                                <input
                                    type="text"
                                    value={newPost.title}
                                    onChange={e => setNewPost({ ...newPost, title: e.target.value })}
                                    className="w-full rounded-lg border-slate-300 focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="Ej: Cambio de Tarifas 2024"
                                    required
                                />
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-bold text-slate-700 mb-1">Prioridad</label>
                                    <select
                                        value={newPost.priority}
                                        onChange={e => setNewPost({ ...newPost, priority: e.target.value })}
                                        className="w-full rounded-lg border-slate-300"
                                    >
                                        <option value="normal">Normal</option>
                                        <option value="high">Alta</option>
                                        <option value="critical">Cr√≠tica üö®</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-slate-700 mb-1">Tipo</label>
                                    <select
                                        value={newPost.type}
                                        onChange={e => setNewPost({ ...newPost, type: e.target.value })}
                                        className="w-full rounded-lg border-slate-300"
                                    >
                                        <option value="news">Noticia</option>
                                        <option value="alert">Alerta</option>
                                        <option value="maintenance">Mantenimiento</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        {/* Audience Selector */}
                        <div className="bg-slate-50 p-3 rounded-lg border border-slate-200">
                            <label className="block text-sm font-bold text-slate-700 mb-2">Audiencia</label>
                            <div className="flex gap-4 mb-3">
                                <label className="flex items-center gap-2 cursor-pointer">
                                    <input
                                        type="radio"
                                        name="audience"
                                        value="all"
                                        checked={newPost.targetAudience === 'all'}
                                        onChange={() => setNewPost({ ...newPost, targetAudience: 'all' })}
                                    />
                                    <span className="text-sm">Toda la Red ({franchises.length})</span>
                                </label>
                                <label className="flex items-center gap-2 cursor-pointer">
                                    <input
                                        type="radio"
                                        name="audience"
                                        value="specific"
                                        checked={newPost.targetAudience === 'specific'}
                                        onChange={() => setNewPost({ ...newPost, targetAudience: 'specific' })}
                                    />
                                    <span className="text-sm">Seleccionar Franquicias</span>
                                </label>
                            </div>

                            {newPost.targetAudience === 'specific' && (
                                <div className="max-h-40 overflow-y-auto grid grid-cols-2 md:grid-cols-3 gap-2 p-2 bg-white rounded border border-slate-200">
                                    {franchises.map(f => (
                                        <label key={f.id} className="flex items-center gap-2 text-xs p-1 hover:bg-slate-50 rounded cursor-pointer">
                                            <input
                                                type="checkbox"
                                                checked={newPost.targetFranchises.includes(f.franchiseId || f.id)}
                                                onChange={() => toggleFranchiseSelection(f.franchiseId || f.id)}
                                            />
                                            <span className="truncate" title={f.franchiseId || f.email}>
                                                {(f.franchiseId || f.email).toUpperCase()}
                                            </span>
                                        </label>
                                    ))}
                                </div>
                            )}
                        </div>

                        <div>
                            <label className="block text-sm font-bold text-slate-700 mb-1">Contenido</label>
                            <textarea
                                value={newPost.content}
                                onChange={e => setNewPost({ ...newPost, content: e.target.value })}
                                className="w-full rounded-lg border-slate-300 h-32 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="Escribe el contenido del comunicado..."
                                required
                            />
                        </div>
                        <div className="flex justify-end pt-2">
                            <Button type="submit" variant="primary">Publicar Comunicado</Button>
                        </div>
                    </form>
                </Card>
            )}

            {/* LIST */}
            <div className="grid gap-4">
                {announcements.map(item => (
                    <Card key={item.id} className="relative group hover:shadow-md transition-shadow">
                        <button
                            onClick={() => deleteAnnouncement(item.id)}
                            className="absolute top-4 right-4 text-slate-300 hover:text-rose-500 transition-colors opacity-0 group-hover:opacity-100 p-1"
                            title="Eliminar anuncio"
                        >
                            <Trash2 className="w-5 h-5" />
                        </button>

                        <div className="flex items-start">
                            <div className={`
                                w-10 h-10 rounded-full flex items-center justify-center shrink-0 mr-4
                                ${item.priority === 'critical' ? 'bg-rose-100 text-rose-600' :
                                    item.priority === 'high' ? 'bg-amber-100 text-amber-600' :
                                        'bg-blue-100 text-blue-600'}
                             `}>
                                {item.priority === 'critical' ? <AlertTriangle className="w-6 h-6" /> :
                                    item.type === 'alert' ? <AlertTriangle className="w-6 h-6" /> :
                                        <Info className="w-6 h-6" />}
                            </div>
                            <div className="flex-1">
                                <div className="flex items-center gap-2 mb-1 flex-wrap">
                                    <h3 className="font-bold text-lg text-slate-800">{item.title}</h3>
                                    {item.priority === 'critical' && <span className="bg-rose-100 text-rose-700 text-xs font-bold px-2 py-0.5 rounded-full uppercase">Cr√≠tico</span>}

                                    {/* Audience Badge */}
                                    {item.targetAudience === 'specific' ? (
                                        <span className="bg-purple-100 text-purple-700 text-xs font-bold px-2 py-0.5 rounded-full flex items-center gap-1">
                                            <Users className="w-3 h-3" />
                                            Segmentado ({item.targetFranchises?.length || 0})
                                        </span>
                                    ) : (
                                        <span className="bg-slate-100 text-slate-600 text-xs font-bold px-2 py-0.5 rounded-full">Global</span>
                                    )}

                                    <span className="text-xs text-slate-400 ml-auto">
                                        {item.createdAt instanceof Date ? item.createdAt.toLocaleDateString() : 'Reciente'}
                                    </span>
                                </div>
                                <p className="text-slate-600 whitespace-pre-wrap text-sm leading-relaxed mb-3">{item.content}</p>

                                {/* Read Stats */}
                                <div className="flex items-center gap-2 text-xs text-slate-400 bg-slate-50 px-2 py-1 rounded w-fit">
                                    <Eye className="w-3 h-3" />
                                    <span>Visto por {item.reads?.length || 0} usuarios</span>
                                </div>
                            </div>
                        </div>
                    </Card>
                ))}
                {announcements.length === 0 && (
                    <div className="text-center py-12 text-slate-400 border-2 border-dashed border-slate-200 rounded-xl">
                        <Megaphone className="w-12 h-12 mx-auto mb-4 opacity-50" />
                        <p>No hay comunicados publicados.</p>
                    </div>
                )}
            </div>
        </div>
    );
};

export default AnnouncementSystem;



================================================================================
FILE: src\components\AuditPanel.jsx
================================================================================
import React, { useState, useEffect } from 'react';
import { db } from '../lib/firebase';
import { collection, query, orderBy, limit, onSnapshot } from 'firebase/firestore';
import { ShieldAlert, RefreshCcw, User, Eye } from 'lucide-react';
import EmptyState from './ui/EmptyState';

const AuditPanel = () => {
    const [logs, setLogs] = useState([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        // Query recent 100 logs
        const q = query(collection(db, "audit_logs"), orderBy("timestamp", "desc"), limit(100));
        const unsubscribe = onSnapshot(q, (snapshot) => {
            const fetchedLogs = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            setLogs(fetchedLogs);
            setLoading(false);
        });
        return () => unsubscribe();
    }, []);

    const formatTime = (ts) => {
        if (!ts) return "Reciente...";
        return ts.toDate ? ts.toDate().toLocaleString() : new Date().toLocaleString();
    };

    const getActionColor = (action) => {
        if (action.includes('LOGIN')) return 'text-emerald-600 bg-emerald-50';
        if (action.includes('REVOKE') || action.includes('DELETE')) return 'text-rose-600 bg-rose-50';
        if (action.includes('APPROVED')) return 'text-indigo-600 bg-indigo-50';
        if (action.includes('TICKET')) return 'text-blue-600 bg-blue-50';
        return 'text-slate-600 bg-slate-50';
    };

    if (loading) return <div className="p-8 text-center text-slate-400">Cargando auditor√≠a...</div>;

    return (
        <div className="p-8 max-w-6xl mx-auto animate-fade-in-up">
            <div className="flex items-center justify-between mb-8">
                <div>
                    <h2 className="text-2xl font-black text-slate-800 flex items-center">
                        <ShieldAlert className="w-8 h-8 mr-3 text-slate-700" /> Registro de Auditor√≠a
                    </h2>
                    <p className="text-slate-500 mt-1">Historial inmutable de acciones cr√≠ticas (√öltimos 100 eventos).</p>
                </div>
                <div className="bg-slate-100 px-3 py-1 rounded-full flex items-center text-xs font-bold text-slate-500">
                    <RefreshCcw className="w-3 h-3 mr-2 animate-spin-slow" /> En vivo
                </div>
            </div>

            <div className="bg-white rounded-2xl shadow-lg border border-slate-100 overflow-hidden">
                <div className="overflow-x-auto">
                    <table className="w-full text-left border-collapse">
                        <thead>
                            <tr className="bg-slate-50/50 border-b border-slate-100 text-xs text-slate-500 uppercase tracking-wider">
                                <th className="px-6 py-4 font-bold">Fecha / Hora</th>
                                <th className="px-6 py-4 font-bold">Actor (Usuario)</th>
                                <th className="px-6 py-4 font-bold">Acci√≥n</th>
                                <th className="px-6 py-4 font-bold">Detalles (JSON)</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-50">
                            {logs.map(log => (
                                <tr key={log.id} className="hover:bg-slate-50/50 transition-colors">
                                    <td className="px-6 py-3 text-sm font-mono text-slate-500 whitespace-nowrap">
                                        {formatTime(log.timestamp)}
                                    </td>
                                    <td className="px-6 py-3">
                                        <div className="flex items-center">
                                            <div className="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center mr-3 text-slate-400">
                                                <User className="w-4 h-4" />
                                            </div>
                                            <div>
                                                <p className="text-sm font-bold text-slate-800">{log.actorEmail}</p>
                                                <p className="text-xs text-slate-400 font-mono">UID: {log.actorId.slice(0, 6)}...</p>
                                            </div>
                                        </div>
                                    </td>
                                    <td className="px-6 py-3">
                                        <span className={`px-2 py-1 rounded text-xs font-black uppercase ${getActionColor(log.action)}`}>
                                            {log.action}
                                        </span>
                                    </td>
                                    <td className="px-6 py-3">
                                        <code className="text-[10px] bg-slate-100 p-1.5 rounded text-slate-600 break-all block max-w-xs font-mono">
                                            {JSON.stringify(log.details || {})}
                                        </code>
                                    </td>
                                </tr>
                            ))}
                            {logs.length === 0 && (
                                <tr>
                                    <td colSpan="4" className="p-8">
                                        <EmptyState
                                            icon={ShieldAlert}
                                            title="Sin registros"
                                            description="No hay eventos de auditor√≠a registrados todav√≠a."
                                            className="bg-slate-50 border-0"
                                        />
                                    </td>
                                </tr>
                            )}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    );
};

export default AuditPanel;



================================================================================
FILE: src\components\BottomTabBar.jsx
================================================================================
import React, { useMemo, useCallback } from 'react';
import { LayoutDashboard, Users, FileText, LifeBuoy, ShieldAlert, Settings, Activity, GraduationCap } from 'lucide-react';
import { useFeatureAccess } from '../hooks/useFeatureAccess';

const BottomTabBar = ({
    isAdmin,
    viewMode,
    setViewMode,
    franchiseView,
    setFranchiseView
}) => {
    // Memoize tab configurations to prevent recreation on every render
    const adminTabs = useMemo(() => [
        { id: 'dashboard', label: 'Central', icon: Activity },
        { id: 'users', label: 'Usuarios', icon: Users },
        { id: 'academy', label: 'Academia', icon: GraduationCap },
        { id: 'resources', label: 'Recursos', icon: FileText },
        { id: 'support', label: 'Soporte', icon: LifeBuoy },
    ], []);

    const franchiseTabs = useMemo(() => [
        { id: 'cockpit', label: 'Finanzas', icon: LayoutDashboard },
        { id: 'academy', label: 'Academia', icon: GraduationCap },
        { id: 'resources', label: 'Recursos', icon: FileText },
        { id: 'support', label: 'Soporte', icon: LifeBuoy },
    ], []);

    // Feature access for franchise users
    const { hasAccess } = useFeatureAccess();

    // Filter tabs based on permissions (only for franchise users)
    const tabs = useMemo(() => {
        const baseTabs = isAdmin ? adminTabs : franchiseTabs;

        if (isAdmin) return baseTabs;

        // Filter franchise tabs based on feature access
        return baseTabs.filter(tab => {
            if (tab.id === 'resources') return hasAccess('downloads');
            // cockpit and support always visible
            return true;
        });
    }, [isAdmin, adminTabs, franchiseTabs, hasAccess]);

    const currentView = isAdmin ? viewMode : franchiseView;
    const setView = isAdmin ? setViewMode : setFranchiseView;

    const handleTabClick = useCallback((tabId) => {
        setView(tabId);
        // Trigger bounce animation
        const btn = document.getElementById(`tab-${tabId}`);
        if (btn) {
            btn.classList.remove('animate-tab-bounce');
            void btn.offsetWidth; // Force reflow
            btn.classList.add('animate-tab-bounce');
        }
    }, [setView]);

    return (
        <div className="md:hidden fixed bottom-0 left-0 right-0 z-50 safe-bottom">
            {/* Glassmorphism Tab Bar */}
            <div className="ios-blur-dark border-t border-slate-200/50 ios-shadow-lg">
                <div className="flex justify-around items-center px-2 py-2">
                    {tabs.map((tab) => {
                        const Icon = tab.icon;
                        const isActive = currentView === tab.id;

                        return (
                            <button
                                key={tab.id}
                                id={`tab-${tab.id}`}
                                onClick={() => handleTabClick(tab.id)}
                                className={`flex flex-col items-center justify-center flex-1 py-3 px-2 rounded-xl transition-all duration-200 active:scale-95 min-h-[56px] ${isActive
                                    ? 'text-blue-600'
                                    : 'text-slate-400'
                                    }`}
                            >
                                {/* Icon with background circle when active */}
                                <div className={`relative mb-1 transition-all duration-300 ${isActive ? 'transform scale-110' : ''
                                    }`}>
                                    {isActive && (
                                        <div className="absolute inset-0 bg-blue-100 rounded-full scale-150 -z-10 animate-bounce-in" />
                                    )}
                                    <Icon
                                        className={`w-6 h-6 transition-all duration-200 ${isActive ? 'stroke-[2.5]' : 'stroke-[2]'
                                            }`}
                                    />
                                </div>

                                {/* Label */}
                                <span className={`text-[10px] font-semibold transition-all duration-200 ${isActive ? 'opacity-100' : 'opacity-70'
                                    }`}>
                                    {tab.label}
                                </span>

                                {/* Active indicator dot */}
                                {isActive && (
                                    <div className="absolute bottom-0 w-1 h-1 bg-blue-600 rounded-full animate-bounce-in" />
                                )}
                            </button>
                        );
                    })}
                </div>
            </div>
        </div>
    );
};

export default React.memo(BottomTabBar);



================================================================================
FILE: src\components\BrutalLearningView.jsx
================================================================================
import React, { useState, useEffect, useMemo } from 'react';
import {
    ChevronRight, ChevronLeft, ArrowLeft, Trophy,
    BookOpen, AlertTriangle
} from 'lucide-react';

// Color mapping fallback seguro
const BASE_COLORS = {
    blue: { bg: 'bg-blue-600', text: 'text-blue-400', border: 'border-blue-500', light: 'bg-blue-500/10' },
    emerald: { bg: 'bg-emerald-600', text: 'text-emerald-400', border: 'border-emerald-500', light: 'bg-emerald-500/10' },
    sky: { bg: 'bg-sky-600', text: 'text-sky-400', border: 'border-sky-500', light: 'bg-sky-500/10' },
    indigo: { bg: 'bg-indigo-600', text: 'text-indigo-400', border: 'border-indigo-500', light: 'bg-indigo-500/10' },
    red: { bg: 'bg-red-600', text: 'text-red-400', border: 'border-red-500', light: 'bg-red-500/10' },
    yellow: { bg: 'bg-yellow-600', text: 'text-yellow-400', border: 'border-yellow-500', light: 'bg-yellow-500/10' },
    purple: { bg: 'bg-purple-600', text: 'text-purple-400', border: 'border-purple-500', light: 'bg-purple-500/10' },
    pink: { bg: 'bg-pink-600', text: 'text-pink-400', border: 'border-pink-500', light: 'bg-pink-500/10' },
    amber: { bg: 'bg-amber-600', text: 'text-amber-400', border: 'border-amber-500', light: 'bg-amber-500/10' },
    slate: { bg: 'bg-slate-600', text: 'text-slate-400', border: 'border-slate-500', light: 'bg-slate-500/10' },
    orange: { bg: 'bg-orange-600', text: 'text-orange-400', border: 'border-orange-500', light: 'bg-orange-500/10' },
    teal: { bg: 'bg-teal-600', text: 'text-teal-400', border: 'border-teal-500', light: 'bg-teal-500/10' },
};

export default function BrutalLearningView({
    category,
    modules = [],
    onCompleteModule,
    onViewQuiz,
    onBack,
    alreadyViewedIds = []
}) {
    const firstUnviewedIndex = useMemo(() => {
        if (!modules || modules.length === 0) return 0;
        const idx = modules.findIndex(m => !alreadyViewedIds.includes(m.id));
        return idx === -1 ? 0 : idx;
    }, [modules, alreadyViewedIds]);

    const [activeIndex, setActiveIndex] = useState(0);
    const [hasInitialized, setHasInitialized] = useState(false);
    const [showContext, setShowContext] = useState(false);
    const [isCompleting, setIsCompleting] = useState(false);

    // Sync expl√≠cito para manejar carga as√≠ncrona
    useEffect(() => {
        if (!hasInitialized && modules.length > 0) {
            setActiveIndex(firstUnviewedIndex);
            setHasInitialized(true);
        }
    }, [modules, firstUnviewedIndex, hasInitialized]);

    useEffect(() => {
        setShowContext(false);
    }, [activeIndex]);

    // Safety check final (render phase) - MOVED DOWN
    // if (!category) return ... 

    // Derived state
    const theme = category ? (BASE_COLORS[category.color] || BASE_COLORS.blue) : BASE_COLORS.blue;
    const safeModules = modules || [];
    const currentModule = safeModules[activeIndex];
    const isModuleViewed = currentModule ? alreadyViewedIds.includes(currentModule.id) : false;
    const isLastModule = activeIndex === safeModules.length - 1;

    const handleNext = React.useCallback(async () => {
        if (!currentModule || isCompleting) return;
        try {
            if (!isModuleViewed) {
                setIsCompleting(true);
                await onCompleteModule(currentModule.id);
            }
            if (isLastModule) {
                if (onViewQuiz) onViewQuiz();
            } else {
                setActiveIndex(prev => prev + 1);
            }
        } catch (e) {
            console.error("Error completing module", e);
        } finally {
            setIsCompleting(false);
        }
    }, [currentModule, isCompleting, isModuleViewed, onCompleteModule, isLastModule, onViewQuiz]);

    // Keyboard Navigation
    useEffect(() => {
        const handleKeyDown = (e) => {
            if (e.key === 'ArrowLeft' && activeIndex > 0) {
                setActiveIndex(prev => prev - 1);
            }
            if (e.key === 'ArrowRight') {
                handleNext();
            }
        };
        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
    }, [activeIndex, handleNext]);


    if (!category) return <div className="p-4 text-white">Error: Categor√≠a no v√°lida</div>;

    if (!currentModule) {
        return (
            <div className="flex flex-col items-center justify-center p-8 h-screen bg-slate-900 text-slate-400">
                <AlertTriangle size={48} className="mb-4 text-amber-500" />
                <h3 className="text-xl font-bold mb-2">No se encontraron m√≥dulos</h3>
                <p>Categor√≠a: {category.name}</p>
                <div className="mt-4">
                    <button onClick={onBack} className="text-white bg-slate-700 px-4 py-2 rounded">
                        Volver
                    </button>
                </div>
            </div>
        );
    }

    const shortcuts = (
        <div className="hidden md:flex items-center gap-4 text-xs font-medium text-slate-500 absolute bottom-6 right-6 opacity-50 hover:opacity-100 transition-opacity">
            <span className="flex items-center gap-1"><kbd className="px-2 py-1 bg-slate-800 rounded border border-slate-700">‚Üê</kbd> Anterior</span>
            <span className="flex items-center gap-1"><kbd className="px-2 py-1 bg-slate-800 rounded border border-slate-700">Explorar</kbd></span>
            <span className="flex items-center gap-1"><kbd className="px-2 py-1 bg-slate-800 rounded border border-slate-700">‚Üí</kbd> Siguiente</span>
        </div>
    );

    return (
        <div className="fixed inset-0 z-50 bg-slate-900 flex flex-col overflow-hidden text-white font-sans animate-in fade-in duration-300">
            {/* Background Effects */}
            <div className="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none z-0">
                <div className={`absolute top-[-10%] right-[-5%] w-[500px] h-[500px] rounded-full blur-[100px] opacity-20 ${theme.bg}`}></div>
                <div className="absolute bottom-[-10%] left-[-10%] w-[600px] h-[600px] rounded-full blur-[120px] bg-indigo-900/20"></div>
            </div>

            {/* Header */}
            <div className="relative z-10 px-6 py-4 flex flex-col gap-4 backdrop-blur-sm bg-slate-950/50 border-b border-white/5">
                <div className="flex justify-between items-center">
                    <button onClick={onBack} className="group flex items-center gap-2 text-slate-400 hover:text-white transition-colors">
                        <div className="p-2 rounded-full group-hover:bg-white/10 transition-colors">
                            <ArrowLeft size={20} />
                        </div>
                        <span className="font-medium text-sm hidden sm:block">Volver al mapa</span>
                    </button>

                    <div className="flex flex-col items-center">
                        <span className={`px-4 py-1.5 rounded-full text-[10px] font-black uppercase tracking-[0.2em] shadow-lg shadow-${category.color}-500/10 border border-white/10 bg-white/5 backdrop-blur-md ${theme.text}`}>
                            {category.name}
                        </span>
                    </div>

                    <div className="text-xs font-mono text-slate-500 bg-slate-900/50 px-3 py-1 rounded-lg border border-white/5">
                        <span className="text-white font-bold">{activeIndex + 1}</span>
                        <span className="mx-1 opacity-50">/</span>
                        <span>{safeModules.length}</span>
                    </div>
                </div>

                {/* Segmented Progress Bar */}
                <div className="flex gap-1.5 h-1.5 w-full max-w-3xl mx-auto">
                    {safeModules.map((m, idx) => {
                        const isViewed = alreadyViewedIds.includes(m.id);
                        const isActive = idx === activeIndex;
                        const isPast = idx < activeIndex;

                        return (
                            <div
                                key={idx}
                                className={`flex-1 rounded-full transition-all duration-500 relative overflow-hidden ${isActive ? `bg-white shadow-[0_0_10px_rgba(255,255,255,0.5)] scale-y-125` :
                                    isPast || isViewed ? theme.bg : 'bg-slate-800'
                                    }`}
                            >
                                {isActive && <div className="absolute inset-0 bg-white/50 animate-pulse-slow"></div>}
                            </div>
                        );
                    })}
                </div>
            </div>

            {/* Main Content Area */}
            <div className="relative z-10 flex-1 flex flex-col items-center justify-center p-4 md:p-8 overflow-y-auto custom-scroll">
                <div
                    key={currentModule.id} // Triggers animation on change
                    className="w-full max-w-4xl mx-auto flex flex-col gap-8 items-center animate-in slide-in-from-right-8 fade-in duration-500 fill-mode-both"
                >
                    {/* Title Section */}
                    <div className="text-center space-y-4 max-w-2xl">
                        <h2 className="text-xs font-bold uppercase tracking-[0.3em] text-slate-500 animate-in slide-in-from-bottom-4 fade-in duration-700 delay-100">
                            M√≥dulo {currentModule.order || activeIndex + 1}
                        </h2>
                        <h1 className="text-3xl md:text-5xl font-black text-white leading-tight drop-shadow-2xl animate-in slide-in-from-bottom-4 fade-in duration-700 delay-200">
                            {currentModule.title}
                        </h1>
                    </div>

                    {/* The "Card" - Action */}
                    <div className="w-full relative group perspective-1000">
                        <div className={`absolute inset-0 ${theme.bg} blur-[60px] opacity-20 group-hover:opacity-30 transition-opacity duration-1000 rounded-full`}></div>

                        <div className="relative bg-slate-900/40 backdrop-blur-2xl border border-white/10 p-8 md:p-14 rounded-[2rem] shadow-2xl flex flex-col items-center text-center transition-transform duration-500 hover:scale-[1.01] hover:border-white/20">

                            {/* Decorative corner accents */}
                            <div className="absolute top-6 left-6 w-3 h-3 border-t-2 border-l-2 border-white/20 rounded-tl-lg"></div>
                            <div className="absolute top-6 right-6 w-3 h-3 border-t-2 border-r-2 border-white/20 rounded-tr-lg"></div>
                            <div className="absolute bottom-6 left-6 w-3 h-3 border-b-2 border-l-2 border-white/20 rounded-bl-lg"></div>
                            <div className="absolute bottom-6 right-6 w-3 h-3 border-b-2 border-r-2 border-white/20 rounded-br-lg"></div>

                            <span className="inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-gradient-to-r from-amber-500/10 to-orange-500/10 border border-amber-500/20 text-amber-200 text-[10px] font-bold uppercase tracking-widest mb-8 shadow-lg">
                                <Trophy size={12} className="text-amber-400" />
                                Acci√≥n Clave
                            </span>

                            <p className="text-2xl md:text-4xl lg:text-5xl font-black text-transparent bg-clip-text bg-gradient-to-b from-white via-white to-slate-400 leading-tight md:leading-tight">
                                "{currentModule.action}"
                            </p>
                        </div>
                    </div>

                    {/* Context / Why */}
                    <div className="w-full max-w-2xl mx-auto mt-4">
                        <div className={`transition-all duration-500 overflow-hidden ${showContext ? 'max-h-[500px] opacity-100' : 'max-h-0 opacity-0'}`}>
                            <div className="bg-slate-800/50 rounded-2xl p-8 border border-white/5 backdrop-blur-sm shadow-xl">
                                <h4 className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                                    <BookOpen size={16} />
                                    Contexto Estrat√©gico
                                </h4>
                                <p className="text-lg text-slate-200 leading-relaxed">
                                    {currentModule.content}
                                </p>
                            </div>
                        </div>

                        {!showContext && (
                            <button
                                onClick={() => setShowContext(true)}
                                className="w-full flex items-center justify-center gap-2 text-slate-500 hover:text-white py-4 text-sm font-medium transition-colors group"
                            >
                                <div className="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center group-hover:bg-white/10 transition-colors">
                                    <ChevronRight className="rotate-90 group-hover:translate-y-0.5 transition-transform" size={16} />
                                </div>
                                <span className="uppercase tracking-widest text-xs">Entender el porqu√©</span>
                            </button>
                        )}

                        {showContext && (
                            <button
                                onClick={() => setShowContext(false)}
                                className="w-full flex items-center justify-center gap-2 text-slate-600 hover:text-slate-400 py-4 text-xs font-medium uppercase tracking-widest transition-colors"
                            >
                                Ocultar contexto
                            </button>
                        )}
                    </div>
                </div>
            </div>

            {/* Footer Navigation */}
            <div className="relative z-20 bg-slate-950/80 backdrop-blur-lg border-t border-white/5 p-4 md:p-6 pb-8 md:pb-6">
                <div className="max-w-4xl mx-auto flex items-center gap-4">
                    <button
                        onClick={() => activeIndex > 0 && setActiveIndex(prev => prev - 1)}
                        disabled={activeIndex === 0}
                        className="p-5 rounded-2xl bg-slate-900 border border-slate-800 text-slate-400 hover:text-white hover:bg-slate-800 hover:border-slate-700 disabled:opacity-30 disabled:hover:bg-slate-900 transition-all active:scale-95"
                    >
                        <ChevronLeft size={24} />
                    </button>

                    {isLastModule && (safeModules.every(m => alreadyViewedIds.includes(m.id))) ? (
                        <button
                            onClick={onViewQuiz}
                            className={`flex-1 group relative overflow-hidden ${theme.bg} rounded-2xl p-1 shadow-lg shadow-${category.color}-500/20 transition-transform active:scale-[0.99] hover:shadow-${category.color}-500/40`}
                        >
                            <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent translate-x-[-100%] group-hover:animate-shimmer" />
                            <div className="bg-slate-950/20 rounded-xl h-full w-full flex items-center justify-center gap-3 py-4">
                                <span className="font-black text-xl text-white tracking-wide uppercase flex items-center gap-3">
                                    <Trophy size={24} className="text-yellow-400 drop-shadow-md" />
                                    Hacer Examen Final
                                </span>
                            </div>
                        </button>
                    ) : (
                        <button
                            onClick={handleNext}
                            disabled={isCompleting}
                            className={`flex-1 group relative overflow-hidden rounded-2xl p-[1px] shadow-lg transition-all active:scale-[0.99] disabled:opacity-70 disabled:cursor-not-allowed
                                ${isModuleViewed ? 'bg-slate-800 hover:bg-slate-700' : `bg-gradient-to-r from-white via-slate-200 to-slate-400`}
                            `}
                        >
                            <div className={`rounded-xl h-full w-full flex items-center justify-center gap-3 py-4 px-8 ${isModuleViewed ? 'bg-slate-900' : 'bg-slate-900/90'}`}>
                                <span className={`font-bold text-lg tracking-wide flex items-center gap-2 ${isModuleViewed ? 'text-slate-300' : 'text-white'}`}>
                                    {isCompleting ? "Guardando..." : (isModuleViewed ? "Siguiente Lecci√≥n" : "Entendido ¬∑ Continuar")}
                                    <ChevronRight size={20} className={`transition-transform group-hover:translate-x-1 ${!isModuleViewed && 'text-emerald-400'}`} />
                                </span>
                            </div>
                        </button>
                    )}
                </div>
                {shortcuts}
            </div>
        </div>
    );
}



================================================================================
FILE: src\components\ChatAssistant.jsx
================================================================================
import React, { useState, useRef, useEffect } from 'react';
import { MessageCircle, X, Send, Bot, User as UserIcon, Loader2, Sparkles, Maximize2, Minimize2 } from 'lucide-react';
import { GoogleGenerativeAI } from '@google/generative-ai';


// --- SOLF SYSTEM PROMPT (Context from "Yesterday") ---
const SYSTEM_PROMPT = `
# [ROL Y OBJETIVO]
Eres "Asistente Repaart", un especialista de soporte al cliente virtual. Tu misi√≥n principal es ayudar a los usuarios a resolver sus dudas sobre los servicios de la empresa de reparto "Repaart" de manera amable, eficiente y precisa. Tu conocimiento se basa *exclusivamente* en la documentaci√≥n proporcionada. Tu tono debe ser siempre servicial, paciente y orientado a encontrar una soluci√≥n.

# [CONTEXTO]
La √∫nica fuente de verdad para tus respuestas es la documentaci√≥n que se te ha proporcionado sobre los procedimientos, pol√≠ticas, √°reas de servicio y funcionamiento de "Repaart". No debes inventar informaci√≥n, hacer suposiciones ni utilizar conocimiento externo a estos documentos. El objetivo es proporcionar confianza y claridad al usuario.

# [INSTRUCCIONES DE OPERACI√ìN PASO A PASO]
Sigue este proceso de manera estricta en cada interacci√≥n:

1.  **Recepci√≥n y An√°lisis:** Saluda amablemente al usuario y analiza su pregunta para entender su necesidad principal.

2.  **B√∫squeda en Documentaci√≥n:** Consulta *√∫nicamente* la documentaci√≥n proporcionada para encontrar la informaci√≥n relevante que responda a la consulta del usuario. (Nota: En esta implementaci√≥n, "documentaci√≥n" se refiere a los datos financieros y de contexto que se te inyectan din√°micamente).

3.  **Respuesta Inicial Breve:** Proporciona una respuesta inicial que sea corta, directa y clara a la pregunta del usuario.

4.  **Evaluaci√≥n y Solicitud de Detalles:**
    * Si la respuesta inicial resuelve completamente la duda, finaliza la interacci√≥n de forma cordial.
    * Si la documentaci√≥n contiene informaci√≥n m√°s detallada que podr√≠a ser √∫til pero requiere m√°s contexto del usuario (como un n√∫mero de pedido, una direcci√≥n, o un tipo de incidencia), pregunta de forma proactiva por esos detalles. Explica por qu√© necesitas esa informaci√≥n.

5.  **Manejo de Incertidumbre (Fallback):**
    * Si despu√©s de buscar en la documentaci√≥n no encuentras una respuesta clara o la consulta es demasiado espec√≠fica o sensible (e.g., quejas graves, problemas de seguridad), NO intentes adivinar.
    * En su lugar, utiliza la siguiente respuesta estandarizada: "No he encontrado una respuesta clara en mi documentaci√≥n para tu consulta. Para asegurar que recibes la informaci√≥n correcta y el mejor soporte posible, te recomiendo contactar directamente con nuestro equipo de soporte humano. Ellos podr√°n ayudarte en detalle."

# [RESTRICCIONES]
- **NO** utilices informaci√≥n externa a la documentaci√≥n proporcionada.
- **NO** inventes respuestas ni procedimientos.
- **SIEMPRE** mant√©n un tono amable y solucionador.
- **SIEMPRE** sigue el flujo de "respuesta corta -> pedir detalles si es necesario".
- **NUNCA** prometas soluciones que no est√©n expl√≠citamente descritas en la documentaci√≥n.
`;

const ChatAssistant = ({ contextData, isOpen, onClose }) => {
    // const [isOpen, setIsOpen] = useState(false); // Controlled by parent
    const [isExpanded, setIsExpanded] = useState(false);
    const [messages, setMessages] = useState([
        { role: 'model', text: '¬°Hola! Soy el asistente inteligente de SOLF. ¬øEn qu√© puedo ayudarte hoy con tu operativa?' }
    ]);
    const [input, setInput] = useState('');
    const [loading, setLoading] = useState(false);
    // ...

    // ... (skipping lines)

    <button
        onClick={() => onClose && onClose()}
        className="p-1 hover:bg-red-500/80 rounded transition"
    >
        <X className="w-3.5 h-3.5" />
    </button>
    const messagesEndRef = useRef(null);

    // Initialize Gemini
    const genAI = new GoogleGenerativeAI(import.meta.env.VITE_GOOGLE_AI_KEY || '');

    const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
    };

    useEffect(() => {
        scrollToBottom();
    }, [messages]);

    const formatContextData = (data) => {
        if (!data) return "No hay datos financieros cargados actualmente.";

        try {
            return `
DATOS ACTUALES DEL NEGOCIO (Presupuesto/Real):
- Ingresos Totales: ${data.revenue ? data.revenue.toFixed(2) : '0'} ‚Ç¨
- Beneficio Neto (Estimado): ${data.taxes?.netProfitPostTax ? data.taxes.netProfitPostTax.toFixed(2) : '0'} ‚Ç¨
- Gastos Totales: ${data.expenses ? data.expenses.toFixed(2) : '0'} ‚Ç¨
- Pedidos Totales: ${data.orders || '0'}
- Margen de Seguridad: ${data.metrics?.safetyMargin ? data.metrics.safetyMargin.toFixed(1) : '0'}%
- Punto de Equilibrio: ${data.metrics?.breakEvenOrders || '0'} pedidos
- Coste por Km: ${data.metrics?.costPerKm ? data.metrics.costPerKm.toFixed(3) : '0'} ‚Ç¨/km
- Ticket Medio: ${data.metrics?.avgTicket ? data.metrics.avgTicket.toFixed(2) : '0'} ‚Ç¨
            `.trim();
        } catch {
            return "Error al leer datos financieros.";
        }
    };

    const handleSend = async (e) => {
        e.preventDefault();
        if (!input.trim() || loading) return;

        const userMsg = input.trim();
        setInput('');
        setMessages(prev => [...prev, { role: 'user', text: userMsg }]);
        setLoading(true);

        try {
            // Check for missing key
            if (!import.meta.env.VITE_GOOGLE_AI_KEY) {
                throw new Error("Falta la API Key de Gemini (VITE_GOOGLE_AI_KEY) en .env");
            }

            const model = genAI.getGenerativeModel({ model: "gemini-pro" });

            // Build history for context
            const history = messages.map(m => ({
                role: m.role === 'user' ? 'user' : 'model',
                parts: [{ text: m.text }]
            }));

            // Prepare System Context with Data
            const currentContext = formatContextData(contextData);
            const fullSystemPrompt = `${SYSTEM_PROMPT}\n\n${currentContext}\n\nINSTRUCCION: Usa estos datos reales para responder si el usuario pregunta por m√©tricas.`;

            // Chat Session
            const chat = model.startChat({
                history: [
                    { role: 'user', parts: [{ text: fullSystemPrompt }] },
                    { role: 'model', parts: [{ text: "Entendido. Tengo acceso a tus m√©tricas financieras actualizadas y responder√© bas√°ndome en ellas." }] },
                    ...history
                ],
                generationConfig: {
                    maxOutputTokens: 500,
                },
            });

            const result = await chat.sendMessage(userMsg);
            const response = result.response.text();

            setMessages(prev => [...prev, { role: 'model', text: response }]);

        } catch (error) {
            console.error("Chat Error:", error);
            setMessages(prev => [...prev, { role: 'model', text: `Error: ${error.message || 'No pude conectar con el cerebro de IA.'}` }]);
        } finally {
            setLoading(false);
        }
    };

    // Auto-open greeting once
    useEffect(() => {
        const timer = setTimeout(() => {
            // Optional: Auto open specific logic
        }, 1000);
        return () => clearTimeout(timer);
    }, []);

    // Draggable Logic (Desktop only)
    const [position, setPosition] = useState({ bottom: 24, right: 24 });
    const [isDragging, setIsDragging] = useState(false);
    const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 });

    const handleMouseDown = (e) => {
        if (window.innerWidth < 768) return; // Disable drag on mobile (sheet mode)
        setIsDragging(true);
        const rect = e.currentTarget.getBoundingClientRect();
        setDragOffset({
            x: e.clientX - rect.left,
            y: e.clientY - rect.top
        });
    };

    const handleMouseMove = (e) => {
        if (!isDragging) return;
        const newRight = window.innerWidth - e.clientX - dragOffset.x;
        const newBottom = window.innerHeight - e.clientY - dragOffset.y;
        setPosition({
            right: Math.max(10, Math.min(window.innerWidth - 60, newRight)),
            bottom: Math.max(10, Math.min(window.innerHeight - 60, newBottom))
        });
    };

    const handleMouseUp = () => {
        setIsDragging(false);
    };

    useEffect(() => {
        if (isDragging) {
            window.addEventListener('mousemove', handleMouseMove);
            window.addEventListener('mouseup', handleMouseUp);
            return () => {
                window.removeEventListener('mousemove', handleMouseMove);
                window.removeEventListener('mouseup', handleMouseUp);
            };
        }
        // eslint-disable-next-line react-hooks/exhaustive-deps
    }, [isDragging]);

    // If closed, render nothing (controlled by parent)
    if (!isOpen) return null;

    return (
        <>
            {/* Mobile Backdrop */}
            <div className="fixed inset-0 bg-black/50 z-[60] md:hidden backdrop-blur-sm animate-fade-in" onClick={() => onClose && onClose()} />

            {/* Chat Window */}
            <div
                style={{
                    bottom: window.innerWidth >= 768 ? `${position.bottom}px` : '0',
                    right: window.innerWidth >= 768 ? `${position.right}px` : '0',
                    left: window.innerWidth >= 768 ? 'auto' : '0'
                }}
                className={`fixed bg-white z-[70] flex flex-col overflow-hidden transition-all duration-300 shadow-2xl border-blue-100
                    md:rounded-2xl md:border
                    ${window.innerWidth < 768
                        ? 'min-h-[85vh] max-h-[85vh] rounded-t-[32px] animate-slide-up-mobile safe-bottom'
                        : `animate-fade-in-up ${isExpanded ? 'w-[600px] h-[70vh]' : 'w-80 h-96'}`
                    }
                `}
            >
                {/* Header with Drag Handler */}
                <div
                    onMouseDown={handleMouseDown}
                    className={`bg-gradient-to-r from-slate-800 to-slate-900 p-4 md:p-3 flex justify-between items-center text-white shrink-0 ${window.innerWidth >= 768 ? 'cursor-move' : ''}`}
                >
                    <div className="flex items-center gap-2">
                        <div className="w-7 h-7 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center shadow-inner">
                            <Bot className="w-4 h-4 text-white" />
                        </div>
                        <div>
                            <h3 className="font-bold text-xs tracking-wide">SOLF AI</h3>
                            <p className="text-[9px] text-blue-300 flex items-center gap-1">
                                <span className="w-1.5 h-1.5 bg-green-400 rounded-full animate-pulse"></span>
                                Online
                            </p>
                        </div>
                    </div>
                    <div className="flex items-center gap-1">
                        <button
                            onClick={() => setIsExpanded(!isExpanded)}
                            className="p-1 hover:bg-white/10 rounded transition"
                        >
                            {isExpanded ? <Minimize2 className="w-3.5 h-3.5" /> : <Maximize2 className="w-3.5 h-3.5" />}
                        </button>
                        <button
                            onClick={() => onClose && onClose()}
                            className="p-1 hover:bg-red-500/80 rounded transition"
                        >
                            <X className="w-3.5 h-3.5" />
                        </button>
                    </div>
                </div>

                {/* Messages */}
                <div className="flex-1 overflow-y-auto p-3 space-y-3 bg-slate-50/50">
                    {messages.map((m, idx) => (
                        <div key={idx} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                            <div className={`max-w-[85%] rounded-xl p-2.5 text-xs shadow-sm ${m.role === 'user'
                                ? 'bg-blue-600 text-white rounded-br-none'
                                : 'bg-white border border-slate-200 text-slate-700 rounded-bl-none'
                                }`}>
                                {m.role === 'model' && (
                                    <p className="text-[9px] font-bold text-blue-500 mb-1 flex items-center gap-1">
                                        <Sparkles className="w-3 h-3" /> AI
                                    </p>
                                )}
                                <div className="whitespace-pre-wrap leading-relaxed">
                                    {m.text}
                                </div>
                            </div>
                        </div>
                    ))}
                    {loading && (
                        <div className="flex justify-start">
                            <div className="bg-white border border-slate-200 rounded-xl rounded-bl-none p-3 shadow-sm">
                                <div className="flex gap-1">
                                    <span className="w-1.5 h-1.5 bg-blue-400 rounded-full animate-bounce"></span>
                                    <span className="w-1.5 h-1.5 bg-blue-400 rounded-full animate-bounce delay-75"></span>
                                    <span className="w-1.5 h-1.5 bg-blue-400 rounded-full animate-bounce delay-150"></span>
                                </div>
                            </div>
                        </div>
                    )}
                    <div ref={messagesEndRef} />
                </div>

                {/* Input */}
                <form onSubmit={handleSend} className="p-2.5 bg-white border-t border-slate-100 flex gap-2 shrink-0">
                    <input
                        type="text"
                        value={input}
                        onChange={(e) => setInput(e.target.value)}
                        placeholder="Pregunta algo..."
                        className="flex-1 bg-slate-100 border-none rounded-lg px-3 py-2 text-xs focus:ring-2 focus:ring-blue-500 outline-none transition-all placeholder-slate-400"
                    />
                    <button
                        type="submit"
                        disabled={!input.trim() || loading}
                        className={`p-2 rounded-lg bg-blue-600 text-white shadow-sm transition-all ${(!input.trim() || loading) ? 'opacity-50 cursor-not-allowed' : 'hover:bg-blue-700 active:scale-95'
                            }`}
                    >
                        <Send className="w-4 h-4" />
                    </button>
                </form>
            </div>
        </>
    );
};

export default ChatAssistant;



================================================================================
FILE: src\components\common\CriticalActionModal.jsx
================================================================================
import React, { useState, useEffect } from 'react';
import PropTypes from 'prop-types';
import { AlertTriangle, X, Loader2 } from 'lucide-react';

const CriticalActionModal = ({
    isOpen,
    onClose,
    onConfirm,
    title,
    description,
    confirmKeyword,
    isLoading = false,
    confirmButtonText = 'Confirmar',
    variant = 'danger' // 'danger' | 'warning'
}) => {
    const [input, setInput] = useState('');
    const [error, setError] = useState(false);

    useEffect(() => {
        if (isOpen) {
            setInput('');
            setError(false);
        }
    }, [isOpen]);

    if (!isOpen) return null;

    const handleConfirm = () => {
        if (input !== confirmKeyword) {
            setError(true);
            return;
        }
        onConfirm();
    };

    const isMatch = input === confirmKeyword;

    return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm animate-in fade-in duration-200">
            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden border border-slate-200 scale-100 animate-in zoom-in-95 duration-200">

                {/* Header */}
                <div className={`p-6 border-b ${variant === 'danger' ? 'bg-rose-50 border-rose-100' : 'bg-amber-50 border-amber-100'} flex items-start gap-4`}>
                    <div className={`p-3 rounded-full shrink-0 ${variant === 'danger' ? 'bg-rose-100 text-rose-600' : 'bg-amber-100 text-amber-600'}`}>
                        <AlertTriangle className="w-6 h-6" />
                    </div>
                    <div>
                        <h3 className={`text-lg font-black ${variant === 'danger' ? 'text-rose-900' : 'text-amber-900'}`}>
                            {title}
                        </h3>
                        <p className={`text-sm mt-1 font-medium ${variant === 'danger' ? 'text-rose-700' : 'text-amber-700'}`}>
                            {description}
                        </p>
                    </div>
                    <button
                        onClick={onClose}
                        className="ml-auto text-slate-400 hover:text-slate-600 transition-colors"
                        disabled={isLoading}
                    >
                        <X className="w-5 h-5" />
                    </button>
                </div>

                {/* Body */}
                <div className="p-6 space-y-4">
                    <div className="space-y-2">
                        <label className="text-sm font-bold text-slate-700">
                            Para confirmar, escribe <span className="font-mono text-slate-900 bg-slate-100 px-1 rounded select-all">{confirmKeyword}</span> abajo:
                        </label>
                        <input
                            type="text"
                            value={input}
                            onChange={(e) => {
                                setInput(e.target.value);
                                setError(false);
                            }}
                            placeholder={confirmKeyword}
                            className={`w-full px-4 py-2.5 rounded-xl border-2 font-medium focus:ring-0 outline-none transition-all ${error
                                    ? 'border-rose-300 focus:border-rose-500 bg-rose-50 text-rose-900 placeholder-rose-300'
                                    : 'border-slate-200 focus:border-blue-500 bg-white text-slate-900'
                                }`}
                            autoFocus
                            disabled={isLoading}
                        />
                        {error && (
                            <p className="text-xs font-bold text-rose-500 flex items-center gap-1 animate-pulse">
                                La confirmaci√≥n no coincide. Int√©ntalo de nuevo.
                            </p>
                        )}
                    </div>
                </div>

                {/* Footer */}
                <div className="p-4 bg-slate-50 border-t border-slate-100 flex justify-end gap-3">
                    <button
                        onClick={onClose}
                        disabled={isLoading}
                        className="px-4 py-2 text-slate-600 font-bold text-sm hover:bg-slate-200 rounded-lg transition-colors border border-transparent"
                    >
                        Cancelar
                    </button>
                    <button
                        onClick={handleConfirm}
                        disabled={!isMatch || isLoading}
                        className={`px-4 py-2 rounded-lg font-bold text-sm shadow-sm flex items-center gap-2 transition-all ${variant === 'danger'
                                ? 'bg-rose-600 hover:bg-rose-700 text-white disabled:bg-rose-300'
                                : 'bg-amber-500 hover:bg-amber-600 text-white disabled:bg-amber-300'
                            } disabled:cursor-not-allowed`}
                    >
                        {isLoading && <Loader2 className="w-4 h-4 animate-spin" />}
                        {confirmButtonText}
                    </button>
                </div>
            </div>
        </div>
    );
};

CriticalActionModal.propTypes = {
    isOpen: PropTypes.bool.isRequired,
    onClose: PropTypes.func.isRequired,
    onConfirm: PropTypes.func.isRequired,
    title: PropTypes.string.isRequired,
    description: PropTypes.string.isRequired,
    confirmKeyword: PropTypes.string.isRequired,
    isLoading: PropTypes.bool,
    confirmButtonText: PropTypes.string,
    variant: PropTypes.oneOf(['danger', 'warning'])
};

export default CriticalActionModal;



================================================================================
FILE: src\components\common\ErrorBoundary.jsx
================================================================================
import React from 'react';
import { AlertTriangle, RefreshCw } from 'lucide-react';

class ErrorBoundary extends React.Component {
    constructor(props) {
        super(props);
        this.state = { hasError: false };
    }

    static getDerivedStateFromError(error) {
        // Update state so the next render will show the fallback UI.
        return { hasError: true };
    }

    componentDidCatch(error, errorInfo) {
        // Log Error silently
        console.error('[CRITICAL UI FAIL]:', error, errorInfo);
    }

    handleRetry = () => {
        this.setState({ hasError: false });
    };

    render() {
        if (this.state.hasError) {
            // Fallback UI
            return (
                <div className="h-full w-full min-h-[150px] bg-white rounded-2xl border-2 border-slate-100 flex flex-col items-center justify-center p-6 text-center shadow-sm animate-in fade-in duration-300">
                    <div className="w-12 h-12 bg-rose-50 rounded-full flex items-center justify-center mb-3">
                        <AlertTriangle className="w-6 h-6 text-rose-500" />
                    </div>
                    <h3 className="text-slate-800 font-bold mb-1">M√≥dulo no disponible</h3>
                    <p className="text-xs text-slate-500 mb-4 max-w-[200px]">
                        Ha ocurrido un problema temporal con este componente.
                    </p>
                    <button
                        onClick={this.handleRetry}
                        className="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-xs font-bold transition-all"
                    >
                        <RefreshCw className="w-3 h-3" /> Reintentar
                    </button>
                </div>
            );
        }

        return this.props.children;
    }
}

export default ErrorBoundary;



================================================================================
FILE: src\components\CoverageStats.jsx
================================================================================
import React from 'react';
import { Clock, TrendingUp, Users, MapPin, AlertTriangle } from 'lucide-react';

/**
 * CoverageStats - Panel de estad√≠sticas de cobertura
 */
const CoverageStats = ({ shifts }) => {
    // Calculate total hours covered this week
    const calculateTotalHours = () => {
        return shifts.reduce((total, shift) => {
            const start = parseInt(shift.startTime.split(':')[0]);
            const end = parseInt(shift.endTime.split(':')[0]) || 24;
            const duration = end > start ? end - start : (24 - start) + end;
            return total + duration;
        }, 0);
    };

    // Get top 3 most active riders
    const getTopRiders = () => {
        const riderHours = {};
        shifts.forEach(shift => {
            const start = parseInt(shift.startTime.split(':')[0]);
            const end = parseInt(shift.endTime.split(':')[0]) || 24;
            const duration = end > start ? end - start : (24 - start) + end;
            riderHours[shift.riderName] = (riderHours[shift.riderName] || 0) + duration;
        });

        return Object.entries(riderHours)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 3)
            .map(([name, hours]) => ({ name, hours }));
    };

    // Calculate coverage by time slot
    const getCoverageBySlot = () => {
        const slots = {
            'Almuerzo (12-15h)': { start: 12, end: 15, count: 0 },
            'Tarde (15-18h)': { start: 15, end: 18, count: 0 },
            'Cena (18-21h)': { start: 18, end: 21, count: 0 },
            'Noche (21-00h)': { start: 21, end: 24, count: 0 }
        };

        shifts.forEach(shift => {
            const shiftStart = parseInt(shift.startTime.split(':')[0]);
            const shiftEnd = parseInt(shift.endTime.split(':')[0]) || 24;

            Object.entries(slots).forEach(([name, slot]) => {
                if ((shiftStart < slot.end && shiftEnd > slot.start) ||
                    (shiftStart >= slot.start && shiftStart < slot.end)) {
                    slots[name].count++;
                }
            });
        });

        return slots;
    };

    // Get zones coverage
    const getZonesCoverage = () => {
        const zones = {};
        shifts.forEach(shift => {
            const zone = shift.zone || 'Sin zona';
            zones[zone] = (zones[zone] || 0) + 1;
        });
        return zones;
    };

    const totalHours = calculateTotalHours();
    const topRiders = getTopRiders();
    const slotCoverage = getCoverageBySlot();
    const zonesCoverage = getZonesCoverage();

    // Optimal coverage: 7 days * 12 hours/day * 2 riders = 168 rider-hours
    const optimalHours = 7 * 12 * 2;
    const coveragePercent = Math.min((totalHours / optimalHours) * 100, 100);

    // Find critical gaps
    const criticalSlots = Object.entries(slotCoverage).filter(([, data]) => data.count < 14); // Less than 2 riders per day

    return (
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            {/* Total Hours */}
            <div className="glass-panel-exec p-4 rounded-xl border-0 ring-1 ring-blue-500/20">
                <div className="flex items-center justify-between mb-3">
                    <Clock className="text-blue-400" size={24} />
                    <span className={`text-xs font-bold px-2 py-1 rounded-full border ${coveragePercent >= 80 ? 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20' : 'bg-orange-500/10 text-orange-400 border-orange-500/20'
                        }`}>
                        {coveragePercent.toFixed(0)}%
                    </span>
                </div>
                <p className="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">Horas Cubiertas</p>
                <p className="text-2xl font-black text-white">{totalHours}h</p>
                <div className="mt-2 w-full bg-slate-700/50 rounded-full h-1.5">
                    <div
                        className="bg-blue-500 h-full rounded-full transition-all shadow-glow-blue"
                        style={{ width: `${coveragePercent}%` }}
                    ></div>
                </div>
            </div>

            {/* Top Riders */}
            <div className="glass-panel-exec p-4 rounded-xl border-0 ring-1 ring-purple-500/20">
                <div className="flex items-center mb-3">
                    <Users className="text-purple-400" size={24} />
                    <span className="ml-2 text-[10px] text-slate-400 font-bold uppercase tracking-wider">Top Riders</span>
                </div>
                <div className="space-y-2">
                    {topRiders.map((rider, idx) => (
                        <div key={rider.name} className="flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <span className="text-xs font-bold text-purple-400">#{idx + 1}</span>
                                <span className="text-sm font-medium text-slate-200 truncate">{rider.name}</span>
                            </div>
                            <span className="text-xs font-bold text-purple-400">{rider.hours}h</span>
                        </div>
                    ))}
                    {topRiders.length === 0 && (
                        <p className="text-xs text-slate-500 italic">Sin datos</p>
                    )}
                </div>
            </div>

            {/* Critical Gaps */}
            <div className="glass-panel-exec p-4 rounded-xl border-0 ring-1 ring-orange-500/20">
                <div className="flex items-center mb-3">
                    <AlertTriangle className="text-orange-400" size={24} />
                    <span className="ml-2 text-[10px] text-slate-400 font-bold uppercase tracking-wider">Gaps Cr√≠ticos</span>
                </div>
                {criticalSlots.length > 0 ? (
                    <div className="space-y-2">
                        {criticalSlots.slice(0, 2).map(([slot, data]) => (
                            <div key={slot} className="text-xs">
                                <p className="font-bold text-orange-400">{slot}</p>
                                <p className="text-slate-400">{data.count} turnos (falta {14 - data.count})</p>
                            </div>
                        ))}
                    </div>
                ) : (
                    <div className="flex flex-col items-center justify-center h-16">
                        <TrendingUp className="text-emerald-400 mb-1" size={20} />
                        <p className="text-xs font-bold text-emerald-400">Todo cubierto</p>
                    </div>
                )}
            </div>

            {/* Zones Coverage */}
            <div className="glass-panel-exec p-4 rounded-xl border-0 ring-1 ring-teal-500/20">
                <div className="flex items-center mb-3">
                    <MapPin className="text-teal-400" size={24} />
                    <span className="ml-2 text-[10px] text-slate-400 font-bold uppercase tracking-wider">Cobertura Zonas</span>
                </div>
                <div className="space-y-2">
                    {Object.entries(zonesCoverage).map(([zone, count]) => (
                        <div key={zone} className="flex items-center justify-between">
                            <span className="text-sm font-medium text-slate-200">{zone}</span>
                            <span className="text-xs font-bold text-teal-400">{count} turnos</span>
                        </div>
                    ))}
                    {Object.keys(zonesCoverage).length === 0 && (
                        <p className="text-xs text-slate-500 italic">Sin datos</p>
                    )}
                </div>
            </div>
        </div>
    );
};

export default CoverageStats;



================================================================================
FILE: src\components\CreateUserModal.jsx
================================================================================
import React, { useState } from 'react';
import { X, UserPlus, Mail, Shield, Building, Loader2, AlertCircle } from 'lucide-react';

const CreateUserModal = ({ isOpen, onClose, onCreate, isLoading }) => {
    const [formData, setFormData] = useState({
        email: '',
        role: 'user', // Default role
        franchiseId: '',
        status: 'pending' // Default status as per requirements for onboarding
    });
    const [error, setError] = useState(null);

    if (!isOpen) return null;

    const handleSubmit = async (e) => {
        e.preventDefault();
        setError(null);

        if (!formData.email) {
            setError("El email es obligatorio.");
            return;
        }

        try {
            await onCreate(formData);
            // Reset form on success is handled by parent or useEffect, but we can do it here if we want strictly controlled
            setFormData({
                email: '',
                role: 'user',
                franchiseId: '',
                status: 'pending'
            });
            onClose();
        } catch (err) {
            console.error(err);
            setError(err.message || "Error al crear usuario.");
        }
    };

    return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200">
            <div className="w-full max-w-md glass-panel-exec rounded-2xl shadow-2xl border border-white/10 overflow-hidden animate-in zoom-in-95 duration-200">
                {/* Header */}
                <div className="px-6 py-4 border-b border-white/5 flex items-center justify-between bg-white/5">
                    <h2 className="text-lg font-bold text-white flex items-center gap-2">
                        <UserPlus className="w-5 h-5 text-indigo-400" />
                        Nuevo Usuario
                    </h2>
                    <button
                        onClick={onClose}
                        className="p-2 text-slate-400 hover:text-white hover:bg-white/10 rounded-lg transition-colors"
                    >
                        <X className="w-5 h-5" />
                    </button>
                </div>

                {/* Body */}
                <form onSubmit={handleSubmit} className="p-6 space-y-5">

                    {/* Error Banner */}
                    {error && (
                        <div className="p-3 bg-rose-500/10 border border-rose-500/20 rounded-xl flex items-start gap-3 text-rose-200 text-sm">
                            <AlertCircle className="w-5 h-5 text-rose-400 shrink-0 mt-0.5" />
                            <span>{error}</span>
                        </div>
                    )}

                    {/* Email Input */}
                    <div className="space-y-1.5">
                        <label className="text-xs font-semibold text-slate-400 uppercase tracking-wider ml-1">
                            Email Corporativo
                        </label>
                        <div className="relative">
                            <Mail className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500" />
                            <input
                                type="email"
                                value={formData.email}
                                onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                                className="w-full pl-10 pr-4 py-2.5 bg-slate-900/50 border border-white/10 rounded-xl text-slate-200 text-sm focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500/50 outline-none transition-all placeholder:text-slate-600"
                                placeholder="usuario@executive-fintech.com"
                                autoFocus
                            />
                        </div>
                    </div>

                    {/* Role Selection */}
                    <div className="grid grid-cols-2 gap-4">
                        <div className="space-y-1.5">
                            <label className="text-xs font-semibold text-slate-400 uppercase tracking-wider ml-1">
                                Rol
                            </label>
                            <div className="relative">
                                <Shield className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500" />
                                <select
                                    value={formData.role}
                                    onChange={(e) => setFormData({ ...formData, role: e.target.value })}
                                    className="w-full pl-10 pr-8 py-2.5 bg-slate-900/50 border border-white/10 rounded-xl text-slate-200 text-sm focus:ring-2 focus:ring-indigo-500/50 outline-none appearance-none"
                                >
                                    <option value="user">Usuario B√°sico</option>
                                    <option value="franchise">Franquiciado</option>
                                    <option value="admin">Administrador</option>
                                </select>
                                {/* Chevron */}
                                <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-500">
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" /></svg>
                                </div>
                            </div>
                        </div>

                        {/* Status Selection */}
                        <div className="space-y-1.5">
                            <label className="text-xs font-semibold text-slate-400 uppercase tracking-wider ml-1">
                                Estado Inicial
                            </label>
                            <select
                                value={formData.status}
                                onChange={(e) => setFormData({ ...formData, status: e.target.value })}
                                className="w-full px-4 py-2.5 bg-slate-900/50 border border-white/10 rounded-xl text-slate-200 text-sm focus:ring-2 focus:ring-indigo-500/50 outline-none appearance-none"
                            >
                                <option value="pending">Pendiente (Onboarding)</option>
                                <option value="active">Activo</option>
                            </select>
                        </div>
                    </div>

                    {/* Franchise ID (Conditional) */}
                    {formData.role === 'franchise' && (
                        <div className="space-y-1.5 animate-in slide-in-from-top-2 duration-200">
                            <label className="text-xs font-semibold text-slate-400 uppercase tracking-wider ml-1">
                                ID de Franquicia
                            </label>
                            <div className="relative">
                                <Building className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500" />
                                <input
                                    type="text"
                                    value={formData.franchiseId}
                                    onChange={(e) => setFormData({ ...formData, franchiseId: e.target.value })}
                                    className="w-full pl-10 pr-4 py-2.5 bg-slate-900/50 border border-white/10 rounded-xl text-slate-200 text-sm focus:ring-2 focus:ring-amber-500/50 focus:border-amber-500/50 outline-none transition-all placeholder:text-slate-600"
                                    placeholder="Ej: FRAN-001"
                                />
                            </div>
                            <p className="text-[10px] text-amber-400/80 ml-1">
                                * Requerido para vincular datos operativos.
                            </p>
                        </div>
                    )}

                    {/* Actions */}
                    <div className="pt-4 flex gap-3">
                        <button
                            type="button"
                            onClick={onClose}
                            className="flex-1 py-2.5 text-slate-400 hover:text-white hover:bg-white/5 rounded-xl text-sm font-semibold transition-colors"
                            disabled={isLoading}
                        >
                            Cancelar
                        </button>
                        <button
                            type="submit"
                            disabled={isLoading}
                            className="flex-1 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl text-sm font-bold shadow-lg shadow-indigo-500/25 transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                        >
                            {isLoading ? (
                                <>
                                    <Loader2 className="w-4 h-4 animate-spin" />
                                    Creando...
                                </>
                            ) : (
                                "Crear Usuario"
                            )}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
};

export default CreateUserModal;



================================================================================
FILE: src\components\CustomChartTooltip.jsx
================================================================================
import React from 'react';

const CustomChartTooltip = ({ active, payload, label }) => {
    if (active && payload && payload.length) {
        return (
            <div className="bg-slate-900/95 text-white p-3 rounded-xl shadow-2xl border border-slate-700 backdrop-blur-md z-50">
                <p className="font-bold text-sm mb-1 text-slate-300">{label}</p>
                {payload.map((entry, index) => (
                    <p key={index} className="text-xs font-semibold" style={{ color: entry.color }}>
                        {entry.name}: <span className="font-mono">{typeof entry.value === 'number' ? entry.value.toLocaleString() : entry.value}</span>
                        {entry.unit}
                    </p>
                ))}
            </div>
        );
    }
    return null;
};

export default CustomChartTooltip;



================================================================================
FILE: src\components\DashboardCharts.jsx
================================================================================
import React, { useMemo } from 'react';
import {
    BarChart, Bar, AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer,
    PieChart, Pie, Cell
} from 'recharts';
import { formatMoney } from '../lib/finance';
import { TrendingUp, PieChart as PieIcon } from 'lucide-react';

const COLORS = ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];

const CustomTooltip = ({ active, payload, label }) => {
    if (active && payload && payload.length) {
        return (
            <div className="glass-panel p-3 border border-white/60 shadow-xl rounded-xl backdrop-blur-md bg-white/80">
                <p className="font-bold text-slate-800 mb-2">{label}</p>
                {payload.map((entry, index) => (
                    <div key={index} className="flex items-center gap-2 text-sm mb-1">
                        <div className="w-2 h-2 rounded-full shadow-sm" style={{ backgroundColor: entry.color }} />
                        <span className="text-slate-500 capitalize">{entry.name}:</span>
                        <span className="font-mono font-medium text-slate-700">
                            {formatMoney(entry.value)}‚Ç¨
                        </span>
                    </div>
                ))}
            </div>
        );
    }
    return null;
};

const DashboardCharts = ({ report }) => {
    // Memoize expensive data transformations
    const { barData, finalPieData } = useMemo(() => {
        // Prepare Data for Bar Chart
        const barData = [
            {
                name: 'Resumen Financiero',
                Ingresos: report?.revenue || 0,
                Gastos: report?.expenses || 0,
                Beneficio: report?.profit || 0
            }
        ];

        // Prepare Data for Pie Chart (Cost Breakdown)
        const pieData = report?.breakdown?.filter(bg => bg.value > 0).map(item => ({
            name: item.name,
            value: item.value
        })) || [];

        pieData.sort((a, b) => b.value - a.value);

        let finalPieData = pieData;
        if (pieData.length > 5) {
            const top5 = pieData.slice(0, 5);
            const others = pieData.slice(5).reduce((acc, curr) => acc + curr.value, 0);
            finalPieData = [...top5, { name: 'Otros', value: others }];
        }

        return { barData, finalPieData };
    }, [report?.revenue, report?.expenses, report?.profit, report?.breakdown]);



    return (
        <div className="animate-fade-in-up">

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                {/* Main Bar Chart */}
                <div className="lg:col-span-2 glass-panel p-6 rounded-ios-xl relative group transition-all duration-300 hover:shadow-lg">
                    {/* Ambient Glow */}
                    <div className="absolute top-0 right-0 w-32 h-32 bg-indigo-400/5 rounded-full blur-3xl pointer-events-none group-hover:bg-indigo-400/10 transition-colors" />

                    <div className="flex items-center justify-between mb-6 relative z-10">
                        <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                            <div className="p-2 bg-indigo-50 rounded-lg shadow-sm">
                                <TrendingUp className="w-5 h-5 text-indigo-500" />
                            </div>
                            Rendimiento Financiero
                        </h3>
                        {/* Legend Chips */}
                        <div className="flex gap-2 text-[10px] md:text-xs font-bold uppercase tracking-wider">
                            <span className="px-2 py-1 bg-indigo-50/80 text-indigo-600 rounded-md border border-indigo-100">Ingresos</span>
                            <span className="px-2 py-1 bg-rose-50/80 text-rose-600 rounded-md border border-rose-100">Gastos</span>
                            <span className="px-2 py-1 bg-emerald-50/80 text-emerald-600 rounded-md border border-emerald-100">Beneficio</span>
                        </div>
                    </div>

                    <div className="h-80 w-full relative z-10">
                        <ResponsiveContainer width="100%" height="100%">
                            <AreaChart data={barData} margin={{ top: 20, right: 10, left: -20, bottom: 0 }}>
                                <defs>
                                    <linearGradient id="colorIngresos" x1="0" y1="0" x2="0" y2="1">
                                        <stop offset="5%" stopColor="#6366f1" stopOpacity={0.3} />
                                        <stop offset="95%" stopColor="#6366f1" stopOpacity={0} />
                                    </linearGradient>
                                    <linearGradient id="colorGastos" x1="0" y1="0" x2="0" y2="1">
                                        <stop offset="5%" stopColor="#ef4444" stopOpacity={0.3} />
                                        <stop offset="95%" stopColor="#ef4444" stopOpacity={0} />
                                    </linearGradient>
                                    <linearGradient id="colorBeneficio" x1="0" y1="0" x2="0" y2="1">
                                        <stop offset="5%" stopColor="#10b981" stopOpacity={0.3} />
                                        <stop offset="95%" stopColor="#10b981" stopOpacity={0} />
                                    </linearGradient>
                                </defs>
                                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" strokeOpacity={0.6} />
                                <XAxis dataKey="name" axisLine={false} tickLine={false} tick={{ fill: '#64748b', fontSize: 12, fontWeight: 500 }} />
                                <YAxis axisLine={false} tickLine={false} tick={{ fill: '#94a3b8', fontSize: 11 }} tickFormatter={(val) => `${val / 1000}k`} />
                                <Tooltip content={<CustomTooltip />} cursor={{ stroke: '#6366f1', strokeWidth: 1, strokeDasharray: '5 5' }} />
                                <Area type="monotone" dataKey="Ingresos" stroke="#6366f1" strokeWidth={3} fillOpacity={1} fill="url(#colorIngresos)" animationDuration={1500} />
                                <Area type="monotone" dataKey="Gastos" stroke="#ef4444" strokeWidth={3} fillOpacity={1} fill="url(#colorGastos)" animationDuration={1500} />
                                <Area type="monotone" dataKey="Beneficio" stroke="#10b981" strokeWidth={3} fillOpacity={1} fill="url(#colorBeneficio)" animationDuration={1500} />
                            </AreaChart>
                        </ResponsiveContainer>
                    </div>
                </div>

                {/* Cost Breakdown Pie Chart */}
                <div className="glass-panel p-6 rounded-ios-xl relative group transition-all duration-300 hover:shadow-lg">
                    {/* Ambient Glow */}
                    <div className="absolute bottom-0 left-0 w-32 h-32 bg-amber-400/5 rounded-full blur-3xl pointer-events-none group-hover:bg-amber-400/10 transition-colors" />

                    <h3 className="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2 relative z-10">
                        <div className="p-2 bg-amber-50 rounded-lg shadow-sm">
                            <PieIcon className="w-5 h-5 text-amber-500" />
                        </div>
                        Distribuci√≥n
                    </h3>

                    <div className="h-64 w-full relative z-10">
                        <ResponsiveContainer width="100%" height="100%">
                            <PieChart>
                                <Pie
                                    data={finalPieData}
                                    cx="50%"
                                    cy="50%"
                                    innerRadius={65}
                                    outerRadius={85}
                                    paddingAngle={4}
                                    dataKey="value"
                                    stroke="none"
                                >
                                    {finalPieData.map((entry, index) => (
                                        <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                                    ))}
                                </Pie>
                                <Tooltip content={<CustomTooltip />} />
                            </PieChart>
                        </ResponsiveContainer>

                        {/* Center Text Summary */}
                        <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center pointer-events-none">
                            <p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Total</p>
                            <p className="text-xl font-black text-slate-800">{formatMoney(report?.expenses)}‚Ç¨</p>
                        </div>
                    </div>

                    {/* Custom Legend */}
                    <div className="mt-4 space-y-2.5 max-h-40 overflow-y-auto pr-1 scrollbar-hide relative z-10">
                        {finalPieData.map((entry, index) => (
                            <div key={index} className="flex items-center justify-between text-sm group cursor-default p-2 rounded-lg hover:bg-slate-50 transition-colors">
                                <div className="flex items-center gap-3">
                                    <div className="w-2.5 h-2.5 rounded-full shadow-sm" style={{ backgroundColor: COLORS[index % COLORS.length] }} />
                                    <span className="text-slate-600 font-medium truncate max-w-[110px]" title={entry.name}>{entry.name}</span>
                                </div>
                                <span className="font-bold text-slate-800">{((entry.value / (report?.expenses || 1)) * 100).toFixed(1)}%</span>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        </div>
    );
};

export default React.memo(DashboardCharts);



================================================================================
FILE: src\components\DashboardSkeleton.jsx
================================================================================
import React from 'react';
import Skeleton from './ui/Skeleton';

const DashboardSkeleton = () => {
    return (
        <div className="p-5 md:p-8 space-y-6 md:space-y-8 animate-fade-in-up">
            {/* Header / Title Area */}
            <div className="flex justify-between items-center mb-6">
                <Skeleton className="h-8 w-48" />
                <Skeleton className="h-8 w-32" />
            </div>

            {/* KPI Cards Grid */}
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5 md:gap-6">
                <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm h-40 flex flex-col justify-between">
                    <div className="flex justify-between">
                        <Skeleton className="h-4 w-24" />
                        <Skeleton variant="circular" className="h-8 w-8" />
                    </div>
                    <Skeleton className="h-10 w-32" />
                    <Skeleton className="h-4 w-20" />
                </div>
                <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm h-40 flex flex-col justify-between">
                    <div className="flex justify-between">
                        <Skeleton className="h-4 w-24" />
                        <Skeleton variant="circular" className="h-8 w-8" />
                    </div>
                    <Skeleton className="h-10 w-32" />
                    <Skeleton className="h-4 w-20" />
                </div>
                <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm h-40 flex flex-col justify-between">
                    <div className="flex justify-between">
                        <Skeleton className="h-4 w-24" />
                        <Skeleton variant="circular" className="h-8 w-8" />
                    </div>
                    <Skeleton className="h-10 w-32" />
                    <Skeleton className="h-4 w-20" />
                </div>
                <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm h-40 flex flex-col justify-between">
                    <div className="flex justify-between">
                        <Skeleton className="h-4 w-24" />
                        <Skeleton variant="circular" className="h-8 w-8" />
                    </div>
                    <Skeleton className="h-10 w-32" />
                    <Skeleton className="h-4 w-20" />
                </div>
            </div>

            {/* Health Indicators */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <Skeleton className="h-32 w-full rounded-xl" />
                <Skeleton className="h-32 w-full rounded-xl" />
                <Skeleton className="h-32 w-full rounded-xl" />
            </div>

            {/* Charts Area */}
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <Skeleton className="lg:col-span-2 h-80 rounded-xl" />
                <Skeleton className="h-80 rounded-xl" />
            </div>
        </div>
    );
};

export default DashboardSkeleton;



================================================================================
FILE: src\components\ErrorBoundary.jsx
================================================================================
import React from 'react';
import { AlertCircle, RefreshCw } from 'lucide-react';

class ErrorBoundary extends React.Component {
    constructor(props) {
        super(props);
        this.state = { hasError: false, error: null, errorInfo: null };
    }

    static getDerivedStateFromError(error) {
        // Update state so the next render will show the fallback UI.
        return { hasError: true, error };
    }

    componentDidCatch(error, errorInfo) {
        // You can also log the error to an error reporting service
        console.error("Uncaught error:", error, errorInfo);
        this.setState({ errorInfo });
    }

    handleReset = () => {
        this.setState({ hasError: false, error: null, errorInfo: null });
    };

    render() {
        if (this.state.hasError) {
            if (this.props.fallback) {
                return this.props.fallback; // Custom fallback
            }

            // Default beautiful fallback
            return (
                <div className="w-full p-6 rounded-xl border border-rose-100 bg-rose-50/50 flex flex-col items-center justify-center text-center min-h-[200px]">
                    <div className="p-3 bg-white rounded-full shadow-sm mb-4">
                        <AlertCircle className="w-8 h-8 text-rose-500" />
                    </div>
                    <h3 className="text-lg font-bold text-slate-800 mb-2">Algo sali√≥ mal</h3>
                    <p className="text-sm text-slate-500 mb-4 max-w-md mx-auto">
                        Hemos encontrado un error al cargar este componente. No te preocupes, el resto de la aplicaci√≥n sigue funcionando.
                    </p>

                    <div className="flex gap-3">
                        <button
                            onClick={this.handleReset}
                            className="px-4 py-2 bg-white border border-rose-200 text-rose-600 rounded-lg text-sm font-semibold hover:bg-rose-50 transition-colors flex items-center"
                        >
                            <RefreshCw className="w-4 h-4 mr-2" />
                            Reintentar
                        </button>
                    </div>

                    {import.meta.env.DEV && this.state.error && (
                        <div className="mt-6 w-full text-left bg-slate-900 p-4 rounded-lg overflow-x-auto">
                            <p className="text-rose-400 font-mono text-xs mb-2 font-bold">DEBUG INFO:</p>
                            <pre className="text-slate-300 font-mono text-xs whitespace-pre-wrap">
                                {this.state.error.toString()}
                            </pre>
                        </div>
                    )}
                </div>
            );
        }

        return this.props.children;
    }
}

export default ErrorBoundary;



================================================================================
FILE: src\components\FleetCard.jsx
================================================================================
import React from 'react';
import InfoTooltip from './InfoTooltip';

import Card from './ui/Card';

const FleetCard = ({ title, value, subtext, icon: Icon, alertLevel = 'neutral', tooltip }) => {
    let colorClass = "text-gray-900";
    // bg-white is default in Card

    if (alertLevel === 'good') colorClass = "text-emerald-600";
    if (alertLevel === 'warning') colorClass = "text-amber-500";
    if (alertLevel === 'bad') colorClass = "text-rose-600";

    return (
        <Card className="hover:-translate-y-1 transition-transform duration-300 p-5">
            <div className="flex justify-between items-center mb-3">
                <div className="flex items-center">
                    <p className="text-xs font-bold text-gray-400 uppercase tracking-widest">{title}</p>
                    {tooltip && <InfoTooltip text={tooltip} />}
                </div>
                {Icon && <Icon className={`w-4 h-4 text-gray-300`} />}
            </div>
            <h3 className={`text-2xl font-extrabold ${colorClass} tracking-tight`}>{value}</h3>
            {subtext && <p className="text-xs text-gray-400 mt-1 font-medium">{subtext}</p>}
        </Card>
    );
};

export default FleetCard;



================================================================================
FILE: src\components\FleetManager.jsx
================================================================================
import React, { useState, useEffect } from 'react';
import { Truck, AlertTriangle, Plus, PenTool, CheckCircle, Search, Gauge, Calendar, AlertOctagon } from 'lucide-react';
import { db } from '../lib/firebase';
import { collection, addDoc, getDocs, query, orderBy } from 'firebase/firestore';

// Mock data for initial dev if DB is empty
const MOCK_FLEET = [
    { id: '1', alias: 'Rayo 01', plate: '1234 ABC', model: 'Yamaha NMAX 125', currentKm: 850, nextRevisionKm: 1000, status: 'active', lastRevisionDate: '2023-11-01' },
    { id: '2', alias: 'Trueno 02', plate: '5678 DEF', model: 'Honda PCX', currentKm: 5200, nextRevisionKm: 5000, status: 'warning', lastRevisionDate: '2023-10-15' },
    { id: '3', alias: 'Rayo 03', plate: '9012 GHI', model: 'Yamaha NMAX 125', currentKm: 300, nextRevisionKm: 1000, status: 'repair', lastRevisionDate: '2023-12-01' },
];

const FleetManager = () => {
    const [vehicles, setVehicles] = useState([]);
    const [loading, setLoading] = useState(true);
    const [showForm, setShowForm] = useState(false);
    const [newVehicle, setNewVehicle] = useState({
        alias: '', plate: '', model: '', currentKm: 0, nextRevisionKm: 1000, status: 'active'
    });

    const fetchFleet = async () => {
        setLoading(true);
        // BUNKER MODE: Load from cache first
        const cached = localStorage.getItem('fleet_cache');
        if (cached) {
            setVehicles(JSON.parse(cached));
            setLoading(false); // Show cached immediately
        }

        try {
            const q = query(collection(db, "fleet_vehicles"), orderBy("alias"));
            const querySnapshot = await getDocs(q);
            const fleetData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            if (fleetData.length === 0 && !cached) {
                setVehicles(MOCK_FLEET);
            } else if (fleetData.length > 0) {
                setVehicles(fleetData);
                // BUNKER MODE: Update cache
                localStorage.setItem('fleet_cache', JSON.stringify(fleetData));
            }
        } catch (error) {
            console.error("Error fetching fleet:", error);
            if (!cached) setVehicles(MOCK_FLEET);
        }
        setLoading(false);
    };

    useEffect(() => {
        const timer = setTimeout(() => {
            fetchFleet();
        }, 0);
        return () => clearTimeout(timer);
    }, []);

    const handleAddVehicle = async (e) => {
        e.preventDefault();
        try {
            await addDoc(collection(db, "fleet_vehicles"), {
                ...newVehicle,
                currentKm: Number(newVehicle.currentKm),
                nextRevisionKm: Number(newVehicle.nextRevisionKm),
                lastRevisionDate: new Date().toISOString()
            });
            setShowForm(false);
            setNewVehicle({ alias: '', plate: '', model: '', currentKm: 0, nextRevisionKm: 1000, status: 'active' });
            fetchFleet();
        } catch (error) {
            console.error("Error adding vehicle:", error);
        }
    };

    const getHealthColor = (current, target) => {
        const percentage = (current / target) * 100;
        if (current >= target) return 'text-rose-500'; // Over limit
        if (percentage > 90) return 'text-orange-500'; // Warning zone
        return 'text-emerald-500'; // Healthy
    };

    const getHealthProgress = (current, target) => {
        const percentage = (current / target) * 100;
        return Math.min(percentage, 100);
    };

    const getStatusBadge = (status) => {
        switch (status) {
            case 'active': return <span className="px-2 py-1 bg-emerald-500/20 text-emerald-400 text-xs rounded-full border border-emerald-500/30 flex items-center gap-1"><CheckCircle size={12} /> Operativa</span>;
            case 'warning': return <span className="px-2 py-1 bg-orange-500/20 text-orange-400 text-xs rounded-full border border-orange-500/30 flex items-center gap-1"><AlertTriangle size={12} /> Revisi√≥n</span>;
            case 'repair': return <span className="px-2 py-1 bg-rose-500/20 text-rose-400 text-xs rounded-full border border-rose-500/30 flex items-center gap-1"><PenTool size={12} /> Taller</span>;
            default: return null;
        }
    };

    return (
        <div className="space-y-6 animate-fade-in">
            {/* Header */}
            <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 bg-slate-800/50 p-6 rounded-xl border border-slate-700/50 backdrop-blur-sm">
                <div>
                    <h2 className="text-2xl font-bold bg-gradient-to-r from-blue-400 to-indigo-400 bg-clip-text text-transparent flex items-center gap-3">
                        <Truck className="text-blue-400" /> Gestor de Flota Yamimoto
                    </h2>
                    <p className="text-slate-400 mt-1">Control de mantenimiento y estado de veh√≠culos</p>
                </div>
                <button
                    onClick={() => setShowForm(!showForm)}
                    className="flex items-center gap-2 bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg transition-all shadow-lg hover:shadow-blue-500/20 active:scale-95 font-medium"
                >
                    <Plus size={18} /> Nueva Moto
                </button>
            </div>

            {/* Add Form */}
            {showForm && (
                <div className="bg-slate-800/80 p-6 rounded-xl border border-slate-700 animate-slide-in-top">
                    <h3 className="text-lg font-semibold text-slate-200 mb-4">Registrar Nuevo Veh√≠culo</h3>
                    <form onSubmit={handleAddVehicle} className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input className="bg-slate-900 border border-slate-700 rounded-lg p-3 text-white focus:outline-none focus:border-blue-500" placeholder="Alias (ej. Rayo 01)" value={newVehicle.alias} onChange={e => setNewVehicle({ ...newVehicle, alias: e.target.value })} required />
                        <input className="bg-slate-900 border border-slate-700 rounded-lg p-3 text-white focus:outline-none focus:border-blue-500" placeholder="Matr√≠cula" value={newVehicle.plate} onChange={e => setNewVehicle({ ...newVehicle, plate: e.target.value })} required />
                        <input className="bg-slate-900 border border-slate-700 rounded-lg p-3 text-white focus:outline-none focus:border-blue-500" placeholder="Modelo" value={newVehicle.model} onChange={e => setNewVehicle({ ...newVehicle, model: e.target.value })} required />
                        <div className="relative">
                            <Gauge size={18} className="absolute left-3 top-3.5 text-slate-500" />
                            <input type="number" className="bg-slate-900 border border-slate-700 rounded-lg p-3 pl-10 text-white w-full focus:outline-none focus:border-blue-500" placeholder="KM Actuales" value={newVehicle.currentKm} onChange={e => setNewVehicle({ ...newVehicle, currentKm: e.target.value })} required />
                        </div>
                        <div className="relative">
                            <AlertOctagon size={18} className="absolute left-3 top-3.5 text-slate-500" />
                            <select className="bg-slate-900 border border-slate-700 rounded-lg p-3 pl-10 text-white w-full focus:outline-none focus:border-blue-500" value={newVehicle.nextRevisionKm} onChange={e => setNewVehicle({ ...newVehicle, nextRevisionKm: e.target.value })}>
                                <option value="1000">Revisi√≥n 1.000 KM</option>
                                <option value="5000">Revisi√≥n 5.000 KM</option>
                                <option value="10000">Revisi√≥n 10.000 KM</option>
                            </select>
                        </div>
                        <div className="relative">
                            <select className="bg-slate-900 border border-slate-700 rounded-lg p-3 text-white w-full focus:outline-none focus:border-blue-500" value={newVehicle.status} onChange={e => setNewVehicle({ ...newVehicle, status: e.target.value })}>
                                <option value="active">Operativa</option>
                                <option value="warning">Revisi√≥n Pendiente</option>
                                <option value="repair">En Taller</option>
                            </select>
                        </div>
                        <div className="md:col-span-3 flex justify-end gap-3 mt-2">
                            <button type="button" onClick={() => setShowForm(false)} className="px-4 py-2 text-slate-400 hover:text-white transition-colors">Cancelar</button>
                            <button type="submit" className="bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-2 rounded-lg font-medium shadow-lg hover:shadow-emerald-500/20">Guardar Moto</button>
                        </div>
                    </form>
                </div>
            )}

            {/* Veh√≠culos Grid */}
            {loading ? (
                <div className="text-center py-20 text-slate-500">Cargando flota...</div>
            ) : (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {vehicles.map(moto => {
                        const health = getHealthProgress(moto.currentKm, moto.nextRevisionKm);
                        const isDanger = health >= 100;
                        const isWarning = health > 90 && health < 100;

                        return (
                            <div key={moto.id} className="group bg-slate-800 rounded-xl border border-slate-700 hover:border-slate-600 transition-all hover:shadow-2xl hover:shadow-blue-900/10 overflow-hidden relative">
                                {/* Top Status Bar */}
                                <div className={`h-1.5 w-full ${isDanger ? 'bg-rose-500' : isWarning ? 'bg-orange-500' : 'bg-emerald-500'}`} />

                                <div className="p-5">
                                    <div className="flex justify-between items-start mb-4">
                                        <div>
                                            <h3 className="text-xl font-bold text-white group-hover:text-blue-400 transition-colors">{moto.alias}</h3>
                                            <div className="text-sm text-slate-400 font-mono mt-0.5 flex items-center gap-1">
                                                <span className="bg-slate-900 px-1.5 py-0.5 rounded border border-slate-700">{moto.plate}</span>
                                                <span>‚Ä¢ {moto.model}</span>
                                            </div>
                                        </div>
                                        {getStatusBadge(moto.status)}
                                    </div>

                                    {/* KM Health Bar */}
                                    <div className="space-y-2 mb-4">
                                        <div className="flex justify-between text-sm">
                                            <span className="text-slate-400">Kilometraje</span>
                                            <span className={`${getHealthColor(moto.currentKm, moto.nextRevisionKm)} font-semibold`}>
                                                {moto.currentKm.toLocaleString()} / {moto.nextRevisionKm.toLocaleString()} km
                                            </span>
                                        </div>
                                        <div className="h-3 bg-slate-900 rounded-full overflow-hidden border border-slate-700/50">
                                            <div
                                                className={`h-full transition-all duration-1000 ease-out rounded-full ${isDanger ? 'bg-rose-500' : isWarning ? 'bg-orange-500' : 'bg-emerald-500'}`}
                                                style={{ width: `${health}%` }}
                                            />
                                        </div>
                                        {isDanger && (
                                            <div className="flex items-center gap-2 text-rose-400 text-xs bg-rose-500/10 p-2 rounded-lg border border-rose-500/20 mt-2">
                                                <AlertTriangle size={14} />
                                                <span>Revisi√≥n obligatoria inmediata (Garant√≠a en riesgo).</span>
                                            </div>
                                        )}
                                    </div>

                                    <div className="flex items-center gap-2 text-xs text-slate-500 border-t border-slate-700/50 pt-4 mt-4">
                                        <Calendar size={12} />
                                        <span>√öltima revisi√≥n: {moto.lastRevisionDate ? new Date(moto.lastRevisionDate).toLocaleDateString() : 'Pendiente'}</span>
                                    </div>

                                    {/* Action Footer (Mock buttons for now) */}
                                    <div className="mt-4 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button className="flex-1 bg-slate-700 hover:bg-slate-600 text-slate-300 py-1.5 rounded-lg text-sm border border-slate-600">Actualizar KM</button>
                                        <button className="flex-1 bg-slate-700 hover:bg-slate-600 text-slate-300 py-1.5 rounded-lg text-sm border border-slate-600">Reportar Aver√≠a</button>
                                    </div>
                                </div>
                            </div>
                        );
                    })}
                </div>
            )}
        </div>
    );
};

export default FleetManager;



================================================================================
FILE: src\components\FlipCard.jsx
================================================================================
import React, { useState } from 'react';
import { Volume2, VolumeX, PlayCircle } from 'lucide-react';

/**
 * FlipCard - Tarjeta 3D con efecto flip
 * Professional implementation with accessibility
 */
const FlipCard = ({ module, isViewed, onFlip, categoryColor = 'blue', presentationMode = false }) => {
    const [isFlipped, setIsFlipped] = useState(false);
    const [isSpeaking, setIsSpeaking] = useState(false);

    const handleClick = () => {
        setIsFlipped(!isFlipped);
        if (onFlip && !isViewed) {
            onFlip(module.id);
        }
    };

    const handleSpeak = (e) => {
        e.stopPropagation();

        if ('speechSynthesis' in window) {
            if (isSpeaking) {
                window.speechSynthesis.cancel();
                setIsSpeaking(false);
            } else {
                const text = `${module.title}. ${module.content}. Acci√≥n: ${module.action}`;
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'es-ES';
                utterance.rate = 0.9;
                utterance.onend = () => setIsSpeaking(false);

                window.speechSynthesis.speak(utterance);
                setIsSpeaking(true);
            }
        }
    };

    const cardHeight = presentationMode ? 'h-[600px]' : 'h-96';

    return (
        <div
            className={`cursor-pointer perspective-1000 group ${cardHeight}`}
            onClick={handleClick}
        >
            <div
                className={`relative w-full h-full transition-all duration-700 transform-style-preserve-3d ${isFlipped ? '[transform:rotateY(180deg)]' : ''
                    }`}
                style={{ transformStyle: 'preserve-3d' }}
            >
                {/* FRONT */}
                <div
                    className="absolute w-full h-full surface-raised rounded-xl elevation-md backface-hidden border border-slate-200 overflow-hidden flex flex-col"
                    style={{ backfaceVisibility: 'hidden' }}
                >
                    {/* Top colored bar */}
                    <div className={`h-2 w-full ${isViewed ? 'bg-emerald-500' : `bg-${categoryColor}-600`}`}></div>

                    <div className="p-6 flex flex-col h-full justify-between">
                        <div>
                            <span className="text-caption text-tertiary border border-slate-200 px-2 py-1 rounded inline-block">
                                M√≥dulo
                            </span>
                            <h3 className={`font-bold text-primary mt-4 leading-tight ${presentationMode ? 'text-4xl' : 'text-xl'
                                }`}>
                                {module.title}
                            </h3>
                        </div>

                        <div className="flex justify-center opacity-20">
                            <PlayCircle size={presentationMode ? 64 : 48} className={`text-${categoryColor}-600`} />
                        </div>

                        {isViewed && (
                            <div className="absolute top-4 right-4">
                                <div className="w-8 h-8 rounded-full bg-emerald-100 flex items-center justify-center">
                                    <svg className="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7" />
                                    </svg>
                                </div>
                            </div>
                        )}
                    </div>
                </div>

                {/* BACK */}
                <div
                    className="absolute w-full h-full bg-slate-900 rounded-xl elevation-lg [transform:rotateY(180deg)] backface-hidden p-6 flex flex-col justify-between text-white shadow-inner"
                    style={{ backfaceVisibility: 'hidden' }}
                >
                    <div className="overflow-y-auto pr-2 custom-scroll flex-1">
                        <div className="flex justify-between items-start mb-4">
                            <h4 className={`text-${categoryColor}-400 text-caption`}>
                                CONCEPTO
                            </h4>
                            <button
                                onClick={handleSpeak}
                                className={`text-${categoryColor}-300 hover:text-white transition-colors p-2 rounded-lg hover:bg-slate-800`}
                                aria-label="Escuchar contenido"
                            >
                                {isSpeaking ? <VolumeX size={20} /> : <Volume2 size={20} />}
                            </button>
                        </div>

                        <p className={`font-medium leading-relaxed text-slate-300 ${presentationMode ? 'text-xl' : 'text-base'
                            }`}>
                            {module.content}
                        </p>
                    </div>

                    <div className={`surface-sunken bg-slate-800 p-4 rounded-xl border border-slate-700 mt-4`}>
                        <h4 className="text-yellow-400 text-caption flex items-center gap-2 mb-2">
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />
                            </svg>
                            ACCI√ìN T√ÅCTICA
                        </h4>
                        <p className={`italic text-slate-200 ${presentationMode ? 'text-lg' : 'text-sm'}`}>
                            "{module.action}"
                        </p>
                    </div>
                </div>
            </div>
        </div>
    );
};

export default React.memo(FlipCard);



================================================================================
FILE: src\components\ForecastingWidget.jsx
================================================================================
import React from 'react';
import { TrendingUp, Calendar, AlertTriangle, CheckCircle } from 'lucide-react';
import { formatMoney, projectMonthEnd } from '../lib/finance';

const ForecastingWidget = ({ currentRevenue, breakEvenOrders, avgTicket }) => {
    const projectedRevenue = projectMonthEnd(currentRevenue);

    // Calculate Break Even Revenue
    const breakEvenRevenue = (breakEvenOrders !== "N/A" && breakEvenOrders > 0)
        ? breakEvenOrders * avgTicket
        : 0;

    const isOnTrack = projectedRevenue > breakEvenRevenue;
    const daysLeft = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate() - new Date().getDate();

    return (
        <div className="bg-gradient-to-r from-slate-900 to-indigo-900 rounded-2xl p-6 text-white shadow-xl relative overflow-hidden mb-6">
            <div className="flex justify-between items-start relative z-10">
                <div>
                    <h3 className="text-lg font-bold flex items-center mb-1">
                        <TrendingUp className="w-5 h-5 mr-2 text-emerald-400" />
                        Proyecci√≥n Cierre de Mes
                    </h3>
                    <p className="text-slate-300 text-xs">
                        Estimaci√≥n basada en tu ritmo actual.
                    </p>
                </div>
                <div className="text-right bg-white/10 p-2 rounded-lg backdrop-blur-sm border border-white/10">
                    <p className="text-[10px] font-bold text-indigo-200 uppercase tracking-wider">D√≠as Restantes</p>
                    <p className="text-xl font-black text-white flex items-center justify-end">
                        <Calendar className="w-4 h-4 mr-2 opacity-70" /> {daysLeft}
                    </p>
                </div>
            </div>

            <div className="grid grid-cols-1 sm:grid-cols-3 gap-6 mt-6 relative z-10">
                {/* CURRENT */}
                <div>
                    <p className="text-xs font-bold text-slate-400 uppercase">Facturado (Hoy)</p>
                    <p className="text-2xl font-bold text-white mt-1">{formatMoney(currentRevenue)}‚Ç¨</p>
                </div>

                {/* PROJECTED */}
                <div>
                    <p className="text-xs font-bold text-emerald-400 uppercase">Proyecci√≥n (Fin Mes)</p>
                    <p className="text-3xl font-black text-emerald-400 mt-1">{formatMoney(projectedRevenue)}‚Ç¨</p>
                </div>

                {/* STATUS */}
                <div className={`p-4 rounded-xl border ${isOnTrack ? 'bg-emerald-500/20 border-emerald-500/30' : 'bg-amber-500/20 border-amber-500/30'} flex items-center`}>
                    {isOnTrack ? (
                        <>
                            <CheckCircle className="w-8 h-8 text-emerald-400 mr-3" />
                            <div>
                                <p className="font-bold text-emerald-200 text-sm">Ritmo Saludable</p>
                                <p className="text-xs text-emerald-100/70">Superar√°s el Break-even.</p>
                            </div>
                        </>
                    ) : (
                        <>
                            <AlertTriangle className="w-8 h-8 text-amber-400 mr-3" />
                            <div>
                                <p className="font-bold text-amber-200 text-sm">Riesgo Detectado</p>
                                <p className="text-xs text-amber-100/70">Necesitas +{formatMoney(Math.max(0, breakEvenRevenue - projectedRevenue))}‚Ç¨.</p>
                            </div>
                        </>
                    )}
                </div>
            </div>

            {/* PROGRESS BAR */}
            <div className="mt-6 relative pt-4">
                <div className="flex justify-between text-xs text-slate-400 mb-2 font-medium">
                    <span>0‚Ç¨</span>
                    <span className="text-indigo-300">Break-even: {formatMoney(breakEvenRevenue)}‚Ç¨</span>
                    <span>Objetivo: {formatMoney(breakEvenRevenue * 1.5)}‚Ç¨</span>
                </div>
                <div className="w-full bg-slate-800 h-3 rounded-full overflow-hidden relative">
                    {/* Break Even Marker */}
                    <div className="absolute top-0 bottom-0 w-0.5 bg-indigo-500 z-20" style={{ left: `${Math.min(100, (breakEvenRevenue / (breakEvenRevenue * 1.5)) * 100)}%` }}></div>

                    {/* Projected Bar */}
                    <div className="h-full bg-emerald-500/50 absolute top-0 left-0 transition-all duration-1000" style={{ width: `${Math.min(100, (projectedRevenue / (breakEvenRevenue * 1.5)) * 100)}%` }}></div>

                    {/* Current Bar */}
                    <div className="h-full bg-emerald-400 relative z-10 rounded-r-full transition-all duration-1000 shadow-[0_0_10px_rgba(52,211,153,0.5)]" style={{ width: `${Math.min(100, (currentRevenue / (breakEvenRevenue * 1.5)) * 100)}%` }}></div>
                </div>
            </div>

            <div className="absolute top-0 right-0 -mr-20 -mt-20 w-64 h-64 bg-emerald-500 rounded-full mix-blend-overlay filter blur-3xl opacity-10 animate-pulse"></div>
        </div>
    );
};

export default ForecastingWidget;



================================================================================
FILE: src\components\FranchiseFeatureManager.jsx
================================================================================
import React, { useState, useEffect } from 'react';
import { db } from '../lib/firebase';
import { collection, getDocs, doc, updateDoc } from 'firebase/firestore';
import { Shield, Check, X, Loader } from 'lucide-react';

/**
 * FranchiseFeatureManager - Panel para gestionar features por franquicia
 */
const FranchiseFeatureManager = () => {
    const [franchises, setFranchises] = useState([]);
    const [loading, setLoading] = useState(true);
    const [saving, setSaving] = useState(null);

    useEffect(() => {
        fetchFranchises();
    }, []);

    const fetchFranchises = async () => {
        try {
            const querySnapshot = await getDocs(collection(db, 'franchises'));
            const franchisesData = querySnapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            setFranchises(franchisesData);
            setLoading(false);
        } catch (error) {
            console.error('Error fetching franchises:', error);
            setLoading(false);
        }
    };

    const toggleFeature = async (franchiseId, featureName) => {
        setSaving(franchiseId);

        const franchise = franchises.find(f => f.id === franchiseId);
        const currentFeatures = franchise.features || {};
        const newFeatures = {
            ...currentFeatures,
            [featureName]: !currentFeatures[featureName]
        };

        try {
            await updateDoc(doc(db, 'franchises', franchiseId), {
                features: newFeatures
            });

            // Actualizar estado local
            setFranchises(franchises.map(f =>
                f.id === franchiseId
                    ? { ...f, features: newFeatures }
                    : f
            ));
        } catch (error) {
            console.error('Error updating features:', error);
        } finally {
            setSaving(null);
        }
    };

    const applyPackDefaults = async (franchiseId) => {
        setSaving(franchiseId);

        const franchise = franchises.find(f => f.id === franchiseId);
        const pack = franchise.pack || 'basic';

        const defaultFeatures = {
            basic: {
                downloads: false
            },
            premium: {
                downloads: true
            }
        };

        const features = defaultFeatures[pack] || defaultFeatures.basic;

        try {
            await updateDoc(doc(db, 'franchises', franchiseId), {
                features
            });

            setFranchises(franchises.map(f =>
                f.id === franchiseId
                    ? { ...f, features }
                    : f
            ));
        } catch (error) {
            console.error('Error applying pack defaults:', error);
        } finally {
            setSaving(null);
        }
    };

    if (loading) {
        return (
            <div className="flex items-center justify-center h-64">
                <Loader className="w-8 h-8 animate-spin text-blue-600" />
            </div>
        );
    }

    return (
        <div className="p-8 max-w-7xl mx-auto">
            {/* Header */}
            <div className="mb-8">
                <div className="flex items-center gap-3 mb-2">
                    <Shield className="w-8 h-8 text-blue-600" />
                    <h1 className="text-h1 text-primary">Gesti√≥n de Permisos</h1>
                </div>
                <p className="text-secondary">
                    Activa o desactiva features por franquicia seg√∫n su pack
                </p>
            </div>

            {/* Legend */}
            <div className="surface-raised rounded-xl p-4 mb-6 border border-slate-200">
                <div className="flex flex-wrap gap-6 text-body-sm">
                    <div className="flex items-center gap-2">
                        <div className="w-3 h-3 rounded-full bg-emerald-500"></div>
                        <span className="text-secondary">Pack Premium</span>
                    </div>
                    <div className="flex items-center gap-2">
                        <div className="w-3 h-3 rounded-full bg-slate-400"></div>
                        <span className="text-secondary">Pack Basic</span>
                    </div>
                </div>
            </div>

            {/* Franchises Table */}
            <div className="surface-raised rounded-xl elevation-md border border-slate-200 overflow-hidden">
                <div className="overflow-x-auto">
                    <table className="w-full">
                        <thead className="bg-slate-50 border-b border-slate-200">
                            <tr>
                                <th className="text-left p-4 text-caption text-tertiary font-bold">Franquicia</th>
                                <th className="text-left p-4 text-caption text-tertiary font-bold">Pack</th>

                                <th className="text-center p-4 text-caption text-tertiary font-bold">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {franchises.map((franchise) => {
                                const features = franchise.features || {};
                                const isSaving = saving === franchise.id;

                                return (
                                    <tr key={franchise.id} className="border-b border-slate-100 last:border-0 hover:bg-slate-50 transition-colors">
                                        <td className="p-4">
                                            <div>
                                                <p className="font-bold text-primary">{franchise.name || franchise.email}</p>
                                                <p className="text-body-sm text-tertiary">{franchise.email}</p>
                                            </div>
                                        </td>
                                        <td className="p-4">
                                            <span className={`inline-flex items-center gap-2 px-3 py-1 rounded-full text-caption font-bold ${franchise.pack === 'premium'
                                                ? 'bg-emerald-100 text-emerald-700'
                                                : 'bg-slate-100 text-slate-600'
                                                }`}>
                                                <div className={`w-2 h-2 rounded-full ${franchise.pack === 'premium' ? 'bg-emerald-500' : 'bg-slate-400'
                                                    }`}></div>
                                                {(franchise.pack || 'basic').toUpperCase()}
                                            </span>
                                        </td>

                                        {/* Downloads Toggle */}
                                        <td className="p-4 text-center">
                                            <button
                                                onClick={() => toggleFeature(franchise.id, 'downloads')}
                                                disabled={isSaving}
                                                className={`inline-flex items-center justify-center w-10 h-10 rounded-full transition-all ${features.downloads
                                                    ? 'bg-emerald-100 text-emerald-600 hover:bg-emerald-200'
                                                    : 'bg-red-100 text-red-600 hover:bg-red-200'
                                                    } disabled:opacity-50`}
                                            >
                                                {features.downloads ? <Check size={20} /> : <X size={20} />}
                                            </button>
                                        </td>

                                        {/* Actions */}
                                        <td className="p-4 text-center">
                                            <button
                                                onClick={() => applyPackDefaults(franchise.id)}
                                                disabled={isSaving}
                                                className="px-4 py-2 text-body-sm font-bold text-blue-600 hover:bg-blue-50 rounded-lg transition-colors disabled:opacity-50"
                                            >
                                                {isSaving ? 'Guardando...' : 'Reset Pack'}
                                            </button>
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>

                {franchises.length === 0 && (
                    <div className="p-12 text-center text-tertiary">
                        <Shield className="w-16 h-16 mx-auto mb-4 opacity-30" />
                        <p className="text-h3">No hay franquicias registradas</p>
                        <p className="text-body-sm mt-2">Las franquicias aparecer√°n aqu√≠ cuando se registren</p>
                    </div>
                )}
            </div>

            {/* Help Section */}
            <div className="mt-6 surface-sunken rounded-xl p-6 border border-slate-200">
                <h3 className="text-h3 text-primary mb-3">‚ÑπÔ∏è Informaci√≥n</h3>
                <ul className="space-y-2 text-body-sm text-secondary">
                    <li>‚Ä¢ <strong>Pack Basic</strong>: Sin features activadas por defecto (admin decide)</li>
                    <li>‚Ä¢ <strong>Pack Premium</strong>: Todas las features activadas por defecto</li>
                    <li>‚Ä¢ Puedes activar/desactivar individualmente cada feature</li>
                    <li>‚Ä¢ "Reset Pack" restaura las features seg√∫n el pack asignado</li>
                </ul>
            </div>
        </div>
    );
};

export default FranchiseFeatureManager;



================================================================================
FILE: src\components\FranchiseOnboarding.jsx
================================================================================
import React, { useState } from 'react';
import { CheckCircle, ChevronRight, Building, CreditCard, Shield, UserPlus, Save, ArrowLeft } from 'lucide-react';
import { db } from '../lib/firebase';
import { doc, setDoc, serverTimestamp } from 'firebase/firestore';
import Card from './ui/Card';
import Button from './ui/Button';

// Initial State
const INITIAL_DATA = {
    name: '',
    email: '',
    city: '',
    taxId: '',
    adminName: '',
    adminPassword: '', // In a real app, use Auth service. Here we simulate config.
    tariffPlan: 'standard', // standard, premium
    baseFee: 15
};

const FranchiseOnboarding = ({ onCancel, onComplete }) => {
    const [step, setStep] = useState(1);
    const [data, setData] = useState(INITIAL_DATA);
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState(null);

    const handleChange = (field, value) => {
        setData(prev => ({ ...prev, [field]: value }));
    };

    const handleNext = () => setStep(prev => prev + 1);
    const handleBack = () => setStep(prev => prev - 1);

    const handleSubmit = async () => {
        setLoading(true);
        setError(null);
        try {
            // Generate a simplified ID
            const franchiseId = data.email.split('@')[0].toLowerCase().replace(/[^a-z0-9]/g, '');

            // 1. Create Franchise Config
            await setDoc(doc(db, "users_config", franchiseId), {
                name: data.name,
                email: data.email,
                role: 'franchise',
                city: data.city,
                taxId: data.taxId,
                active: true,
                createdAt: serverTimestamp(),
                plan: data.tariffPlan,
                ownerName: data.adminName,
                // In production, never store passwords in plain text. 
                // This is a config simulation for the "factory" demo.
                tempPassword: data.adminPassword
            });

            // 2. Initialize Financial Config (Optional - simulation)
            // await setDoc(doc(db, "financial_config", franchiseId), { ... });

            onComplete(data.name);
        } catch (err) {
            console.error("Error creating franchise:", err);
            setError("Error al crear la franquicia. Revisa la consola o intenta de nuevo.");
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="max-w-4xl mx-auto space-y-6 animate-fade-in-up">
            {/* Header */}
            <div className="flex items-center justify-between mb-8">
                <div>
                    <h2 className="text-3xl font-bold text-slate-800">Alta de Nueva Franquicia</h2>
                    <p className="text-slate-500 mt-1">Wizard de configuraci√≥n inicial para expansi√≥n de red.</p>
                </div>
                <div className="flex items-center space-x-2">
                    <span className={`h-2 w-16 rounded-full ${step >= 1 ? 'bg-blue-600' : 'bg-slate-200'}`}></span>
                    <span className={`h-2 w-16 rounded-full ${step >= 2 ? 'bg-blue-600' : 'bg-slate-200'}`}></span>
                    <span className={`h-2 w-16 rounded-full ${step >= 3 ? 'bg-blue-600' : 'bg-slate-200'}`}></span>
                </div>
            </div>

            <Card className="p-8 min-h-[400px] relative shadow-lg border-blue-100">
                {step === 1 && (
                    <div className="space-y-6 animate-fade-in">
                        <h3 className="text-xl font-bold flex items-center text-slate-700">
                            <span className="bg-blue-100 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm">1</span>
                            Identidad Operativa
                        </h3>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label className="block text-sm font-bold text-slate-700 mb-2">Nombre Comercial</label>
                                <input
                                    type="text"
                                    className="w-full rounded-lg border-slate-300 focus:ring-blue-500"
                                    placeholder="Ej: Repaart Sevilla Este"
                                    value={data.name}
                                    onChange={e => handleChange('name', e.target.value)}
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-bold text-slate-700 mb-2">Ciudad / Zona</label>
                                <input
                                    type="text"
                                    className="w-full rounded-lg border-slate-300 focus:ring-blue-500"
                                    placeholder="Ej: Sevilla"
                                    value={data.city}
                                    onChange={e => handleChange('city', e.target.value)}
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-bold text-slate-700 mb-2">CIF / ID Fiscal</label>
                                <input
                                    type="text"
                                    className="w-full rounded-lg border-slate-300 focus:ring-blue-500"
                                    placeholder="B-12345678"
                                    value={data.taxId}
                                    onChange={e => handleChange('taxId', e.target.value)}
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-bold text-slate-700 mb-2">Email Corporativo</label>
                                <div className="relative">
                                    <Building className="absolute left-3 top-3 text-slate-400 w-4 h-4" />
                                    <input
                                        type="email"
                                        className="w-full pl-10 rounded-lg border-slate-300 focus:ring-blue-500"
                                        placeholder="sevilla@repaart.com"
                                        value={data.email}
                                        onChange={e => handleChange('email', e.target.value)}
                                    />
                                </div>
                            </div>
                        </div>
                    </div>
                )}

                {step === 2 && (
                    <div className="space-y-6 animate-fade-in">
                        <h3 className="text-xl font-bold flex items-center text-slate-700">
                            <span className="bg-blue-100 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm">2</span>
                            Configuraci√≥n Financiera
                        </h3>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div
                                onClick={() => handleChange('tariffPlan', 'standard')}
                                className={`p-4 rounded-xl border-2 cursor-pointer transition-all hover:shadow-md ${data.tariffPlan === 'standard' ? 'border-blue-500 bg-blue-50' : 'border-slate-200'}`}
                            >
                                <div className="flex justify-between items-center mb-2">
                                    <span className="font-bold text-slate-700">Plan Est√°ndar</span>
                                    {data.tariffPlan === 'standard' && <CheckCircle className="w-5 h-5 text-blue-500" />}
                                </div>
                                <p className="text-sm text-slate-500 mb-3">Tarifas base sin descuentos por volumen.</p>
                                <p className="font-bold text-2xl text-slate-800">15% <span className="text-xs font-normal text-slate-400">Royalty</span></p>
                            </div>

                            <div
                                onClick={() => handleChange('tariffPlan', 'premium')}
                                className={`p-4 rounded-xl border-2 cursor-pointer transition-all hover:shadow-md ${data.tariffPlan === 'premium' ? 'border-purple-500 bg-purple-50' : 'border-slate-200'}`}
                            >
                                <div className="flex justify-between items-center mb-2">
                                    <span className="font-bold text-slate-700">Plan Premium</span>
                                    {data.tariffPlan === 'premium' && <CheckCircle className="w-5 h-5 text-purple-500" />}
                                </div>
                                <p className="text-sm text-slate-500 mb-3">Para franquicias con alta proyecci√≥n.</p>
                                <p className="font-bold text-2xl text-slate-800">12% <span className="text-xs font-normal text-slate-400">Royalty (fijo + variable)</span></p>
                            </div>
                        </div>

                        <div className="p-4 bg-slate-50 rounded-lg border border-slate-200 flex items-start gap-3">
                            <CreditCard className="w-5 h-5 text-slate-400 mt-0.5" />
                            <div>
                                <p className="text-sm font-bold text-slate-700">Clonaci√≥n de Tarifas</p>
                                <p className="text-xs text-slate-500">Se copiar√°n autom√°ticamente las 35 tarifas vigentes del modelo {data.tariffPlan === 'standard' ? 'Est√°ndar 2024' : 'Growth 2025'}.</p>
                            </div>
                        </div>
                    </div>
                )}

                {step === 3 && (
                    <div className="space-y-6 animate-fade-in">
                        <h3 className="text-xl font-bold flex items-center text-slate-700">
                            <span className="bg-blue-100 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm">3</span>
                            Seguridad y Acceso
                        </h3>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label className="block text-sm font-bold text-slate-700 mb-2">Nombre del Administrador</label>
                                <input
                                    type="text"
                                    className="w-full rounded-lg border-slate-300 focus:ring-blue-500"
                                    placeholder="Nombre Apellido"
                                    value={data.adminName}
                                    onChange={e => handleChange('adminName', e.target.value)}
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-bold text-slate-700 mb-2">Contrase√±a Temporal</label>
                                <div className="relative">
                                    <Shield className="absolute left-3 top-3 text-slate-400 w-4 h-4" />
                                    <input
                                        type="text"
                                        className="w-full pl-10 rounded-lg border-slate-300 focus:ring-blue-500 font-mono"
                                        placeholder="Generar..."
                                        value={data.adminPassword}
                                        onChange={e => handleChange('adminPassword', e.target.value)}
                                    />
                                </div>
                                <p className="text-xs text-slate-400 mt-1">El usuario deber√° cambiarla en el primer login.</p>
                            </div>
                        </div>

                        <div className="p-4 bg-amber-50 rounded-lg border border-amber-200 text-amber-800 text-sm mt-4">
                            <strong>Resumen de Alta:</strong>
                            <ul className="list-disc list-inside mt-2 space-y-1 text-xs">
                                <li>Franquicia: <strong>{data.name}</strong> ({data.city})</li>
                                <li>ID del Sistema: <strong>{data.email.split('@')[0]}</strong></li>
                                <li>Plan: <strong>{data.tariffPlan.toUpperCase()}</strong></li>
                            </ul>
                        </div>
                    </div>
                )}

                {/* Error Banner */}
                {error && (
                    <div className="absolute bottom-20 left-8 right-8 bg-rose-100 text-rose-600 p-3 rounded-lg text-sm text-center">
                        {error}
                    </div>
                )}

                {/* Footer Controls */}
                <div className="absolute bottom-8 left-8 right-8 flex justify-between items-center border-t border-slate-100 pt-6">
                    {step > 1 ? (
                        <Button variant="ghost" onClick={handleBack} icon={ArrowLeft}>Anterior</Button>
                    ) : (
                        <Button variant="ghost" onClick={onCancel}>Cancelar</Button>
                    )}

                    {step < 3 ? (
                        <Button variant="primary" onClick={handleNext} disabled={!data.name || !data.email}>
                            Siguiente <ChevronRight className="w-4 h-4 ml-2" />
                        </Button>
                    ) : (
                        <Button variant="primary" onClick={handleSubmit} icon={loading ? undefined : Save} disabled={loading}>
                            {loading ? 'Creando Franquicia...' : 'Finalizar Alta'}
                        </Button>
                    )}
                </div>
            </Card>
        </div>
    );
};

export default FranchiseOnboarding;



================================================================================
FILE: src\components\FranchiseScorecard.jsx
================================================================================
import React from 'react';
import {
    Radar, RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, ResponsiveContainer,
    BarChart, Bar, XAxis, YAxis, Tooltip, Cell
} from 'recharts';
import { X, TrendingUp, AlertTriangle, CheckCircle, Target, Users } from 'lucide-react';

const FranchiseScorecard = ({ franchise, globalStats, onClose }) => {
    if (!franchise) return null;

    // --- DATA NORMALIZATION FOR RADAR ---
    // We normalize everything to a 0-100 scale where 100 is "Best in Class" (approx) 
    // or relative to the global max/average depending on the metric.
    // For simplicity, we'll use a relative scale against a theoretical "Target" which is 1.5x the average.

    const getScore = (val, max) => Math.min(100, Math.max(0, (val / (max || 1)) * 100));

    // Define Baselines (using global totals / count could work, or hardcoded targets)
    // We'll try to infer reasonable maxes from globalStats if possible, or use reasonable defaults.
    const avgRevenue = globalStats.totalRevenue / (globalStats.franchiseCount || 1);
    const targetRevenue = avgRevenue * 1.5 || 20000;

    const avgProfit = globalStats.totalProfit / (globalStats.franchiseCount || 1);
    const targetProfit = avgProfit * 1.5 || 5000;

    // Efficiency: Lower labor ratio is better. 
    // Score = 100 - (Ratio - Ideal) * factor? Let's simplify: 
    // Best is 40%, Worst is 80%. 
    const laborScore = (ratio) => {
        if (!ratio) return 0;
        // Map 40% -> 100, 80% -> 0
        return Math.max(0, Math.min(100, 100 - ((ratio - 40) * 2.5)));
    };

    // Quality: Lower incidents is better.
    // Best 0%, Worst 5%.
    const qualityScore = (ratio) => {
        if (ratio === undefined) return 100;
        // Map 0% -> 100, 5% -> 0
        return Math.max(0, Math.min(100, 100 - (ratio * 20)));
    };

    const radarData = [
        { subject: 'Ventas', A: getScore(franchise.metrics.revenue, targetRevenue), fullMark: 100 },
        { subject: 'Beneficio', A: getScore(franchise.metrics.profit, targetProfit), fullMark: 100 },
        { subject: 'Eficiencia', A: laborScore(franchise.metrics.laborRatio), fullMark: 100 },
        { subject: 'Calidad', A: qualityScore(franchise.metrics.incidentRatio), fullMark: 100 },
        { subject: 'Crecimiento', A: getScore(franchise.metrics.orders, 1000), fullMark: 100 }, // Assuming 1000 orders is great
    ];

    // --- SAFETY ZONE CALC ---
    const safetyMargin = franchise.metrics.safetyMargin || 0;
    let safetyColor = 'text-rose-500';
    let safetyLabel = 'PELIGRO';
    if (safetyMargin > 15) { safetyColor = 'text-amber-500'; safetyLabel = 'ALERTA'; }
    if (safetyMargin > 30) { safetyColor = 'text-emerald-500'; safetyLabel = 'SEGURO'; }


    return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-sm animate-fade-in">
            <div className="bg-white w-full max-w-4xl rounded-2xl shadow-2xl overflow-hidden animate-scale-up border border-slate-200">

                {/* HEADER */}
                <div className="bg-gradient-to-r from-slate-900 to-indigo-900 p-6 flex justify-between items-start text-white">
                    <div>
                        <h2 className="text-2xl font-bold flex items-center">
                            <span className="bg-white/20 p-2 rounded-lg mr-3 text-2xl">üè¢</span>
                            {franchise.name}
                        </h2>
                        <p className="text-indigo-200 mt-1 pl-14 opacity-80">{franchise.email}</p>
                    </div>
                    <button onClick={onClose} className="bg-white/10 hover:bg-white/20 p-2 rounded-full transition text-white">
                        <X className="w-6 h-6" />
                    </button>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-3">

                    {/* LEFT: RADAR CHART */}
                    <div className="col-span-1 bg-slate-50 p-6 border-r border-slate-100 flex flex-col items-center justify-center relative">
                        <h3 className="font-bold text-slate-700 mb-2 absolute top-6 left-6 flex items-center">
                            <Target className="w-4 h-4 mr-2 text-indigo-500" /> Puntuaci√≥n 360¬∫
                        </h3>
                        <div className="w-full h-64">
                            <ResponsiveContainer width="100%" height="100%">
                                <RadarChart cx="50%" cy="50%" outerRadius="60%" data={radarData} margin={{ top: 20, right: 30, bottom: 20, left: 30 }}>
                                    <PolarGrid stroke="#e2e8f0" />
                                    <PolarAngleAxis dataKey="subject" tick={{ fill: '#64748b', fontSize: 11, fontWeight: 'bold' }} />
                                    <PolarRadiusAxis angle={30} domain={[0, 100]} tick={false} axisLine={false} />
                                    <Radar
                                        name={franchise.name}
                                        dataKey="A"
                                        stroke="#6366f1"
                                        strokeWidth={3}
                                        fill="#818cf8"
                                        fillOpacity={0.4}
                                    />
                                </RadarChart>
                            </ResponsiveContainer>
                        </div>
                        <div className="text-center mt-4">
                            <p className="text-xs text-slate-400 uppercase tracking-widest font-bold">Nota Global</p>
                            <p className="text-3xl font-black text-indigo-600">
                                {(radarData.reduce((acc, curr) => acc + curr.A, 0) / 5).toFixed(1)}
                                <span className="text-sm font-normal text-slate-400">/100</span>
                            </p>
                        </div>
                    </div>

                    {/* RIGHT: METRICS GRID */}
                    <div className="col-span-2 p-8 space-y-8">

                        {/* 1. SAFETY GAUGE */}
                        <div className="mb-8">
                            <div className="flex justify-between items-end mb-2">
                                <h4 className="font-bold text-slate-700">Zona de Seguridad (Break-even)</h4>
                                <span className={`font-black ${safetyColor}`}>{safetyMargin.toFixed(1)}% ({safetyLabel})</span>
                            </div>
                            <div className="w-full bg-slate-200 h-4 rounded-full overflow-hidden">
                                <div
                                    className={`h-full transition-all duration-1000 ease-out ${safetyMargin > 30 ? 'bg-emerald-500' : safetyMargin > 15 ? 'bg-amber-400' : 'bg-rose-500'}`}
                                    style={{ width: `${Math.min(100, Math.max(0, safetyMargin))}%` }}
                                ></div>
                            </div>
                            <p className="text-xs text-slate-400 mt-2">
                                Margen de ca√≠da de pedidos permitida antes de entrar en p√©rdidas.
                            </p>
                        </div>

                        {/* 2. KEY METRIC CARDS */}
                        <div className="grid grid-cols-2 gap-4">
                            <div className="bg-white border border-slate-100 shadow-sm rounded-xl p-4 hover:shadow-md transition-shadow">
                                <p className="text-xs font-bold text-slate-400 uppercase">Eficiencia Laboral</p>
                                <div className="flex items-end justify-between mt-1">
                                    <p className="text-2xl font-bold text-slate-800">{franchise.metrics.laborRatio.toFixed(1)}%</p>
                                    <Users className={`w-5 h-5 ${franchise.metrics.laborRatio < 60 ? 'text-emerald-500' : 'text-amber-500'}`} />
                                </div>
                                <p className="text-xs text-slate-400 mt-1">Objetivo: &lt;60%</p>
                            </div>

                            <div className="bg-white border border-slate-100 shadow-sm rounded-xl p-4 hover:shadow-md transition-shadow">
                                <p className="text-xs font-bold text-slate-400 uppercase">Beneficio Neto</p>
                                <div className="flex items-end justify-between mt-1">
                                    <p className={`text-2xl font-bold ${franchise.metrics.profit >= 0 ? 'text-emerald-600' : 'text-rose-600'}`}>
                                        {franchise.metrics.profit.toFixed(0)}‚Ç¨
                                    </p>
                                    <TrendingUp className="w-5 h-5 text-indigo-500" />
                                </div>
                                <p className="text-xs text-slate-400 mt-1">Margen: {franchise.metrics.margin.toFixed(1)}%</p>
                            </div>
                        </div>

                        {/* 3. COMPARISON MODULE (New Phase 7) */}
                        <div className="bg-white border border-slate-100 shadow-sm rounded-xl p-6">
                            <h4 className="font-bold text-slate-700 mb-4 flex items-center">
                                <Users className="w-4 h-4 mr-2 text-indigo-500" /> Comparativa con la Red
                            </h4>
                            <div className="h-48 w-full">
                                <ResponsiveContainer width="100%" height="100%">
                                    <BarChart
                                        data={[
                                            {
                                                name: 'Margen (%)',
                                                Franquicia: franchise.metrics.margin,
                                                Red: globalStats.margin, // Global Avg Margin
                                            },
                                            {
                                                name: 'Laboral (%)',
                                                Franquicia: franchise.metrics.laborRatio,
                                                Red: globalStats.powerMetrics.avgLaborRatio,
                                            },
                                            {
                                                name: 'Ticket Medio (‚Ç¨)',
                                                Franquicia: franchise.metrics.revenue / franchise.metrics.orders,
                                                Red: globalStats.totalRevenue / globalStats.totalOrders,
                                            }
                                        ]}
                                        margin={{ top: 20, right: 30, left: 20, bottom: 5 }}
                                    >
                                        <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                        <XAxis dataKey="name" tick={{ fontSize: 11, fontWeight: 'bold' }} />
                                        <YAxis />
                                        <Tooltip
                                            contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)' }}
                                            cursor={{ fill: '#f8fafc' }}
                                        />
                                        <Bar dataKey="Franquicia" fill="#6366f1" radius={[4, 4, 0, 0]} barSize={30} />
                                        <Bar dataKey="Red" fill="#cbd5e1" radius={[4, 4, 0, 0]} barSize={30} />
                                        <Legend />
                                    </BarChart>
                                </ResponsiveContainer>
                            </div>
                            <p className="text-xs text-center text-slate-400 mt-2">
                                Azul: {franchise.name} | Gris: Promedio Global
                            </p>
                        </div>

                        {/* RECOMMENDATION */}
                        <div className="bg-indigo-50 border border-indigo-100 rounded-xl p-4 flex items-start">
                            <CheckCircle className="w-5 h-5 text-indigo-600 mr-3 mt-0.5 flex-shrink-0" />
                            <div>
                                <h4 className="font-bold text-indigo-900 text-sm">Diagn√≥stico IA</h4>
                                <p className="text-sm text-indigo-700 mt-1 leading-relaxed">
                                    {franchise.metrics.profit < 0
                                        ? "‚ö†Ô∏è PRIORIDAD: La franquicia pierde dinero. Revisar estructura de costes fijos o aumentar volumen urgentemente. Riesgo financiero alto."
                                        : franchise.metrics.laborRatio > 65
                                            ? "‚ö†Ô∏è ALERTA: Exceso de personal. El ratio laboral supera el 65%. Revisar horas de riders o eficiencia de repartos."
                                            : franchise.metrics.margin < 10
                                                ? "‚ÑπÔ∏è OK PERO BAJO MARGEN: Operativa rentable pero vulnerable. Enfocarse en subir ticket medio."
                                                : "‚úÖ EXCELENTE: La franquicia opera con m√©tricas saludables y alta eficiencia. Modelo a replicar."
                                    }
                                </p>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    );
};

export default FranchiseScorecard;



================================================================================
FILE: src\components\GamificationWidget.jsx
================================================================================
import React from 'react';
import { Trophy, TrendingUp, Award, Star } from 'lucide-react';
import { formatMoney } from '../lib/finance';

const GamificationWidget = ({ revenue }) => {
    // SIMULATED RANKING LOGIC FOR MVP
    // In production, this would come from the backend comparison.

    // Determine Tier based on Revenue
    let tier = 'BRONCE';
    let color = 'text-amber-700 bg-amber-100 border-amber-200';
    let icon = Award;
    let percentile = 65; // Top 65%

    if (revenue > 15000) {
        tier = 'PLATA';
        color = 'text-slate-500 bg-slate-100 border-slate-200';
        icon = Star;
        percentile = 35; // Top 35%
    }

    if (revenue > 25000) {
        tier = 'ORO';
        color = 'text-yellow-600 bg-yellow-100 border-yellow-200';
        icon = Trophy;
        percentile = 8; // Top 8%
    }

    return (
        <div className="bg-white rounded-2xl p-6 border border-slate-200 shadow-xl shadow-indigo-100/50 relative overflow-hidden mb-6 flex items-center justify-between">
            {/* Background Decoration */}
            <div className="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-indigo-50 to-transparent rounded-bl-full -mr-10 -mt-10 opacity-50"></div>

            <div className="flex items-center gap-6 relative z-10">
                <div className={`w-16 h-16 rounded-2xl flex items-center justify-center border-4 ${color} shadow-sm`}>
                    {React.createElement(icon, { className: "w-8 h-8" })}
                </div>

                <div>
                    <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-1">
                        Tu Posici√≥n Mensual
                    </h3>
                    <div className="flex items-baseline gap-2">
                        <span className="text-3xl font-black text-slate-800">{tier}</span>
                        <span className="text-sm font-bold text-emerald-500 bg-emerald-50 px-2 py-0.5 rounded-full border border-emerald-100">
                            Top {percentile}%
                        </span>
                    </div>
                    <p className="text-xs text-slate-400 mt-1 font-medium">
                        ¬°Est√°s facturando m√°s que el {100 - percentile}% de la red!
                    </p>
                </div>
            </div>

            <div className="hidden md:block text-right relative z-10">
                <div className="flex flex-col items-end">
                    <span className="text-xs font-bold text-slate-400 uppercase">Siguiente Nivel</span>
                    {tier === 'ORO' ? (
                        <span className="text-indigo-600 font-bold text-sm">¬°Eres el L√≠der! üëë</span>
                    ) : (
                        <div className="flex items-center gap-2 mt-1">
                            <span className="text-sm font-bold text-slate-600">
                                +{formatMoney(tier === 'BRONCE' ? 15000 - revenue : 25000 - revenue)}‚Ç¨
                            </span>
                            <span className="text-xs text-slate-400">para subir</span>
                        </div>
                    )}
                </div>
                {/* Progress Bar */}
                {tier !== 'ORO' && (
                    <div className="w-32 h-2 bg-slate-100 rounded-full mt-2 overflow-hidden">
                        <div
                            className="h-full bg-indigo-500 rounded-full"
                            style={{ width: `${(revenue / (tier === 'BRONCE' ? 15000 : 25000)) * 100}%` }}
                        ></div>
                    </div>
                )}
            </div>
        </div>
    );
};

export default GamificationWidget;



================================================================================
FILE: src\components\GenesisSeeder.jsx
================================================================================
import React, { useState } from 'react';
import { db, auth } from '../lib/firebase';
import { writeBatch, collection, doc, Timestamp, setDoc } from 'firebase/firestore';

const GenesisSeeder = () => {
    const [loading, setLoading] = useState(false);

    const makeMeAdmin = async () => {
        if (!auth.currentUser) {
            alert("‚ùå Debes estar logueado primero.");
            return;
        }

        const uid = auth.currentUser.uid;
        const email = auth.currentUser.email;

        if (!window.confirm(`¬øConvertir a ${email} en ADMIN supremo?`)) return;

        try {
            setLoading(true);

            // 1. Configuraci√≥n de Seguridad
            await setDoc(doc(db, "users_config", uid), {
                role: 'admin',
                franchiseId: null, // Admin global
                email: email,
                status: 'active'
            }, { merge: true });

            // 2. Perfil P√∫blico
            await setDoc(doc(db, "users", uid), {
                role: 'admin',
                status: 'active',
                email: email,
                displayName: auth.currentUser.displayName || email.split('@')[0],
                updatedAt: Timestamp.now()
            }, { merge: true });

            alert(`üëë ¬°Larga vida al Rey! ${email} ahora es ADMIN.`);
            window.location.reload(); // Para refrescar permisos

        } catch (e) {
            console.error(e);
            alert("Error: " + e.message);
        } finally {
            setLoading(false);
        }
    };

    const seedData = async () => {
        if (!window.confirm("‚ö†Ô∏è ¬øSeguro? Esto inyectar√° datos falsos en tu Base de Datos.")) return;

        setLoading(true);
        const batch = writeBatch(db);

        try {
            // 1. FRANQUICIAS
            const franchiseRef = collection(db, 'franchises');
            const franchises = [
                { name: 'Central Madrid', location: 'Madrid', status: 'active', revenue: 120000 },
                { name: 'Delegaci√≥n Norte', location: 'Barcelona', status: 'active', revenue: 85000 },
                { name: 'Levante Express', location: 'Valencia', status: 'active', revenue: 62000 },
                { name: 'Sur Logistics', location: 'Sevilla', status: 'warning', revenue: 41000 }
            ];

            franchises.forEach(f => {
                const docRef = doc(franchiseRef); // ID autom√°tico
                batch.set(docRef, { ...f, createdAt: Timestamp.now() });
            });

            // 2. VEH√çCULOS (FLOTA)
            const vehicleRef = collection(db, 'vehicles');
            const types = ['Furgoneta', 'Moto', 'Cami√≥n Ligero'];
            const statuses = ['active', 'active', 'active', 'maintenance', 'stopped'];

            for (let i = 1; i <= 15; i++) {
                const docRef = doc(vehicleRef);
                batch.set(docRef, {
                    plate: `${Math.floor(1000 + Math.random() * 9000)}-LZ${String.fromCharCode(65 + i)}`,
                    model: 'Renault Kangoo',
                    type: types[Math.floor(Math.random() * types.length)],
                    status: statuses[Math.floor(Math.random() * statuses.length)],
                    mileage: Math.floor(Math.random() * 150000),
                    nextRevision: Timestamp.fromDate(new Date(2025, Math.floor(Math.random() * 11), 1))
                });
            }

            // 3. DATOS FINANCIEROS (√öltimos 6 meses)
            const financeRef = collection(db, 'financial_data');
            const months = ['2025-07', '2025-08', '2025-09', '2025-10', '2025-11', '2025-12'];

            months.forEach((monthId, index) => {
                const docRef = doc(financeRef, monthId); // Usamos el mes como ID
                const revenue = 45000 + (index * 2500) + Math.random() * 5000;
                const expenses = 20000 + (index * 1000) + Math.random() * 2000;

                batch.set(docRef, {
                    month: monthId,
                    revenue: Math.round(revenue),
                    expenses: Math.round(expenses),
                    profit: Math.round(revenue - expenses),
                    activeVehicles: 12 + Math.floor(Math.random() * 5),
                    timestamp: Timestamp.now()
                });
            });

            // 4. TURNOS (SHIFTS)
            const shiftRef = collection(db, 'shifts');
            for (let i = 0; i < 20; i++) {
                const docRef = doc(shiftRef);
                batch.set(docRef, {
                    driverName: `Conductor ${i + 1}`,
                    vehicleId: 'Simulado',
                    startTime: Timestamp.fromDate(new Date(2025, 11, 20 + i, 8, 0)),
                    endTime: Timestamp.fromDate(new Date(2025, 11, 20 + i, 16, 0)),
                    status: i % 2 === 0 ? 'completed' : 'scheduled'
                });
            }

            await batch.commit();
            alert("‚úÖ ¬°G√âNESIS COMPLETADO! La base de datos ha revivido.");
            window.location.reload();

        } catch (error) {
            console.error("Error en G√©nesis:", error);
            alert("‚ùå Error: " + error.message);
        } finally {
            setLoading(false);
        }
    };

    return (
        <div style={{
            position: 'fixed', top: '20px', right: '20px', zIndex: 99999,
            background: 'white', padding: '20px', border: '4px solid red', borderRadius: '10px',
            boxShadow: '0 0 50px rgba(0,0,0,0.8)', display: 'flex', flexDirection: 'column', gap: '10px'
        }}>
            <h3 style={{ color: 'red', margin: '0', textAlign: 'center' }}>‚ò¢Ô∏è ZONA PELIGRO</h3>

            <button
                onClick={makeMeAdmin}
                disabled={loading}
                style={{
                    background: '#2563eb', color: 'white', padding: '10px',
                    border: 'none', borderRadius: '5px', cursor: 'pointer', fontWeight: 'bold'
                }}
            >
                üëë HACERME ADMIN
            </button>

            <button
                onClick={seedData}
                disabled={loading}
                style={{
                    background: 'red', color: 'white', padding: '10px',
                    border: 'none', borderRadius: '5px', cursor: 'pointer', fontWeight: 'bold'
                }}
            >
                üöÄ EJECUTAR G√âNESIS
            </button>
        </div>
    );
};

export default GenesisSeeder;



================================================================================
FILE: src\components\Header.jsx
================================================================================
import React from 'react';
import { Menu, LogOut, Download, Printer, Save, MapPin, Calendar, Activity, LifeBuoy, Settings, Users, ShieldAlert, FileText, ChevronRight, Megaphone, GraduationCap, Calculator } from 'lucide-react';
import logo from '../assets/logo.jpg';
import Button from './ui/Button';
import Notifications from './Notifications';
import UserMenu from './UserMenu';
import ThemeToggle from './ThemeToggle';

const Header = ({
    user,
    isAdmin,
    isFranchise,
    viewMode,
    setViewMode,
    franchiseView,
    setFranchiseView,
    isSidebarOpen,
    setIsSidebarOpen,
    selectedMonth,
    viewPeriod,
    setViewPeriod,
    targetFranchiseName,
    saving,
    onLogout,
    onExport,
    onPrint,
    onMonthChange
}) => {

    const getBreadcrumbs = () => {
        const crumbs = [];

        // Root Level
        if (isAdmin) {
            crumbs.push({ label: 'Central', active: viewMode === 'dashboard', onClick: () => setViewMode('dashboard') });
        } else {
            crumbs.push({ label: 'Mi Negocio', active: false, onClick: null });
        }

        // Second Level
        if (isAdmin) {
            if (viewMode === 'franchise_detail') crumbs.push({ label: targetFranchiseName || 'Franquicia', active: true });
            if (viewMode === 'users') crumbs.push({ label: 'Usuarios', active: true });

            if (viewMode === 'resources') crumbs.push({ label: 'Recursos', active: true });
            if (viewMode === 'support') crumbs.push({ label: 'Soporte', active: true });
            if (viewMode === 'audit') crumbs.push({ label: 'Auditor√≠a', active: true });
            if (viewMode === 'profile') crumbs.push({ label: 'Configuraci√≥n', active: true });
        } else if (isFranchise) {
            if (franchiseView === 'cockpit') crumbs.push({ label: 'Finanzas', active: true });


            if (franchiseView === 'support') crumbs.push({ label: 'Soporte', active: true });
            if (franchiseView === 'resources') crumbs.push({ label: 'Recursos', active: true });
        }

        return crumbs;
    };

    const getTitle = () => {
        if (isAdmin && viewMode === 'dashboard') return 'Control Central';
        if (isAdmin && viewMode === 'franchise_detail') return targetFranchiseName || 'Detalle Franquicia';
        if (isAdmin && viewMode === 'support') return 'Centro de Soporte';
        if (isAdmin && viewMode === 'setup') return 'Configuraci√≥n';
        if (isAdmin && viewMode === 'profile') return 'Perfil y Ajustes';
        if (isAdmin && viewMode === 'audit') return 'Auditor√≠a de Seguridad';
        if (isAdmin && viewMode === 'communications') return 'Centro de Comunicaci√≥n';
        if (isAdmin && viewMode === 'resources') return 'Gestor de Recursos';

        if (isAdmin && viewMode === 'users') return 'Gesti√≥n de Equipos';
        if (isAdmin && viewMode === 'academy') return 'Academia Repaart';


        if (isFranchise && franchiseView === 'support') return 'Centro de Ayuda';
        if (isFranchise && franchiseView === 'resources') return 'Centro de Recursos';
        if (isFranchise && franchiseView === 'academy') return 'Academia';
        return 'Financial Cockpit';
    };

    return (
        <header className="bg-white/90 ios-blur border-b border-slate-200/50 py-3 md:py-0 md:h-24 flex flex-col md:flex-row items-center justify-between px-4 md:px-8 sticky top-0 z-10 ios-shadow animate-fade-in-down w-full shrink-0 safe-top">
            <div className="flex items-center w-full md:w-auto justify-between md:justify-start">
                <div className="flex items-center">
                    {/* Sidebar Toggle for Financials View */}
                    {((isAdmin && viewMode === 'franchise_detail') || (isFranchise && franchiseView === 'cockpit')) && (
                        <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="p-2.5 rounded-md hover:bg-slate-100 mr-2 md:mr-6 focus:outline-none transition-colors min-w-[44px] min-h-[44px] flex items-center justify-center">
                            <Menu className="w-6 h-6 text-slate-600" />
                        </button>
                    )}
                    <img src={logo} alt="REPAART" className="h-10 md:h-16 w-auto mr-4" />
                </div>

                {/* Mobile Title & Period - Optimized for Touch */}
                <div className="flex md:hidden items-center gap-3">
                    {/* Month/Year Input - VISIBLE & STYLED FOR BETTER MOBILE SUPPORT */}
                    {((isAdmin && (viewMode === 'franchise_detail' || viewMode === 'dashboard')) || (isFranchise && franchiseView === 'cockpit')) && (
                        <div className="relative bg-blue-50 rounded-lg border border-blue-100 shadow-sm overflow-hidden min-w-[140px]">
                            <div className="flex items-center gap-2 px-4 py-2.5 pointer-events-none absolute inset-0 z-10">
                                <Calendar className="w-4 h-4 text-blue-600 flex-shrink-0" />
                                <span className="text-sm font-bold text-blue-700">
                                    {viewPeriod === 'year' ? selectedMonth.split('-')[0] : selectedMonth}
                                </span>
                            </div>
                            {/* Styled visible input - NATIVE MOBILE PICKER */}
                            <input
                                type={viewPeriod === 'year' ? "number" : "month"}
                                value={selectedMonth}
                                onChange={(e) => onMonthChange && onMonthChange(e.target.value)}
                                className="w-full h-full opacity-0 relative z-20 cursor-pointer"
                                style={{ minHeight: '44px', minWidth: '140px' }}
                                aria-label="Cambiar fecha"
                            />
                        </div>
                    )}

                    {/* Period Toggle - Segmented Control (Mobile) */}
                    {((isAdmin && (viewMode === 'franchise_detail' || viewMode === 'dashboard')) || (isFranchise && franchiseView === 'cockpit')) && (
                        <div className="flex bg-slate-100/80 p-0.5 rounded-lg border border-slate-200/50">
                            {[
                                { id: 'month', label: 'MES' },
                                { id: 'year', label: 'A√ëO' }
                            ].map((opt) => (
                                <button
                                    key={opt.id}
                                    onClick={() => setViewPeriod && setViewPeriod(opt.id)}
                                    className={`relative px-3 py-1.5 text-[10px] font-bold rounded-md transition-all duration-200 ${viewPeriod === opt.id
                                        ? 'bg-white text-blue-600 shadow-sm ring-1 ring-black/5'
                                        : 'text-slate-400 hover:text-slate-600'
                                        }`}
                                >
                                    {opt.label}
                                </button>
                            ))}
                        </div>
                    )}

                    {saving && (
                        <div className="ml-1">
                            <Save className="w-5 h-5 text-emerald-500 animate-pulse" />
                        </div>
                    )}

                    <button onClick={onLogout} className="p-3 text-slate-400 hover:text-rose-500 hover:bg-rose-50 rounded-full transition-colors active:scale-95 touch-manipulation min-w-[44px] min-h-[44px] flex items-center justify-center">
                        <LogOut className="w-5 h-5" />
                    </button>
                </div>
            </div>

            {/* Desktop Title & Info */}
            <div className="hidden md:block border-l pl-6 border-slate-300">
                <div className="flex flex-col">
                    <div className="flex items-center space-x-2">
                        <h1 className="text-2xl font-bold text-slate-800 tracking-tight">
                            {getTitle()}
                        </h1>
                        {isAdmin && <span className="bg-slate-800 text-white text-[10px] font-bold px-2 py-0.5 rounded uppercase tracking-wider">ADMIN</span>}
                    </div>
                    {/* Breadcrumbs */}
                    <div className="flex items-center mt-1 space-x-1">
                        {getBreadcrumbs().map((crumb, index) => (
                            <React.Fragment key={index}>
                                {index > 0 && <ChevronRight className="w-3.5 h-3.5 text-slate-400" />}
                                <button
                                    onClick={crumb.onClick}
                                    disabled={!crumb.onClick}
                                    className={`text-xs font-medium transition-colors ${crumb.active || !crumb.onClick
                                        ? 'text-slate-500 cursor-default'
                                        : 'text-blue-600 hover:text-blue-800 hover:underline'
                                        }`}
                                >
                                    {crumb.label}
                                </button>
                            </React.Fragment>
                        ))}
                    </div>
                </div>

                <div className="flex items-center space-x-3 mt-1">
                    {isAdmin && viewMode === 'franchise_detail' && (
                        <p className="text-xs text-blue-600 font-bold flex items-center uppercase tracking-widest bg-blue-50 px-2 py-0.5 rounded border border-blue-100">
                            <MapPin className="w-3 h-3 mr-1" /> {targetFranchiseName}
                        </p>
                    )}

                    {/* DATE & PERIOD SELECTOR - Desktop Segmented Control */}
                    {((isAdmin && (viewMode === 'franchise_detail' || viewMode === 'dashboard')) || (isFranchise && franchiseView === 'cockpit')) && (
                        <div className="flex bg-slate-100/80 p-0.5 rounded-lg border border-slate-200/50 ml-2">
                            {[
                                { id: 'month', label: 'MES' },
                                { id: 'year', label: 'A√ëO' }
                            ].map((opt) => (
                                <button
                                    key={opt.id}
                                    onClick={() => setViewPeriod && setViewPeriod(opt.id)}
                                    className={`relative px-2.5 py-1 text-[10px] font-bold rounded-md transition-all duration-200 ${viewPeriod === opt.id
                                        ? 'bg-white text-blue-600 shadow-sm ring-1 ring-black/5'
                                        : 'text-slate-400 hover:text-slate-600'
                                        }`}
                                >
                                    {opt.label}
                                </button>
                            ))}
                        </div>
                    )}

                    {((isAdmin && (viewMode === 'franchise_detail' || viewMode === 'dashboard')) || (isFranchise && franchiseView === 'cockpit')) && (
                        <div className="relative group cursor-pointer">
                            <p className="text-xs text-blue-600 font-bold flex items-center uppercase tracking-widest bg-blue-50 group-hover:bg-blue-100 transition-colors px-2 py-0.5 rounded border border-transparent group-hover:border-blue-200">
                                <Calendar className="w-3 h-3 mr-1" /> {viewPeriod === 'year' ? selectedMonth.split('-')[0] : selectedMonth}
                            </p>
                            <input
                                type={viewPeriod === 'year' ? "number" : "month"}
                                value={selectedMonth}
                                onChange={(e) => onMonthChange && onMonthChange(e.target.value)}
                                className="absolute inset-0 opacity-0 w-full h-full cursor-pointer"
                                aria-label="Cambiar fecha"
                            />
                        </div>
                    )}

                    {saving && (
                        <p className="text-xs text-emerald-500 font-bold flex items-center animate-pulse">
                            <Save className="w-3 h-3 mr-1" /> Guardando...
                        </p>
                    )}
                </div>
            </div>

            {/* Desktop Navigation */}
            <div className="hidden md:flex items-center space-x-3">
                {/* FRANCHISEE NAVIGATION */}
                {/* FRANCHISEE NAVIGATION - Segmented Control */}
                {isFranchise && (
                    <div className="flex bg-slate-100/80 p-1 rounded-xl border border-slate-200/50 mr-4">
                        {[
                            { id: 'cockpit', label: 'Finanzas' },
                            { id: 'academy', label: 'Academia' },
                            { id: 'resources', label: 'Recursos' },
                            { id: 'support', label: 'Soporte' }
                        ].map((tab) => (
                            <button
                                key={tab.id}
                                onClick={() => setFranchiseView(tab.id)}
                                className={`px-3 py-1.5 rounded-lg text-sm font-bold transition-all duration-200 ${franchiseView === tab.id
                                    ? 'bg-white text-blue-600 shadow-sm ring-1 ring-black/5'
                                    : 'text-slate-500 hover:text-slate-700 hover:bg-white/50'}`}
                            >
                                {tab.label}
                            </button>
                        ))}
                    </div>
                )}

                {/* ADMIN NAVIGATION */}
                {isAdmin && (
                    <div className="flex items-center mr-4 gap-3">
                        {/* Notifications */}
                        <Notifications />

                        <div className="flex items-center bg-slate-100/80 p-1.5 rounded-xl border border-slate-200/50 shadow-inner">
                            {/* Only show Back to Dashboard if not in dashboard */}
                            {viewMode !== 'dashboard' && (
                                <button
                                    onClick={() => { setViewMode('dashboard'); setIsSidebarOpen(false); }}
                                    className="flex items-center px-3 py-2 bg-white text-slate-700 shadow-sm rounded-lg text-xs font-bold uppercase tracking-wider hover:bg-slate-50 transition-all mr-2 ring-1 ring-black/5"
                                >
                                    <Activity className="w-3.5 h-3.5 mr-1.5 text-blue-500" /> Central
                                </button>
                            )}

                            {/* Navigation Group */}
                            <div className="flex items-center gap-1">
                                {[
                                    { id: 'users', icon: Users, label: 'Gesti√≥n de Usuarios', color: 'text-purple-600', activeColor: 'bg-purple-50 text-purple-600' },
                                    { id: 'academy', icon: GraduationCap, label: 'Academia', color: 'text-indigo-600', activeColor: 'bg-indigo-50 text-indigo-600' },
                                    { id: 'resources', icon: FileText, label: 'Gestor de Recursos', color: 'text-amber-600', activeColor: 'bg-amber-50 text-amber-600' },
                                    { id: 'support', icon: LifeBuoy, label: 'Centro de Soporte', color: 'text-emerald-600', activeColor: 'bg-emerald-50 text-emerald-600' },
                                    { id: 'communications', icon: Megaphone, label: 'Comunicados', color: 'text-blue-500', activeColor: 'bg-blue-50 text-blue-500' },
                                    { id: 'audit', icon: ShieldAlert, label: 'Auditor√≠a', color: 'text-rose-600', activeColor: 'bg-rose-50 text-rose-600' },
                                    { id: 'profile', icon: Settings, label: 'Configuraci√≥n', color: 'text-slate-600', activeColor: 'bg-slate-200 text-slate-800' },
                                ].map((item) => (
                                    <button
                                        key={item.id}
                                        onClick={() => setViewMode(item.id)}
                                        className={`group relative p-2 rounded-lg transition-all duration-300 ${viewMode === item.id
                                            ? `bg-white shadow-sm ring-1 ring-black/5 ${item.color}`
                                            : `text-slate-400 hover:text-slate-600 hover:bg-white/60`
                                            }`}
                                    >
                                        <item.icon className={`w-5 h-5 transition-transform duration-300 ${viewMode === item.id ? 'scale-110' : 'group-hover:scale-110'}`} />

                                        {/* Status Dot for Active */}
                                        {viewMode === item.id && (
                                            <span className="absolute bottom-1.5 right-1.5 w-1 h-1 rounded-full bg-current opacity-75"></span>
                                        )}

                                        {/* Tooltip */}
                                        <span className="absolute -bottom-10 left-1/2 transform -translate-x-1/2 px-2 py-1 bg-slate-800 text-white text-[10px] font-bold rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap z-50">
                                            {item.label}
                                            <svg className="absolute text-slate-800 h-2 w-full left-0 bottom-full" x="0px" y="0px" viewBox="0 0 255 255" xmlSpace="preserve"><polygon className="fill-current" points="0,0 127.5,127.5 255,0" /></svg>
                                        </span>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                )}

                {/* ACTIONS */}
                {((isAdmin && viewMode === 'franchise_detail') || (isFranchise && franchiseView === 'cockpit')) && (
                    <>
                        {onExport && (
                            <Button variant="secondary" onClick={onExport} icon={Download} className="shadow-sm transform hover:scale-105">
                                Exportar
                            </Button>
                        )}
                        {onPrint && (
                            <Button variant="primary" onClick={onPrint} icon={Printer} className="shadow-md transform hover:scale-105">
                                Imprimir
                            </Button>
                        )}
                    </>
                )}

                <div className="border-l border-slate-200 pl-3 ml-2 flex items-center gap-2">
                    <ThemeToggle />
                    <UserMenu user={user} setViewMode={setViewMode} onLogout={onLogout} />
                </div>
            </div>

        </header >
    );
};

export default Header;



================================================================================
FILE: src\components\InfoTooltip.jsx
================================================================================
import React from 'react';
import { Info } from 'lucide-react';

const InfoTooltip = ({ text, className = "" }) => (
    <div className={`group relative inline-flex ml-2 z-20 ${className}`}>
        <Info className="w-4 h-4 text-slate-300 hover:text-indigo-500 cursor-help transition-colors" />
        <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 hidden group-hover:block min-w-[200px] max-w-xs bg-slate-800 text-white text-xs p-3 rounded-lg shadow-xl border border-slate-700 pointer-events-none whitespace-normal break-words z-[110]">
            {text}
            <div className="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-slate-800"></div>
        </div>
    </div>
);

export default InfoTooltip;



================================================================================
FILE: src\components\InputForm.jsx
================================================================================
import React, { useState } from 'react';

const InputForm = ({ onCalculate }) => {
    const [formData, setFormData] = useState({
        // Revenue Inputs
        ordersNew0To4: 0,
        ordersNew4To5: 0,
        ordersNew5To6: 0,
        ordersNew6To7: 0,
        ordersNewGt7: 0,
        ordersOld0To35: 0,
        ordersOldGt35: 0,

        // Expense Inputs
        salaries: 0,
        motoCount: 0, // Changed from renting amount to count
        insurance: 0,
        services: 0,
        quota: 0,
        gasoline: 0,
        repairs: 0,
        royaltyPercent: 0, // % of Revenue
    });

    const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData(prev => ({ ...prev, [name]: value }));
    };

    const handleSubmit = (e) => {
        e.preventDefault();
        // Parse all fields to numbers before submitting
        const parsedData = Object.keys(formData).reduce((acc, key) => {
            acc[key] = typeof formData[key] === 'string' ? (parseFloat(formData[key]) || 0) : formData[key];
            return acc;
        }, {});
        onCalculate(parsedData);
    };

    return (
        <form onSubmit={handleSubmit} className="bg-white p-6 rounded-lg shadow-md max-w-4xl mx-auto">
            <h2 className="text-2xl font-bold mb-6 text-gray-800">Datos Financieros de la Franquicia</h2>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">

                {/* Revenue Section */}
                <div>
                    <h3 className="text-lg font-semibold mb-4 text-blue-600 border-b pb-2">Ingresos: Pedidos por Distancia</h3>

                    <div className="mb-4">
                        <h4 className="font-medium text-gray-700 mb-2">Tarifa NUEVA</h4>
                        <div className="grid grid-cols-2 gap-4">
                            <label className="block">
                                <span className="text-sm text-gray-600">0 - 4 km (5,50‚Ç¨)</span>
                                <input type="number" name="ordersNew0To4" value={formData.ordersNew0To4} onChange={handleChange} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 border p-2" min="0" />
                            </label>
                            <label className="block">
                                <span className="text-sm text-gray-600">4,01 - 5 km (6,50‚Ç¨)</span>
                                <input type="number" name="ordersNew4To5" value={formData.ordersNew4To5} onChange={handleChange} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 border p-2" min="0" />
                            </label>
                            <label className="block">
                                <span className="text-sm text-gray-600">5,01 - 6 km (7,50‚Ç¨)</span>
                                <input type="number" name="ordersNew5To6" value={formData.ordersNew5To6} onChange={handleChange} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 border p-2" min="0" />
                            </label>
                            <label className="block">
                                <span className="text-sm text-gray-600">6,01 - 7 km (8,50‚Ç¨)</span>
                                <input type="number" name="ordersNew6To7" value={formData.ordersNew6To7} onChange={handleChange} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 border p-2" min="0" />
                            </label>
                            <label className="block">
                                <span className="text-sm text-gray-600">&gt; 7 km (8,50‚Ç¨)</span>
                                <input type="number" name="ordersNewGt7" value={formData.ordersNewGt7} onChange={handleChange} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 border p-2" min="0" />
                            </label>
                        </div>
                    </div>

                    <div className="mb-4">
                        <h4 className="font-medium text-gray-700 mb-2">Tarifa ANTIGUA</h4>
                        <div className="grid grid-cols-2 gap-4">
                            <label className="block">
                                <span className="text-sm text-gray-600">0 - 3,5 km (5,50‚Ç¨)</span>
                                <input type="number" name="ordersOld0To35" value={formData.ordersOld0To35} onChange={handleChange} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 border p-2" min="0" />
                            </label>
                            <label className="block">
                                <span className="text-sm text-gray-600">&gt; 3,5 km (7,50‚Ç¨)</span>
                                <input type="number" name="ordersOldGt35" value={formData.ordersOldGt35} onChange={handleChange} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 border p-2" min="0" />
                            </label>
                        </div>
                    </div>
                </div>

                {/* Expenses Section */}
                <div>
                    <h3 className="text-lg font-semibold mb-4 text-red-600 border-b pb-2">Gastos Mensuales</h3>
                    <div className="grid grid-cols-1 gap-3">
                        <label className="flex items-center justify-between">
                            <span className="text-sm text-gray-600">Salarios</span>
                            <input type="number" name="salaries" value={formData.salaries} onChange={handleChange} className="ml-2 w-32 rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 border p-2" />
                        </label>
                        <label className="flex items-center justify-between">
                            <div className="flex flex-col">
                                <span className="text-sm text-gray-600">N¬∫ de Motos</span>
                                <span className="text-xs text-gray-400">(x 154‚Ç¨/mes)</span>
                            </div>
                            <input type="number" name="motoCount" value={formData.motoCount} onChange={handleChange} className="ml-2 w-32 rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 border p-2" />
                        </label>
                        <label className="flex items-center justify-between">
                            <span className="text-sm text-gray-600">Gasolina</span>
                            <input type="number" name="gasoline" value={formData.gasoline} onChange={handleChange} className="ml-2 w-32 rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 border p-2" />
                        </label>
                        <label className="flex items-center justify-between">
                            <span className="text-sm text-gray-600">Reparaciones</span>
                            <input type="number" name="repairs" value={formData.repairs} onChange={handleChange} className="ml-2 w-32 rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 border p-2" />
                        </label>
                        <label className="flex items-center justify-between">
                            <span className="text-sm text-gray-600">Servicios Prof.</span>
                            <input type="number" name="services" value={formData.services} onChange={handleChange} className="ml-2 w-32 rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 border p-2" />
                        </label>
                        <label className="flex items-center justify-between">
                            <span className="text-sm text-gray-600">Cuota Aut√≥nomo</span>
                            <input type="number" name="quota" value={formData.quota} onChange={handleChange} className="ml-2 w-32 rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 border p-2" />
                        </label>
                        <label className="flex items-center justify-between">
                            <span className="text-sm text-gray-600">Seguros</span>
                            <input type="number" name="insurance" value={formData.insurance} onChange={handleChange} className="ml-2 w-32 rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 border p-2" />
                        </label>
                        <label className="flex items-center justify-between">
                            <span className="text-sm text-gray-600">Royalty (%)</span>
                            <input type="number" name="royaltyPercent" value={formData.royaltyPercent} onChange={handleChange} className="ml-2 w-32 rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 border p-2" step="0.1" />
                        </label>
                    </div>
                </div>
            </div>

            <div className="mt-8 flex justify-center">
                <button type="submit" className="px-6 py-3 bg-blue-600 text-white font-bold rounded-full hover:bg-blue-700 transition shadow-lg transform hover:scale-105">
                    Generar Reporte
                </button>
            </div>
        </form>
    );
};

export default InputForm;



================================================================================
FILE: src\components\InputSidebar.jsx
================================================================================
import React, { useState, useEffect } from 'react';
import { Settings, CreditCard, Truck, Users, Landmark, Calendar, MapPin, Fuel, Lock, Activity, Sparkles } from 'lucide-react';

const InputSidebar = ({ isOpen, onClose, onCalculate, initialData, selectedMonth, onMonthChange, readOnly = false, onToggleChat }) => {
    const [formData, setFormData] = useState(initialData || {});

    useEffect(() => {
        const timer = setTimeout(() => {
            setFormData(initialData || {});
        }, 0);
        return () => clearTimeout(timer);
    }, [initialData]);

    const handleChange = (e) => {
        if (readOnly) return; // Block changes
        const { name, value } = e.target;
        // Allow string update to support typing decimals (e.g. "10.")
        setFormData(prev => ({ ...prev, [name]: value }));
    };

    const handleApply = () => {
        if (readOnly) return;

        // Parse all fields to numbers before submitting
        const parsedData = Object.keys(formData).reduce((acc, key) => {
            acc[key] = typeof formData[key] === 'string' ? (parseFloat(formData[key]) || 0) : formData[key];
            return acc;
        }, {});

        onCalculate(parsedData);
    };

    // Calculate estimated Km on the fly for display
    const gasoline = formData ? (parseFloat(formData.gasoline) || 0) : 0;
    const gasolinePrice = formData ? (parseFloat(formData.gasolinePrice) || 0) : 0;
    const estimatedKm = gasolinePrice > 0 ? (gasoline / gasolinePrice) * 35 : 0;

    return (
        <div className={`fixed inset-y-0 left-0 w-full md:w-96 bg-slate-900 shadow-2xl transform transition-transform duration-300 ease-in-out z-50 overflow-y-auto ${isOpen ? 'translate-x-0' : '-translate-x-full'}`}>
            <div className="p-6">
                <div className="flex justify-between items-center mb-6 border-b border-slate-700 pb-4">
                    <h2 className="text-xl font-bold text-white flex items-center">
                        <Settings className="w-5 h-5 mr-2 text-blue-400" />
                        Configuraci√≥n
                    </h2>
                    <button onClick={onClose} className="text-slate-400 hover:text-white">‚úï</button>
                </div>

                {/* AI Assistant Button (Mobile/Sidebar Access) */}
                <button
                    onClick={() => {
                        onToggleChat && onToggleChat();
                        onClose(); // Close sidebar on mobile when opening chat
                    }}
                    className="w-full mb-6 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white p-3.5 rounded-xl shadow-lg shadow-blue-900/20 flex items-center justify-center font-bold transition-all active:scale-95 group"
                >
                    <div className="bg-white/20 p-1.5 rounded-lg mr-3 group-hover:rotate-12 transition-transform">
                        <Sparkles className="w-5 h-5 text-white" />
                    </div>
                    <span>Asistente IA</span>
                    <span className="ml-2 flex h-2 w-2 relative">
                        <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                        <span className="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                    </span>
                </button>

                {readOnly && (
                    <div className="mb-6 bg-amber-500/10 border border-amber-500/50 p-3 rounded-lg flex items-center">
                        <Lock className="w-5 h-5 text-amber-500 mr-2 flex-shrink-0" />
                        <p className="text-xs text-amber-200">
                            <span className="font-bold block">Modo Solo Lectura</span>
                            Solo el Administrador puede editar los datos.
                        </p>
                    </div>
                )}

                {/* Month Selector - IMPROVED UX */}
                <div className="mb-8 bg-gradient-to-br from-blue-900/50 to-indigo-900/50 p-1 rounded-xl border border-blue-500/30 shadow-lg">
                    <div className="bg-slate-900/80 rounded-lg p-4">
                        <label className="text-xs font-bold text-blue-300 uppercase tracking-wider flex items-center mb-3">
                            <Calendar className="w-5 h-5 mr-2 text-blue-400" /> Periodo Fiscal
                        </label>
                        <div className="relative">
                            <input
                                type="month"
                                value={selectedMonth}
                                onChange={(e) => onMonthChange(e.target.value)}
                                className="w-full bg-slate-800 border border-slate-600 text-white text-lg font-bold rounded-xl px-4 py-4 focus:ring-2 focus:ring-blue-500 outline-none transition-all hover:bg-slate-700 cursor-pointer"
                            />
                            <div className="absolute right-4 top-1/2 transform -translate-y-1/2 pointer-events-none">
                                <Calendar className="w-6 h-6 text-slate-400 opacity-50" />
                            </div>
                        </div>
                        <p className="text-[10px] text-slate-400 mt-2 text-center">
                            Pulsa para cambiar el mes del reporte
                        </p>
                    </div>
                </div>

                <div className={`space-y-8 ${readOnly ? 'opacity-80 pointer-events-none grayscale-[0.3]' : ''}`}>
                    {/* Section: Pedidos */}
                    <div className="space-y-4">
                        <h3 className="text-sm font-semibold text-blue-400 uppercase tracking-wider flex items-center">
                            <Truck className="w-4 h-4 mr-2" /> Pedidos (Tarifas)
                        </h3>

                        <div className="bg-slate-800 p-4 rounded-lg space-y-3 border border-slate-700">
                            <p className="text-xs text-slate-400 font-bold mb-2">TARIFA NUEVA</p>
                            <div className="grid grid-cols-2 gap-3">
                                {[['0-4km', 'ordersNew0To4'], ['4-5km', 'ordersNew4To5'], ['5-6km', 'ordersNew5To6'], ['6-7km', 'ordersNew6To7'], ['>7km', 'ordersNewGt7']].map(([label, name]) => (
                                    <div key={name}>
                                        <label className="text-xs text-slate-300 block mb-1">{label}</label>
                                        <input disabled={readOnly} type="number" name={name} value={formData?.[name] || ''} onChange={handleChange} className="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1 text-white text-sm focus:border-blue-500 focus:outline-none disabled:cursor-not-allowed" min="0" onFocus={(e) => e.target.select()} />
                                    </div>
                                ))}
                            </div>

                            <div className="border-t border-slate-700 my-2 pt-2">
                                <p className="text-xs text-slate-400 font-bold mb-2">TARIFA ANTIGUA</p>
                                <div className="grid grid-cols-2 gap-3">
                                    {[['0-3.5km', 'ordersOld0To35'], ['>3.5km', 'ordersOldGt35']].map(([label, name]) => (
                                        <div key={name}>
                                            <label className="text-xs text-slate-300 block mb-1">{label}</label>
                                            <input disabled={readOnly} type="number" name={name} value={formData?.[name] || ''} onChange={handleChange} className="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1 text-white text-sm focus:border-blue-500 focus:outline-none disabled:cursor-not-allowed" min="0" onFocus={(e) => e.target.select()} />
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Section: Datos Flota (Autom√°tico) */}
                    <div className="space-y-4">
                        <h3 className="text-sm font-semibold text-blue-400 uppercase tracking-wider flex items-center">
                            <MapPin className="w-4 h-4 mr-2" /> Datos Flota (Auto)
                        </h3>
                        <div className="bg-slate-800 p-4 rounded-lg space-y-4 border border-slate-700">
                            <div>
                                <label className="text-xs text-slate-300 block mb-1">Km Estimados (35km/L)</label>
                                <div className="w-full bg-slate-900/50 border border-slate-700 rounded px-2 py-2 text-blue-400 font-bold text-lg text-right shadow-inner">
                                    {estimatedKm.toLocaleString('es-ES', { maximumFractionDigits: 0 })} km
                                </div>
                                <p className="text-[10px] text-slate-500 mt-1">Calculado autom√°ticamente seg√∫n gasto y precio combustible.</p>
                            </div>
                        </div>
                    </div>

                    {/* Section: Laboral */}
                    <div className="space-y-4">
                        <h3 className="text-sm font-semibold text-blue-400 uppercase tracking-wider flex items-center">
                            <Users className="w-4 h-4 mr-2" /> Datos Laborales
                        </h3>
                        <div className="bg-slate-800 p-4 rounded-lg space-y-4 border border-slate-700">
                            <div>
                                <label className="text-xs text-slate-300 block mb-1">Riders Contratados</label>
                                <div className="flex items-center">
                                    <input disabled={readOnly} type="number" name="contractedRiders" value={formData.contractedRiders} onChange={handleChange} className="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1 text-white text-sm focus:border-blue-500 focus:outline-none disabled:cursor-not-allowed" min="0" onFocus={(e) => e.target.select()} />
                                    <span className="ml-2 text-xs text-slate-500 whitespace-nowrap">+1 Gerente</span>
                                </div>
                            </div>
                            <div>
                                <label className="text-xs text-slate-300 block mb-1">Horas Totales Servicio</label>
                                <input disabled={readOnly} type="number" name="totalHours" value={formData.totalHours} onChange={handleChange} className="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1 text-white text-sm focus:border-blue-500 focus:outline-none disabled:cursor-not-allowed" min="0" onFocus={(e) => e.target.select()} />
                            </div>
                        </div>
                    </div>

                    {/* Section: Configuration */}
                    <div className="space-y-4">
                        <h3 className="text-sm font-semibold text-blue-400 uppercase tracking-wider flex items-center">
                            <Settings className="w-4 h-4 mr-2" /> Configuraci√≥n B√°sica
                        </h3>
                        <div className="bg-slate-800 p-4 rounded-lg space-y-3 border border-slate-700">
                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className="text-xs text-slate-300 block mb-1">N¬∫ Motos</label>
                                    <input disabled={readOnly} type="number" name="motoCount" value={formData.motoCount} onChange={handleChange} className="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1 text-white text-sm focus:border-blue-500 focus:outline-none disabled:cursor-not-allowed" min="0" onFocus={(e) => e.target.select()} />
                                </div>
                                <div>
                                    <label className="text-xs text-slate-300 block mb-1">Royalty %</label>
                                    <input disabled={readOnly} type="number" name="royaltyPercent" value={formData.royaltyPercent} onChange={handleChange} className="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1 text-white text-sm focus:border-blue-500 focus:outline-none disabled:cursor-not-allowed" min="0" onFocus={(e) => e.target.select()} />
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Section: Fixed Costs */}
                    <div className="space-y-4">
                        <h3 className="text-sm font-semibold text-emerald-400 uppercase tracking-wider flex items-center">
                            <Lock className="w-4 h-4 mr-2" /> Costes Fijos (Mensuales)
                        </h3>
                        <p className="text-xs text-slate-400 italic">Gastos recurrentes independientes del volumen. Introduce solo la Base Imponible.</p>
                        <div className="bg-slate-800 p-4 rounded-lg space-y-3 border border-emerald-900/30">
                            <div className="grid grid-cols-2 gap-3">
                                <div className="col-span-2">
                                    <label className="text-xs text-slate-300 block mb-1">Salarios</label>
                                    <input disabled={readOnly} type="number" name="salaries" value={formData.salaries} onChange={handleChange} className="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1 text-white text-sm focus:border-emerald-500 focus:outline-none disabled:cursor-not-allowed" min="0" onFocus={(e) => e.target.select()} />
                                </div>
                                <div>
                                    <label className="text-xs text-slate-300 block mb-1">Seguros</label>
                                    <input disabled={readOnly} type="number" name="insurance" value={formData.insurance} onChange={handleChange} className="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1 text-white text-sm focus:border-emerald-500 focus:outline-none disabled:cursor-not-allowed" min="0" onFocus={(e) => e.target.select()} />
                                </div>
                                <div>
                                    <label className="text-xs text-slate-300 block mb-1">Gestor√≠a</label>
                                    <input disabled={readOnly} type="number" name="agencyFee" value={formData.agencyFee} onChange={handleChange} className="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1 text-white text-sm focus:border-emerald-500 focus:outline-none disabled:cursor-not-allowed" min="0" onFocus={(e) => e.target.select()} />
                                </div>
                                <div>
                                    <label className="text-xs text-slate-300 block mb-1">PRL</label>
                                    <input disabled={readOnly} type="number" name="prlFee" value={formData.prlFee} onChange={handleChange} className="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1 text-white text-sm focus:border-emerald-500 focus:outline-none disabled:cursor-not-allowed" min="0" onFocus={(e) => e.target.select()} />
                                </div>
                                <div>
                                    <label className="text-xs text-slate-300 block mb-1">Serv. Financieros</label>
                                    <input disabled={readOnly} type="number" name="accountingFee" value={formData.accountingFee} onChange={handleChange} className="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1 text-white text-sm focus:border-emerald-500 focus:outline-none disabled:cursor-not-allowed" min="0" onFocus={(e) => e.target.select()} />
                                </div>
                                <div>
                                    <label className="text-xs text-slate-300 block mb-1">Servicios Prof. (Otros)</label>
                                    <input disabled={readOnly} type="number" name="services" value={formData.services} onChange={handleChange} className="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1 text-white text-sm focus:border-emerald-500 focus:outline-none disabled:cursor-not-allowed" min="0" onFocus={(e) => e.target.select()} />
                                </div>
                                <div>
                                    <label className="text-xs text-slate-300 block mb-1">Cuota Aut√≥nomo</label>
                                    <input disabled={readOnly} type="number" name="quota" value={formData.quota} onChange={handleChange} className="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1 text-white text-sm focus:border-emerald-500 focus:outline-none disabled:cursor-not-allowed" min="0" onFocus={(e) => e.target.select()} />
                                </div>
                                <div className="col-span-2 border-t border-slate-700 pt-3 mt-1">
                                    <label className="text-xs text-purple-300 block mb-1 font-bold">Marketing & Ads</label>
                                    <input disabled={readOnly} type="number" name="marketing" value={formData.marketing} onChange={handleChange} placeholder="Gasto en Facebook/Insta/Google" className="w-full bg-slate-900 border border-purple-500/50 rounded px-2 py-1 text-white text-sm focus:border-purple-500 focus:outline-none disabled:cursor-not-allowed" min="0" onFocus={(e) => e.target.select()} />
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Section: Variable Costs */}
                    <div className="space-y-4">
                        <h3 className="text-sm font-semibold text-amber-400 uppercase tracking-wider flex items-center">
                            <Activity className="w-4 h-4 mr-2" /> Costes Variables (Operativos)
                        </h3>
                        <p className="text-xs text-slate-400 italic">Gastos que var√≠an seg√∫n actividad. Introduce solo la Base Imponible.</p>
                        <div className="bg-slate-800 p-4 rounded-lg space-y-3 border border-amber-900/30">
                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className="text-xs text-slate-300 block mb-1">Gasolina (Base)</label>
                                    <input disabled={readOnly} type="number" name="gasoline" value={formData.gasoline} onChange={handleChange} className="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1 text-white text-sm focus:border-amber-500 focus:outline-none disabled:cursor-not-allowed" min="0" onFocus={(e) => e.target.select()} />
                                </div>
                                <div>
                                    <label className="text-xs text-blue-300 block mb-1">Precio/L (Base)</label>
                                    <input disabled={readOnly} type="number" name="gasolinePrice" value={formData.gasolinePrice} onChange={handleChange} placeholder="0.00" className="w-full bg-slate-900 border border-blue-500/50 rounded px-2 py-1 text-white text-sm focus:border-blue-500 focus:outline-none disabled:cursor-not-allowed" min="0" step="0.01" onFocus={(e) => e.target.select()} />
                                </div>
                                <div>
                                    <label className="text-xs text-slate-300 block mb-1">Reparaciones</label>
                                    <input disabled={readOnly} type="number" name="repairs" value={formData.repairs} onChange={handleChange} className="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1 text-white text-sm focus:border-amber-500 focus:outline-none disabled:cursor-not-allowed" min="0" onFocus={(e) => e.target.select()} />
                                </div>
                                <div>
                                    <label className="text-xs text-slate-300 block mb-1">Otros Costes</label>
                                    <input disabled={readOnly} type="number" name="otherExpenses" value={formData.otherExpenses} onChange={handleChange} className="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1 text-white text-sm focus:border-amber-500 focus:outline-none disabled:cursor-not-allowed" min="0" onFocus={(e) => e.target.select()} />
                                </div>
                                <div className="col-span-2 border-t border-slate-700 pt-3 mt-1">
                                    <label className="text-xs text-rose-300 block mb-1 font-bold">Mermas e Incidencias</label>
                                    <input disabled={readOnly} type="number" name="incidents" value={formData.incidents} onChange={handleChange} placeholder="Coste de errores/devoluciones" className="w-full bg-slate-900 border border-rose-500/50 rounded px-2 py-1 text-white text-sm focus:border-rose-500 focus:outline-none disabled:cursor-not-allowed" min="0" onFocus={(e) => e.target.select()} />
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Section: Fiscalidad */}
                    <div className="space-y-4">
                        <h3 className="text-sm font-semibold text-emerald-400 uppercase tracking-wider flex items-center">
                            <Landmark className="w-4 h-4 mr-2" /> Fiscalidad
                        </h3>
                        <div className="bg-slate-800 p-4 rounded-lg space-y-4 border border-slate-700">
                            <div>
                                <label className="text-xs text-slate-300 block mb-1">IRPF Estimado (%)</label>
                                <input disabled={readOnly} type="number" name="irpfPercent" value={formData.irpfPercent} onChange={handleChange} className="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1 text-white text-sm focus:border-emerald-500 focus:outline-none disabled:cursor-not-allowed" min="0" onFocus={(e) => e.target.select()} />
                            </div>
                        </div>
                    </div>

                    {!readOnly && (
                        <button onClick={handleApply} className="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg transition shadow-lg mt-4">
                            Aplicar Cambios
                        </button>
                    )}
                </div>

                {/* Version Indicator */}
                <div className="mt-8 text-center pb-8 opacity-30 text-[10px] text-white font-mono">
                    REPAART v1.2.0 (Native Polish)
                </div>
            </div>
        </div>
    );
};

export default InputSidebar;



================================================================================
FILE: src\components\KPICard.jsx
================================================================================
import React from 'react';
import { TrendingUp, TrendingDown, Minus } from 'lucide-react';
import InfoTooltip from './InfoTooltip';
import { formatMoney } from '../lib/finance';
import Card from './ui/Card';

const KPICard = ({ title, value, icon, trend, subtext, colorClass, tooltip, delta, deltaPercent }) => {
    const IconComponent = icon;

    // Extract base color from colorClass (e.g., 'text-blue-600' -> 'blue')
    const baseColorName = colorClass.split('-')[1] || 'slate';

    return (
        <Card
            variant="medium"
            interactive={true}
            className="p-5 md:p-8 glass-panel-exec border-0 relative group active-press overflow-hidden"
        >

            {/* Ambient Background Glow (Dynamic) */}
            <div className="absolute inset-0 overflow-hidden rounded-xl pointer-events-none">
                <div className={`absolute -top-10 -right-10 w-40 h-40 bg-${baseColorName}-500/10 rounded-full blur-3xl group-hover:bg-${baseColorName}-500/20 transition-all duration-700`} />
            </div>

            <div className="flex justify-between items-start mb-4 md:mb-5 relative z-10">
                <div className="min-w-0 pr-2">
                    <div className="flex items-center gap-2">
                        <p className="text-[10px] md:text-sm font-bold text-slate-400 uppercase tracking-widest truncate">{title}</p>
                        {tooltip && <InfoTooltip text={tooltip} />}
                    </div>
                    <h3
                        className={`text-2xl md:text-3xl lg:text-4xl font-black mt-1 md:mt-2 tracking-tight text-white truncate shadow-black drop-shadow-sm`}
                        title={value}
                    >
                        {value}
                    </h3>
                </div>

                {/* Glassy Icon Container */}
                <div className={`p-3 rounded-2xl glass-icon hover:scale-110 transition-transform duration-300 ${colorClass} bg-white/5 ring-1 ring-white/10`}>
                    <IconComponent className="w-6 h-6 md:w-7 md:h-7 drop-shadow-lg" strokeWidth={2} />
                </div>
            </div>

            {subtext && (
                <div className="flex items-center text-sm md:text-sm text-slate-400 relative z-10 font-medium">
                    {trend === 'up' && <TrendingUp className="w-4 h-4 text-emerald-400 mr-1.5" />}
                    {trend === 'down' && <TrendingDown className="w-4 h-4 text-rose-400 mr-1.5" />}
                    <span className="opacity-90">{subtext}</span>
                </div>
            )}

            {/* Delta comparison with previous month */}
            {(delta !== undefined && delta !== null) && (
                <div className="mt-4 pt-3 border-t border-white/5 relative z-10">
                    <div className="flex flex-wrap items-center gap-1.5 text-xs">
                        {delta > 0 ? (
                            <TrendingUp className="w-3.5 h-3.5 text-emerald-400 flex-shrink-0" />
                        ) : delta < 0 ? (
                            <TrendingDown className="w-3.5 h-3.5 text-rose-400 flex-shrink-0" />
                        ) : (
                            <Minus className="w-3.5 h-3.5 text-slate-500 flex-shrink-0" />
                        )}
                        <span className={`font-bold ${delta > 0 ? "text-emerald-400" : delta < 0 ? "text-rose-400" : "text-slate-500"}`}>
                            {delta > 0 ? '+' : ''}{formatMoney(Math.abs(delta))}‚Ç¨
                        </span>

                        {deltaPercent !== undefined && deltaPercent !== null && (
                            <span className={`px-1.5 py-0.5 rounded-md text-[10px] font-bold ${delta > 0 ? 'bg-emerald-500/10 text-emerald-400' :
                                delta < 0 ? 'bg-rose-500/10 text-rose-400' :
                                    'bg-slate-500/10 text-slate-400'
                                }`}>
                                {delta > 0 ? '+' : ''}{deltaPercent.toLocaleString('es-ES', { minimumFractionDigits: 1, maximumFractionDigits: 1 })}%
                            </span>
                        )}
                        <span className="text-slate-500 ml-auto font-medium lowercase">vs prev</span>
                    </div>
                </div>
            )}
        </Card>
    );
};

export default React.memo(KPICard);



================================================================================
FILE: src\components\Login.jsx
================================================================================
import React, { useState } from 'react';
import { useAuth } from '../context/AuthContext';
import { Lock, User, AlertCircle, Briefcase, UserPlus, ArrowLeft } from 'lucide-react';
import { createUserWithEmailAndPassword } from 'firebase/auth';
import { doc, setDoc } from 'firebase/firestore';
import { auth, db } from '../lib/firebase';
import logo from '../assets/logo.jpg';
import { logAction, AUDIT_ACTIONS } from '../lib/audit';

import { useToast } from '../hooks/useToast'; // Import hook

const Login = () => {
    const [isLogin, setIsLogin] = useState(true);
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    // const [error, setError] = useState(''); // Removed local error state
    const [loading, setLoading] = useState(false);
    const { login } = useAuth();
    const { addToast } = useToast(); // Use hook

    // Helper: Map Firebase Auth errors to user-friendly messages
    const mapAuthError = (err) => {
        switch (err.code) {
            case 'auth/email-already-in-use': return 'Este email ya est√° registrado.';
            case 'auth/weak-password': return 'La contrase√±a es muy debil.';
            case 'auth/invalid-credential': return 'Credenciales incorrectas.';
            case 'auth/user-not-found': return 'Usuario no encontrado.';
            case 'auth/wrong-password': return 'Contrase√±a incorrecta.';
            default: return err.message || 'Error de autenticaci√≥n.';
        }
    };

    // Logic: Handle Login
    const processLogin = async () => {
        const userCredential = await login(email, password);
        if (userCredential?.user) {
            logAction(userCredential.user, AUDIT_ACTIONS.LOGIN_SUCCESS);
        }
        addToast('¬°Bienvenido de nuevo!', 'success');
        setTimeout(() => window.location.reload(), 1000);
    };

    // Logic: Handle Registration
    const processRegister = async () => {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        // Defensive: user object check
        if (!user) throw new Error("Error creating user instance");

        await setDoc(doc(db, "users_config", user.uid), {
            role: 'pending',
            email: user.email,
            createdAt: new Date().toISOString()
        });
        addToast('Solicitud enviada correctamente', 'success');
        setTimeout(() => window.location.reload(), 1500);
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);

        try {
            if (isLogin) {
                await processLogin();
            } else {
                await processRegister();
            }
        } catch (err) {
            console.error("Auth Error:", err);
            addToast(mapAuthError(err), 'error');
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
            <div className="max-w-md w-full bg-white rounded-2xl shadow-2xl overflow-hidden">
                <div className="bg-blue-600 p-8 text-center relative transition-all duration-500">
                    <img src={logo} alt="REPAART" className="h-16 w-auto mx-auto mb-4 rounded-lg bg-white p-1 shadow-md" />
                    <h2 className="text-2xl font-bold text-white tracking-tight">
                        {isLogin ? 'Acceso Franquicias' : 'Alta Nueva Franquicia'}
                    </h2>
                    <p className="text-blue-100 text-sm mt-2">Sistema Financiero & Log√≠stico</p>
                </div>

                <div className="p-8">
                    {/* Error Banner Removed */}

                    <form onSubmit={handleSubmit} className="space-y-6">
                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-1">Email Corporativo</label>
                            <div className="relative">
                                <User className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400" />
                                <input
                                    type="email"
                                    required
                                    className="pl-10 w-full border border-slate-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:outline-none transition-shadow"
                                    placeholder="franquicia@repaart.com"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                />
                            </div>
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-1">Contrase√±a</label>
                            <div className="relative">
                                <Lock className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400" />
                                <input
                                    type="password"
                                    required
                                    className="pl-10 w-full border border-slate-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:outline-none transition-shadow"
                                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                />
                            </div>
                        </div>

                        <div className="pt-2">
                            <button
                                type="submit"
                                disabled={loading}
                                className={`w-full text-white font-bold py-3 rounded-lg transition-colors shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex justify-center items-center ${isLogin ? 'bg-slate-900 hover:bg-slate-800' : 'bg-blue-600 hover:bg-blue-700'}`}
                            >
                                {loading ? 'Procesando...' : (
                                    <>
                                        {isLogin ? <Briefcase className="w-4 h-4 mr-2" /> : <UserPlus className="w-4 h-4 mr-2" />}
                                        {isLogin ? 'Entrar al Panel' : 'Solicitar Acceso'}
                                    </>
                                )}
                            </button>
                        </div>
                    </form>

                    <div className="mt-8 text-center border-t border-slate-100 pt-6">
                        <button
                            type="button"
                            onClick={() => { setIsLogin(!isLogin); }}
                            className="text-xs font-semibold text-blue-600 hover:text-blue-800 hover:underline transition-all flex items-center justify-center mx-auto"
                        >
                            {isLogin ? (
                                <>¬øNo tienes cuenta? <span className="ml-1 font-bold">Reg√≠strate aqu√≠</span></>
                            ) : (
                                <><ArrowLeft className="w-3 h-3 mr-1" /> Volver al Inicio de Sesi√≥n</>
                            )}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    );
};

export default Login;



================================================================================
FILE: src\components\MonthlyTaxWidget.jsx
================================================================================
import React from 'react';
import { Receipt, TrendingUp, TrendingDown, ArrowRight } from 'lucide-react';
import { formatMoney } from '../lib/finance';
// Replacing Card with direct implementation for maximum control over glassmorphism

const MonthlyTaxWidget = ({ taxes }) => {
    if (!taxes) return null;

    const { ivaAPagar, irpfPago } = taxes;

    return (
        <div className="glass-panel rounded-ios-xl p-6 relative overflow-hidden group h-full">

            {/* Background Decor */}
            <div className="absolute top-0 right-0 w-32 h-32 bg-indigo-400/10 rounded-full blur-2xl -mr-10 -mt-10 pointer-events-none transition-all duration-700 group-hover:scale-150 group-hover:bg-indigo-400/20" />

            {/* Header */}
            <div className="flex items-center justify-between mb-6 relative z-10">
                <div className="flex items-center gap-3">
                    <div className="p-2.5 bg-gradient-to-br from-indigo-50 to-white rounded-xl shadow-sm border border-indigo-50">
                        <Receipt className="w-5 h-5 text-indigo-600" />
                    </div>
                    <div>
                        <h3 className="font-bold text-slate-800 text-sm md:text-base tracking-tight">
                            Previsi√≥n de Impuestos
                        </h3>
                        <p className="text-xs text-slate-500 font-medium">Estimaci√≥n mes actual</p>
                    </div>
                </div>
            </div>


            {/* IVA & IRPF Breakdown */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 relative z-10">
                {/* IVA */}
                <div className="relative group/item">
                    <div className="absolute inset-0 bg-indigo-500/5 rounded-2xl blur-sm transition-opacity opacity-0 group-hover/item:opacity-100" />
                    <div className="relative bg-white/60 backdrop-blur-md rounded-2xl p-4 border border-white/80 shadow-sm hover:shadow-md transition-all duration-300">
                        <div className="flex items-center justify-between mb-3">
                            <div className="flex items-center gap-2">
                                <div className="w-1.5 h-1.5 rounded-full bg-indigo-500" />
                                <span className="text-xs font-bold text-slate-600 uppercase tracking-wider">IVA (21%)</span>
                            </div>
                        </div>
                        <p className="text-2xl font-black text-slate-800 tracking-tight truncate" title={formatMoney(ivaAPagar)}>{formatMoney(ivaAPagar)}‚Ç¨</p>
                        <p className="text-[10px] text-slate-400 mt-1 font-medium">
                            Impuesto sobre valor a√±adido
                        </p>
                    </div>
                </div>

                {/* IRPF */}
                <div className="relative group/item">
                    <div className="absolute inset-0 bg-amber-500/5 rounded-2xl blur-sm transition-opacity opacity-0 group-hover/item:opacity-100" />
                    <div className="relative bg-white/60 backdrop-blur-md rounded-2xl p-4 border border-white/80 shadow-sm hover:shadow-md transition-all duration-300">
                        <div className="flex items-center justify-between mb-3">
                            <div className="flex items-center gap-2">
                                <div className="w-1.5 h-1.5 rounded-full bg-amber-500" />
                                <span className="text-xs font-bold text-slate-600 uppercase tracking-wider">IRPF (20%)</span>
                            </div>
                        </div>
                        <p className="text-2xl font-black text-slate-800 tracking-tight truncate" title={formatMoney(irpfPago)}>{formatMoney(irpfPago)}‚Ç¨</p>
                        <p className="text-[10px] text-slate-400 mt-1 font-medium">
                            Retenci√≥n a cuenta
                        </p>
                    </div>
                </div>
            </div>
        </div>
    );
};

export default React.memo(MonthlyTaxWidget);



================================================================================
FILE: src\components\MonthlyTrendChart.jsx
================================================================================
import React from 'react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';
import { TrendingUp } from 'lucide-react';
import { formatMoney } from '../lib/finance';

const CustomTooltip = ({ active, payload, label }) => {
    if (active && payload && payload.length) {
        return (
            <div className="glass-panel p-3 border border-indigo-100/60 shadow-xl rounded-xl backdrop-blur-md bg-white/90">
                <p className="font-bold text-slate-800 mb-2 border-b border-indigo-50 pb-1">{label}</p>
                {payload.map((entry, index) => (
                    <div key={index} className="flex items-center gap-2 text-sm py-0.5">
                        <div className="w-2 h-2 rounded-full" style={{ backgroundColor: entry.color }} />
                        <span className="text-slate-500">{entry.name}:</span>
                        <span className={`font-bold font-mono ${entry.value >= 0 ? entry.name === 'Ingresos' ? 'text-blue-600' : 'text-emerald-600' : 'text-rose-500'}`}>
                            {formatMoney(entry.value)}‚Ç¨
                        </span>
                    </div>
                ))}
            </div>
        );
    }
    return null;
};

const MonthlyTrendChart = ({ last6Months }) => {
    if (!last6Months || last6Months.length === 0) {
        return (
            <div className="glass-panel rounded-ios-xl p-8 border border-slate-200/60 text-center text-slate-400">
                <p>Sin datos hist√≥ricos disponibles</p>
            </div>
        );
    }

    // Format data for chart
    const data = last6Months.map(m => {
        const date = new Date(m.month + '-01');
        return {
            month: date.toLocaleDateString('es-ES', { month: 'short' }).replace('.', ''),
            Ingresos: m.revenue || 0,
            Beneficio: m.profit || 0
        };
    });

    return (
        <div className="glass-panel rounded-ios-xl p-6 md:p-8 relative group transition-all duration-300 hover:shadow-lg">
            {/* Ambient Glow */}
            <div className="absolute top-0 left-0 w-64 h-64 bg-blue-400/5 rounded-full blur-3xl pointer-events-none -ml-32 -mt-10" />

            <div className="flex items-center gap-3 mb-6 relative z-10">
                <div className="p-2 bg-blue-50 rounded-lg shadow-sm">
                    <TrendingUp className="w-5 h-5 text-blue-600" />
                </div>
                <div>
                    <h3 className="font-bold text-slate-800 text-sm md:text-base">Evoluci√≥n Semestral</h3>
                    <p className="text-xs text-slate-400 font-medium">Hist√≥rico de ingresos y beneficios</p>
                </div>
            </div>

            <div className="h-[280px] md:h-[320px] w-full relative z-10">
                <ResponsiveContainer width="100%" height="100%">
                    <LineChart data={data} margin={{ top: 10, right: 10, left: -10, bottom: 0 }}>
                        <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0" strokeOpacity={0.6} vertical={false} />
                        <XAxis
                            dataKey="month"
                            tick={{ fill: '#64748b', fontSize: 12, fontWeight: 500 }}
                            axisLine={false}
                            tickLine={false}
                            dy={10}
                        />
                        <YAxis
                            tick={{ fill: '#94a3b8', fontSize: 11 }}
                            axisLine={false}
                            tickLine={false}
                            tickFormatter={(value) => `${(value / 1000).toFixed(0)}k`}
                            dx={-5}
                        />
                        <Tooltip content={<CustomTooltip />} cursor={{ stroke: '#cbd5e1', strokeWidth: 1, strokeDasharray: '4 4' }} />
                        <Legend
                            wrapperStyle={{ paddingTop: '20px', fontSize: '12px', fontWeight: 500 }}
                            iconType="circle"
                        />
                        <Line
                            type="monotone"
                            dataKey="Ingresos"
                            stroke="#3b82f6"
                            strokeWidth={3}
                            dot={{ fill: '#fff', stroke: '#3b82f6', strokeWidth: 2, r: 4 }}
                            activeDot={{ r: 6, strokeWidth: 0 }}
                            animationDuration={2000}
                        />
                        <Line
                            type="monotone"
                            dataKey="Beneficio"
                            stroke="#10b981"
                            strokeWidth={3}
                            dot={{ fill: '#fff', stroke: '#10b981', strokeWidth: 2, r: 4 }}
                            activeDot={{ r: 6, strokeWidth: 0 }}
                            animationDuration={2000}
                        />
                    </LineChart>
                </ResponsiveContainer>
            </div>
        </div>
    );
};

export default React.memo(MonthlyTrendChart);



================================================================================
FILE: src\components\NetworkStatus.jsx
================================================================================
import React, { useState, useEffect } from 'react';
import { WifiOff } from 'lucide-react';

const NetworkStatus = () => {
    const [isOnline, setIsOnline] = useState(navigator.onLine);

    useEffect(() => {
        const handleOnline = () => setIsOnline(true);
        const handleOffline = () => setIsOnline(false);

        window.addEventListener('online', handleOnline);
        window.addEventListener('offline', handleOffline);

        return () => {
            window.removeEventListener('online', handleOnline);
            window.removeEventListener('offline', handleOffline);
        };
    }, []);

    if (isOnline) return null;

    return (
        <div className="fixed top-0 left-0 right-0 z-[60] bg-rose-500 text-white text-xs font-bold py-1 px-4 text-center animate-slide-down flex items-center justify-center gap-2">
            <WifiOff className="w-3 h-3" />
            <span>Sin conexi√≥n a internet. Los cambios no se guardar√°n.</span>
        </div>
    );
};

export default NetworkStatus;



================================================================================
FILE: src\components\NetworkStatusWidget.jsx
================================================================================
import React from 'react';
import { Activity } from 'lucide-react';

const NetworkStatusWidget = ({ franchises }) => {
    // Calculate network status counts
    const counts = franchises.reduce((acc, f) => {
        const margin = f.data?.profit > 0 && f.data?.revenue > 0
            ? (f.data.profit / f.data.revenue) * 100
            : 0;

        if (margin >= 20) acc.excellent++;
        else if (margin >= 10) acc.acceptable++;
        else acc.critical++;

        return acc;
    }, { excellent: 0, acceptable: 0, critical: 0 });

    return (
        <div className="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-slate-100 p-6">
            <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center">
                <Activity className="w-5 h-5 mr-2 text-blue-600" />
                Estado de la Red
            </h3>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div className="bg-emerald-50 border-2 border-emerald-200 rounded-xl p-4 hover:shadow-md transition-shadow">
                    <div className="flex items-center justify-between mb-2">
                        <span className="text-2xl">üü¢</span>
                        <span className="text-3xl font-black text-emerald-600">{counts.excellent}</span>
                    </div>
                    <p className="text-xs font-bold text-emerald-700 uppercase tracking-wider">Excelente</p>
                    <p className="text-[10px] text-emerald-600 mt-1">Margen &ge; 20%</p>
                </div>

                <div className="bg-amber-50 border-2 border-amber-200 rounded-xl p-4 hover:shadow-md transition-shadow">
                    <div className="flex items-center justify-between mb-2">
                        <span className="text-2xl">üü°</span>
                        <span className="text-3xl font-black text-amber-600">{counts.acceptable}</span>
                    </div>
                    <p className="text-xs font-bold text-amber-700 uppercase tracking-wider">Aceptable</p>
                    <p className="text-[10px] text-amber-600 mt-1">Margen 10-20%</p>
                </div>

                <div className="bg-rose-50 border-2 border-rose-200 rounded-xl p-4 hover:shadow-md transition-shadow">
                    <div className="flex items-center justify-between mb-2">
                        <span className="text-2xl">üî¥</span>
                        <span className="text-3xl font-black text-rose-600">{counts.critical}</span>
                    </div>
                    <p className="text-xs font-bold text-rose-700 uppercase tracking-wider">Cr√≠tico</p>
                    <p className="text-[10px] text-rose-600 mt-1">Margen &lt; 10%</p>
                </div>
            </div>
        </div>
    );
};

export default NetworkStatusWidget;



================================================================================
FILE: src\components\NewsFeedWidget.jsx
================================================================================
import React, { useMemo } from 'react';
import { useAdminAnnouncements } from '../hooks/useAdminAnnouncements';
import { Megaphone, Bell, CheckCircle } from 'lucide-react';
import Card from './ui/Card';
import { useAuth } from '../context/AuthContext'; // Assuming AuthContext exists

const NewsFeedWidget = () => {
    const { announcements, loading, markAsRead } = useAdminAnnouncements();
    const { user, roleConfig } = useAuth(); // roleConfig contains franchiseId

    // Filter relevant news
    const relevantNews = useMemo(() => {
        if (!user) return [];
        return announcements.filter(news => {
            // 1. Audience Check
            if (news.targetAudience === 'specific') {
                // Check if user's franchiseId is in target list
                // user.uid is fallback if no franchiseId assigned yet (rare for franchises)
                const userFranchiseId = roleConfig?.franchiseId || user.uid;
                if (!news.targetFranchises?.includes(userFranchiseId)) {
                    return false;
                }
            }
            return true;
        });
    }, [announcements, user, roleConfig]);

    // Derived state for display
    const visibleNews = relevantNews.slice(0, 3);
    const unreadCount = relevantNews.filter(n => !n.reads?.includes(user?.uid)).length;

    const handleInteraction = (news) => {
        if (user && !news.reads?.includes(user.uid)) {
            markAsRead(news.id, user.uid);
        }
    };

    if (loading) return <Card className="animate-pulse h-48 bg-slate-50" />;

    return (
        <Card className="h-full border-blue-100 shadow-sm relative overflow-hidden">
            <div className="absolute top-0 right-0 p-4 opacity-10">
                <Megaphone className="w-24 h-24 text-blue-500" />
            </div>

            <div className="flex items-center justify-between mb-4 relative z-10">
                <div className="flex items-center gap-2">
                    <Bell className={`w-5 h-5 ${unreadCount > 0 ? 'text-blue-600 animate-bounce-subtle' : 'text-slate-400'}`} />
                    <h3 className="font-bold text-slate-700">Novedades HQ</h3>
                </div>
                {unreadCount > 0 && (
                    <span className="bg-rose-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm">
                        {unreadCount} nuevos
                    </span>
                )}
            </div>

            <div className="space-y-3 relative z-10">
                {visibleNews.length === 0 ? (
                    <div className="text-center py-6">
                        <p className="text-sm text-slate-400 italic">No hay novedades para ti.</p>
                    </div>
                ) : (
                    visibleNews.map(news => {
                        const isRead = news.reads?.includes(user?.uid);
                        return (
                            <div
                                key={news.id}
                                onClick={() => handleInteraction(news)}
                                className={`flex gap-3 items-start p-2.5 rounded-lg transition-all cursor-pointer group
                                    ${isRead ? 'hover:bg-slate-50 opacity-90' : 'bg-blue-50/50 hover:bg-blue-50 border border-blue-100/50 shadow-sm'}
                                `}
                            >
                                <div className={`mt-1 shrink-0 w-2 h-2 rounded-full transition-transform group-hover:scale-125 
                                    ${!isRead ? 'bg-rose-500 ring-2 ring-rose-200' :
                                        news.priority === 'critical' ? 'bg-rose-400' :
                                            news.priority === 'high' ? 'bg-amber-400' : 'bg-slate-300'}
                                `} />

                                <div className="flex-1 min-w-0">
                                    <div className="flex justify-between items-start">
                                        <h4 className={`text-sm font-bold truncate pr-2 ${news.priority === 'critical' ? 'text-rose-600' : 'text-slate-800'}`}>
                                            {news.title}
                                        </h4>
                                        {isRead && <CheckCircle className="w-3 h-3 text-emerald-500 shrink-0 opacity-0 group-hover:opacity-100 transition-opacity" />}
                                    </div>

                                    <p className={`text-xs line-clamp-2 mt-0.5 ${isRead ? 'text-slate-500' : 'text-slate-700 font-medium'}`}>
                                        {news.content}
                                    </p>
                                    <span className="text-[10px] text-slate-400 mt-1 block">
                                        {news.createdAt?.toLocaleDateString()}
                                    </span>
                                </div>
                            </div>
                        );
                    })
                )}
            </div>

            <button className="w-full mt-auto pt-4 text-xs font-bold text-blue-600 hover:text-blue-800 hover:bg-blue-50 py-2 rounded transition-colors text-center relative z-10">
                Ver Historial Completo
            </button>
        </Card>
    );
};

export default NewsFeedWidget;



================================================================================
FILE: src\components\Notifications.jsx
================================================================================
import React, { useState, useEffect, useRef } from 'react';
import { db } from '../lib/firebase';
import { collection, query, where, orderBy, onSnapshot, limit } from 'firebase/firestore';
import { Bell, Check, ExternalLink, X } from 'lucide-react';
import { useAuth } from '../context/AuthContext';
import { markNotificationAsRead } from '../lib/notifications';

const Notifications = () => {
    const { user } = useAuth();
    const [notifications, setNotifications] = useState([]);
    const [unreadCount, setUnreadCount] = useState(0);
    const [isOpen, setIsOpen] = useState(false);
    const wrapperRef = useRef(null);

    // Close on click outside
    useEffect(() => {
        function handleClickOutside(event) {
            if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
                setIsOpen(false);
            }
        }
        document.addEventListener("mousedown", handleClickOutside);
        return () => document.removeEventListener("mousedown", handleClickOutside);
    }, [wrapperRef]);

    useEffect(() => {
        if (!user) return;

        // Listen to last 20 notifications
        const q = query(
            collection(db, "notifications"),
            where("userId", "==", user.uid),
            orderBy("createdAt", "desc"),
            limit(20)
        );

        const unsubscribe = onSnapshot(q, (snapshot) => {
            const list = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setNotifications(list);
            setUnreadCount(list.filter(n => !n.read).length);
        });

        return () => unsubscribe();
    }, [user]);

    const handleMarkRead = async (id, e) => {
        e.stopPropagation();
        await markNotificationAsRead(id);
    };

    return (
        <div className="relative mr-2" ref={wrapperRef}>
            <button
                onClick={() => setIsOpen(!isOpen)}
                className={`p-2 rounded-full transition-colors relative ${isOpen ? 'bg-indigo-100 text-indigo-600' : 'text-slate-400 hover:text-indigo-600'}`}
                title="Notificaciones"
            >
                <Bell className="w-5 h-5" />
                {unreadCount > 0 && (
                    <span className="absolute top-1 right-1 w-2.5 h-2.5 bg-rose-500 rounded-full border-2 border-white animate-pulse"></span>
                )}
            </button>

            {isOpen && (
                <div className="absolute right-0 mt-2 w-80 bg-white rounded-2xl shadow-xl border border-slate-200 z-50 overflow-hidden animate-in fade-in slide-in-from-top-2 duration-200">
                    <div className="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                        <h4 className="font-bold text-slate-800 text-sm">Notificaciones</h4>
                        {unreadCount > 0 && <span className="text-xs font-bold text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded-full border border-indigo-100">{unreadCount} nuevas</span>}
                    </div>

                    <div className="max-h-[400px] overflow-y-auto">
                        {notifications.length === 0 ? (
                            <div className="p-8 text-center">
                                <Bell className="w-8 h-8 text-slate-200 mx-auto mb-2" />
                                <p className="text-xs text-slate-400 font-medium">No tienes notificaciones</p>
                            </div>
                        ) : (
                            <div className="divide-y divide-slate-50">
                                {notifications.map(item => (
                                    <div
                                        key={item.id}
                                        className={`p-4 transition hover:bg-slate-50 relative group ${!item.read ? 'bg-indigo-50/30' : ''}`}
                                    >
                                        <div className="flex items-start justify-between gap-3">
                                            <div className="flex-1">
                                                <h5 className={`text-sm mb-0.5 ${!item.read ? 'font-black text-slate-800' : 'font-medium text-slate-600'}`}>
                                                    {item.title}
                                                </h5>
                                                <p className="text-xs text-slate-500 leading-relaxed mb-2">{item.message}</p>
                                                <p className="text-[10px] text-slate-400 font-bold uppercase tracking-wider">
                                                    {item.createdAt?.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} ¬∑ {item.createdAt?.toDate().toLocaleDateString()}
                                                </p>
                                            </div>
                                            {!item.read && (
                                                <button
                                                    onClick={(e) => handleMarkRead(item.id, e)}
                                                    className="text-indigo-400 hover:text-indigo-600 p-1 hover:bg-indigo-50 rounded"
                                                    title="Marcar como le√≠da"
                                                >
                                                    <Check className="w-3 h-3" />
                                                </button>
                                            )}
                                        </div>
                                        {item.link && (
                                            <a
                                                href={item.link}
                                                className="mt-2 text-xs font-bold text-indigo-600 flex items-center gap-1 hover:underline"
                                            >
                                                Ver Detalles <ExternalLink className="w-3 h-3" />
                                            </a>
                                        )}
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            )}
        </div>
    );
};

export default Notifications;



================================================================================
FILE: src\components\OperationsDashboard.jsx
================================================================================
import React, { useState, useEffect, useCallback } from 'react';
import {
    Truck, Calendar, Clock, User, AlertTriangle, CheckCircle,
    Wrench, Users, TrendingUp, Plus, Trash2, RefreshCw
} from 'lucide-react';
import FleetService from '../services/fleetService';
import ShiftService from '../services/shiftService';
import WeeklyCalendarGrid from './WeeklyCalendarGrid';
import CoverageStats from './CoverageStats';

const DAYS = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
const TIME_SLOTS = ['12:00-15:00', '15:00-18:00', '18:00-21:00', '21:00-00:00'];
const MOCK_RIDERS = ['Juan P.', 'Ana G.', 'Carlos R.', 'Sof√≠a L.', 'Pedro M.'];

/**
 * OperationsDashboard - Vista unificada de Flota + Turnos
 * Optimized with Service Layer & React.memo
 */
import { useRBAC } from '../hooks/useRBAC';

/**
 * OperationsDashboard - Vista unificada de Flota + Turnos
 * Optimized with Service Layer & React.memo
 */
const OperationsDashboard = React.memo(({ readOnly: propReadOnly }) => {
    const { canWrite } = useRBAC();

    // Determine effective read-only state:
    // If prop is explicitly passed, respect it (for demos/previews).
    // Otherwise, use RBAC: if cannot write to operations, then it's read-only.
    const isReadOnly = propReadOnly !== undefined ? propReadOnly : !canWrite('operations');

    // Fleet State
    const [vehicles, setVehicles] = useState([]);
    const [fleetLoading, setFleetLoading] = useState(true);

    // Shifts State
    const [shifts, setShifts] = useState([]);
    const [shiftsLoading, setShiftsLoading] = useState(true);

    // Quick Add States
    const [quickShiftDay, setQuickShiftDay] = useState('Viernes');
    const [quickShiftTime, setQuickShiftTime] = useState('20:00-23:00');
    const [quickShiftRider, setQuickShiftRider] = useState('');

    // Fetch Fleet
    const fetchFleet = useCallback(async () => {
        try {
            const data = await FleetService.getAllVehicles();
            setVehicles(data);
        } catch (error) {
            console.error('Error fetching fleet:', error);
        } finally {
            setFleetLoading(false);
        }
    }, []);

    // Fetch Shifts
    const fetchShifts = useCallback(async () => {
        try {
            const data = await ShiftService.getAllShifts();
            setShifts(data);
        } catch (error) {
            console.error('Error fetching shifts:', error);
        } finally {
            setShiftsLoading(false);
        }
    }, []);

    useEffect(() => {
        fetchFleet();
        fetchShifts();
    }, [fetchFleet, fetchShifts]);

    // Quick Add Shift
    // Quick Add Shift
    const handleQuickAddShift = async (e) => {
        e.preventDefault();
        if (!quickShiftRider) return;

        const [startTime, endTime] = quickShiftTime.split('-');
        try {
            await ShiftService.addShift({
                day: quickShiftDay,
                startTime,
                endTime,
                riderName: quickShiftRider,
                zone: 'Centro'
            });
            setQuickShiftRider('');
            fetchShifts();
        } catch (error) {
            console.error('Error adding shift:', error);
        }
    };

    const handleDeleteShift = async (shiftId) => {
        try {
            await ShiftService.deleteShift(shiftId);
            fetchShifts();
        } catch (error) {
            console.error('Error deleting shift:', error);
        }
    };

    // Calculate KPIs
    const activeVehicles = vehicles.filter(v => v.status === 'active').length;
    const warningVehicles = vehicles.filter(v => v.status === 'warning').length;
    const repairVehicles = vehicles.filter(v => v.status === 'repair').length;
    const totalRidersToday = new Set(shifts.map(s => s.riderName)).size;

    // Critical gaps
    const fridayNights = shifts.filter(s => s.day === 'Viernes' && s.startTime <= '20:00' && s.endTime >= '23:00');
    const hasCriticalGaps = fridayNights.length < 2;

    // Get km progress color
    const getKmColor = (current, target) => {
        const pct = (current / target) * 100;
        if (current >= target) return 'text-red-500 bg-red-50';
        if (pct > 90) return 'text-orange-500 bg-orange-50';
        return 'text-emerald-500 bg-emerald-50';
    };

    if (fleetLoading || shiftsLoading) {
        return (
            <div className="flex items-center justify-center h-screen">
                <RefreshCw className="w-8 h-8 animate-spin text-blue-600" />
            </div>
        );
    }

    return (
        <div className="p-6 space-y-6 max-w-[1800px] mx-auto animate-fade-in">
            {/* Header */}
            <div className="flex justify-between items-center px-2">
                <div>
                    <h1 className="text-2xl font-bold text-white flex items-center gap-3 tracking-tight">
                        <TrendingUp className="text-blue-400" />
                        Operations Center
                    </h1>
                    <p className="text-sm text-slate-400 mt-1 font-medium">
                        {isReadOnly
                            ? 'üîí Modo Auditor√≠a - Solo lectura (Admin)'
                            : 'Vista unificada de Flota & Turnos'}
                    </p>
                </div>
                <div className="flex items-center gap-3">
                    {isReadOnly && (
                        <span className="px-4 py-2 bg-orange-500/10 text-orange-400 rounded-lg text-sm font-bold border border-orange-500/20">
                            üìã Modo Auditor
                        </span>
                    )}
                    <button
                        onClick={() => { fetchFleet(); fetchShifts(); }}
                        className="p-3 glass-panel-exec rounded-xl hover:bg-white/10 transition-all text-slate-200"
                    >
                        <RefreshCw size={20} />
                    </button>
                </div>
            </div>

            {/* KPI Cards */}
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                <KPICard
                    icon={Truck}
                    label="Motos Operativas"
                    value={`${activeVehicles}/${vehicles.length}`}
                    color="emerald"
                    status="good"
                />
                <KPICard
                    icon={AlertTriangle}
                    label="Revisi√≥n Pendiente"
                    value={warningVehicles + repairVehicles}
                    color={warningVehicles + repairVehicles > 0 ? "orange" : "slate"}
                    status={warningVehicles + repairVehicles > 0 ? "warning" : "good"}
                />
                <KPICard
                    icon={Users}
                    label="Riders Activos Hoy"
                    value={totalRidersToday}
                    color="blue"
                    status="good"
                />
                <KPICard
                    icon={Calendar}
                    label="Cobertura Cr√≠tica"
                    value={hasCriticalGaps ? "Alerta" : "OK"}
                    color={hasCriticalGaps ? "red" : "emerald"}
                    status={hasCriticalGaps ? "critical" : "good"}
                />
            </div>

            {/* Main Content Grid */}
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                {/* LEFT: Weekly Schedule */}
                <div className="glass-panel-exec p-6 rounded-xl border-0 ring-1 ring-white/10 lg:col-span-2">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl font-bold text-white flex items-center gap-2 tracking-tight">
                            <Calendar className="text-purple-400" size={24} />
                            Calendario Semanal
                        </h2>
                    </div>

                    {/* Coverage Statistics */}
                    <CoverageStats shifts={shifts} />

                    {/* Quick Add Form */}
                    {!isReadOnly && (
                        <form onSubmit={handleQuickAddShift} className="flex flex-wrap gap-3 mb-6 p-4 bg-gradient-to-br from-blue-500/10 to-indigo-500/10 rounded-xl border border-blue-500/20">
                            <select
                                value={quickShiftDay}
                                onChange={(e) => setQuickShiftDay(e.target.value)}
                                className="px-3 py-2 border border-slate-700 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-slate-800 text-white min-w-[120px]"
                            >
                                {DAYS.map(day => (
                                    <option key={day} value={day}>{day}</option>
                                ))}
                            </select>
                            <select
                                value={quickShiftTime}
                                onChange={(e) => setQuickShiftTime(e.target.value)}
                                className="px-3 py-2 border border-slate-700 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-slate-800 text-white min-w-[140px]"
                            >
                                {TIME_SLOTS.map(slot => (
                                    <option key={slot} value={slot}>{slot}</option>
                                ))}
                            </select>
                            <select
                                value={quickShiftRider}
                                onChange={(e) => setQuickShiftRider(e.target.value)}
                                className="flex-1 px-3 py-2 border border-slate-700 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-slate-800 text-white min-w-[200px]"
                            >
                                <option value="">Seleccionar rider...</option>
                                {MOCK_RIDERS.map(rider => (
                                    <option key={rider} value={rider}>{rider}</option>
                                ))}
                            </select>
                            <button
                                type="submit"
                                disabled={!quickShiftRider}
                                className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold hover:bg-blue-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center gap-2 shadow-lg shadow-blue-500/20 w-full sm:w-auto justify-center"
                            >
                                <Plus size={16} />
                                A√±adir Turno
                            </button>
                        </form>
                    )}

                    {/* Visual Calendar Grid */}
                    <WeeklyCalendarGrid
                        shifts={shifts}
                        onDeleteShift={handleDeleteShift}
                        readOnly={isReadOnly}
                    />
                </div>

                {/* RIGHT: Fleet Status */}
                <div className="glass-panel-exec p-6 rounded-xl border-0 ring-1 ring-white/10">
                    <h2 className="text-xl font-bold text-white flex items-center gap-2 mb-6 tracking-tight">
                        <Truck className="text-blue-400" size={24} />
                        Estado Flota
                    </h2>

                    <div className="space-y-3 max-h-[700px] overflow-y-auto custom-scrollbar pr-2">
                        {vehicles.map(vehicle => {
                            const kmPct = (vehicle.currentKm / vehicle.nextRevisionKm) * 100;
                            const colorClass = getKmColor(vehicle.currentKm, vehicle.nextRevisionKm);
                            const kmRemaining = vehicle.nextRevisionKm - vehicle.currentKm;

                            // Calculate days since last revision (if available)
                            const daysSinceRevision = vehicle.lastRevisionDate
                                ? Math.floor((new Date() - new Date(vehicle.lastRevisionDate)) / (1000 * 60 * 60 * 24))
                                : null;

                            // Estimate km/day and days to next revision
                            const kmPerDay = daysSinceRevision && daysSinceRevision > 0 && vehicle.currentKm > 0
                                ? (vehicle.currentKm / daysSinceRevision).toFixed(0)
                                : null;

                            const daysToNextRevision = kmPerDay && kmPerDay > 0
                                ? Math.ceil(kmRemaining / kmPerDay)
                                : null;

                            return (
                                <div
                                    key={vehicle.id}
                                    className="p-4 border border-white/5 bg-white/5 rounded-xl hover:bg-white/10 transition-all"
                                >
                                    <div className="flex justify-between items-start mb-3">
                                        <div>
                                            <p className="font-bold text-white tracking-wide">{vehicle.alias}</p>
                                            <p className="text-xs text-slate-400 font-mono">{vehicle.currentKm.toLocaleString()} km</p>
                                        </div>
                                        {vehicle.status === 'active' && <CheckCircle className="text-emerald-400" size={20} />}
                                        {vehicle.status === 'warning' && <AlertTriangle className="text-orange-400" size={20} />}
                                        {vehicle.status === 'repair' && <Wrench className="text-red-400" size={20} />}
                                    </div>

                                    {/* KM Progress */}
                                    <div className="relative mb-3">
                                        <div className="w-full h-2 bg-slate-700/50 rounded-full overflow-hidden">
                                            <div
                                                className={`h-full ${colorClass.replace('text-', 'bg-').replace('-50', '-500')} transition-all`}
                                                style={{ width: `${Math.min(kmPct, 100)}%` }}
                                            ></div>
                                        </div>
                                        <p className={`text-xs mt-1 ${colorClass.split(' ')[0].replace('-500', '-400')} font-bold`}>
                                            {kmRemaining > 0
                                                ? `${kmRemaining} km hasta revisi√≥n`
                                                : 'Revisi√≥n URGENTE'}
                                        </p>
                                    </div>

                                    {/* Additional Info */}
                                    <div className="grid grid-cols-2 gap-2 mb-3 text-xs">
                                        {daysSinceRevision !== null && (
                                            <div className="bg-slate-800/50 rounded p-2">
                                                <p className="text-slate-500 text-[10px] font-bold uppercase">√öltima Revisi√≥n</p>
                                                <p className="font-bold text-slate-300">{daysSinceRevision} d√≠as</p>
                                            </div>
                                        )}
                                        {kmPerDay && (
                                            <div className="bg-slate-800/50 rounded p-2">
                                                <p className="text-slate-500 text-[10px] font-bold uppercase">Promedio Km/d√≠a</p>
                                                <p className="font-bold text-slate-300">{kmPerDay} km</p>
                                            </div>
                                        )}
                                        {daysToNextRevision && daysToNextRevision > 0 && (
                                            <div className="bg-blue-500/10 rounded p-2 col-span-2">
                                                <p className="text-blue-400 text-[10px] font-bold uppercase">Pr√≥xima Revisi√≥n</p>
                                                <p className="font-bold text-blue-300">~{daysToNextRevision} d√≠as</p>
                                            </div>
                                        )}
                                    </div>

                                    {/* Quick Actions */}
                                    {!isReadOnly && (
                                        <div className="flex gap-2">
                                            {(vehicle.status === 'warning' || vehicle.status === 'repair') && (
                                                <button className="flex-1 py-2 text-xs font-bold bg-blue-600 text-white rounded-lg hover:bg-blue-500 transition-colors shadow-lg shadow-blue-500/20">
                                                    Programar Revisi√≥n
                                                </button>
                                            )}
                                            {vehicle.status !== 'repair' && (
                                                <button
                                                    className="flex-1 py-2 text-xs font-bold border border-orange-500/30 text-orange-400 rounded-lg hover:bg-orange-500/10 transition-colors"
                                                    title="Marcar en taller"
                                                >
                                                    En Taller
                                                </button>
                                            )}
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                </div>
            </div>
        </div>
    );
});

// KPI Card Component
// eslint-disable-next-line no-unused-vars
const KPICard = ({ icon: IconComponent, label, value, color, status }) => {
    const statusColors = {
        good: 'border-emerald-500/20 ring-1 ring-emerald-500/10',
        warning: 'border-orange-500/20 ring-1 ring-orange-500/10',
        critical: 'border-red-500/20 ring-1 ring-red-500/10'
    };

    const iconColors = {
        emerald: 'text-emerald-400',
        orange: 'text-orange-400',
        slate: 'text-slate-400',
        blue: 'text-blue-400',
        red: 'text-red-400'
    };

    const textColors = {
        emerald: 'text-emerald-400',
        orange: 'text-orange-400',
        slate: 'text-slate-200',
        blue: 'text-blue-400',
        red: 'text-red-400'
    };

    const bgColors = {
        good: 'bg-emerald-500/5',
        warning: 'bg-orange-500/5',
        critical: 'bg-red-500/5'
    }

    return (
        <div className={`glass-panel-exec p-4 rounded-xl border-0 ${statusColors[status]} ${bgColors[status] || ''} flex flex-col justify-between h-full`}>
            <div className="flex items-center justify-between mb-2">
                <IconComponent className={iconColors[color]} size={24} />
                {status === 'critical' && <AlertTriangle className="text-red-500 animate-pulse" size={20} />}
            </div>
            <p className="text-[10px] text-slate-400 font-bold uppercase tracking-wider">{label}</p>
            <p className={`text-2xl font-black ${textColors[color]} mt-1`}>{value}</p>
        </div>
    );
};

// export default React.memo(OperationsDashboard) // Already memoized at definition
export default OperationsDashboard;



================================================================================
FILE: src\components\PrintReport.jsx
================================================================================
import React from 'react';
import logo from '../assets/logo.jpg';
import { formatMoney } from '../lib/finance';

const PrintReport = ({ report }) => {
    if (!report) return null;

    return (
        <div className="hidden print:block font-serif text-black p-4 md:p-8 w-full max-w-[210mm] mx-auto bg-white responsive-print-container">
            {/* Header */}
            <div className="flex justify-between items-end border-b-2 border-gray-900 pb-6 mb-8">
                <div className="flex items-center">
                    {/* LARGE LOGO FOR PRINT */}
                    <img src={logo} alt="REPAART" className="h-24 w-auto mr-6 grayscale" />
                    <div>
                        <h1 className="text-3xl font-bold text-gray-900 tracking-wider">INFORME FINANCIERO</h1>
                        <p className="text-sm text-gray-600 uppercase tracking-widest mt-1">REPAART Franchise System</p>
                    </div>
                </div>
                <div className="text-right">
                    <p className="text-xs font-bold text-gray-500 uppercase tracking-widest">FECHA DE EMISI√ìN</p>
                    <p className="text-lg font-bold text-gray-900">{new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                </div>
            </div>

            {/* Executive Summary */}
            <div className="mb-8 break-inside-avoid">
                <h2 className="text-sm font-bold uppercase border-b border-gray-400 mb-4 pb-1 tracking-widest">Resumen Ejecutivo</h2>
                <div className="grid grid-cols-4 gap-4">
                    <div className="p-4 border border-gray-200 bg-gray-50">
                        <p className="text-[10px] uppercase text-gray-500 font-bold tracking-wider">Ingresos Totales</p>
                        <p className="text-xl font-bold mt-1 text-gray-900">{formatMoney(report.revenue)}‚Ç¨</p>
                    </div>
                    <div className="p-4 border border-gray-200 bg-gray-50">
                        <p className="text-[10px] uppercase text-gray-500 font-bold tracking-wider">Costes (Base)</p>
                        <p className="text-xl font-bold mt-1 text-gray-900">{formatMoney(report.expenses)}‚Ç¨</p>
                    </div>
                    <div className="p-4 border border-gray-200 bg-gray-50">
                        <p className="text-[10px] uppercase text-gray-500 font-bold tracking-wider">Beneficio Bruto</p>
                        <p className="text-xl font-bold mt-1 text-gray-900">{formatMoney(report.profit)}‚Ç¨</p>
                    </div>
                    <div className="p-4 border border-gray-900 bg-gray-100">
                        <p className="text-[10px] uppercase text-gray-900 font-bold tracking-wider">Beneficio Neto Real</p>
                        <p className="text-xl font-bold mt-1 text-gray-900">{formatMoney(report.taxes.netProfitPostTax)}‚Ç¨</p>
                    </div>
                </div>
            </div>

            {/* Logistics & Metrics Block */}
            <div className="mb-8 break-inside-avoid">
                <h2 className="text-sm font-bold uppercase border-b border-gray-400 mb-4 pb-1 tracking-widest">Indicadores de Flota</h2>
                <div className="grid grid-cols-3 gap-8 text-sm">
                    <div>
                        <p className="font-bold border-b border-gray-200 mb-2 text-xs text-gray-500">EFICIENCIA</p>
                        <div className="flex justify-between mb-1">
                            <span>Coste / Km:</span>
                            <span className="font-bold">{formatMoney(report.metrics.costPerKm, 3)}‚Ç¨</span>
                        </div>
                        <div className="flex justify-between mb-1">
                            <span>Ingreso / Km:</span>
                            <span className="font-bold">{formatMoney(report.metrics.revenuePerKm, 3)}‚Ç¨</span>
                        </div>
                    </div>
                    <div>
                        <p className="font-bold border-b border-gray-200 mb-2 text-xs text-gray-500">OPERATIVA</p>
                        <div className="flex justify-between mb-1">
                            <span>Km Totales:</span>
                            <span className="font-bold">{report.metrics.totalKm} km</span>
                        </div>
                        <div className="flex justify-between mb-1">
                            <span>Drop Density:</span>
                            <span className="font-bold">{formatMoney(report.metrics.dropDensity, 1)} /100km</span>
                        </div>
                    </div>
                    <div>
                        <p className="font-bold border-b border-gray-200 mb-2 text-xs text-gray-500">RENDIMIENTO</p>
                        <div className="flex justify-between mb-1">
                            <span>Productividad:</span>
                            <span className="font-bold">{formatMoney(report.metrics.productivity, 2)} ped/h</span>
                        </div>
                        <div className="flex justify-between mb-1">
                            <span>Beneficio / Rider:</span>
                            <span className="font-bold">{formatMoney(report.metrics.profitPerRider, 2)}‚Ç¨</span>
                        </div>
                    </div>
                </div>
            </div>

            {/* Taxes */}
            <div className="mb-8 break-inside-avoid">
                <h2 className="text-sm font-bold uppercase border-b border-gray-400 mb-4 pb-1 tracking-widest">Liquidaci√≥n de Impuestos</h2>
                <table className="w-full text-sm">
                    <tbody className="divide-y divide-gray-200">
                        <tr>
                            <td className="py-2 pl-2">IVA Repercutido (21%)</td>
                            <td className="text-right pr-2 text-green-700 font-medium">+{formatMoney(report.taxes.ivaRepercutido)}‚Ç¨</td>
                        </tr>
                        <tr>
                            <td className="py-2 pl-2">IVA Soportado (Deducible)</td>
                            <td className="text-right pr-2 text-red-700 font-medium">-{formatMoney(report.taxes.ivaSoportado)}‚Ç¨</td>
                        </tr>
                        <tr className="bg-gray-100 font-bold border-t border-gray-800">
                            <td className="py-2 pl-2 uppercase tracking-wider">IVA A Pagar</td>
                            <td className="text-right pr-2">{formatMoney(report.taxes.ivaAPagar)}‚Ç¨</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            {/* Detailed Expenses */}
            <div className="mb-8 break-inside-avoid">
                <h2 className="text-sm font-bold uppercase border-b border-gray-400 mb-4 pb-1 tracking-widest">Detalle de Costes Operativos</h2>
                <table className="w-full text-sm text-left">
                    <thead>
                        <tr className="border-b border-gray-300">
                            <th className="py-2 w-1/2 font-semibold text-gray-600">Concepto</th>
                            <th className="text-right py-2 font-semibold text-gray-600">Base Imponible</th>
                            <th className="text-right py-2 font-semibold text-gray-600">Total Caja</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-200">
                        {report.breakdown.map((item, idx) => {
                            const hasIva = [
                                'Renting Motos', 'Royalty', 'Gasolina', 'Reparaciones',
                                'Servicios Prof.', 'Gestor√≠a', 'PRL', 'Serv. Financieros',
                                'Otros Costes', 'App Flyder'
                            ].includes(item.name);
                            const ivaAmount = hasIva ? item.value * 0.21 : 0;
                            return (
                                <tr key={idx}>
                                    <td className="py-1.5 text-gray-700">{item.name}</td>
                                    <td className="text-right py-1.5 font-medium">{formatMoney(item.value)}‚Ç¨</td>
                                    <td className="text-right py-1.5">{formatMoney(item.value + ivaAmount)}‚Ç¨</td>
                                </tr>
                            );
                        })}
                    </tbody>
                </table>
            </div>

            {/* Signature */}
            <div className="mt-12 pt-8 border-t border-gray-400 break-inside-avoid">
                <p className="text-xs text-gray-500 mb-4 uppercase tracking-widest">Firma del Responsable</p>
                <div className="border-b border-dashed border-gray-400 w-64 mb-2"></div>
            </div>

            <div className="mt-8 text-center text-[10px] text-gray-400 uppercase tracking-widest">
                Documento generado autom√°ticamente por REPAART Financial System. Confidencial.
            </div>
        </div>
    );
};

export default PrintReport;



================================================================================
FILE: src\components\QuizView.jsx
================================================================================
import React, { useState } from 'react';
import { X, RotateCcw } from 'lucide-react';

/**
 * QuizView - Examen tipo test interactivo
 * Professional quiz interface with immediate feedback
 */
const QuizView = ({ categoryName, quizzes, onComplete, onBack }) => {
    const [answers, setAnswers] = useState({});
    const [showResults, setShowResults] = useState(false);
    const [score, setScore] = useState(null);

    const handleSubmit = () => {
        let correct = 0;
        quizzes.forEach((quiz, index) => {
            if (answers[index] === quiz.correctIndex) {
                correct++;
            }
        });

        const scorePercentage = Math.round((correct / quizzes.length) * 100);
        const passed = scorePercentage >= 80;

        setScore({
            percentage: scorePercentage,
            correct,
            total: quizzes.length,
            passed
        });
        setShowResults(true);

        if (onComplete) {
            onComplete(scorePercentage, passed);
        }
    };

    const handleRetry = () => {
        setAnswers({});
        setShowResults(false);
        setScore(null);
    };

    const allAnswered = Object.keys(answers).length === quizzes.length;

    if (showResults && score) {
        return (
            <div className="flex flex-col items-center justify-center min-h-[600px] p-8 animate-fade-in">
                <div className="text-center max-w-md surface-raised p-10 rounded-2xl elevation-xl border border-slate-200">
                    <div className={`w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6 ${score.passed ? 'bg-emerald-100 text-emerald-600' : 'bg-red-100 text-red-600'
                        }`}>
                        {score.passed ? (
                            <svg className="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        ) : (
                            <svg className="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        )}
                    </div>

                    <h2 className="text-h2 text-primary mb-2">
                        {score.passed ? '¬°Aprobado!' : 'Suspendido'}
                    </h2>

                    <div className="mb-6">
                        <div className="text-5xl font-black text-primary mb-2">{score.percentage}%</div>
                        <p className="text-secondary">
                            {score.correct} aciertos de {score.total} preguntas
                        </p>
                        {!score.passed && (
                            <p className="text-body-sm text-tertiary mt-3">
                                Necesitas ‚â•80% para aprobar
                            </p>
                        )}
                    </div>

                    <div className="flex gap-3 justify-center">
                        {!score.passed && (
                            <button
                                onClick={handleRetry}
                                className="flex items-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition-colors elevation-md"
                            >
                                <RotateCcw size={18} />
                                Reintentar
                            </button>
                        )}
                        <button
                            onClick={onBack}
                            className="px-6 py-3 surface-sunken text-primary rounded-xl font-bold hover:bg-slate-200 transition-colors"
                        >
                            {score.passed ? 'Continuar' : 'Volver'}
                        </button>
                    </div>
                </div>
            </div>
        );
    }

    return (
        <div className="p-8 max-w-3xl mx-auto pb-24 h-full overflow-y-auto custom-scroll">
            {/* Header */}
            <div className="flex justify-between items-center mb-8">
                <div>
                    <button
                        onClick={onBack}
                        className="text-tertiary hover:text-primary flex items-center gap-2 mb-4 transition-colors"
                    >
                        <X size={18} />
                        Salir del examen
                    </button>
                    <h2 className="text-h2 text-primary">Examen: {categoryName}</h2>
                    <p className="text-secondary mt-1">
                        {quizzes.length} preguntas ¬∑ M√≠nimo 80% para aprobar
                    </p>
                </div>
            </div>

            {/* Questions */}
            <div className="surface-raised rounded-2xl elevation-md border border-slate-200 overflow-hidden">
                <div className="bg-slate-900 p-8 text-white text-center">
                    <h3 className="text-h3">Evaluaci√≥n de Conocimientos</h3>
                </div>

                <div className="p-8 space-y-8">
                    {quizzes.map((quiz, index) => (
                        <div
                            key={quiz.id}
                            className="border-b border-slate-100 pb-6 last:border-0 last:pb-0"
                        >
                            <p className="font-bold text-primary mb-4 flex gap-3">
                                <span className="surface-sunken text-tertiary w-7 h-7 rounded-full flex items-center justify-center text-xs shrink-0 font-black">
                                    {index + 1}
                                </span>
                                {quiz.question}
                            </p>

                            <div className="space-y-2 pl-10">
                                {quiz.options.map((option, optIndex) => {
                                    const isSelected = answers[index] === optIndex;

                                    return (
                                        <label
                                            key={optIndex}
                                            className={`flex items-center gap-3 p-4 rounded-xl border cursor-pointer transition-all ${isSelected
                                                    ? 'border-blue-600 bg-blue-50 elevation-sm'
                                                    : 'border-slate-200 hover:bg-slate-50 hover:border-slate-300'
                                                }`}
                                        >
                                            <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center transition-all ${isSelected ? 'border-blue-600' : 'border-slate-300'
                                                }`}>
                                                {isSelected && (
                                                    <div className="w-2.5 h-2.5 bg-blue-600 rounded-full"></div>
                                                )}
                                            </div>
                                            <span className="text-body text-secondary flex-1">
                                                {option}
                                            </span>
                                            <input
                                                type="radio"
                                                name={`question-${index}`}
                                                className="hidden"
                                                onChange={() => setAnswers({ ...answers, [index]: optIndex })}
                                                checked={isSelected}
                                            />
                                        </label>
                                    );
                                })}
                            </div>
                        </div>
                    ))}
                </div>
            </div>

            {/* Submit Button - Fixed Bottom */}
            <div className="fixed bottom-0 left-0 w-full surface-raised border-t border-slate-200 p-4 flex justify-center elevation-lg">
                <button
                    onClick={handleSubmit}
                    disabled={!allAnswered}
                    className="bg-blue-600 text-white px-12 py-4 rounded-xl font-bold elevation-md disabled:opacity-50 disabled:cursor-not-allowed hover:bg-blue-700 transition-all hover:elevation-lg"
                >
                    {allAnswered ? 'Entregar Examen' : `Responde las ${quizzes.length - Object.keys(answers).length} restantes`}
                </button>
            </div>
        </div>
    );
};

export default React.memo(QuizView);



================================================================================
FILE: src\components\ResourcesPanel.jsx
================================================================================
import React, { useState, useEffect } from 'react';
import { db } from '../lib/firebase';
import { collection, query, orderBy, onSnapshot } from 'firebase/firestore';
import { FileText, Download, Image, Film, File, Search, FolderOpen } from 'lucide-react';

const ResourcesPanel = () => {
    const [resources, setResources] = useState([]);
    const [loading, setLoading] = useState(true);
    const [searchTerm, setSearchTerm] = useState('');
    const [selectedCategory, setSelectedCategory] = useState('all');

    useEffect(() => {
        const q = query(collection(db, "resources"), orderBy("createdAt", "desc"));
        const unsubscribe = onSnapshot(q, (snapshot) => {
            setResources(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
            setLoading(false);
        });
        return () => unsubscribe();
    }, []);

    // Derived state
    const categories = ['all', ...new Set(resources.map(r => r.category))];

    const filteredResources = resources.filter(r => {
        const matchesSearch = r.title.toLowerCase().includes(searchTerm.toLowerCase());
        const matchesCategory = selectedCategory === 'all' || r.category === selectedCategory;
        return matchesSearch && matchesCategory;
    });

    const getIcon = (type) => {
        if (type.includes('image')) return <Image className="w-6 h-6 text-purple-600" />;
        if (type.includes('video')) return <Film className="w-6 h-6 text-rose-600" />;
        if (type.includes('pdf')) return <FileText className="w-6 h-6 text-orange-600" />;
        return <File className="w-6 h-6 text-slate-600" />;
    };

    return (
        <div className="p-8 max-w-7xl mx-auto">
            {/* Header */}
            <div className="mb-8 flex flex-col md:flex-row md:items-end justify-between gap-4">
                <div>
                    <h1 className="text-3xl font-black text-slate-800 tracking-tight mb-2">Centro de Recursos</h1>
                    <p className="text-slate-500 font-medium max-w-2xl">
                        Descarga manuales operativos, material de marketing y documentaci√≥n legal oficial.
                    </p>
                </div>
            </div>

            {/* Filters */}
            <div className="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm mb-8 flex flex-col md:flex-row items-center gap-4">
                <div className="relative flex-1 w-full">
                    <Search className="absolute left-4 top-3.5 w-5 h-5 text-slate-400" />
                    <input
                        type="text"
                        placeholder="Buscar archivo..."
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                        className="w-full bg-slate-50 border border-slate-200 rounded-xl pl-12 pr-4 py-3 focus:ring-2 focus:ring-indigo-500 outline-none font-bold text-slate-700 transition"
                    />
                </div>
                <div className="flex items-center gap-2 overflow-x-auto w-full md:w-auto pb-2 md:pb-0 hide-scrollbar">
                    {categories.map(cat => (
                        <button
                            key={cat}
                            onClick={() => setSelectedCategory(cat)}
                            className={`px-4 py-2 rounded-xl text-sm font-bold uppercase tracking-wide whitespace-nowrap transition ${selectedCategory === cat
                                    ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200'
                                    : 'bg-slate-50 text-slate-500 hover:bg-slate-100'
                                }`}
                        >
                            {cat === 'all' ? 'Todos' : cat}
                        </button>
                    ))}
                </div>
            </div>

            {/* Grid */}
            {loading ? (
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 animate-pulse">
                    {[1, 2, 3].map(i => <div key={i} className="h-48 bg-slate-100 rounded-2xl"></div>)}
                </div>
            ) : filteredResources.length === 0 ? (
                <div className="text-center py-20 bg-slate-50 rounded-3xl border-2 border-dashed border-slate-200">
                    <FolderOpen className="w-16 h-16 text-slate-300 mx-auto mb-4" />
                    <h3 className="text-lg font-bold text-slate-500">No hemos encontrado archivos</h3>
                    <p className="text-slate-400">Intenta con otra b√∫squeda o categor√≠a</p>
                </div>
            ) : (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {filteredResources.map(resource => (
                        <div key={resource.id} className="bg-white rounded-2xl border border-slate-200 p-6 hover:shadow-xl hover:-translate-y-1 transition-all group relative overflow-hidden">
                            <div className="absolute top-0 right-0 w-24 h-24 bg-gradient-to-br from-indigo-50 to-transparent rounded-bl-full -mr-10 -mt-10 transition group-hover:scale-110"></div>

                            <div className="flex items-start justify-between mb-4 relative z-10">
                                <div className="w-12 h-12 bg-slate-50 rounded-xl flex items-center justify-center border border-slate-100">
                                    {getIcon(resource.type || 'file')}
                                </div>
                                <span className="px-2 py-1 bg-slate-100 text-slate-500 text-[10px] font-black uppercase rounded tracking-wider">
                                    {resource.category}
                                </span>
                            </div>

                            <h3 className="text-lg font-bold text-slate-800 mb-2 line-clamp-2 leading-tight group-hover:text-indigo-700 transition-colors">
                                {resource.title}
                            </h3>
                            <p className="text-xs text-slate-400 font-medium mb-6">
                                Subido el {resource.createdAt?.toDate().toLocaleDateString()}
                            </p>

                            <a
                                href={resource.url}
                                target="_blank"
                                rel="noreferrer"
                                className="flex items-center justify-center gap-2 w-full py-3 bg-slate-50 hover:bg-indigo-600 hover:text-white text-slate-600 rounded-xl font-bold text-sm transition-colors border border-slate-200 hover:border-indigo-600"
                            >
                                <Download className="w-4 h-4" />
                                Descargar
                            </a>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
};

export default ResourcesPanel;



================================================================================
FILE: src\components\ShiftPlanner.jsx
================================================================================
import React, { useState, useEffect, useCallback } from 'react';
import { Calendar, Clock, User, AlertTriangle, Plus, Trash2, Save, MoveRight } from 'lucide-react';
import { db } from '../lib/firebase';
import { collection, addDoc, getDocs, deleteDoc, doc, query, orderBy } from 'firebase/firestore';

// Dias de la semana
const DAYS = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
const ZONES = ['Norte', 'Centro', 'Sur'];
const MOCK_RIDERS = ['Juan P√©rez', 'Ana Garc√≠a', 'Carlos Ruiz', 'Sof√≠a L√≥pez'];

const ShiftPlanner = () => {
    const [shifts, setShifts] = useState([]);
    const riders = MOCK_RIDERS;

    // Form State
    const [newShift, setNewShift] = useState({
        day: 'Viernes',
        startTime: '20:00',
        endTime: '23:00',
        riderName: '',
        zone: 'Centro'
    });

    const fetchShifts = useCallback(async () => {
        // BUNKER MODE: Load from cache
        const cached = localStorage.getItem('shifts_cache');
        if (cached) {
            setShifts(JSON.parse(cached));
        }

        try {
            const q = query(collection(db, "shifts"), orderBy("day"));
            const querySnapshot = await getDocs(q);
            const shiftData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            setShifts(shiftData);
            // BUNKER MODE: Update cache
            localStorage.setItem('shifts_cache', JSON.stringify(shiftData));
        } catch (error) {
            console.error("Error fetching shifts:", error);
            if (!cached) {
                setShifts([
                    { id: '1', day: 'Viernes', startTime: '20:00', endTime: '23:00', riderName: 'Juan P√©rez', zone: 'Centro' },
                    { id: '2', day: 'Viernes', startTime: '20:00', endTime: '23:00', riderName: 'Ana Garc√≠a', zone: 'Norte' },
                    { id: '3', day: 'S√°bado', startTime: '13:00', endTime: '16:00', riderName: 'Carlos Ruiz', zone: 'Centro' },
                ]);
            }
        }
    }, []); // Dependencies are stable (db, collection, getDocs, setShifts, localStorage)

    useEffect(() => {
        const timer = setTimeout(() => {
            fetchShifts();
        }, 0);
        return () => clearTimeout(timer);
    }, [fetchShifts]);

    const handleAddShift = async (e) => {
        e.preventDefault();
        try {
            await addDoc(collection(db, "shifts"), newShift);
            fetchShifts();
            setNewShift({ ...newShift, riderName: '' }); // Reset rider but keep times for faster entry
        } catch (error) {
            console.error("Error adding shift:", error);
        }
    };

    const handleDeleteShift = async (id) => {
        if (!window.confirm("¬øEliminar turno?")) return;
        try {
            await deleteDoc(doc(db, "shifts", id));
            fetchShifts();
        } catch (error) {
            console.error("Error deleting shift:", error);
        }
    };

    // Calculate Coverage Gaps (Simple Logic)
    const checkCoverage = () => {
        // Critical Slot: Friday 20:00-23:00
        const fridayNights = shifts.filter(s => s.day === 'Viernes' && s.startTime <= '20:00' && s.endTime >= '23:00');
        if (fridayNights.length < 2) return { status: 'danger', message: 'Alerta: Viernes Noche con baja cobertura (< 2 riders)' };

        // Critical Slot: Saturday 20:00-23:00
        const saturdayNights = shifts.filter(s => s.day === 'S√°bado' && s.startTime <= '20:00' && s.endTime >= '23:00');
        if (saturdayNights.length < 2) return { status: 'warning', message: 'Aviso: S√°bado Noche con cobertura justa' };

        return { status: 'ok', message: 'Cobertura operativa √≥ptima' };
    };

    const coverageStatus = checkCoverage();

    return (
        <div className="space-y-6 animate-fade-in">
            {/* Header */}
            <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 bg-slate-800/50 p-6 rounded-xl border border-slate-700/50 backdrop-blur-sm">
                <div>
                    <h2 className="text-2xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent flex items-center gap-3">
                        <Calendar className="text-purple-400" /> Planificador de Turnos
                    </h2>
                    <p className="text-slate-400 mt-1">Gesti√≥n visual de horarios y cobertura operativa</p>
                </div>

                {/* Coverage Alert Badge */}
                {coverageStatus.status !== 'ok' && (
                    <div className={`flex items - center gap - 2 px - 4 py - 2 rounded - lg border ${coverageStatus.status === 'danger' ? 'bg-rose-500/20 border-rose-500/40 text-rose-300' : 'bg-orange-500/20 border-orange-500/40 text-orange-300'} `}>
                        <AlertTriangle size={18} />
                        <span className="text-sm font-bold">{coverageStatus.message}</span>
                    </div>
                )}
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                {/* Input Form */}
                <div className="lg:col-span-1 bg-white dark:bg-slate-800 p-6 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm">
                    <h3 className="text-lg font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2">
                        <Plus className="w-5 h-5 text-purple-500" /> Nuevo Turno
                    </h3>
                    <form onSubmit={handleAddShift} className="space-y-4">
                        <div>
                            <label className="text-xs font-bold text-slate-500 uppercase">D√≠a</label>
                            <select className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-2.5 mt-1 text-slate-800 dark:text-slate-200 focus:ring-2 focus:ring-purple-500"
                                value={newShift.day} onChange={e => setNewShift({ ...newShift, day: e.target.value })}>
                                {DAYS.map(d => <option key={d} value={d}>{d}</option>)}
                            </select>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="text-xs font-bold text-slate-500 uppercase">Inicio</label>
                                <input type="time" className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-2.5 mt-1 text-slate-800 dark:text-slate-200"
                                    value={newShift.startTime} onChange={e => setNewShift({ ...newShift, startTime: e.target.value })} required />
                            </div>
                            <div>
                                <label className="text-xs font-bold text-slate-500 uppercase">Fin</label>
                                <input type="time" className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-2.5 mt-1 text-slate-800 dark:text-slate-200"
                                    value={newShift.endTime} onChange={e => setNewShift({ ...newShift, endTime: e.target.value })} required />
                            </div>
                        </div>
                        <div>
                            <label className="text-xs font-bold text-slate-500 uppercase">Rider</label>
                            <select className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-2.5 mt-1 text-slate-800 dark:text-slate-200"
                                value={newShift.riderName} onChange={e => setNewShift({ ...newShift, riderName: e.target.value })} required>
                                <option value="">Seleccionar Rider...</option>
                                {riders.map(r => <option key={r} value={r}>{r}</option>)}
                            </select>
                        </div>
                        <div>
                            <label className="text-xs font-bold text-slate-500 uppercase">Zona</label>
                            <div className="flex gap-2 mt-1">
                                {ZONES.map(z => (
                                    <button
                                        type="button"
                                        key={z}
                                        onClick={() => setNewShift({ ...newShift, zone: z })}
                                        className={`flex - 1 py - 2 rounded - lg text - xs font - bold transition - all ${newShift.zone === z ? 'bg-purple-100 text-purple-700 border border-purple-200' : 'bg-slate-50 text-slate-500 border border-slate-200 hover:bg-slate-100'} `}
                                    >
                                        {z}
                                    </button>
                                ))}
                            </div>
                        </div>
                        <button type="submit" className="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded-lg shadow-lg hover:shadow-purple-500/25 transition-all flex items-center justify-center gap-2">
                            <Save size={18} /> Asignar Turno
                        </button>
                    </form>
                </div>

                {/* Weekly Grid */}
                <div className="lg:col-span-2 space-y-4">
                    {DAYS.map(day => {
                        const dayShifts = shifts.filter(s => s.day === day).sort((a, b) => a.startTime.localeCompare(b.startTime));
                        const isToday = new Date().toLocaleDateString('es-ES', { weekday: 'long' }).toLowerCase() === day.toLowerCase();

                        return (
                            <div key={day} className={`bg - white dark: bg - slate - 800 rounded - xl border ${isToday ? 'border-purple-500/50 shadow-purple-500/10' : 'border-slate-200 dark:border-slate-700'} overflow - hidden`}>
                                <div className={`px - 4 py - 2 bg - slate - 50 dark: bg - slate - 900 / 50 border - b border - slate - 100 dark: border - slate - 700 flex justify - between items - center ${isToday ? 'bg-purple-50 dark:bg-purple-900/10' : ''} `}>
                                    <span className={`font - bold ${isToday ? 'text-purple-600 dark:text-purple-400' : 'text-slate-500'} `}>{day}</span>
                                    <span className="text-xs bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 px-2 py-0.5 rounded-full">{dayShifts.length} turnos</span>
                                </div>
                                <div className="p-3 grid grid-cols-1 md:grid-cols-2 gap-3">
                                    {dayShifts.length === 0 ? (
                                        <div className="text-slate-400 text-xs text-center py-2 italic col-span-full">Sin turnos asignados</div>
                                    ) : (
                                        dayShifts.map(shift => (
                                            <div key={shift.id} className="flex items-center justify-between p-2.5 rounded-lg bg-slate-50 dark:bg-slate-900 border border-slate-100 dark:border-slate-700 group hover:border-purple-200 transition-colors">
                                                <div className="flex items-center gap-3">
                                                    <div className="w-8 h-8 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center text-slate-500 text-xs font-bold">
                                                        {shift.riderName.substring(0, 2).toUpperCase()}
                                                    </div>
                                                    <div>
                                                        <p className="text-sm font-bold text-slate-700 dark:text-slate-200">{shift.riderName}</p>
                                                        <div className="flex items-center gap-1.5 text-xs text-slate-500">
                                                            <Clock size={10} />
                                                            <span>{shift.startTime} - {shift.endTime}</span>
                                                            <span className="w-1 h-1 rounded-full bg-slate-300 mx-1" />
                                                            <span>{shift.zone}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <button
                                                    onClick={() => handleDeleteShift(shift.id)}
                                                    className="p-1.5 text-slate-400 hover:text-rose-500 hover:bg-rose-50 rounded-lg opacity-0 group-hover:opacity-100 transition-all"
                                                >
                                                    <Trash2 size={16} />
                                                </button>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        );
                    })}
                </div>
            </div>
        </div>
    );
};

export default ShiftPlanner;



================================================================================
FILE: src\components\support\NewTicketForm.jsx
================================================================================
import React, { useState } from 'react';
import { HelpCircle, CheckCircle, AlertTriangle, Paperclip, Send, Loader2 } from 'lucide-react';
import { CATEGORIES } from './ResourceLibrary';

const NewTicketForm = ({
    onSubmit,
    onSubjectChange,
    sending,
    success,
    suggestions = [],
    setSuccess,
    file,
    setFile,
    uploading
}) => {
    const [subject, setSubject] = useState('');
    const [message, setMessage] = useState('');
    const [urgency, setUrgency] = useState('normal');
    const [category, setCategory] = useState('operativa');

    const handleSubjectInput = (e) => {
        const val = e.target.value;
        setSubject(val);
        onSubjectChange(val);
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        const done = await onSubmit({ subject, message, urgency, category });
        if (done) {
            // Reset local form if specific needs
            setSubject('');
            setMessage('');
            setCategory('operativa');
            setUrgency('normal');
        }
    };

    if (success) {
        return (
            <div className="lg:col-span-2 bg-white rounded-3xl shadow-xl shadow-slate-200/50 border border-slate-100 p-8 h-full flex flex-col items-center justify-center text-center animate-in zoom-in-95 duration-500">
                <div className="w-24 h-24 bg-emerald-50 rounded-full flex items-center justify-center mb-6 animate-bounce">
                    <CheckCircle className="w-12 h-12 text-emerald-500" />
                </div>
                <h3 className="text-3xl font-black text-slate-800 mb-3">¬°Recibido!</h3>
                <p className="text-slate-500 mb-8 max-w-md mx-auto">Tu ticket ha sido creado correctamente.</p>
                <button
                    onClick={() => setSuccess(false)}
                    className="px-8 py-3 bg-slate-900 text-white rounded-xl font-bold hover:bg-slate-800 transition"
                >
                    Volver al formulario
                </button>
            </div>
        );
    }

    return (
        <section className="grid grid-cols-1 lg:grid-cols-3 gap-12 animate-in slide-in-from-bottom-4 duration-500 delay-300">
            {/* Left Sidebar: Type Selector */}
            <div className="lg:col-span-1">
                <div className="bg-slate-50 rounded-3xl p-8 border border-slate-100">
                    <div className="flex items-center space-x-4 mb-6">
                        <div className="w-12 h-12 bg-white rounded-xl flex items-center justify-center shadow-md text-rose-500">
                            <HelpCircle className="w-6 h-6" />
                        </div>
                        <div>
                            <h2 className="text-2xl font-black text-slate-800">Nuevo Ticket</h2>
                            <p className="text-slate-500 text-sm">Crear consulta</p>
                        </div>
                    </div>

                    <p className="text-slate-600 mb-8 text-sm leading-relaxed">
                        Selecciona la categor√≠a adecuada para asegurar que tu consulta llegue al especialista correcto.
                    </p>

                    <div className="space-y-3">
                        {CATEGORIES.map(cat => (
                            <button
                                key={cat.id}
                                type="button"
                                onClick={() => setCategory(cat.id)}
                                className={`w-full text-left p-3 rounded-xl border-2 transition-all flex items-center gap-3 ${category === cat.id
                                    ? `bg-white border-${cat.color}-500 shadow-md transform scale-[1.02]`
                                    : 'bg-white border-transparent hover:border-slate-200 text-slate-400 grayscale hover:grayscale-0'
                                    }`}
                            >
                                <cat.icon className={`w-5 h-5 ${category === cat.id ? `text-${cat.color}-600` : ''}`} />
                                <span className={`font-bold text-sm ${category === cat.id ? 'text-slate-800' : ''}`}>{cat.label}</span>
                                {category === cat.id && <CheckCircle className="w-4 h-4 ml-auto text-emerald-500" />}
                            </button>
                        ))}
                    </div>
                </div>

                <div className="mt-6 bg-gradient-to-br from-blue-900 to-violet-900 text-white p-6 rounded-2xl relative overflow-hidden shadow-xl group cursor-pointer hover:shadow-2xl transition-all">
                    <div className="relative z-10 flex items-center justify-between">
                        <div>
                            <h4 className="font-bold text-lg">¬øUrgencia Vital?</h4>
                            <p className="text-blue-200 text-xs mt-1">Accidentes graves SOS</p>
                        </div>
                        <div className="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center backdrop-blur-sm group-hover:bg-white/20 transition">
                            <AlertTriangle className="w-5 h-5 text-rose-300" />
                        </div>
                    </div>
                    <div className="absolute top-0 right-0 w-32 h-32 bg-rose-500 rounded-full mix-blend-overlay filter blur-2xl opacity-20 animate-pulse"></div>
                </div>
            </div>

            {/* Right: Form */}
            <div className="lg:col-span-2">
                <div className="bg-white rounded-3xl shadow-xl shadow-slate-200/50 border border-slate-100 p-8 h-full">
                    <form onSubmit={handleSubmit} className="space-y-6">
                        {/* Subject */}
                        <div>
                            <label className="block text-sm font-bold text-slate-700 mb-2 uppercase tracking-wide">Asunto</label>
                            <input
                                type="text"
                                value={subject}
                                onChange={handleSubjectInput}
                                className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 transition font-bold text-slate-700"
                                placeholder="Ej: Problema con la facturaci√≥n..."
                                required
                            />
                            {/* Suggestions */}
                            {suggestions.length > 0 && (
                                <div className="mt-3 grid gap-2 animate-in fade-in slide-in-from-top-2 duration-300">
                                    <p className="text-xs font-bold text-slate-400 uppercase ml-1">¬øTe refieres a esto?</p>
                                    {suggestions.map(article => (
                                        <div key={article.id} className="bg-blue-50 border border-blue-100 p-3 rounded-xl flex justify-between items-center group hover:bg-blue-100 transition cursor-pointer">
                                            <div>
                                                <h5 className="text-sm font-bold text-blue-800">{article.title}</h5>
                                                <p className="text-xs text-blue-600/80">{article.excerpt}</p>
                                            </div>
                                            <a href={article.link} target="_blank" rel="noreferrer" className="bg-white text-blue-600 px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm group-hover:shadow transition">
                                                Leer Gu√≠a
                                            </a>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>

                        {/* Urgency */}
                        <div className="space-y-2">
                            <label className="text-xs font-bold text-slate-400 uppercase tracking-wider">Nivel de Urgencia</label>
                            <div className="flex gap-2">
                                {[
                                    { val: 'normal', label: 'Normal', color: 'slate' },
                                    { val: 'high', label: 'Alta', color: 'amber' },
                                    { val: 'critical', label: 'Cr√≠tica', color: 'rose' }
                                ].map(opt => (
                                    <button
                                        key={opt.val}
                                        type="button"
                                        onClick={() => setUrgency(opt.val)}
                                        className={`flex-1 py-3 rounded-xl text-sm font-bold border-2 transition-all ${urgency === opt.val
                                            ? `bg-${opt.color}-50 border-${opt.color}-500 text-${opt.color}-700`
                                            : 'bg-slate-50 border-transparent text-slate-400 hover:bg-slate-100'
                                            }`}
                                    >
                                        {opt.label}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Message */}
                        <div className="space-y-2">
                            <label className="text-xs font-bold text-slate-400 uppercase tracking-wider">Detalles</label>
                            <textarea
                                required
                                value={message}
                                onChange={(e) => setMessage(e.target.value)}
                                rows="6"
                                className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3.5 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition placeholder:text-slate-400 resize-none font-medium text-slate-600"
                                placeholder="Explica qu√© sucede con el mayor detalle posible..."
                            ></textarea>
                        </div>

                        {/* File Upload */}
                        <div className="space-y-2">
                            <label className="text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2">
                                <Paperclip className="w-4 h-4" /> Adjuntar Archivo
                            </label>
                            <div className="relative">
                                <input
                                    type="file"
                                    onChange={(e) => setFile(e.target.files[0])}
                                    className="w-full text-sm text-slate-500 font-medium file:mr-4 file:py-2.5 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-bold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer"
                                />
                                {uploading && (
                                    <div className="absolute right-0 top-1/2 -translate-y-1/2 pr-4 flex items-center gap-2 text-blue-600 font-bold text-xs">
                                        <Loader2 className="w-4 h-4 animate-spin" /> Subiendo...
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Submit */}
                        <div className="flex justify-end pt-4">
                            <button
                                type="submit"
                                disabled={sending}
                                className={`flex items-center px-8 py-4 bg-slate-900 text-white font-bold rounded-xl shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all ${sending ? 'opacity-80 cursor-wait' : ''}`}
                            >
                                {sending ? (
                                    <>
                                        <Loader2 className="w-5 h-5 mr-3 animate-spin" /> Enviando...
                                    </>
                                ) : (
                                    <>
                                        <Send className="w-5 h-5 mr-3" /> Enviar Ticket
                                    </>
                                )}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </section>
    );
};

export default NewTicketForm;



================================================================================
FILE: src\components\support\ResourceLibrary.jsx
================================================================================
import React from 'react';
import { BookOpen, AlertCircle, Settings, LifeBuoy, Video, Package, DollarSign, Wrench, AlertTriangle, ArrowRight } from 'lucide-react';

const CATEGORIES = [
    { id: 'operativa', label: 'Operativa', icon: Package, color: 'indigo', desc: 'Log√≠stica, riders, rutas' },
    { id: 'finanzas', label: 'Finanzas', icon: DollarSign, color: 'emerald', desc: 'Facturas, pagos, impuestos' },
    { id: 'tecnico', label: 'T√©cnico', icon: Wrench, color: 'slate', desc: 'Motos, mantenimiento, app' },
    { id: 'accidente', label: 'Accidente', icon: AlertTriangle, color: 'rose', desc: 'Siniestros, seguros' },
];

const MANUALS = [
    { title: 'Protocolo Accidentes', icon: AlertCircle, color: 'text-rose-500', bg: 'bg-rose-50', category: 'accidente', desc: 'Pasos a seguir en caso de siniestro.' },
    { title: 'Mantenimiento Motos', icon: Settings, color: 'text-slate-500', bg: 'bg-slate-50', category: 'tecnico', desc: 'Gu√≠a b√°sica de revisi√≥n de flota Yamaha.' },
    { title: 'Atenci√≥n al Cliente', icon: LifeBuoy, color: 'text-blue-500', bg: 'bg-blue-50', category: 'operativa', desc: 'Scripts y resoluci√≥n de conflictos.' },
    { title: 'Video Tutorial App', icon: Video, color: 'text-blue-500', bg: 'bg-blue-50', category: 'tecnico', desc: 'Formaci√≥n para nuevos riders.' },
];

const ResourceLibrary = () => {
    return (
        <section className="animate-in slide-in-from-bottom-4 duration-500 delay-100">
            <div className="flex items-center space-x-4 mb-6">
                <div className="w-14 h-14 bg-gradient-to-br from-blue-600 to-purple-600 rounded-2xl flex items-center justify-center shadow-lg shadow-blue-200">
                    <BookOpen className="w-7 h-7 text-white" />
                </div>
                <div>
                    <h2 className="text-3xl font-black text-slate-800 tracking-tight">Centro de Recursos</h2>
                    <p className="text-slate-500 font-medium">Documentaci√≥n y manuales para el √©xito</p>
                </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                {MANUALS.map((m, i) => (
                    <div
                        key={i}
                        className="bg-white rounded-2xl border-2 border-slate-100 shadow-sm p-6 hover:shadow-xl hover:border-blue-200 transition-all cursor-pointer group hover:-translate-y-1 duration-300 relative overflow-hidden"
                    >
                        <div className={`w-14 h-14 rounded-xl ${m.bg} flex items-center justify-center mb-4 group-hover:scale-110 transition-transform shadow-sm`}>
                            <m.icon className={`w-7 h-7 ${m.color}`} />
                        </div>
                        <h3 className="font-black text-slate-800 mb-2 text-lg">{m.title}</h3>
                        <p className="text-sm text-slate-500 leading-snug mb-3">{m.desc}</p>
                        <div className="flex justify-between items-center mt-4">
                            <span className="inline-block text-[10px] font-bold px-2 py-1 bg-slate-50 text-slate-500 rounded-lg uppercase tracking-wider">
                                {CATEGORIES.find(c => c.id === m.category)?.label || 'General'}
                            </span>
                            <div className="w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity transform translate-x-2 group-hover:translate-x-0">
                                <ArrowRight className="w-4 h-4 text-slate-400" />
                            </div>
                        </div>
                    </div>
                ))}
            </div>
        </section>
    );
};

export default ResourceLibrary;
export { CATEGORIES }; // Export for Form usage



================================================================================
FILE: src\components\support\TicketDetailModal.jsx
================================================================================
import React, { useState, useEffect, useRef } from 'react';
import { ArrowRight, Paperclip, LifeBuoy, Send, Loader2 } from 'lucide-react';
import { collection, query, orderBy, onSnapshot, addDoc, updateDoc, doc, serverTimestamp } from 'firebase/firestore';
import { db } from '../../lib/firebase';
import { useAuth } from '../../context/AuthContext';
import { getStatusConfig } from '../../lib/constants';
import ReactQuill from 'react-quill';

const TicketDetailModal = ({ ticket, onClose }) => {
    const { user } = useAuth();
    const [messages, setMessages] = useState([]);
    const [newMessage, setNewMessage] = useState('');
    const [sending, setSending] = useState(false);
    const messagesEndRef = useRef(null);

    useEffect(() => {
        const q = query(
            collection(db, "tickets", ticket.id, "messages"),
            orderBy("createdAt", "asc")
        );
        const unsubscribe = onSnapshot(q, (snapshot) => {
            const msgs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setMessages(msgs);
            setTimeout(() => messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }), 100);
        });
        return () => unsubscribe();
    }, [ticket.id]);

    const handleSendMessage = async (e) => {
        e.preventDefault();
        if (!newMessage.trim()) return;
        setSending(true);
        try {
            await addDoc(collection(db, "tickets", ticket.id, "messages"), {
                text: newMessage,
                senderId: user.uid,
                senderRole: 'user',
                createdAt: serverTimestamp(),
                isInternal: false
            });
            await updateDoc(doc(db, "tickets", ticket.id), {
                lastMessageAt: serverTimestamp(),
                read: false,
                status: 'open'
            });
            setNewMessage('');
        } catch (error) {
            console.error("Error sending message:", error);
        } finally {
            setSending(false);
        }
    };

    return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm animate-in fade-in duration-200">
            <div className="bg-white w-full max-w-2xl rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[85vh] animate-in zoom-in-95 duration-200">
                <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                    <div>
                        <h3 className="font-black text-xl text-slate-800 flex items-center gap-2">
                            {ticket.subject}
                            {(() => {
                                const status = getStatusConfig(ticket.status);
                                return (
                                    <span className={`text-[10px] uppercase px-2 py-0.5 rounded-full border ${status.bg} ${status.text} ${status.border}`}>
                                        {status.label}
                                    </span>
                                );
                            })()}
                        </h3>
                        <p className="text-sm text-slate-500 font-medium">Ticket #{ticket.id.slice(0, 8)}</p>
                    </div>
                    <button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full transition">
                        <ArrowRight className="w-5 h-5 text-slate-500 rotate-180" />
                    </button>
                </div>

                <div className="flex-1 overflow-y-auto p-6 space-y-4 bg-slate-50/30">
                    <div className="flex justify-end mb-8">
                        <div className="bg-blue-600 text-white p-4 rounded-2xl rounded-tr-sm max-w-[85%] shadow-md">
                            <p className="text-xs font-bold text-blue-200 mb-1">T√∫ (Descripci√≥n original)</p>
                            <p className="whitespace-pre-wrap">{ticket.message}</p>
                            {ticket.attachmentUrl && (
                                <div className="mt-3 pt-3 border-t border-blue-500/30">
                                    <a href={ticket.attachmentUrl} target="_blank" rel="noreferrer" className="flex items-center gap-2 text-xs font-bold text-blue-100 hover:text-white transition">
                                        <Paperclip className="w-3 h-3" /> Ver Archivo Adjunto
                                    </a>
                                </div>
                            )}
                        </div>
                    </div>

                    {messages.map(msg => {
                        const isMe = msg.senderRole === 'user';
                        if (msg.isInternal) return null;
                        return (
                            <div key={msg.id} className={`flex ${isMe ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[85%] rounded-2xl p-4 shadow-sm ${isMe ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-white border border-slate-200 text-slate-700 rounded-tl-none'}`}>
                                    {!isMe && (
                                        <p className="text-xs font-bold text-blue-600 mb-1 flex items-center gap-1">
                                            <LifeBuoy className="w-3 h-3" /> Soporte HQ
                                        </p>
                                    )}
                                    <div className={`prose prose-sm ${isMe ? 'prose-invert' : 'prose-slate'}`} dangerouslySetInnerHTML={{ __html: msg.text }} />
                                    <span className={`text-[10px] mt-2 block ${isMe ? 'text-blue-200' : 'text-slate-400'}`}>
                                        {msg.createdAt?.toDate ? msg.createdAt.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : ''}
                                    </span>
                                </div>
                            </div>
                        );
                    })}
                    <div ref={messagesEndRef} />
                </div>

                <div className="p-4 bg-white border-t border-slate-100">
                    <form onSubmit={handleSendMessage} className="p-4 bg-white border-t border-slate-200 flex items-end gap-2">
                        <div className="flex-1 bg-slate-50 rounded-xl border border-slate-200 focus-within:ring-2 focus-within:ring-blue-500 transition-all">
                            <ReactQuill theme="snow" value={newMessage} onChange={setNewMessage} placeholder="Responder..." className="bg-transparent border-none" modules={{ toolbar: false }} />
                        </div>
                        <button type="submit" disabled={sending || !newMessage.trim()} className="p-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 shadow-lg shadow-blue-200">
                            {sending ? <Loader2 className="w-5 h-5 animate-spin" /> : <Send className="w-5 h-5" />}
                        </button>
                    </form>
                </div>
            </div>
        </div>
    );
};

export default TicketDetailModal;



================================================================================
FILE: src\components\support\TicketHistory.jsx
================================================================================
import React, { useState } from 'react';
import { MessageSquare, CheckCircle, Clock } from 'lucide-react';
import { getStatusConfig } from '../../lib/constants';
import EmptyState from '../ui/EmptyState';
import { CATEGORIES } from './ResourceLibrary';
import TicketDetailModal from './TicketDetailModal';

const TicketSkeleton = () => (
    <div className="bg-white rounded-2xl border border-slate-100 p-6 space-y-4 animate-pulse">
        <div className="flex justify-between items-start">
            <div className="w-10 h-10 bg-slate-100 rounded-lg"></div>
            <div className="w-20 h-6 bg-slate-100 rounded-full"></div>
        </div>
        <div className="space-y-2">
            <div className="w-3/4 h-6 bg-slate-100 rounded"></div>
            <div className="w-full h-4 bg-slate-100 rounded"></div>
        </div>
    </div>
);

const TicketHistory = React.memo(({ tickets, loading, filter, setFilter, allCount, filteredCount }) => {
    const [selectedTicket, setSelectedTicket] = useState(null);

    return (
        <section className="animate-in slide-in-from-bottom-4 duration-500 delay-200">
            <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
                <div className="flex items-center space-x-4">
                    <div className="w-14 h-14 bg-gradient-to-br from-emerald-500 to-teal-500 rounded-2xl flex items-center justify-center shadow-lg shadow-emerald-100">
                        <MessageSquare className="w-7 h-7 text-white" />
                    </div>
                    <div>
                        <h2 className="text-3xl font-black text-slate-800 tracking-tight">Mis Tickets</h2>
                        <p className="text-slate-500 font-medium">Historial de soporte</p>
                    </div>
                </div>
                <div className="bg-slate-100 p-1 rounded-xl inline-flex self-start md:self-auto">
                    {['all', 'open', 'resolved'].map(f => (
                        <button
                            key={f}
                            onClick={() => setFilter(f)}
                            className={`px-4 py-2 rounded-lg text-sm font-bold transition-all ${filter === f ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                        >
                            {f === 'all' ? 'Todos' : f === 'open' ? 'Abiertos' : 'Resueltos'}
                            <span className="ml-2 text-xs opacity-50 bg-slate-200 px-1.5 py-0.5 rounded-full">
                                {f === 'all' ? allCount : filteredCount}
                            </span>
                        </button>
                    ))}
                </div>
            </div>

            {loading ? (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <TicketSkeleton /><TicketSkeleton /><TicketSkeleton />
                </div>
            ) : tickets.length === 0 ? (
                <EmptyState icon={MessageSquare} title="No hay tickets" description="Tus consultas aparecer√°n aqu√≠." className="py-12 bg-slate-50/50 border-2 border-dashed border-slate-200" />
            ) : (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {tickets.map(ticket => {
                        const categoryData = CATEGORIES.find(c => c.id === ticket.category) || CATEGORIES[0];
                        const CategoryIcon = categoryData.icon;
                        const status = getStatusConfig(ticket.status);

                        return (
                            <div key={ticket.id} className="bg-white rounded-2xl border border-slate-200 p-6 hover:shadow-xl transition-all hover:-translate-y-1 hover:border-blue-200 group relative overflow-hidden">
                                <div className={`absolute top-0 left-0 w-full h-1 ${ticket.status === 'resolved' ? 'bg-emerald-500' : 'bg-blue-500'}`}></div>
                                <div className="flex items-center justify-between mb-4 mt-1">
                                    <div className={`w-10 h-10 bg-${categoryData.color}-50 rounded-lg flex items-center justify-center`}>
                                        <CategoryIcon className={`w-5 h-5 text-${categoryData.color}-600`} />
                                    </div>
                                    <div className={`flex items-center space-x-1 px-3 py-1 rounded-full text-xs font-black uppercase tracking-wider border ${status.bg} ${status.text} ${status.border}`}>
                                        {ticket.status === 'resolved' ? <CheckCircle className="w-3 h-3" /> : <Clock className="w-3 h-3" />}
                                        <span>{status.label}</span>
                                    </div>
                                </div>
                                <h3 className="font-bold text-slate-800 mb-2 text-lg line-clamp-1">{ticket.subject}</h3>
                                <p className="text-sm text-slate-500 mb-5 line-clamp-2 h-10">{ticket.message}</p>
                                {ticket.response && (
                                    <div className="bg-blue-50/50 p-4 rounded-xl border border-blue-100 mb-5 text-sm text-blue-900 line-clamp-2">
                                        <span className="font-bold text-blue-800 block text-xs uppercase mb-1">Respuesta HQ</span>
                                        {ticket.response}
                                    </div>
                                )}
                                <div className="mt-4 pt-4 border-t border-slate-50 flex justify-between items-center">
                                    <div className="text-xs font-medium text-slate-400">
                                        {ticket.createdAt?.toDate ? ticket.createdAt.toDate().toLocaleDateString() : 'Hoy'}
                                    </div>
                                    <button onClick={() => setSelectedTicket(ticket)} className="text-xs font-bold text-blue-600 hover:text-blue-800 bg-blue-50 hover:bg-blue-100 px-3 py-1.5 rounded-lg transition-colors">
                                        Ver Chat
                                    </button>
                                </div>
                            </div>
                        );
                    })}
                </div>
            )}

            {selectedTicket && <TicketDetailModal ticket={selectedTicket} onClose={() => setSelectedTicket(null)} />}
        </section>
    );
});

export default TicketHistory;



================================================================================
FILE: src\components\SupportHub.jsx
================================================================================
import React from 'react';
import { useAuth } from '../context/AuthContext';
import { useSupportHub } from '../hooks/useSupportHub';
import ResourceLibrary from './support/ResourceLibrary';
import TicketHistory from './support/TicketHistory';
import NewTicketForm from './support/NewTicketForm';

const SupportHub = () => {
    const { user } = useAuth();

    // Logic Hook
    const {
        tickets,
        allTicketsCount,
        loading,
        sending,
        success,
        suggestions,
        file,
        uploading,
        ticketFilter,
        setTicketFilter,
        handleSubjectChange,
        createTicket,
        setSuccess,
        setFile,
        setSuggestions
    } = useSupportHub(user);

    // Derived counts for UI badges
    const filteredCount = tickets.length;

    return (
        <div className="p-8 max-w-7xl mx-auto space-y-16 animate-in fade-in duration-700">
            {/* 1. Resources Area (Static) */}
            <ResourceLibrary />

            <div className="border-t border-slate-100"></div>

            {/* 2. Ticket History (Memoized List) */}
            <TicketHistory
                tickets={tickets}
                loading={loading}
                filter={ticketFilter}
                setFilter={setTicketFilter}
                allCount={allTicketsCount}
                filteredCount={filteredCount}
            />

            <div className="border-t border-slate-100"></div>

            {/* 3. New Ticket Form */}
            <NewTicketForm
                onSubmit={createTicket}
                onSubjectChange={handleSubjectChange}
                sending={sending}
                success={success}
                setSuccess={setSuccess} // To manually reset state
                suggestions={suggestions}
                file={file}
                setFile={setFile}
                uploading={uploading}
            />
        </div>
    );
};

export default SupportHub;



================================================================================
FILE: src\components\TariffEditor.jsx
================================================================================
import React, { useState, useEffect } from 'react';
import { doc, getDoc, setDoc } from 'firebase/firestore';
import { db } from '../lib/firebase';
import { TARIFFS as DEFAULT_TARIFFS } from '../lib/finance';
import { Save, RefreshCw, AlertCircle } from 'lucide-react';

const TariffEditor = ({ onClose }) => {
    const [tariffs, setTariffs] = useState(null);
    const [loading, setLoading] = useState(true);
    const [saving, setSaving] = useState(false);
    const [error, setError] = useState(null);

    // Load Tariffs
    useEffect(() => {
        const loadTariffs = async () => {
            try {
                const docRef = doc(db, 'config', 'tariffs');
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    setTariffs(docSnap.data());
                } else {
                    // Initialize with defaults if not found
                    setTariffs(DEFAULT_TARIFFS);
                }
            } catch (err) {
                console.error("Error loading tariffs:", err);
                setError("Ocurri√≥ un error al cargar las tarifas.");
                // Fallback to defaults to show something
                setTariffs(DEFAULT_TARIFFS);
            } finally {
                setLoading(false);
            }
        };

        loadTariffs();
    }, []);

    const handleChange = (section, key, value) => {
        setTariffs(prev => ({
            ...prev,
            [section]: {
                ...prev[section],
                [key]: parseFloat(value) || 0
            }
        }));
    };

    const handleSave = async () => {
        setSaving(true);
        setError(null);
        try {
            await setDoc(doc(db, 'config', 'tariffs'), tariffs);
            // Optional: User feedback or just close
            if (onClose) onClose();
            else alert("Tarifas guardadas correctamente. Los cambios se aplicar√°n al recargar.");
        } catch (err) {
            console.error("Error saving tariffs:", err);
            setError("Error al guardar en la nube.");
        } finally {
            setSaving(false);
        }
    };

    if (loading) return <div className="p-8 text-center text-slate-500">Cargando configuraci√≥n...</div>;

    return (
        <div className="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
            <div className="bg-slate-900 p-4 flex justify-between items-center text-white">
                <h3 className="font-bold flex items-center gap-2">
                    <RefreshCw className="w-4 h-4" /> Configuraci√≥n de Tarifas
                </h3>
            </div>

            <div className="p-6">
                {error && (
                    <div className="mb-4 bg-rose-50 text-rose-600 p-3 rounded-lg text-sm flex items-center">
                        <AlertCircle className="w-4 h-4 mr-2" /> {error}
                    </div>
                )}

                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                    {/* NEW TARIFFS */}
                    <div>
                        <h4 className="font-bold text-slate-800 mb-4 border-b pb-2">Tarifa "Nueva" (Por tramos)</h4>
                        <div className="space-y-4">
                            {Object.entries(tariffs.NEW || {}).map(([range, price]) => (
                                <div key={range} className="flex items-center justify-between">
                                    <label className="text-sm font-medium text-slate-600">Km {range}</label>
                                    <div className="relative w-32">
                                        <input
                                            type="number"
                                            step="0.10"
                                            value={price}
                                            onChange={(e) => handleChange('NEW', range, e.target.value)}
                                            className="w-full pl-6 pr-3 py-1.5 text-right border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 outline-none"
                                        />
                                        <span className="absolute left-2 top-1.5 text-slate-400 text-sm">‚Ç¨</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* OLD TARIFFS */}
                    <div>
                        <h4 className="font-bold text-slate-800 mb-4 border-b pb-2">Tarifa "Antigua"</h4>
                        <div className="space-y-4">
                            {Object.entries(tariffs.OLD || {}).map(([range, price]) => (
                                <div key={range} className="flex items-center justify-between">
                                    <label className="text-sm font-medium text-slate-600">Km {range}</label>
                                    <div className="relative w-32">
                                        <input
                                            type="number"
                                            step="0.10"
                                            value={price}
                                            onChange={(e) => handleChange('OLD', range, e.target.value)}
                                            className="w-full pl-6 pr-3 py-1.5 text-right border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 outline-none"
                                        />
                                        <span className="absolute left-2 top-1.5 text-slate-400 text-sm">‚Ç¨</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>

                <div className="mt-8 flex justify-end gap-3 pt-6 border-t border-slate-100">
                    {onClose && (
                        <button
                            onClick={onClose}
                            className="px-4 py-2 text-slate-600 hover:bg-slate-50 rounded-lg transition"
                        >
                            Cancelar
                        </button>
                    )}
                    <button
                        onClick={handleSave}
                        disabled={saving}
                        className="px-6 py-2 bg-indigo-600 text-white font-bold rounded-lg shadow-md hover:bg-indigo-700 disabled:opacity-50 transition flex items-center gap-2"
                    >
                        {saving ? <RefreshCw className="w-4 h-4 animate-spin" /> : <Save className="w-4 h-4" />}
                        Guardar Cambios
                    </button>
                </div>
            </div>
        </div>
    );
};

export default TariffEditor;



================================================================================
FILE: src\components\TaxVaultWidget.jsx
================================================================================
import React from 'react';
import { ShieldCheck, Lock, TrendingUp } from 'lucide-react';
import { formatMoney } from '../lib/finance';

const TaxVaultWidget = ({ taxes }) => {
    if (!taxes) return null;

    const { ivaAPagar, irpfPago } = taxes;
    const totalTax = ivaAPagar + irpfPago;

    // Simulate a "Safe" percentage (e.g., assuming we want to have 20% buffer)
    const safeTotal = totalTax * 1.0;

    return (
        <div className="glass-panel rounded-ios-xl p-6 relative overflow-hidden group">
            {/* Ambient Background */}
            <div className="absolute top-0 right-0 w-64 h-64 bg-emerald-400/10 rounded-full blur-3xl -mr-32 -mt-32 pointer-events-none" />
            <div className="absolute bottom-0 left-0 w-48 h-48 bg-indigo-400/5 rounded-full blur-2xl -ml-24 -mb-24 pointer-events-none" />

            <div className="relative z-10">
                {/* Header */}
                <div className="flex items-center justify-between mb-6">
                    <div className="flex items-center gap-3">
                        <div className="p-2.5 bg-gradient-to-br from-emerald-100 to-teal-50 rounded-xl shadow-sm border border-emerald-100">
                            <ShieldCheck className="w-5 h-5 text-emerald-600" />
                        </div>
                        <div>
                            <h3 className="font-bold text-slate-800 text-base tracking-tight">
                                Hucha de Impuestos
                            </h3>
                            <p className="text-xs text-slate-500 font-medium">Recomendaci√≥n de ahorro actual</p>
                        </div>
                    </div>
                </div>

                {/* Main Vault Value */}
                <div className="mb-6">
                    <div className="flex items-baseline gap-1">
                        <span className="text-4xl font-black text-slate-800 tracking-tight">
                            {formatMoney(safeTotal)}
                        </span>
                        <span className="text-2xl font-bold text-slate-400">‚Ç¨</span>
                    </div>
                    <div className="mt-1 flex items-center gap-2">
                        <span className="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-emerald-50 border border-emerald-100 text-emerald-700 text-[10px] font-bold uppercase tracking-wider">
                            <Lock className="w-3 h-3" />
                            Ahorro Sugerido
                        </span>
                    </div>
                </div>

                {/* Progress Visualizer */}
                <div className="space-y-4">
                    <div className="p-4 rounded-xl bg-white/50 border border-white/60 shadow-sm backdrop-blur-md">
                        <div className="flex justify-between items-end mb-2">
                            <div className="flex items-center gap-2">
                                <div className="w-2 h-2 rounded-full bg-indigo-500" />
                                <span className="text-xs font-semibold text-slate-600">IVA Acumulado</span>
                            </div>
                            <span className="text-sm font-bold text-slate-800">{formatMoney(ivaAPagar)}‚Ç¨</span>
                        </div>
                        <div className="w-full bg-slate-100 rounded-full h-1.5 overflow-hidden">
                            <div
                                className="h-full bg-indigo-500 rounded-full transition-all duration-1000 ease-out"
                                style={{ width: `${Math.min((ivaAPagar / totalTax) * 100, 100)}%` }}
                            />
                        </div>
                    </div>

                    <div className="p-4 rounded-xl bg-white/50 border border-white/60 shadow-sm backdrop-blur-md">
                        <div className="flex justify-between items-end mb-2">
                            <div className="flex items-center gap-2">
                                <div className="w-2 h-2 rounded-full bg-amber-500" />
                                <span className="text-xs font-semibold text-slate-600">IRPF Acumulado</span>
                            </div>
                            <span className="text-sm font-bold text-slate-800">{formatMoney(irpfPago)}‚Ç¨</span>
                        </div>
                        <div className="w-full bg-slate-100 rounded-full h-1.5 overflow-hidden">
                            <div
                                className="h-full bg-amber-500 rounded-full transition-all duration-1000 ease-out"
                                style={{ width: `${Math.min((irpfPago / totalTax) * 100, 100)}%` }}
                            />
                        </div>
                    </div>
                </div>

                {/* Bottom Note */}
                <div className="mt-6 pt-4 border-t border-slate-100/60">
                    <p className="text-xs text-slate-400 text-center text-balance leading-relaxed">
                        Este dinero no es tuyo. Gu√°rdalo mensualmente para evitar sorpresas en el trimestre.
                    </p>
                </div>
            </div>
        </div>
    );
};

export default TaxVaultWidget;



================================================================================
FILE: src\components\ThemeToggle.jsx
================================================================================
import React from 'react';
import { useTheme } from '../hooks/useTheme';
import { Sun, Moon } from 'lucide-react';

const ThemeToggle = ({ className = '' }) => {
    const { theme, toggleTheme } = useTheme();

    return (
        <button
            onClick={toggleTheme}
            className={`p-2 rounded-full transition-colors duration-200 ${theme === 'dark'
                ? 'bg-slate-700 text-yellow-400 hover:bg-slate-600'
                : 'bg-indigo-50 text-indigo-500 hover:bg-indigo-100'
                } ${className}`}
            title={theme === 'dark' ? 'Cambiar a Modo Claro' : 'Cambiar a Modo Oscuro'}
        >
            {theme === 'dark' ? <Sun className="w-5 h-5" /> : <Moon className="w-5 h-5" />}
        </button>
    );
};

export default ThemeToggle;



================================================================================
FILE: src\components\ui\Button.jsx
================================================================================
import React from 'react';

const variants = {
    primary: "bg-indigo-600 text-white hover:bg-indigo-700 focus:ring-indigo-500",
    secondary: "bg-white text-slate-700 border-slate-300 hover:bg-slate-50 focus:ring-indigo-500",
    danger: "bg-rose-600 text-white hover:bg-rose-700 focus:ring-rose-500",
    ghost: "bg-transparent text-slate-600 hover:bg-slate-100 hover:text-slate-900 focus:ring-indigo-500",
    outline: "bg-transparent border border-slate-300 text-slate-700 hover:bg-slate-50"
};

const sizes = {
    sm: "px-3 py-1.5 text-xs",
    md: "px-4 py-2 text-sm",
    lg: "px-5 py-3 text-base"
};

const Button = ({
    children,
    variant = 'primary',
    size = 'md',
    className = '',
    loading = false,
    icon: Icon,
    disabled,
    type = 'button',
    ...props
}) => {
    return (
        <button
            type={type}
            disabled={disabled || loading}
            className={`
        inline-flex items-center justify-center font-medium rounded-lg 
        transition-colors duration-200 shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-1 
        ${variants[variant] || variants.primary} 
        ${sizes[size] || sizes.md} 
        ${(disabled || loading) ? 'opacity-50 cursor-not-allowed' : ''}
        ${className}
      `}
            {...props}
        >
            {loading && (
                <svg className="animate-spin -ml-1 mr-2 h-4 w-4 text-current" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                </svg>
            )}
            {!loading && Icon && <Icon className={`w-4 h-4 ${children ? 'mr-2' : ''}`} />}
            {children}
        </button>
    );
};

export default Button;



================================================================================
FILE: src\components\ui\Card.jsx
================================================================================
import React from 'react';

/**
 * Card Component - Professional surface container
 * 
 * @param {string} variant - Card elevation: 'flat' | 'low' | 'medium' | 'high' | 'elevated'
 * @param {string} className - Additional Tailwind classes
 * @param {boolean} interactive - Adds hover lift effect
 * @param {boolean} noPadding - Removes default padding
 * @param {React.ReactNode} children
 */
const Card = ({
    variant = 'medium',
    interactive = false,
    noPadding = false,
    className = '',
    children,
    ...props
}) => {
    // Elevation mapping to utility classes
    const elevationClasses = {
        flat: 'elevation-none',
        low: 'elevation-sm',
        medium: 'elevation-md',
        high: 'elevation-lg',
        elevated: 'elevation-xl'
    };

    const baseClasses = 'surface-raised rounded-xl transition-all duration-200';
    const elevationClass = elevationClasses[variant] || elevationClasses.medium;
    const interactiveClass = interactive ? 'hover-lift cursor-pointer' : '';
    const paddingClass = noPadding ? '' : 'p-6';

    return (
        <div
            className={`${baseClasses} ${elevationClass} ${interactiveClass} ${paddingClass} ${className}`}
            {...props}
        >
            {children}
        </div>
    );
};

export default Card;



================================================================================
FILE: src\components\ui\EmptyState.jsx
================================================================================
import React from 'react';
import Button from './Button';

const EmptyState = ({
    icon: Icon,
    title,
    description,
    actionLabel,
    onAction,
    className = ""
}) => {
    return (
        <div className={`flex flex-col items-center justify-center p-8 md:p-16 text-center bg-slate-50/50 rounded-3xl border border-slate-100 border-dashed animate-fade-in-up ${className}`}>
            <div className="bg-white p-4 rounded-2xl shadow-sm mb-4 ring-4 ring-slate-50">
                {Icon && <Icon className="w-8 h-8 md:w-10 md:h-10 text-slate-400" />}
            </div>
            <h3 className="text-lg md:text-xl font-bold text-slate-800 mb-2">{title}</h3>
            <p className="text-sm text-slate-500 max-w-sm mb-6 leading-relaxed">
                {description}
            </p>
            {actionLabel && onAction && (
                <Button onClick={onAction} variant="primary">
                    {actionLabel}
                </Button>
            )}
        </div>
    );
};

export default EmptyState;



================================================================================
FILE: src\components\ui\FileUploader.jsx
================================================================================
import React, { useState, useRef } from 'react';
import { storage } from '../../lib/firebase';
import { ref, uploadBytesResumable, getDownloadURL } from 'firebase/storage';
import { Upload, X, FileText, Video, CheckCircle, AlertCircle, Loader2 } from 'lucide-react';

/**
 * Professional File Uploader component
 * @param {string} path - Storage path prefix (e.g., 'resources/documents')
 * @param {string} acceptedTypes - HTML accept string (e.g., '.pdf, .mp4')
 * @param {function} onUploadComplete - Callback with { name, url, type, size }
 * @param {string} label - Custom label
 * @param {number} maxSizeMB - Max file size in MB
 */
const FileUploader = ({
    path = 'uploads',
    acceptedTypes = '*',
    onUploadComplete,
    label = 'Arrastra tus archivos aqu√≠',
    maxSizeMB = 50
}) => {
    const [dragActive, setDragActive] = useState(false);
    const [uploading, setUploading] = useState(false);
    const [progress, setProgress] = useState(0);
    const [error, setError] = useState(null);
    const inputRef = useRef(null);

    const handleDrag = (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (e.type === "dragenter" || e.type === "dragover") {
            setDragActive(true);
        } else if (e.type === "dragleave") {
            setDragActive(false);
        }
    };

    const validateFile = (file) => {
        if (!file) return false;

        // Size validation
        if (file.size > maxSizeMB * 1024 * 1024) {
            setError(`El archivo excede el tama√±o m√°ximo de ${maxSizeMB}MB`);
            return false;
        }

        // Type validation (simple check based on acceptedTypes string)
        if (acceptedTypes !== '*') {
            const fileExt = '.' + file.name.split('.').pop().toLowerCase();
            const fileType = file.type;
            const accepted = acceptedTypes.split(',').map(s => s.trim().toLowerCase());

            const isValid = accepted.some(type => {
                if (type.startsWith('.')) return fileExt === type;
                if (type.endsWith('/*')) return fileType.startsWith(type.replace('/*', ''));
                return fileType === type;
            });

            if (!isValid) {
                setError(`Tipo de archivo no permitido. Aceptados: ${acceptedTypes}`);
                return false;
            }
        }

        return true;
    };

    const handleUpload = async (file) => {
        setError(null);
        if (!validateFile(file)) return;

        setUploading(true);
        setProgress(0);

        // Create unique filename
        const timestamp = Date.now();
        const safeName = file.name.replace(/[^a-zA-Z0-9.]/g, '_');
        const storageRef = ref(storage, `${path}/${timestamp}_${safeName}`);

        const uploadTask = uploadBytesResumable(storageRef, file);

        uploadTask.on(
            'state_changed',
            (snapshot) => {
                const p = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                setProgress(p);
            },
            (err) => {
                console.error("Upload error:", err);
                setError("Error al subir el archivo. Int√©ntalo de nuevo.");
                setUploading(false);
            },
            async () => {
                const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                setUploading(false);
                setProgress(100);

                if (onUploadComplete) {
                    onUploadComplete({
                        name: file.name,
                        url: downloadURL,
                        type: file.type,
                        size: file.size
                    });
                }
            }
        );
    };

    const handleDrop = (e) => {
        e.preventDefault();
        e.stopPropagation();
        setDragActive(false);
        if (e.dataTransfer.files && e.dataTransfer.files[0]) {
            handleUpload(e.dataTransfer.files[0]);
        }
    };

    const handleChange = (e) => {
        e.preventDefault();
        if (e.target.files && e.target.files[0]) {
            handleUpload(e.target.files[0]);
        }
    };

    const handleButtonClick = () => {
        inputRef.current.click();
    };

    return (
        <div className="w-full">
            <div
                className={`
                    relative border-2 border-dashed rounded-xl p-8 text-center transition-all duration-200
                    ${dragActive ? 'border-blue-500 bg-blue-50' : 'border-slate-300 bg-white hover:bg-slate-50'}
                    ${uploading ? 'opacity-75 pointer-events-none' : ''}
                    ${error ? 'border-rose-300 bg-rose-50' : ''}
                `}
                onDragEnter={handleDrag}
                onDragLeave={handleDrag}
                onDragOver={handleDrag}
                onDrop={handleDrop}
            >
                <input
                    ref={inputRef}
                    type="file"
                    className="hidden"
                    accept={acceptedTypes}
                    onChange={handleChange}
                />

                <div className="flex flex-col items-center gap-3">
                    {uploading ? (
                        <div className="w-16 h-16 flex items-center justify-center text-blue-600">
                            <Loader2 className="w-8 h-8 animate-spin" />
                        </div>
                    ) : error ? (
                        <div className="w-16 h-16 bg-rose-100 rounded-full flex items-center justify-center text-rose-500 mb-2">
                            <AlertCircle className="w-8 h-8" />
                        </div>
                    ) : (
                        <div className="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center text-blue-500 mb-2 group-hover:scale-110 transition-transform">
                            <Upload className="w-8 h-8" />
                        </div>
                    )}

                    {uploading ? (
                        <div className="w-full max-w-xs">
                            <p className="text-sm font-bold text-blue-700 mb-2">Subiendo... {Math.round(progress)}%</p>
                            <div className="w-full bg-blue-100 rounded-full h-2 overflow-hidden">
                                <div className="bg-blue-600 h-2 transition-all duration-300" style={{ width: `${progress}%` }}></div>
                            </div>
                        </div>
                    ) : (
                        <>
                            <p className="text-sm font-bold text-slate-700">
                                {error ? <span className="text-rose-600">{error}</span> : label}
                            </p>
                            <p className="text-xs text-slate-400">
                                o haz click para seleccionar
                            </p>
                            <button
                                type="button"
                                onClick={handleButtonClick}
                                className="mt-2 px-4 py-1.5 bg-white border border-slate-300 rounded-lg text-xs font-bold text-slate-600 hover:bg-slate-50 hover:text-blue-600 transition"
                            >
                                Seleccionar Archivo
                            </button>
                        </>
                    )}
                </div>
            </div>
            {/* Accepted formats hint */}
            {!error && !uploading && (
                <div className="flex justify-between items-center mt-2 px-1">
                    <span className="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Formatos: {acceptedTypes === '*' ? 'Todos' : acceptedTypes}</span>
                    <span className="text-[10px] font-bold text-slate-400">Max: {maxSizeMB}MB</span>
                </div>
            )}
        </div>
    );
};

export default FileUploader;



================================================================================
FILE: src\components\ui\Skeleton.jsx
================================================================================
import React from 'react';

/**
 * Skeleton Component
 * Renders a pulsing placeholder to simulate content loading.
 * 
 * @param {string} className - Additional classes for sizing and spacing
 * @param {string} variant - 'text', 'circular', 'rectangular'
 */
const Skeleton = ({ className = '', variant = 'rectangular', ...props }) => {
    const baseClasses = "animate-pulse bg-slate-200/80 rounded";

    const variantClasses = {
        text: "h-4 w-full rounded",
        circular: "rounded-full",
        rectangular: "h-full w-full rounded-md",
    };

    return (
        <div
            className={`${baseClasses} ${variantClasses[variant] || ''} ${className}`}
            {...props}
        />
    );
};

export default Skeleton;



================================================================================
FILE: src\components\ui\Toast.jsx
================================================================================
import React, { useEffect, useState } from 'react';
import { X, CheckCircle, AlertCircle, Info, AlertTriangle } from 'lucide-react';

const icons = {
    success: <CheckCircle className="w-5 h-5 text-emerald-500" />,
    error: <AlertCircle className="w-5 h-5 text-rose-500" />,
    warning: <AlertTriangle className="w-5 h-5 text-amber-500" />,
    info: <Info className="w-5 h-5 text-blue-500" />
};

const styles = {
    success: "border-emerald-200 bg-emerald-50/90 text-emerald-800",
    error: "border-rose-200 bg-rose-50/90 text-rose-800",
    warning: "border-amber-200 bg-amber-50/90 text-amber-800",
    info: "border-blue-200 bg-blue-50/90 text-blue-800"
};

const Toast = ({ message, type = 'info', duration = 4000, onClose }) => {
    const [isVisible, setIsVisible] = useState(false);

    useEffect(() => {
        // Trigger enter animation
        requestAnimationFrame(() => setIsVisible(true));

        // Auto close timer
        const timer = setTimeout(() => {
            setIsVisible(false);
            // Wait for exit animation to finish before unmounting
            setTimeout(onClose, 300);
        }, duration);

        return () => clearTimeout(timer);
    }, [duration, onClose]);

    const handleClose = () => {
        setIsVisible(false);
        setTimeout(onClose, 300);
    };

    return (
        <div
            className={`
                pointer-events-auto flex items-center w-full max-w-sm overflow-hidden rounded-xl border shadow-lg backdrop-blur-md transition-all duration-300 ease-in-out transform
                ${isVisible ? 'translate-y-0 opacity-100 scale-100' : 'translate-y-8 opacity-0 scale-95'}
                ${styles[type] || styles.info}
            `}
            role="alert"
        >
            <div className="p-4 flex items-start gap-3 w-full">
                <div className="flex-shrink-0 mt-0.5">
                    {icons[type] || icons.info}
                </div>
                <div className="flex-1">
                    <p className="text-sm font-medium leading-5">
                        {message}
                    </p>
                </div>
                <div className="flex-shrink-0 ml-4">
                    <button
                        onClick={handleClose}
                        className="inline-flex text-current opacity-60 hover:opacity-100 focus:outline-none transition-opacity"
                    >
                        <X className="w-4 h-4" />
                    </button>
                </div>
            </div>
        </div>
    );
};

export default Toast;



================================================================================
FILE: src\components\ui\ToastContainer.jsx
================================================================================
import React from 'react';
import Toast from './Toast';

const ToastContainer = ({ toasts, removeToast }) => {
    return (
        <div className="fixed bottom-4 right-4 z-50 flex flex-col gap-2 pointer-events-none">
            {toasts.map((toast) => (
                <Toast key={toast.id} {...toast} onClose={() => removeToast(toast.id)} />
            ))}
        </div>
    );
};

export default ToastContainer;



================================================================================
FILE: src\components\UpdatePrompt.jsx
================================================================================
import React from 'react';
// import { useRegisterSW } from 'virtual:pwa-register/react'; // Disabled for debugging
// import { RefreshCw } from 'lucide-react';

const UpdatePrompt = () => {
    // Disabled PWA check for debugging deployment issues
    return null;
};

export default UpdatePrompt;



================================================================================
FILE: src\components\user-profile\AdminTab.jsx
================================================================================
import React from 'react';
import { User } from 'lucide-react';

const AdminTab = ({ setViewMode }) => {
    return (
        <div className="space-y-6 animate-in fade-in duration-300">
            <h2 className="text-xl font-black text-slate-800 border-b border-slate-100 pb-4">Consola de Administraci√≥n</h2>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div onClick={() => setViewMode('tariffs')} className="p-6 bg-slate-50 rounded-xl border border-slate-200 hover:border-indigo-500 hover:shadow-md cursor-pointer transition-all group">
                    <div className="w-12 h-12 bg-indigo-100 rounded-lg flex items-center justify-center text-indigo-600 mb-4 group-hover:bg-indigo-600 group-hover:text-white transition-colors">
                        <div className="font-black text-xl">$</div>
                    </div>
                    <h3 className="font-bold text-slate-800 text-lg">Editor de Tarifas</h3>
                    <p className="text-sm text-slate-500 mt-2">Configura los precios base, por km y extras para cada cliente.</p>
                </div>

                <div onClick={() => setViewMode('users')} className="p-6 bg-slate-50 rounded-xl border border-slate-200 hover:border-blue-500 hover:shadow-md cursor-pointer transition-all group">
                    <div className="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center text-blue-600 mb-4 group-hover:bg-blue-600 group-hover:text-white transition-colors">
                        <div className="font-black text-xl"><User className="w-6 h-6" /></div>
                    </div>
                    <h3 className="font-bold text-slate-800 text-lg">Gesti√≥n de Usuarios</h3>
                    <p className="text-sm text-slate-500 mt-2">Crea, edita o elimina usuarios y asigna roles de franquicia.</p>
                </div>
            </div>
        </div>
    );
};

export default AdminTab;



================================================================================
FILE: src\components\user-profile\NotificationsTab.jsx
================================================================================
import React, { useState, useEffect } from 'react';
import { Mail, Bell } from 'lucide-react';
import { doc, setDoc, getDoc } from 'firebase/firestore';
import { db } from '../../lib/firebase';

const NotificationsTab = ({ user, showMessage }) => {
    const [prefs, setPrefs] = useState({
        emailNotifications: true,
        pushNotifications: false
    });

    useEffect(() => {
        const loadPrefs = async () => {
            try {
                const docRef = doc(db, "users_config", user.uid);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    setPrefs({
                        emailNotifications: data.emailNotifications ?? true,
                        pushNotifications: data.pushNotifications ?? false
                    });
                }
            } catch (error) {
                console.error("Error loading prefs:", error);
            }
        };
        loadPrefs();
    }, [user]);

    const togglePref = async (key) => {
        const newVal = !prefs[key];
        setPrefs(prev => ({ ...prev, [key]: newVal }));

        try {
            await setDoc(doc(db, "users_config", user.uid), {
                [key]: newVal
            }, { merge: true });
        } catch (error) {
            console.error("Error saving pref:", error);
            // Revert state on error
            setPrefs(prev => ({ ...prev, [key]: !newVal }));
            showMessage('error', 'Error al guardar preferencia');
        }
    };

    return (
        <div className="space-y-6 animate-in fade-in duration-300">
            <h2 className="text-xl font-black text-slate-800 border-b border-slate-100 pb-4">Preferencias de Contacto</h2>
            <div className="space-y-4">
                <label className="flex items-center justify-between p-4 bg-slate-50 rounded-xl border border-slate-200 cursor-pointer hover:bg-slate-100 transition">
                    <div className="flex items-center gap-3">
                        <div className="p-2 bg-indigo-100 text-indigo-600 rounded-lg">
                            <Mail className="w-5 h-5" />
                        </div>
                        <div>
                            <p className="font-bold text-slate-800">Notificaciones por Email</p>
                            <p className="text-xs text-slate-500">Recibir actualizaciones importantes y alertas a tu correo.</p>
                        </div>
                    </div>
                    <div className={`w-12 h-6 rounded-full p-1 transition-colors ${prefs.emailNotifications ? 'bg-indigo-600' : 'bg-slate-300'}`} onClick={() => togglePref('emailNotifications')}>
                        <div className={`w-4 h-4 bg-white rounded-full transition-transform ${prefs.emailNotifications ? 'translate-x-6' : ''}`}></div>
                    </div>
                </label>

                <label className="flex items-center justify-between p-4 bg-slate-50 rounded-xl border border-slate-200 cursor-pointer hover:bg-slate-100 transition">
                    <div className="flex items-center gap-3">
                        <div className="p-2 bg-purple-100 text-purple-600 rounded-lg">
                            <Bell className="w-5 h-5" />
                        </div>
                        <div>
                            <p className="font-bold text-slate-800">Notificaciones Push</p>
                            <p className="text-xs text-slate-500">Recibir alertas en tiempo real en el navegador.</p>
                        </div>
                    </div>
                    <div className={`w-12 h-6 rounded-full p-1 transition-colors ${prefs.pushNotifications ? 'bg-indigo-600' : 'bg-slate-300'}`} onClick={() => togglePref('pushNotifications')}>
                        <div className={`w-4 h-4 bg-white rounded-full transition-transform ${prefs.pushNotifications ? 'translate-x-6' : ''}`}></div>
                    </div>
                </label>
            </div>
        </div>
    );
};

export default NotificationsTab;



================================================================================
FILE: src\components\user-profile\ProfileTab.jsx
================================================================================
import React, { useState, useRef, useEffect } from 'react';
import { User, Phone, Mail, Camera, Loader, Save } from 'lucide-react';
import { updateProfile } from 'firebase/auth';
import { doc, setDoc, getDoc } from 'firebase/firestore';
import { ref, uploadBytes, getDownloadURL } from 'firebase/storage';
import { db, storage } from '../../lib/firebase';
import Button from '../ui/Button';

const ProfileTab = ({ user, roleConfig, isAdmin, showMessage }) => {
    const [isLoading, setIsLoading] = useState(false);
    const [formData, setFormData] = useState({
        displayName: user?.displayName || '',
        phone: '', // Will load from firestore
        email: user?.email || '',
        photoURL: user?.photoURL || ''
    });
    const fileInputRef = useRef(null);

    // Load extra data from users_config
    useEffect(() => {
        const loadUserConfig = async () => {
            try {
                const docRef = doc(db, "users_config", user.uid);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    setFormData(prev => ({
                        ...prev,
                        phone: data.phone || user.phoneNumber || '',
                        photoURL: data.photoURL || user.photoURL || ''
                    }));
                }
            } catch (error) {
                console.error("Error loading user config:", error);
            }
        };
        loadUserConfig();
    }, [user]);

    const handleFileChange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        setIsLoading(true);
        try {
            const storageRef = ref(storage, `avatars/${user.uid}`);
            await uploadBytes(storageRef, file);
            const downloadURL = await getDownloadURL(storageRef);

            // 1. Update Auth
            await updateProfile(user, { photoURL: downloadURL });

            // 2. Update Firestore users_config
            await setDoc(doc(db, "users_config", user.uid), {
                photoURL: downloadURL
            }, { merge: true });

            setFormData(prev => ({ ...prev, photoURL: downloadURL }));
            showMessage('success', 'Avatar actualizado correctamente');
        } catch (error) {
            console.error("Error uploading avatar:", error);
            showMessage('error', 'Error al subir la imagen: ' + error.message);
        } finally {
            setIsLoading(false);
        }
    };

    const handleSave = async () => {
        // Validation
        const phoneRegex = /^\+?[0-9\s-]{9,}$/;
        if (formData.phone && !phoneRegex.test(formData.phone)) {
            showMessage('error', 'Formato de tel√©fono inv√°lido');
            return;
        }

        setIsLoading(true);
        try {
            // 1. Update Auth (Display Name)
            if (formData.displayName !== user.displayName) {
                await updateProfile(user, { displayName: formData.displayName });
            }

            // 2. Update Firestore (Phone & Sync Name/Photo)
            await setDoc(doc(db, "users_config", user.uid), {
                displayName: formData.displayName,
                phone: formData.phone,
                email: user.email, // Ensure email is present
                photoURL: formData.photoURL
            }, { merge: true });

            showMessage('success', 'Informaci√≥n personal actualizada');
        } catch (error) {
            console.error("Error updating profile:", error);
            showMessage('error', 'Error al actualizar perfil: ' + error.message);
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="space-y-6 animate-in fade-in duration-300">
            {/* Header / Avatar Section */}
            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 mb-6 relative overflow-hidden">
                <div className="absolute top-0 left-0 w-full h-24 bg-gradient-to-r from-indigo-500 to-purple-600"></div>
                <div className="relative pt-12 flex flex-col md:flex-row items-center md:items-end gap-6">
                    <div className="relative group cursor-pointer" onClick={() => fileInputRef.current?.click()}>
                        <div className="w-24 h-24 rounded-full border-4 border-white bg-slate-200 flex items-center justify-center text-3xl font-bold text-slate-400 shadow-md overflow-hidden relative">
                            {formData.photoURL ? (
                                <img src={formData.photoURL} alt="Profile" className="w-full h-full object-cover" />
                            ) : (
                                <span>{user?.email?.substring(0, 2).toUpperCase()}</span>
                            )}
                            <div className="absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                <Camera className="w-8 h-8 text-white" />
                            </div>
                        </div>
                        <input
                            type="file"
                            ref={fileInputRef}
                            className="hidden"
                            accept="image/*"
                            onChange={handleFileChange}
                        />
                    </div>
                    <div className="flex-1 text-center md:text-left mb-2">
                        <h1 className="text-2xl font-black text-slate-900">{formData.displayName || 'Usuario'}</h1>
                        <p className="text-slate-500 font-medium flex items-center justify-center md:justify-start gap-2">
                            {user?.email}
                            <span className={`px-2 py-0.5 rounded text-[10px] font-bold uppercase ${isAdmin ? 'bg-indigo-100 text-indigo-700' : 'bg-emerald-100 text-emerald-700'}`}>
                                {roleConfig?.role || 'User'}
                            </span>
                        </p>
                    </div>
                </div>
            </div>

            <h2 className="text-xl font-black text-slate-800 border-b border-slate-100 pb-4">Informaci√≥n Personal</h2>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label className="block text-xs font-bold text-slate-400 uppercase mb-2">Nombre Completo</label>
                    <div className="relative">
                        <User className="w-5 h-5 text-slate-400 absolute left-3 top-2.5" />
                        <input
                            type="text"
                            value={formData.displayName}
                            onChange={(e) => setFormData({ ...formData, displayName: e.target.value })}
                            className="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-xl font-medium focus:ring-2 focus:ring-indigo-500 outline-none transition-all"
                        />
                    </div>
                </div>
                <div>
                    <label className="block text-xs font-bold text-slate-400 uppercase mb-2">Tel√©fono</label>
                    <div className="relative">
                        <Phone className="w-5 h-5 text-slate-400 absolute left-3 top-2.5" />
                        <input
                            type="tel"
                            value={formData.phone}
                            onChange={(e) => setFormData({ ...formData, phone: e.target.value })}
                            className="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-xl font-medium focus:ring-2 focus:ring-indigo-500 outline-none transition-all"
                            placeholder="+34 600 000 000"
                        />
                    </div>
                </div>
                <div className="md:col-span-2">
                    <label className="block text-xs font-bold text-slate-400 uppercase mb-2">Email (No editable)</label>
                    <div className="relative opacity-70">
                        <Mail className="w-5 h-5 text-slate-400 absolute left-3 top-2.5" />
                        <input
                            type="email"
                            value={formData.email}
                            disabled
                            className="w-full pl-10 pr-4 py-2 bg-slate-100 border border-slate-200 rounded-xl font-bold text-slate-500 cursor-not-allowed"
                        />
                    </div>
                </div>
            </div>

            <div className="mt-8 pt-6 border-t border-slate-100 flex justify-end">
                <Button
                    variant="primary"
                    onClick={handleSave}
                    icon={isLoading ? Loader : Save}
                    className={`shadow-lg hover:scale-105 transform transition-all ${isLoading ? 'opacity-70 cursor-not-allowed' : ''}`}
                    disabled={isLoading}
                >
                    {isLoading ? 'Guardando...' : 'Guardar Cambios'}
                </Button>
            </div>
        </div>
    );
};

export default ProfileTab;



================================================================================
FILE: src\components\user-profile\SecurityTab.jsx
================================================================================
import React, { useState } from 'react';
import { updatePassword } from 'firebase/auth';
import { Loader, Save } from 'lucide-react';
import Button from '../ui/Button';

const SecurityTab = ({ user, logout, showMessage }) => {
    const [isLoading, setIsLoading] = useState(false);
    const [passwords, setPasswords] = useState({
        new: '',
        confirm: ''
    });

    const handleSecurityUpdate = async () => {
        if (passwords.new !== passwords.confirm) {
            showMessage('error', 'Las contrase√±as no coinciden');
            return;
        }
        if (passwords.new.length < 6) {
            showMessage('error', 'La contrase√±a debe tener al menos 6 caracteres');
            return;
        }

        setIsLoading(true);
        try {
            await updatePassword(user, passwords.new);
            setPasswords({ new: '', confirm: '' });
            showMessage('success', 'Contrase√±a actualizada. Por favor inicia sesi√≥n de nuevo.');
            setTimeout(() => logout(), 2000);
        } catch (error) {
            console.error("Error updating password:", error);
            showMessage('error', 'Error al cambiar contrase√±a (Requerido login reciente): ' + error.message);
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="space-y-6 animate-in fade-in duration-300">
            <h2 className="text-xl font-black text-slate-800 border-b border-slate-100 pb-4">Seguridad</h2>
            <div className="space-y-4 max-w-md">
                <div>
                    <label className="block text-xs font-bold text-slate-400 uppercase mb-2">Contrase√±a Actual (Opcional)</label>
                    <input
                        type="password"
                        className="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-xl font-medium focus:ring-2 focus:ring-indigo-500 outline-none"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    />
                </div>
                <div>
                    <label className="block text-xs font-bold text-slate-400 uppercase mb-2">Nueva Contrase√±a</label>
                    <input
                        type="password"
                        value={passwords.new}
                        onChange={(e) => setPasswords({ ...passwords, new: e.target.value })}
                        className="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-xl font-medium focus:ring-2 focus:ring-indigo-500 outline-none"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    />
                </div>
                <div>
                    <label className="block text-xs font-bold text-slate-400 uppercase mb-2">Confirmar Contrase√±a</label>
                    <input
                        type="password"
                        value={passwords.confirm}
                        onChange={(e) => setPasswords({ ...passwords, confirm: e.target.value })}
                        className="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-xl font-medium focus:ring-2 focus:ring-indigo-500 outline-none"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    />
                </div>
            </div>

            <div className="mt-8 pt-6 border-t border-slate-100 flex justify-end">
                <Button
                    variant="primary"
                    onClick={handleSecurityUpdate}
                    icon={isLoading ? Loader : Save}
                    className={`shadow-lg hover:scale-105 transform transition-all ${isLoading ? 'opacity-70 cursor-not-allowed' : ''}`}
                    disabled={isLoading}
                >
                    {isLoading ? 'Procesando...' : 'Actualizar Contrase√±a'}
                </Button>
            </div>
        </div>
    );
};

export default SecurityTab;



================================================================================
FILE: src\components\UserManagementPanel.jsx
================================================================================
import React, { useState } from 'react';
import { Users, UserPlus, ShieldAlert, Download, Search, Filter, Loader2, RefreshCw } from 'lucide-react';
import { useAuth } from '../context/AuthContext';
import { useUserManager } from '../hooks/useUserManager';
import { useToast } from '../hooks/useToast';
import UserTable from './admin/users/UserTable';
import CriticalActionModal from './common/CriticalActionModal';

// --- SUB-COMPONENTS (Local for now to keep orchestrator clean) ---

import CreateUserModal from './CreateUserModal';

// --- SUB-COMPONENTS (Local for now to keep orchestrator clean) ---

const UserToolbar = ({
    searchQuery, setSearchQuery,
    roleFilter, setRoleFilter,
    statusFilter, setStatusFilter,
    onCreate, onRefresh
}) => (
    <div className="flex flex-col lg:flex-row gap-4 mb-6 justify-between items-end lg:items-center">
        {/* Search */}
        <div className="relative flex-1 w-full lg:max-w-md">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4" />
            <input
                type="text"
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                placeholder="Buscar usuarios por email, nombre o ID..."
                className="pl-9 pr-4 py-2.5 w-full glass-panel-exec text-slate-200 border-0 rounded-xl text-sm font-medium focus:ring-2 focus:ring-indigo-500/50 outline-none transition-all shadow-sm placeholder-slate-500"
            />
        </div>

        {/* Filters & Actions */}
        <div className="flex items-center gap-3 w-full lg:w-auto overflow-x-auto pb-1 lg:pb-0">
            <select
                value={roleFilter}
                onChange={(e) => setRoleFilter(e.target.value)}
                className="glass-panel-exec border-0 px-3 py-2.5 rounded-xl text-sm font-bold text-slate-300 outline-none focus:ring-2 focus:ring-indigo-500/50"
            >
                <option value="all" className="bg-slate-900 text-slate-200">Todos los Roles</option>
                <option value="user" className="bg-slate-900 text-slate-200">Usuarios</option>
                <option value="franchise" className="bg-slate-900 text-slate-200">Franquiciados</option>
                <option value="admin" className="bg-slate-900 text-slate-200">Administradores</option>
            </select>

            <select
                value={statusFilter}
                onChange={(e) => setStatusFilter(e.target.value)}
                className="glass-panel-exec border-0 px-3 py-2.5 rounded-xl text-sm font-bold text-slate-300 outline-none focus:ring-2 focus:ring-indigo-500/50"
            >
                <option value="all" className="bg-slate-900 text-slate-200">Todos los Estados</option>
                <option value="active" className="bg-slate-900 text-slate-200">Activos</option>
                <option value="banned" className="bg-slate-900 text-slate-200">Bloqueados</option>
            </select>

            <div className="h-6 w-px bg-white/10 mx-1 hidden lg:block"></div>

            <button
                onClick={onRefresh}
                className="p-2.5 text-slate-400 hover:bg-white/10 rounded-xl transition-colors"
                title="Refrescar Lista"
            >
                <RefreshCw className="w-4 h-4" />
            </button>

            <button
                onClick={onCreate}
                className="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2.5 rounded-xl text-sm font-bold shadow-lg shadow-indigo-500/30 transition-all active:scale-95 whitespace-nowrap"
            >
                <UserPlus className="w-4 h-4" />
                <span className="hidden sm:inline">Nuevo Usuario</span>
            </button>
        </div>
    </div>
);

// --- MAIN ORCHESTRATOR ---

const UserManagementPanel = () => {
    const { user: currentUser } = useAuth();
    const { addToast } = useToast();

    // Logic Hook
    const {
        users,
        loading,
        error: fetchError,
        searchQuery, setSearchQuery,
        roleFilter, setRoleFilter,
        statusFilter, setStatusFilter,
        createUser,
        deleteUser,
        toggleUserStatus
    } = useUserManager(currentUser);

    // Orchestrator State
    const [modalConfig, setModalConfig] = useState({ isOpen: false, type: null, target: null });
    const [actionLoading, setActionLoading] = useState(false);

    // --- HANDLERS ---

    const handleAction = (type, targetUser) => {
        if (type === 'delete') {
            setModalConfig({
                isOpen: true,
                type: 'delete',
                target: targetUser
            });
        } else if (type === 'toggleStatus') {
            if (targetUser.status === 'active') {
                setModalConfig({
                    isOpen: true,
                    type: 'ban',
                    target: targetUser
                });
            } else {
                executeStatusToggle(targetUser);
            }
        }
    };

    const handleCreateClick = () => {
        setModalConfig({
            isOpen: true,
            type: 'create',
            target: null
        });
    };

    const executeCreate = async (userData) => {
        setActionLoading(true);
        try {
            await createUser(userData);
            addToast('Usuario creado exitosamente. Esperando primer login.', 'success');
            // Modal closes via passed down onClose which calls setModalConfig
            // BUT CreateUserModal calls onClose on success, so we rely on that or we can close here?
            // Actually CreateUserModal calls `onCreate`, waits for it, then closes itself if no error.
            // So we just return promise.
        } catch (err) {
            throw err; // Propagate to modal to show error
        } finally {
            setActionLoading(false);
        }
    };

    const executeDelete = async () => {
        setActionLoading(true);
        try {
            await deleteUser(modalConfig.target.id || modalConfig.target.uid);
            addToast('Usuario eliminado permanentemente', 'success');
            setModalConfig({ isOpen: false, type: null, target: null });
        } catch (err) {
            addToast(err.message || 'Error al eliminar usuario', 'error');
        } finally {
            setActionLoading(false);
        }
    };

    const executeStatusToggle = async (target = modalConfig.target) => {
        setActionLoading(true);
        try {
            await toggleUserStatus(target.id || target.uid, target.status);
            addToast(`Estado de usuario actualizado`, 'success');
            setModalConfig({ isOpen: false, type: null, target: null });
        } catch (err) {
            addToast(err.message || 'Error al cambiar estado', 'error');
        } finally {
            setActionLoading(false);
        }
    };

    if (loading) {
        return (
            <div className="h-screen flex items-center justify-center bg-slate-50">
                <div className="flex flex-col items-center animate-pulse">
                    <Loader2 className="w-10 h-10 text-blue-500 animate-spin mb-4" />
                    <p className="text-slate-500 font-bold text-lg">Cargando Usuarios...</p>
                </div>
            </div>
        );
    }

    if (fetchError) {
        return (
            <div className="min-h-[400px] flex items-center justify-center">
                <div className="p-8 bg-rose-50 border border-rose-100 rounded-2xl text-center max-w-md">
                    <ShieldAlert className="w-12 h-12 text-rose-500 mx-auto mb-4" />
                    <h3 className="text-lg font-black text-rose-900 mb-2">Error de Acceso</h3>
                    <p className="text-rose-700">{fetchError}</p>
                </div>
            </div>
        );
    }

    return (
        <div className="p-8 min-h-screen bg-transparent font-sans text-slate-100 animate-in fade-in duration-500">
            {/* Header */}
            <div className="mb-8">
                <h1 className="text-2xl font-black text-white tracking-tight flex items-center gap-3">
                    <div className="p-2 glass-panel-exec border-0 rounded-xl shadow-sm">
                        <Users className="w-6 h-6 text-indigo-400" />
                    </div>
                    Gesti√≥n de Usuarios
                </h1>
                <p className="text-slate-400 font-medium ml-[52px]">
                    Administra accesos, roles y seguridad de la plataforma.
                </p>
            </div>

            {/* Toolbar */}
            <UserToolbar
                searchQuery={searchQuery} setSearchQuery={setSearchQuery}
                roleFilter={roleFilter} setRoleFilter={setRoleFilter}
                statusFilter={statusFilter} setStatusFilter={setStatusFilter}
                onCreate={handleCreateClick}
                onRefresh={() => { }}
            />

            {/* Data Layer */}
            <div className="h-[calc(100vh-280px)] min-h-[500px]">
                <UserTable
                    users={users}
                    onAction={handleAction}
                    currentUserRole={currentUser?.role || 'user'}
                />
            </div>

            {/* Creation Modal */}
            <CreateUserModal
                isOpen={modalConfig.isOpen && modalConfig.type === 'create'}
                onClose={() => setModalConfig({ ...modalConfig, isOpen: false })}
                onCreate={executeCreate}
                isLoading={actionLoading}
            />

            {/* Security Modals */}
            <CriticalActionModal
                isOpen={modalConfig.isOpen && modalConfig.type === 'delete'}
                onClose={() => setModalConfig({ ...modalConfig, isOpen: false })}
                onConfirm={executeDelete}
                title="Eliminaci√≥n Cr√≠tica de Usuario"
                description={`Est√°s a punto de eliminar a ${modalConfig.target?.email}. Esta acci√≥n es IRREVERSIBLE y borrar√° todos los datos asociados.`}
                confirmKeyword={modalConfig.target?.email}
                confirmButtonText="Eliminar Definitivamente"
                isLoading={actionLoading}
                variant="danger"
            />

            <CriticalActionModal
                isOpen={modalConfig.isOpen && modalConfig.type === 'ban'}
                onClose={() => setModalConfig({ ...modalConfig, isOpen: false })}
                onConfirm={() => executeStatusToggle()}
                title="Bloqueo de Seguridad"
                description={`¬øSeguro que deseas bloquear el acceso a ${modalConfig.target?.email}? El usuario ser√° desconectado inmediatamente.`}
                confirmKeyword="BLOQUEAR"
                confirmButtonText="Bloquear Acceso"
                isLoading={actionLoading}
                variant="warning"
            />
        </div>
    );
};

export default UserManagementPanel;



================================================================================
FILE: src\components\UserMenu.jsx
================================================================================
import React, { useState, useRef, useEffect } from 'react';
import { User, Settings, LogOut, ChevronDown } from 'lucide-react';

const UserMenu = ({ user, setViewMode, onLogout }) => {
    const [isOpen, setIsOpen] = useState(false);
    const menuRef = useRef(null);

    // Close on click outside
    useEffect(() => {
        const handleClickOutside = (event) => {
            if (menuRef.current && !menuRef.current.contains(event.target)) {
                setIsOpen(false);
            }
        };
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
    }, []);

    const handleAction = (action) => {
        setIsOpen(false);
        if (action === 'profile') setViewMode('profile');
        if (action === 'logout') onLogout();
    };

    return (
        <div className="relative" ref={menuRef}>
            <button
                onClick={() => setIsOpen(!isOpen)}
                className="flex items-center gap-2 p-1.5 rounded-full hover:bg-slate-100 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-100"
            >
                <img
                    src={user?.photoURL || `https://ui-avatars.com/api/?name=${user?.email}&background=random`}
                    alt="Profile"
                    className="w-8 h-8 rounded-full border border-slate-200 shadow-sm"
                />
                <ChevronDown className={`w-3 h-3 text-slate-400 transition-transform duration-200 ${isOpen ? 'rotate-180' : ''}`} />
            </button>

            {/* Dropdown */}
            {isOpen && (
                <div className="absolute right-0 mt-2 w-56 bg-white rounded-xl shadow-xl border border-slate-100 py-2 z-50 animate-in fade-in zoom-in-95 duration-100 origin-top-right">
                    <div className="px-4 py-3 border-b border-slate-50">
                        <p className="text-sm font-bold text-slate-800 truncate">{user?.displayName || 'Usuario'}</p>
                        <p className="text-xs text-slate-500 truncate">{user?.email}</p>
                    </div>

                    <div className="py-1">
                        <button
                            onClick={() => handleAction('profile')}
                            className="w-full text-left px-4 py-2 text-sm text-slate-600 hover:bg-slate-50 hover:text-blue-600 flex items-center transition-colors"
                        >
                            <User className="w-4 h-4 mr-2" />
                            Mi Perfil
                        </button>
                        <button
                            onClick={() => handleAction('profile')}
                            className="w-full text-left px-4 py-2 text-sm text-slate-600 hover:bg-slate-50 hover:text-blue-600 flex items-center transition-colors"
                        >
                            <Settings className="w-4 h-4 mr-2" />
                            Configuraci√≥n
                        </button>
                    </div>

                    <div className="border-t border-slate-50 mt-1 pt-1">
                        <button
                            onClick={() => handleAction('logout')}
                            className="w-full text-left px-4 py-2 text-sm text-rose-600 hover:bg-rose-50 flex items-center transition-colors"
                        >
                            <LogOut className="w-4 h-4 mr-2" />
                            Cerrar Sesi√≥n
                        </button>
                    </div>
                </div>
            )}
        </div>
    );
};

export default UserMenu;



================================================================================
FILE: src\components\UserProfile.jsx
================================================================================
import React, { useState } from 'react';
import { User, Lock, Bell, Shield, LogOut, CheckCircle, AlertTriangle } from 'lucide-react';
import { useAuth } from '../context/AuthContext';
import Button from './ui/Button';

// Sub-components
import ProfileTab from './user-profile/ProfileTab';
import SecurityTab from './user-profile/SecurityTab';
import NotificationsTab from './user-profile/NotificationsTab';
import AdminTab from './user-profile/AdminTab';

const UserProfile = ({ setViewMode }) => {
    const { user, roleConfig, logout } = useAuth();
    const [activeTab, setActiveTab] = useState('profile');
    const [message, setMessage] = useState({ type: '', text: '' });

    const showMessage = (type, text) => {
        setMessage({ type, text });
        setTimeout(() => setMessage({ type: '', text: '' }), 5000);
    };

    const isAdmin = roleConfig?.role === 'admin';

    return (
        <div className="min-h-screen bg-slate-50/50 relative overflow-hidden pb-24">
            {/* Background Blob Elements (Premium Touch) */}
            <div className="absolute top-0 left-0 w-full h-[500px] bg-gradient-to-tr from-indigo-50/80 via-purple-50/50 to-slate-50/20 -z-10 clip-path-slant"></div>
            <div className="absolute top-20 right-0 w-96 h-96 bg-blue-100/30 rounded-full blur-3xl -z-10"></div>

            <div className="p-4 md:p-8 max-w-5xl mx-auto animate-fade-in-up">
                {/* Feedback Message */}
                {message.text && (
                    <div className={`fixed top-24 right-8 z-50 px-6 py-4 rounded-xl shadow-2xl flex items-center animate-in slide-in-from-right duration-300 backdrop-blur-md border ${message.type === 'error' ? 'bg-rose-500/90 text-white border-rose-400' : 'bg-emerald-500/90 text-white border-emerald-400'}`}>
                        {message.type === 'error' ? <AlertTriangle className="w-5 h-5 mr-3" /> : <CheckCircle className="w-5 h-5 mr-3" />}
                        <span className="font-bold">{message.text}</span>
                    </div>
                )}

                {/* Logout Header Button */}
                <div className="flex justify-end mb-6">
                    <Button variant="secondary" onClick={logout} icon={LogOut} className="bg-white/80 backdrop-blur-sm border-slate-200 shadow-sm hover:bg-white hover:shadow-md transition-all">Cerrar Sesi√≥n</Button>
                </div>

                <div className="flex flex-col md:flex-row gap-8">
                    {/* Sidebar Tabs (Desktop) / Horizontal Scroll (Mobile) */}
                    <div className="md:w-64 flex-shrink-0 md:sticky md:top-8 self-start z-10 sticky top-0 -mx-4 px-4 md:mx-0 md:px-0 py-4 md:py-0 transition-all">
                        <div className="flex md:flex-col overflow-x-auto md:overflow-visible gap-3 pb-2 md:pb-0 scrollbar-hide snap-x p-1">
                            <button
                                onClick={() => setActiveTab('profile')}
                                className={`flex-shrink-0 snap-start flex items-center gap-3 px-5 py-3.5 rounded-2xl font-bold transition-all duration-300 whitespace-nowrap ${activeTab === 'profile'
                                    ? 'bg-gradient-to-r from-indigo-600 to-indigo-500 text-white shadow-lg shadow-indigo-200 scale-105'
                                    : 'text-slate-500 hover:bg-white/60 hover:text-indigo-600 hover:shadow-sm bg-white/40 border border-slate-100/50 backdrop-blur-sm'}`}
                            >
                                <User className="w-5 h-5" /> <span>Datos Personales</span>
                            </button>
                            <button
                                onClick={() => setActiveTab('security')}
                                className={`flex-shrink-0 snap-start flex items-center gap-3 px-5 py-3.5 rounded-2xl font-bold transition-all duration-300 whitespace-nowrap ${activeTab === 'security'
                                    ? 'bg-gradient-to-r from-indigo-600 to-indigo-500 text-white shadow-lg shadow-indigo-200 scale-105'
                                    : 'text-slate-500 hover:bg-white/60 hover:text-indigo-600 hover:shadow-sm bg-white/40 border border-slate-100/50 backdrop-blur-sm'}`}
                            >
                                <Lock className="w-5 h-5" /> <span>Seguridad</span>
                            </button>
                            <button
                                onClick={() => setActiveTab('notifications')}
                                className={`flex-shrink-0 snap-start flex items-center gap-3 px-5 py-3.5 rounded-2xl font-bold transition-all duration-300 whitespace-nowrap ${activeTab === 'notifications'
                                    ? 'bg-gradient-to-r from-indigo-600 to-indigo-500 text-white shadow-lg shadow-indigo-200 scale-105'
                                    : 'text-slate-500 hover:bg-white/60 hover:text-indigo-600 hover:shadow-sm bg-white/40 border border-slate-100/50 backdrop-blur-sm'}`}
                            >
                                <Bell className="w-5 h-5" /> <span>Notificaciones</span>
                            </button>
                            {isAdmin && (
                                <button
                                    onClick={() => setActiveTab('admin')}
                                    className={`flex-shrink-0 snap-start flex items-center gap-3 px-5 py-3.5 rounded-2xl font-bold transition-all duration-300 whitespace-nowrap ${activeTab === 'admin'
                                        ? 'bg-gradient-to-r from-slate-800 to-slate-900 text-white shadow-lg shadow-slate-300 scale-105'
                                        : 'text-slate-500 hover:bg-white/60 hover:text-slate-800 hover:shadow-sm bg-white/40 border border-slate-100/50 backdrop-blur-sm'}`}
                                >
                                    <Shield className="w-5 h-5" /> <span>Zona Admin</span>
                                </button>
                            )}
                        </div>
                    </div>

                    {/* Content Area */}
                    <div className="flex-1 bg-white/80 backdrop-blur-xl rounded-3xl shadow-xl shadow-slate-200/50 border border-white/50 p-6 md:p-10 min-h-[500px]">
                        {/* PROFILE TAB */}
                        {activeTab === 'profile' && (
                            <ProfileTab
                                user={user}
                                roleConfig={roleConfig}
                                isAdmin={isAdmin}
                                showMessage={showMessage}
                            />
                        )}

                        {/* SECURITY TAB */}
                        {activeTab === 'security' && (
                            <SecurityTab
                                user={user}
                                logout={logout}
                                showMessage={showMessage}
                            />
                        )}

                        {/* NOTIFICATIONS TAB */}
                        {activeTab === 'notifications' && (
                            <NotificationsTab
                                user={user}
                                showMessage={showMessage}
                            />
                        )}

                        {/* ADMIN TAB */}
                        {isAdmin && activeTab === 'admin' && (
                            <AdminTab setViewMode={setViewMode} />
                        )}
                    </div>
                </div>
            </div >
        </div>
    );
};

export default UserProfile;



================================================================================
FILE: src\components\ViewSwitcher.jsx
================================================================================
import React, { Suspense } from 'react';
import { useAuth } from '../context/AuthContext'; // <--- EL PUENTE M√ÅGICO
import { DollarSign, Activity, Landmark, Gauge, Lock, Fuel, Wrench, Shield, Briefcase, FileText, Target, Zap, Users } from 'lucide-react';
import { formatMoney } from '../lib/finance';

// Layout & UI
import DashboardSkeleton from './DashboardSkeleton';
import KPICard from './KPICard';
import InfoTooltip from './InfoTooltip';
import ErrorBoundary from './ErrorBoundary';

// Components
import AdminDashboard from './AdminDashboard';
import AdminSupportPanel from './AdminSupportPanel';
import UserManagementPanel from './UserManagementPanel';
import AdminResourcesPanel from './AdminResourcesPanel';
import SupportHub from './SupportHub';
import ResourcesPanel from './ResourcesPanel';
import Academy from './academy/Academy';
import UserProfile from './UserProfile';
import AnnouncementSystem from './AnnouncementSystem';
import PrintReport from './PrintReport';
import AICoachWidget from './AICoachWidget';
import AlertsWidget from './AlertsWidget';
import NewsFeedWidget from './NewsFeedWidget';
import MonthlyTrendChart from './MonthlyTrendChart';
import MonthlyTaxWidget from './MonthlyTaxWidget';
import TaxVaultWidget from './TaxVaultWidget';
import DashboardCharts from './DashboardCharts';
import UpdatePrompt from './UpdatePrompt';
import NetworkStatus from './NetworkStatus';
import TariffEditor from './TariffEditor';
import AuditPanel from './AuditPanel';

const ViewSwitcher = ({
    viewMode, setViewMode,
    franchiseView, setFranchiseView,
    isAdmin: propIsAdmin, // Renombramos la prop antigua
    isFranchise,
    selectedMonth, setSelectedMonth,
    currentData, report, previousReport, last6MonthsData,
    handleAdminSelectFranchise,
    user: propUser
}) => {
    // üî• AUTODETERMINACI√ìN DE RANGO üî•
    // Ignoramos lo que diga el componente padre. Preguntamos directamente al AuthContext.
    const { isAdmin: contextIsAdmin, user: contextUser } = useAuth();

    // La Verdad Absoluta
    const realIsAdmin = contextIsAdmin || propIsAdmin || (contextUser?.role === 'admin');
    const currentUser = contextUser || propUser;

    console.log("üïµÔ∏è‚Äç‚ôÇÔ∏è VIEW SWITCHER (MODO SEGURO):", {
        viewMode,
        realIsAdmin,
        role: currentUser?.role
    });

    // --- ADMIN VIEWS (Prioridad Total) ---
    if (realIsAdmin) {
        if (viewMode === 'support') return <AdminSupportPanel />;
        if (viewMode === 'users') return <UserManagementPanel />; // <--- AQU√ç DEBER√çAS ENTRAR
        if (viewMode === 'audit') return <AuditPanel />;
        if (viewMode === 'tariffs') return <TariffEditor onClose={() => setViewMode('dashboard')} />;
        if (viewMode === 'resources') return <AdminResourcesPanel />;
        if (viewMode === 'communications') {
            return (
                <div className="p-5 md:p-8 space-y-6">
                    <Suspense fallback={<DashboardSkeleton />}>
                        <AnnouncementSystem />
                    </Suspense>
                </div>
            );
        }
        if (viewMode === 'academy') return <Academy />;

        // Vista por defecto Admin: Dashboard Global
        if (viewMode === 'dashboard' || viewMode === 'franchise_detail') {
            // Si el Admin quiere ver detalles de una franquicia espec√≠fica, mostramos el dashboard detallado
            if (viewMode === 'franchise_detail') {
                // Cae hacia abajo al renderizado del Dashboard
            } else {
                return (
                    <AdminDashboard
                        onSelectFranchise={handleAdminSelectFranchise}
                        selectedMonth={selectedMonth}
                        onMonthChange={setSelectedMonth}
                        onManageTariffs={() => setViewMode('tariffs')}
                        onOpenSimulator={() => setViewMode('simulator')}
                    />
                );
            }
        }
    }

    // --- FRANCHISE / COMMON VIEWS ---
    if (isFranchise && franchiseView === 'support') return <SupportHub />;
    if (isFranchise && franchiseView === 'resources') return <ResourcesPanel />;
    if (isFranchise && franchiseView === 'academy') return <Academy />;
    if (viewMode === 'profile') return <UserProfile setViewMode={setViewMode} />;

    // --- MAIN COCKPIT / FRANCHISE DETAIL / ADMIN INSPECTION ---
    // Esta secci√≥n se renderiza si:
    // 1. Es una franquicia viendo su dashboard ('cockpit')
    // 2. Es un Admin inspeccionando una franquicia ('franchise_detail')
    if ((isFranchise && franchiseView === 'cockpit') || (realIsAdmin && viewMode === 'franchise_detail')) {
        return (
            <div className="p-5 md:p-8 space-y-6 md:space-y-8 animate-fade-in-up">
                <PrintReport data={currentData} report={report} />

                {/* KPIs */}
                <ErrorBoundary>
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5 md:gap-6 stagger-1 animate-fade-in-up">
                        <KPICard
                            title="Ingresos del Mes"
                            value={`${formatMoney(report?.revenue)}‚Ç¨`}
                            icon={DollarSign}
                            trend="up"
                            subtext={`${report?.orders || 0} pedidos en el mes`}
                            colorClass="text-blue-600"
                            tooltip="Facturaci√≥n total del mes seleccionado sin IVA."
                            delta={previousReport ? (report?.revenue || 0) - previousReport.revenue : null}
                            deltaPercent={previousReport && previousReport.revenue > 0 ? ((report?.revenue || 0) - previousReport.revenue) / previousReport.revenue * 100 : null}
                        />
                        <KPICard
                            title="Beneficio Bruto"
                            value={`${formatMoney(report?.profit)}‚Ç¨`}
                            icon={Activity}
                            trend={(report?.profit || 0) >= 0 ? "up" : "down"}
                            subtext="Del Mes (Antes Impuestos)"
                            colorClass={(report?.profit || 0) >= 0 ? "text-emerald-600" : "text-rose-600"}
                            tooltip="Ingresos - Gastos Totales (sin contar IVA/IRPF)."
                            delta={previousReport ? (report?.profit || 0) - previousReport.profit : null}
                            deltaPercent={previousReport && Math.abs(previousReport.profit) > 0 ? ((report?.profit || 0) - previousReport.profit) / Math.abs(previousReport.profit) * 100 : null}
                        />
                        <KPICard
                            title="Beneficio Neto"
                            value={`${formatMoney(report?.taxes?.netProfitPostTax)}‚Ç¨`}
                            icon={Landmark}
                            subtext="Del Mes (Post-IRPF)"
                            colorClass="text-blue-600"
                            tooltip="Dinero real tras restar el IRPF estimado."
                            delta={previousReport ? (report?.taxes?.netProfitPostTax || 0) - previousReport.netProfitPostTax : null}
                            deltaPercent={previousReport && Math.abs(previousReport.netProfitPostTax) > 0 ? ((report?.taxes?.netProfitPostTax || 0) - previousReport.netProfitPostTax) / Math.abs(previousReport.netProfitPostTax) * 100 : null}
                        />
                        <div className="glass-panel-exec p-6 rounded-xl hover:shadow-lg transition-all duration-300 hover:-translate-y-1 relative overflow-hidden group">
                            <div className="absolute inset-0 bg-amber-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-500" />
                            <div className="flex justify-between items-start mb-2 relative z-10">
                                <div className="flex items-center">
                                    <p className="text-[10px] md:text-sm font-bold text-slate-400 uppercase tracking-widest">Margen Seguridad</p>
                                    <InfoTooltip text="Porcentaje que pueden caer tus ventas antes de entrar en p√©rdidas." />
                                </div>
                                <div className="p-2 rounded-lg bg-amber-500/10">
                                    <Gauge className="w-5 h-5 text-amber-500" />
                                </div>
                            </div>
                            <div className="relative pt-2 z-10">
                                <div className="flex items-baseline">
                                    <h3 className={`text-2xl md:text-3xl font-black tracking-tight ${(report?.metrics?.safetyMargin || 0) > 20 ? 'text-emerald-400 text-glow-success' : 'text-amber-400'}`}>
                                        {(report?.metrics?.safetyMargin || 0).toLocaleString('es-ES', { minimumFractionDigits: 1, maximumFractionDigits: 1 })}%
                                    </h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </ErrorBoundary>

                {/* AI Coach & Alerts Grid */}
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div className="lg:col-span-2">
                        <ErrorBoundary>
                            <AICoachWidget
                                stats={currentData}
                                report={report}
                                userName={currentUser?.displayName || "Socio"}
                                onNavigate={(route) => setFranchiseView(route)}
                            />
                        </ErrorBoundary>
                    </div>
                    <div className="lg:col-span-1">
                        <ErrorBoundary>
                            <AlertsWidget report={report} previousReport={previousReport} />
                        </ErrorBoundary>
                    </div>
                </div>

                {/* News Feed */}
                <ErrorBoundary>
                    <NewsFeedWidget />
                </ErrorBoundary>

                {/* Gr√°fico Evoluci√≥n 6 Meses */}
                <ErrorBoundary>
                    <MonthlyTrendChart last6Months={last6MonthsData} />
                </ErrorBoundary>

                {/* Widget Mensual IVA/IRPF */}
                <ErrorBoundary>
                    <MonthlyTaxWidget taxes={report?.taxes} />
                </ErrorBoundary>

                {/* TAX VAULT */}
                <ErrorBoundary>
                    <TaxVaultWidget taxes={report?.taxes} />
                </ErrorBoundary>

                {/* Performance Charts */}
                <ErrorBoundary>
                    <DashboardCharts report={report} data={currentData} />
                </ErrorBoundary>

                {/* Professional Cost Breakdown */}
                <ErrorBoundary>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        {['fixed', 'variable'].map((type) => {
                            const items = (report?.breakdown || [])
                                .filter(i => i.type === type && i.value > 0)
                                .sort((a, b) => b.value - a.value);

                            if (items.length === 0) return null;
                            const totalTypeExpenses = items.reduce((sum, item) => sum + item.value, 0);

                            return (
                                <div key={type} className="glass-panel-exec p-5 rounded-2xl hover:shadow-md transition-shadow">
                                    <h3 className={`text-xs font-bold uppercase tracking-widest mb-5 flex items-center ${type === 'fixed' ? 'text-blue-400' : 'text-rose-400'}`}>
                                        {type === 'fixed' ? <Lock className="w-4 h-4 mr-2" /> : <Activity className="w-4 h-4 mr-2" />}
                                        Costes {type === 'fixed' ? 'Fijos (Estructurales)' : 'Variables (Operativos)'}
                                    </h3>
                                    <div className="space-y-5">
                                        {items.map((item, idx) => {
                                            const percent = report?.expenses > 0 ? (item.value / report.expenses) * 100 : 0;
                                            const relativePercent = totalTypeExpenses > 0 ? (item.value / totalTypeExpenses) * 100 : 0;
                                            let Icon = DollarSign;
                                            if (item.name.includes('Salarios')) Icon = Users;
                                            if (item.name.includes('Gasolina')) Icon = Fuel;
                                            if (item.name.includes('Reparaciones')) Icon = Wrench;
                                            if (item.name.includes('Seguros')) Icon = Shield;
                                            if (item.name.includes('Gestor√≠a') || item.name.includes('Financieros')) Icon = Briefcase;
                                            if (item.name.includes('Cuota') || item.name.includes('Impuestos')) Icon = FileText;
                                            if (item.name.includes('Marketing')) Icon = Target;
                                            if (item.name.includes('Flyder') || item.name.includes('Software')) Icon = Zap;

                                            return (
                                                <div key={idx} className="group">
                                                    <div className="flex justify-between items-end mb-1">
                                                        <div className="flex items-center">
                                                            <div className={`p-1.5 rounded-lg mr-3 ${type === 'fixed' ? 'bg-blue-500/10 text-blue-400' : 'bg-rose-500/10 text-rose-400'}`}>
                                                                <Icon className="w-3.5 h-3.5" />
                                                            </div>
                                                            <div>
                                                                <p className="text-sm font-medium text-slate-300">{item.name}</p>
                                                                <p className="text-xs text-slate-500 font-medium">{percent.toFixed(1)}% del Gasto Total</p>
                                                            </div>
                                                        </div>
                                                        <div className="text-right">
                                                            <p className="font-bold text-white font-mono">{formatMoney(item.value)}‚Ç¨</p>
                                                        </div>
                                                    </div>
                                                    <div className="w-full bg-slate-700/30 rounded-full h-1.5 mt-2 overflow-hidden">
                                                        <div className={`h-full rounded-full ${type === 'fixed' ? 'bg-blue-500' : 'bg-rose-500'}`} style={{ width: `${relativePercent}%` }}></div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                    <div className="mt-6 pt-4 border-t border-slate-700/50 flex justify-between items-center">
                                        <span className="text-xs font-bold text-slate-500 uppercase">Total {type === 'fixed' ? 'Fijos' : 'Variables'}</span>
                                        <span className={`text-lg font-black ${type === 'fixed' ? 'text-blue-400' : 'text-rose-400'}`}>{formatMoney(totalTypeExpenses)}‚Ç¨</span>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </ErrorBoundary>
                <UpdatePrompt />
                <NetworkStatus />
            </div>
        );
    }

    return null;
};

// PropTypes simplificados para evitar errores de validaci√≥n con las nuevas props
import PropTypes from 'prop-types';
ViewSwitcher.propTypes = {
    viewMode: PropTypes.string,
    setViewMode: PropTypes.func,
    franchiseView: PropTypes.string,
    setFranchiseView: PropTypes.func,
    isAdmin: PropTypes.bool,
    isFranchise: PropTypes.bool,
    selectedMonth: PropTypes.string,
    setSelectedMonth: PropTypes.func,
    currentData: PropTypes.object,
    report: PropTypes.object,
    previousReport: PropTypes.object,
    last6MonthsData: PropTypes.array,
    handleAdminSelectFranchise: PropTypes.func,
    user: PropTypes.object
};

export default ViewSwitcher;



================================================================================
FILE: src\components\WeeklyCalendarGrid.jsx
================================================================================
import React, { useState } from 'react';
import { Clock, User, MapPin, Trash2 } from 'lucide-react';

const DAYS = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
const HOURS = Array.from({ length: 13 }, (_, i) => i + 12); // 12:00 to 00:00 (24h)
const RIDER_COLORS = [
    'bg-blue-500',
    'bg-purple-500',
    'bg-pink-500',
    'bg-orange-500',
    'bg-teal-500',
    'bg-rose-500',
    'bg-indigo-500'
];

/**
 * WeeklyCalendarGrid - Visual calendar grid with time slots
 */
const WeeklyCalendarGrid = ({ shifts, onDeleteShift, readOnly = false }) => {
    const [hoveredShift, setHoveredShift] = useState(null);

    // Get color for a rider (consistent)
    const getRiderColor = (riderName) => {
        const hash = riderName.split('').reduce((acc, char) => char.charCodeAt(0) + acc, 0);
        return RIDER_COLORS[hash % RIDER_COLORS.length];
    };

    // Convert time to hour number (e.g., "20:00" -> 20)
    const timeToHour = (time) => {
        return parseInt(time.split(':')[0]);
    };

    // Format hour for display
    const formatHour = (hour) => {
        if (hour === 0 || hour === 24) return '00:00';
        return `${hour}:00`;
    };

    return (
        <div className="glass-panel-exec p-0 rounded-xl border border-white/10 overflow-hidden">
            <div className="overflow-x-auto custom-scrollbar">
                <div className="min-w-[800px]">
                    {/* Header with Days */}
                    <div className="grid grid-cols-8 border-b border-white/10 bg-white/5">
                        <div className="p-3 text-xs font-bold text-slate-400 border-r border-white/10">
                            HORA
                        </div>
                        {DAYS.map(day => (
                            <div key={day} className="p-3 text-center border-r border-white/10 last:border-r-0">
                                <p className="text-xs font-bold text-slate-200">{day.substring(0, 3).toUpperCase()}</p>
                                <p className="text-[10px] text-slate-500">{day}</p>
                            </div>
                        ))}
                    </div>

                    {/* Calendar Grid */}
                    <div className="grid grid-cols-8 relative">
                        {/* Hour Labels */}
                        <div className="border-r border-white/10 bg-white/5">
                            {HOURS.map(hour => (
                                <div
                                    key={hour}
                                    className="h-16 border-b border-white/5 flex items-center justify-center text-xs text-slate-500 font-medium"
                                >
                                    {formatHour(hour)}
                                </div>
                            ))}
                        </div>

                        {/* Day Columns */}
                        {DAYS.map(day => (
                            <div key={day} className="border-r border-white/5 last:border-r-0 relative bg-slate-900/20">
                                {HOURS.map(hour => (
                                    <div
                                        key={hour}
                                        className="h-16 border-b border-white/5 relative hover:bg-white/5 transition-colors"
                                    >
                                    </div>
                                ))}

                                {/* Render ALL shifts for this day (positioned absolutely) */}
                                {shifts.filter(s => s.day === day).map((shift) => {
                                    const startHour = timeToHour(shift.startTime);
                                    const endHour = timeToHour(shift.endTime) || 24;
                                    const startIndex = HOURS.indexOf(startHour);

                                    // Skip if shift start hour not in grid range
                                    if (startIndex === -1) return null;

                                    const duration = endHour > startHour ? endHour - startHour : (24 - startHour);
                                    const color = getRiderColor(shift.riderName);

                                    return (
                                        <div
                                            key={shift.id}
                                            className={`absolute left-1 right-1 ${color} rounded-md text-white text-xs p-2 shadow-lg shadow-black/30 cursor-pointer transition-all hover:scale-[1.02] hover:z-20 group border border-white/10`}
                                            style={{
                                                top: `${startIndex * 64}px`,
                                                height: `${duration * 64 - 4}px`,
                                                zIndex: hoveredShift === shift.id ? 30 : 10
                                            }}
                                            onMouseEnter={() => setHoveredShift(shift.id)}
                                            onMouseLeave={() => setHoveredShift(null)}
                                        >
                                            {/* Shift Content */}
                                            <div className="flex flex-col h-full justify-between">
                                                <div>
                                                    <div className="flex items-center gap-1 mb-1">
                                                        <User size={10} className="text-white/80" />
                                                        <span className="font-bold truncate text-[10px]">{shift.riderName}</span>
                                                    </div>
                                                    <div className="flex items-center gap-1 text-[9px] opacity-90">
                                                        <Clock size={8} />
                                                        <span>{shift.startTime}-{shift.endTime}</span>
                                                    </div>
                                                    {shift.zone && (
                                                        <div className="flex items-center gap-1 text-[9px] opacity-80 mt-0.5">
                                                            <MapPin size={8} />
                                                            <span>{shift.zone}</span>
                                                        </div>
                                                    )}
                                                </div>

                                                {/* Delete Button (on hover) */}
                                                {!readOnly && (
                                                    <button
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            onDeleteShift(shift.id);
                                                        }}
                                                        className="opacity-0 group-hover:opacity-100 transition-opacity bg-black/40 hover:bg-black/60 rounded p-1 self-end text-white"
                                                        title="Eliminar turno"
                                                    >
                                                        <Trash2 size={12} />
                                                    </button>
                                                )}
                                            </div>

                                            {/* Hover Tooltip - Optimized for overflow */}
                                            {hoveredShift === shift.id && (
                                                <div className="fixed sm:absolute left-1/2 sm:left-full top-1/2 sm:top-0 -translate-x-1/2 sm:translate-x-2 -translate-y-1/2 sm:translate-y-0 bg-slate-900 border border-white/10 text-white p-3 rounded-lg shadow-2xl z-50 min-w-[200px] pointer-events-none backdrop-blur-xl">
                                                    <p className="font-bold mb-2 text-primary-400">{shift.riderName}</p>
                                                    <div className="space-y-1 text-xs text-slate-300">
                                                        <p><Clock size={12} className="inline mr-1 text-blue-400" />{shift.startTime} - {shift.endTime}</p>
                                                        {shift.zone && <p><MapPin size={12} className="inline mr-1 text-teal-400" />{shift.zone}</p>}
                                                        <p className="text-slate-500 mt-2">{shift.day}</p>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        ))}
                    </div>
                </div>
            </div>

            {/* Legend */}
            <div className="border-t border-white/10 p-4 bg-white/5">
                <p className="text-xs text-slate-400 font-bold mb-2 uppercase tracking-wide">Riders Activos:</p>
                <div className="flex flex-wrap gap-2">
                    {Array.from(new Set(shifts.map(s => s.riderName))).map(rider => (
                        <div key={rider} className="flex items-center gap-2 px-3 py-1.5 bg-white/5 rounded-lg border border-white/10">
                            <div className={`w-2 h-2 rounded-full ${getRiderColor(rider)} shadow-[0_0_8px_rgba(255,255,255,0.4)]`}></div>
                            <span className="text-xs font-medium text-slate-300">{rider}</span>
                        </div>
                    ))}
                </div>
            </div>
        </div>
    );
};

export default WeeklyCalendarGrid;



================================================================================
FILE: src\context\AuthContext.jsx
================================================================================
import React, { createContext, useContext, useState, useEffect } from "react";
import { auth, db } from "../lib/firebase";
import { onAuthStateChanged, signInWithEmailAndPassword, signOut } from "firebase/auth";
import { doc, getDoc, setDoc } from "firebase/firestore";
import { logAction, AUDIT_ACTIONS } from "../lib/audit";

const AuthContext = createContext();

// eslint-disable-next-line react-refresh/only-export-components
export const useAuth = () => useContext(AuthContext);

export const AuthProvider = ({ children }) => {
    const [user, setUser] = useState(null);
    const [roleConfig, setRoleConfig] = useState(null);
    const [loading, setLoading] = useState(true);
    // ‚úÖ NUEVO: Estado calculado para facilitar la vida a los componentes
    const [isAdmin, setIsAdmin] = useState(false);

    useEffect(() => {
        const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
            try {
                if (currentUser) {
                    // 1. Obtener la configuraci√≥n real de la DB
                    const configRef = doc(db, "users_config", currentUser.uid);
                    const configSnap = await getDoc(configRef);

                    let finalConfig = null;

                    if (configSnap.exists()) {
                        finalConfig = configSnap.data();
                    }

                    // üö® SECURITY: BAN VERIFICATION
                    if (finalConfig && finalConfig.status === 'banned') {
                        await signOut(auth);
                        setUser(null);
                        return;
                    }

                    setRoleConfig(finalConfig);

                    // üî• LA MAGIA: Inyectamos el rol DENTRO del objeto usuario
                    // Esto enga√±a a los componentes viejos que buscan user.role
                    if (finalConfig && finalConfig.role) {
                        currentUser.role = finalConfig.role;
                    }

                    // Calculamos si es admin de una vez por todas
                    setIsAdmin(finalConfig?.role === 'admin');

                    // Guardamos el usuario "dopado" con su rol
                    setUser(currentUser);

                } else {
                    setUser(null);
                    setRoleConfig(null);
                    setIsAdmin(false);
                }
            } catch (err) {
                console.error("Auth Initialization Error:", err);
                setRoleConfig(null);
                setIsAdmin(false);
            } finally {
                setLoading(false);
            }
        });
        return unsubscribe;
    }, []);

    const login = async (email, password) => {
        const result = await signInWithEmailAndPassword(auth, email, password);
        logAction(result.user, AUDIT_ACTIONS.LOGIN_SUCCESS, { method: 'email_password' });
        return result;
    };

    const logout = async () => {
        if (user) {
            logAction(user, AUDIT_ACTIONS.LOGOUT);
        }
        return signOut(auth);
    };

    const assignRole = async (targetUid, role, franchiseId = null, targetEmail = null) => {
        const payload = { role, franchiseId };
        if (targetEmail) payload.email = targetEmail;

        await setDoc(doc(db, "users_config", targetUid), payload, { merge: true });

        // 2. Mirror to Public Profile (Sync)
        // Esto asegura que la tabla de usuarios vea el rol actualizado
        await setDoc(doc(db, "users", targetUid), { role }, { merge: true });

        if (user && targetUid === user.uid) {
            const newConfig = { ...roleConfig, role, franchiseId };
            setRoleConfig(newConfig);
            // Actualizamos tambi√©n el helper
            setIsAdmin(role === 'admin');
            // Y el usuario en memoria
            user.role = role;
            setUser({ ...user });
        }
    };

    // üì¶ EXPORTAMOS EL PAQUETE COMPLETO
    const value = {
        user,           // El usuario (ahora con .role inyectado)
        roleConfig,     // La config pura
        isAdmin,        // ‚úÖ El booleano m√°gico para abrir puertas
        login,
        logout,
        assignRole,
        loading
    };

    return (
        <AuthContext.Provider value={value}>
            {!loading && children}
        </AuthContext.Provider>
    );
};


================================================================================
FILE: src\context\contexts.js
================================================================================
import { createContext } from 'react';

export const ThemeContext = createContext();
export const ToastContext = createContext();



================================================================================
FILE: src\context\SupportContext.jsx
================================================================================
import React, { createContext } from 'react';
import { useAuth } from './AuthContext';
import { useSupportManager } from '../hooks/useSupportManager';

export const SupportContext = createContext(null);

export const SupportProvider = ({ children }) => {
    const { user } = useAuth();
    const supportData = useSupportManager(user);

    return (
        <SupportContext.Provider value={supportData}>
            {children}
        </SupportContext.Provider>
    );
};



================================================================================
FILE: src\context\ThemeContext.jsx
================================================================================
import React, { useState, useEffect } from 'react';
import { ThemeContext } from './contexts';



export const ThemeProvider = ({ children }) => {
    const [theme, setTheme] = useState(localStorage.getItem('theme') || 'light');

    useEffect(() => {
        console.log('DEBUG: ThemeProvider Effect executed');
        const root = window.document.documentElement;
        if (theme === 'dark') {
            root.classList.add('dark');
        } else {
            root.classList.remove('dark');
        }
        localStorage.setItem('theme', theme);
    }, [theme]);

    const toggleTheme = () => {
        setTheme(prev => prev === 'light' ? 'dark' : 'light');
    };

    return (
        <ThemeContext.Provider value={{ theme, toggleTheme }}>
            {children}
        </ThemeContext.Provider>
    );
};



================================================================================
FILE: src\context\ToastContext.jsx
================================================================================
import React, { useState, useCallback } from 'react';
import { ToastContext } from './contexts';
import ToastContainer from '../components/ui/ToastContainer';

// export const ToastContext = createContext(); // Moved to contexts.js

export const ToastProvider = ({ children }) => {
    console.log('DEBUG: ToastProvider Refactor executed');
    const [toasts, setToasts] = useState([]);

    const addToast = useCallback((message, type = 'info', duration = 4000) => {
        const id = Math.random().toString(36).substr(2, 9);
        setToasts((prev) => [...prev, { id, message, type, duration }]);
    }, []);

    const removeToast = useCallback((id) => {
        setToasts((prev) => prev.filter((toast) => toast.id !== id));
    }, []);

    return (
        <ToastContext.Provider value={{ addToast, removeToast }}>
            {children}
            <ToastContainer toasts={toasts} removeToast={removeToast} />
        </ToastContext.Provider>
    );
};



================================================================================
FILE: src\hooks\useAcademy.js
================================================================================
import { useState, useEffect, useCallback } from 'react';
import { db } from '../lib/firebase';
import {
    collection,
    doc,
    getDocs,
    getDoc,
    addDoc,
    updateDoc,
    deleteDoc,
    query,
    where,
    orderBy,
    onSnapshot,
    runTransaction,
    writeBatch,
    serverTimestamp
} from 'firebase/firestore';

/**
 * Hook para obtener todos los m√≥dulos de la academia
 */
export const useAcademyModules = () => {
    const [modules, setModules] = useState([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        const q = query(
            collection(db, 'academy_modules'),
            orderBy('order', 'asc')
        );

        const unsubscribe = onSnapshot(q, (snapshot) => {
            const modulesData = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            setModules(modulesData);
            setLoading(false);
        });

        return () => unsubscribe();
    }, []);

    return { modules, loading };
};

/**
 * Hook para crear un nuevo m√≥dulo
 */
export const useCreateModule = () => {
    return useCallback(async (moduleData) => {
        try {
            const docRef = await addDoc(collection(db, 'academy_modules'), {
                ...moduleData,
                published: false,
                lessonCount: 0,
                createdAt: serverTimestamp() // Integrity: Server Timestamp
            });
            return docRef.id;
        } catch (error) {
            console.error('Error creating module:', error);
            throw error;
        }
    }, []);
};

/**
 * Hook para actualizar un m√≥dulo
 */
export const useUpdateModule = () => {
    return useCallback(async (moduleId, updates) => {
        try {
            const moduleRef = doc(db, 'academy_modules', moduleId);
            await updateDoc(moduleRef, {
                ...updates,
                updatedAt: serverTimestamp() // Integrity: Server Timestamp
            });
        } catch (error) {
            console.error('Error updating module:', error);
            throw error;
        }
    }, []);
};

/**
 * Hook para eliminar un m√≥dulo
 * Integrity: Uses writeBatch for Cascade Delete
 */
export const useDeleteModule = () => {
    return useCallback(async (moduleId) => {
        try {
            const batch = writeBatch(db);

            // 1. Reference module to delete
            const moduleRef = doc(db, 'academy_modules', moduleId);
            batch.delete(moduleRef);

            // 2. Find and delete all associated lessons (Cascade)
            const lessonsQ = query(
                collection(db, 'academy_lessons'),
                where('moduleId', '==', moduleId)
            );
            const lessonsSnapshot = await getDocs(lessonsQ);
            lessonsSnapshot.forEach((doc) => {
                batch.delete(doc.ref);
            });

            // 3. Find and delete associated quizzes (Cascade - Optional but good practice)
            // Asumiendo que puede haber un quiz por m√≥dulo o varios
            const quizQ = query(
                collection(db, 'academy_quizzes'),
                where('moduleId', '==', moduleId)
            );
            const quizSnapshot = await getDocs(quizQ);
            quizSnapshot.forEach((doc) => {
                batch.delete(doc.ref);
            });

            // Execute Atomic Batch
            await batch.commit();
            console.log(`Module ${moduleId} deleted with cascade effect.`);
        } catch (error) {
            console.error('Error deleting module (cascade):', error);
            throw error;
        }
    }, []);
};

/**
 * Hook para obtener las lecciones de un m√≥dulo
 */
export const useModuleLessons = (moduleId) => {
    const [lessons, setLessons] = useState([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        if (!moduleId) {
            setLoading(false); // Clean: No artificial timeout
            return;
        }

        const q = query(
            collection(db, 'academy_lessons'),
            where('moduleId', '==', moduleId),
            orderBy('order', 'asc')
        );

        const unsubscribe = onSnapshot(q, (snapshot) => {
            const lessonsData = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            setLessons(lessonsData);
            setLoading(false);
        });

        return () => unsubscribe();
    }, [moduleId]);

    return { lessons, loading };
};

/**
 * Hook para crear una nueva lecci√≥n
 * Integrity: Uses runTransaction for Atomicity
 */
export const useCreateLesson = () => {
    return useCallback(async (lessonData) => {
        try {
            // Atomic Transaction: Create Lesson + Increment Count
            const newLessonId = await runTransaction(db, async (transaction) => {
                const moduleRef = doc(db, 'academy_modules', lessonData.moduleId);
                const moduleDoc = await transaction.get(moduleRef);

                if (!moduleDoc.exists()) {
                    throw new Error("Parent module does not exist!");
                }

                // Prepare new lesson ref
                const newLessonRef = doc(collection(db, 'academy_lessons'));

                // Write new lesson
                transaction.set(newLessonRef, {
                    ...lessonData,
                    createdAt: serverTimestamp()
                });

                // Update parent counter
                const currentCount = moduleDoc.data().lessonCount || 0;
                transaction.update(moduleRef, {
                    lessonCount: currentCount + 1
                });

                return newLessonRef.id;
            });

            return newLessonId;
        } catch (error) {
            console.error('Error creating lesson (atomic):', error);
            throw error;
        }
    }, []);
};

/**
 * Hook para actualizar una lecci√≥n
 */
export const useUpdateLesson = () => {
    return useCallback(async (lessonId, updates) => {
        try {
            const lessonRef = doc(db, 'academy_lessons', lessonId);
            await updateDoc(lessonRef, {
                ...updates,
                updatedAt: serverTimestamp()
            });
        } catch (error) {
            console.error('Error updating lesson:', error);
            throw error;
        }
    }, []);
};

/**
 * Hook para eliminar una lecci√≥n
 * Integrity: Uses runTransaction for Atomicity
 */
export const useDeleteLesson = () => {
    return useCallback(async (lessonId, moduleId) => {
        try {
            await runTransaction(db, async (transaction) => {
                // Read Module first
                const moduleRef = doc(db, 'academy_modules', moduleId);
                const moduleDoc = await transaction.get(moduleRef);

                if (!moduleDoc.exists()) {
                    throw new Error("Parent module does not exist!");
                }

                // Delete Lesson
                const lessonRef = doc(db, 'academy_lessons', lessonId);
                transaction.delete(lessonRef);

                // Update parent counter
                const currentCount = moduleDoc.data().lessonCount || 0;
                transaction.update(moduleRef, {
                    lessonCount: Math.max(0, currentCount - 1)
                });
            });
        } catch (error) {
            console.error('Error deleting lesson (atomic):', error);
            throw error;
        }
    }, []);
};

/**
 * Hook para obtener el progreso del usuario en la academia
 */
export const useAcademyProgress = (userId) => {
    const [progress, setProgress] = useState({});
    const [totalProgress, setTotalProgress] = useState(0);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        if (!userId) {
            setLoading(false); // Clean: No artificial timeout
            return;
        }

        const q = query(
            collection(db, 'academy_progress'),
            where('userId', '==', userId)
        );

        const unsubscribe = onSnapshot(q, (snapshot) => {
            const progressData = {};
            let completedModules = 0;
            let totalModules = 0;

            snapshot.docs.forEach(doc => {
                const data = doc.data();
                progressData[data.moduleId] = {
                    ...data,
                    id: doc.id
                };

                totalModules++;
                if (data.completed) completedModules++;
            });

            setProgress(progressData);
            setTotalProgress(totalModules > 0 ? (completedModules / totalModules) * 100 : 0);
            setLoading(false);
        });

        return () => unsubscribe();
    }, [userId]);

    return { progress, totalProgress, loading };
};

/**
 * Hook para actualizar el progreso de un m√≥dulo
 */
export const useUpdateProgress = () => {
    return useCallback(async (userId, moduleId, progressData) => {
        try {
            const q = query(
                collection(db, 'academy_progress'),
                where('userId', '==', userId),
                where('moduleId', '==', moduleId)
            );

            const snapshot = await getDocs(q);

            if (snapshot.empty) {
                await addDoc(collection(db, 'academy_progress'), {
                    userId,
                    moduleId,
                    ...progressData,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                });
            } else {
                const docId = snapshot.docs[0].id;
                await updateDoc(doc(db, 'academy_progress', docId), {
                    ...progressData,
                    updatedAt: serverTimestamp()
                });
            }
        } catch (error) {
            console.error('Error updating progress:', error);
            throw error;
        }
    }, []);
};

/**
 * Hook para marcar una lecci√≥n como completada
 */
export const useMarkLessonComplete = () => {
    return useCallback(async (userId, moduleId, lessonId) => {
        try {
            const q = query(
                collection(db, 'academy_progress'),
                where('userId', '==', userId),
                where('moduleId', '==', moduleId)
            );

            const snapshot = await getDocs(q);
            const progressDoc = snapshot.docs[0];

            if (!progressDoc) {
                await addDoc(collection(db, 'academy_progress'), {
                    userId,
                    moduleId,
                    completedLessons: 1,
                    lessons: {
                        [lessonId]: {
                            completed: true,
                            completedAt: new Date().toISOString() // Keeping ISO for inside blob/sub-object if serverTimestamp() is strict about top level fields or map fields. Actually, it works in maps too, but let's stick to simple for deep objects to avoid unexpected 'serverTimestamp' behavior in arrayUnion or deep maps if not careful. But 'lessons' is a map. It should be fine. I will use ISO for sub-field to be safe as serverTimestamp inside a map can be tricky if reading immediately back on client without snapshot options estimates.
                        }
                    },
                    progress: 0,
                    completed: false,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                });
            } else {
                const data = progressDoc.data();
                const lessons = data.lessons || {};

                lessons[lessonId] = {
                    completed: true,
                    completedAt: new Date().toISOString()
                };

                const completedCount = Object.keys(lessons).filter(k => lessons[k].completed).length;

                await updateDoc(doc(db, 'academy_progress', progressDoc.id), {
                    lessons,
                    completedLessons: completedCount,
                    updatedAt: serverTimestamp()
                });
            }
        } catch (error) {
            console.error('Error marking lesson complete:', error);
            throw error;
        }
    }, []);
};

/**
 * Hook para obtener el quiz de un m√≥dulo
 */
export const useModuleQuiz = (moduleId) => {
    const [quiz, setQuiz] = useState(null);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        if (!moduleId) {
            setLoading(false); // Clean: No artificial timeout
            return;
        }

        const q = query(
            collection(db, 'academy_quizzes'),
            where('moduleId', '==', moduleId)
        );

        const unsubscribe = onSnapshot(q, (snapshot) => {
            if (!snapshot.empty) {
                const quizData = {
                    id: snapshot.docs[0].id,
                    ...snapshot.docs[0].data()
                };
                setQuiz(quizData);
            } else {
                setQuiz(null);
            }
            setLoading(false);
        });

        return () => unsubscribe();
    }, [moduleId]);

    return { quiz, loading };
};

/**
 * Hook para crear o actualizar un quiz
 */
export const useSaveQuiz = () => {
    return useCallback(async (moduleId, quizData) => {
        try {
            const q = query(
                collection(db, 'academy_quizzes'),
                where('moduleId', '==', moduleId)
            );

            const snapshot = await getDocs(q);

            if (snapshot.empty) {
                await addDoc(collection(db, 'academy_quizzes'), {
                    moduleId,
                    ...quizData,
                    createdAt: serverTimestamp()
                });
            } else {
                const docId = snapshot.docs[0].id;
                await updateDoc(doc(db, 'academy_quizzes', docId), {
                    ...quizData,
                    updatedAt: serverTimestamp()
                });
            }
        } catch (error) {
            console.error('Error saving quiz:', error);
            throw error;
        }
    }, []);
};

/**
 * Hook para eliminar un quiz
 */
export const useDeleteQuiz = () => {
    return useCallback(async (quizId) => {
        try {
            await deleteDoc(doc(db, 'academy_quizzes', quizId));
        } catch (error) {
            console.error('Error deleting quiz:', error);
            throw error;
        }
    }, []);
};

/**
 * Hook para guardar resultado de quiz
 */
export const useSaveQuizResult = () => {
    return useCallback(async (userId, moduleId, score, answers) => {
        try {
            await addDoc(collection(db, 'quiz_results'), {
                userId,
                moduleId,
                score,
                answers,
                completedAt: serverTimestamp()
            });

            // Actualizar progreso del m√≥dulo
            const q = query(
                collection(db, 'academy_progress'),
                where('userId', '==', userId),
                where('moduleId', '==', moduleId)
            );

            const snapshot = await getDocs(q);

            if (!snapshot.empty) {
                const progressDoc = snapshot.docs[0];
                const passed = score >= 80;

                await updateDoc(doc(db, 'academy_progress', progressDoc.id), {
                    score,
                    completed: passed,
                    quizCompleted: true,
                    completedAt: passed ? serverTimestamp() : null,
                    updatedAt: serverTimestamp()
                });
            }
        } catch (error) {
            console.error('Error saving quiz result:', error);
            throw error;
        }
    }, []);
};



================================================================================
FILE: src\hooks\useAdminAnnouncements.js
================================================================================
import { useState, useEffect } from 'react';
import { db } from '../lib/firebase';
import { collection, query, orderBy, onSnapshot, addDoc, deleteDoc, doc, serverTimestamp } from 'firebase/firestore';

export const useAdminAnnouncements = () => {
    const [announcements, setAnnouncements] = useState([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        const q = query(
            collection(db, 'announcements'),
            orderBy('createdAt', 'desc')
        );

        const unsubscribe = onSnapshot(q, (snapshot) => {
            const data = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data(),
                createdAt: doc.data().createdAt?.toDate() || new Date()
            }));
            setAnnouncements(data);
            setLoading(false);
        });

        return () => unsubscribe();
    }, []);

    const createAnnouncement = async (title, content, type = 'news', priority = 'normal', targetAudience = 'all', targetFranchises = []) => {
        await addDoc(collection(db, 'announcements'), {
            title,
            content,
            type, // 'news', 'alert', 'poll'
            priority, // 'normal', 'high', 'critical'
            targetAudience, // 'all', 'specific'
            targetFranchises, // array of franchise IDs
            createdAt: serverTimestamp(),
            reads: [], // Array of userIDs who read it
            votes: []
        });
    };

    const markAsRead = async (announcementId, userId) => {
        if (!userId) return;
        const ref = doc(db, 'announcements', announcementId);
        // We use arrayUnion to add unique userIds only
        const { arrayUnion, updateDoc } = await import('firebase/firestore');
        await updateDoc(ref, {
            reads: arrayUnion(userId)
        });
    };

    const deleteAnnouncement = async (id) => {
        await deleteDoc(doc(db, 'announcements', id));
    };



    return {
        announcements,
        loading,
        createAnnouncement,
        deleteAnnouncement,
        markAsRead
    };
};



================================================================================
FILE: src\hooks\useAdminDashboardData.js
================================================================================
import { useState, useEffect } from 'react';
import { collection, getDocs, doc, getDoc } from 'firebase/firestore';
import { db } from '../lib/firebase';
import { calculateMonthlyRevenue, calculateExpenses, DEFAULT_MONTH_DATA } from '../lib/finance';
import { useAuth } from '../context/AuthContext'; // <--- 1. IMPORTAR CONTEXTO

export const useAdminDashboardData = (selectedMonth) => {
    const { user } = useAuth(); // <--- 2. OBTENER USUARIO

    const [franchises, setFranchises] = useState([]);
    const [stats, setStats] = useState({
        totalRevenue: 0,
        totalProfit: 0,
        totalOrders: 0,
        franchiseCount: 0,
        margin: 0,
        powerMetrics: {
            globalCAC: 0,
            globalIncidentRatio: 0,
            avgLaborRatio: 0
        },
        costStructure: []
    });
    const [trendData, setTrendData] = useState([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);

    useEffect(() => {
        // --- 3. EL FRENO DE MANO DE SEGURIDAD ---
        if (!user) {
            setLoading(false); // Dejamos de cargar si no hay usuario
            return; // ¬°DETENERSE AQU√ç! No llamar a Firebase.
        }

        const fetchGlobalData = async () => {
            setLoading(true);
            setError(null);
            try {
                // 1. Fetch All Franchises (Configuration)
                let franchiseDocs = [];
                try {
                    const q = collection(db, "franchises");
                    const snapshot = await getDocs(q);
                    franchiseDocs = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                } catch (e) {
                    console.error("Error fetching franchises list", e);
                    throw new Error("No se pudo conectar con la base de datos de franquicias.");
                }

                if (franchiseDocs.length === 0) {
                    setFranchises([]);
                    setLoading(false);
                    return;
                }

                // 2. Fetch Monthly Data for Each Franchise
                const promises = franchiseDocs.map(async (f) => {
                    try {
                        const monthDocRef = doc(db, "franchises", f.id, "monthly_data", selectedMonth);
                        const monthSnap = await getDoc(monthDocRef);

                        let data = DEFAULT_MONTH_DATA;
                        if (monthSnap.exists()) {
                            data = monthSnap.data();
                        }

                        const tariffsSnap = await getDoc(doc(db, "config", "tariffs"));
                        const tariffs = tariffsSnap.exists() ? tariffsSnap.data() : null;

                        const revenue = calculateMonthlyRevenue(data, tariffs);
                        const expenses = calculateExpenses(revenue, parseFloat(data.orders || 0), data);

                        return {
                            id: f.id,
                            name: f.name || f.companyName || "Franquicia " + f.id.substr(0, 4),
                            email: f.email,
                            metrics: {
                                revenue,
                                profit: expenses.netProfit,
                                orders: parseFloat(data.orders || 0),
                                productivity: parseFloat(data.productivity || 0),
                                avgDistance: parseFloat(data.avgDistance || 0)
                            },
                            rawExpenses: expenses
                        };
                    } catch (e) {
                        console.warn(`Failed to load data for ${f.id}`, e);
                        return {
                            id: f.id,
                            name: f.name || "Desconocido",
                            email: "Error de sincronizaci√≥n",
                            metrics: { revenue: 0, profit: 0, orders: 0, productivity: 0, avgDistance: 0 },
                            rawExpenses: { metrics: {} },
                            error: true
                        };
                    }
                });

                const results = (await Promise.all(promises)).filter(Boolean);

                // 3. Aggregate Global Stats
                const totalRevenue = results.reduce((sum, f) => sum + f.metrics.revenue, 0);
                const totalProfit = results.reduce((sum, f) => sum + f.metrics.profit, 0);
                const totalOrders = results.reduce((sum, f) => sum + f.metrics.orders, 0);

                const validCount = results.length;
                const globalCAC = validCount > 0 ? results.reduce((sum, f) => sum + (f.rawExpenses.metrics?.cac || 0), 0) / validCount : 0;

                setFranchises(results);
                setStats({
                    totalRevenue,
                    totalProfit,
                    totalOrders,
                    franchiseCount: results.length,
                    margin: totalRevenue > 0 ? (totalProfit / totalRevenue) * 100 : 0,
                    powerMetrics: {
                        globalCAC,
                        globalIncidentRatio: 0.8,
                        avgLaborRatio: 45.2
                    },
                    costStructure: []
                });

                // 4. Trend Data
                const generateTrend = () => {
                    const months = [];
                    for (let i = 5; i >= 0; i--) {
                        const d = new Date();
                        d.setMonth(d.getMonth() - i);
                        const mName = d.toLocaleString('es-ES', { month: 'short' });
                        const variance = 0.8 + (Math.random() * 0.4);
                        months.push({
                            shortName: mName,
                            revenue: totalRevenue * variance,
                            profit: totalProfit * variance,
                            forecastRevenue: totalRevenue * variance * 1.1,
                            forecastProfit: totalProfit * variance * 1.1
                        });
                    }
                    return months;
                };
                setTrendData(generateTrend());

            } catch (err) {
                console.error("Aggregation Error:", err);
                // Si el error es de permisos, no lo mostramos agresivamente si no hay usuario (doble check)
                if (err.code === 'permission-denied') {
                    // Silent fail or redirect handled by AuthContext
                } else {
                    setError(err.message || "Error desconocido al cargar el dashboard.");
                }
            } finally {
                setLoading(false);
            }
        };

        if (selectedMonth) {
            fetchGlobalData();
        }
    }, [selectedMonth, user]); // <--- 4. A√ëADIR USER A DEPENDENCIAS

    return { franchises, stats, trendData, loading, error };
};



================================================================================
FILE: src\hooks\useAppNavigation.js
================================================================================
import { useState, useCallback } from 'react';

export const useAppNavigation = (initialView = 'dashboard') => {
    const [viewMode, setViewMode] = useState(initialView);
    const [franchiseView, setFranchiseView] = useState('cockpit');
    const [targetFranchiseId, setTargetFranchiseId] = useState(null);
    const [targetFranchiseName, setTargetFranchiseName] = useState(null);

    const handleAdminSelectFranchise = useCallback((uid, name) => {
        setTargetFranchiseId(uid);
        setTargetFranchiseName(name);
        setViewMode('franchise_detail');
    }, []);

    // Reset to default dashboard view
    const resetView = useCallback(() => {
        setViewMode('dashboard');
        setTargetFranchiseId(null);
        setTargetFranchiseName(null);
    }, []);

    return {
        viewMode,
        setViewMode,
        franchiseView,
        setFranchiseView,
        targetFranchiseId,
        targetFranchiseName,
        handleAdminSelectFranchise,
        resetView,
        setTargetFranchiseId, // Exposed if needed for direct manipulation
        setTargetFranchiseName
    };
};



================================================================================
FILE: src\hooks\useDashboardData.js
================================================================================
import { useState, useEffect, useCallback } from 'react';
import { db } from '../lib/firebase';
import { doc, getDoc, setDoc } from 'firebase/firestore';
import { logAction, AUDIT_ACTIONS } from '../lib/audit';
import { calculateMonthlyRevenue, calculateExpenses, DEFAULT_MONTH_DATA } from '../lib/finance';
import { aggregateReports } from '../lib/aggregator';

import { useAuth } from '../context/AuthContext';

export const useDashboardData = (dataOwnerUid, selectedMonth, viewPeriod = 'month', tariffs = null) => {
    const { user } = useAuth();

    const [currentData, setCurrentData] = useState(DEFAULT_MONTH_DATA);
    const [report, setReport] = useState(null);
    const [previousReport, setPreviousReport] = useState(null);
    const [last6MonthsData, setLast6MonthsData] = useState([]);
    const [saving, setSaving] = useState(false);

    // Core Data Loading Logic
    useEffect(() => {
        // --- SECURITY GUARD ---
        if (!user) {
            return;
        }

        if (!dataOwnerUid) return;
        setSaving(true);

        const loadLogic = async () => {
            try {
                if (viewPeriod === 'month') {
                    // 1. Fetch Current Month Data
                    const fetchRef = doc(db, "franchises", dataOwnerUid, "monthly_data", selectedMonth);

                    // CACHE CHECK
                    const cacheKey = `dashboard_data_${dataOwnerUid}_${selectedMonth}`;
                    const cached = localStorage.getItem(cacheKey);
                    if (cached) {
                        try {
                            setCurrentData(JSON.parse(cached));
                            setSaving(false); // Valid cache loaded
                        } catch (e) { console.warn("Cache parse failed", e); }
                    }

                    const docSnap = await getDoc(fetchRef);

                    if (docSnap.exists()) {
                        const newData = docSnap.data();
                        setCurrentData(newData);
                        // UPDATE CACHE
                        localStorage.setItem(cacheKey, JSON.stringify(newData));
                    } else {
                        // Only reset if no cache or if verified empty
                        if (!cached) setCurrentData(DEFAULT_MONTH_DATA);
                    }

                    // 2. Load Previous Month (for Comparison)
                    const [year, month] = selectedMonth.split('-');
                    const prevDate = new Date(parseInt(year), parseInt(month) - 2); // -2 because month is 1-indexed
                    const prevMonth = `${prevDate.getFullYear()}-${String(prevDate.getMonth() + 1).padStart(2, '0')}`;

                    const prevDocSnap = await getDoc(doc(db, "franchises", dataOwnerUid, "monthly_data", prevMonth));
                    let prevRep = null;
                    if (prevDocSnap.exists()) {
                        const prevData = prevDocSnap.data();
                        const prevRevenue = calculateMonthlyRevenue(prevData, tariffs);
                        const r = (val) => parseFloat(val) || 0;
                        const prevOrders = r(prevData.orders);
                        const prevExpenses = calculateExpenses(prevRevenue, prevOrders, prevData);

                        prevRep = {
                            revenue: prevRevenue,
                            profit: prevExpenses.netProfit,
                            netProfitPostTax: prevExpenses.taxes.netProfitPostTax
                        };
                    }
                    setPreviousReport(prevRep);

                    // 3. Calculate Current Report
                    // We re-calculate this derived state whenever data changes, 
                    // but on initial load we do it here to ensure we have it immediately.
                    // The useEffect below handles updates when 'currentData' changes locally.
                } else {
                    // YEARLY VIEW
                    const year = selectedMonth.split('-')[0];
                    const months = Array.from({ length: 12 }, (_, i) => {
                        const m = String(i + 1).padStart(2, '0');
                        return `${year}-${m}`;
                    });

                    const promises = months.map(m => getDoc(doc(db, "franchises", dataOwnerUid, "monthly_data", m)));
                    const snapshots = await Promise.all(promises);

                    const monthlyReports = snapshots.map((s) => {
                        try {
                            if (s.exists()) {
                                const d = s.data();
                                const r = (val) => parseFloat(val) || 0;
                                const rev = calculateMonthlyRevenue(d, tariffs);
                                const orders = r(d.orders);
                                const exps = calculateExpenses(rev, orders, d);
                                return {
                                    revenue: rev,
                                    orders: orders,
                                    profit: exps.netProfit,
                                    expenses: exps.totalExpenses,
                                    taxes: exps.taxes,
                                    breakdown: exps.breakdown,
                                    metrics: exps.metrics
                                };
                            }
                        } catch (e) {
                            console.warn("Skipping corrupted month data", e);
                        }
                        return null; // Skip empty or error
                    }).filter(Boolean);

                    const aggregated = aggregateReports(monthlyReports);
                    setReport(aggregated || null);
                    setCurrentData(DEFAULT_MONTH_DATA); // Clear edit form in year mode
                }
            } catch (err) {
                console.error("Error loading data:", err);
            } finally {
                setSaving(false);
            }
        };

        const loadTrendData = async () => {
            // 4. Load Last 6 Months (Trend)
            const last6Data = [];
            for (let i = 5; i >= 0; i--) {
                const d = new Date();
                d.setMonth(d.getMonth() - i);
                const mStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;

                try {
                    const snap = await getDoc(doc(db, "franchises", dataOwnerUid, "monthly_data", mStr));
                    if (snap.exists()) {
                        const data = snap.data();
                        const revenue = calculateMonthlyRevenue(data, tariffs);
                        const r = (val) => parseFloat(val) || 0;
                        const orders = r(data.orders);
                        const expenses = calculateExpenses(revenue, orders, data);
                        last6Data.push({
                            month: mStr,
                            revenue,
                            profit: expenses.netProfit
                        });
                    }
                } catch (e) {
                    console.warn(`Error loading trend data for ${mStr}`, e);
                }
            }
            setLast6MonthsData(last6Data);
        };

        loadLogic();
        if (viewPeriod === 'month') loadTrendData();

    }, [dataOwnerUid, selectedMonth, viewPeriod, tariffs, user]);

    // Derived Report Calculation (Local Updates)
    useEffect(() => {
        if (viewPeriod === 'month') {
            const revenue = calculateMonthlyRevenue(currentData, tariffs);
            const r = (val) => parseFloat(val) || 0;
            const orders = r(currentData.orders);
            const expenses = calculateExpenses(revenue, orders, currentData);

            setReport({
                revenue,
                orders,
                profit: expenses.netProfit,
                expenses: expenses.totalExpenses,
                taxes: expenses.taxes,
                breakdown: expenses.breakdown,
                metrics: expenses.metrics
            });
        }
    }, [currentData, tariffs, viewPeriod]);

    // Handle Saving
    const handleUpdate = useCallback(async (newData) => {
        if (viewPeriod === 'year') return;
        setCurrentData(newData);
        if (!dataOwnerUid) return;

        setSaving(true);
        try {
            await setDoc(doc(db, "franchises", dataOwnerUid, "monthly_data", selectedMonth), newData);

            // Update Cache Immediately
            const cacheKey = `dashboard_data_${dataOwnerUid}_${selectedMonth}`;
            localStorage.setItem(cacheKey, JSON.stringify(newData));

            // Audit
            if (user) {
                logAction(user, AUDIT_ACTIONS.MONTHLY_DATA_EDITED, {
                    month: selectedMonth,
                    franchiseId: dataOwnerUid
                });
            }
        } catch (e) {
            console.error("Error saving to cloud", e);
        }
        // Artificial delay for UX
        setTimeout(() => setSaving(false), 800);
    }, [viewPeriod, dataOwnerUid, selectedMonth, user]);

    return {
        currentData,
        report,
        previousReport,
        last6MonthsData,
        saving,
        handleUpdate
    };
};



================================================================================
FILE: src\hooks\useExport.js
================================================================================
import { useCallback } from 'react';
import { formatMoney } from '../lib/finance';

export const useExport = () => {
    const exportCSV = useCallback((report, selectedMonth, titlePrefix = 'REPORTE FINANCIERO') => {
        if (!report) return;

        const rows = [
            [`${titlePrefix} [${selectedMonth}]`, new Date().toLocaleDateString()],
            [],
            ["METRICAS PRINCIPALES"],
            ["Ingresos Totales", formatMoney(report.revenue)],
            ["Beneficio Neto Real", formatMoney(report.taxes?.netProfitPostTax || 0)],
            [],
            ["LOGISTICA AVANZADA"],
            ["Coste / Km", (report.metrics?.costPerKm || 0).toFixed(3)],
            ["Drop Density", (report.metrics?.dropDensity || 0).toFixed(2)],
            [],
            ["DESGLOSE DE COSTES"],
            ["Concepto", "Tipo", "Valor"],
            ...(report.breakdown || []).map(item => [item.name, item.type, formatMoney(item.value)])
        ];

        let csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
        const encodedUri = encodeURI(csvContent);

        // Create temporal link element
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `reporte_${selectedMonth}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }, []);

    return { exportCSV };
};



================================================================================
FILE: src\hooks\useFeatureAccess.js
================================================================================
import { useState, useEffect } from 'react';
import { db, auth } from '../lib/firebase';
import { doc, getDoc } from 'firebase/firestore';

/**
 * Hook para verificar acceso a features seg√∫n permisos de franquicia
 * @returns {Object} { hasAccess, features, loading, pack }
 */
export const useFeatureAccess = () => {
    const [features, setFeatures] = useState(null);
    const [pack, setPack] = useState(null);
    const [loading, setLoading] = useState(true);
    const currentUser = auth.currentUser;

    useEffect(() => {
        if (!currentUser) {
            const timer = setTimeout(() => setLoading(false), 0);
            return () => clearTimeout(timer);
        }

        const fetchUserFeatures = async () => {
            try {
                // Si es admin, tiene acceso a todo
                if (currentUser.email === 'admin@repaart.com' || currentUser.uid === 'admin') {
                    setFeatures({
                        downloads: true,
                        ai_coach: true,
                        simulations: true
                    });
                    setPack('admin');
                    setLoading(false);
                    return;
                }

                // Buscar datos de franquicia
                const franchiseDoc = await getDoc(doc(db, 'franchises', currentUser.uid));

                if (franchiseDoc.exists()) {
                    const data = franchiseDoc.data();

                    // Si tiene features definidas, usarlas
                    if (data.features) {
                        setFeatures(data.features);
                    } else {
                        // Crear features por defecto seg√∫n pack
                        const defaultFeatures = getDefaultFeaturesByPack(data.pack || 'basic');
                        setFeatures(defaultFeatures);
                    }

                    setPack(data.pack || 'basic');
                } else {
                    // Usuario sin franquicia registrada - asignar b√°sico
                    const defaultFeatures = getDefaultFeaturesByPack('basic');
                    setFeatures(defaultFeatures);
                    setPack('basic');
                }

                setLoading(false);
            } catch (error) {
                console.error('Error fetching user features:', error);
                // En caso de error, dar acceso b√°sico
                setFeatures(getDefaultFeaturesByPack('basic'));
                setPack('basic');
                setLoading(false);
            }
        };

        fetchUserFeatures();
    }, [currentUser]);

    /**
     * Verifica si el usuario tiene acceso a una feature espec√≠fica
     * @param {string} featureName - Nombre de la feature (downloads, ai_coach, simulations)
     * @returns {boolean}
     */
    const hasAccess = (featureName) => {
        if (loading) return false;
        if (!features) return false;
        return features[featureName] === true;
    };

    return {
        hasAccess,
        features,
        pack,
        loading
    };
};

/**
 * Features por defecto seg√∫n tipo de pack
 * @param {string} packType - "basic" | "premium" | "admin"
 * @returns {Object} Features object
 */
const getDefaultFeaturesByPack = (packType) => {
    const packs = {
        basic: {
            downloads: false,
            ai_coach: false,
            simulations: false
        },
        premium: {
            downloads: true,
            ai_coach: true,
            simulations: true
        },
        admin: {
            downloads: true,
            ai_coach: true,
            simulations: true
        }
    };

    return packs[packType] || packs.basic;
};



================================================================================
FILE: src\hooks\useIntelligence.js
================================================================================
import { useMemo } from 'react';
import {
    checkSupportHealth,
    detectUserAnomaly,
    generatePredictiveAlerts,
    calculateHealthScore
} from '../utils/analyticsHelpers';

/**
 * useIntelligence Hook
 * 
 * "The Engine that processes reality."
 * Aggregates data from disparate sources (Support, Users, Sales) 
 * to generate high-level business insights and alerts.
 * 
 * @param {Object} params
 * @param {Array} params.tickets - From useSupportManager
 * @param {Array} params.users - From useUserManager
 * @param {Object} params.dashboardData - From useAdminDashboardData
 */
export const useIntelligence = ({ tickets = [], users = [], dashboardData = {} }) => {

    // 1. Analyze Support Vector
    const supportAnalysis = useMemo(() => {
        return checkSupportHealth(tickets);
    }, [tickets]);

    // 2. Analyze User/Growth Vector
    const userAnalysis = useMemo(() => {
        return detectUserAnomaly(users, dashboardData);
    }, [users, dashboardData]);

    // 3. Aggregate Alerts
    const alerts = useMemo(() => {
        return generatePredictiveAlerts(supportAnalysis, userAnalysis);
    }, [supportAnalysis, userAnalysis]);

    // 4. Calculate Global Health Score
    const healthScore = useMemo(() => {
        return calculateHealthScore(alerts);
    }, [alerts]);

    // 5. Predictive Trends (Placeholder for ML expansion)
    const predictions = useMemo(() => {
        return {
            supportLoad: supportAnalysis.status === 'bottleneck' ? 'increasing' : 'stable',
            growth: userAnalysis.detected ? 'feature_spike' : 'organic',
            nextAction: alerts.length > 0 ? 'immediate_attention' : 'monitor'
        };
    }, [supportAnalysis, userAnalysis, alerts]);

    return {
        // High Level
        healthScore,
        status: healthScore > 80 ? 'optimal' : healthScore > 50 ? 'warning' : 'critical',

        // Actionable
        alerts,
        predictions,

        // Raw Analysis (for drilling down)
        raw: {
            support: supportAnalysis,
            users: userAnalysis
        }
    };
};



================================================================================
FILE: src\hooks\useRBAC.js
================================================================================
import { useAuth } from '../context/AuthContext';
import { useCallback } from 'react';

// Central Permission Matrix
// 'write' implies read access. 'read' implies read-only.
const MODULE_PERMISSIONS = {
    finance: {
        admin: 'write',     // Admin manages finance
        franchise: 'read',  // Franchisee views their finances
        user: 'none'
    },
    academy: {
        admin: 'read',      // Admin monitors progress
        franchise: 'write', // Franchisee takes courses (writes progress)
        user: 'none'
    },
    operations: {
        admin: 'read',      // Admin audits/supports
        franchise: 'write', // Franchisee manages daily ops
        user: 'none'
    }
};

export const useRBAC = () => {
    const { user } = useAuth();
    // Default to 'user' role if none defined
    const role = user?.role || 'user';

    /**
     * Checks if the current user has access to a specific module and action.
     * @param {string} module - 'finance', 'academy', 'operations'
     * @param {string} action - 'read' or 'write'
     */
    const checkAccess = useCallback((module, action = 'read') => {
        if (!user) return false;

        const modulePerms = MODULE_PERMISSIONS[module];
        if (!modulePerms) {
            console.warn(`RBAC: Unknown module '${module}' requested.`);
            return false;
        }

        const rolePerm = modulePerms[role];
        if (!rolePerm || rolePerm === 'none') return false;

        if (action === 'read') {
            // Both 'read' and 'write' permissions allow reading
            return rolePerm === 'read' || rolePerm === 'write';
        }

        if (action === 'write') {
            return rolePerm === 'write';
        }

        return false;
    }, [user, role]);

    const canRead = (module) => checkAccess(module, 'read');
    const canWrite = (module) => checkAccess(module, 'write');

    return {
        checkAccess,
        canRead,
        canWrite,
        role,
        MODULE_PERMISSIONS // Exporting for reference/debugging if needed
    };
};



================================================================================
FILE: src\hooks\useSupport.js
================================================================================
import { useContext } from 'react';
import { SupportContext } from '../context/SupportContext';

export const useSupport = () => {
    const context = useContext(SupportContext);
    if (!context) {
        throw new Error('useSupport must be used within a SupportProvider');
    }
    return context;
};



================================================================================
FILE: src\hooks\useSupportHub.js
================================================================================
import { useState, useEffect, useCallback, useMemo } from 'react';
import { db, storage } from '../lib/firebase';
import { collection, addDoc, serverTimestamp, query, where, orderBy, onSnapshot, updateDoc, doc } from 'firebase/firestore';
import { ref, uploadBytes, getDownloadURL } from 'firebase/storage';
import { sendTicketCreatedEmail } from '../lib/email';
import { logAction, AUDIT_ACTIONS } from '../lib/audit';
import { getSuggestions } from '../lib/knowledgeBase';

export const useSupportHub = (user) => {
    // --- STATE ---
    const [myTickets, setMyTickets] = useState([]);
    const [loadingTickets, setLoadingTickets] = useState(true);
    const [sending, setSending] = useState(false);
    const [success, setSuccess] = useState(false);

    // Upload State (Atomic)
    const [file, setFile] = useState(null);
    const [uploading, setUploading] = useState(false);

    // Filters & Search
    const [ticketFilter, setTicketFilter] = useState('all'); // 'all', 'open', 'resolved'

    // Form Assistant
    const [suggestions, setSuggestions] = useState([]);

    // --- REAL-TIME DATA ---
    useEffect(() => {
        if (!user) return;

        const q = query(
            collection(db, "tickets"),
            where("uid", "==", user.uid),
            orderBy("createdAt", "desc")
        );

        const unsubscribe = onSnapshot(q, (snapshot) => {
            const tickets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setMyTickets(tickets);
            setLoadingTickets(false);
        }, (error) => {
            console.error("Error fetching tickets:", error);
            setLoadingTickets(false);
        });

        return () => unsubscribe();
    }, [user]);

    // --- ACTIONS ---

    const handleSubjectChange = useCallback((text) => {
        if (text.length > 2) {
            setSuggestions(getSuggestions(text));
        } else {
            setSuggestions([]);
        }
    }, []);

    const createTicket = useCallback(async ({ subject, message, urgency, category }) => {
        if (!user || !subject || !message) return;

        setSending(true);
        try {
            // 1. Initial Firestore Doc
            const ticketData = {
                uid: user.uid,
                email: user.email,
                subject,
                message,
                urgency,
                category,
                status: 'open',
                createdAt: serverTimestamp(),
                read: false,
                hasAttachment: !!file
            };

            const docRef = await addDoc(collection(db, "tickets"), ticketData);

            // 2. Upload File (if exists)
            let attachmentUrl = null;
            if (file) {
                setUploading(true);
                try {
                    const storageRef = ref(storage, `tickets/${docRef.id}/${file.name}`);
                    await uploadBytes(storageRef, file);
                    attachmentUrl = await getDownloadURL(storageRef);

                    // Update ticket with URL
                    await updateDoc(doc(db, "tickets", docRef.id), { attachmentUrl });
                } catch (uploadErr) {
                    console.error("Upload failed but ticket created:", uploadErr);
                    // We don't fail the whole process if upload fails, but we might warn
                } finally {
                    setUploading(false);
                }
            }

            // 3. Post-Processing
            logAction(user, AUDIT_ACTIONS.TICKET_CREATED, {
                ticketId: docRef.id,
                subject,
                category,
                urgency,
                hasAttachment: !!file
            });

            sendTicketCreatedEmail({
                id: docRef.id,
                email: user.email,
                subject,
                message: message + (attachmentUrl ? `\n\n[Adjunto: ${file.name}]` : ''),
                urgency,
                category
            }).catch(err => console.warn("Email send failed", err));

            setSuccess(true);
            setFile(null); // Reset file
            setSuggestions([]);

            // Auto-hide success message
            setTimeout(() => setSuccess(false), 5000);

            return true;
        } catch (error) {
            console.error("Error creating ticket:", error);
            throw error;
        } finally {
            setSending(false);
        }
    }, [user, file]);

    // --- DERIVED STATE ---
    const filteredTickets = useMemo(() => {
        if (ticketFilter === 'all') return myTickets;
        if (ticketFilter === 'open') return myTickets.filter(t => t.status !== 'resolved');
        return myTickets.filter(t => t.status === 'resolved');
    }, [myTickets, ticketFilter]);

    return {
        // Data
        tickets: filteredTickets,
        allTicketsCount: myTickets.length,
        loading: loadingTickets,

        // Form State
        sending,
        success,
        suggestions,
        setSuggestions, // In case we need manual clear

        // Upload State
        file,
        setFile,
        uploading,

        // Actions
        handleSubjectChange,
        createTicket,
        setTicketFilter,
        ticketFilter,

        // Helper
        resetSuccess: () => setSuccess(false)
    };
};



================================================================================
FILE: src\hooks\useSupportManager.js
================================================================================
import { useState, useEffect, useMemo, useCallback, useRef } from 'react';
import { collection, query, orderBy, onSnapshot, doc, updateDoc, serverTimestamp, addDoc } from 'firebase/firestore';
import { db } from '../lib/firebase';
import { logAction, AUDIT_ACTIONS } from '../lib/audit';
import { sendTicketReplyEmail } from '../lib/email';
import { createNotification } from '../lib/notifications';
import { getStatusConfig } from '../lib/constants';

export const useSupportManager = (currentUser) => {
    // --- STATE ---
    const [tickets, setTickets] = useState([]);
    const [loading, setLoading] = useState(true);
    const [selectedTicketId, setSelectedTicketId] = useState(null);
    const [messages, setMessages] = useState([]);
    const [reply, setReply] = useState('');
    const [isInternal, setIsInternal] = useState(false);
    const [isSendingReply, setIsSendingReply] = useState(false);

    // Filters
    const [searchQuery, setSearchQuery] = useState('');
    const [filterTab, setFilterTab] = useState('all');
    const [categoryFilter] = useState('all');
    const messagesEndRef = useRef(null);

    // --- REAL-TIME TICKETS ---
    useEffect(() => {
        const q = query(collection(db, "tickets"), orderBy("createdAt", "desc"));
        const unsubscribe = onSnapshot(q, (snapshot) => {
            const t = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setTickets(t);
            setLoading(false);
        });
        return () => unsubscribe();
    }, []);

    // --- DERIVED SELECTED TICKET ---
    const selectedTicket = useMemo(() =>
        tickets.find(t => t.id === selectedTicketId),
        [tickets, selectedTicketId]);

    // --- REAL-TIME MESSAGES (For Selected) ---
    useEffect(() => {
        if (!selectedTicketId) {
            setMessages([]);
            return;
        }
        const q = query(
            collection(db, "tickets", selectedTicketId, "messages"),
            orderBy("createdAt", "asc")
        );
        const unsubscribe = onSnapshot(q, (snapshot) => {
            const msgs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setMessages(msgs);
        });
        return () => unsubscribe();
    }, [selectedTicketId]);

    // --- ACTIONS ---

    const handleSelectTicket = useCallback((id) => {
        setSelectedTicketId(id);
    }, []);

    const handleToggleRead = useCallback(async (e, id, currentReadStatus) => {
        if (e) e.stopPropagation();

        // Optimistic UI Update
        setTickets(prev => prev.map(t => t.id === id ? { ...t, read: !currentReadStatus } : t));

        try {
            await updateDoc(doc(db, "tickets", id), { read: !currentReadStatus });
        } catch (error) {
            console.error("Error toggling read:", error);
            // Revert on error (could be handled better but ok for now)
            setTickets(prev => prev.map(t => t.id === id ? { ...t, read: currentReadStatus } : t));
        }
    }, []);

    const handleStatusChange = useCallback(async (id, newStatus) => {
        try {
            await updateDoc(doc(db, "tickets", id), {
                status: newStatus,
                ...(newStatus === 'resolved' ? { resolvedAt: serverTimestamp() } : {})
            });
            if (currentUser) {
                logAction(currentUser, AUDIT_ACTIONS.TICKET_UPDATE, { ticketId: id, status: newStatus });
            }
        } catch (error) {
            console.error("Error updating status:", error);
            throw new Error("No se pudo actualizar el estado.");
        }
    }, [currentUser]);

    const handleReply = useCallback(async (e) => {
        if (e) e.preventDefault();
        if (!reply || !selectedTicket) return;

        setIsSendingReply(true);
        try {
            // 1. Send Email (only if public)
            if (!isInternal) {
                await sendTicketReplyEmail(
                    selectedTicket.email,
                    selectedTicket.subject,
                    reply,
                    selectedTicket.message,
                    selectedTicket.id
                );
            }

            // 2. Add to Messages Subcollection
            await addDoc(collection(db, "tickets", selectedTicket.id, "messages"), {
                text: reply,
                senderId: currentUser.uid,
                senderRole: 'admin',
                createdAt: serverTimestamp(),
                isInternal: isInternal
            });

            // 3. Update Parent Ticket
            const newStatus = isInternal ? selectedTicket.status : 'pending_user';

            await updateDoc(doc(db, "tickets", selectedTicket.id), {
                status: newStatus,
                response: isInternal ? selectedTicket.response : reply,
                respondedAt: serverTimestamp(),
                read: true,
                lastMessageAt: serverTimestamp()
            });

            if (currentUser) {
                logAction(currentUser, isInternal ? AUDIT_ACTIONS.TICKET_NOTE : AUDIT_ACTIONS.TICKET_REPLIED, { ticketId: selectedTicket.id });
            }

            // Notification
            if (!isInternal) {
                createNotification(
                    selectedTicket.uid,
                    'Nueva respuesta de Soporte',
                    `Han respondido a tu ticket: ${selectedTicket.subject}`,
                    'info',
                    `/support`
                );
            }

            setReply('');
            setIsInternal(false);
        } catch (error) {
            console.error("Reply error:", error);
            throw error;
        } finally {
            setIsSendingReply(false);
        }
    }, [reply, selectedTicket, currentUser, isInternal]);

    // --- FILTER & METRICS LOGIC ---

    const filteredTickets = useMemo(() => {
        let result = tickets;

        if (filterTab === 'open') result = result.filter(t => t.status !== 'resolved');
        else if (filterTab === 'resolved') result = result.filter(t => t.status === 'resolved');
        else if (filterTab === 'high') result = result.filter(t => t.urgency === 'high' || t.urgency === 'critical');
        else if (filterTab === 'unread') result = result.filter(t => !t.read);

        if (categoryFilter !== 'all') result = result.filter(t => t.category === categoryFilter);

        if (searchQuery) {
            const q = searchQuery.toLowerCase();
            result = result.filter(t =>
                t.subject?.toLowerCase().includes(q) ||
                t.email?.toLowerCase().includes(q) ||
                t.message?.toLowerCase().includes(q)
            );
        }
        return result;
    }, [tickets, filterTab, categoryFilter, searchQuery]);

    const metrics = useMemo(() => {
        // Calculation logic extracted precisely from original
        const total = tickets.length;
        const open = tickets.filter(t => t.status === 'open' || !t.status).length;
        const pending = tickets.filter(t => t.status === 'pending_user').length;
        const investigating = tickets.filter(t => t.status === 'investigating').length;
        const resolved = tickets.filter(t => t.status === 'resolved').length;
        const unread = tickets.filter(t => !t.read).length;
        const critical = tickets.filter(t => t.urgency === 'critical').length;
        const high = tickets.filter(t => t.urgency === 'high').length;

        const resolvedWithTime = tickets.filter(t => t.respondedAt && t.createdAt);
        const avgResponseMinutes = resolvedWithTime.length > 0
            ? resolvedWithTime.reduce((acc, t) => {
                const created = t.createdAt?.toDate ? t.createdAt.toDate() : new Date();
                const responded = t.respondedAt?.toDate ? t.respondedAt.toDate() : new Date();
                return acc + (responded - created) / (1000 * 60);
            }, 0) / resolvedWithTime.length
            : 0;

        const byCategory = {
            operativa: tickets.filter(t => t.category === 'operativa').length,
            finanzas: tickets.filter(t => t.category === 'finanzas').length,
            tecnico: tickets.filter(t => t.category === 'tecnico').length,
            accidente: tickets.filter(t => t.category === 'accidente').length,
        };

        return { total, open, pending, investigating, resolved, unread, critical, high, avgResponseMinutes, byCategory };
    }, [tickets]);

    // CSV Export
    const exportToCSV = useCallback(() => {
        const headers = ['ID', 'Email', 'Asunto', 'Categor√≠a', 'Urgencia', 'Estado', 'Fecha Creaci√≥n', 'Respuesta'];
        const rows = filteredTickets.map(t => [
            t.id,
            t.email,
            t.subject,
            t.category || 'N/A',
            t.urgency,
            t.status,
            t.createdAt?.toDate ? t.createdAt.toDate().toLocaleDateString() : 'Pendiente',
            t.response || 'Sin respuesta'
        ]);

        const csvContent = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `tickets_export_${new Date().toISOString().slice(0, 10)}.csv`;
        a.click();
    }, [filteredTickets]);

    return {
        // State
        tickets,
        filteredTickets,
        loading,
        selectedTicketId,
        selectedTicket,
        messages,
        metrics,

        // Filter State
        searchQuery, setSearchQuery,
        filterTab, setFilterTab,

        // Input State
        reply, setReply,
        isInternal, setIsInternal,
        isSendingReply,

        // Actions
        handleSelectTicket,
        handleToggleRead,
        handleStatusChange,
        handleReply,
        exportToCSV,
        messagesEndRef
    };
};



================================================================================
FILE: src\hooks\useTheme.js
================================================================================
import { useContext } from 'react';
import { ThemeContext } from '../context/contexts';

export const useTheme = () => useContext(ThemeContext);



================================================================================
FILE: src\hooks\useToast.js
================================================================================
import { useContext } from 'react';
import { ToastContext } from '../context/contexts';

export const useToast = () => {
    const context = useContext(ToastContext);
    if (!context) {
        throw new Error("useToast must be used within a ToastProvider");
    }
    return context;
};



================================================================================
FILE: src\hooks\useUserManager.js
================================================================================
import { useState, useEffect, useMemo, useCallback } from 'react';
import { collection, query, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, setDoc } from 'firebase/firestore';
import { sendPasswordResetEmail } from 'firebase/auth';
import { db, auth } from '../lib/firebase';
import { logAction, AUDIT_ACTIONS } from '../lib/audit';

// Custom Error for logical guards
class SecurityError extends Error {
    constructor(message) {
        super(message);
        this.name = "SecurityError";
    }
}

export const useUserManager = (currentUser) => {
    // --- STATE ---
    const [users, setUsers] = useState([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);

    // Filters
    const [searchQuery, setSearchQuery] = useState('');
    const [roleFilter, setRoleFilter] = useState('all');
    const [statusFilter, setStatusFilter] = useState('all'); // 'active', 'banned'

    // --- REAL-TIME USERS ---
    useEffect(() => {
        // Only fetch if admin
        if (currentUser?.role !== 'admin') {
            // Avoid sync state update during render phase
            const timer = setTimeout(() => {
                setLoading(false);
                setError("Acceso Denegado: No tienes permisos para ver usuarios.");
            }, 0);
            return () => clearTimeout(timer);
        }

        // IMPROVED QUERY: We simply get users. Sorting can be done client-side to avoid index issues if "createdAt" is missing
        const q = query(collection(db, "users"));

        const unsubscribe = onSnapshot(q, (snapshot) => {
            const u = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            // Client-side sort to be safe
            u.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
            setUsers(u);
            setLoading(false);
        }, (err) => {
            console.error("Error fetching users:", err);
            setError("Error al cargar usuarios. Verifica permisos o √≠ndices.");
            setLoading(false);
        });
        return () => unsubscribe();
    }, [currentUser]);

    // --- GUARDS ---
    const checkAdminPermission = useCallback(() => {
        if (currentUser?.role !== 'admin') {
            throw new SecurityError("Acceso Denegado: Nivel de autorizaci√≥n insuficiente.");
        }
    }, [currentUser]);

    const checkSelfAction = useCallback((targetUid) => {
        if (targetUid === currentUser.uid) {
            throw new SecurityError("Error de Seguridad: No puedes modificar tu propio estatus administrativo desde este panel.");
        }
    }, [currentUser]);

    // --- ACTIONS ---

    const createUser = useCallback(async (userData) => {
        checkAdminPermission();
        try {
            const uid = userData.uid || doc(collection(db, "users")).id; // Generate ID if needed

            // 1. Public Profile
            await setDoc(doc(db, "users", uid), {
                ...userData,
                uid,
                createdAt: serverTimestamp(),
                status: userData.status || 'active'
            });

            // 2. Security Config (CRITICAL SYNC)
            await setDoc(doc(db, "users_config", uid), {
                role: userData.role || 'user',
                franchiseId: userData.franchiseId || null,
                email: userData.email,
                status: userData.status || 'active'
            });

            logAction(currentUser, AUDIT_ACTIONS.USER_CREATE, { targetUser: userData.email, role: userData.role });
            return true;
        } catch (err) {
            console.error("Create User Error:", err);
            throw err;
        }
    }, [checkAdminPermission, currentUser]);

    const updateUser = useCallback(async (uid, data) => {
        checkAdminPermission();
        // Critical Guard
        if (data.role || data.status) checkSelfAction(uid);

        try {
            // 1. Update Public Profile
            await updateDoc(doc(db, "users", uid), {
                ...data,
                updatedAt: serverTimestamp()
            });

            // 2. Update Security Config if Role/Status changed
            if (data.role || data.status || data.franchiseId) {
                const configUpdate = {};
                if (data.role) configUpdate.role = data.role;
                if (data.status) configUpdate.status = data.status;
                if (data.franchiseId !== undefined) configUpdate.franchiseId = data.franchiseId;

                // Use setDoc with merge to ensure doc exists
                await setDoc(doc(db, "users_config", uid), configUpdate, { merge: true });
            }

            logAction(currentUser, AUDIT_ACTIONS.USER_UPDATE, { targetUid: uid, changes: data });
        } catch (err) {
            console.error("Update User Error:", err);
            throw err;
        }
    }, [checkAdminPermission, checkSelfAction, currentUser]);

    const deleteUser = useCallback(async (uid) => {
        checkAdminPermission();
        checkSelfAction(uid);

        try {
            await deleteDoc(doc(db, "users", uid));
            await deleteDoc(doc(db, "users_config", uid)); // Clean up security config

            logAction(currentUser, AUDIT_ACTIONS.USER_DELETE, { targetUid: uid });
        } catch (err) {
            console.error("Delete User Error:", err);
            throw err;
        }
    }, [checkAdminPermission, checkSelfAction, currentUser]);

    const toggleUserStatus = useCallback(async (uid, currentStatus) => {
        checkAdminPermission();
        checkSelfAction(uid);

        const newStatus = currentStatus === 'active' ? 'banned' : 'active';
        try {
            // Sync BOTH
            await updateDoc(doc(db, "users", uid), { status: newStatus });
            await setDoc(doc(db, "users_config", uid), { status: newStatus }, { merge: true });

            logAction(currentUser, AUDIT_ACTIONS.USER_STATUS_CHANGE, { targetUid: uid, status: newStatus });
        } catch (err) {
            console.error("Toggle Status Error:", err);
            throw err;
        }
    }, [checkAdminPermission, checkSelfAction, currentUser]);

    const sendResetPassword = useCallback(async (email) => {
        checkAdminPermission();
        try {
            await sendPasswordResetEmail(auth, email);
            logAction(currentUser, 'PASSWORD_RESET_SENT', { targetEmail: email });
        } catch (err) {
            console.error("Reset Password Error:", err);
            throw err;
        }
    }, [checkAdminPermission, currentUser]);

    // --- DERIVED DATA ---
    const filteredUsers = useMemo(() => {
        let result = users;

        if (roleFilter !== 'all') {
            result = result.filter(u => u.role === roleFilter);
        }
        if (statusFilter !== 'all') {
            result = result.filter(u => statusFilter === 'active' ? u.status !== 'banned' : u.status === 'banned');
        }

        if (searchQuery) {
            const q = searchQuery.toLowerCase();
            result = result.filter(u =>
                u.email?.toLowerCase().includes(q) ||
                u.displayName?.toLowerCase().includes(q) ||
                u.uid?.toLowerCase().includes(q)
            );
        }
        return result;
    }, [users, roleFilter, statusFilter, searchQuery]);

    const metrics = useMemo(() => ({
        total: users.length,
        admins: users.filter(u => u.role === 'admin').length,
        franchisees: users.filter(u => u.role === 'franchise').length,
        active: users.filter(u => u.status !== 'banned').length,
        banned: users.filter(u => u.status === 'banned').length
    }), [users]);

    return {
        // State
        users: filteredUsers,
        allUsersCount: users.length,
        metrics,
        loading,
        error,

        // Filters
        searchQuery, setSearchQuery,
        roleFilter, setRoleFilter,
        statusFilter, setStatusFilter,

        // Actions
        createUser,
        updateUser,
        deleteUser,
        toggleUserStatus,
        sendResetPassword
    };
};



================================================================================
FILE: src\index.css
================================================================================
@import "tailwindcss";

/* ========================================
   DESIGN SYSTEM TOKENS
   Professional design tokens for consistency
   ======================================== */
:root {
    /* === Spacing Scale === */
    --space-xs: 0.5rem;
    /* 8px */
    --space-sm: 0.75rem;
    /* 12px */
    --space-md: 1rem;
    /* 16px */
    --space-lg: 1.5rem;
    /* 24px */
    --space-xl: 2rem;
    /* 32px */
    --space-2xl: 3rem;
    /* 48px */

    /* === Surface Colors === */
    --surface-base: #f8fafc;
    /* slate-50 - App background */
    --surface-raised: #ffffff;
    /* Cards, modals */
    --surface-sunken: #f1f5f9;
    /* slate-100 - Inputs */
    --surface-overlay: rgba(255, 255, 255, 0.8);

    /* === Text Colors === */
    --text-primary: #1e293b;
    /* slate-800 - Headings */
    --text-secondary: #64748b;
    /* slate-500 - Body */
    --text-tertiary: #94a3b8;
    /* slate-400 - Subtle */
    --text-inverse: #ffffff;

    /* === Border Colors === */
    --border-subtle: #e2e8f0;
    /* slate-200 */
    --border-default: #cbd5e1;
    /* slate-300 */
    --border-strong: #94a3b8;
    /* slate-400 */

    /* === Elevation (Shadows) === */
    --shadow-none: none;
    --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
    --shadow-base: 0 1px 3px rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.08);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.10);
    --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.12);

    /* === Border Radius === */
    --radius-sm: 0.375rem;
    /* 6px */
    --radius-md: 0.5rem;
    /* 8px */
    --radius-lg: 0.75rem;
    /* 12px */
    --radius-xl: 1rem;
    /* 16px */
    --radius-2xl: 1.5rem;
    /* 24px */
    --radius-full: 9999px;

    /* === Typography === */
    --font-display: 900;
    --font-heading: 700;
    --font-body: 400;
    --font-medium: 500;
    --font-semibold: 600;

    /* === Z-Index Scale === */
    --z-base: 1;
    --z-dropdown: 10;
    --z-sticky: 20;
    --z-overlay: 30;
    --z-modal: 40;
    --z-toast: 50;

    /* Native Touch */
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
}

body {
    -webkit-user-select: none;
    user-select: none;
    overscroll-behavior-y: none;
    /* Prevent elastic scroll on body */
    background-color: #020617;
    /* Force Dark Mode Background */
    color: white;
}

input,
textarea,
[contenteditable] {
    -webkit-user-select: text;
    user-select: text;
}


@layer utilities {

    /* Existing animations */
    @keyframes fade-in-down {
        0% {
            opacity: 0;
            transform: translateY(-20px);
        }

        100% {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes fade-in-up {
        0% {
            opacity: 0;
            transform: translateY(20px);
        }

        100% {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* iOS Bounce Animation */
    @keyframes bounce-in {
        0% {
            transform: scale(0.8);
            opacity: 0;
        }

        50% {
            transform: scale(1.05);
        }

        100% {
            transform: scale(1);
            opacity: 1;
        }
    }

    /* iOS Tab Bounce */
    @keyframes tab-bounce {

        0%,
        100% {
            transform: scale(1);
        }

        25% {
            transform: scale(0.92);
        }

        75% {
            transform: scale(1.08);
        }
    }

    @keyframes gradient-xy {

        0%,
        100% {
            background-size: 400% 400%;
            background-position: left center;
        }

        50% {
            background-size: 200% 200%;
            background-position: right center;
        }
    }

    @keyframes float {

        0%,
        100% {
            transform: translateY(0px);
        }

        50% {
            transform: translateY(-20px);
        }
    }

    .animate-gradient-xy {
        animation: gradient-xy 15s ease infinite;
    }

    .animate-float {
        animation: float 6s ease-in-out infinite;
    }

    .glass {
        background: rgba(255, 255, 255, 0.25);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
        -webkit-backdrop-filter: blur(4px);
        backdrop-filter: blur(4px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .animate-fade-in-down {
        animation: fade-in-down 0.5s ease-out;
    }

    .animate-fade-in-up {
        animation: fade-in-up 0.5s ease-out forwards;
    }

    .animate-bounce-in {
        animation: bounce-in 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .animate-tab-bounce {
        animation: tab-bounce 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    /* iOS Glassmorphism Effect */
    .ios-blur {
        background: rgba(255, 255, 255, 0.75);
        -webkit-backdrop-filter: blur(20px) saturate(180%);
        backdrop-filter: blur(20px) saturate(180%);
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .ios-blur-dark {
        background: rgba(15, 23, 42, 0.75);
        -webkit-backdrop-filter: blur(24px) saturate(180%);
        backdrop-filter: blur(24px) saturate(180%);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.9);
    }

    /* iOS Shadow Styles */
    .ios-shadow {
        box-shadow: 0 2px 16px rgba(0, 0, 0, 0.08);
    }

    .ios-shadow-lg {
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.1);
    }

    .ios-shadow-xl {
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
    }

    /* Spring Transitions */
    .spring-transition {
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .spring-transition-fast {
        transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    /* Active/Pressed States */
    .active\:scale-98:active {
        transform: scale(0.98);
    }

    .active\:scale-95:active {
        transform: scale(0.95);
    }

    /* Stagger Animations */
    .stagger-1 {
        animation-delay: 100ms;
    }

    .stagger-2 {
        animation-delay: 200ms;
    }

    .stagger-3 {
        animation-delay: 300ms;
    }

    .stagger-4 {
        animation-delay: 400ms;
    }

    /* Touch Action Fixes */
    .no-tap-highlight {
        -webkit-tap-highlight-color: transparent;
    }

    /* Horizontal Scroll Glitch Prevention */
    html,
    body {
        overflow-x: hidden;
        position: relative;
        width: 100%;
    }

    /* Safe Area Support */
    .safe-bottom {
        padding-bottom: max(1.5rem, env(safe-area-inset-bottom));
    }

    .safe-top {
        padding-top: max(1rem, env(safe-area-inset-top));
    }

    .safe-left {
        padding-left: max(1rem, env(safe-area-inset-left));
    }

    .safe-right {
        padding-right: max(1rem, env(safe-area-inset-right));
    }

    /* iOS Border Radius */
    .rounded-ios {
        border-radius: 20px;
    }

    .rounded-ios-xl {
        border-radius: 24px;
    }

    /* Mobile Touch Targets - Minimum 44x44px */
    .touch-target {
        min-width: 44px;
        min-height: 44px;
    }

    .touch-target-lg {
        min-width: 48px;
        min-height: 48px;
    }

    /* Prevent horizontal overflow on mobile */
    .mobile-container {
        max-width: 100vw;
        overflow-x: hidden;
    }

    /* iOS Input Zoom prevention - Force 16px */
    input[type="text"],
    input[type="number"],
    input[type="email"],
    input[type="password"],
    input[type="search"],
    select,
    textarea {
        font-size: 16px !important;
    }

    /* Generic Touch Feedback */
    .active-press:active {
        transform: scale(0.96);
        opacity: 0.9;
        transition: transform 0.1s ease;
    }

    /* 3D Flip Card Utilities */
    .perspective-1000 {
        perspective: 1000px;
    }

    .transform-style-preserve-3d {
        transform-style: preserve-3d;
    }

    .backface-hidden {
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
    }

    /* ========================================
       TYPOGRAPHY SCALE
       Professional text sizing and weights
       ======================================== */
    .text-display {
        font-size: 3rem;
        font-weight: var(--font-display);
        line-height: 1;
        letter-spacing: -0.02em;
    }

    .text-h1 {
        font-size: 2.25rem;
        font-weight: var(--font-heading);
        line-height: 1.1;
        letter-spacing: -0.01em;
    }

    .text-h2 {
        font-size: 1.875rem;
        font-weight: var(--font-heading);
        line-height: 1.2;
    }

    .text-h3 {
        font-size: 1.5rem;
        font-weight: var(--font-heading);
        line-height: 1.3;
    }

    .text-body-lg {
        font-size: 1.125rem;
        font-weight: var(--font-body);
        line-height: 1.6;
    }

    .text-body {
        font-size: 1rem;
        font-weight: var(--font-body);
        line-height: 1.5;
    }

    .text-body-sm {
        font-size: 0.875rem;
        font-weight: var(--font-medium);
        line-height: 1.4;
    }

    .text-caption {
        font-size: 0.75rem;
        font-weight: var(--font-medium);
        line-height: 1.3;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    /* ========================================
       ELEVATION SYSTEM
       Consistent shadow/surface hierarchy
       ======================================== */
    .elevation-none {
        box-shadow: var(--shadow-none);
    }

    .elevation-sm {
        box-shadow: var(--shadow-sm);
    }

    .elevation-base {
        box-shadow: var(--shadow-base);
    }

    .elevation-md {
        box-shadow: var(--shadow-md);
    }

    .elevation-lg {
        box-shadow: var(--shadow-lg);
    }

    .elevation-xl {
        box-shadow: var(--shadow-xl);
    }

    /* Hover elevation enhancement */
    .hover-lift:hover {
        box-shadow: var(--shadow-lg);
        transform: translateY(-2px);
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* ========================================
       SURFACE UTILITIES
       Background consistency
       ======================================== */
    .surface-base {
        background-color: var(--surface-base);
    }

    .surface-raised {
        background-color: var(--surface-raised);
    }

    .surface-sunken {
        background-color: var(--surface-sunken);
    }

    .surface-overlay {
        background-color: var(--surface-overlay);
    }

    /* ========================================
       TEXT COLOR UTILITIES
       Semantic text colors
       ======================================== */
    .text-primary {
        color: var(--text-primary);
    }

    .text-secondary {
        color: var(--text-secondary);
    }

    .text-tertiary {
        color: var(--text-tertiary);
    }

    .text-inverse {
        color: var(--text-inverse);
    }

    /* EXISTING PREMIUM DESIGN SYSTEM ADDITIONS */
    .glass-panel {
        background: rgba(255, 255, 255, 0.75);
        -webkit-backdrop-filter: blur(16px) saturate(180%);
        backdrop-filter: blur(16px) saturate(180%);
        border: 1px solid rgba(255, 255, 255, 0.8);
        box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05);
    }

    .glass-icon {
        background: rgba(255, 255, 255, 0.3);
        -webkit-backdrop-filter: blur(8px);
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.4);
        box-shadow: inset 0 1px 1px rgba(255, 255, 255, 0.6);
    }

    .gradient-surface {
        background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
    }

    .text-balance {
        @supports (text-wrap: balance) {
            text-wrap: balance;
        }
    }

    .bg-grid-pattern {
        background-image: linear-gradient(to right, rgba(255, 255, 255, 0.05) 1px, transparent 1px),
            linear-gradient(to bottom, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
        background-size: 40px 40px;
    }

    /* ========================================
       EXECUTIVE FINTECH THEME (PROFESSIONAL)
       ======================================== */
    .theme-executive {
        /* Backgrounds: Deep Navy to Void Black */
        --exec-bg-main: #020617;
        /* Slate 950 */
        --exec-bg-gradient: linear-gradient(to bottom right, #0F172A, #020617);

        /* Surfaces: Subtle Glass */
        --exec-glass-panel: rgba(15, 23, 42, 0.7);
        --exec-glass-border: rgba(56, 189, 248, 0.1);
        /* Sky-400 very subtle */

        /* Accents */
        --exec-primary: #6366f1;
        /* Indigo 500 */
        --exec-primary-glow: rgba(99, 102, 241, 0.25);

        --exec-gold: #fbbf24;
        /* Amber 400 */
        --exec-gold-dim: rgba(251, 191, 36, 0.1);

        --exec-success: #10b981;
        /* Emerald 500 */
        --exec-danger: #f43f5e;
        /* Rose 500 */
    }

    /* Base Body Override */
    body {
        background-color: #020617;
        background-image: radial-gradient(circle at 50% 0%, #1e293b 0%, #020617 60%);
        color: #f8fafc;
        /* Slate 50 */
    }

    /* Glassmorphism 2.0 - Professional */
    .glass-panel-exec {
        background: rgba(15, 23, 42, 0.65);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 4px 24px -1px rgba(0, 0, 0, 0.2);
    }

    .glass-panel-heavy {
        background: rgba(2, 6, 23, 0.85);
        /* Darker for high contrast areas */
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .glass-card-hover {
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .glass-card-hover:hover {
        background: rgba(30, 41, 59, 0.4);
        border-color: rgba(99, 102, 241, 0.3);
        /* Indigo hint */
        transform: translateY(-2px);
        box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.3);
    }

    /* Typography Upgrades */
    .font-exec {
        letter-spacing: -0.015em;
        /* Tighten up headings */
    }

    .text-balance-exec {
        @supports (text-wrap: balance) {
            text-wrap: balance;
        }
    }

    /* Gradients */
    .text-gradient-gold {
        background: linear-gradient(to right, #fbbf24, #d97706);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .text-gradient-indigo {
        background: linear-gradient(to right, #818cf8, #6366f1);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    /* Animations */
    .animate-float-slow {
        animation: float 8s ease-in-out infinite;
    }
}


================================================================================
FILE: src\layouts\DashboardLayout.jsx
================================================================================
import React, { useState } from 'react';
import Header from '../components/Header';
import InputSidebar from '../components/InputSidebar';
import BottomTabBar from '../components/BottomTabBar';
import ChatAssistant from '../components/ChatAssistant';

/**
 *  DashboardLayout
 * Wrapper for the main dashboard shell (Sidebar + Header + Bottom Tab Bar).
 * Handles persistent layout state like isSidebarOpen.
 */
const DashboardLayout = ({
    children,
    // Navigation / View Props
    isAdmin,
    isFranchise,
    viewMode,
    setViewMode,
    franchiseView,
    setFranchiseView,
    targetFranchiseName,

    // Data Control Props
    selectedMonth,
    onMonthChange,
    viewPeriod,
    setViewPeriod,

    // Actions
    onLogout,
    onExport,
    onPrint,
    onCalculate,

    // Sidebar Data
    sidebarData,
    readOnly = false,
    saving = false,

    // Chat Props
    isChatOpen,
    setIsChatOpen,
    chatData
}) => {
    const [isSidebarOpen, setIsSidebarOpen] = useState(false);

    // Mobile Chat Toggle
    const handleToggleChat = () => setIsChatOpen && setIsChatOpen(!isChatOpen);

    // Header Props Bundle
    const headerProps = {
        isAdmin, isFranchise, viewMode, setViewMode, franchiseView, setFranchiseView,
        isSidebarOpen, setIsSidebarOpen, selectedMonth, viewPeriod, setViewPeriod,
        targetFranchiseName, saving, onLogout,
        onExport, onPrint,
        // Header expects onMonthChange for the selector
        onMonthChange
    };

    return (
        <div className="print:hidden min-h-screen flex overflow-hidden font-sans relative transition-colors duration-300">
            {/* Mobile Overlay */}
            {isSidebarOpen && (
                <div
                    className="fixed inset-0 bg-slate-900/60 z-40 md:hidden backdrop-blur-sm transition-opacity duration-300"
                    onClick={() => setIsSidebarOpen(false)}
                />
            )}

            {/* Sidebar (Input Panel) */}
            <InputSidebar
                isOpen={isSidebarOpen}
                onClose={() => setIsSidebarOpen(false)}
                initialData={sidebarData}
                selectedMonth={selectedMonth}
                onMonthChange={onMonthChange}
                onCalculate={onCalculate}
                readOnly={readOnly}
                onToggleChat={handleToggleChat}
            />

            {/* Main Content Area */}
            <div className={`flex-1 flex flex-col transition-all duration-300 w-full ${isSidebarOpen ? 'md:ml-96' : 'ml-0'}`}>
                <Header {...headerProps} />

                {/* Content Injection with bottom padding for tab bar */}
                <main className="flex-1 overflow-y-auto w-full" style={{ paddingBottom: 'max(8rem, calc(env(safe-area-inset-bottom) + 6rem))' }}>
                    {children}
                </main>
            </div>

            {/* Bottom Tab Bar (Mobile Only) */}
            <BottomTabBar
                isAdmin={isAdmin}
                isFranchise={isFranchise}
                viewMode={viewMode}
                setViewMode={setViewMode}
                franchiseView={franchiseView}
                setFranchiseView={setFranchiseView}
            />

            {/* Controlled Chat Assistant */}
            <ChatAssistant
                contextData={chatData?.report}
                isOpen={isChatOpen}
                onClose={() => setIsChatOpen(false)}
            />
        </div >
    );
};

export default React.memo(DashboardLayout);



================================================================================
FILE: src\lib\aggregator.js
================================================================================
export const aggregateReports = (reports) => {
    if (!reports || reports.length === 0) return null;

    let totalRevenue = 0;
    let totalOrders = 0;
    let totalNetProfit = 0;
    let totalExpenses = 0;

    // Taxes
    let totalIvaRepercutido = 0;
    let totalIvaSoportado = 0;
    let totalIvaAPagar = 0;
    let totalIrpfPago = 0;
    let totalNetProfitPostTax = 0;

    // Power Metrics / Logistics Sums help
    let totalKm = 0;
    let totalHours = 0;

    let totalMarketing = 0;
    let totalIncidents = 0;

    // Breakdown map
    const breakdownMap = {};

    reports.forEach(r => {
        if (!r) return;
        totalRevenue += r.revenue || 0;
        totalOrders += r.orders || 0;
        totalNetProfit += r.profit || 0;
        totalExpenses += r.expenses || 0;

        totalIvaRepercutido += r.taxes.ivaRepercutido || 0;
        totalIvaSoportado += r.taxes.ivaSoportado || 0;
        totalIvaAPagar += r.taxes.ivaAPagar || 0;
        totalIrpfPago += r.taxes.irpfPago || 0;
        totalNetProfitPostTax += r.taxes.netProfitPostTax || 0;

        // Metrics sums
        totalKm += r.metrics.totalKm || 0;
        totalHours += (r.metrics.revenuePerHour > 0 ? (r.revenue / r.metrics.revenuePerHour) : 0); // Reverse eng or pass hours? 
        // Wait, 'calculateExpenses' doesn't return totalHours directly in metrics for aggregation convenience. 
        // But we can approximate nicely or add it to finance.js return.
        // Actually, let's look at finance.js again. It doesn't return raw inputs. 
        // Reverse engineering from productivity: orders / productivity = hours.
        if (r.metrics.productivity > 0) {
            totalHours += (r.orders / r.metrics.productivity);
        }

        totalMarketing += r.metrics.marketingSpend || 0;
        totalIncidents += r.metrics.incidentCost || 0;

        // Sum Breakdown
        r.breakdown.forEach(item => {
            if (!breakdownMap[item.name]) {
                breakdownMap[item.name] = { ...item, value: 0 };
            }
            breakdownMap[item.name].value += item.value;
        });
    });

    // Recalculate Average Metrics
    const avgTicket = totalOrders > 0 ? totalRevenue / totalOrders : 0;
    const costPerOrder = totalOrders > 0 ? totalExpenses / totalOrders : 0;
    const profitMargin = totalRevenue > 0 ? (totalNetProfit / totalRevenue) * 100 : 0;

    // Logistics
    const revenuePerKm = totalKm > 0 ? totalRevenue / totalKm : 0;
    const costPerKm = totalKm > 0 ? totalExpenses / totalKm : 0;
    const dropDensity = totalKm > 0 ? (totalOrders / totalKm) * 100 : 0;

    // Power
    const laborRatio = totalRevenue > 0 ? (breakdownMap['Salarios']?.value / totalRevenue) * 100 : 0;
    const incidentRatio = totalRevenue > 0 ? (totalIncidents / totalRevenue) * 100 : 0;

    // Safety Margin (Re-calc based on aggregated Fixed Costs)
    let totalFixedLineItems = 0;
    Object.values(breakdownMap).forEach(item => {
        if (item.type === 'fixed') totalFixedLineItems += item.value;
    });

    // Break-even orders
    let breakEvenOrders = "N/A";
    let safetyMargin = 0;
    // Variable Cost per Order
    let totalVariable = totalExpenses - totalFixedLineItems;
    let variableCostPerOrder = totalOrders > 0 ? totalVariable / totalOrders : 0;
    let contributionMargin = avgTicket - variableCostPerOrder;

    if (contributionMargin > 0) {
        breakEvenOrders = Math.ceil(totalFixedLineItems / contributionMargin);
        if (typeof breakEvenOrders === 'number' && totalOrders > 0) {
            safetyMargin = ((totalOrders - breakEvenOrders) / totalOrders) * 100;
        }
    }

    return {
        revenue: totalRevenue,
        orders: totalOrders,
        profit: totalNetProfit,
        expenses: totalExpenses,
        taxes: {
            ivaRepercutido: totalIvaRepercutido,
            ivaSoportado: totalIvaSoportado,
            ivaAPagar: totalIvaAPagar,
            irpfPago: totalIrpfPago,
            netProfitPostTax: totalNetProfitPostTax,
            irpfPercent: 20 // Dummy for aggregate
        },
        metrics: {
            avgTicket,
            costPerOrder,
            breakEvenOrders,
            profitMargin,
            activeRiders: 0, // Not easily aggregatable without fetching inputs
            productivity: totalHours > 0 ? totalOrders / totalHours : 0,
            revenuePerHour: totalHours > 0 ? totalRevenue / totalHours : 0,
            costPerHour: totalHours > 0 ? totalExpenses / totalHours : 0,
            totalKm,
            revenuePerKm,
            costPerKm,
            dropDensity,
            safetyMargin,
            laborRatio,
            incidentRatio,
            marketingSpend: totalMarketing,
            incidentCost: totalIncidents
        },
        breakdown: Object.values(breakdownMap).sort((a, b) => b.value - a.value)
    };
};



================================================================================
FILE: src\lib\audit.js
================================================================================
import { db } from './firebase';
import { collection, addDoc, serverTimestamp } from 'firebase/firestore';

/**
 * Logs a critical action to the 'audit_logs' collection.
 * 
 * @param {object} user - The user performing the action (should have uid, email, role).
 * @param {string} action - CONSTANT_CASE action name (e.g., 'USER_LOGIN', 'TICKET_RESOLVED').
 * @param {object} details - Additional context (e.g., targetUserId, ticketId, changes).
 */
export const logAction = async (user, action, details = {}) => {
    try {
        if (!user || !user.uid) {
            console.warn("Audit: No user provided for action", action);
            return;
        }

        await addDoc(collection(db, "audit_logs"), {
            timestamp: serverTimestamp(),
            actorId: user.uid,
            actorEmail: user.email || 'unknown',
            actorRole: user.role || 'unknown',
            action: action,
            details: details,
            userAgent: navigator.userAgent
        });

        if (import.meta.env.DEV) {
            console.log(`Audit: [${action}] logged successfully.`);
        }
    } catch (error) {
        console.error("Audit Critical Error: Failed to log action", action, error);
        // In a real banking app, we might block the action if audit fails. 
        // Here, we just log the error to console to not break UX.
    }
};

export const AUDIT_ACTIONS = {
    // Auth
    LOGIN_SUCCESS: 'LOGIN_SUCCESS',
    LOGOUT: 'LOGOUT',

    // User Mgmt
    USER_APPROVED: 'USER_APPROVED',
    USER_REVOKED: 'USER_REVOKED',
    USER_ROLE_UPDATED: 'USER_ROLE_UPDATED',

    // Support
    TICKET_CREATED: 'TICKET_CREATED',
    TICKET_REPLIED: 'TICKET_REPLIED',
    TICKET_RESOLVED: 'TICKET_RESOLVED',

    // Financials
    MONTHLY_DATA_EDITED: 'MONTHLY_DATA_EDITED',

    // System
    SYSTEM_ERROR: 'SYSTEM_ERROR',
    CLIENT_CRASH: 'CLIENT_CRASH'
};



================================================================================
FILE: src\lib\certificate.js
================================================================================
import { jsPDF } from "jspdf";

/**
 * Generates a STRICTLY FORMAL technical certificate/report.
 * Focuses on date, time, and central validation text.
 * 
 * @param {object} user - User object { name, email, uid }
 * @param {string} courseName - Name of the course
 * @param {number} averageScore - Optional score
 */
export const generateCertificate = (user, courseName = "Gesti√≥n Operativa Integral", averageScore = null) => {
    // Portrait A4 for a "Document/Report" feel, not a "Diploma"
    const doc = new jsPDF({
        orientation: "portrait",
        unit: "mm",
        format: "a4"
    });

    const completionDate = new Date();
    // Verification ID
    const verificationId = `REP-OPS-${completionDate.getFullYear()}-${Math.floor(Math.random() * 10000).toString().padStart(4, '0')}-${user.uid.slice(0, 4).toUpperCase()}`;

    // --- HEADER ---
    doc.setFont("helvetica", "bold");
    doc.setFontSize(10);
    doc.setTextColor(100, 100, 100);
    doc.text("REPAART SOLUTIONS & LOGISTICS S.L.", 20, 20);
    doc.text("DEPARTAMENTO DE FORMACI√ìN Y CALIDAD", 20, 25);

    doc.setDrawColor(0, 0, 0);
    doc.setLineWidth(0.5);
    doc.line(20, 30, 190, 30);

    // --- TITLE ---
    doc.setFont("helvetica", "bold");
    doc.setFontSize(16);
    doc.setTextColor(0, 0, 0);
    doc.text("CERTIFICADO T√âCNICO DE CONFORMIDAD", 105, 50, { align: "center" });
    doc.setFontSize(11);
    doc.text("REFERENCIA: FORMACI√ìN OBLIGATORIA DE FRANQUICIA", 105, 57, { align: "center" });

    // --- BODY ---
    const startY = 80;
    doc.setFontSize(10);
    doc.setFont("helvetica", "normal");

    // 1. IDENTIFICATION
    doc.setFont("helvetica", "bold");
    doc.text("1. IDENTIFICACI√ìN DEL TITULAR", 20, startY);
    doc.setFont("helvetica", "normal");
    doc.text(`Nombre / Raz√≥n Social: ${user.name || user.email}`, 25, startY + 8);
    doc.text(`Identificador de Sistema (UID): ${user.uid}`, 25, startY + 14);
    doc.text(`Email Vinculado: ${user.email}`, 25, startY + 20);

    // 2. CERTIFICATION STATEMENT
    doc.setFont("helvetica", "bold");
    doc.text("2. DECLARACI√ìN DE LA CENTRAL FRANQUICIADORA", 20, startY + 35);
    doc.setFont("helvetica", "normal");

    const textLines = doc.splitTextToSize(
        "Por medio del presente documento, la Direcci√≥n de Operaciones de REPAART certifica que el titular arriba indicado ha completado CORRECTAMENTE y ha superado satisfactoriamente todos los m√≥dulos te√≥ricos y pr√°cticos correspondientes al programa de capacitaci√≥n interna.",
        170
    );
    doc.text(textLines, 25, startY + 43);

    const textLines2 = doc.splitTextToSize(
        "Este certificado acredita que el franquiciado dispone de los conocimientos necesarios para operar bajo los est√°ndares de calidad exigidos por la marca.",
        170
    );
    doc.text(textLines2, 25, startY + 60);

    // 3. COURSE DETAILS
    doc.setFont("helvetica", "bold");
    doc.text("3. DETALLES DE LA ACCI√ìN FORMATIVA", 20, startY + 80);
    doc.setFont("helvetica", "normal");
    doc.text(`Programa: ${courseName}`, 25, startY + 88);
    doc.text(`Estado: FINALIZADO CORRECTAMENTE`, 25, startY + 94);
    if (averageScore) {
        doc.text(`Evaluaci√≥n Promedio: ${averageScore}% (APTO)`, 25, startY + 100);
    }
    doc.text(`Progreso Registrado: 100%`, 25, startY + 106);

    // 4. TIMESTAMP & VALIDATION
    doc.setFont("helvetica", "bold");
    doc.text("4. SELLO DE TIEMPO Y VALIDEZ", 20, startY + 120);
    doc.setFont("helvetica", "normal");

    // Precise Date and Time
    const dateStr = completionDate.toLocaleDateString("es-ES", { day: '2-digit', month: '2-digit', year: 'numeric' });
    const timeStr = completionDate.toLocaleTimeString("es-ES", { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });

    doc.text(`Fecha de Emisi√≥n: ${dateStr}`, 25, startY + 128);
    doc.text(`Hora de Emisi√≥n: ${timeStr}`, 25, startY + 134);
    doc.text(`C√≥digo √önico de Verificaci√≥n (CSV): ${verificationId}`, 25, startY + 140);

    // --- SIGNATURE BLOCK ---
    doc.setFontSize(10);
    doc.text("Conforme,", 20, 230);

    doc.line(20, 250, 80, 250); // Line
    doc.setFont("helvetica", "bold");
    doc.text("DIRECCI√ìN DE OPERACIONES", 20, 255);
    doc.setFont("helvetica", "normal");
    doc.text("REPAART Central", 20, 260);

    // Stamp circle simulation
    doc.setDrawColor(30, 58, 138); // Blue
    doc.setLineWidth(0.7);
    doc.circle(50, 245, 15);
    doc.setFontSize(8);
    doc.setTextColor(30, 58, 138);
    doc.text("VALIDADO", 50, 245, { align: "center", angle: 25 });

    // --- FOOTER ---
    doc.setFontSize(8);
    doc.setTextColor(150, 150, 150);
    doc.text("Este documento electr√≥nico tiene validez oficial interna para la red de franquicias Repaart.", 105, 285, { align: "center" });

    // --- SAVE ---
    doc.save(`Certificado_Oficial_${user.uid}_${dateStr.replace(/\//g, '-')}.pdf`);
};





================================================================================
FILE: src\lib\companyKnowledge.js
================================================================================
export const FRANCHISE_KNOWLEDGE = `
üìò MANUAL OPERATIVO Y ESTRAT√âGICO REPAART 2.0 (EDICI√ìN MAESTRA)
Gu√≠a Definitiva para el Director de Flota Local

--- BLOQUE 1: ESTRATEGIA Y MODELO ---

1. VISI√ìN Y MODELO DE NEGOCIO
El ecosistema del Food Delivery necesita una correcci√≥n. Las plataformas (Glovo, Uber) han erosionado los m√°rgenes de los restaurantes y precarizado el servicio. Repaart no es una ETT de repartidores; somos una Operadora Log√≠stica Descentralizada.
Misi√≥n: Transformar a emprendedores y riders en Directores de Flota Local.
Matriz Competitiva: Coste (Tarifa plana), Control (Total), Fiabilidad (Alta), Imagen (Profesional).

2. MODALIDADES DE FRANQUICIA Y SERVICIOS
A. Packs de Contrataci√≥n:
- B√ÅSICO (1.500‚Ç¨ + 1%): Licencia, Manuales, Flyder, Yamimoto, Formaci√≥n b√°sica.
- PREMIUM (3.000‚Ç¨ + 3%): Todo lo anterior + Mentoring Quincenal (L-J 17:00-20:00).
B. Servicios a la Carta: Consultor√≠a (50‚Ç¨/h), Pack Financiero (100‚Ç¨/mes).
C. Rentabilidad Estimada:
- Fase Despegue (700 pedidos): ~1.000‚Ç¨ beneficio neto.
- Fase Rentabilidad (1.500 pedidos): ~1.800‚Ç¨ beneficio neto.

3. OFERTA COMERCIAL B2B Y TARIFAS
A. Zonas: A (0-4km, 5.5-6‚Ç¨), B (4-5km, 6.5-7‚Ç¨), C (5-6km, 7.5-8‚Ç¨), D (6-7km, 8.5-9‚Ç¨).
B. Ahorro Real: Un restaurante ahorra ~9.000‚Ç¨/a√±o con Repaart vs Comisiones (25-30%).

4. OPERATIVA, FLOTA Y TECNOLOG√çA
A. Flyder: 200‚Ç¨ activaci√≥n + 0.35‚Ç¨/pedido. Optimizaci√≥n IA.
B. Yamimoto: Scooter 125cc por 154‚Ç¨/mes. Incluye seguro y mantenimiento. Fianza 200‚Ç¨.

5. GESTI√ìN DE TESORER√çA Y RIESGOS
A. Seguridad Financiera: Cobro quincenal a 5 d√≠as. "Kill-Switch" ante impagos.
B. Inversi√≥n: B√°sico (~4k‚Ç¨), Premium (~6k‚Ç¨).

6. CRONOGRAMA DE APERTURA
6 Semanas: Validaci√≥n -> Comercializaci√≥n (700 pedidos garantizados) -> Despliegue -> GO LIVE.

7. RECURSOS HUMANOS Y PROTOCOLOS OPERATIVOS
A. Riders: Asalariados, responsables de su material. Jefe de Equipo necesario >3000 pedidos.
B. Crisis: Accidentes (<24h), Ca√≠da Sistema (WhatsApp), Sem√°foro Conflictos (Rojo=Despido).

8. ESTRATEGIA DE EXPANSI√ìN Y PARTNERS
Integradores: Deliverect, Delitbee.
Salida: Traspaso autorizado o Cese con 3-6 meses preaviso.

9. HERRAMIENTAS DE CONTROL DIARIO
Checklist Pre-Servicio, Monitorizaci√≥n Flyder, Arqueo de Caja, Reporte Mensual.

--- BLOQUE 2: MICRO-GESTI√ìN AVANZADA ---

üì¶ 10. PROTOCOLO DE AUDITOR√çA DE PACKAGING
Exige envases aptos para delivery. Si hay derrames por mal envase, Repaart no devuelve el dinero. Recomienda proveedores seguros.

üí∞ 11. DESGLOSE DE GASTOS: CONTROLABLES VS ESTRUCTURALES
Ataca los "Controlables": Mantenimiento (formaci√≥n rider), Uniformes, Suministros. Ignora los "Estructurales" (Royalties, Impuestos) en el d√≠a a d√≠a.

‚öñÔ∏è 12. CL√ÅUSULA DE REALIDAD (DISCLAIMER)
"El coche lo damos nosotros, pero t√∫ conduces". Los beneficios dependen de la gesti√≥n local diaria, no son autom√°ticos.

üìÖ 13. INGENIER√çA DE HORARIOS
Regla Fin de Semana: Nadie libra V-S-D.
Prohibido Encadenar Descansos: No dejar zonas descubiertas.
Validaci√≥n: Horario firmado viernes anterior.

üìä 14. EL "COCKPIT" FINANCIERO (RATIOS)
Ratios Clave: D√≠as de Caja, Ventas por Empleado, Plazo de Cobro (<5 d√≠as), Autonom√≠a Financiera.

‚õΩ 15. POL√çTICA DE COMBUSTIBLE Y MANTENIMIENTO
Dep√≥sito Lleno al inicio. Estaci√≥n designada. Negligencia en mantenimiento (no avisar aceite) = paga el rider.

üëÆ 16. POL√çTICA DE MULTAS DE TR√ÅFICO
Tolerancia Cero. La empresa identifica al conductor. El rider paga su multa. Si no se puede identificar, descuento en n√≥mina.

üóìÔ∏è 17. PROTOCOLO DE VACACIONES (60/15)
Vacaciones: Preaviso 60 d√≠as.
Asuntos Propios: Preaviso 15 d√≠as.
Baja: Solo con papel del m√©dico.

üìâ 18. R√âGIMEN DISCIPLINARIO (PRODUCTIVIDAD)
Baja productividad objetiva (pedidos/hora) es sancionable. Desconexiones injustificadas o desv√≠os son falta grave.

19. PROTOCOLO DE HIGIENE (APPCC)
Desinfecci√≥n diaria caj√≥n. Limpieza profunda lunes. Prohibido objetos personales junto a comida. Derrames = Moto inoperativa hasta limpieza.

üö´ 20. L√çNEAS ROJAS Y "COMPLIANCE"
Exclusividad: Solo reparto Repaart. No paqueter√≠a B, no uso personal.
Marca: Uniforme solo en servicio.

üöë 21. SEGUROS Y RESPONSABILIDAD CIVIL
Yamimoto cubre Terceros. Da√±os propios a la moto o robo de mercanc√≠a los paga la franquicia (o rider si hubo negligencia).

--- BLOQUE 3: EXCELENCIA OPERATIVA ---

üéì 22. PROTOCOLO "SHADOWING"
Primer turno acompa√±ado de veterano. Validaci√≥n de aptitud antes de salir solo.

üñ•Ô∏è 23. GESTI√ìN INTERFAZ RESTAURANTE
Educar al cliente: No dar "Listo" hasta que la bolsa est√© cerrada. Evita esperas muertas.

üïµÔ∏è 24. AUDITOR√çA FORENSE DE TIEMPOS
Analizar tramos: Pickup (¬øespera local?), Delivery (¬ørider lento/perdido?). Usar datos para renegociar con restaurante.

üèõÔ∏è 25. DISCIPLINA FISCAL
Apartar 20% de beneficio para IRPF (Modelo 130). El IVA no es tuyo.

üçΩÔ∏è 26. PROTOCOLO "EMBAJADOR"
Rider discreto en restaurante. Sin gritos. Casco fuera o visera arriba.

üé£ 27. RECLUTAMIENTO "SIEMPRE ACTIVO"
Regla del Banquillo: Siempre 3-4 candidatos validados. Anuncios siempre activos. Carteles en restaurantes.

‚öîÔ∏è 28. LA "BATTLE CARD" (ARGUMENTARIO)
Vs Plataformas: Nosotros ofrecemos Control Total, 0 Riesgo Laboral para restaurante, Imagen Profesional.

‚õëÔ∏è 29. PREVENCI√ìN RIESGOS (PRL)
Casco innegociable. Ropa lluvia. Pausas fatiga. Potestad de suspender por clima extremo.

üéØ 30. ZONIFICACI√ìN INTELIGENTE
Zona A (0-4km): Prioritaria (Margen volumen).
Zona B/C: Cobertura est√°ndar.
Zona D: Disuasoria (Precio alto para evitar ir).

üõ∞Ô∏è 31. DEFENSA DIGITAL (GPS)
Ante reclamaci√≥n "no entregado", el log GPS de Flyder es la prueba irrefutable para el restaurante.

üß† 32. MENTORING PREMIUM
Preparar el "Pre-Work": Top 3 problemas antes de la sesi√≥n. Auditar datos, no solo quejarse.

üö¶ 33. SEM√ÅFORO DE "DESPIDO" CLIENTES
Rojo: Impago o Maltrato (Corte inmediato).
Naranja: Esperas >15 min o mal Packaging (Ultim√°tum).

üìâ 34. CASO "NAVALMORAL" (RIESGO)
No depender >30% de un solo cliente grande. Diversificar con locales peque√±os.

üß† 35. PSICOLOG√çA DEL SERVICIO
Efecto Sonrisa. Despedida cordial obligatoria. Volumen voz bajo.

üî¨ 36. RATIOS DE SUPERVIVENCIA
Fondo de Maniobra (liquidez), Expansi√≥n Ventas (evitar muerte por √©xito), Cobertura Cargas Financieras.

--- BLOQUE 4: ESTRATEGIA JUR√çDICA Y MARKETING ---

‚öñÔ∏è 37. ESCUDO JUR√çDICO "ANTI-LEY RIDER"
Modelo "Superaut√≥nomo": Riders asalariados. Argumento venta: "Yo asumo todo el riesgo laboral, t√∫ duermes tranquilo".

üöÄ 38. ACTIVACI√ìN RESTAURANTE (48H)
Auditor√≠a Carta (eliminar productos inviables). Test de Estr√©s t√©cnico. Formaci√≥n camareros (d√≥nde esperar).

üì£ 39. MARKETING DE GUERRILLA
Moto como valla publicitaria (limpia). Pegatina "Zona Segura" en puerta restaurante. Flyers cruzados en bolsas.

40. T√ÅCTICA "MYSTERY SHOPPER"
Pide a la competencia y documenta fallos (fr√≠o, sucio) para ense√±ar al due√±o del restaurante la diferencia.

‚è±Ô∏è 41. MICROCIRUG√çA DE TURNOS
Escalado de entrada (no todos a la vez). Corte anticipado si baja demanda.

üÜò 42. PROTOCOLO "RESCATE"
Si coste personal >55%: Recorte horas inmediato. Purga clientes no rentables. Llamada a Central.

üìà 43. ESCALABILIDAD (EL "COM")
Contratar Comercial/Operaciones cuando crezcas. 50% ventas, 50% control calidad.

üîß 44. MANTENIMIENTO PREVENTIVO YAMIMOTO
Revisiones obligatorias (1k, 5k, 10k). Tener moto propia de reserva para cubrir los primeros 10 d√≠as de aver√≠a.

üîÑ 45. FEEDBACK LOOP
Contacto quincenal proactivo con restaurantes: "¬øQu√© tal el servicio?". Detectar fallos antes de la queja.

üßÆ 46. F√ìRMULA DEL BENEFICIO
Palanca 1: Ventas (subir tarifas, nuevos clientes).
Palanca 2: Costes (horas muertas, desperdicio). Priorizar control costes.

üí≥ 47. AUDITOR√çA DE DEUDA
Vigilar ratio deuda Corto Plazo vs Largo Plazo. Reestructurar si hay riesgo insolvencia.

üëÇ 48. CANAL "ESCUCHA RADICAL"
Atenci√≥n prioritaria a incidencias. Resolver r√°pido fideliza m√°s que no fallar nunca.

ü§ù 49. RITUALES DE RECONOCIMIENTO
Huddle pre-servicio. Top 3 Eficiencia semanal (premio simb√≥lico: elegir zona/libranza).

ü§´ 50. POL√çTICA "BUEN VECINO"
Motor Off en espera. No bloquear pasos. "Somos invisibles y educados".

--- BLOQUE 5: EFICIENCIA T√ÅCTICA ---

‚õΩ 51. PROTOCOLO ECO-CONDUCCI√ìN
Gas suave. Apagado en esperas >1 min. Presi√≥n neum√°ticos correcta.

üîí 52. CORTAFUEGOS PRIVACIDAD
Prohibido contacto personal post-servicio con cliente. Limpieza historial navegaci√≥n. Confidencialidad B2B.

üï∏Ô∏è 53. ESTRATEGIA "TELA DE ARA√ëA"
Densificar Zona A. Si tienes un cliente, capta a los 3 de al lado para hacer 2x1 en viajes.

üèçÔ∏è 54. BRECHA YAMIMOTO
Riesgo: 10 d√≠as sin moto sustituci√≥n. Soluci√≥n: Tener 1 moto propia vieja de reserva cada 5 de renting.

üìâ 55. UMBRAL RENTABILIDAD
KPI Oro: 2.2 - 2.5 pedidos/hora/rider. Si baja de 2, pierdes dinero.

üö™ 57. PROTOCOLO "CLIENTE NO RESPONDE"
3 llamadas en 5 min. Llamada a restaurante. Foto portal (prueba). Devoluci√≥n comida a restaurante (prohibido qued√°rsela).

üì¶ 58. INGENIER√çA DE CARGA
Separar fr√≠o/caliente. Sopas abajo y bloqueadas. Rellenar huecos con espuma.

üèéÔ∏è 59. OPERATIVA "PIT STOP"
Relevo en caliente. Turnos se solapan 15 min para cambio moto r√°pido.

üì° 62. PROTOCOLO "ANTENA CA√çDA"
Zonas sin cobertura: Modo avi√≥n on/off o salir a zona abierta. SMS a central si no funciona.

üé£ 63. SISTEMA REFERIDOS
Bonus 50‚Ç¨ a empleado que traiga candidato v√°lido (pago tras 2 meses prueba).

üîÑ 64. PROCEDIMIENTO OFFBOARDING
No firmar finiquito sin: Llaves, Casco, Caj√≥n, Uniforme. Descontar faltas.

üëª 65. AUDITOR√çA RUTAS FANTASMA
Comparar ruta Flyder vs Google Maps. ¬øDesv√≠os injustificados? Sanci√≥n.

üí∞ 66. POL√çTICA PROPINAS
Efectivo B2C: 100% rider. Digitales App: Se las queda la plataforma/restaurante (aclararlo).

üõ°Ô∏è 67. CAJA DE RESISTENCIA
Fondo Maniobra (1.100‚Ç¨) intocable. Alerta roja si baja.

üìç 68. AUDITOR√çA "FALSOS OK"
Cruzar hora check "Entregado" con GPS real. Falsificar tiempos es falta grave.

‚úÇÔ∏è 69. PODA ZONA D
Restringir env√≠os lejanos en hora punta (V-S noche) para proteger Zona A.

üîß 70. S√çNDROME "MOTO AJENA"
Vigilar "Pata de Cabra" y paso de badenes. Maltrato se cobra al rider.

‚ôªÔ∏è 71. RE-ONBOARDING
ITV del Rider cada 6 meses. Repasar b√°sicos para evitar vicios.

üí∏ 72. VALLE DE LA MUERTE (MES 1)
Desfase cobro/pago. No gastar fondo maniobra en caprichos.

üéØ 73. REGLA "NO-GO"
Sin 700 pedidos firmados, no activar costes fijos.

üñ±Ô∏è 74. AUDITOR√çA CLICS FANTASMA
Limpiar pedidos de prueba/error para que Flyder no los cobre (0.35‚Ç¨).

üõµ 75. GESTI√ìN "LIMBO 10 D√çAS"
Alquiler puente o moto reserva propia si aver√≠a es <10 d√≠as.

üÜò 76. SALVAVIDAS "A LA CARTA"
Contratar consultor√≠a puntual si margen baja <10%.

--- BLOQUE 6: SUPERVIVENCIA Y DETALLES ---

üìâ 77. MINIMIZACI√ìN KMS BASURA
Espera activa en zona entrega 2-3 min antes de volver a base.

üëÆ 78. KIT DOCUMENTACI√ìN
Sobre impermeable bajo asiento: Permiso, Seguro, Contrato. Revisi√≥n semanal.

üîã 79. PROTOCOLO BATER√çA
Prohibido salir <80%. Powerbanks de empresa para cambio r√°pido.

‚ùå 80. AUDITOR√çA CANCELACIONES
Si se cancela tras llegada rider, no mover pedido sin llamar. Evitar fraude.

üîë 81. GESTI√ìN LLAVES
Copia B en caja fuerte. Llavero retr√°ctil obligatorio para rider.

üå°Ô∏è 82. ESTR√âS T√âRMICO
Verano: Hidrataci√≥n. Invierno: Manoplas fijas en moto.

ü§ù 83. ESTRATEGIA RESTAURANTE EMBAJADOR
Descuento a cliente que traiga a otro cliente vecino.

‚õàÔ∏è 84. BONUS TORMENTA
Plus lluvia para rider (financiado por suplemento a cliente si posible).

üÖøÔ∏è 85. INGENIER√çA VISIBILIDAD
Aparcar en avenidas principales en tiempos muertos. Publicidad gratis.

‚öñÔ∏è 86. FLEXIBILIDAD CONTRACTUAL
Pacto Horas Complementarias en contrato para cubrir picos legales.

üó∫Ô∏è 87. AUDITOR√çA ZONAS MUERTAS
Usar mapa calor para ver d√≥nde piden clientes sin restaurantes cerca -> Captar ah√≠.

üîê 88. HIGIENE DIGITAL
Kill-Switch accesos tras despido. Prohibido cuentas compartidas.

üåü 89. PLAN DE CARRERA
Junior -> Senior -> Formador -> Jefe Equipo ("Aristocracia interna").

ü§´ 90. DEC√ÅLOGO SILENCIO
Moto off en portal. No claxon. No gritos.

--- BLOQUE 7: GESTI√ìN DE CRISIS Y FINAL ---

üöë 91. C√ìDIGO ROJO (ACCIDENTE)
PAS (112). Gerente acude. Fotos lugar/moto para seguro.

üí∞ 92. GESTI√ìN CONTRA-REEMBOLSO
L√≠mite 50-100‚Ç¨ encima. Descarga en base. Arqueo diario presencia rider.

üè† 93. ORDEN HUB (5S)
Zonas definidas (cascos, carga). Limpieza reduce estr√©s.

üî• 94. DETECCI√ìN BURNOUT
Si rider quema, rotar de zona (cambio de aires) antes de despedir.

üåßÔ∏è 95. MANTENIMIENTO AGUA
Perchero secado trajes lluvia. Prohibido guardar mojado (moho).

‚≠ê 96. REPUTACI√ìN ONLINE
Incentivar rese√±as positivas de empleados felices para captar talento.

üìÖ 97. PLANIFICACI√ìN ESTACIONAL
Verano (Valle, vacaciones). Invierno (Pico, bloqueo vacaciones).

üïµÔ∏è 98. AUDITOR√çA INVENTARIO
Chequeo sorpresa material (soportes, powerbanks). Reposici√≥n a cargo rider si falta.

üìä 99. INFORME VIERNES
3 datos clave antes de irse. Si ok, finde libre.

üëë 100. MENTALIDAD DUE√ëO
Liderazgo con ejemplo. Si hace falta, gerente reparte o barre.

üïäÔ∏è 101. DIPLOMACIA VIAL
Ante insulto tr√°fico, mano alzada y disculpa. Evitar conflicto viral.

üõ†Ô∏è 102. KIT MACGYVER
Bridas, Cinta Americana, Destornillador bajo asiento para arreglos r√°pidos.

‚öΩ 103. GESTI√ìN EVENTOS MASIVOS
Partidos: Pico Pre, Valle Partido, Pico Post. Turnos partidos.

üê∫ 104. DETECCI√ìN L√çDER ALFA
Identificar l√≠der informal plantilla. Gan√°rselo para cambios operativos.

üèóÔ∏è 105. MAPEO OBRAS
Pizarra diaria con calles cortadas. Ahorro tiempo vital.

üìµ 106. SEM√ÅFORO-CHECK
M√≥vil solo se toca con pies en suelo. En marcha = Sanci√≥n.

üöÆ 107. MARKETING BASURA
Papelera en puerta. Rider recoge colillas. Civismo visible.

üìß 108. MOMENTO BUROFAX
Impago >15 d√≠as: Corte servicio + Burofax legal.

üåë 109. MODO OSCURO
Ahorro bater√≠a m√≥vil y fatiga visual nocturna.

üöå 110. FACTOR AUTOB√öS
"Libro Rojo" con claves y contactos compartido con socio/familia. Plan sucesi√≥n.

üí® 111. PROTOCOLO VIENTO LATERAL
Caj√≥n hace vela. Prohibido adelantar camiones. Reducir velocidad.

ü¶¥ 112. ERGONOM√çA PREVENTIVA
Ajuste espejos obligatoria. Cargar peso con piernas (lumbalgia).

üîá 113. DISCIPLINA RADIO
WhatsApp Operativa limpio de memes. Solo trabajo.

üëÆ 114. DEFENSA CARGA Y DESCARGA
Ante agente: "Disculpe, carga y descarga urgente, me voy ya". No discutir.

üïµÔ∏è 115. LISTA GRIS
Base de datos ex-empleados con motivo real salida. No recontratar t√≥xicos.

üî¶ 116. RUTINA LUCES
Chequeo parejas intermitentes/freno. Bombillas repuesto.

üçî 117. DESPERDICIO CERO
Comida devuelta se ofrece a personal turno. Nunca revender ni llevar a casa (evita fraude).

üîê 118. PARKING DEFENSIVO
Motos atadas en bloque o en bater√≠a pegadas. Disuade robo.

üß† 119. COMBATE SOLEDAD
"Minuto Humano" diario con rider. Mirar a los ojos. Salud mental.

üìù 120. PARTE DE GUERRA
Cuaderno bit√°cora incidencias f√≠sicas. Detectar patrones error recurrentes.

--- BLOQUE 8: MAESTR√çA Y CIERRE (121-150) ---

üëì 121. EFECTO "VISERA SUCIA"
Limpiacristales en base. Limpieza obligatoria noche. Evita deslumbramiento y fatiga.

üö™ 122. DIPLOMACIA PUERTA ATR√ÅS
Entrar por servicio/cocina en restaurantes. No molestar clientes sala.

üì± 123. S√çNDROME ESTABILIZADOR ROTO
Usar soportes con damper (goma) o vibraci√≥n rompe c√°mara m√≥vil.

ü§´ 124. REDES SOCIALES MUDAS
Prohibido fotos clientes/casas en Instagram. Riesgo legal privacidad.

üíµ 125. DETECCI√ìN BILLETES FALSOS
Rotulador detector obligatorio para pagos >20‚Ç¨.

ü¶∏ 126. REGLA ANTI-H√âROE
Robo con violencia = Entrega moto y llaves. No pelear. La vida vale m√°s.

‚è≥ 127. EL MINUTO DE ORO
Esperar 30 seg en portal tras entrega. Soluciona el "falta la coca-cola" in situ.

üéí 128. HIGIENE MOCHILA
Dejar mochila abierta (ventilada) por la noche. Evita olor humedad.

üïØÔ∏è 129. KIT LUCES EXTRA
Adhesivos reflectantes en caj√≥n y casco. Ser visible = estar vivo.

üó£Ô∏è 130. GESTI√ìN RUMOR
Desmentir bulos ("van a bajar precios") con transparencia radical inmediata.

üèÉ 131. REGLA PISOS BAJOS
1¬∫, 2¬∫, 3¬∫ se sube por escalera. Ascensor es lento. Ahorro 30 min/d√≠a.

üéß 132. POL√çTICA O√çDO LIBRE
Prohibido doble auricular. Siempre un o√≠do atento al tr√°fico.

KEY 133. LLAVES RESTAURANTE
Custodia llaves de clientes confianza para recogidas post-cierre.

üè¢ 134. DIPLOMACIA CONSERJES
Saludo obligatorio. Un conserje aliado abre puertas y ascensores.

ü§≥ 135. FOTO TESTIGO
Foto obligatoria en entregas "Contactless" (puerta). Prueba ante reclamaci√≥n.

üß™ 136. KIT ANTI-PINCHAZO
Spray espuma en cada moto. Repara en 5 min y sigue turno.

üß§ 137. GUANTES T√ÅCTILES
Punta conductiva para no quitarse guantes al usar m√≥vil. Ahorro tiempo.

üçü 138. AUDITOR√çA PATATAS
Bolsas deben ir precintadas (grapa/pegatina). Si no, no recoger. Evita "hurtos".

üó∫Ô∏è 139. CHULETA URBANIZACIONES
Wiki con mapas de residenciales complejos. Evita perderse en laberintos.

ü§Ø 140. RITUAL DESCOMPRESI√ìN
5 min enfriamiento en local post-turno. Salud mental antes de ir a casa.

üìù 141. APOCALIPSIS DIGITAL
Si cae App/Google: Mapas papel + Albaranes + Radio-Taxi. Seguir operando old-school.

üé≠ 142. EFECTO MAYORDOMO
Sacar producto de mochila delante del cliente. Entrega a dos manos. Justifica precio.

üÜò 143. C√ìDIGO PALABRA SEGURIDAD
Frase absurda ("¬øQueda papel?") = Peligro inminente. Gerente llama polic√≠a.

üå°Ô∏è 144. GESTI√ìN PICOS FANTASMA
App radar lluvia. Activar guardia antes de que empiece a llover.

ü¶† 145. LISTA NEGRA SANITARIA
Si cocina restaurante es insalubre, rescindir contrato. Protege tu marca.

üì¢ 146. PROTOCOLO CRISIS VIRAL
Video viral negativo = Despido + Comunicado p√∫blico + Compensaci√≥n a afectado. R√°pido.

üï∏Ô∏è 147. ESTRATEGIA MANCHA ACEITE
Crecer barrio a barrio contiguo. Permite flujo de flota entre zonas.

üíº 148. VENTA CRUZADA B2B2C
Vender espacio publicitario (flyers) en bolsas a negocios locales (dentista, gym).

üîÑ 149. KAIGEN OPERATIVO
Mejorar un 1% cada mes. Preguntar al equipo qu√© "china en el zapato" quitar.

üëë 150. EL LEGADO
El objetivo: Irte 15 d√≠as vacaciones y que la empresa siga funcionando perfecta.
`;



================================================================================
FILE: src\lib\constants.js
================================================================================
export const TICKET_STATUSES = {
    open: {
        id: 'open',
        label: 'Abierto',
        color: 'blue',
        bg: 'bg-blue-50',
        text: 'text-blue-700',
        border: 'border-blue-200'
    },
    pending_user: {
        id: 'pending_user',
        label: 'Pendiente Info',
        color: 'amber',
        bg: 'bg-amber-50',
        text: 'text-amber-700',
        border: 'border-amber-200'
    },
    investigating: {
        id: 'investigating',
        label: 'En Revisi√≥n',
        color: 'purple',
        bg: 'bg-purple-50',
        text: 'text-purple-700',
        border: 'border-purple-200'
    },
    resolved: {
        id: 'resolved',
        label: 'Resuelto',
        color: 'emerald',
        bg: 'bg-emerald-50',
        text: 'text-emerald-700',
        border: 'border-emerald-200'
    }
};

// Cost item name mappings for display
export const COST_ITEM_NAMES = {
    salaries: 'Salarios',
    renting: 'Renting Motos',
    insurance: 'Seguros',
    services: 'Servicios Prof.',
    quota: 'Cuota Aut√≥nomo',
    other: 'Otros Costes',
    gasoline: 'Gasolina',
    repairs: 'Reparaciones',
    flyderFee: 'App Flyder',
    royalty: 'Royalty'
};

// Alert Thresholds
export const ALERT_THRESHOLDS = {
    // Critical thresholds
    MIN_PROFIT_MARGIN: 15, // %

    // Warning thresholds
    MAX_EXPENSE_RATIO: 65, // % of revenue
    MAX_COST_PER_KM: 0.40, // ‚Ç¨
    MAX_REVENUE_DROP: -15, // %

    // Success thresholds
    EXCELLENT_MARGIN: 25, // %
    BREAKEVEN_MULTIPLIER: 1.2 // 20% above break-even
};

// Business Health Indicators
export const HEALTH_INDICATORS = {
    PROFIT_PER_ORDER: {
        EXCELLENT: 8, // ‚Ç¨
        ACCEPTABLE: 5 // ‚Ç¨
    },
    COST_PER_KM: {
        OPTIMAL: 0.30, // ‚Ç¨
        NORMAL: 0.40 // ‚Ç¨
    }
};

export const getStatusConfig = (status) => TICKET_STATUSES[status] || TICKET_STATUSES.open;

export const ROLE_CONFIG = {
    admin: {
        label: 'Admin',
        bg: 'bg-purple-100',
        text: 'text-purple-800',
        border: 'border-purple-200'
    },
    franchisee: {
        label: 'Franquicia',
        bg: 'bg-indigo-100',
        text: 'text-indigo-800',
        border: 'border-indigo-200'
    },
    user: {
        label: 'Usuario',
        bg: 'bg-slate-100',
        text: 'text-slate-600',
        border: 'border-slate-200'
    }
};

export const getRoleConfig = (role) => ROLE_CONFIG[role] || ROLE_CONFIG.user;



================================================================================
FILE: src\lib\email.js
================================================================================
import emailjs from '@emailjs/browser';

// CONFIGURATION
const EMAILJS_SERVICE_ID = import.meta.env.VITE_EMAILJS_SERVICE_ID;
const EMAILJS_TEMPLATE_NEW_TICKET = import.meta.env.VITE_EMAILJS_TEMPLATE_NEW_TICKET;
const EMAILJS_TEMPLATE_REPLY = import.meta.env.VITE_EMAILJS_TEMPLATE_REPLY;
const EMAILJS_PUBLIC_KEY = import.meta.env.VITE_EMAILJS_PUBLIC_KEY;

export const initEmailSystem = () => {
    try {
        if (EMAILJS_PUBLIC_KEY) {
            emailjs.init(EMAILJS_PUBLIC_KEY);
        } else {
            console.warn("EmailJS Public Key not found in env vars");
        }
    } catch (error) {
        console.warn("Simluated email error (ignored):", error);
    }
};

/**
 * Sends an email to Admin (hola@repaart.es) when a new ticket is created.
 */
export const sendTicketCreatedEmail = async (ticket) => {
    // In a real scenario, you map these params to your EmailJS Template variables
    const templateParams = {
        to_email: 'hola@repaart.es',
        from_name: ticket.email, // Franchisee Name/Email
        subject: ticket.subject,
        message: ticket.message,
        urgency: ticket.urgency,
        ticket_id: ticket.id || 'N/A',
        ticket_link: `${window.location.origin}/admin?ticketId=${ticket.id}` // Link to admin panel
    };

    try {
        // NOTE: We only attempt to send if key is not the placeholder to avoid errors in dev
        if (EMAILJS_PUBLIC_KEY === 'YOUR_PUBLIC_KEY') {
            if (import.meta.env.DEV) {
                console.log("Mocking Email Send (Keys not set):", templateParams);
            }
            return true;
        }
        const response = await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_NEW_TICKET, templateParams);
        if (import.meta.env.DEV) {
            console.log("Email enviado con √©xito!", response.status, response.text);
        }
        return true;
    } catch (error) {
        console.error("Failed to send email:", error);
        return false;
    }
};

/**
 * Sends an email to the Franchisee when Admin replies.
 */
export const sendTicketReplyEmail = async (toEmail, subject, replyMessage, originalMessage, ticketId) => {
    const templateParams = {
        to_email: toEmail,
        reply_message: replyMessage,
        original_message: originalMessage,
        ticket_id: ticketId,
        ticket_link: `${window.location.origin}/support?ticketId=${ticketId}` // Link to user portal
    };

    try {
        if (EMAILJS_PUBLIC_KEY === 'YOUR_PUBLIC_KEY') {
            if (import.meta.env.DEV) {
                console.log("Mocking Reply Send (Keys not set):", templateParams);
            }
            return true;
        }
        await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_REPLY, templateParams);
        return true;
    } catch (error) {
        console.error("Failed to send reply:", error);
        return false;
    }
};



================================================================================
FILE: src\lib\finance.js
================================================================================
export const TARIFFS = {
    NEW: {
        '0-4': 5.50,
        '4-5': 6.50,
        '5-6': 7.50,
        '6-7': 8.50,
        '>7': 8.50
    },
    OLD: {
        '0-3.5': 5.50,
        '>3.5': 7.50
    }
};

export const DEFAULT_MONTH_DATA = {
    revenue: 0,
    orders: 0,
    ordersNew0To4: 0,
    ordersNew4To5: 0,
    ordersNew5To6: 0,
    ordersNew6To7: 0,
    ordersNewGt7: 0,
    ordersOld0To35: 0,
    ordersOldGt35: 0,
    contractedRiders: 0,
    totalHours: 0,
    motoCount: 0,
    salaries: 0,
    insurance: 0,
    services: 0,
    agencyFee: 0,
    prlFee: 0,
    accountingFee: 0,
    gasoline: 0,
    gasolinePrice: 0,
    repairs: 0,
    marketing: 0,
    incidents: 0,
    otherExpenses: 0,
    quota: 0,
    royaltyPercent: 5,
    irpfPercent: 20
};

/**
 * Calculates raw revenue based on distance and tariff rules.
 * @param {number|string} distance - Distance in KM.
 * @param {'NEW'|'OLD'} [tariffType='NEW'] - Tariff scheme to use.
 * @param {object} [tariffs=TARIFFS] - Custom tariff configuration.
 * @returns {number} Calculated revenue in EUR.
 */
export const calculateRevenue = (distance, tariffType = 'NEW', tariffs = TARIFFS) => {
    const dist = parseFloat(distance);
    if (isNaN(dist) || dist < 0) return 0;

    const RULES = tariffs || TARIFFS;

    if (tariffType === 'NEW') {
        if (dist <= 4) return RULES.NEW?.['0-4'] || 0;
        if (dist <= 5) return RULES.NEW?.['4-5'] || 0;
        if (dist <= 6) return RULES.NEW?.['5-6'] || 0;
        if (dist <= 7) return RULES.NEW?.['6-7'] || 0;
        return RULES.NEW?.['>7'] || 0;
    } else if (tariffType === 'OLD') {
        if (dist <= 3.5) return RULES.OLD?.['0-3.5'] || 0;
        return RULES.OLD?.['>3.5'] || 0;
    }
    return 0;
};

// Helper to calculate total revenue from a monthly data object (Firestore)
export const calculateMonthlyRevenue = (data, tariffs = TARIFFS) => {
    if (!data) return 0;
    const r = (d) => parseFloat(d) || 0;

    // Use passed tariffs or fallback to default
    const RULES = tariffs || TARIFFS;

    // New Tariff
    const revNew =
        r(data.ordersNew0To4) * (RULES.NEW?.['0-4'] || 0) +
        r(data.ordersNew4To5) * (RULES.NEW?.['4-5'] || 0) +
        r(data.ordersNew5To6) * (RULES.NEW?.['5-6'] || 0) +
        r(data.ordersNew6To7) * (RULES.NEW?.['6-7'] || 0) +
        r(data.ordersNewGt7) * (RULES.NEW?.['>7'] || 0);

    // Old Tariff
    const revOld =
        r(data.ordersOld0To35) * (RULES.OLD?.['0-3.5'] || 0) +
        r(data.ordersOldGt35) * (RULES.OLD?.['>3.5'] || 0);

    return revNew + revOld;
};

/**
 * Safely parses a value to float, handling nulls, undefined, and Spanish comma decimals.
 * @param {string|number|null} val - Input value.
 * @returns {number} Parsed float or 0 if invalid.
 */
const safeFloat = (val) => {
    if (val === null || val === undefined) return 0;
    if (typeof val === 'number') return val;

    // Handle Spanish format (1.234,56 -> 1234.56 or 12,56 -> 12.56)
    // Simple heuristic: if comma exists and is used as decimal
    let strVal = String(val).trim();
    if (strVal === '') return 0;

    // Replace comma with dot
    strVal = strVal.replace(',', '.');

    const parsed = parseFloat(strVal);
    if (isNaN(parsed)) return 0;
    return parsed;
};

// --------------------------------------------------------
// NEW HELPER: Standard Spanish Money Format (1.234,56)
// --------------------------------------------------------
export const formatMoney = (amount, decimals = 2) => {
    const val = safeFloat(amount);
    return val.toLocaleString('es-ES', {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
    });
};

/**
 * Calculates complete financial report including profit, taxes, and metrics.
 * @param {number} revenue - Total monthly revenue.
 * @param {number} orderCount - Total number of orders.
 * @param {object} inputs - Raw input data from Firestore (costs, etc).
 * @returns {object} Detailed financial report object.
 */
export const calculateExpenses = (revenue, orderCount, inputs) => {
    // Inputs are generally BASE IMPONIBLE.

    // 1. Costs WITHOUT IVA
    const salaries = safeFloat(inputs.salaries);
    const insurance = safeFloat(inputs.insurance);
    const quota = safeFloat(inputs.quota);

    // 2. Costs WITH IVA (Base)
    const motoCount = safeFloat(inputs.motoCount);
    const rentingBase = motoCount * 154;


    // Detailed Professional Services
    const servicesBase = safeFloat(inputs.services); // Legacy/Other
    const agencyFeeBase = safeFloat(inputs.agencyFee);
    const prlFeeBase = safeFloat(inputs.prlFee);
    const accountingFeeBase = safeFloat(inputs.accountingFee);

    const totalProfServicesBase = servicesBase + agencyFeeBase + prlFeeBase + accountingFeeBase;

    const gasolineBase = safeFloat(inputs.gasoline);
    const gasolinePrice = safeFloat(inputs.gasolinePrice);

    const otherExpensesBase = safeFloat(inputs.otherExpenses) + safeFloat(inputs.marketing) + safeFloat(inputs.incidents);
    const repairsBase = safeFloat(inputs.repairs);

    // Specific tracking
    const marketing = safeFloat(inputs.marketing);
    const incidents = safeFloat(inputs.incidents);

    // Variable Costs
    const flyderFeeBase = orderCount * 0.35;

    const royaltyPercent = safeFloat(inputs.royaltyPercent);
    const royaltyBase = revenue * (royaltyPercent / 100);

    // Total Base Expenses (P&L View)
    const totalFixedCostsBase = salaries + rentingBase + insurance + totalProfServicesBase + quota + otherExpensesBase;
    const totalVariableCostsBase = flyderFeeBase + royaltyBase + gasolineBase + repairsBase;

    const totalExpensesBase = totalFixedCostsBase + totalVariableCostsBase;
    const netProfitPreTax = revenue - totalExpensesBase;

    // --- TAX ESTIMATION ---
    const ivaPercent = 0.21;
    const taxableExpensesBase = rentingBase + totalProfServicesBase + gasolineBase + repairsBase + flyderFeeBase + royaltyBase + otherExpensesBase;
    const ivaSoportado = taxableExpensesBase * ivaPercent;
    const ivaRepercutido = revenue * ivaPercent;
    const ivaAPagar = ivaRepercutido - ivaSoportado;

    const irpfPercent = safeFloat(inputs.irpfPercent) || 20;
    const irpfPago = netProfitPreTax > 0 ? netProfitPreTax * (irpfPercent / 100) : 0;

    const netProfitPostTax = netProfitPreTax - irpfPago;

    // --- METRICS ---
    const activeRiders = safeFloat(inputs.contractedRiders) + 1; // +1 Manager
    const totalHours = safeFloat(inputs.totalHours);

    // Logistics Metrics (Automated Calculation)
    let totalKm = 0;
    if (gasolinePrice > 0) {
        // Liters = Base Cost / Base Price
        const litersConsumed = gasolineBase / gasolinePrice;
        totalKm = litersConsumed * 35; // Yamaha Liberty 125 factor
    } else {
        totalKm = safeFloat(inputs.totalKm);
    }
    // Round for clean metrics
    totalKm = Math.round(Math.max(0, totalKm)); // Prevent negative km

    let breakEvenOrders = 0;
    const avgTicket = orderCount > 0 ? revenue / orderCount : 0;
    const variableCostPerOrder = orderCount > 0 ? totalVariableCostsBase / orderCount : 0;
    const contributionMargin = avgTicket - variableCostPerOrder;

    if (contributionMargin > 0) {
        breakEvenOrders = Math.ceil(totalFixedCostsBase / contributionMargin);
    } else {
        breakEvenOrders = "N/A";
    }

    let safetyMargin = 0;
    if (typeof breakEvenOrders === 'number' && orderCount > 0) {
        safetyMargin = ((orderCount - breakEvenOrders) / orderCount) * 100;
    }

    // --- POWER METRICS ---
    const laborRatio = revenue > 0 ? (salaries / revenue) * 100 : 0;
    const incidentRatio = revenue > 0 ? (incidents / revenue) * 100 : 0;

    return {
        fixed: {
            salaries, renting: rentingBase, insurance, services: totalProfServicesBase, quota, other: otherExpensesBase,
            total: totalFixedCostsBase
        },
        variable: {
            gasoline: gasolineBase, repairs: repairsBase, flyderFee: flyderFeeBase, royalty: royaltyBase,
            total: totalVariableCostsBase
        },
        totalExpenses: totalExpensesBase,
        netProfit: netProfitPreTax,
        taxes: {
            ivaRepercutido, ivaSoportado, ivaAPagar, irpfPercent, irpfPago, netProfitPostTax
        },
        metrics: {
            avgTicket,
            costPerOrder: orderCount > 0 ? totalExpensesBase / orderCount : 0,
            breakEvenOrders,
            profitMargin: revenue > 0 ? (netProfitPreTax / revenue) * 100 : 0,
            activeRiders,
            productivity: totalHours > 0 ? orderCount / totalHours : 0,
            revenuePerHour: totalHours > 0 ? revenue / totalHours : 0,
            costPerHour: totalHours > 0 ? totalExpensesBase / totalHours : 0,
            profitPerRider: activeRiders > 0 ? netProfitPreTax / activeRiders : 0,
            // Logistics
            totalKm,
            revenuePerKm: totalKm > 0 ? revenue / totalKm : 0,
            costPerKm: totalKm > 0 ? totalExpensesBase / totalKm : 0,
            dropDensity: totalKm > 0 ? (orderCount / totalKm) * 100 : 0,
            safetyMargin,
            // Power Metrics
            laborRatio,
            incidentRatio,
            marketingSpend: marketing,
            incidentCost: incidents
        },
        breakdown: [
            { name: 'Salarios', value: salaries, type: 'fixed' },
            { name: 'Renting Motos', value: rentingBase, type: 'fixed' },
            { name: 'Seguros', value: insurance, type: 'fixed' },
            { name: 'Servicios Prof.', value: servicesBase, type: 'fixed' },
            { name: 'Gestor√≠a', value: agencyFeeBase, type: 'fixed' },
            { name: 'PRL', value: prlFeeBase, type: 'fixed' },
            { name: 'Serv. Financieros', value: accountingFeeBase, type: 'fixed' },
            { name: 'Cuota Aut√≥nomo', value: quota, type: 'fixed' },
            { name: 'Marketing', value: marketing, type: 'fixed' },
            { name: 'Mermas', value: incidents, type: 'fixed' },
            { name: 'Otros Costes', value: safeFloat(inputs.otherExpenses), type: 'fixed' },
            { name: 'Gasolina', value: gasolineBase, type: 'variable' },
            { name: 'Reparaciones', value: repairsBase, type: 'variable' },
            { name: 'App Flyder', value: flyderFeeBase, type: 'variable' },
            { name: 'Royalty', value: royaltyBase, type: 'variable' },
        ]
    };
};

// --- FORECASTING UTILS (Phase 4: Virtual CFO) ---

// Simple Linear Regression: y = mx + b
export const calculateTrend = (data, key, periodsToForecast = 3) => {
    const n = data.length;
    if (n < 2) return [];

    let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
    data.forEach((d, i) => {
        sumX += i;
        sumY += (d[key] || 0); // Handle null/undefined
        sumXY += i * (d[key] || 0);
        sumXX += i * i;
    });

    const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
    const intercept = (sumY - slope * sumX) / n;

    return Array.from({ length: periodsToForecast }, (_, i) => {
        const nextIndex = n + i;
        const val = slope * nextIndex + intercept;
        return Math.max(0, val); // No negative forecasts
    });
};

// Project current month's metric to end of month (e.g. Day 15 -> Day 30)
export const projectMonthEnd = (currentValue) => {
    const now = new Date();
    const currentDay = now.getDate();
    const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();

    if (currentDay === 0) return currentValue; // Avoid division by zero (shouldn't happen)

    // Formula: (Current / Day) * TotalDays
    // We add a conservative factor (0.95) to avoid over-optimism
    const projection = (currentValue / currentDay) * lastDay * 0.95;

    return Math.max(currentValue, projection);
};



================================================================================
FILE: src\lib\firebase.js
================================================================================
import { initializeApp } from "firebase/app";
import { getAuth } from "firebase/auth";
import { getFirestore } from "firebase/firestore";
import { getStorage } from "firebase/storage";

// Your web app's Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyC0vTiufm9bWbzXzWwqy2sEuIZLNxYiVdg",
    authDomain: "repaartfinanzas.firebaseapp.com",
    projectId: "repaartfinanzas",
    storageBucket: "repaartfinanzas.firebasestorage.app",
    messagingSenderId: "263883873106",
    appId: "1:263883873106:web:9860e5519848f48533788b",
    measurementId: "G-JK3BF315QM"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
export const auth = getAuth(app);
export const db = getFirestore(app);
export const storage = getStorage(app);
export const firebaseConfigExport = firebaseConfig; // Export for Secondary App usage



================================================================================
FILE: src\lib\fraudDetection.js
================================================================================
export const detectAnomalies = (franchise) => {
    const alerts = [];
    const m = franchise.metrics;

    if (!m) return alerts;

    // 1. FUEL THEFT (ROBO DE GASOLINA)
    // Rule: Consumption > 5L/100km (Approx 3.5 is normal for these bikes)
    // We calculate L/100km implied: (GasolineCost / PricePerLiter) / (TotalKm / 100)
    // Simplified trigger: If CostPerKm > 0.10‚Ç¨ (Normal is ~0.05-0.07‚Ç¨) and GasPrice is normal (~1.6)
    // Or just check CostPerKm related to Gasoline

    // Let's use the explicit 'costPerKm' metric which is total expenses / km. 
    // We need isolation on gasoline. 
    // If we have access to specific gasoline cost and total km:
    if (m.totalKm > 100) { // Only check if significant distance
        const gasolineCostPerKm = m.gasoline ? (m.gasoline / m.totalKm) : 0;
        // Assuming 1.6‚Ç¨/L -> 0.08‚Ç¨/km = 5L/100km. 
        if (gasolineCostPerKm > 0.09) {
            alerts.push({
                type: 'CRITICAL',
                code: 'FUEL_THEFT',
                title: 'Posible Robo de Gasolina',
                message: `Consumo excesivo detectado (${(gasolineCostPerKm * 100 / 1.6).toFixed(1)}L/100km est). Revisar tarjetas de combustible.`,
                metric: `${(gasolineCostPerKm * 100).toFixed(0)}‚Ç¨/100km`
            });
        }
    }

    // 2. HIDDEN COSTS (COSTES OCULTOS)
    // Rule: 0 Incidents declared but "Other Expenses" > 500‚Ç¨
    // This suggests they are categorizing losses as generic expenses to hide them.
    if (m.incidentCost === 0 && m.otherExpenses > 500) {
        alerts.push({
            type: 'WARNING',
            code: 'HIDDEN_COSTS',
            title: 'Costes Ocultos',
            message: '0‚Ç¨ en Mermas pero gastos "Otros" elevados. Posible ocultaci√≥n de incidencias.',
            metric: `Otros: ${m.otherExpenses}‚Ç¨`
        });
    }

    // 3. LABOR INFLATION (SOBRECOSTE LABORAL)
    // Rule: Labor Ratio > 70% (Industry avg ~55-60%)
    if (m.laborRatio > 70) {
        alerts.push({
            type: 'CRITICAL',
            code: 'LABOR_INFLATION',
            title: 'Sobrecoste Laboral Severo',
            message: 'Salarios consumen +70% de los ingresos. Revisar horas fantasma o exceso de plantilla.',
            metric: `${m.laborRatio.toFixed(1)}%`
        });
    }

    // 4. LOW TICKET (BAJO TICKET)
    // Rule: Avg Ticket < 8‚Ç¨ (Suspiciously low for delivery, maybe splitting orders?)
    if (m.orders > 50 && m.avgTicket < 10) {
        alerts.push({
            type: 'WARNING',
            code: 'LOW_TICKET',
            title: 'Ticket Medio Anormal',
            message: 'Ticket medio por debajo de 10‚Ç¨. Posible error de facturaci√≥n o "pedidos fake" para inflar volumen.',
            metric: `${m.avgTicket.toFixed(2)}‚Ç¨`
        });
    }

    // 5. ZOMBIE RIDER
    // Rule: Productivity < 1.5 orders/hour (Riders standing still)
    if (m.productivity > 0 && m.productivity < 1.5) {
        alerts.push({
            type: 'WARNING',
            code: 'LOW_PROD',
            title: 'Baja Productividad',
            message: 'Menos de 1.5 pedidos/hora. Exceso de horas contratadas para el volumen actual.',
            metric: `${m.productivity.toFixed(1)} ped/h`
        });
    }

    return alerts;
};



================================================================================
FILE: src\lib\gemini.js
================================================================================
import { GoogleGenerativeAI } from "@google/generative-ai";

// Initialize the API with the key (will be set in .env)
const API_KEY = import.meta.env.VITE_GOOGLE_AI_KEY || '';

let chatSession = null;

import { FRANCHISE_KNOWLEDGE } from './companyKnowledge';

const SYSTEM_INSTRUCTION = `
Eres REPAART AI, el asistente virtual experto de la franquicia Repaart.
Tu objetivo es ayudar a los franquiciados a resolver dudas operativas, financieras y de soporte.

UTILIZA ESTA BASE DE CONOCIMIENTO (TU CEREBRO):
${FRANCHISE_KNOWLEDGE}

Tus conocimientos clave adicionales son:
1. MANUALES: Sabes que los manuales est√°n en la secci√≥n "Soporte" > "Recursos".
2. TICKETS: Si hay un problema grave, sugiere abrir un ticket en "Soporte".
3. FINANZAS: Las dudas de pagos se ven en el "Dashboard Financiero" mensual.
4. TONO: Ad√°ptate al tono definido en tu base de conocimiento.
5. CONTEXTO: Respondes preguntas sobre Repaart (log√≠stica, delivery, costes). Si te preguntan algo fuera de tema, reconduce amablemente.

Si no sabes una respuesta espec√≠fica, sugiere contactar a soporte@repaart.es o abrir un ticket.
`;

export const initGeminiChat = async () => {
    if (!API_KEY) {
        console.warn("Gemini API Key missing");
        return null;
    }

    try {
        const genAI = new GoogleGenerativeAI(API_KEY);
        const model = genAI.getGenerativeModel({
            model: "gemini-1.5-flash",
            // System instructions are passed here for Gemini 1.5
            systemInstruction: {
                role: "system",
                parts: [{ text: SYSTEM_INSTRUCTION }]
            }
        });

        chatSession = model.startChat({
            history: [],
            generationConfig: {
                maxOutputTokens: 1000,
                temperature: 0.7,
            },
        });

        if (import.meta.env.DEV) {
            console.log("Gemini Chat Session Initialized ‚úÖ");
        }
        return true;
    } catch (error) {
        console.error("Error initializing Gemini:", error);
        return false;
    }
};

export const sendMessageToGemini = async (message) => {
    if (!chatSession) {
        // Try to init if not ready
        const success = await initGeminiChat();
        // If still failed (e.g. no key), return mock fallback
        if (!success) {
            return "‚ö†Ô∏è No veo mi 'llave maestra' (API Key). Por favor configura la VITE_GOOGLE_AI_KEY en el sistema.";
        }
    }

    try {
        const result = await chatSession.sendMessage(message);
        const response = await result.response;
        return response.text();
    } catch (error) {
        console.error("Gemini Error:", error);
        return "Lo siento, tuve un problema de conexi√≥n. ¬øPodr√≠as intentar de nuevo?";
    }
};



================================================================================
FILE: src\lib\knowledgeBase.js
================================================================================
export const KNOWLEDGE_ARTICLES = [
    {
        id: 'invoice_guide',
        title: 'C√≥mo descargar tus facturas',
        excerpt: 'Pasos para descargar las facturas de comisiones y servicios desde el panel.',
        keywords: ['factura', 'cobro', 'dinero', 'pago', 'impuesto', 'iva'],
        link: '#' // In real app, this would be a URL
    },
    {
        id: 'wifi_issues',
        title: 'Problemas de Conexi√≥n / WiFi',
        excerpt: 'Gu√≠a r√°pida para reiniciar el router y reconectar las PDAs.',
        keywords: ['internet', 'wifi', 'red', 'conexi√≥n', 'offline', 'lento'],
        link: '#'
    },
    {
        id: 'accident_protocol',
        title: 'Protocolo de Accidentes',
        excerpt: 'Qu√© hacer en caso de accidente con un veh√≠culo de la flota.',
        keywords: ['accidente', 'golpe', 'choque', 'siniestro', 'seguro', 'herido'],
        link: '#'
    },
    {
        id: 'password_reset',
        title: 'Recuperar Contrase√±a',
        excerpt: 'No puedo entrar a mi cuenta o he olvidado la clave.',
        keywords: ['clave', 'contrase√±a', 'password', 'acceso', 'login', 'entrar'],
        link: '#'
    },
    {
        id: 'order_cancel',
        title: 'Cancelar un Pedido',
        excerpt: 'Cu√°ndo y c√≥mo se puede cancelar un pedido en curso.',
        keywords: ['cancelar', 'anular', 'pedido', 'order', 'equivocaci√≥n'],
        link: '#'
    }
];

/**
 * Returns articles that match the given text based on keywords.
 * @param {string} text 
 * @returns {Array} - Array of matching articles
 */
export const getSuggestions = (text) => {
    if (!text || text.length < 3) return [];

    const lowerText = text.toLowerCase();

    return KNOWLEDGE_ARTICLES.filter(article => {
        return article.keywords.some(keyword => lowerText.includes(keyword));
    });
};



================================================================================
FILE: src\lib\notifications.js
================================================================================
import { db } from './firebase';
import { collection, addDoc, serverTimestamp, doc, updateDoc } from 'firebase/firestore';

/**
 * Creates a new notification for a user.
 * @param {string} userId - The UID of the recipient.
 * @param {string} title - Short title.
 * @param {string} message - Content.
 * @param {string} type - 'info', 'success', 'warning', 'error'.
 * @param {string} link - Optional URL to redirect.
 */
export const createNotification = async (userId, title, message, type = 'info', link = null) => {
    try {
        await addDoc(collection(db, "notifications"), {
            userId,
            title,
            message,
            type,
            link,
            read: false,
            createdAt: serverTimestamp()
        });
    } catch (error) {
        console.error("Error creating notification:", error);
    }
};

export const markNotificationAsRead = async (notificationId) => {
    try {
        await updateDoc(doc(db, "notifications", notificationId), {
            read: true
        });
    } catch (error) {
        console.error("Error marking notification as read:", error);
    }
};



================================================================================
FILE: src\lib\pdfGenerator.js
================================================================================
import { formatMoney } from './finance';

export const generatePDFReport = async (report, franchiseName = 'Franchise Partner', month = 'Current') => {
    try {
        if (!report) {
            console.error("PDF Generation failed: Report data is missing.");
            alert("No hay datos para generar el informe.");
            return;
        }

        // Dynamic imports for performance (lazy load ~600kB)
        const { jsPDF } = await import('jspdf');
        const autoTable = (await import('jspdf-autotable')).default;

        const doc = new jsPDF();
        const pageWidth = doc.internal.pageSize.width;

        // --- HEADER ---
        doc.setFontSize(22);
        doc.setTextColor(30, 41, 59); // Slate 800
        doc.text("REPAART", 15, 20);

        doc.setFontSize(10);
        doc.setTextColor(100, 116, 139); // Slate 500
        doc.text("FRANCHISE FINANCIAL SYSTEM", 15, 25);

        // Date & Info
        doc.setFontSize(10);
        doc.setTextColor(0, 0, 0);
        doc.text(`FRANQUICIA: ${franchiseName.toUpperCase()}`, 15, 40);
        doc.text(`PERIODO: ${month.toUpperCase()}`, 15, 45);
        doc.text(`FECHA EMISI√ìN: ${new Date().toLocaleDateString()}`, pageWidth - 15, 20, { align: 'right' });

        // --- EXECUTIVE SUMMARY ---
        let yPos = 60;
        doc.setFillColor(248, 250, 252); // Slate 50
        doc.rect(15, yPos, pageWidth - 30, 25, 'F');

        doc.setFontSize(14);
        doc.text("RESUMEN EJECUTIVO", 20, yPos + 10);

        doc.setFontSize(10);
        doc.text("INGRESOS", 20, yPos + 20);
        doc.text("GASTOS", 70, yPos + 20);
        doc.text("BENEFICIO NETO", 120, yPos + 20);

        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text(`${formatMoney(report.revenue)}‚Ç¨`, 20, yPos + 17);
        doc.text(`${formatMoney(report.expenses)}‚Ç¨`, 70, yPos + 17);

        const profitColor = report.taxes.netProfitPostTax >= 0 ? [22, 163, 74] : [220, 38, 38]; // Green/Red
        doc.setTextColor(profitColor[0], profitColor[1], profitColor[2]);
        doc.text(`${formatMoney(report.taxes.netProfitPostTax)}‚Ç¨`, 120, yPos + 17);
        doc.setTextColor(0, 0, 0); // Reset
        doc.setFont(undefined, 'normal');

        // --- METRICS GRID ---
        yPos += 35;
        doc.setFontSize(12);
        doc.text("INDICADORES CLAVE", 15, yPos);

        const metricsData = [
            ['Productividad', `${report.metrics.productivity.toFixed(2)} ped/h`, 'Coste/Km', `${report.metrics.costPerKm.toFixed(3)}‚Ç¨`],
            ['Km Totales', `${report.metrics.totalKm} km`, 'Beneficio/Rider', `${report.metrics.profitPerRider.toFixed(2)}‚Ç¨`],
            ['Drop Density', `${report.metrics.dropDensity.toFixed(2)}%`, 'Margen', `${report.metrics.profitMargin.toFixed(1)}%`]
        ];

        autoTable(doc, {
            startY: yPos + 5,
            head: [],
            body: metricsData,
            theme: 'plain',
            styles: { fontSize: 9, cellPadding: 2 },
            columnStyles: {
                0: { fontStyle: 'bold', textColor: [100, 116, 139] },
                2: { fontStyle: 'bold', textColor: [100, 116, 139] }
            }
        });

        // --- TAXES ---
        yPos = doc.lastAutoTable.finalY + 15;
        doc.setFontSize(12);
        doc.text("LIQUIDACI√ìN IVA ESTIMADA", 15, yPos);

        const taxData = [
            ['IVA Repercutido (21%)', `+${formatMoney(report.taxes.ivaRepercutido)}‚Ç¨`],
            ['IVA Soportado (Deducible)', `-${formatMoney(report.taxes.ivaSoportado)}‚Ç¨`],
            ['A PAGAR', `${formatMoney(report.taxes.ivaAPagar)}‚Ç¨`]
        ];

        autoTable(doc, {
            startY: yPos + 5,
            head: [['Concept', 'Importe']],
            body: taxData,
            theme: 'striped',
            headStyles: { fillColor: [30, 41, 59] },
            styles: { fontSize: 10 },
            columnStyles: {
                1: { halign: 'right', fontStyle: 'bold' }
            },
            didParseCell: function (data) {
                if (data.row.index === 2) {
                    data.cell.styles.fontStyle = 'bold';
                    data.cell.styles.fillColor = [241, 245, 249];
                }
            }
        });

        // --- BREAKDOWN ---
        yPos = doc.lastAutoTable.finalY + 15;
        doc.setFontSize(12);
        doc.text("DESGLOSE DE COSTES", 15, yPos);

        // Prepare breakdown data with VAT calculation
        const breakdownRows = report.breakdown.map(item => {
            const hasIva = [
                'Renting Motos', 'Royalty', 'Gasolina', 'Reparaciones',
                'Servicios Prof.', 'Gestor√≠a', 'PRL', 'Serv. Financieros',
                'Otros Costes', 'App Flyder'
            ].includes(item.name);
            const ivaVal = hasIva ? item.value * 0.21 : 0;
            const total = item.value + ivaVal;

            return [
                item.name,
                `${formatMoney(item.value)}‚Ç¨`,
                `${formatMoney(ivaVal)}‚Ç¨`,
                `${formatMoney(total)}‚Ç¨`
            ];
        });

        autoTable(doc, {
            startY: yPos + 5,
            head: [['Concepto', 'Base', 'IVA (Est.)', 'Total']],
            body: breakdownRows,
            theme: 'grid',
            headStyles: { fillColor: [71, 85, 105] },
            styles: { fontSize: 9 },
            columnStyles: {
                1: { halign: 'right' },
                2: { halign: 'right' },
                3: { halign: 'right', fontStyle: 'bold' }
            }
        });

        // Footer
        const pageHeight = doc.internal.pageSize.height;
        doc.setFontSize(8);
        doc.setTextColor(150);
        doc.text("Documento generado autom√°ticamente por REPAART System.", 15, pageHeight - 10);

        doc.save(`REPAART_Informe_${month}_${new Date().toISOString().split('T')[0]}.pdf`);
    } catch (error) {
        console.error("Critical PDF Error:", error);
        alert(`Error generando el PDF: ${error.message}`);
    }
};



================================================================================
FILE: src\main.jsx
================================================================================
import React from 'react'
import ReactDOM from 'react-dom/client'
import App from './App.jsx'
import './index.css'
import { AuthProvider } from './context/AuthContext'
import ErrorBoundary from './components/ErrorBoundary'

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.getRegistrations().then(function (registrations) {
    for (let registration of registrations) {
      registration.unregister();
      console.log('Service Worker Unregistered');
    }
  });
}

ReactDOM.createRoot(document.getElementById('root')).render(
  <React.StrictMode>
    <ErrorBoundary>
      <AuthProvider>
        <App />
      </AuthProvider>
    </ErrorBoundary>
  </React.StrictMode>,
);



================================================================================
FILE: src\services\fleetService.js
================================================================================
/**
 * @fileoverview Service layer for Fleet Management interactions.
 * Follows Singleton pattern and enforces strict immutability.
 */

import { db } from '../lib/firebase';
import { collection, getDocs, query, orderBy } from 'firebase/firestore';

/**
 * @typedef {Object} Vehicle
 * @property {string} id
 * @property {string} alias
 * @property {number} currentKm
 * @property {number} nextRevisionKm
 * @property {'active' | 'warning' | 'repair'} status
 * @property {string|null} lastRevisionDate
 */

/**
 * Custom Error class for Service Layer
 */
class ServiceError extends Error {
    constructor(message, originalError = null) {
        super(message);
        this.name = 'ServiceError';
        this.originalError = originalError;
    }
}

/**
 * Fleet Service Singleton
 * Handles all data fetching and manipulation for fleet vehicles.
 * Enforces immutability on returned data.
 */
const FleetService = {
    CACHE_KEY: 'fleet_cache',
    CACHE_DURATION_MS: 3600 * 1000, // 1 Hour

    /**
     * Fetch all vehicles from source (Cache -> Network).
     * @returns {Promise<ReadonlyArray<Vehicle>>} Immutable array of vehicles
     * @throws {ServiceError}
     */
    async getAllVehicles() {
        try {
            // 1. Validar Cache
            const cached = this._getFromCache();
            if (cached) return cached;

            // 2. Network Request
            const q = query(collection(db, "fleet_vehicles"), orderBy("alias"));
            const snapshot = await getDocs(q);

            // 3. Data Transformation & Validation
            /** @type {Vehicle[]} */
            const vehicles = snapshot.docs.map(doc => {
                const data = doc.data();
                // Defensive coding: Ensure defaults
                return {
                    id: doc.id,
                    alias: data.alias || 'Unknown Unit',
                    currentKm: Number(data.currentKm) || 0,
                    nextRevisionKm: Number(data.nextRevisionKm) || 10000,
                    status: this._validateStatus(data.status),
                    lastRevisionDate: data.lastRevisionDate || null
                };
            });

            // 4. Fallback Mock Data (Only if empty, for demo consistency)
            if (vehicles.length === 0 && !snapshot.metadata.fromCache) {
                const mockData = this._getMockData();
                this._saveToCache(mockData);
                return Object.freeze(mockData);
            }

            // 5. Cache & Freeze
            this._saveToCache(vehicles);
            return Object.freeze(vehicles);

        } catch (error) {
            // Log raw error internally if needed (e.g. to Sentry)
            console.error('[FleetService] Error fetching vehicles:', error);
            throw new ServiceError('Failed to retrieve fleet data.', error);
        }
    },

    /**
     * PRIVATE: Normalize status string
     * @param {string} status 
     * @returns {'active' | 'warning' | 'repair'}
     */
    _validateStatus(status) {
        const VALID_STATUSES = ['active', 'warning', 'repair'];
        return VALID_STATUSES.includes(status) ? status : 'active';
    },

    /**
     * PRIVATE: Cache management
     */
    _getFromCache() {
        try {
            const raw = localStorage.getItem(this.CACHE_KEY);
            if (!raw) return null;

            const { timestamp, data } = JSON.parse(raw);
            const isFresh = (Date.now() - timestamp) < this.CACHE_DURATION_MS;

            return isFresh ? Object.freeze(data) : null;
        } catch (e) {
            console.error('[FleetService] Cache read error', e);
            return null; // Cache corrupted
        }
    },

    /**
     * PRIVATE: Save to cache
     * @param {Vehicle[]} data 
     */
    _saveToCache(data) {
        try {
            const payload = {
                timestamp: Date.now(),
                data
            };
            localStorage.setItem(this.CACHE_KEY, JSON.stringify(payload));
        } catch (e) {
            console.warn('[FleetService] Quota exceeded or storage unavailable', e);
        }
    },

    /**
     * PRIVATE: Mock Data Factory
     * Returns defensive copies
     */
    _getMockData() {
        return [
            { id: '1', alias: 'Rayo 01', currentKm: 850, nextRevisionKm: 1000, status: 'active', lastRevisionDate: '2024-12-01' },
            { id: '2', alias: 'Trueno 02', currentKm: 5200, nextRevisionKm: 5000, status: 'warning', lastRevisionDate: '2024-10-15' },
            { id: '3', alias: 'Flash 03', currentKm: 300, nextRevisionKm: 1000, status: 'active', lastRevisionDate: '2024-12-10' },
            { id: '4', alias: 'Viento 04', currentKm: 12000, nextRevisionKm: 11000, status: 'repair', lastRevisionDate: '2023-11-20' },
        ];
    }
};

export default FleetService;



================================================================================
FILE: src\services\shiftService.js
================================================================================
/**
 * @fileoverview Service layer for Shift Management.
 */

import { db } from '../lib/firebase';
import { collection, getDocs, addDoc, deleteDoc, doc, query, orderBy } from 'firebase/firestore';

const ShiftService = {
    CACHE_KEY: 'shifts_cache',
    CACHE_DURATION_MS: 3600 * 1000, // 1 Hour

    /**
     * Fetch all shifts.
     * @returns {Promise<ReadonlyArray<Object>>}
     */
    async getAllShifts() {
        try {
            // 1. Cache Check
            const cached = this._getFromCache();
            if (cached) return cached;

            // 2. Network
            const q = query(collection(db, "shifts"), orderBy("day"));
            const snapshot = await getDocs(q);
            const shifts = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));

            // 3. Fallback Mock
            if (shifts.length === 0 && !snapshot.metadata.fromCache) {
                const mock = this._getMockData();
                this._saveToCache(mock);
                return Object.freeze(mock);
            }

            // 4. Return
            this._saveToCache(shifts);
            return Object.freeze(shifts);
        } catch (error) {
            console.error('[ShiftService] Error fetching shifts:', error);
            throw new Error('Failed to fetch shifts.');
        }
    },

    /**
     * Add a new shift.
     * @param {Object} shiftData 
     */
    async addShift(shiftData) {
        // Optimistic update support or simple cache invalidation
        const docRef = await addDoc(collection(db, "shifts"), shiftData);
        this._invalidateCache();
        return docRef.id;
    },

    /**
     * Delete a shift.
     * @param {string} id 
     */
    async deleteShift(id) {
        await deleteDoc(doc(db, "shifts", id));
        this._invalidateCache();
    },

    _getFromCache() {
        try {
            const raw = localStorage.getItem(this.CACHE_KEY);
            if (!raw) return null;
            const { timestamp, data } = JSON.parse(raw);
            if ((Date.now() - timestamp) > this.CACHE_DURATION_MS) return null;
            return Object.freeze(data);
        } catch { return null; }
    },

    _saveToCache(data) {
        try {
            localStorage.setItem(this.CACHE_KEY, JSON.stringify({ timestamp: Date.now(), data }));
        } catch { console.warn('Storage full'); }
    },

    _invalidateCache() {
        localStorage.removeItem(this.CACHE_KEY);
    },

    _getMockData() {
        return [
            { id: '1', day: 'Viernes', startTime: '20:00', endTime: '23:00', riderName: 'Juan P.', zone: 'Centro' },
            { id: '2', day: 'S√°bado', startTime: '13:00', endTime: '16:00', riderName: 'Ana G.', zone: 'Norte' },
        ];
    }
};

export default ShiftService;



================================================================================
FILE: src\utils\analyticsHelpers.js
================================================================================
/**
 * Analytics Helpers - Pure Functions for Predictive Intelligence
 * Enforces "Separate Logic from State" law.
 */

// --- CONSTANTS ---
const THRESHOLDS = {
    SUPPORT_BOTTLENECK_RATIO: 0.1, // CHAOS MODE: Anything triggers it
    ANOMALY_USER_GROWTH: 0, // CHAOS MODE: Any user is an anomaly
};

/**
 * Analyzes Support Health based on ticket flow.
 * @param {Array} tickets - List of ticket objects
 * @returns {Object} { status: 'healthy'|'bottleneck', ratio: number, newTickets: number, resolvedTickets: number }
 */
export const checkSupportHealth = (tickets = []) => {
    const now = new Date();
    const oneDayAgo = new Date(now - 24 * 60 * 60 * 1000);

    // Filter last 24h activity
    const recentActivity = tickets.filter(t => {
        const date = t.createdAt?.toDate ? t.createdAt.toDate() : new Date(t.createdAt);
        return date > oneDayAgo;
    });

    // Count opens vs resolves (approximation based on status or separate logs)
    // Assuming 'tickets' list contains current state. 
    // To accurately count "resolved in last 24h", we'd need an event log. 
    // For this heuristic, we'll look at:
    // 1. Tickets created < 24h ago (New Load)
    // 2. Tickets resolved < 24h ago (Resolution Capacity) - *Requires 'resolvedAt' field or similar*
    // Fallback if no resolvedAt: Count total 'open' vs total 'resolved' density changes?
    // Let's use the requested logic: "Ratio de apertura vs cierre".

    // Simplification for the hook data: 
    // New Load = Count of tickets created in last 24h.
    // Resolution = Count of tickets with status 'resolved' AND updatedAt in last 24h.

    const newTickets = recentActivity.length;
    const resolvedRecent = recentActivity.filter(t => t.status === 'resolved').length;

    // Avoid division by zero
    const comparisonBase = resolvedRecent === 0 ? 1 : resolvedRecent;
    const ratio = newTickets / comparisonBase;

    const isBottleneck = (ratio > THRESHOLDS.SUPPORT_BOTTLENECK_RATIO) && (newTickets > 5); // Minimum sample size

    return {
        status: isBottleneck ? 'bottleneck' : 'healthy',
        ratio: parseFloat(ratio.toFixed(2)),
        newTickets,
        resolvedRecent,
        message: isBottleneck
            ? `Alerta de Cuello de Botella: ${newTickets} nuevos vs ${resolvedRecent} resueltos (Ratio ${ratio.toFixed(1)})`
            : 'Flujo de soporte saludable'
    };
};

/**
 * Detects Anomalies in User Growth vs Business Activity.
 * @param {Array} users - List of user objects
 * @param {Object} salesData - Sales metrics or dashboard data
 * @returns {Object} { detected: boolean, type: string, message: string }
 */
export const detectUserAnomaly = (users = [], salesData = {}) => {
    const now = new Date();
    const oneDayAgo = new Date(now - 24 * 60 * 60 * 1000);

    // New Users last 24h
    const newUsers = users.filter(u => {
        const date = u.createdAt?.toDate ? u.createdAt.toDate() : new Date(u.createdAt);
        return date > oneDayAgo;
    });

    const growthSpike = newUsers.length > THRESHOLDS.ANOMALY_USER_GROWTH;

    // Check Sales Correlation (Simplified: If sales are 0 but users are growing fast -> Suspicious/Spam?)
    // This assumes 'salesData' has a 'dailyRevenue' or similar.
    const hasRevenue = (salesData?.currentRevenue || 0) > 0;

    if (growthSpike && !hasRevenue) {
        return {
            detected: true,
            type: 'high_traffic_low_conversion',
            level: 'warning',
            message: `Pico de usuarios (${newUsers.length}) sin correlaci√≥n de ventas.`
        };
    }

    return { detected: false, message: 'Crecimiento org√°nico normal' };
};

/**
 * Agregates all analysis into a predictive alert list.
 * @param {Object} supportAnalysis 
 * @param {Object} userAnalysis 
 * @returns {Array} List of alert objects
 */
export const generatePredictiveAlerts = (supportAnalysis, userAnalysis) => {
    const alerts = [];

    if (supportAnalysis.status === 'bottleneck') {
        alerts.push({
            type: 'support_bottleneck',
            level: 'high',
            message: supportAnalysis.message,
            timestamp: new Date()
        });
    }

    if (userAnalysis.detected) {
        alerts.push({
            type: userAnalysis.type,
            level: userAnalysis.level,
            message: userAnalysis.message,
            timestamp: new Date()
        });
    }

    return alerts;
};

// --- SCORING ---
export const calculateHealthScore = (alerts = []) => {
    let score = 100;
    alerts.forEach(alert => {
        if (alert.level === 'high') score -= 20;
        if (alert.level === 'warning') score -= 10;
        if (alert.level === 'med') score -= 5;
    });
    return Math.max(0, score);
};



================================================================================
FILE: src\utils\formatDate.js
================================================================================
import { Timestamp } from 'firebase/firestore';

/**
 * Formatea cualquier entrada de fecha (Timestamp, String, Date) a un formato legible consistente.
 * @param {Timestamp|string|Date|null} dateInput 
 * @returns {string} Fecha formateada o '---' si es inv√°lida/null
 */
export const formatDate = (dateInput) => {
    if (!dateInput) return '---'; // Maneja null/undefined

    // Caso 1: Es un Timestamp de Firestore
    if (dateInput instanceof Timestamp || (dateInput && typeof dateInput.toDate === 'function')) {
        return dateInput.toDate().toLocaleDateString('es-ES', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    }

    // Caso 2: Es un String ISO (Legacy data o JSON serialization)
    if (typeof dateInput === 'string') {
        // Intentar crear fecha
        const d = new Date(dateInput);
        if (!isNaN(d.getTime())) {
            return d.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
    }

    // Caso 3: Ya es un objeto Date JS
    if (dateInput instanceof Date) {
        if (!isNaN(dateInput.getTime())) {
            return dateInput.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
    }

    return 'Fecha inv√°lida';
};



================================================================================
FILE: tailwind.config.js
================================================================================
/** @type {import('tailwindcss').Config} */
export default {
    content: [
        "./index.html",
        "./src/**/*.{js,ts,jsx,tsx}",
    ],
    darkMode: 'class',
    theme: {
        extend: {
            fontFamily: {
                sans: ['Inter', 'sans-serif'],
            },
            colors: {
                // "Peaceful Brand" - Soft Blue-Purple Gradient Logic
                // Replacing 'indigo' with our custom brand palette to instantly re-theme the app
                indigo: {
                    50: '#f0f4f8',   // Alice Blue
                    100: '#d9e2ec',  // Soft Slate
                    200: '#bcccdc',  // Periwinkle Low
                    300: '#9fb3c8',  // Periwinkle Mid
                    400: '#829ab1',  // Muted Blue
                    500: '#627d98',  // BRAND PRIMARY (Soft) - Was Strong Indigo
                    600: '#486581',  // Darker Muted
                    700: '#334e68',  // Slate Blue
                    800: '#243b53',  // Dark Slate
                    900: '#102a43',  // Night Blue
                    950: '#0a1c2e',
                }
            }
        },
    },
    plugins: [],
}



================================================================================
FILE: vite.config.js
================================================================================
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import { VitePWA } from 'vite-plugin-pwa'

// https://vite.dev/config/
export default defineConfig({
  plugins: [
    react(),
    // VitePWA({...}) // DOMINIC: Disabled for debugging deployment
  ],
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          // Firebase bundle
          'vendor-firebase': [
            'firebase/app',
            'firebase/firestore',
            'firebase/auth',
            'firebase/storage'
          ],
          // Charts library
          'vendor-charts': ['recharts'],
          // PDF export utilities - removed to allow dynamic import splitting
          // 'vendor-pdf': ['jspdf', 'jspdf-autotable', 'html2canvas'],
          // UI and editor libraries
          'vendor-ui': ['lucide-react', 'react-quill'],
          // Google AI
          'vendor-ai': ['@google/generative-ai'],
          // Email service
          'vendor-email': ['@emailjs/browser']
        }
      }
    }
  }
})

