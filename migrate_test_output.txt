
[1m[46m RUN [49m[22m [36mv4.0.16 [39m[90mC:/Users/Usuario/.gemini/antigravity/playground/synthetic-sagan[39m

[90mstdout[2m | src/services/migrationService.test.ts[2m > [22m[2mMigrationService[2m > [22m[2mmigrateFleetLegacyFields[2m > [22m[2mshould correctly stage updates in dryRun mode
[22m[39mÂ­Æ’Âºâ•£ [Fleet] Migraciâ”œâ”‚n de campos (VISTA PREVIA)...

stderr | src/services/migrationService.test.ts > MigrationService > migrateFleetLegacyFields > should correctly stage updates in dryRun mode
Ã”Ã˜Ã® ERROR en migrateFleetLegacyFields: TypeError: assetsSnap.forEach is not a function
    at Object.migrateFleetLegacyFields (C:/Users/Usuario/.gemini/antigravity/playground/synthetic-sagan/src/services/migrationService.ts:242:24)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/Usuario/.gemini/antigravity/playground/synthetic-sagan/src/services/migrationService.test.ts:50:28
    at file:///C:/Users/Usuario/.gemini/antigravity/playground/synthetic-sagan/node_modules/@vitest/runner/dist/index.js:915:20

[90mstdout[2m | src/services/migrationService.test.ts[2m > [22m[2mMigrationService[2m > [22m[2mmigrateFleetLegacyFields[2m > [22m[2mshould commit updates when dryRun is false
[22m[39mÂ­Æ’Âºâ•£ [Fleet] Migraciâ”œâ”‚n de campos (EJECUCIâ”œÃ´N)...

stderr | src/services/migrationService.test.ts > MigrationService > migrateFleetLegacyFields > should commit updates when dryRun is false
Ã”Ã˜Ã® ERROR en migrateFleetLegacyFields: TypeError: assetsSnap.forEach is not a function
    at Object.migrateFleetLegacyFields (C:/Users/Usuario/.gemini/antigravity/playground/synthetic-sagan/src/services/migrationService.ts:242:24)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/Usuario/.gemini/antigravity/playground/synthetic-sagan/src/services/migrationService.test.ts:67:28
    at file:///C:/Users/Usuario/.gemini/antigravity/playground/synthetic-sagan/node_modules/@vitest/runner/dist/index.js:915:20

[90mstdout[2m | src/services/migrationService.test.ts[2m > [22m[2mMigrationService[2m > [22m[2mmigrateFinanceLegacyFields[2m > [22m[2mshould migrate records and summaries
[22m[39mÂ­Æ’Âºâ•£ [Finance] Migraciâ”œâ”‚n de campos (EJECUCIâ”œÃ´N)...
stderr | src/services/migrationService.test.ts > MigrationService > migrateFinanceLegacyFields > should migrate records and summaries
Ã”Ã˜Ã® ERROR en migrateFinanceLegacyFields: TypeError: Cannot read properties of undefined (reading '_query')
    at C:/Users/Usuario/.gemini/antigravity/playground/synthetic-sagan/src/services/migrationService.test.ts:92:35
    at Mock (file:///C:/Users/Usuario/.gemini/antigravity/playground/synthetic-sagan/node_modules/@vitest/spy/dist/index.js:285:34)
    at Object.migrateFinanceLegacyFields (C:/Users/Usuario/.gemini/antigravity/playground/synthetic-sagan/src/services/migrationService.ts:168:39)
    at C:/Users/Usuario/.gemini/antigravity/playground/synthetic-sagan/src/services/migrationService.test.ts:100:51
    at file:///C:/Users/Usuario/.gemini/antigravity/playground/synthetic-sagan/node_modules/@vitest/runner/dist/index.js:145:11

    at file:///C:/Users/Usuario/.gemini/antigravity/playground/synthetic-sagan/node_modules/@vitest/runner/dist/index.js:915:26
    at file:///C:/Users/Usuario/.gemini/antigravity/playground/synthetic-sagan/node_modules/@vitest/runner/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout (file:///C:/Users/Usuario/.gemini/antigravity/playground/synthetic-sagan/node_modules/@vitest/runner/dist/index.js:1209:10)
    at file:///C:/Users/Usuario/.gemini/antigravity/playground/synthetic-sagan/node_modules/@vitest/runner/dist/index.js:1653:37

 [31mÃ”Ã˜Â»[39m src/services/migrationService.test.ts [2m([22m[2m3 tests[22m[2m | [22m[31m3 failed[39m[2m)[22m[32m 14[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should correctly stage updates in dryRun mode[39m[32m 10[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should commit updates when dryRun is false[39m[32m 2[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should migrate records and summaries[39m[32m 2[2mms[22m[39m

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â» Failed Tests 3 Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»

 FAIL  src/services/migrationService.test.ts > MigrationService > migrateFleetLegacyFields > should correctly stage updates in dryRun mode
AssertionError: expected false to be true // Object.is equality

- Expected
+ Received

- true
+ false

 Ã”Ã˜Â» src/services/migrationService.test.ts:52:36
     50|             const result = await migrationService.migrateFleetLegacyFiÃ”Ã‡Âª
     51| 
     52|             expect(result.success).toBe(true);
       |                                    ^
     53|             expect(result.count).toBe(1); // Only v1 needs migration
     54|             expect(writeBatch).toHaveBeenCalled();

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[1/3]Ã”Ã„Â»

 FAIL  src/services/migrationService.test.ts > MigrationService > migrateFleetLegacyFields > should commit updates when dryRun is false
AssertionError: expected false to be true // Object.is equality

- Expected
+ Received

- true
+ false

 Ã”Ã˜Â» src/services/migrationService.test.ts:69:36
     67|             const result = await migrationService.migrateFleetLegacyFiÃ”Ã‡Âª
     68| 
     69|             expect(result.success).toBe(true);
       |                                    ^
     70|             const mockBatch = vi.mocked(writeBatch).mock.results[0].vaÃ”Ã‡Âª
     71|             expect(mockBatch.update).toHaveBeenCalledWith(

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[2/3]Ã”Ã„Â»

 FAIL  src/services/migrationService.test.ts > MigrationService > migrateFinanceLegacyFields > should migrate records and summaries
AssertionError: expected false to be true // Object.is equality

- Expected
+ Received

- true
+ false

 Ã”Ã˜Â» src/services/migrationService.test.ts:102:36
    100|             const result = await migrationService.migrateFinanceLegacyÃ”Ã‡Âª
    101| 
    102|             expect(result.success).toBe(true);
       |                                    ^
    103|             expect(result.count).toBe(2);
    104|             const mockBatch = vi.mocked(writeBatch).mock.results[0].vaÃ”Ã‡Âª

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[3/3]Ã”Ã„Â»


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m3 failed[39m[22m[90m (3)[39m
[2m   Start at [22m 00:14:29
[2m   Duration [22m 1.23s[2m (transform 78ms, setup 126ms, import 61ms, tests 14ms, environment 812ms)[22m

